diff -x '.*' -aur pacman-4.0.3/HACKING pacman/HACKING
--- pacman-4.0.3/HACKING	2011-10-12 19:04:25.000000000 +0000
+++ pacman/HACKING	2012-10-15 18:11:52.469419064 +0000
@@ -90,6 +90,61 @@
        NOT
     if(!strcmp(a, b))
 
+8.  Use spaces around almost all arithmetic, comparison and assignment
+    operators and after all ',;:' separators.
+
+	foobar[2 * size + 1] = function(a, 6);
+	   NOT
+	foobar[2*size+1]=function(a,6);
+
+	for(a = 0; a < n && n > 0; a++,n--) {}
+	   NOT
+	for(a=0;a<n&&n>0;a++,n--) {}
+
+9.  Declare all variables at the start of the block.
+[source,C]
+-------------------------------------------
+int SYMEXPORT alpm_db_remove_server(alpm_db_t *db, const char *url)
+{
+  char *newurl, *vdata = NULL;
+
+  newurl = url;
+  if(!newurl) {
+    return -1;
+  }
+
+  ...
+
+  if(vdata) {
+    ...
+  }
+
+  return 1;
+}
+-------------------------------------------
+
+    NOT
+
+[source,C]
+-------------------------------------------
+int SYMEXPORT alpm_db_remove_server(alpm_db_t *db, const char *url)
+{
+  char *newurl = url;
+
+  if(!newurl) {
+    return -1;
+  }
+
+  char *vdata = NULL;
+
+  if(vdata) {
+    ...
+  }
+
+  return 1;
+}
+-------------------------------------------
+
 
 Other Concerns
 --------------
@@ -103,8 +158,6 @@
 
 [source,C]
 -------------------------------------------
-#include "config.h"
-
 #include <standardheader.h>
 #include <another.h>
 #include <...>
@@ -133,6 +186,8 @@
 #include "anythingelse.h"
 -------------------------------------------
 
+Never directly include config.h. This will always be added via Makefiles.
+
 GDB and Valgrind Usage
 ~~~~~~~~~~~~~~~~~~~~~~
 
diff -x '.*' -aur pacman-4.0.3/Makefile.am pacman/Makefile.am
--- pacman-4.0.3/Makefile.am	2011-10-12 19:04:25.000000000 +0000
+++ pacman/Makefile.am	2012-10-15 18:11:52.469419064 +0000
@@ -1,8 +1,10 @@
-SUBDIRS = lib/libalpm src/util src/pacman scripts etc test/pacman test/util contrib
+SUBDIRS = lib/libalpm src/util src/pacman scripts etc test/pacman test/util test/scripts
 if WANT_DOC
 SUBDIRS += doc
 endif
 
+DIST_SUBDIRS = $(SUBDIRS) contrib
+
 ACLOCAL_AMFLAGS = -I m4 --install
 
 # Make sure we test and build manpages when doing distcheck
@@ -21,15 +23,27 @@
 	proto/ChangeLog.proto
 
 # run the pactest test suite and vercmp tests
-check-local: test/pacman test/util src/pacman src/util
+check-local: test-pacman test-pacsort test-vercmp test-parseopts
+
+test-pacman: test/pacman src/pacman
 	LC_ALL=C $(PYTHON) $(top_srcdir)/test/pacman/pactest.py --debug=1 \
 		--test $(top_srcdir)/test/pacman/tests/*.py \
 		-p $(top_builddir)/src/pacman/pacman
-	$(SH) $(top_srcdir)/test/util/pacsorttest.sh \
+
+test-pacsort: test/util src/util
+	$(BASH_SHELL) $(top_srcdir)/test/util/pacsorttest.sh \
 		$(top_builddir)/src/util/pacsort
-	$(SH) $(top_srcdir)/test/util/vercmptest.sh \
+
+test-vercmp: test/util src/util
+	$(BASH_SHELL) $(top_srcdir)/test/util/vercmptest.sh \
 		$(top_builddir)/src/util/vercmp
 
+test-parseopts: test/scripts scripts
+	$(BASH_SHELL) $(top_srcdir)/test/scripts/parseopts_test.sh \
+		$(top_srcdir)/scripts/library/parseopts.sh
+	$(BASH_SHELL) $(top_srcdir)/test/scripts/human_to_size_test.sh \
+		$(top_srcdir)/scripts/library/human_to_size.sh
+
 # create the pacman DB and cache directories upon install
 install-data-local:
 	for dir in "$(DESTDIR)$(localstatedir)/lib/pacman" "$(DESTDIR)$(localstatedir)/cache/pacman/pkg"; do \
@@ -41,4 +55,6 @@
 	$(MAKE) -C scripts/po update-po
 	$(MAKE) -C src/pacman/po update-po
 
+.PHONY: test-pacman test-pacsort test-vercmp test-parseopts update-po
+
 # vim:set ts=2 sw=2 noet:
diff -x '.*' -aur pacman-4.0.3/Makefile.in pacman/Makefile.in
--- pacman-4.0.3/Makefile.in	2012-04-07 15:58:14.000000000 +0000
+++ pacman/Makefile.in	2012-10-15 18:12:22.405292091 +0000
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.11.4 from Makefile.am.
+# Makefile.in generated by automake 1.12 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -54,27 +54,42 @@
 subdir = .
 DIST_COMMON = README $(am__configure_deps) $(dist_pkgdata_DATA) \
 	$(srcdir)/Makefile.am $(srcdir)/Makefile.in \
-	$(srcdir)/config.h.in $(top_srcdir)/configure AUTHORS COPYING \
-	INSTALL NEWS config.guess config.rpath config.sub depcomp \
-	install-sh ltmain.sh missing mkinstalldirs
+	$(srcdir)/config.h.in $(top_srcdir)/build-aux/config.guess \
+	$(top_srcdir)/build-aux/config.rpath \
+	$(top_srcdir)/build-aux/config.sub \
+	$(top_srcdir)/build-aux/install-sh \
+	$(top_srcdir)/build-aux/ltmain.sh \
+	$(top_srcdir)/build-aux/missing \
+	$(top_srcdir)/build-aux/mkinstalldirs $(top_srcdir)/configure \
+	AUTHORS COPYING INSTALL NEWS build-aux/config.guess \
+	build-aux/config.rpath build-aux/config.sub build-aux/depcomp \
+	build-aux/install-sh build-aux/ltmain.sh build-aux/missing \
+	build-aux/mkinstalldirs
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/m4/gettext.m4 \
+am__aclocal_m4_deps = $(top_srcdir)/m4/acinclude.m4 \
+	$(top_srcdir)/m4/gettext.m4 $(top_srcdir)/m4/gpgme.m4 \
 	$(top_srcdir)/m4/iconv.m4 $(top_srcdir)/m4/intlmacosx.m4 \
 	$(top_srcdir)/m4/lib-ld.m4 $(top_srcdir)/m4/lib-link.m4 \
-	$(top_srcdir)/m4/lib-prefix.m4 $(top_srcdir)/m4/libcurl.m4 \
-	$(top_srcdir)/m4/libtool.m4 $(top_srcdir)/m4/ltoptions.m4 \
-	$(top_srcdir)/m4/ltsugar.m4 $(top_srcdir)/m4/ltversion.m4 \
-	$(top_srcdir)/m4/lt~obsolete.m4 $(top_srcdir)/m4/nls.m4 \
+	$(top_srcdir)/m4/lib-prefix.m4 $(top_srcdir)/m4/libtool.m4 \
+	$(top_srcdir)/m4/ltoptions.m4 $(top_srcdir)/m4/ltsugar.m4 \
+	$(top_srcdir)/m4/ltversion.m4 $(top_srcdir)/m4/lt~obsolete.m4 \
+	$(top_srcdir)/m4/nls.m4 $(top_srcdir)/m4/pkg.m4 \
 	$(top_srcdir)/m4/po.m4 $(top_srcdir)/m4/progtest.m4 \
-	$(top_srcdir)/acinclude.m4 $(top_srcdir)/configure.ac
+	$(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
 am__CONFIG_DISTCLEAN_FILES = config.status config.cache config.log \
  configure.lineno config.status.lineno
-mkinstalldirs = $(SHELL) $(top_srcdir)/mkinstalldirs
+mkinstalldirs = $(SHELL) $(top_srcdir)/build-aux/mkinstalldirs
 CONFIG_HEADER = config.h
 CONFIG_CLEAN_FILES =
 CONFIG_CLEAN_VPATH_FILES =
+AM_V_GEN = $(am__v_GEN_@AM_V@)
+am__v_GEN_ = $(am__v_GEN_@AM_DEFAULT_V@)
+am__v_GEN_0 = @echo "  GEN     " $@;
+AM_V_at = $(am__v_at_@AM_V@)
+am__v_at_ = $(am__v_at_@AM_DEFAULT_V@)
+am__v_at_0 = @
 SOURCES =
 DIST_SOURCES =
 RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
@@ -122,11 +137,10 @@
   distclean-recursive maintainer-clean-recursive
 AM_RECURSIVE_TARGETS = $(RECURSIVE_TARGETS:-recursive=) \
 	$(RECURSIVE_CLEAN_TARGETS:-recursive=) tags TAGS ctags CTAGS \
-	distdir dist dist-all distcheck
+	cscope distdir dist dist-all distcheck
 ETAGS = etags
 CTAGS = ctags
-DIST_SUBDIRS = lib/libalpm src/util src/pacman scripts etc test/pacman \
-	test/util contrib doc
+CSCOPE = cscope
 DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
 distdir = $(PACKAGE)-$(VERSION)
 top_distdir = $(distdir)
@@ -136,6 +150,7 @@
       && rm -rf "$(distdir)" \
       || { sleep 5 && rm -rf "$(distdir)"; }; \
   else :; fi
+am__post_remove_distdir = $(am__remove_distdir)
 am__relativize = \
   dir0=`pwd`; \
   sed_first='s,^\([^/]*\)/.*$$,\1,'; \
@@ -163,6 +178,7 @@
   reldir="$$dir2"
 DIST_ARCHIVES = $(distdir).tar.gz
 GZIP_ENV = --best
+DIST_TARGETS = dist-gzip
 distuninstallcheck_listfiles = find . -type f -print
 am__distuninstallcheck_listfiles = $(distuninstallcheck_listfiles) \
   | sed 's|^\./|$(prefix)/|' | grep -v '$(infodir)/dir$$'
@@ -172,6 +188,7 @@
 pkgdatadir = ${datadir}/${PACKAGE}
 ACLOCAL = @ACLOCAL@
 AMTAR = @AMTAR@
+AM_DEFAULT_VERBOSITY = @AM_DEFAULT_VERBOSITY@
 AR = @AR@
 ASCIIDOC = @ASCIIDOC@
 AUTOCONF = @AUTOCONF@
@@ -187,10 +204,6 @@
 CHOST = @CHOST@
 CPP = @CPP@
 CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXCPP = @CXXCPP@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
 CYGPATH_W = @CYGPATH_W@
 DEFS = @DEFS@
 DEPDIR = @DEPDIR@
@@ -209,7 +222,11 @@
 GIT = @GIT@
 GMSGFMT = @GMSGFMT@
 GMSGFMT_015 = @GMSGFMT_015@
+GPGME_CFLAGS = @GPGME_CFLAGS@
+GPGME_CONFIG = @GPGME_CONFIG@
+GPGME_LIBS = @GPGME_LIBS@
 GREP = @GREP@
+INODECMD = @INODECMD@
 INSTALL = @INSTALL@
 INSTALL_DATA = @INSTALL_DATA@
 INSTALL_PROGRAM = @INSTALL_PROGRAM@
@@ -219,12 +236,16 @@
 INTL_MACOSX_LIBS = @INTL_MACOSX_LIBS@
 LD = @LD@
 LDFLAGS = @LDFLAGS@
-LIBCURL = @LIBCURL@
-LIBCURL_CPPFLAGS = @LIBCURL_CPPFLAGS@
+LIBARCHIVE_CFLAGS = @LIBARCHIVE_CFLAGS@
+LIBARCHIVE_LIBS = @LIBARCHIVE_LIBS@
+LIBCURL_CFLAGS = @LIBCURL_CFLAGS@
+LIBCURL_LIBS = @LIBCURL_LIBS@
 LIBICONV = @LIBICONV@
 LIBINTL = @LIBINTL@
 LIBOBJS = @LIBOBJS@
 LIBS = @LIBS@
+LIBSSL_CFLAGS = @LIBSSL_CFLAGS@
+LIBSSL_LIBS = @LIBSSL_LIBS@
 LIBTOOL = @LIBTOOL@
 LIB_VERSION = @LIB_VERSION@
 LIB_VERSION_INFO = @LIB_VERSION_INFO@
@@ -254,10 +275,14 @@
 PACKAGE_VERSION = @PACKAGE_VERSION@
 PATH_SEPARATOR = @PATH_SEPARATOR@
 PKGEXT = @PKGEXT@
+PKG_CONFIG = @PKG_CONFIG@
+PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
+PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 POSUB = @POSUB@
 PYTHON = @PYTHON@
 RANLIB = @RANLIB@
 ROOTDIR = @ROOTDIR@
+SCRIPTLET_SHELL = @SCRIPTLET_SHELL@
 SED = @SED@
 SEDINPLACE = @SEDINPLACE@
 SET_MAKE = @SET_MAKE@
@@ -270,17 +295,16 @@
 STRIP_STATIC = @STRIP_STATIC@
 USE_NLS = @USE_NLS@
 VERSION = @VERSION@
+WARNING_CFLAGS = @WARNING_CFLAGS@
 XGETTEXT = @XGETTEXT@
 XGETTEXT_015 = @XGETTEXT_015@
 XGETTEXT_EXTRA_OPTIONS = @XGETTEXT_EXTRA_OPTIONS@
-_libcurl_config = @_libcurl_config@
 abs_builddir = @abs_builddir@
 abs_srcdir = @abs_srcdir@
 abs_top_builddir = @abs_top_builddir@
 abs_top_srcdir = @abs_top_srcdir@
 ac_ct_AR = @ac_ct_AR@
 ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
 ac_ct_DUMPBIN = @ac_ct_DUMPBIN@
 am__include = @am__include@
 am__leading_dot = @am__leading_dot@
@@ -328,7 +352,8 @@
 top_builddir = @top_builddir@
 top_srcdir = @top_srcdir@
 SUBDIRS = lib/libalpm src/util src/pacman scripts etc test/pacman \
-	test/util contrib $(am__append_1)
+	test/util test/scripts $(am__append_1)
+DIST_SUBDIRS = $(SUBDIRS) contrib
 ACLOCAL_AMFLAGS = -I m4 --install
 
 # Make sure we test and build manpages when doing distcheck
@@ -410,7 +435,7 @@
 	@list='$(dist_pkgdata_DATA)'; test -n "$(pkgdatadir)" || list=; \
 	if test -n "$$list"; then \
 	  echo " $(MKDIR_P) '$(DESTDIR)$(pkgdatadir)'"; \
-	  $(MKDIR_P) '$(DESTDIR)$(pkgdatadir)' || exit 1; \
+	  $(MKDIR_P) "$(DESTDIR)$(pkgdatadir)" || exit 1; \
 	fi; \
 	for p in $$list; do \
 	  if test -f "$$p"; then d=; else d="$(srcdir)/"; fi; \
@@ -428,11 +453,11 @@
 	dir='$(DESTDIR)$(pkgdatadir)'; $(am__uninstall_files_from_dir)
 
 # This directory's subdirectories are mostly independent; you can cd
-# into them and run `make' without going through this Makefile.
-# To change the values of `make' variables: instead of editing Makefiles,
-# (1) if the variable is set in `config.status', edit `config.status'
-#     (which will cause the Makefiles to be regenerated when you run `make');
-# (2) otherwise, pass the desired values on the `make' command line.
+# into them and run 'make' without going through this Makefile.
+# To change the values of 'make' variables: instead of editing Makefiles,
+# (1) if the variable is set in 'config.status', edit 'config.status'
+#     (which will cause the Makefiles to be regenerated when you run 'make');
+# (2) otherwise, pass the desired values on the 'make' command line.
 $(RECURSIVE_TARGETS):
 	@fail= failcom='exit 1'; \
 	for f in x $$MAKEFLAGS; do \
@@ -496,6 +521,10 @@
 	list='$(SUBDIRS)'; for subdir in $$list; do \
 	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) ctags); \
 	done
+cscopelist-recursive:
+	list='$(SUBDIRS)'; for subdir in $$list; do \
+	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) cscopelist); \
+	done
 
 ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
 	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
@@ -559,8 +588,32 @@
 	  && $(am__cd) $(top_srcdir) \
 	  && gtags -i $(GTAGS_ARGS) "$$here"
 
+cscope: cscope.files
+	test ! -s cscope.files \
+	  || $(CSCOPE) -b -q $(AM_CSCOPEFLAGS) $(CSCOPEFLAGS) -i cscope.files $(CSCOPE_ARGS)
+
+clean-cscope:
+	-rm -f cscope.files
+
+cscope.files: clean-cscope cscopelist-recursive cscopelist
+
+cscopelist: cscopelist-recursive $(HEADERS) $(SOURCES) $(LISP)
+	list='$(SOURCES) $(HEADERS) $(LISP)'; \
+	case "$(srcdir)" in \
+	  [\\/]* | ?:[\\/]*) sdir="$(srcdir)" ;; \
+	  *) sdir=$(subdir)/$(srcdir) ;; \
+	esac; \
+	for i in $$list; do \
+	  if test -f "$$i"; then \
+	    echo "$(subdir)/$$i"; \
+	  else \
+	    echo "$$sdir/$$i"; \
+	  fi; \
+	done >> $(top_builddir)/cscope.files
+
 distclean-tags:
 	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+	-rm -f cscope.out cscope.in.out cscope.po.out cscope.files
 
 distdir: $(DISTFILES)
 	$(am__remove_distdir)
@@ -628,40 +681,36 @@
 	|| chmod -R a+r "$(distdir)"
 dist-gzip: distdir
 	tardir=$(distdir) && $(am__tar) | GZIP=$(GZIP_ENV) gzip -c >$(distdir).tar.gz
-	$(am__remove_distdir)
+	$(am__post_remove_distdir)
 
 dist-bzip2: distdir
 	tardir=$(distdir) && $(am__tar) | BZIP2=$${BZIP2--9} bzip2 -c >$(distdir).tar.bz2
-	$(am__remove_distdir)
+	$(am__post_remove_distdir)
 
 dist-lzip: distdir
 	tardir=$(distdir) && $(am__tar) | lzip -c $${LZIP_OPT--9} >$(distdir).tar.lz
-	$(am__remove_distdir)
-
-dist-lzma: distdir
-	tardir=$(distdir) && $(am__tar) | lzma -9 -c >$(distdir).tar.lzma
-	$(am__remove_distdir)
+	$(am__post_remove_distdir)
 
 dist-xz: distdir
 	tardir=$(distdir) && $(am__tar) | XZ_OPT=$${XZ_OPT--e} xz -c >$(distdir).tar.xz
-	$(am__remove_distdir)
+	$(am__post_remove_distdir)
 
 dist-tarZ: distdir
 	tardir=$(distdir) && $(am__tar) | compress -c >$(distdir).tar.Z
-	$(am__remove_distdir)
+	$(am__post_remove_distdir)
 
 dist-shar: distdir
 	shar $(distdir) | GZIP=$(GZIP_ENV) gzip -c >$(distdir).shar.gz
-	$(am__remove_distdir)
+	$(am__post_remove_distdir)
 
 dist-zip: distdir
 	-rm -f $(distdir).zip
 	zip -rq $(distdir).zip $(distdir)
-	$(am__remove_distdir)
+	$(am__post_remove_distdir)
 
-dist dist-all: distdir
-	tardir=$(distdir) && $(am__tar) | GZIP=$(GZIP_ENV) gzip -c >$(distdir).tar.gz
-	$(am__remove_distdir)
+dist dist-all:
+	$(MAKE) $(AM_MAKEFLAGS) $(DIST_TARGETS) am__post_remove_distdir='@:'
+	$(am__post_remove_distdir)
 
 # This target untars the dist file and tries a VPATH configuration.  Then
 # it guarantees that the distribution is self-contained by making another
@@ -672,8 +721,6 @@
 	  GZIP=$(GZIP_ENV) gzip -dc $(distdir).tar.gz | $(am__untar) ;;\
 	*.tar.bz2*) \
 	  bzip2 -dc $(distdir).tar.bz2 | $(am__untar) ;;\
-	*.tar.lzma*) \
-	  lzma -dc $(distdir).tar.lzma | $(am__untar) ;;\
 	*.tar.lz*) \
 	  lzip -dc $(distdir).tar.lz | $(am__untar) ;;\
 	*.tar.xz*) \
@@ -719,7 +766,7 @@
 	  && $(MAKE) $(AM_MAKEFLAGS) distcleancheck \
 	  && cd "$$am__cwd" \
 	  || exit 1
-	$(am__remove_distdir)
+	$(am__post_remove_distdir)
 	@(echo "$(distdir) archives ready for distribution: "; \
 	  list='$(DIST_ARCHIVES)'; for i in $$list; do echo $$i; done) | \
 	  sed -e 1h -e 1s/./=/g -e 1p -e 1x -e '$$p' -e '$$x'
@@ -859,38 +906,51 @@
 uninstall-am: uninstall-dist_pkgdataDATA
 
 .MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) all check-am \
-	ctags-recursive install-am install-strip tags-recursive
+	cscopelist-recursive ctags-recursive install-am install-strip \
+	tags-recursive
 
 .PHONY: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) CTAGS GTAGS \
 	all all-am am--refresh check check-am check-local clean \
-	clean-generic clean-libtool ctags ctags-recursive dist \
-	dist-all dist-bzip2 dist-gzip dist-lzip dist-lzma dist-shar \
-	dist-tarZ dist-xz dist-zip distcheck distclean \
-	distclean-generic distclean-hdr distclean-libtool \
-	distclean-tags distcleancheck distdir distuninstallcheck dvi \
-	dvi-am html html-am info info-am install install-am \
-	install-data install-data-am install-data-local \
-	install-dist_pkgdataDATA install-dvi install-dvi-am \
-	install-exec install-exec-am install-html install-html-am \
-	install-info install-info-am install-man install-pdf \
-	install-pdf-am install-ps install-ps-am install-strip \
-	installcheck installcheck-am installdirs installdirs-am \
-	maintainer-clean maintainer-clean-generic mostlyclean \
-	mostlyclean-generic mostlyclean-libtool pdf pdf-am ps ps-am \
-	tags tags-recursive uninstall uninstall-am \
+	clean-cscope clean-generic clean-libtool cscope cscopelist \
+	cscopelist-recursive ctags ctags-recursive dist dist-all \
+	dist-bzip2 dist-gzip dist-lzip dist-shar dist-tarZ dist-xz \
+	dist-zip distcheck distclean distclean-generic distclean-hdr \
+	distclean-libtool distclean-tags distcleancheck distdir \
+	distuninstallcheck dvi dvi-am html html-am info info-am \
+	install install-am install-data install-data-am \
+	install-data-local install-dist_pkgdataDATA install-dvi \
+	install-dvi-am install-exec install-exec-am install-html \
+	install-html-am install-info install-info-am install-man \
+	install-pdf install-pdf-am install-ps install-ps-am \
+	install-strip installcheck installcheck-am installdirs \
+	installdirs-am maintainer-clean maintainer-clean-generic \
+	mostlyclean mostlyclean-generic mostlyclean-libtool pdf pdf-am \
+	ps ps-am tags tags-recursive uninstall uninstall-am \
 	uninstall-dist_pkgdataDATA
 
 
 # run the pactest test suite and vercmp tests
-check-local: test/pacman test/util src/pacman src/util
+check-local: test-pacman test-pacsort test-vercmp test-parseopts
+
+test-pacman: test/pacman src/pacman
 	LC_ALL=C $(PYTHON) $(top_srcdir)/test/pacman/pactest.py --debug=1 \
 		--test $(top_srcdir)/test/pacman/tests/*.py \
 		-p $(top_builddir)/src/pacman/pacman
-	$(SH) $(top_srcdir)/test/util/pacsorttest.sh \
+
+test-pacsort: test/util src/util
+	$(BASH_SHELL) $(top_srcdir)/test/util/pacsorttest.sh \
 		$(top_builddir)/src/util/pacsort
-	$(SH) $(top_srcdir)/test/util/vercmptest.sh \
+
+test-vercmp: test/util src/util
+	$(BASH_SHELL) $(top_srcdir)/test/util/vercmptest.sh \
 		$(top_builddir)/src/util/vercmp
 
+test-parseopts: test/scripts scripts
+	$(BASH_SHELL) $(top_srcdir)/test/scripts/parseopts_test.sh \
+		$(top_srcdir)/scripts/library/parseopts.sh
+	$(BASH_SHELL) $(top_srcdir)/test/scripts/human_to_size_test.sh \
+		$(top_srcdir)/scripts/library/human_to_size.sh
+
 # create the pacman DB and cache directories upon install
 install-data-local:
 	for dir in "$(DESTDIR)$(localstatedir)/lib/pacman" "$(DESTDIR)$(localstatedir)/cache/pacman/pkg"; do \
@@ -902,6 +962,8 @@
 	$(MAKE) -C scripts/po update-po
 	$(MAKE) -C src/pacman/po update-po
 
+.PHONY: test-pacman test-pacsort test-vercmp test-parseopts update-po
+
 # vim:set ts=2 sw=2 noet:
 
 # Tell versions [3.59,3.63) of GNU make to not export all variables.
diff -x '.*' -aur pacman-4.0.3/README pacman/README
--- pacman-4.0.3/README	2011-10-12 19:04:25.000000000 +0000
+++ pacman/README	2012-10-15 18:11:52.469419064 +0000
@@ -389,7 +389,7 @@
 - PM_ prefixes for enum values are now ALPM_
 - pm prefixes for structs and enums are now alpm_
 - alpm_initialize now has parameters: char *root, char *dbpath,
-    _alpm_errno_t *err and returns an alpm_handle_t struct.
+    alpm_errno_t *err and returns an alpm_handle_t struct.
 - alpm_release now takes an alpm_handle_t *.
 - alpm_db_register_sync() now requires a extra parameter of a alpm_siglevel_t.
 - alpm_pkg_load() now requires an extra parameter of an alpm_siglevel_t
Only in pacman: TRANSLATORS
Only in pacman-4.0.3: acinclude.m4
diff -x '.*' -aur pacman-4.0.3/aclocal.m4 pacman/aclocal.m4
--- pacman-4.0.3/aclocal.m4	2012-04-07 15:58:12.000000000 +0000
+++ pacman/aclocal.m4	2012-10-15 18:12:20.801419171 +0000
@@ -1,4 +1,4 @@
-# generated automatically by aclocal 1.11.4 -*- Autoconf -*-
+# generated automatically by aclocal 1.12 -*- Autoconf -*-
 
 # Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004,
 # 2005, 2006, 2007, 2008, 2009, 2010, 2011 Free Software Foundation,
@@ -14,20 +14,19 @@
 
 m4_ifndef([AC_AUTOCONF_VERSION],
   [m4_copy([m4_PACKAGE_VERSION], [AC_AUTOCONF_VERSION])])dnl
-m4_if(m4_defn([AC_AUTOCONF_VERSION]), [2.68],,
-[m4_warning([this file was generated for autoconf 2.68.
+m4_if(m4_defn([AC_AUTOCONF_VERSION]), [2.69],,
+[m4_warning([this file was generated for autoconf 2.69.
 You have another version of autoconf.  It may work, but is not guaranteed to.
 If you have problems, you may need to regenerate the build system entirely.
-To do so, use the procedure documented by the package, typically `autoreconf'.])])
+To do so, use the procedure documented by the package, typically 'autoreconf'.])])
 
-# Copyright (C) 2002, 2003, 2005, 2006, 2007, 2008, 2011 Free Software
-# Foundation, Inc.
+# Copyright (C) 2002-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 1
+# serial 8
 
 # AM_AUTOMAKE_VERSION(VERSION)
 # ----------------------------
@@ -35,10 +34,10 @@
 # generated from the m4 files accompanying Automake X.Y.
 # (This private macro should not be called outside this file.)
 AC_DEFUN([AM_AUTOMAKE_VERSION],
-[am__api_version='1.11'
+[am__api_version='1.12'
 dnl Some users find AM_AUTOMAKE_VERSION and mistake it for a way to
 dnl require some minimum version.  Point them to the right macro.
-m4_if([$1], [1.11.4], [],
+m4_if([$1], [1.12], [],
       [AC_FATAL([Do not call $0, use AM_INIT_AUTOMAKE([$1]).])])dnl
 ])
 
@@ -54,24 +53,24 @@
 # Call AM_AUTOMAKE_VERSION and AM_AUTOMAKE_VERSION so they can be traced.
 # This function is AC_REQUIREd by AM_INIT_AUTOMAKE.
 AC_DEFUN([AM_SET_CURRENT_AUTOMAKE_VERSION],
-[AM_AUTOMAKE_VERSION([1.11.4])dnl
+[AM_AUTOMAKE_VERSION([1.12])dnl
 m4_ifndef([AC_AUTOCONF_VERSION],
   [m4_copy([m4_PACKAGE_VERSION], [AC_AUTOCONF_VERSION])])dnl
 _AM_AUTOCONF_VERSION(m4_defn([AC_AUTOCONF_VERSION]))])
 
 # AM_AUX_DIR_EXPAND                                         -*- Autoconf -*-
 
-# Copyright (C) 2001, 2003, 2005, 2011 Free Software Foundation, Inc.
+# Copyright (C) 2001-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 1
+# serial 2
 
 # For projects using AC_CONFIG_AUX_DIR([foo]), Autoconf sets
-# $ac_aux_dir to `$srcdir/foo'.  In other projects, it is set to
-# `$srcdir', `$srcdir/..', or `$srcdir/../..'.
+# $ac_aux_dir to '$srcdir/foo'.  In other projects, it is set to
+# '$srcdir', '$srcdir/..', or '$srcdir/../..'.
 #
 # Of course, Automake must honor this variable whenever it calls a
 # tool from the auxiliary directory.  The problem is that $srcdir (and
@@ -90,7 +89,7 @@
 #
 # The reason of the latter failure is that $top_srcdir and $ac_aux_dir
 # are both prefixed by $srcdir.  In an in-source build this is usually
-# harmless because $srcdir is `.', but things will broke when you
+# harmless because $srcdir is '.', but things will broke when you
 # start a VPATH build or use an absolute $srcdir.
 #
 # So we could use something similar to $top_srcdir/$ac_aux_dir/missing,
@@ -116,22 +115,21 @@
 
 # AM_CONDITIONAL                                            -*- Autoconf -*-
 
-# Copyright (C) 1997, 2000, 2001, 2003, 2004, 2005, 2006, 2008
-# Free Software Foundation, Inc.
+# Copyright (C) 1997-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 9
+# serial 10
 
 # AM_CONDITIONAL(NAME, SHELL-CONDITION)
 # -------------------------------------
 # Define a conditional.
 AC_DEFUN([AM_CONDITIONAL],
-[AC_PREREQ(2.52)dnl
- ifelse([$1], [TRUE],  [AC_FATAL([$0: invalid condition: $1])],
-	[$1], [FALSE], [AC_FATAL([$0: invalid condition: $1])])dnl
+[AC_PREREQ([2.52])dnl
+ m4_if([$1], [TRUE],  [AC_FATAL([$0: invalid condition: $1])],
+       [$1], [FALSE], [AC_FATAL([$0: invalid condition: $1])])dnl
 AC_SUBST([$1_TRUE])dnl
 AC_SUBST([$1_FALSE])dnl
 _AM_SUBST_NOTMAKE([$1_TRUE])dnl
@@ -150,16 +148,15 @@
 Usually this means the macro was only invoked conditionally.]])
 fi])])
 
-# Copyright (C) 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2009,
-# 2010, 2011 Free Software Foundation, Inc.
+# Copyright (C) 1999-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 12
+# serial 16
 
-# There are a few dirty hacks below to avoid letting `AC_PROG_CC' be
+# There are a few dirty hacks below to avoid letting 'AC_PROG_CC' be
 # written in clear, in which case automake, when reading aclocal.m4,
 # will think it sees a *use*, and therefore will trigger all it's
 # C support machinery.  Also note that it means that autoscan, seeing
@@ -182,12 +179,12 @@
 AC_REQUIRE([AM_MAKE_INCLUDE])dnl
 AC_REQUIRE([AM_DEP_TRACK])dnl
 
-ifelse([$1], CC,   [depcc="$CC"   am_compiler_list=],
-       [$1], CXX,  [depcc="$CXX"  am_compiler_list=],
-       [$1], OBJC, [depcc="$OBJC" am_compiler_list='gcc3 gcc'],
-       [$1], UPC,  [depcc="$UPC"  am_compiler_list=],
-       [$1], GCJ,  [depcc="$GCJ"  am_compiler_list='gcc3 gcc'],
-                   [depcc="$$1"   am_compiler_list=])
+m4_if([$1], [CC],   [depcc="$CC"   am_compiler_list=],
+      [$1], [CXX],  [depcc="$CXX"  am_compiler_list=],
+      [$1], [OBJC], [depcc="$OBJC" am_compiler_list='gcc3 gcc'],
+      [$1], [UPC],  [depcc="$UPC"  am_compiler_list=],
+      [$1], [GCJ],  [depcc="$GCJ"  am_compiler_list='gcc3 gcc'],
+                    [depcc="$$1"   am_compiler_list=])
 
 AC_CACHE_CHECK([dependency style of $depcc],
                [am_cv_$1_dependencies_compiler_type],
@@ -195,8 +192,8 @@
   # We make a subdir and do the tests there.  Otherwise we can end up
   # making bogus files that we don't know about and never remove.  For
   # instance it was reported that on HP-UX the gcc test will end up
-  # making a dummy file named `D' -- because `-MD' means `put the output
-  # in D'.
+  # making a dummy file named 'D' -- because '-MD' means "put the output
+  # in D".
   rm -rf conftest.dir
   mkdir conftest.dir
   # Copy depcomp to subdir because otherwise we won't find it if we're
@@ -236,16 +233,16 @@
     : > sub/conftest.c
     for i in 1 2 3 4 5 6; do
       echo '#include "conftst'$i'.h"' >> sub/conftest.c
-      # Using `: > sub/conftst$i.h' creates only sub/conftst1.h with
-      # Solaris 8's {/usr,}/bin/sh.
-      touch sub/conftst$i.h
+      # Using ": > sub/conftst$i.h" creates only sub/conftst1.h with
+      # Solaris 10 /bin/sh.
+      echo '/* dummy */' > sub/conftst$i.h
     done
     echo "${am__include} ${am__quote}sub/conftest.Po${am__quote}" > confmf
 
-    # We check with `-c' and `-o' for the sake of the "dashmstdout"
+    # We check with '-c' and '-o' for the sake of the "dashmstdout"
     # mode.  It turns out that the SunPro C++ compiler does not properly
-    # handle `-M -o', and we need to detect this.  Also, some Intel
-    # versions had trouble with output in subdirs
+    # handle '-M -o', and we need to detect this.  Also, some Intel
+    # versions had trouble with output in subdirs.
     am__obj=sub/conftest.${OBJEXT-o}
     am__minus_obj="-o $am__obj"
     case $depmode in
@@ -254,8 +251,8 @@
       test "$am__universal" = false || continue
       ;;
     nosideeffect)
-      # after this tag, mechanisms are not by side-effect, so they'll
-      # only be used when explicitly requested
+      # After this tag, mechanisms are not by side-effect, so they'll
+      # only be used when explicitly requested.
       if test "x$enable_dependency_tracking" = xyes; then
 	continue
       else
@@ -263,7 +260,7 @@
       fi
       ;;
     msvc7 | msvc7msys | msvisualcpp | msvcmsys)
-      # This compiler won't grok `-c -o', but also, the minuso test has
+      # This compiler won't grok '-c -o', but also, the minuso test has
       # not run yet.  These depmodes are late enough in the game, and
       # so weak that their functioning should not be impacted.
       am__obj=conftest.${OBJEXT-o}
@@ -311,7 +308,7 @@
 # AM_SET_DEPDIR
 # -------------
 # Choose a directory name for dependency files.
-# This macro is AC_REQUIREd in _AM_DEPENDENCIES
+# This macro is AC_REQUIREd in _AM_DEPENDENCIES.
 AC_DEFUN([AM_SET_DEPDIR],
 [AC_REQUIRE([AM_SET_LEADING_DOT])dnl
 AC_SUBST([DEPDIR], ["${am__leading_dot}deps"])dnl
@@ -321,9 +318,13 @@
 # AM_DEP_TRACK
 # ------------
 AC_DEFUN([AM_DEP_TRACK],
-[AC_ARG_ENABLE(dependency-tracking,
-[  --disable-dependency-tracking  speeds up one-time build
-  --enable-dependency-tracking   do not reject slow dependency extractors])
+[AC_ARG_ENABLE([dependency-tracking], [dnl
+AS_HELP_STRING(
+  [--enable-dependency-tracking],
+  [do not reject slow dependency extractors])
+AS_HELP_STRING(
+  [--disable-dependency-tracking],
+  [speeds up one-time build])])
 if test "x$enable_dependency_tracking" != xno; then
   am_depcomp="$ac_aux_dir/depcomp"
   AMDEPBACKSLASH='\'
@@ -338,14 +339,13 @@
 
 # Generate code to set up dependency tracking.              -*- Autoconf -*-
 
-# Copyright (C) 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2008
-# Free Software Foundation, Inc.
+# Copyright (C) 1999-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-#serial 5
+# serial 6
 
 # _AM_OUTPUT_DEPENDENCY_COMMANDS
 # ------------------------------
@@ -364,7 +364,7 @@
     # Strip MF so we end up with the name of the file.
     mf=`echo "$mf" | sed -e 's/:.*$//'`
     # Check whether this is an Automake generated Makefile or not.
-    # We used to match only the files named `Makefile.in', but
+    # We used to match only the files named 'Makefile.in', but
     # some people rename them; so instead we look at the file content.
     # Grep'ing the first line is not enough: some people post-process
     # each Makefile.in and add a new line on top of each file to say so.
@@ -376,21 +376,19 @@
       continue
     fi
     # Extract the definition of DEPDIR, am__include, and am__quote
-    # from the Makefile without running `make'.
+    # from the Makefile without running 'make'.
     DEPDIR=`sed -n 's/^DEPDIR = //p' < "$mf"`
     test -z "$DEPDIR" && continue
     am__include=`sed -n 's/^am__include = //p' < "$mf"`
     test -z "am__include" && continue
     am__quote=`sed -n 's/^am__quote = //p' < "$mf"`
-    # When using ansi2knr, U may be empty or an underscore; expand it
-    U=`sed -n 's/^U = //p' < "$mf"`
     # Find all dependency output files, they are included files with
     # $(DEPDIR) in their names.  We invoke sed twice because it is the
     # simplest approach to changing $(DEPDIR) to its actual value in the
     # expansion.
     for file in `sed -n "
       s/^$am__include $am__quote\(.*(DEPDIR).*\)$am__quote"'$/\1/p' <"$mf" | \
-	 sed -e 's/\$(DEPDIR)/'"$DEPDIR"'/g' -e 's/\$U/'"$U"'/g'`; do
+	 sed -e 's/\$(DEPDIR)/'"$DEPDIR"'/g'`; do
       # Make sure the directory exists.
       test -f "$dirpart/$file" && continue
       fdir=`AS_DIRNAME(["$file"])`
@@ -408,7 +406,7 @@
 # This macro should only be invoked once -- use via AC_REQUIRE.
 #
 # This code is only required when automatic dependency tracking
-# is enabled.  FIXME.  This creates each `.P' file that we will
+# is enabled.  FIXME.  This creates each '.P' file that we will
 # need in order to bootstrap the dependency handling code.
 AC_DEFUN([AM_OUTPUT_DEPENDENCY_COMMANDS],
 [AC_CONFIG_COMMANDS([depfiles],
@@ -418,14 +416,13 @@
 
 # Do all the work for Automake.                             -*- Autoconf -*-
 
-# Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004,
-# 2005, 2006, 2008, 2009 Free Software Foundation, Inc.
+# Copyright (C) 1996-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 16
+# serial 18
 
 # This macro actually does too much.  Some checks are only needed if
 # your package does certain things.  But this isn't really a big deal.
@@ -476,23 +473,25 @@
  AC_SUBST([VERSION], [$2])],
 [_AM_SET_OPTIONS([$1])dnl
 dnl Diagnose old-style AC_INIT with new-style AM_AUTOMAKE_INIT.
-m4_if(m4_ifdef([AC_PACKAGE_NAME], 1)m4_ifdef([AC_PACKAGE_VERSION], 1), 11,,
+m4_if(
+  m4_ifdef([AC_PACKAGE_NAME], [ok]):m4_ifdef([AC_PACKAGE_VERSION], [ok]),
+  [ok:ok],,
   [m4_fatal([AC_INIT should be called with package and version arguments])])dnl
  AC_SUBST([PACKAGE], ['AC_PACKAGE_TARNAME'])dnl
  AC_SUBST([VERSION], ['AC_PACKAGE_VERSION'])])dnl
 
 _AM_IF_OPTION([no-define],,
-[AC_DEFINE_UNQUOTED(PACKAGE, "$PACKAGE", [Name of package])
- AC_DEFINE_UNQUOTED(VERSION, "$VERSION", [Version number of package])])dnl
+[AC_DEFINE_UNQUOTED([PACKAGE], ["$PACKAGE"], [Name of package])
+ AC_DEFINE_UNQUOTED([VERSION], ["$VERSION"], [Version number of package])])dnl
 
 # Some tools Automake needs.
 AC_REQUIRE([AM_SANITY_CHECK])dnl
 AC_REQUIRE([AC_ARG_PROGRAM])dnl
-AM_MISSING_PROG(ACLOCAL, aclocal-${am__api_version})
-AM_MISSING_PROG(AUTOCONF, autoconf)
-AM_MISSING_PROG(AUTOMAKE, automake-${am__api_version})
-AM_MISSING_PROG(AUTOHEADER, autoheader)
-AM_MISSING_PROG(MAKEINFO, makeinfo)
+AM_MISSING_PROG([ACLOCAL], [aclocal-${am__api_version}])
+AM_MISSING_PROG([AUTOCONF], [autoconf])
+AM_MISSING_PROG([AUTOMAKE], [automake-${am__api_version}])
+AM_MISSING_PROG([AUTOHEADER], [autoheader])
+AM_MISSING_PROG([MAKEINFO], [makeinfo])
 AC_REQUIRE([AM_PROG_INSTALL_SH])dnl
 AC_REQUIRE([AM_PROG_INSTALL_STRIP])dnl
 AC_REQUIRE([AM_PROG_MKDIR_P])dnl
@@ -506,28 +505,28 @@
 			     [_AM_PROG_TAR([v7])])])
 _AM_IF_OPTION([no-dependencies],,
 [AC_PROVIDE_IFELSE([AC_PROG_CC],
-		  [_AM_DEPENDENCIES(CC)],
+		  [_AM_DEPENDENCIES([CC])],
 		  [define([AC_PROG_CC],
-			  defn([AC_PROG_CC])[_AM_DEPENDENCIES(CC)])])dnl
+			  defn([AC_PROG_CC])[_AM_DEPENDENCIES([CC])])])dnl
 AC_PROVIDE_IFELSE([AC_PROG_CXX],
-		  [_AM_DEPENDENCIES(CXX)],
+		  [_AM_DEPENDENCIES([CXX])],
 		  [define([AC_PROG_CXX],
-			  defn([AC_PROG_CXX])[_AM_DEPENDENCIES(CXX)])])dnl
+			  defn([AC_PROG_CXX])[_AM_DEPENDENCIES([CXX])])])dnl
 AC_PROVIDE_IFELSE([AC_PROG_OBJC],
-		  [_AM_DEPENDENCIES(OBJC)],
+		  [_AM_DEPENDENCIES([OBJC])],
 		  [define([AC_PROG_OBJC],
-			  defn([AC_PROG_OBJC])[_AM_DEPENDENCIES(OBJC)])])dnl
+			  defn([AC_PROG_OBJC])[_AM_DEPENDENCIES([OBJC])])])dnl
 ])
 _AM_IF_OPTION([silent-rules], [AC_REQUIRE([AM_SILENT_RULES])])dnl
-dnl The `parallel-tests' driver may need to know about EXEEXT, so add the
-dnl `am__EXEEXT' conditional if _AM_COMPILER_EXEEXT was seen.  This macro
+dnl The 'parallel-tests' driver may need to know about EXEEXT, so add the
+dnl 'am__EXEEXT' conditional if _AM_COMPILER_EXEEXT was seen.  This macro
 dnl is hooked onto _AC_COMPILER_EXEEXT early, see below.
 AC_CONFIG_COMMANDS_PRE(dnl
 [m4_provide_if([_AM_COMPILER_EXEEXT],
   [AM_CONDITIONAL([am__EXEEXT], [test -n "$EXEEXT"])])])dnl
 ])
 
-dnl Hook into `_AC_COMPILER_EXEEXT' early to learn its expansion.  Do not
+dnl Hook into '_AC_COMPILER_EXEEXT' early to learn its expansion.  Do not
 dnl add the conditional right here, as _AC_COMPILER_EXEEXT may be further
 dnl mangled by Autoconf and run in a shell conditional statement.
 m4_define([_AC_COMPILER_EXEEXT],
@@ -555,14 +554,13 @@
 done
 echo "timestamp for $_am_arg" >`AS_DIRNAME(["$_am_arg"])`/stamp-h[]$_am_stamp_count])
 
-# Copyright (C) 2001, 2003, 2005, 2008, 2011 Free Software Foundation,
-# Inc.
+# Copyright (C) 2001-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 1
+# serial 8
 
 # AM_PROG_INSTALL_SH
 # ------------------
@@ -577,9 +575,9 @@
     install_sh="\${SHELL} $am_aux_dir/install-sh"
   esac
 fi
-AC_SUBST(install_sh)])
+AC_SUBST([install_sh])])
 
-# Copyright (C) 2003, 2005  Free Software Foundation, Inc.
+# Copyright (C) 2003-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -602,13 +600,13 @@
 
 # Check to see how 'make' treats includes.	            -*- Autoconf -*-
 
-# Copyright (C) 2001, 2002, 2003, 2005, 2009  Free Software Foundation, Inc.
+# Copyright (C) 2001-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 4
+# serial 5
 
 # AM_MAKE_INCLUDE()
 # -----------------
@@ -627,7 +625,7 @@
 _am_result=none
 # First try GNU make style include.
 echo "include confinc" > confmf
-# Ignore all kinds of additional output from `make'.
+# Ignore all kinds of additional output from 'make'.
 case `$am_make -s -f confmf 2> /dev/null` in #(
 *the\ am__doit\ target*)
   am__include=include
@@ -654,14 +652,13 @@
 
 # Fake the existence of programs that GNU maintainers use.  -*- Autoconf -*-
 
-# Copyright (C) 1997, 1999, 2000, 2001, 2003, 2004, 2005, 2008
-# Free Software Foundation, Inc.
+# Copyright (C) 1997-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 6
+# serial 7
 
 # AM_MISSING_PROG(NAME, PROGRAM)
 # ------------------------------
@@ -691,22 +688,21 @@
   am_missing_run="$MISSING --run "
 else
   am_missing_run=
-  AC_MSG_WARN([`missing' script is too old or missing])
+  AC_MSG_WARN(['missing' script is too old or missing])
 fi
 ])
 
-# Copyright (C) 2003, 2004, 2005, 2006, 2011 Free Software Foundation,
-# Inc.
+# Copyright (C) 2003-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 1
+# serial 2
 
 # AM_PROG_MKDIR_P
 # ---------------
-# Check for `mkdir -p'.
+# Check for 'mkdir -p'.
 AC_DEFUN([AM_PROG_MKDIR_P],
 [AC_PREREQ([2.60])dnl
 AC_REQUIRE([AC_PROG_MKDIR_P])dnl
@@ -726,14 +722,13 @@
 
 # Helper functions for option handling.                     -*- Autoconf -*-
 
-# Copyright (C) 2001, 2002, 2003, 2005, 2008, 2010 Free Software
-# Foundation, Inc.
+# Copyright (C) 2001-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 5
+# serial 6
 
 # _AM_MANGLE_OPTION(NAME)
 # -----------------------
@@ -744,7 +739,7 @@
 # --------------------
 # Set option NAME.  Presently that only means defining a flag for this option.
 AC_DEFUN([_AM_SET_OPTION],
-[m4_define(_AM_MANGLE_OPTION([$1]), 1)])
+[m4_define(_AM_MANGLE_OPTION([$1]), [1])])
 
 # _AM_SET_OPTIONS(OPTIONS)
 # ------------------------
@@ -760,22 +755,18 @@
 
 # Check to make sure that the build environment is sane.    -*- Autoconf -*-
 
-# Copyright (C) 1996, 1997, 2000, 2001, 2003, 2005, 2008
-# Free Software Foundation, Inc.
+# Copyright (C) 1996-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 5
+# serial 9
 
 # AM_SANITY_CHECK
 # ---------------
 AC_DEFUN([AM_SANITY_CHECK],
 [AC_MSG_CHECKING([whether build environment is sane])
-# Just in case
-sleep 1
-echo timestamp > conftest.file
 # Reject unsafe characters in $srcdir or the absolute working directory
 # name.  Accept space and tab only in the latter.
 am_lf='
@@ -786,32 +777,40 @@
 esac
 case $srcdir in
   *[[\\\"\#\$\&\'\`$am_lf\ \	]]*)
-    AC_MSG_ERROR([unsafe srcdir value: `$srcdir']);;
+    AC_MSG_ERROR([unsafe srcdir value: '$srcdir']);;
 esac
 
-# Do `set' in a subshell so we don't clobber the current shell's
+# Do 'set' in a subshell so we don't clobber the current shell's
 # arguments.  Must try -L first in case configure is actually a
 # symlink; some systems play weird games with the mod time of symlinks
 # (eg FreeBSD returns the mod time of the symlink's containing
 # directory).
 if (
-   set X `ls -Lt "$srcdir/configure" conftest.file 2> /dev/null`
-   if test "$[*]" = "X"; then
-      # -L didn't work.
-      set X `ls -t "$srcdir/configure" conftest.file`
-   fi
-   rm -f conftest.file
-   if test "$[*]" != "X $srcdir/configure conftest.file" \
-      && test "$[*]" != "X conftest.file $srcdir/configure"; then
-
-      # If neither matched, then we have a broken ls.  This can happen
-      # if, for instance, CONFIG_SHELL is bash and it inherits a
-      # broken ls alias from the environment.  This has actually
-      # happened.  Such a system could not be considered "sane".
-      AC_MSG_ERROR([ls -t appears to fail.  Make sure there is not a broken
-alias in your environment])
-   fi
-
+   am_has_slept=no
+   for am_try in 1 2; do
+     echo "timestamp, slept: $am_has_slept" > conftest.file
+     set X `ls -Lt "$srcdir/configure" conftest.file 2> /dev/null`
+     if test "$[*]" = "X"; then
+	# -L didn't work.
+	set X `ls -t "$srcdir/configure" conftest.file`
+     fi
+     if test "$[*]" != "X $srcdir/configure conftest.file" \
+	&& test "$[*]" != "X conftest.file $srcdir/configure"; then
+
+	# If neither matched, then we have a broken ls.  This can happen
+	# if, for instance, CONFIG_SHELL is bash and it inherits a
+	# broken ls alias from the environment.  This has actually
+	# happened.  Such a system could not be considered "sane".
+	AC_MSG_ERROR([ls -t appears to fail.  Make sure there is not a broken
+  alias in your environment])
+     fi
+     if test "$[2]" = conftest.file || test $am_try -eq 2; then
+       break
+     fi
+     # Just in case.
+     sleep 1
+     am_has_slept=yes
+   done
    test "$[2]" = conftest.file
    )
 then
@@ -821,39 +820,117 @@
    AC_MSG_ERROR([newly created file is older than distributed files!
 Check your system clock])
 fi
-AC_MSG_RESULT(yes)])
+AC_MSG_RESULT([yes])
+# If we didn't sleep, we still need to ensure time stamps of config.status and
+# generated files are strictly newer.
+am_sleep_pid=
+if grep 'slept: no' conftest.file >/dev/null 2>&1; then
+  ( sleep 1 ) &
+  am_sleep_pid=$!
+fi
+AC_CONFIG_COMMANDS_PRE(
+  [AC_MSG_CHECKING([that generated files are newer than configure])
+   if test -n "$am_sleep_pid"; then
+     # Hide warnings about reused PIDs.
+     wait $am_sleep_pid 2>/dev/null
+   fi
+   AC_MSG_RESULT([done])])
+rm -f conftest.file
+])
+
+# Copyright (C) 2009-2012 Free Software Foundation, Inc.
+#
+# This file is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# serial 3
+
+# AM_SILENT_RULES([DEFAULT])
+# --------------------------
+# Enable less verbose build rules; with the default set to DEFAULT
+# ("yes" being less verbose, "no" or empty being verbose).
+AC_DEFUN([AM_SILENT_RULES],
+[AC_ARG_ENABLE([silent-rules], [dnl
+AS_HELP_STRING(
+  [--enable-silent-rules],
+  [less verbose build output (undo: "make V=1")])
+AS_HELP_STRING(
+  [--disable-silent-rules],
+  [verbose build output (undo: "make V=0")])dnl
+])
+case $enable_silent_rules in @%:@ (((
+  yes) AM_DEFAULT_VERBOSITY=0;;
+   no) AM_DEFAULT_VERBOSITY=1;;
+    *) AM_DEFAULT_VERBOSITY=m4_if([$1], [yes], [0], [1]);;
+esac
+dnl
+dnl A few 'make' implementations (e.g., NonStop OS and NextStep)
+dnl do not support nested variable expansions.
+dnl See automake bug#9928 and bug#10237.
+am_make=${MAKE-make}
+AC_CACHE_CHECK([whether $am_make supports nested variables],
+   [am_cv_make_support_nested_variables],
+   [if AS_ECHO([['TRUE=$(BAR$(V))
+BAR0=false
+BAR1=true
+V=1
+am__doit:
+	@$(TRUE)
+.PHONY: am__doit']]) | $am_make -f - >/dev/null 2>&1; then
+  am_cv_make_support_nested_variables=yes
+else
+  am_cv_make_support_nested_variables=no
+fi])
+if test $am_cv_make_support_nested_variables = yes; then
+  dnl Using '$V' instead of '$(V)' breaks IRIX make.
+  AM_V='$(V)'
+  AM_DEFAULT_V='$(AM_DEFAULT_VERBOSITY)'
+else
+  AM_V=$AM_DEFAULT_VERBOSITY
+  AM_DEFAULT_V=$AM_DEFAULT_VERBOSITY
+fi
+AC_SUBST([AM_V])dnl
+AM_SUBST_NOTMAKE([AM_V])dnl
+AC_SUBST([AM_DEFAULT_V])dnl
+AM_SUBST_NOTMAKE([AM_DEFAULT_V])dnl
+AC_SUBST([AM_DEFAULT_VERBOSITY])dnl
+AM_BACKSLASH='\'
+AC_SUBST([AM_BACKSLASH])dnl
+_AM_SUBST_NOTMAKE([AM_BACKSLASH])dnl
+])
 
-# Copyright (C) 2001, 2003, 2005, 2011 Free Software Foundation, Inc.
+# Copyright (C) 2001-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 1
+# serial 2
 
 # AM_PROG_INSTALL_STRIP
 # ---------------------
-# One issue with vendor `install' (even GNU) is that you can't
+# One issue with vendor 'install' (even GNU) is that you can't
 # specify the program used to strip binaries.  This is especially
 # annoying in cross-compiling environments, where the build's strip
 # is unlikely to handle the host's binaries.
 # Fortunately install-sh will honor a STRIPPROG variable, so we
-# always use install-sh in `make install-strip', and initialize
+# always use install-sh in "make install-strip", and initialize
 # STRIPPROG with the value of the STRIP variable (set by the user).
 AC_DEFUN([AM_PROG_INSTALL_STRIP],
 [AC_REQUIRE([AM_PROG_INSTALL_SH])dnl
-# Installed binaries are usually stripped using `strip' when the user
-# run `make install-strip'.  However `strip' might not be the right
+# Installed binaries are usually stripped using 'strip' when the user
+# run "make install-strip".  However 'strip' might not be the right
 # tool to use in cross-compilation environments, therefore Automake
-# will honor the `STRIP' environment variable to overrule this program.
-dnl Don't test for $cross_compiling = yes, because it might be `maybe'.
+# will honor the 'STRIP' environment variable to overrule this program.
+dnl Don't test for $cross_compiling = yes, because it might be 'maybe'.
 if test "$cross_compiling" != no; then
   AC_CHECK_TOOL([STRIP], [strip], :)
 fi
 INSTALL_STRIP_PROGRAM="\$(install_sh) -c -s"
 AC_SUBST([INSTALL_STRIP_PROGRAM])])
 
-# Copyright (C) 2006, 2008, 2010 Free Software Foundation, Inc.
+# Copyright (C) 2006-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -874,18 +951,18 @@
 
 # Check how to create a tarball.                            -*- Autoconf -*-
 
-# Copyright (C) 2004, 2005, 2012 Free Software Foundation, Inc.
+# Copyright (C) 2004-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 2
+# serial 3
 
 # _AM_PROG_TAR(FORMAT)
 # --------------------
 # Check how to create a tarball in format FORMAT.
-# FORMAT should be one of `v7', `ustar', or `pax'.
+# FORMAT should be one of 'v7', 'ustar', or 'pax'.
 #
 # Substitute a variable $(am__tar) that is a command
 # writing to stdout a FORMAT-tarball containing the directory
@@ -908,7 +985,7 @@
 _am_tools='gnutar m4_if([$1], [ustar], [plaintar]) pax cpio none'
 _am_tools=${am_cv_prog_tar_$1-$_am_tools}
 # Do not fold the above two line into one, because Tru64 sh and
-# Solaris sh will not grok spaces in the rhs of `-'.
+# Solaris sh will not grok spaces in the rhs of '-'.
 for _am_tool in $_am_tools
 do
   case $_am_tool in
@@ -969,19 +1046,20 @@
 AC_SUBST([am__untar])
 ]) # _AM_PROG_TAR
 
+m4_include([m4/acinclude.m4])
 m4_include([m4/gettext.m4])
+m4_include([m4/gpgme.m4])
 m4_include([m4/iconv.m4])
 m4_include([m4/intlmacosx.m4])
 m4_include([m4/lib-ld.m4])
 m4_include([m4/lib-link.m4])
 m4_include([m4/lib-prefix.m4])
-m4_include([m4/libcurl.m4])
 m4_include([m4/libtool.m4])
 m4_include([m4/ltoptions.m4])
 m4_include([m4/ltsugar.m4])
 m4_include([m4/ltversion.m4])
 m4_include([m4/lt~obsolete.m4])
 m4_include([m4/nls.m4])
+m4_include([m4/pkg.m4])
 m4_include([m4/po.m4])
 m4_include([m4/progtest.m4])
-m4_include([acinclude.m4])
Only in pacman: autoclean.sh
Only in pacman: autogen.sh
Only in pacman: autom4te.cache
Only in pacman: build-aux
Only in pacman-4.0.3: config.guess
diff -x '.*' -aur pacman-4.0.3/config.h.in pacman/config.h.in
--- pacman-4.0.3/config.h.in	2012-04-07 15:58:27.000000000 +0000
+++ pacman/config.h.in	2012-10-15 18:10:45.673914634 +0000
@@ -3,6 +3,9 @@
 /* The build script name used by makepkg */
 #undef BUILDSCRIPT
 
+/* Define if host OS is cygwin */
+#undef CYGWIN
+
 /* Define if gnu89 inlining semantics should be used. */
 #undef ENABLE_GNU89_INLINE_CC
 
@@ -86,13 +89,10 @@
 /* Define to 1 if you have the <inttypes.h> header file. */
 #undef HAVE_INTTYPES_H
 
-/* Define to 1 if you have the `archive' library (-larchive). */
-#undef HAVE_LIBARCHIVE
-
-/* Define to 1 if you have a functional curl library. */
+/* Define if libcurl is available */
 #undef HAVE_LIBCURL
 
-/* Define to 1 if you have the `gpgme' library (-lgpgme). */
+/* Define if gpgme should be used to provide GPG signature support. */
 #undef HAVE_LIBGPGME
 
 /* Define to 1 if you have the <libintl.h> header file. */
@@ -101,7 +101,7 @@
 /* Define to 1 if you have the `m' library (-lm). */
 #undef HAVE_LIBM
 
-/* Define to 1 if you have the `ssl' library (-lssl). */
+/* Define if libcrypto is available */
 #undef HAVE_LIBSSL
 
 /* Define to 1 if you have the <limits.h> header file. */
@@ -114,9 +114,6 @@
    to 0 otherwise. */
 #undef HAVE_MALLOC
 
-/* Define to 1 if you have the <mcheck.h> header file. */
-#undef HAVE_MCHECK_H
-
 /* Define to 1 if you have the `memmove' function. */
 #undef HAVE_MEMMOVE
 
@@ -214,6 +211,9 @@
 /* Define to 1 if `f_flag' is a member of `struct statvfs'. */
 #undef HAVE_STRUCT_STATVFS_F_FLAG
 
+/* Define to 1 if `st_blksize' is a member of `struct stat'. */
+#undef HAVE_STRUCT_STAT_ST_BLKSIZE
+
 /* Define to 1 if you have the `swprintf' function. */
 #undef HAVE_SWPRINTF
 
@@ -285,69 +285,6 @@
 /* Define to 1 if `vfork' works. */
 #undef HAVE_WORKING_VFORK
 
-/* Defined if libcurl supports AsynchDNS */
-#undef LIBCURL_FEATURE_ASYNCHDNS
-
-/* Defined if libcurl supports IDN */
-#undef LIBCURL_FEATURE_IDN
-
-/* Defined if libcurl supports IPv6 */
-#undef LIBCURL_FEATURE_IPV6
-
-/* Defined if libcurl supports KRB4 */
-#undef LIBCURL_FEATURE_KRB4
-
-/* Defined if libcurl supports libz */
-#undef LIBCURL_FEATURE_LIBZ
-
-/* Defined if libcurl supports NTLM */
-#undef LIBCURL_FEATURE_NTLM
-
-/* Defined if libcurl supports SSL */
-#undef LIBCURL_FEATURE_SSL
-
-/* Defined if libcurl supports SSPI */
-#undef LIBCURL_FEATURE_SSPI
-
-/* Defined if libcurl supports DICT */
-#undef LIBCURL_PROTOCOL_DICT
-
-/* Defined if libcurl supports FILE */
-#undef LIBCURL_PROTOCOL_FILE
-
-/* Defined if libcurl supports FTP */
-#undef LIBCURL_PROTOCOL_FTP
-
-/* Defined if libcurl supports FTPS */
-#undef LIBCURL_PROTOCOL_FTPS
-
-/* Defined if libcurl supports HTTP */
-#undef LIBCURL_PROTOCOL_HTTP
-
-/* Defined if libcurl supports HTTPS */
-#undef LIBCURL_PROTOCOL_HTTPS
-
-/* Defined if libcurl supports IMAP */
-#undef LIBCURL_PROTOCOL_IMAP
-
-/* Defined if libcurl supports LDAP */
-#undef LIBCURL_PROTOCOL_LDAP
-
-/* Defined if libcurl supports POP3 */
-#undef LIBCURL_PROTOCOL_POP3
-
-/* Defined if libcurl supports RTSP */
-#undef LIBCURL_PROTOCOL_RTSP
-
-/* Defined if libcurl supports SMTP */
-#undef LIBCURL_PROTOCOL_SMTP
-
-/* Defined if libcurl supports TELNET */
-#undef LIBCURL_PROTOCOL_TELNET
-
-/* Defined if libcurl supports TFTP */
-#undef LIBCURL_PROTOCOL_TFTP
-
 /* libalpm version number */
 #undef LIB_VERSION
 
@@ -389,6 +326,12 @@
 /* The file extension used by pacman packages */
 #undef PKGEXT
 
+/* The location of the root operating directory */
+#undef ROOTDIR
+
+/* The full path of the shell used to run install scriptlets */
+#undef SCRIPTLET_SHELL
+
 /* The file extension used by pacman source packages */
 #undef SRCEXT
 
@@ -407,15 +350,17 @@
 /* Version number of package */
 #undef VERSION
 
+/* Enable large inode numbers on Mac OS X 10.5.  */
+#ifndef _DARWIN_USE_64_BIT_INODE
+# define _DARWIN_USE_64_BIT_INODE 1
+#endif
+
 /* Number of bits in a file offset, on hosts where this is settable. */
 #undef _FILE_OFFSET_BITS
 
 /* Define for large files, on AIX-style hosts. */
 #undef _LARGE_FILES
 
-/* Define curl_free() as free() if our version of curl lacks curl_free. */
-#undef curl_free
-
 /* Define to `int' if <sys/types.h> doesn't define. */
 #undef gid_t
 
Only in pacman-4.0.3: config.rpath
Only in pacman-4.0.3: config.sub
diff -x '.*' -aur pacman-4.0.3/configure pacman/configure
--- pacman-4.0.3/configure	2012-04-07 15:58:13.000000000 +0000
+++ pacman/configure	2012-10-15 18:12:24.053541090 +0000
@@ -1,13 +1,11 @@
 #! /bin/sh
 # Guess values for system-dependent variables and create Makefiles.
-# Generated by GNU Autoconf 2.68 for pacman 4.0.3.
+# Generated by GNU Autoconf 2.69 for pacman 4.0.3.
 #
 # Report bugs to <pacman-dev@archlinux.org>.
 #
 #
-# Copyright (C) 1992, 1993, 1994, 1995, 1996, 1998, 1999, 2000, 2001,
-# 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010 Free Software
-# Foundation, Inc.
+# Copyright (C) 1992-1996, 1998-2012 Free Software Foundation, Inc.
 #
 #
 # This configure script is free software; the Free Software Foundation
@@ -136,6 +134,31 @@
 # CDPATH.
 (unset CDPATH) >/dev/null 2>&1 && unset CDPATH
 
+# Use a proper internal environment variable to ensure we don't fall
+  # into an infinite loop, continuously re-executing ourselves.
+  if test x"${_as_can_reexec}" != xno && test "x$CONFIG_SHELL" != x; then
+    _as_can_reexec=no; export _as_can_reexec;
+    # We cannot yet assume a decent shell, so we have to provide a
+# neutralization value for shells without unset; and this also
+# works around shells that cannot unset nonexistent variables.
+# Preserve -v and -x to the replacement shell.
+BASH_ENV=/dev/null
+ENV=/dev/null
+(unset BASH_ENV) >/dev/null 2>&1 && unset BASH_ENV ENV
+case $- in # ((((
+  *v*x* | *x*v* ) as_opts=-vx ;;
+  *v* ) as_opts=-v ;;
+  *x* ) as_opts=-x ;;
+  * ) as_opts= ;;
+esac
+exec $CONFIG_SHELL $as_opts "$as_myself" ${1+"$@"}
+# Admittedly, this is quite paranoid, since all the known shells bail
+# out after a failed `exec'.
+$as_echo "$0: could not re-execute with $CONFIG_SHELL" >&2
+as_fn_exit 255
+  fi
+  # We don't want this to propagate to other subprocesses.
+          { _as_can_reexec=; unset _as_can_reexec;}
 if test "x$CONFIG_SHELL" = x; then
   as_bourne_compatible="if test -n \"\${ZSH_VERSION+set}\" && (emulate sh) >/dev/null 2>&1; then :
   emulate sh
@@ -169,7 +192,8 @@
 else
   exitcode=1; echo positional parameters were not saved.
 fi
-test x\$exitcode = x0 || exit 1"
+test x\$exitcode = x0 || exit 1
+test -x / || exit 1"
   as_suggested="  as_lineno_1=";as_suggested=$as_suggested$LINENO;as_suggested=$as_suggested" as_lineno_1a=\$LINENO
   as_lineno_2=";as_suggested=$as_suggested$LINENO;as_suggested=$as_suggested" as_lineno_2a=\$LINENO
   eval 'test \"x\$as_lineno_1'\$as_run'\" != \"x\$as_lineno_2'\$as_run'\" &&
@@ -222,21 +246,25 @@
 
 
       if test "x$CONFIG_SHELL" != x; then :
-  # We cannot yet assume a decent shell, so we have to provide a
-	# neutralization value for shells without unset; and this also
-	# works around shells that cannot unset nonexistent variables.
-	# Preserve -v and -x to the replacement shell.
-	BASH_ENV=/dev/null
-	ENV=/dev/null
-	(unset BASH_ENV) >/dev/null 2>&1 && unset BASH_ENV ENV
-	export CONFIG_SHELL
-	case $- in # ((((
-	  *v*x* | *x*v* ) as_opts=-vx ;;
-	  *v* ) as_opts=-v ;;
-	  *x* ) as_opts=-x ;;
-	  * ) as_opts= ;;
-	esac
-	exec "$CONFIG_SHELL" $as_opts "$as_myself" ${1+"$@"}
+  export CONFIG_SHELL
+             # We cannot yet assume a decent shell, so we have to provide a
+# neutralization value for shells without unset; and this also
+# works around shells that cannot unset nonexistent variables.
+# Preserve -v and -x to the replacement shell.
+BASH_ENV=/dev/null
+ENV=/dev/null
+(unset BASH_ENV) >/dev/null 2>&1 && unset BASH_ENV ENV
+case $- in # ((((
+  *v*x* | *x*v* ) as_opts=-vx ;;
+  *v* ) as_opts=-v ;;
+  *x* ) as_opts=-x ;;
+  * ) as_opts= ;;
+esac
+exec $CONFIG_SHELL $as_opts "$as_myself" ${1+"$@"}
+# Admittedly, this is quite paranoid, since all the known shells bail
+# out after a failed `exec'.
+$as_echo "$0: could not re-execute with $CONFIG_SHELL" >&2
+exit 255
 fi
 
     if test x$as_have_required = xno; then :
@@ -339,6 +367,14 @@
 
 
 } # as_fn_mkdir_p
+
+# as_fn_executable_p FILE
+# -----------------------
+# Test if FILE is an executable regular file.
+as_fn_executable_p ()
+{
+  test -f "$1" && test -x "$1"
+} # as_fn_executable_p
 # as_fn_append VAR VALUE
 # ----------------------
 # Append the text in VALUE to the end of the definition contained in VAR. Take
@@ -460,6 +496,10 @@
   chmod +x "$as_me.lineno" ||
     { $as_echo "$as_me: error: cannot create $as_me.lineno; rerun with a POSIX shell" >&2; as_fn_exit 1; }
 
+  # If we had to re-execute with $CONFIG_SHELL, we're ensured to have
+  # already done that, so ensure we don't try to do so again and fall
+  # in an infinite loop.  This has already happened in practice.
+  _as_can_reexec=no; export _as_can_reexec
   # Don't try to exec as it changes $[0], causing all sort of problems
   # (the dirname of $[0] is not the place where we might find the
   # original and so on.  Autoconf is especially sensitive to this).
@@ -494,16 +534,16 @@
     # ... but there are two gotchas:
     # 1) On MSYS, both `ln -s file dir' and `ln file dir' fail.
     # 2) DJGPP < 2.04 has no symlinks; `ln -s' creates a wrapper executable.
-    # In both cases, we have to default to `cp -p'.
+    # In both cases, we have to default to `cp -pR'.
     ln -s conf$$.file conf$$.dir 2>/dev/null && test ! -f conf$$.exe ||
-      as_ln_s='cp -p'
+      as_ln_s='cp -pR'
   elif ln conf$$.file conf$$ 2>/dev/null; then
     as_ln_s=ln
   else
-    as_ln_s='cp -p'
+    as_ln_s='cp -pR'
   fi
 else
-  as_ln_s='cp -p'
+  as_ln_s='cp -pR'
 fi
 rm -f conf$$ conf$$.exe conf$$.dir/conf$$.file conf$$.file
 rmdir conf$$.dir 2>/dev/null
@@ -515,28 +555,8 @@
   as_mkdir_p=false
 fi
 
-if test -x / >/dev/null 2>&1; then
-  as_test_x='test -x'
-else
-  if ls -dL / >/dev/null 2>&1; then
-    as_ls_L_option=L
-  else
-    as_ls_L_option=
-  fi
-  as_test_x='
-    eval sh -c '\''
-      if test -d "$1"; then
-	test -d "$1/.";
-      else
-	case $1 in #(
-	-*)set "./$1";;
-	esac;
-	case `ls -ld'$as_ls_L_option' "$1" 2>/dev/null` in #((
-	???[sx]*):;;*)false;;esac;fi
-    '\'' sh
-  '
-fi
-as_executable_p=$as_test_x
+as_test_x='test -x'
+as_executable_p=as_fn_executable_p
 
 # Sed expression to map a string onto a valid CPP name.
 as_tr_cpp="eval sed 'y%*$as_cr_letters%P$as_cr_LETTERS%;s%[^_$as_cr_alnum]%_%g'"
@@ -618,6 +638,7 @@
 ac_subst_vars='am__EXEEXT_FALSE
 am__EXEEXT_TRUE
 LTLIBOBJS
+SCRIPTLET_SHELL
 BUILDSCRIPT
 SRCEXT
 PKGEXT
@@ -625,6 +646,7 @@
 USE_GIT_VERSION_FALSE
 USE_GIT_VERSION_TRUE
 GIT
+WARNING_CFLAGS
 USE_DOXYGEN_FALSE
 USE_DOXYGEN_TRUE
 DOXYGEN
@@ -638,6 +660,7 @@
 STRIP_BINARIES
 SEDINPLACE
 SIZECMD
+INODECMD
 DUPATH
 DARWIN_FALSE
 DARWIN_TRUE
@@ -650,8 +673,22 @@
 LIBOBJS
 HAVE_LIBGPGME_FALSE
 HAVE_LIBGPGME_TRUE
+GPGME_LIBS
+GPGME_CFLAGS
+GPGME_CONFIG
+HAVE_LIBCURL_FALSE
+HAVE_LIBCURL_TRUE
+LIBCURL_LIBS
+LIBCURL_CFLAGS
 HAVE_LIBSSL_FALSE
 HAVE_LIBSSL_TRUE
+LIBSSL_LIBS
+LIBSSL_CFLAGS
+LIBARCHIVE_LIBS
+LIBARCHIVE_CFLAGS
+PKG_CONFIG_LIBDIR
+PKG_CONFIG_PATH
+PKG_CONFIG
 POSUB
 LTLIBINTL
 LIBINTL
@@ -671,7 +708,8 @@
 USE_NLS
 BASH_SHELL
 PYTHON
-CXXCPP
+LIB_VERSION_INFO
+LIB_VERSION
 CPP
 OTOOL64
 OTOOL
@@ -684,6 +722,7 @@
 AR
 DLLTOOL
 OBJDUMP
+LN_S
 NM
 ac_ct_DUMPBIN
 DUMPBIN
@@ -692,16 +731,6 @@
 EGREP
 GREP
 SED
-LIBTOOL
-LN_S
-am__fastdepCXX_FALSE
-am__fastdepCXX_TRUE
-CXXDEPMODE
-ac_ct_CXX
-CXXFLAGS
-CXX
-LIBCURL
-LIBCURL_CPPFLAGS
 am__fastdepCC_FALSE
 am__fastdepCC_TRUE
 CCDEPMODE
@@ -719,9 +748,11 @@
 LDFLAGS
 CFLAGS
 CC
-_libcurl_config
-LIB_VERSION_INFO
-LIB_VERSION
+LIBTOOL
+AM_BACKSLASH
+AM_DEFAULT_VERBOSITY
+AM_DEFAULT_V
+AM_V
 am__untar
 am__tar
 AMTAR
@@ -794,30 +825,34 @@
 ac_subst_files=''
 ac_user_opts='
 enable_option_checking
+enable_silent_rules
+enable_shared
+enable_static
+with_pic
+enable_fast_install
+enable_dependency_tracking
+with_gnu_ld
+with_sysroot
+enable_libtool_lock
 with_root_dir
 with_pkg_ext
 with_src_ext
 with_buildscript
+with_scriptlet_shell
 with_openssl
 with_gpgme
-with_libcurl
-enable_dependency_tracking
+with_curl
 enable_doc
 enable_doxygen
 enable_debug
+enable_warningflags
 enable_git_version
-enable_shared
-enable_static
-with_pic
-enable_fast_install
-with_gnu_ld
-with_sysroot
-enable_libtool_lock
+enable_largefile
 enable_nls
 enable_rpath
 with_libiconv_prefix
 with_libintl_prefix
-enable_largefile
+with_gpgme_prefix
 '
       ac_precious_vars='build_alias
 host_alias
@@ -827,11 +862,16 @@
 LDFLAGS
 LIBS
 CPPFLAGS
-CXX
-CXXFLAGS
-CCC
 CPP
-CXXCPP'
+PKG_CONFIG
+PKG_CONFIG_PATH
+PKG_CONFIG_LIBDIR
+LIBARCHIVE_CFLAGS
+LIBARCHIVE_LIBS
+LIBSSL_CFLAGS
+LIBSSL_LIBS
+LIBCURL_CFLAGS
+LIBCURL_LIBS'
 
 
 # Initialize some variables set by options.
@@ -1287,8 +1327,6 @@
 if test "x$host_alias" != x; then
   if test "x$build_alias" = x; then
     cross_compiling=maybe
-    $as_echo "$as_me: WARNING: if you wanted to set the --build type, don't use --host.
-    If a cross compiler is detected then cross compile mode will be used" >&2
   elif test "x$build_alias" != "x$host_alias"; then
     cross_compiling=yes
   fi
@@ -1452,44 +1490,52 @@
   --disable-option-checking  ignore unrecognized --enable/--with options
   --disable-FEATURE       do not include FEATURE (same as --enable-FEATURE=no)
   --enable-FEATURE[=ARG]  include FEATURE [ARG=yes]
-  --disable-dependency-tracking  speeds up one-time build
-  --enable-dependency-tracking   do not reject slow dependency extractors
-  --disable-doc           prevent make from looking at doc/ dir
-  --enable-doxygen        build your own API docs via Doxygen
-  --enable-debug          enable debugging support
-  --enable-git-version    enable use of git version in version string if
-                          available
+  --enable-silent-rules   less verbose build output (undo: "make V=1")
+  --disable-silent-rules  verbose build output (undo: "make V=0")
   --enable-shared[=PKGS]  build shared libraries [default=yes]
   --enable-static[=PKGS]  build static libraries [default=yes]
   --enable-fast-install[=PKGS]
                           optimize for fast installation [default=yes]
+  --enable-dependency-tracking
+                          do not reject slow dependency extractors
+  --disable-dependency-tracking
+                          speeds up one-time build
   --disable-libtool-lock  avoid locking (might break parallel builds)
+  --disable-doc           prevent make from looking at doc/ dir
+  --enable-doxygen        build your own API docs via Doxygen
+  --enable-debug          enable debugging support
+  --enable-warningflags   enable extra compiler warning flags
+  --enable-git-version    enable use of git version in version string if
+                          available
+  --disable-largefile     omit support for large files
   --disable-nls           do not use Native Language Support
   --disable-rpath         do not hardcode runtime library paths
-  --disable-largefile     omit support for large files
 
 Optional Packages:
   --with-PACKAGE[=ARG]    use PACKAGE [ARG=yes]
   --without-PACKAGE       do not use PACKAGE (same as --with-PACKAGE=no)
+  --with-pic              try to use only PIC/non-PIC objects [default=use
+                          both]
+  --with-gnu-ld           assume the C compiler uses GNU ld [default=no]
+  --with-sysroot=DIR Search for dependent libraries within DIR
+                        (or the compiler's sysroot if not specified).
   --with-root-dir=path    set the location of the root operating directory
   --with-pkg-ext=ext      set the file extension used by packages
   --with-src-ext=ext      set the file extension used by source packages
   --with-buildscript=name set the build script name used by makepkg
+  --with-scriptlet-shell=shell
+                          set the full path to the shell used to run install
+                          scriptlets
   --with-openssl          use OpenSSL crypto implementations instead of
                           internal routines
   --with-gpgme            use GPGME for PGP signature verification
-  --with-libcurl=PREFIX   look for the curl library in PREFIX/lib and headers
-                          in PREFIX/include
-  --with-pic              try to use only PIC/non-PIC objects [default=use
-                          both]
-  --with-gnu-ld           assume the C compiler uses GNU ld [default=no]
-  --with-sysroot=DIR Search for dependent libraries within DIR
-                        (or the compiler's sysroot if not specified).
+  --with-libcurl          use libcurl for the internal downloader
   --with-gnu-ld           assume the C compiler uses GNU ld default=no
   --with-libiconv-prefix[=DIR]  search for libiconv in DIR/include and DIR/lib
   --without-libiconv-prefix     don't search for libiconv in includedir and libdir
   --with-libintl-prefix[=DIR]  search for libintl in DIR/include and DIR/lib
   --without-libintl-prefix     don't search for libintl in includedir and libdir
+  --with-gpgme-prefix=PFX prefix where GPGME is installed (optional)
 
 Some influential environment variables:
   CC          C compiler command
@@ -1499,10 +1545,23 @@
   LIBS        libraries to pass to the linker, e.g. -l<library>
   CPPFLAGS    (Objective) C/C++ preprocessor flags, e.g. -I<include dir> if
               you have headers in a nonstandard directory <include dir>
-  CXX         C++ compiler command
-  CXXFLAGS    C++ compiler flags
   CPP         C preprocessor
-  CXXCPP      C++ preprocessor
+  PKG_CONFIG  path to pkg-config utility
+  PKG_CONFIG_PATH
+              directories to add to pkg-config's search path
+  PKG_CONFIG_LIBDIR
+              path overriding pkg-config's built-in search path
+  LIBARCHIVE_CFLAGS
+              C compiler flags for LIBARCHIVE, overriding pkg-config
+  LIBARCHIVE_LIBS
+              linker flags for LIBARCHIVE, overriding pkg-config
+  LIBSSL_CFLAGS
+              C compiler flags for LIBSSL, overriding pkg-config
+  LIBSSL_LIBS linker flags for LIBSSL, overriding pkg-config
+  LIBCURL_CFLAGS
+              C compiler flags for LIBCURL, overriding pkg-config
+  LIBCURL_LIBS
+              linker flags for LIBCURL, overriding pkg-config
 
 Use these variables to override the choices made by `configure' or to help
 it to find libraries and programs with nonstandard names/locations.
@@ -1571,9 +1630,9 @@
 if $ac_init_version; then
   cat <<\_ACEOF
 pacman configure 4.0.3
-generated by GNU Autoconf 2.68
+generated by GNU Autoconf 2.69
 
-Copyright (C) 2010 Free Software Foundation, Inc.
+Copyright (C) 2012 Free Software Foundation, Inc.
 This configure script is free software; the Free Software Foundation
 gives unlimited permission to copy, distribute and modify it.
 _ACEOF
@@ -1649,7 +1708,7 @@
 	 test ! -s conftest.err
        } && test -s conftest$ac_exeext && {
 	 test "$cross_compiling" = yes ||
-	 $as_test_x conftest$ac_exeext
+	 test -x conftest$ac_exeext
        }; then :
   ac_retval=0
 else
@@ -1668,111 +1727,6 @@
 
 } # ac_fn_c_try_link
 
-# ac_fn_c_check_func LINENO FUNC VAR
-# ----------------------------------
-# Tests whether FUNC exists, setting the cache variable VAR accordingly
-ac_fn_c_check_func ()
-{
-  as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $2" >&5
-$as_echo_n "checking for $2... " >&6; }
-if eval \${$3+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-/* Define $2 to an innocuous variant, in case <limits.h> declares $2.
-   For example, HP-UX 11i <limits.h> declares gettimeofday.  */
-#define $2 innocuous_$2
-
-/* System header to define __stub macros and hopefully few prototypes,
-    which can conflict with char $2 (); below.
-    Prefer <limits.h> to <assert.h> if __STDC__ is defined, since
-    <limits.h> exists even on freestanding compilers.  */
-
-#ifdef __STDC__
-# include <limits.h>
-#else
-# include <assert.h>
-#endif
-
-#undef $2
-
-/* Override any GCC internal prototype to avoid an error.
-   Use char because int might match the return type of a GCC
-   builtin and then its argument prototype would still apply.  */
-#ifdef __cplusplus
-extern "C"
-#endif
-char $2 ();
-/* The GNU C library defines this for functions which it implements
-    to always fail with ENOSYS.  Some functions are actually named
-    something starting with __ and the normal name is an alias.  */
-#if defined __stub_$2 || defined __stub___$2
-choke me
-#endif
-
-int
-main ()
-{
-return $2 ();
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  eval "$3=yes"
-else
-  eval "$3=no"
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-fi
-eval ac_res=\$$3
-	       { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_res" >&5
-$as_echo "$ac_res" >&6; }
-  eval $as_lineno_stack; ${as_lineno_stack:+:} unset as_lineno
-
-} # ac_fn_c_check_func
-
-# ac_fn_cxx_try_compile LINENO
-# ----------------------------
-# Try to compile conftest.$ac_ext, and return whether this succeeded.
-ac_fn_cxx_try_compile ()
-{
-  as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
-  rm -f conftest.$ac_objext
-  if { { ac_try="$ac_compile"
-case "(($ac_try" in
-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
-  *) ac_try_echo=$ac_try;;
-esac
-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
-$as_echo "$ac_try_echo"; } >&5
-  (eval "$ac_compile") 2>conftest.err
-  ac_status=$?
-  if test -s conftest.err; then
-    grep -v '^ *+' conftest.err >conftest.er1
-    cat conftest.er1 >&5
-    mv -f conftest.er1 conftest.err
-  fi
-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; } && {
-	 test -z "$ac_cxx_werror_flag" ||
-	 test ! -s conftest.err
-       } && test -s conftest.$ac_objext; then :
-  ac_retval=0
-else
-  $as_echo "$as_me: failed program was:" >&5
-sed 's/^/| /' conftest.$ac_ext >&5
-
-	ac_retval=1
-fi
-  eval $as_lineno_stack; ${as_lineno_stack:+:} unset as_lineno
-  as_fn_set_status $ac_retval
-
-} # ac_fn_cxx_try_compile
-
 # ac_fn_c_check_header_compile LINENO HEADER VAR INCLUDES
 # -------------------------------------------------------
 # Tests whether HEADER exists and can be compiled using the include files in
@@ -1883,95 +1837,79 @@
 
 } # ac_fn_c_try_run
 
-# ac_fn_cxx_try_cpp LINENO
-# ------------------------
-# Try to preprocess conftest.$ac_ext, and return whether this succeeded.
-ac_fn_cxx_try_cpp ()
+# ac_fn_c_check_func LINENO FUNC VAR
+# ----------------------------------
+# Tests whether FUNC exists, setting the cache variable VAR accordingly
+ac_fn_c_check_func ()
 {
   as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
-  if { { ac_try="$ac_cpp conftest.$ac_ext"
-case "(($ac_try" in
-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
-  *) ac_try_echo=$ac_try;;
-esac
-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
-$as_echo "$ac_try_echo"; } >&5
-  (eval "$ac_cpp conftest.$ac_ext") 2>conftest.err
-  ac_status=$?
-  if test -s conftest.err; then
-    grep -v '^ *+' conftest.err >conftest.er1
-    cat conftest.er1 >&5
-    mv -f conftest.er1 conftest.err
-  fi
-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; } > conftest.i && {
-	 test -z "$ac_cxx_preproc_warn_flag$ac_cxx_werror_flag" ||
-	 test ! -s conftest.err
-       }; then :
-  ac_retval=0
+  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $2" >&5
+$as_echo_n "checking for $2... " >&6; }
+if eval \${$3+:} false; then :
+  $as_echo_n "(cached) " >&6
 else
-  $as_echo "$as_me: failed program was:" >&5
-sed 's/^/| /' conftest.$ac_ext >&5
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+/* Define $2 to an innocuous variant, in case <limits.h> declares $2.
+   For example, HP-UX 11i <limits.h> declares gettimeofday.  */
+#define $2 innocuous_$2
 
-    ac_retval=1
+/* System header to define __stub macros and hopefully few prototypes,
+    which can conflict with char $2 (); below.
+    Prefer <limits.h> to <assert.h> if __STDC__ is defined, since
+    <limits.h> exists even on freestanding compilers.  */
+
+#ifdef __STDC__
+# include <limits.h>
+#else
+# include <assert.h>
+#endif
+
+#undef $2
+
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
+#ifdef __cplusplus
+extern "C"
+#endif
+char $2 ();
+/* The GNU C library defines this for functions which it implements
+    to always fail with ENOSYS.  Some functions are actually named
+    something starting with __ and the normal name is an alias.  */
+#if defined __stub_$2 || defined __stub___$2
+choke me
+#endif
+
+int
+main ()
+{
+return $2 ();
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_link "$LINENO"; then :
+  eval "$3=yes"
+else
+  eval "$3=no"
+fi
+rm -f core conftest.err conftest.$ac_objext \
+    conftest$ac_exeext conftest.$ac_ext
 fi
+eval ac_res=\$$3
+	       { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_res" >&5
+$as_echo "$ac_res" >&6; }
   eval $as_lineno_stack; ${as_lineno_stack:+:} unset as_lineno
-  as_fn_set_status $ac_retval
 
-} # ac_fn_cxx_try_cpp
+} # ac_fn_c_check_func
 
-# ac_fn_cxx_try_link LINENO
-# -------------------------
-# Try to link conftest.$ac_ext, and return whether this succeeded.
-ac_fn_cxx_try_link ()
-{
-  as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
-  rm -f conftest.$ac_objext conftest$ac_exeext
-  if { { ac_try="$ac_link"
-case "(($ac_try" in
-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
-  *) ac_try_echo=$ac_try;;
-esac
-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
-$as_echo "$ac_try_echo"; } >&5
-  (eval "$ac_link") 2>conftest.err
-  ac_status=$?
-  if test -s conftest.err; then
-    grep -v '^ *+' conftest.err >conftest.er1
-    cat conftest.er1 >&5
-    mv -f conftest.er1 conftest.err
-  fi
-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; } && {
-	 test -z "$ac_cxx_werror_flag" ||
-	 test ! -s conftest.err
-       } && test -s conftest$ac_exeext && {
-	 test "$cross_compiling" = yes ||
-	 $as_test_x conftest$ac_exeext
-       }; then :
-  ac_retval=0
-else
-  $as_echo "$as_me: failed program was:" >&5
-sed 's/^/| /' conftest.$ac_ext >&5
-
-	ac_retval=1
-fi
-  # Delete the IPA/IPO (Inter Procedural Analysis/Optimization) information
-  # created by the PGI compiler (conftest_ipa8_conftest.oo), as it would
-  # interfere with the next link command; also delete a directory that is
-  # left behind by Apple's compiler.  We do this before executing the actions.
-  rm -rf conftest.dSYM conftest_ipa8_conftest.oo
-  eval $as_lineno_stack; ${as_lineno_stack:+:} unset as_lineno
-  as_fn_set_status $ac_retval
-
-} # ac_fn_cxx_try_link
-
-# ac_fn_c_check_header_mongrel LINENO HEADER VAR INCLUDES
-# -------------------------------------------------------
-# Tests whether HEADER exists, giving a warning if it cannot be compiled using
-# the include files in INCLUDES and setting the cache variable VAR
-# accordingly.
-ac_fn_c_check_header_mongrel ()
+# ac_fn_c_check_header_mongrel LINENO HEADER VAR INCLUDES
+# -------------------------------------------------------
+# Tests whether HEADER exists, giving a warning if it cannot be compiled using
+# the include files in INCLUDES and setting the cache variable VAR
+# accordingly.
+ac_fn_c_check_header_mongrel ()
 {
   as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
   if eval \${$3+:} false; then :
@@ -2082,7 +2020,8 @@
 main ()
 {
 static int test_array [1 - 2 * !(0 < ($ac_type) ((((($ac_type) 1 << N) << N) - 1) * 2 + 1))];
-test_array [0] = 0
+test_array [0] = 0;
+return test_array [0];
 
   ;
   return 0;
@@ -2098,7 +2037,8 @@
 {
 static int test_array [1 - 2 * !(($ac_type) ((((($ac_type) 1 << N) << N) - 1) * 2 + 1)
 		 < ($ac_type) ((((($ac_type) 1 << N) << N) - 1) * 2 + 2))];
-test_array [0] = 0
+test_array [0] = 0;
+return test_array [0];
 
   ;
   return 0;
@@ -2246,7 +2186,7 @@
 running configure, to aid debugging if configure makes a mistake.
 
 It was created by pacman $as_me 4.0.3, which was
-generated by GNU Autoconf 2.68.  Invocation command line was
+generated by GNU Autoconf 2.69.  Invocation command line was
 
   $ $0 $@
 
@@ -2602,7 +2542,7 @@
 
 
 ac_aux_dir=
-for ac_dir in "$srcdir" "$srcdir/.." "$srcdir/../.."; do
+for ac_dir in build-aux "$srcdir"/build-aux; do
   if test -f "$ac_dir/install-sh"; then
     ac_aux_dir=$ac_dir
     ac_install_sh="$ac_aux_dir/install-sh -c"
@@ -2618,7 +2558,7 @@
   fi
 done
 if test -z "$ac_aux_dir"; then
-  as_fn_error $? "cannot find install-sh, install.sh, or shtool in \"$srcdir\" \"$srcdir/..\" \"$srcdir/../..\"" "$LINENO" 5
+  as_fn_error $? "cannot find install-sh, install.sh, or shtool in build-aux \"$srcdir\"/build-aux" "$LINENO" 5
 fi
 
 # These three variables are undocumented and unsupported,
@@ -2630,6 +2570,7 @@
 ac_configure="$SHELL $ac_aux_dir/configure"  # Please don't use this var.
 
 
+
 # Make sure we can run config.sub.
 $SHELL "$ac_aux_dir/config.sub" sun4 >/dev/null 2>&1 ||
   as_fn_error $? "cannot run $SHELL $ac_aux_dir/config.sub" "$LINENO" 5
@@ -2701,7 +2642,7 @@
 case $host_os in *\ *) host_os=`echo "$host_os" | sed 's/ /-/g'`;; esac
 
 
-am__api_version='1.11'
+am__api_version='1.12'
 
 # Find a good install program.  We prefer a C program (faster),
 # so one script is as good as another.  But avoid the broken or
@@ -2740,7 +2681,7 @@
     # by default.
     for ac_prog in ginstall scoinst install; do
       for ac_exec_ext in '' $ac_executable_extensions; do
-	if { test -f "$as_dir/$ac_prog$ac_exec_ext" && $as_test_x "$as_dir/$ac_prog$ac_exec_ext"; }; then
+	if as_fn_executable_p "$as_dir/$ac_prog$ac_exec_ext"; then
 	  if test $ac_prog = install &&
 	    grep dspmsg "$as_dir/$ac_prog$ac_exec_ext" >/dev/null 2>&1; then
 	    # AIX install.  It has an incompatible calling convention.
@@ -2798,9 +2739,6 @@
 
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether build environment is sane" >&5
 $as_echo_n "checking whether build environment is sane... " >&6; }
-# Just in case
-sleep 1
-echo timestamp > conftest.file
 # Reject unsafe characters in $srcdir or the absolute working directory
 # name.  Accept space and tab only in the latter.
 am_lf='
@@ -2811,32 +2749,40 @@
 esac
 case $srcdir in
   *[\\\"\#\$\&\'\`$am_lf\ \	]*)
-    as_fn_error $? "unsafe srcdir value: \`$srcdir'" "$LINENO" 5;;
+    as_fn_error $? "unsafe srcdir value: '$srcdir'" "$LINENO" 5;;
 esac
 
-# Do `set' in a subshell so we don't clobber the current shell's
+# Do 'set' in a subshell so we don't clobber the current shell's
 # arguments.  Must try -L first in case configure is actually a
 # symlink; some systems play weird games with the mod time of symlinks
 # (eg FreeBSD returns the mod time of the symlink's containing
 # directory).
 if (
-   set X `ls -Lt "$srcdir/configure" conftest.file 2> /dev/null`
-   if test "$*" = "X"; then
-      # -L didn't work.
-      set X `ls -t "$srcdir/configure" conftest.file`
-   fi
-   rm -f conftest.file
-   if test "$*" != "X $srcdir/configure conftest.file" \
-      && test "$*" != "X conftest.file $srcdir/configure"; then
-
-      # If neither matched, then we have a broken ls.  This can happen
-      # if, for instance, CONFIG_SHELL is bash and it inherits a
-      # broken ls alias from the environment.  This has actually
-      # happened.  Such a system could not be considered "sane".
-      as_fn_error $? "ls -t appears to fail.  Make sure there is not a broken
-alias in your environment" "$LINENO" 5
-   fi
+   am_has_slept=no
+   for am_try in 1 2; do
+     echo "timestamp, slept: $am_has_slept" > conftest.file
+     set X `ls -Lt "$srcdir/configure" conftest.file 2> /dev/null`
+     if test "$*" = "X"; then
+	# -L didn't work.
+	set X `ls -t "$srcdir/configure" conftest.file`
+     fi
+     if test "$*" != "X $srcdir/configure conftest.file" \
+	&& test "$*" != "X conftest.file $srcdir/configure"; then
 
+	# If neither matched, then we have a broken ls.  This can happen
+	# if, for instance, CONFIG_SHELL is bash and it inherits a
+	# broken ls alias from the environment.  This has actually
+	# happened.  Such a system could not be considered "sane".
+	as_fn_error $? "ls -t appears to fail.  Make sure there is not a broken
+  alias in your environment" "$LINENO" 5
+     fi
+     if test "$2" = conftest.file || test $am_try -eq 2; then
+       break
+     fi
+     # Just in case.
+     sleep 1
+     am_has_slept=yes
+   done
    test "$2" = conftest.file
    )
 then
@@ -2848,6 +2794,16 @@
 fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
 $as_echo "yes" >&6; }
+# If we didn't sleep, we still need to ensure time stamps of config.status and
+# generated files are strictly newer.
+am_sleep_pid=
+if grep 'slept: no' conftest.file >/dev/null 2>&1; then
+  ( sleep 1 ) &
+  am_sleep_pid=$!
+fi
+
+rm -f conftest.file
+
 test "$program_prefix" != NONE &&
   program_transform_name="s&^&$program_prefix&;$program_transform_name"
 # Use a double $ so make ignores it.
@@ -2874,8 +2830,8 @@
   am_missing_run="$MISSING --run "
 else
   am_missing_run=
-  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: \`missing' script is too old or missing" >&5
-$as_echo "$as_me: WARNING: \`missing' script is too old or missing" >&2;}
+  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: 'missing' script is too old or missing" >&5
+$as_echo "$as_me: WARNING: 'missing' script is too old or missing" >&2;}
 fi
 
 if test x"${install_sh}" != xset; then
@@ -2887,10 +2843,10 @@
   esac
 fi
 
-# Installed binaries are usually stripped using `strip' when the user
-# run `make install-strip'.  However `strip' might not be the right
+# Installed binaries are usually stripped using 'strip' when the user
+# run "make install-strip".  However 'strip' might not be the right
 # tool to use in cross-compilation environments, therefore Automake
-# will honor the `STRIP' environment variable to overrule this program.
+# will honor the 'STRIP' environment variable to overrule this program.
 if test "$cross_compiling" != no; then
   if test -n "$ac_tool_prefix"; then
   # Extract the first word of "${ac_tool_prefix}strip", so it can be a program name with args.
@@ -2909,7 +2865,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_STRIP="${ac_tool_prefix}strip"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -2949,7 +2905,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_STRIP="strip"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -3000,7 +2956,7 @@
   test -z "$as_dir" && as_dir=.
     for ac_prog in mkdir gmkdir; do
 	 for ac_exec_ext in '' $ac_executable_extensions; do
-	   { test -f "$as_dir/$ac_prog$ac_exec_ext" && $as_test_x "$as_dir/$ac_prog$ac_exec_ext"; } || continue
+	   as_fn_executable_p "$as_dir/$ac_prog$ac_exec_ext" || continue
 	   case `"$as_dir/$ac_prog$ac_exec_ext" --version 2>&1` in #(
 	     'mkdir (GNU coreutils) '* | \
 	     'mkdir (coreutils) '* | \
@@ -3053,7 +3009,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_AWK="$ac_prog"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -3179,81 +3135,140 @@
 
 
 
+# Check whether --enable-silent-rules was given.
+if test "${enable_silent_rules+set}" = set; then :
+  enableval=$enable_silent_rules;
+fi
+
+case $enable_silent_rules in # (((
+  yes) AM_DEFAULT_VERBOSITY=0;;
+   no) AM_DEFAULT_VERBOSITY=1;;
+    *) AM_DEFAULT_VERBOSITY=0;;
+esac
+am_make=${MAKE-make}
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether $am_make supports nested variables" >&5
+$as_echo_n "checking whether $am_make supports nested variables... " >&6; }
+if ${am_cv_make_support_nested_variables+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  if $as_echo 'TRUE=$(BAR$(V))
+BAR0=false
+BAR1=true
+V=1
+am__doit:
+	@$(TRUE)
+.PHONY: am__doit' | $am_make -f - >/dev/null 2>&1; then
+  am_cv_make_support_nested_variables=yes
+else
+  am_cv_make_support_nested_variables=no
+fi
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $am_cv_make_support_nested_variables" >&5
+$as_echo "$am_cv_make_support_nested_variables" >&6; }
+if test $am_cv_make_support_nested_variables = yes; then
+    AM_V='$(V)'
+  AM_DEFAULT_V='$(AM_DEFAULT_VERBOSITY)'
+else
+  AM_V=$AM_DEFAULT_VERBOSITY
+  AM_DEFAULT_V=$AM_DEFAULT_VERBOSITY
+fi
+AM_BACKSLASH='\'
 
-LIB_VERSION=`expr 7 - 0`.0.3
-LIB_VERSION_INFO="7:3:0"
 
-# Set subsitution values for version stuff in Makefiles and anywhere else,
-# and put LIB_VERSION in config.h
+case `pwd` in
+  *\ * | *\	*)
+    { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Libtool does not cope well with whitespace in \`pwd\`" >&5
+$as_echo "$as_me: WARNING: Libtool does not cope well with whitespace in \`pwd\`" >&2;} ;;
+esac
 
 
 
-cat >>confdefs.h <<_ACEOF
-#define LIB_VERSION "$LIB_VERSION"
-_ACEOF
+macro_version='2.4.2'
+macro_revision='1.3337'
 
 
-# Help line for root directory
 
-# Check whether --with-root-dir was given.
-if test "${with_root_dir+set}" = set; then :
-  withval=$with_root_dir; ROOTDIR=$withval
-else
-  ROOTDIR=/
-fi
 
 
-# Help line for package extension
 
-# Check whether --with-pkg-ext was given.
-if test "${with_pkg_ext+set}" = set; then :
-  withval=$with_pkg_ext; PKGEXT=$withval
-else
-  PKGEXT=.pkg.tar.gz
-fi
 
 
-# Help line for source package directory
 
-# Check whether --with-src-ext was given.
-if test "${with_src_ext+set}" = set; then :
-  withval=$with_src_ext; SRCEXT=$withval
-else
-  SRCEXT=.src.tar.gz
-fi
 
 
-# Help line for buildscript filename
 
-# Check whether --with-buildscript was given.
-if test "${with_buildscript+set}" = set; then :
-  withval=$with_buildscript; BUILDSCRIPT=$withval
-else
-  BUILDSCRIPT=PKGBUILD
-fi
 
+ltmain="$ac_aux_dir/ltmain.sh"
 
-# Help line for using OpenSSL
+# Backslashify metacharacters that are still active within
+# double-quoted strings.
+sed_quote_subst='s/\(["`$\\]\)/\\\1/g'
 
-# Check whether --with-openssl was given.
-if test "${with_openssl+set}" = set; then :
-  withval=$with_openssl;
-else
-  with_openssl=check
-fi
+# Same as above, but do not quote variable references.
+double_quote_subst='s/\(["`\\]\)/\\\1/g'
 
+# Sed substitution to delay expansion of an escaped shell variable in a
+# double_quote_subst'ed string.
+delay_variable_subst='s/\\\\\\\\\\\$/\\\\\\$/g'
 
-# Help line for using gpgme
+# Sed substitution to delay expansion of an escaped single quote.
+delay_single_quote_subst='s/'\''/'\'\\\\\\\'\''/g'
 
-# Check whether --with-gpgme was given.
-if test "${with_gpgme+set}" = set; then :
-  withval=$with_gpgme;
+# Sed substitution to avoid accidental globbing in evaled expressions
+no_glob_subst='s/\*/\\\*/g'
+
+ECHO='\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\'
+ECHO=$ECHO$ECHO$ECHO$ECHO$ECHO
+ECHO=$ECHO$ECHO$ECHO$ECHO$ECHO$ECHO
+
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking how to print strings" >&5
+$as_echo_n "checking how to print strings... " >&6; }
+# Test print first, because it will be a builtin if present.
+if test "X`( print -r -- -n ) 2>/dev/null`" = X-n && \
+   test "X`print -r -- $ECHO 2>/dev/null`" = "X$ECHO"; then
+  ECHO='print -r --'
+elif test "X`printf %s $ECHO 2>/dev/null`" = "X$ECHO"; then
+  ECHO='printf %s\n'
 else
-  with_gpgme=check
+  # Use this function as a fallback that always works.
+  func_fallback_echo ()
+  {
+    eval 'cat <<_LTECHO_EOF
+$1
+_LTECHO_EOF'
+  }
+  ECHO='func_fallback_echo'
 fi
 
+# func_echo_all arg...
+# Invoke $ECHO with all args, space-separated.
+func_echo_all ()
+{
+    $ECHO ""
+}
+
+case "$ECHO" in
+  printf*) { $as_echo "$as_me:${as_lineno-$LINENO}: result: printf" >&5
+$as_echo "printf" >&6; } ;;
+  print*) { $as_echo "$as_me:${as_lineno-$LINENO}: result: print -r" >&5
+$as_echo "print -r" >&6; } ;;
+  *) { $as_echo "$as_me:${as_lineno-$LINENO}: result: cat" >&5
+$as_echo "cat" >&6; } ;;
+esac
+
+
+
+
+
+
+
+
+
+
+
+
+
 
-# Check for useable libcurl
 DEPDIR="${am__leading_dot}deps"
 
 ac_config_commands="$ac_config_commands depfiles"
@@ -3273,7 +3288,7 @@
 _am_result=none
 # First try GNU make style include.
 echo "include confinc" > confmf
-# Ignore all kinds of additional output from `make'.
+# Ignore all kinds of additional output from 'make'.
 case `$am_make -s -f confmf 2> /dev/null` in #(
 *the\ am__doit\ target*)
   am__include=include
@@ -3339,7 +3354,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_CC="${ac_tool_prefix}gcc"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -3379,7 +3394,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_CC="gcc"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -3432,7 +3447,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_CC="${ac_tool_prefix}cc"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -3473,7 +3488,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     if test "$as_dir/$ac_word$ac_exec_ext" = "/usr/ucb/cc"; then
        ac_prog_rejected=yes
        continue
@@ -3531,7 +3546,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_CC="$ac_tool_prefix$ac_prog"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -3575,7 +3590,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_CC="$ac_prog"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -4021,8 +4036,7 @@
 /* end confdefs.h.  */
 #include <stdarg.h>
 #include <stdio.h>
-#include <sys/types.h>
-#include <sys/stat.h>
+struct stat;
 /* Most of the following tests are stolen from RCS 5.7's src/conf.sh.  */
 struct buf { int x; };
 FILE * (*rcsopen) (struct buf *, struct stat *, int);
@@ -4118,8 +4132,8 @@
   # We make a subdir and do the tests there.  Otherwise we can end up
   # making bogus files that we don't know about and never remove.  For
   # instance it was reported that on HP-UX the gcc test will end up
-  # making a dummy file named `D' -- because `-MD' means `put the output
-  # in D'.
+  # making a dummy file named 'D' -- because '-MD' means "put the output
+  # in D".
   rm -rf conftest.dir
   mkdir conftest.dir
   # Copy depcomp to subdir because otherwise we won't find it if we're
@@ -4154,16 +4168,16 @@
     : > sub/conftest.c
     for i in 1 2 3 4 5 6; do
       echo '#include "conftst'$i'.h"' >> sub/conftest.c
-      # Using `: > sub/conftst$i.h' creates only sub/conftst1.h with
-      # Solaris 8's {/usr,}/bin/sh.
-      touch sub/conftst$i.h
+      # Using ": > sub/conftst$i.h" creates only sub/conftst1.h with
+      # Solaris 10 /bin/sh.
+      echo '/* dummy */' > sub/conftst$i.h
     done
     echo "${am__include} ${am__quote}sub/conftest.Po${am__quote}" > confmf
 
-    # We check with `-c' and `-o' for the sake of the "dashmstdout"
+    # We check with '-c' and '-o' for the sake of the "dashmstdout"
     # mode.  It turns out that the SunPro C++ compiler does not properly
-    # handle `-M -o', and we need to detect this.  Also, some Intel
-    # versions had trouble with output in subdirs
+    # handle '-M -o', and we need to detect this.  Also, some Intel
+    # versions had trouble with output in subdirs.
     am__obj=sub/conftest.${OBJEXT-o}
     am__minus_obj="-o $am__obj"
     case $depmode in
@@ -4172,8 +4186,8 @@
       test "$am__universal" = false || continue
       ;;
     nosideeffect)
-      # after this tag, mechanisms are not by side-effect, so they'll
-      # only be used when explicitly requested
+      # After this tag, mechanisms are not by side-effect, so they'll
+      # only be used when explicitly requested.
       if test "x$enable_dependency_tracking" = xyes; then
 	continue
       else
@@ -4181,7 +4195,7 @@
       fi
       ;;
     msvc7 | msvc7msys | msvisualcpp | msvcmsys)
-      # This compiler won't grok `-c -o', but also, the minuso test has
+      # This compiler won't grok '-c -o', but also, the minuso test has
       # not run yet.  These depmodes are late enough in the game, and
       # so weak that their functioning should not be impacted.
       am__obj=conftest.${OBJEXT-o}
@@ -4235,9 +4249,77 @@
 fi
 
 
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for a sed that does not truncate output" >&5
+$as_echo_n "checking for a sed that does not truncate output... " >&6; }
+if ${ac_cv_path_SED+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+            ac_script=s/aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa/bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb/
+     for ac_i in 1 2 3 4 5 6 7; do
+       ac_script="$ac_script$as_nl$ac_script"
+     done
+     echo "$ac_script" 2>/dev/null | sed 99q >conftest.sed
+     { ac_script=; unset ac_script;}
+     if test -z "$SED"; then
+  ac_path_SED_found=false
+  # Loop through the user's path and test for each of PROGNAME-LIST
+  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+for as_dir in $PATH
+do
+  IFS=$as_save_IFS
+  test -z "$as_dir" && as_dir=.
+    for ac_prog in sed gsed; do
+    for ac_exec_ext in '' $ac_executable_extensions; do
+      ac_path_SED="$as_dir/$ac_prog$ac_exec_ext"
+      as_fn_executable_p "$ac_path_SED" || continue
+# Check for GNU ac_path_SED and select it if it is found.
+  # Check for GNU $ac_path_SED
+case `"$ac_path_SED" --version 2>&1` in
+*GNU*)
+  ac_cv_path_SED="$ac_path_SED" ac_path_SED_found=:;;
+*)
+  ac_count=0
+  $as_echo_n 0123456789 >"conftest.in"
+  while :
+  do
+    cat "conftest.in" "conftest.in" >"conftest.tmp"
+    mv "conftest.tmp" "conftest.in"
+    cp "conftest.in" "conftest.nl"
+    $as_echo '' >> "conftest.nl"
+    "$ac_path_SED" -f conftest.sed < "conftest.nl" >"conftest.out" 2>/dev/null || break
+    diff "conftest.out" "conftest.nl" >/dev/null 2>&1 || break
+    as_fn_arith $ac_count + 1 && ac_count=$as_val
+    if test $ac_count -gt ${ac_path_SED_max-0}; then
+      # Best one so far, save it but keep looking for a better one
+      ac_cv_path_SED="$ac_path_SED"
+      ac_path_SED_max=$ac_count
+    fi
+    # 10*(2^10) chars as input seems more than enough
+    test $ac_count -gt 10 && break
+  done
+  rm -f conftest.in conftest.tmp conftest.nl conftest.out;;
+esac
 
+      $ac_path_SED_found && break 3
+    done
+  done
+  done
+IFS=$as_save_IFS
+  if test -z "$ac_cv_path_SED"; then
+    as_fn_error $? "no acceptable sed could be found in \$PATH" "$LINENO" 5
+  fi
+else
+  ac_cv_path_SED=$SED
+fi
 
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_path_SED" >&5
+$as_echo "$ac_cv_path_SED" >&6; }
+ SED="$ac_cv_path_SED"
+  rm -f conftest.sed
 
+test -z "$SED" && SED=sed
+Xsed="$SED -e 1s/^X//"
 
 
 
@@ -4249,425 +4331,448 @@
 
 
 
-
-
-
-
-
-
-
-
-
-
-
-
-# Check whether --with-libcurl was given.
-if test "${with_libcurl+set}" = set; then :
-  withval=$with_libcurl; _libcurl_with=$withval
-else
-  _libcurl_with=yes
-fi
-
-
-  if test "$_libcurl_with" != "no" ; then
-
-     for ac_prog in gawk mawk nawk awk
-do
-  # Extract the first word of "$ac_prog", so it can be a program name with args.
-set dummy $ac_prog; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_prog_AWK+:} false; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for grep that handles long lines and -e" >&5
+$as_echo_n "checking for grep that handles long lines and -e... " >&6; }
+if ${ac_cv_path_GREP+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  if test -n "$AWK"; then
-  ac_cv_prog_AWK="$AWK" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
+  if test -z "$GREP"; then
+  ac_path_GREP_found=false
+  # Loop through the user's path and test for each of PROGNAME-LIST
+  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+for as_dir in $PATH$PATH_SEPARATOR/usr/xpg4/bin
 do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
+    for ac_prog in grep ggrep; do
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_AWK="$ac_prog"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
+      ac_path_GREP="$as_dir/$ac_prog$ac_exec_ext"
+      as_fn_executable_p "$ac_path_GREP" || continue
+# Check for GNU ac_path_GREP and select it if it is found.
+  # Check for GNU $ac_path_GREP
+case `"$ac_path_GREP" --version 2>&1` in
+*GNU*)
+  ac_cv_path_GREP="$ac_path_GREP" ac_path_GREP_found=:;;
+*)
+  ac_count=0
+  $as_echo_n 0123456789 >"conftest.in"
+  while :
+  do
+    cat "conftest.in" "conftest.in" >"conftest.tmp"
+    mv "conftest.tmp" "conftest.in"
+    cp "conftest.in" "conftest.nl"
+    $as_echo 'GREP' >> "conftest.nl"
+    "$ac_path_GREP" -e 'GREP$' -e '-(cannot match)-' < "conftest.nl" >"conftest.out" 2>/dev/null || break
+    diff "conftest.out" "conftest.nl" >/dev/null 2>&1 || break
+    as_fn_arith $ac_count + 1 && ac_count=$as_val
+    if test $ac_count -gt ${ac_path_GREP_max-0}; then
+      # Best one so far, save it but keep looking for a better one
+      ac_cv_path_GREP="$ac_path_GREP"
+      ac_path_GREP_max=$ac_count
+    fi
+    # 10*(2^10) chars as input seems more than enough
+    test $ac_count -gt 10 && break
   done
-IFS=$as_save_IFS
+  rm -f conftest.in conftest.tmp conftest.nl conftest.out;;
+esac
 
-fi
-fi
-AWK=$ac_cv_prog_AWK
-if test -n "$AWK"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $AWK" >&5
-$as_echo "$AWK" >&6; }
+      $ac_path_GREP_found && break 3
+    done
+  done
+  done
+IFS=$as_save_IFS
+  if test -z "$ac_cv_path_GREP"; then
+    as_fn_error $? "no acceptable grep could be found in $PATH$PATH_SEPARATOR/usr/xpg4/bin" "$LINENO" 5
+  fi
 else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
+  ac_cv_path_GREP=$GREP
 fi
 
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_path_GREP" >&5
+$as_echo "$ac_cv_path_GREP" >&6; }
+ GREP="$ac_cv_path_GREP"
 
-  test -n "$AWK" && break
-done
-
-
-     _libcurl_version_parse="eval $AWK '{split(\$NF,A,\".\"); X=256*256*A[1]+256*A[2]+A[3]; print X;}'"
-
-     _libcurl_try_link=yes
 
-     if test -d "$_libcurl_with" ; then
-        LIBCURL_CPPFLAGS="-I$withval/include"
-        _libcurl_ldflags="-L$withval/lib"
-        # Extract the first word of "curl-config", so it can be a program name with args.
-set dummy curl-config; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_path__libcurl_config+:} false; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for egrep" >&5
+$as_echo_n "checking for egrep... " >&6; }
+if ${ac_cv_path_EGREP+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  case $_libcurl_config in
-  [\\/]* | ?:[\\/]*)
-  ac_cv_path__libcurl_config="$_libcurl_config" # Let the user override the test with a path.
-  ;;
-  *)
+  if echo a | $GREP -E '(a|b)' >/dev/null 2>&1
+   then ac_cv_path_EGREP="$GREP -E"
+   else
+     if test -z "$EGREP"; then
+  ac_path_EGREP_found=false
+  # Loop through the user's path and test for each of PROGNAME-LIST
   as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in "$withval/bin"
+for as_dir in $PATH$PATH_SEPARATOR/usr/xpg4/bin
 do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
+    for ac_prog in egrep; do
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_path__libcurl_config="$as_dir/$ac_word$ac_exec_ext"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
+      ac_path_EGREP="$as_dir/$ac_prog$ac_exec_ext"
+      as_fn_executable_p "$ac_path_EGREP" || continue
+# Check for GNU ac_path_EGREP and select it if it is found.
+  # Check for GNU $ac_path_EGREP
+case `"$ac_path_EGREP" --version 2>&1` in
+*GNU*)
+  ac_cv_path_EGREP="$ac_path_EGREP" ac_path_EGREP_found=:;;
+*)
+  ac_count=0
+  $as_echo_n 0123456789 >"conftest.in"
+  while :
+  do
+    cat "conftest.in" "conftest.in" >"conftest.tmp"
+    mv "conftest.tmp" "conftest.in"
+    cp "conftest.in" "conftest.nl"
+    $as_echo 'EGREP' >> "conftest.nl"
+    "$ac_path_EGREP" 'EGREP$' < "conftest.nl" >"conftest.out" 2>/dev/null || break
+    diff "conftest.out" "conftest.nl" >/dev/null 2>&1 || break
+    as_fn_arith $ac_count + 1 && ac_count=$as_val
+    if test $ac_count -gt ${ac_path_EGREP_max-0}; then
+      # Best one so far, save it but keep looking for a better one
+      ac_cv_path_EGREP="$ac_path_EGREP"
+      ac_path_EGREP_max=$ac_count
+    fi
+    # 10*(2^10) chars as input seems more than enough
+    test $ac_count -gt 10 && break
   done
-IFS=$as_save_IFS
-
-  ;;
+  rm -f conftest.in conftest.tmp conftest.nl conftest.out;;
 esac
-fi
-_libcurl_config=$ac_cv_path__libcurl_config
-if test -n "$_libcurl_config"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $_libcurl_config" >&5
-$as_echo "$_libcurl_config" >&6; }
+
+      $ac_path_EGREP_found && break 3
+    done
+  done
+  done
+IFS=$as_save_IFS
+  if test -z "$ac_cv_path_EGREP"; then
+    as_fn_error $? "no acceptable egrep could be found in $PATH$PATH_SEPARATOR/usr/xpg4/bin" "$LINENO" 5
+  fi
 else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
+  ac_cv_path_EGREP=$EGREP
 fi
 
+   fi
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_path_EGREP" >&5
+$as_echo "$ac_cv_path_EGREP" >&6; }
+ EGREP="$ac_cv_path_EGREP"
 
-     else
-        # Extract the first word of "curl-config", so it can be a program name with args.
-set dummy curl-config; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_path__libcurl_config+:} false; then :
+
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for fgrep" >&5
+$as_echo_n "checking for fgrep... " >&6; }
+if ${ac_cv_path_FGREP+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  case $_libcurl_config in
-  [\\/]* | ?:[\\/]*)
-  ac_cv_path__libcurl_config="$_libcurl_config" # Let the user override the test with a path.
-  ;;
-  *)
+  if echo 'ab*c' | $GREP -F 'ab*c' >/dev/null 2>&1
+   then ac_cv_path_FGREP="$GREP -F"
+   else
+     if test -z "$FGREP"; then
+  ac_path_FGREP_found=false
+  # Loop through the user's path and test for each of PROGNAME-LIST
   as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
+for as_dir in $PATH$PATH_SEPARATOR/usr/xpg4/bin
 do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
+    for ac_prog in fgrep; do
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_path__libcurl_config="$as_dir/$ac_word$ac_exec_ext"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
+      ac_path_FGREP="$as_dir/$ac_prog$ac_exec_ext"
+      as_fn_executable_p "$ac_path_FGREP" || continue
+# Check for GNU ac_path_FGREP and select it if it is found.
+  # Check for GNU $ac_path_FGREP
+case `"$ac_path_FGREP" --version 2>&1` in
+*GNU*)
+  ac_cv_path_FGREP="$ac_path_FGREP" ac_path_FGREP_found=:;;
+*)
+  ac_count=0
+  $as_echo_n 0123456789 >"conftest.in"
+  while :
+  do
+    cat "conftest.in" "conftest.in" >"conftest.tmp"
+    mv "conftest.tmp" "conftest.in"
+    cp "conftest.in" "conftest.nl"
+    $as_echo 'FGREP' >> "conftest.nl"
+    "$ac_path_FGREP" FGREP < "conftest.nl" >"conftest.out" 2>/dev/null || break
+    diff "conftest.out" "conftest.nl" >/dev/null 2>&1 || break
+    as_fn_arith $ac_count + 1 && ac_count=$as_val
+    if test $ac_count -gt ${ac_path_FGREP_max-0}; then
+      # Best one so far, save it but keep looking for a better one
+      ac_cv_path_FGREP="$ac_path_FGREP"
+      ac_path_FGREP_max=$ac_count
+    fi
+    # 10*(2^10) chars as input seems more than enough
+    test $ac_count -gt 10 && break
   done
-IFS=$as_save_IFS
-
-  ;;
+  rm -f conftest.in conftest.tmp conftest.nl conftest.out;;
 esac
-fi
-_libcurl_config=$ac_cv_path__libcurl_config
-if test -n "$_libcurl_config"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $_libcurl_config" >&5
-$as_echo "$_libcurl_config" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-
 
-     fi
-
-     if test x$_libcurl_config != "x" ; then
-        { $as_echo "$as_me:${as_lineno-$LINENO}: checking for the version of libcurl" >&5
-$as_echo_n "checking for the version of libcurl... " >&6; }
-if ${libcurl_cv_lib_curl_version+:} false; then :
-  $as_echo_n "(cached) " >&6
+      $ac_path_FGREP_found && break 3
+    done
+  done
+  done
+IFS=$as_save_IFS
+  if test -z "$ac_cv_path_FGREP"; then
+    as_fn_error $? "no acceptable fgrep could be found in $PATH$PATH_SEPARATOR/usr/xpg4/bin" "$LINENO" 5
+  fi
 else
-  libcurl_cv_lib_curl_version=`$_libcurl_config --version | $AWK '{print $2}'`
+  ac_cv_path_FGREP=$FGREP
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libcurl_cv_lib_curl_version" >&5
-$as_echo "$libcurl_cv_lib_curl_version" >&6; }
 
-        _libcurl_version=`echo $libcurl_cv_lib_curl_version | $_libcurl_version_parse`
-        _libcurl_wanted=`echo 7.19.4 | $_libcurl_version_parse`
-
-        if test $_libcurl_wanted -gt 0 ; then
-           { $as_echo "$as_me:${as_lineno-$LINENO}: checking for libcurl >= version 7.19.4" >&5
-$as_echo_n "checking for libcurl >= version 7.19.4... " >&6; }
-if ${libcurl_cv_lib_version_ok+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
+   fi
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_path_FGREP" >&5
+$as_echo "$ac_cv_path_FGREP" >&6; }
+ FGREP="$ac_cv_path_FGREP"
 
-              if test $_libcurl_version -ge $_libcurl_wanted ; then
-                 libcurl_cv_lib_version_ok=yes
-              else
-                 libcurl_cv_lib_version_ok=no
-              fi
 
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libcurl_cv_lib_version_ok" >&5
-$as_echo "$libcurl_cv_lib_version_ok" >&6; }
-        fi
+test -z "$GREP" && GREP=grep
 
-        if test $_libcurl_wanted -eq 0 || test x$libcurl_cv_lib_version_ok = xyes ; then
-           if test x"$LIBCURL_CPPFLAGS" = "x" ; then
-              LIBCURL_CPPFLAGS=`$_libcurl_config --cflags`
-           fi
-           if test x"$LIBCURL" = "x" ; then
-              LIBCURL=`$_libcurl_config --libs`
 
-              # This is so silly, but Apple actually has a bug in their
-              # curl-config script.  Fixed in Tiger, but there are still
-              # lots of Panther installs around.
-              case "${host}" in
-                 powerpc-apple-darwin7*)
-                    LIBCURL=`echo $LIBCURL | sed -e 's|-arch i386||g'`
-                 ;;
-              esac
-           fi
 
-           # All curl-config scripts support --feature
-           _libcurl_features=`$_libcurl_config --feature`
 
-           # Is it modern enough to have --protocols? (7.12.4)
-           if test $_libcurl_version -ge 461828 ; then
-              _libcurl_protocols=`$_libcurl_config --protocols`
-           fi
-        else
-           _libcurl_try_link=no
-        fi
 
-        unset _libcurl_wanted
-     fi
 
-     if test $_libcurl_try_link = yes ; then
 
-        # we didn't find curl-config, so let's see if the user-supplied
-        # link line (or failing that, "-lcurl") is enough.
-        LIBCURL=${LIBCURL-"$_libcurl_ldflags -lcurl"}
 
-        { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether libcurl is usable" >&5
-$as_echo_n "checking whether libcurl is usable... " >&6; }
-if ${libcurl_cv_lib_curl_usable+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
 
-           _libcurl_save_cppflags=$CPPFLAGS
-           CPPFLAGS="$LIBCURL_CPPFLAGS $CPPFLAGS"
-           _libcurl_save_libs=$LIBS
-           LIBS="$LIBCURL $LIBS"
 
-           cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <curl/curl.h>
-int
-main ()
-{
 
-/* Try and use a few common options to force a failure if we are
-   missing symbols or can't link. */
-int x;
-curl_easy_setopt(NULL,CURLOPT_URL,NULL);
-x=CURL_ERROR_SIZE;
-x=CURLOPT_WRITEFUNCTION;
-x=CURLOPT_FILE;
-x=CURLOPT_ERRORBUFFER;
-x=CURLOPT_STDERR;
-x=CURLOPT_VERBOSE;
 
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  libcurl_cv_lib_curl_usable=yes
-else
-  libcurl_cv_lib_curl_usable=no
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
 
-           CPPFLAGS=$_libcurl_save_cppflags
-           LIBS=$_libcurl_save_libs
-           unset _libcurl_save_cppflags
-           unset _libcurl_save_libs
 
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libcurl_cv_lib_curl_usable" >&5
-$as_echo "$libcurl_cv_lib_curl_usable" >&6; }
 
-        if test $libcurl_cv_lib_curl_usable = yes ; then
 
-           # Does curl_free() exist in this version of libcurl?
-           # If not, fake it with free()
 
-           _libcurl_save_cppflags=$CPPFLAGS
-           CPPFLAGS="$CPPFLAGS $LIBCURL_CPPFLAGS"
-           _libcurl_save_libs=$LIBS
-           LIBS="$LIBS $LIBCURL"
 
-           ac_fn_c_check_func "$LINENO" "curl_free" "ac_cv_func_curl_free"
-if test "x$ac_cv_func_curl_free" = xyes; then :
 
+# Check whether --with-gnu-ld was given.
+if test "${with_gnu_ld+set}" = set; then :
+  withval=$with_gnu_ld; test "$withval" = no || with_gnu_ld=yes
 else
-
-$as_echo "#define curl_free free" >>confdefs.h
-
+  with_gnu_ld=no
 fi
 
+ac_prog=ld
+if test "$GCC" = yes; then
+  # Check if gcc -print-prog-name=ld gives a path.
+  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for ld used by $CC" >&5
+$as_echo_n "checking for ld used by $CC... " >&6; }
+  case $host in
+  *-*-mingw*)
+    # gcc leaves a trailing carriage return which upsets mingw
+    ac_prog=`($CC -print-prog-name=ld) 2>&5 | tr -d '\015'` ;;
+  *)
+    ac_prog=`($CC -print-prog-name=ld) 2>&5` ;;
+  esac
+  case $ac_prog in
+    # Accept absolute paths.
+    [\\/]* | ?:[\\/]*)
+      re_direlt='/[^/][^/]*/\.\./'
+      # Canonicalize the pathname of ld
+      ac_prog=`$ECHO "$ac_prog"| $SED 's%\\\\%/%g'`
+      while $ECHO "$ac_prog" | $GREP "$re_direlt" > /dev/null 2>&1; do
+	ac_prog=`$ECHO $ac_prog| $SED "s%$re_direlt%/%"`
+      done
+      test -z "$LD" && LD="$ac_prog"
+      ;;
+  "")
+    # If it fails, then pretend we aren't using GCC.
+    ac_prog=ld
+    ;;
+  *)
+    # If it is relative, then search for the first ld in PATH.
+    with_gnu_ld=unknown
+    ;;
+  esac
+elif test "$with_gnu_ld" = yes; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GNU ld" >&5
+$as_echo_n "checking for GNU ld... " >&6; }
+else
+  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for non-GNU ld" >&5
+$as_echo_n "checking for non-GNU ld... " >&6; }
+fi
+if ${lt_cv_path_LD+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  if test -z "$LD"; then
+  lt_save_ifs="$IFS"; IFS=$PATH_SEPARATOR
+  for ac_dir in $PATH; do
+    IFS="$lt_save_ifs"
+    test -z "$ac_dir" && ac_dir=.
+    if test -f "$ac_dir/$ac_prog" || test -f "$ac_dir/$ac_prog$ac_exeext"; then
+      lt_cv_path_LD="$ac_dir/$ac_prog"
+      # Check to see if the program is GNU ld.  I'd rather use --version,
+      # but apparently some variants of GNU ld only accept -v.
+      # Break only if it was the GNU/non-GNU ld that we prefer.
+      case `"$lt_cv_path_LD" -v 2>&1 </dev/null` in
+      *GNU* | *'with BFD'*)
+	test "$with_gnu_ld" != no && break
+	;;
+      *)
+	test "$with_gnu_ld" != yes && break
+	;;
+      esac
+    fi
+  done
+  IFS="$lt_save_ifs"
+else
+  lt_cv_path_LD="$LD" # Let the user override the test with a path.
+fi
+fi
 
-           CPPFLAGS=$_libcurl_save_cppflags
-           LIBS=$_libcurl_save_libs
-           unset _libcurl_save_cppflags
-           unset _libcurl_save_libs
-
-
-$as_echo "#define HAVE_LIBCURL 1" >>confdefs.h
-
-
-
-
-           for _libcurl_feature in $_libcurl_features ; do
-              cat >>confdefs.h <<_ACEOF
-#define `$as_echo "libcurl_feature_$_libcurl_feature" | $as_tr_cpp` 1
-_ACEOF
+LD="$lt_cv_path_LD"
+if test -n "$LD"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $LD" >&5
+$as_echo "$LD" >&6; }
+else
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
+fi
+test -z "$LD" && as_fn_error $? "no acceptable ld found in \$PATH" "$LINENO" 5
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking if the linker ($LD) is GNU ld" >&5
+$as_echo_n "checking if the linker ($LD) is GNU ld... " >&6; }
+if ${lt_cv_prog_gnu_ld+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  # I'd rather use --version here, but apparently some GNU lds only accept -v.
+case `$LD -v 2>&1 </dev/null` in
+*GNU* | *'with BFD'*)
+  lt_cv_prog_gnu_ld=yes
+  ;;
+*)
+  lt_cv_prog_gnu_ld=no
+  ;;
+esac
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_prog_gnu_ld" >&5
+$as_echo "$lt_cv_prog_gnu_ld" >&6; }
+with_gnu_ld=$lt_cv_prog_gnu_ld
 
-              eval `$as_echo "libcurl_feature_$_libcurl_feature" | $as_tr_sh`=yes
-           done
 
-           if test "x$_libcurl_protocols" = "x" ; then
 
-              # We don't have --protocols, so just assume that all
-              # protocols are available
-              _libcurl_protocols="HTTP FTP FILE TELNET LDAP DICT TFTP"
 
-              if test x$libcurl_feature_SSL = xyes ; then
-                 _libcurl_protocols="$_libcurl_protocols HTTPS"
 
-                 # FTPS wasn't standards-compliant until version
-                 # 7.11.0 (0x070b00 == 461568)
-                 if test $_libcurl_version -ge 461568; then
-                    _libcurl_protocols="$_libcurl_protocols FTPS"
-                 fi
-              fi
 
-              # RTSP, IMAP, POP3 and SMTP were added in
-              # 7.20.0 (0x071400 == 463872)
-              if test $_libcurl_version -ge 463872; then
-                 _libcurl_protocols="$_libcurl_protocols RTSP IMAP POP3 SMTP"
-              fi
-           fi
 
-           for _libcurl_protocol in $_libcurl_protocols ; do
-              cat >>confdefs.h <<_ACEOF
-#define `$as_echo "libcurl_protocol_$_libcurl_protocol" | $as_tr_cpp` 1
-_ACEOF
 
-              eval `$as_echo "libcurl_protocol_$_libcurl_protocol" | $as_tr_sh`=yes
-           done
-        else
-           unset LIBCURL
-           unset LIBCURL_CPPFLAGS
-        fi
-     fi
 
-     unset _libcurl_try_link
-     unset _libcurl_version_parse
-     unset _libcurl_config
-     unset _libcurl_feature
-     unset _libcurl_features
-     unset _libcurl_protocol
-     unset _libcurl_protocols
-     unset _libcurl_version
-     unset _libcurl_ldflags
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for BSD- or MS-compatible name lister (nm)" >&5
+$as_echo_n "checking for BSD- or MS-compatible name lister (nm)... " >&6; }
+if ${lt_cv_path_NM+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  if test -n "$NM"; then
+  # Let the user override the test.
+  lt_cv_path_NM="$NM"
+else
+  lt_nm_to_check="${ac_tool_prefix}nm"
+  if test -n "$ac_tool_prefix" && test "$build" = "$host"; then
+    lt_nm_to_check="$lt_nm_to_check nm"
   fi
-
-  if test x$_libcurl_with = xno || test x$libcurl_cv_lib_curl_usable != xyes ; then
-     # This is the IF-NO path
-     with_libcurl=no
+  for lt_tmp_nm in $lt_nm_to_check; do
+    lt_save_ifs="$IFS"; IFS=$PATH_SEPARATOR
+    for ac_dir in $PATH /usr/ccs/bin/elf /usr/ccs/bin /usr/ucb /bin; do
+      IFS="$lt_save_ifs"
+      test -z "$ac_dir" && ac_dir=.
+      tmp_nm="$ac_dir/$lt_tmp_nm"
+      if test -f "$tmp_nm" || test -f "$tmp_nm$ac_exeext" ; then
+	# Check to see if the nm accepts a BSD-compat flag.
+	# Adding the `sed 1q' prevents false positives on HP-UX, which says:
+	#   nm: unknown option "B" ignored
+	# Tru64's nm complains that /dev/null is an invalid object file
+	case `"$tmp_nm" -B /dev/null 2>&1 | sed '1q'` in
+	*/dev/null* | *'Invalid file or object type'*)
+	  lt_cv_path_NM="$tmp_nm -B"
+	  break
+	  ;;
+	*)
+	  case `"$tmp_nm" -p /dev/null 2>&1 | sed '1q'` in
+	  */dev/null*)
+	    lt_cv_path_NM="$tmp_nm -p"
+	    break
+	    ;;
+	  *)
+	    lt_cv_path_NM=${lt_cv_path_NM="$tmp_nm"} # keep the first match, but
+	    continue # so that we can try to find one that supports BSD flags
+	    ;;
+	  esac
+	  ;;
+	esac
+      fi
+    done
+    IFS="$lt_save_ifs"
+  done
+  : ${lt_cv_path_NM=no}
+fi
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_path_NM" >&5
+$as_echo "$lt_cv_path_NM" >&6; }
+if test "$lt_cv_path_NM" != "no"; then
+  NM="$lt_cv_path_NM"
+else
+  # Didn't find any BSD compatible name lister, look for dumpbin.
+  if test -n "$DUMPBIN"; then :
+    # Let the user override the test.
   else
-     # This is the IF-YES path
-     with_libcurl=yes
+    if test -n "$ac_tool_prefix"; then
+  for ac_prog in dumpbin "link -dump"
+  do
+    # Extract the first word of "$ac_tool_prefix$ac_prog", so it can be a program name with args.
+set dummy $ac_tool_prefix$ac_prog; ac_word=$2
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
+if ${ac_cv_prog_DUMPBIN+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  if test -n "$DUMPBIN"; then
+  ac_cv_prog_DUMPBIN="$DUMPBIN" # Let the user override the test.
+else
+as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+for as_dir in $PATH
+do
+  IFS=$as_save_IFS
+  test -z "$as_dir" && as_dir=.
+    for ac_exec_ext in '' $ac_executable_extensions; do
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+    ac_cv_prog_DUMPBIN="$ac_tool_prefix$ac_prog"
+    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+    break 2
   fi
+done
+  done
+IFS=$as_save_IFS
 
-  unset _libcurl_with
-
-
-# Help line for documentation
-# Check whether --enable-doc was given.
-if test "${enable_doc+set}" = set; then :
-  enableval=$enable_doc; wantdoc=$enableval
-else
-  wantdoc=yes
 fi
-
-
-# Help line for doxygen
-# Check whether --enable-doxygen was given.
-if test "${enable_doxygen+set}" = set; then :
-  enableval=$enable_doxygen; wantdoxygen=$enableval
-else
-  wantdoxygen=no
 fi
-
-
-# Help line for debug
-# Check whether --enable-debug was given.
-if test "${enable_debug+set}" = set; then :
-  enableval=$enable_debug; debug=$enableval
+DUMPBIN=$ac_cv_prog_DUMPBIN
+if test -n "$DUMPBIN"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $DUMPBIN" >&5
+$as_echo "$DUMPBIN" >&6; }
 else
-  debug=no
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
 fi
 
 
-# Help line for using git version in pacman version string
-# Check whether --enable-git-version was given.
-if test "${enable_git_version+set}" = set; then :
-  enableval=$enable_git_version; wantgitver=$enableval
-else
-  wantgitver=no
+    test -n "$DUMPBIN" && break
+  done
 fi
-
-
-# Checks for programs.
-for ac_prog in gawk mawk nawk awk
+if test -z "$DUMPBIN"; then
+  ac_ct_DUMPBIN=$DUMPBIN
+  for ac_prog in dumpbin "link -dump"
 do
   # Extract the first word of "$ac_prog", so it can be a program name with args.
 set dummy $ac_prog; ac_word=$2
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
 $as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_prog_AWK+:} false; then :
+if ${ac_cv_prog_ac_ct_DUMPBIN+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  if test -n "$AWK"; then
-  ac_cv_prog_AWK="$AWK" # Let the user override the test.
+  if test -n "$ac_ct_DUMPBIN"; then
+  ac_cv_prog_ac_ct_DUMPBIN="$ac_ct_DUMPBIN" # Let the user override the test.
 else
 as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
 for as_dir in $PATH
@@ -4675,8 +4780,8 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_AWK="$ac_prog"
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+    ac_cv_prog_ac_ct_DUMPBIN="$ac_prog"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
@@ -4686,638 +4791,388 @@
 
 fi
 fi
-AWK=$ac_cv_prog_AWK
-if test -n "$AWK"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $AWK" >&5
-$as_echo "$AWK" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
+ac_ct_DUMPBIN=$ac_cv_prog_ac_ct_DUMPBIN
+if test -n "$ac_ct_DUMPBIN"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_ct_DUMPBIN" >&5
+$as_echo "$ac_ct_DUMPBIN" >&6; }
+else
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
 fi
 
 
-  test -n "$AWK" && break
+  test -n "$ac_ct_DUMPBIN" && break
 done
 
-   { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $CC option to accept ISO C99" >&5
-$as_echo_n "checking for $CC option to accept ISO C99... " >&6; }
-if ${ac_cv_prog_cc_c99+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  ac_cv_prog_cc_c99=no
-ac_save_CC=$CC
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <stdarg.h>
-#include <stdbool.h>
-#include <stdlib.h>
-#include <wchar.h>
-#include <stdio.h>
-
-// Check varargs macros.  These examples are taken from C99 6.10.3.5.
-#define debug(...) fprintf (stderr, __VA_ARGS__)
-#define showlist(...) puts (#__VA_ARGS__)
-#define report(test,...) ((test) ? puts (#test) : printf (__VA_ARGS__))
-static void
-test_varargs_macros (void)
-{
-  int x = 1234;
-  int y = 5678;
-  debug ("Flag");
-  debug ("X = %d\n", x);
-  showlist (The first, second, and third items.);
-  report (x>y, "x is %d but y is %d", x, y);
-}
+  if test "x$ac_ct_DUMPBIN" = x; then
+    DUMPBIN=":"
+  else
+    case $cross_compiling:$ac_tool_warned in
+yes:)
+{ $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
+$as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+ac_tool_warned=yes ;;
+esac
+    DUMPBIN=$ac_ct_DUMPBIN
+  fi
+fi
 
-// Check long long types.
-#define BIG64 18446744073709551615ull
-#define BIG32 4294967295ul
-#define BIG_OK (BIG64 / BIG32 == 4294967297ull && BIG64 % BIG32 == 0)
-#if !BIG_OK
-  your preprocessor is broken;
-#endif
-#if BIG_OK
-#else
-  your preprocessor is broken;
-#endif
-static long long int bignum = -9223372036854775807LL;
-static unsigned long long int ubignum = BIG64;
+    case `$DUMPBIN -symbols /dev/null 2>&1 | sed '1q'` in
+    *COFF*)
+      DUMPBIN="$DUMPBIN -symbols"
+      ;;
+    *)
+      DUMPBIN=:
+      ;;
+    esac
+  fi
 
-struct incomplete_array
-{
-  int datasize;
-  double data[];
-};
+  if test "$DUMPBIN" != ":"; then
+    NM="$DUMPBIN"
+  fi
+fi
+test -z "$NM" && NM=nm
 
-struct named_init {
-  int number;
-  const wchar_t *name;
-  double average;
-};
 
-typedef const char *ccp;
 
-static inline int
-test_restrict (ccp restrict text)
-{
-  // See if C++-style comments work.
-  // Iterate through items via the restricted pointer.
-  // Also check for declarations in for loops.
-  for (unsigned int i = 0; *(text+i) != '\0'; ++i)
-    continue;
-  return 0;
-}
 
-// Check varargs and va_copy.
-static void
-test_varargs (const char *format, ...)
-{
-  va_list args;
-  va_start (args, format);
-  va_list args_copy;
-  va_copy (args_copy, args);
 
-  const char *str;
-  int number;
-  float fnumber;
 
-  while (*format)
-    {
-      switch (*format++)
-	{
-	case 's': // string
-	  str = va_arg (args_copy, const char *);
-	  break;
-	case 'd': // int
-	  number = va_arg (args_copy, int);
-	  break;
-	case 'f': // float
-	  fnumber = va_arg (args_copy, double);
-	  break;
-	default:
-	  break;
-	}
-    }
-  va_end (args_copy);
-  va_end (args);
-}
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking the name lister ($NM) interface" >&5
+$as_echo_n "checking the name lister ($NM) interface... " >&6; }
+if ${lt_cv_nm_interface+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  lt_cv_nm_interface="BSD nm"
+  echo "int some_variable = 0;" > conftest.$ac_ext
+  (eval echo "\"\$as_me:$LINENO: $ac_compile\"" >&5)
+  (eval "$ac_compile" 2>conftest.err)
+  cat conftest.err >&5
+  (eval echo "\"\$as_me:$LINENO: $NM \\\"conftest.$ac_objext\\\"\"" >&5)
+  (eval "$NM \"conftest.$ac_objext\"" 2>conftest.err > conftest.out)
+  cat conftest.err >&5
+  (eval echo "\"\$as_me:$LINENO: output\"" >&5)
+  cat conftest.out >&5
+  if $GREP 'External.*some_variable' conftest.out > /dev/null; then
+    lt_cv_nm_interface="MS dumpbin"
+  fi
+  rm -f conftest*
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_nm_interface" >&5
+$as_echo "$lt_cv_nm_interface" >&6; }
 
-int
-main ()
-{
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether ln -s works" >&5
+$as_echo_n "checking whether ln -s works... " >&6; }
+LN_S=$as_ln_s
+if test "$LN_S" = "ln -s"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+$as_echo "yes" >&6; }
+else
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no, using $LN_S" >&5
+$as_echo "no, using $LN_S" >&6; }
+fi
 
-  // Check bool.
-  _Bool success = false;
+# find the maximum length of command line arguments
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking the maximum length of command line arguments" >&5
+$as_echo_n "checking the maximum length of command line arguments... " >&6; }
+if ${lt_cv_sys_max_cmd_len+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+    i=0
+  teststring="ABCD"
 
-  // Check restrict.
-  if (test_restrict ("String literal") == 0)
-    success = true;
-  char *restrict newvar = "Another string";
+  case $build_os in
+  msdosdjgpp*)
+    # On DJGPP, this test can blow up pretty badly due to problems in libc
+    # (any single argument exceeding 2000 bytes causes a buffer overrun
+    # during glob expansion).  Even if it were fixed, the result of this
+    # check would be larger than it should be.
+    lt_cv_sys_max_cmd_len=12288;    # 12K is about right
+    ;;
 
-  // Check varargs.
-  test_varargs ("s, d' f .", "string", 65, 34.234);
-  test_varargs_macros ();
+  gnu*)
+    # Under GNU Hurd, this test is not required because there is
+    # no limit to the length of command line arguments.
+    # Libtool will interpret -1 as no limit whatsoever
+    lt_cv_sys_max_cmd_len=-1;
+    ;;
 
-  // Check flexible array members.
-  struct incomplete_array *ia =
-    malloc (sizeof (struct incomplete_array) + (sizeof (double) * 10));
-  ia->datasize = 10;
-  for (int i = 0; i < ia->datasize; ++i)
-    ia->data[i] = i * 1.234;
+  cygwin* | mingw* | cegcc*)
+    # On Win9x/ME, this test blows up -- it succeeds, but takes
+    # about 5 minutes as the teststring grows exponentially.
+    # Worse, since 9x/ME are not pre-emptively multitasking,
+    # you end up with a "frozen" computer, even though with patience
+    # the test eventually succeeds (with a max line length of 256k).
+    # Instead, let's just punt: use the minimum linelength reported by
+    # all of the supported platforms: 8192 (on NT/2K/XP).
+    lt_cv_sys_max_cmd_len=8192;
+    ;;
 
-  // Check named initializers.
-  struct named_init ni = {
-    .number = 34,
-    .name = L"Test wide string",
-    .average = 543.34343,
-  };
+  mint*)
+    # On MiNT this can take a long time and run out of memory.
+    lt_cv_sys_max_cmd_len=8192;
+    ;;
 
-  ni.number = 58;
+  amigaos*)
+    # On AmigaOS with pdksh, this test takes hours, literally.
+    # So we just punt and use a minimum line length of 8192.
+    lt_cv_sys_max_cmd_len=8192;
+    ;;
 
-  int dynamic_array[ni.number];
-  dynamic_array[ni.number - 1] = 543;
+  netbsd* | freebsd* | openbsd* | darwin* | dragonfly*)
+    # This has been around since 386BSD, at least.  Likely further.
+    if test -x /sbin/sysctl; then
+      lt_cv_sys_max_cmd_len=`/sbin/sysctl -n kern.argmax`
+    elif test -x /usr/sbin/sysctl; then
+      lt_cv_sys_max_cmd_len=`/usr/sbin/sysctl -n kern.argmax`
+    else
+      lt_cv_sys_max_cmd_len=65536	# usable default for all BSDs
+    fi
+    # And add a safety zone
+    lt_cv_sys_max_cmd_len=`expr $lt_cv_sys_max_cmd_len \/ 4`
+    lt_cv_sys_max_cmd_len=`expr $lt_cv_sys_max_cmd_len \* 3`
+    ;;
 
-  // work around unused variable warnings
-  return (!success || bignum == 0LL || ubignum == 0uLL || newvar[0] == 'x'
-	  || dynamic_array[ni.number - 1] != 543);
+  interix*)
+    # We know the value 262144 and hardcode it with a safety zone (like BSD)
+    lt_cv_sys_max_cmd_len=196608
+    ;;
 
-  ;
-  return 0;
-}
-_ACEOF
-for ac_arg in '' -std=gnu99 -std=c99 -c99 -AC99 -xc99=all -qlanglvl=extc99
-do
-  CC="$ac_save_CC $ac_arg"
-  if ac_fn_c_try_compile "$LINENO"; then :
-  ac_cv_prog_cc_c99=$ac_arg
-fi
-rm -f core conftest.err conftest.$ac_objext
-  test "x$ac_cv_prog_cc_c99" != "xno" && break
-done
-rm -f conftest.$ac_ext
-CC=$ac_save_CC
+  osf*)
+    # Dr. Hans Ekkehard Plesser reports seeing a kernel panic running configure
+    # due to this test when exec_disable_arg_limit is 1 on Tru64. It is not
+    # nice to cause kernel panics so lets avoid the loop below.
+    # First set a reasonable default.
+    lt_cv_sys_max_cmd_len=16384
+    #
+    if test -x /sbin/sysconfig; then
+      case `/sbin/sysconfig -q proc exec_disable_arg_limit` in
+        *1*) lt_cv_sys_max_cmd_len=-1 ;;
+      esac
+    fi
+    ;;
+  sco3.2v5*)
+    lt_cv_sys_max_cmd_len=102400
+    ;;
+  sysv5* | sco5v6* | sysv4.2uw2*)
+    kargmax=`grep ARG_MAX /etc/conf/cf.d/stune 2>/dev/null`
+    if test -n "$kargmax"; then
+      lt_cv_sys_max_cmd_len=`echo $kargmax | sed 's/.*[	 ]//'`
+    else
+      lt_cv_sys_max_cmd_len=32768
+    fi
+    ;;
+  *)
+    lt_cv_sys_max_cmd_len=`(getconf ARG_MAX) 2> /dev/null`
+    if test -n "$lt_cv_sys_max_cmd_len"; then
+      lt_cv_sys_max_cmd_len=`expr $lt_cv_sys_max_cmd_len \/ 4`
+      lt_cv_sys_max_cmd_len=`expr $lt_cv_sys_max_cmd_len \* 3`
+    else
+      # Make teststring a little bigger before we do anything with it.
+      # a 1K string should be a reasonable start.
+      for i in 1 2 3 4 5 6 7 8 ; do
+        teststring=$teststring$teststring
+      done
+      SHELL=${SHELL-${CONFIG_SHELL-/bin/sh}}
+      # If test is not a shell built-in, we'll probably end up computing a
+      # maximum length that is only half of the actual maximum length, but
+      # we can't tell.
+      while { test "X"`func_fallback_echo "$teststring$teststring" 2>/dev/null` \
+	         = "X$teststring$teststring"; } >/dev/null 2>&1 &&
+	      test $i != 17 # 1/2 MB should be enough
+      do
+        i=`expr $i + 1`
+        teststring=$teststring$teststring
+      done
+      # Only check the string length outside the loop.
+      lt_cv_sys_max_cmd_len=`expr "X$teststring" : ".*" 2>&1`
+      teststring=
+      # Add a significant safety factor because C++ compilers can tack on
+      # massive amounts of additional arguments before passing them to the
+      # linker.  It appears as though 1/2 is a usable value.
+      lt_cv_sys_max_cmd_len=`expr $lt_cv_sys_max_cmd_len \/ 2`
+    fi
+    ;;
+  esac
 
 fi
-# AC_CACHE_VAL
-case "x$ac_cv_prog_cc_c99" in
-  x)
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: none needed" >&5
-$as_echo "none needed" >&6; } ;;
-  xno)
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: unsupported" >&5
-$as_echo "unsupported" >&6; } ;;
-  *)
-    CC="$CC $ac_cv_prog_cc_c99"
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_prog_cc_c99" >&5
-$as_echo "$ac_cv_prog_cc_c99" >&6; } ;;
-esac
-if test "x$ac_cv_prog_cc_c99" != xno; then :
 
+if test -n $lt_cv_sys_max_cmd_len ; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_sys_max_cmd_len" >&5
+$as_echo "$lt_cv_sys_max_cmd_len" >&6; }
+else
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: none" >&5
+$as_echo "none" >&6; }
 fi
+max_cmd_len=$lt_cv_sys_max_cmd_len
 
 
-ac_ext=cpp
-ac_cpp='$CXXCPP $CPPFLAGS'
-ac_compile='$CXX -c $CXXFLAGS $CPPFLAGS conftest.$ac_ext >&5'
-ac_link='$CXX -o conftest$ac_exeext $CXXFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
-ac_compiler_gnu=$ac_cv_cxx_compiler_gnu
-if test -z "$CXX"; then
-  if test -n "$CCC"; then
-    CXX=$CCC
-  else
-    if test -n "$ac_tool_prefix"; then
-  for ac_prog in g++ c++ gpp aCC CC cxx cc++ cl.exe FCC KCC RCC xlC_r xlC
-  do
-    # Extract the first word of "$ac_tool_prefix$ac_prog", so it can be a program name with args.
-set dummy $ac_tool_prefix$ac_prog; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_prog_CXX+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -n "$CXX"; then
-  ac_cv_prog_CXX="$CXX" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_CXX="$ac_tool_prefix$ac_prog"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
 
-fi
-fi
-CXX=$ac_cv_prog_CXX
-if test -n "$CXX"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $CXX" >&5
-$as_echo "$CXX" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
 
 
-    test -n "$CXX" && break
-  done
-fi
-if test -z "$CXX"; then
-  ac_ct_CXX=$CXX
-  for ac_prog in g++ c++ gpp aCC CC cxx cc++ cl.exe FCC KCC RCC xlC_r xlC
-do
-  # Extract the first word of "$ac_prog", so it can be a program name with args.
-set dummy $ac_prog; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_prog_ac_ct_CXX+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -n "$ac_ct_CXX"; then
-  ac_cv_prog_ac_ct_CXX="$ac_ct_CXX" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_ac_ct_CXX="$ac_prog"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
 
-fi
-fi
-ac_ct_CXX=$ac_cv_prog_ac_ct_CXX
-if test -n "$ac_ct_CXX"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_ct_CXX" >&5
-$as_echo "$ac_ct_CXX" >&6; }
+: ${CP="cp -f"}
+: ${MV="mv -f"}
+: ${RM="rm -f"}
+
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether the shell understands some XSI constructs" >&5
+$as_echo_n "checking whether the shell understands some XSI constructs... " >&6; }
+# Try some XSI features
+xsi_shell=no
+( _lt_dummy="a/b/c"
+  test "${_lt_dummy##*/},${_lt_dummy%/*},${_lt_dummy#??}"${_lt_dummy%"$_lt_dummy"}, \
+      = c,a/b,b/c, \
+    && eval 'test $(( 1 + 1 )) -eq 2 \
+    && test "${#_lt_dummy}" -eq 5' ) >/dev/null 2>&1 \
+  && xsi_shell=yes
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $xsi_shell" >&5
+$as_echo "$xsi_shell" >&6; }
+
+
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether the shell understands \"+=\"" >&5
+$as_echo_n "checking whether the shell understands \"+=\"... " >&6; }
+lt_shell_append=no
+( foo=bar; set foo baz; eval "$1+=\$2" && test "$foo" = barbaz ) \
+    >/dev/null 2>&1 \
+  && lt_shell_append=yes
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_shell_append" >&5
+$as_echo "$lt_shell_append" >&6; }
+
+
+if ( (MAIL=60; unset MAIL) || exit) >/dev/null 2>&1; then
+  lt_unset=unset
 else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
+  lt_unset=false
 fi
 
 
-  test -n "$ac_ct_CXX" && break
-done
 
-  if test "x$ac_ct_CXX" = x; then
-    CXX="g++"
-  else
-    case $cross_compiling:$ac_tool_warned in
-yes:)
-{ $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
-$as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
-ac_tool_warned=yes ;;
-esac
-    CXX=$ac_ct_CXX
-  fi
-fi
 
-  fi
-fi
-# Provide some information about the compiler.
-$as_echo "$as_me:${as_lineno-$LINENO}: checking for C++ compiler version" >&5
-set X $ac_compile
-ac_compiler=$2
-for ac_option in --version -v -V -qversion; do
-  { { ac_try="$ac_compiler $ac_option >&5"
-case "(($ac_try" in
-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
-  *) ac_try_echo=$ac_try;;
+
+# test EBCDIC or ASCII
+case `echo X|tr X '\101'` in
+ A) # ASCII based system
+    # \n is not interpreted correctly by Solaris 8 /usr/ucb/tr
+  lt_SP2NL='tr \040 \012'
+  lt_NL2SP='tr \015\012 \040\040'
+  ;;
+ *) # EBCDIC based system
+  lt_SP2NL='tr \100 \n'
+  lt_NL2SP='tr \r\n \100\100'
+  ;;
 esac
-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
-$as_echo "$ac_try_echo"; } >&5
-  (eval "$ac_compiler $ac_option >&5") 2>conftest.err
-  ac_status=$?
-  if test -s conftest.err; then
-    sed '10a\
-... rest of stderr output deleted ...
-         10q' conftest.err >conftest.er1
-    cat conftest.er1 >&5
-  fi
-  rm -f conftest.er1 conftest.err
-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; }
-done
 
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether we are using the GNU C++ compiler" >&5
-$as_echo_n "checking whether we are using the GNU C++ compiler... " >&6; }
-if ${ac_cv_cxx_compiler_gnu+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
 
-int
-main ()
-{
-#ifndef __GNUC__
-       choke me
-#endif
 
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_cxx_try_compile "$LINENO"; then :
-  ac_compiler_gnu=yes
-else
-  ac_compiler_gnu=no
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-ac_cv_cxx_compiler_gnu=$ac_compiler_gnu
 
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_cxx_compiler_gnu" >&5
-$as_echo "$ac_cv_cxx_compiler_gnu" >&6; }
-if test $ac_compiler_gnu = yes; then
-  GXX=yes
-else
-  GXX=
-fi
-ac_test_CXXFLAGS=${CXXFLAGS+set}
-ac_save_CXXFLAGS=$CXXFLAGS
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether $CXX accepts -g" >&5
-$as_echo_n "checking whether $CXX accepts -g... " >&6; }
-if ${ac_cv_prog_cxx_g+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  ac_save_cxx_werror_flag=$ac_cxx_werror_flag
-   ac_cxx_werror_flag=yes
-   ac_cv_prog_cxx_g=no
-   CXXFLAGS="-g"
-   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
 
-int
-main ()
-{
 
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_cxx_try_compile "$LINENO"; then :
-  ac_cv_prog_cxx_g=yes
-else
-  CXXFLAGS=""
-      cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
 
-int
-main ()
-{
 
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_cxx_try_compile "$LINENO"; then :
-
-else
-  ac_cxx_werror_flag=$ac_save_cxx_werror_flag
-	 CXXFLAGS="-g"
-	 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-int
-main ()
-{
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_cxx_try_compile "$LINENO"; then :
-  ac_cv_prog_cxx_g=yes
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-   ac_cxx_werror_flag=$ac_save_cxx_werror_flag
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_prog_cxx_g" >&5
-$as_echo "$ac_cv_prog_cxx_g" >&6; }
-if test "$ac_test_CXXFLAGS" = set; then
-  CXXFLAGS=$ac_save_CXXFLAGS
-elif test $ac_cv_prog_cxx_g = yes; then
-  if test "$GXX" = yes; then
-    CXXFLAGS="-g -O2"
-  else
-    CXXFLAGS="-g"
-  fi
-else
-  if test "$GXX" = yes; then
-    CXXFLAGS="-O2"
-  else
-    CXXFLAGS=
-  fi
-fi
-ac_ext=c
-ac_cpp='$CPP $CPPFLAGS'
-ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
-ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
-ac_compiler_gnu=$ac_cv_c_compiler_gnu
 
-depcc="$CXX"  am_compiler_list=
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking dependency style of $depcc" >&5
-$as_echo_n "checking dependency style of $depcc... " >&6; }
-if ${am_cv_CXX_dependencies_compiler_type+:} false; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking how to convert $build file names to $host format" >&5
+$as_echo_n "checking how to convert $build file names to $host format... " >&6; }
+if ${lt_cv_to_host_file_cmd+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  if test -z "$AMDEP_TRUE" && test -f "$am_depcomp"; then
-  # We make a subdir and do the tests there.  Otherwise we can end up
-  # making bogus files that we don't know about and never remove.  For
-  # instance it was reported that on HP-UX the gcc test will end up
-  # making a dummy file named `D' -- because `-MD' means `put the output
-  # in D'.
-  rm -rf conftest.dir
-  mkdir conftest.dir
-  # Copy depcomp to subdir because otherwise we won't find it if we're
-  # using a relative directory.
-  cp "$am_depcomp" conftest.dir
-  cd conftest.dir
-  # We will build objects and dependencies in a subdirectory because
-  # it helps to detect inapplicable dependency modes.  For instance
-  # both Tru64's cc and ICC support -MD to output dependencies as a
-  # side effect of compilation, but ICC will put the dependencies in
-  # the current directory while Tru64 will put them in the object
-  # directory.
-  mkdir sub
-
-  am_cv_CXX_dependencies_compiler_type=none
-  if test "$am_compiler_list" = ""; then
-     am_compiler_list=`sed -n 's/^#*\([a-zA-Z0-9]*\))$/\1/p' < ./depcomp`
-  fi
-  am__universal=false
-  case " $depcc " in #(
-     *\ -arch\ *\ -arch\ *) am__universal=true ;;
-     esac
-
-  for depmode in $am_compiler_list; do
-    # Setup a source with many dependencies, because some compilers
-    # like to wrap large dependency lists on column 80 (with \), and
-    # we should not choose a depcomp mode which is confused by this.
-    #
-    # We need to recreate these files for each test, as the compiler may
-    # overwrite some of them when testing with obscure command lines.
-    # This happens at least with the AIX C compiler.
-    : > sub/conftest.c
-    for i in 1 2 3 4 5 6; do
-      echo '#include "conftst'$i'.h"' >> sub/conftest.c
-      # Using `: > sub/conftst$i.h' creates only sub/conftst1.h with
-      # Solaris 8's {/usr,}/bin/sh.
-      touch sub/conftst$i.h
-    done
-    echo "${am__include} ${am__quote}sub/conftest.Po${am__quote}" > confmf
-
-    # We check with `-c' and `-o' for the sake of the "dashmstdout"
-    # mode.  It turns out that the SunPro C++ compiler does not properly
-    # handle `-M -o', and we need to detect this.  Also, some Intel
-    # versions had trouble with output in subdirs
-    am__obj=sub/conftest.${OBJEXT-o}
-    am__minus_obj="-o $am__obj"
-    case $depmode in
-    gcc)
-      # This depmode causes a compiler race in universal mode.
-      test "$am__universal" = false || continue
-      ;;
-    nosideeffect)
-      # after this tag, mechanisms are not by side-effect, so they'll
-      # only be used when explicitly requested
-      if test "x$enable_dependency_tracking" = xyes; then
-	continue
-      else
-	break
-      fi
-      ;;
-    msvc7 | msvc7msys | msvisualcpp | msvcmsys)
-      # This compiler won't grok `-c -o', but also, the minuso test has
-      # not run yet.  These depmodes are late enough in the game, and
-      # so weak that their functioning should not be impacted.
-      am__obj=conftest.${OBJEXT-o}
-      am__minus_obj=
-      ;;
-    none) break ;;
+  case $host in
+  *-*-mingw* )
+    case $build in
+      *-*-mingw* ) # actually msys
+        lt_cv_to_host_file_cmd=func_convert_file_msys_to_w32
+        ;;
+      *-*-cygwin* )
+        lt_cv_to_host_file_cmd=func_convert_file_cygwin_to_w32
+        ;;
+      * ) # otherwise, assume *nix
+        lt_cv_to_host_file_cmd=func_convert_file_nix_to_w32
+        ;;
     esac
-    if depmode=$depmode \
-       source=sub/conftest.c object=$am__obj \
-       depfile=sub/conftest.Po tmpdepfile=sub/conftest.TPo \
-       $SHELL ./depcomp $depcc -c $am__minus_obj sub/conftest.c \
-         >/dev/null 2>conftest.err &&
-       grep sub/conftst1.h sub/conftest.Po > /dev/null 2>&1 &&
-       grep sub/conftst6.h sub/conftest.Po > /dev/null 2>&1 &&
-       grep $am__obj sub/conftest.Po > /dev/null 2>&1 &&
-       ${MAKE-make} -s -f confmf > /dev/null 2>&1; then
-      # icc doesn't choke on unknown options, it will just issue warnings
-      # or remarks (even with -Werror).  So we grep stderr for any message
-      # that says an option was ignored or not supported.
-      # When given -MP, icc 7.0 and 7.1 complain thusly:
-      #   icc: Command line warning: ignoring option '-M'; no argument required
-      # The diagnosis changed in icc 8.0:
-      #   icc: Command line remark: option '-MP' not supported
-      if (grep 'ignoring option' conftest.err ||
-          grep 'not supported' conftest.err) >/dev/null 2>&1; then :; else
-        am_cv_CXX_dependencies_compiler_type=$depmode
-        break
-      fi
-    fi
-  done
+    ;;
+  *-*-cygwin* )
+    case $build in
+      *-*-mingw* ) # actually msys
+        lt_cv_to_host_file_cmd=func_convert_file_msys_to_cygwin
+        ;;
+      *-*-cygwin* )
+        lt_cv_to_host_file_cmd=func_convert_file_noop
+        ;;
+      * ) # otherwise, assume *nix
+        lt_cv_to_host_file_cmd=func_convert_file_nix_to_cygwin
+        ;;
+    esac
+    ;;
+  * ) # unhandled hosts (and "normal" native builds)
+    lt_cv_to_host_file_cmd=func_convert_file_noop
+    ;;
+esac
 
-  cd ..
-  rm -rf conftest.dir
-else
-  am_cv_CXX_dependencies_compiler_type=none
 fi
 
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $am_cv_CXX_dependencies_compiler_type" >&5
-$as_echo "$am_cv_CXX_dependencies_compiler_type" >&6; }
-CXXDEPMODE=depmode=$am_cv_CXX_dependencies_compiler_type
+to_host_file_cmd=$lt_cv_to_host_file_cmd
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_to_host_file_cmd" >&5
+$as_echo "$lt_cv_to_host_file_cmd" >&6; }
 
- if
-  test "x$enable_dependency_tracking" != xno \
-  && test "$am_cv_CXX_dependencies_compiler_type" = gcc3; then
-  am__fastdepCXX_TRUE=
-  am__fastdepCXX_FALSE='#'
-else
-  am__fastdepCXX_TRUE='#'
-  am__fastdepCXX_FALSE=
-fi
 
 
 
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether ln -s works" >&5
-$as_echo_n "checking whether ln -s works... " >&6; }
-LN_S=$as_ln_s
-if test "$LN_S" = "ln -s"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no, using $LN_S" >&5
-$as_echo "no, using $LN_S" >&6; }
-fi
 
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether ${MAKE-make} sets \$(MAKE)" >&5
-$as_echo_n "checking whether ${MAKE-make} sets \$(MAKE)... " >&6; }
-set x ${MAKE-make}
-ac_make=`$as_echo "$2" | sed 's/+/p/g; s/[^a-zA-Z0-9_]/_/g'`
-if eval \${ac_cv_prog_make_${ac_make}_set+:} false; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking how to convert $build file names to toolchain format" >&5
+$as_echo_n "checking how to convert $build file names to toolchain format... " >&6; }
+if ${lt_cv_to_tool_file_cmd+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  cat >conftest.make <<\_ACEOF
-SHELL = /bin/sh
-all:
-	@echo '@@@%%%=$(MAKE)=@@@%%%'
-_ACEOF
-# GNU make sometimes prints "make[1]: Entering ...", which would confuse us.
-case `${MAKE-make} -f conftest.make 2>/dev/null` in
-  *@@@%%%=?*=@@@%%%*)
-    eval ac_cv_prog_make_${ac_make}_set=yes;;
-  *)
-    eval ac_cv_prog_make_${ac_make}_set=no;;
-esac
-rm -f conftest.make
-fi
-if eval test \$ac_cv_prog_make_${ac_make}_set = yes; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }
-  SET_MAKE=
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-  SET_MAKE="MAKE=${MAKE-make}"
-fi
-
-case `pwd` in
-  *\ * | *\	*)
-    { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Libtool does not cope well with whitespace in \`pwd\`" >&5
-$as_echo "$as_me: WARNING: Libtool does not cope well with whitespace in \`pwd\`" >&2;} ;;
+  #assume ordinary cross tools, or native build.
+lt_cv_to_tool_file_cmd=func_convert_file_noop
+case $host in
+  *-*-mingw* )
+    case $build in
+      *-*-mingw* ) # actually msys
+        lt_cv_to_tool_file_cmd=func_convert_file_msys_to_w32
+        ;;
+    esac
+    ;;
 esac
 
+fi
 
+to_tool_file_cmd=$lt_cv_to_tool_file_cmd
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_to_tool_file_cmd" >&5
+$as_echo "$lt_cv_to_tool_file_cmd" >&6; }
 
-macro_version='2.4.2'
-macro_revision='1.3337'
 
 
 
 
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $LD option to reload object files" >&5
+$as_echo_n "checking for $LD option to reload object files... " >&6; }
+if ${lt_cv_ld_reload_flag+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  lt_cv_ld_reload_flag='-r'
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_ld_reload_flag" >&5
+$as_echo "$lt_cv_ld_reload_flag" >&6; }
+reload_flag=$lt_cv_ld_reload_flag
+case $reload_flag in
+"" | " "*) ;;
+*) reload_flag=" $reload_flag" ;;
+esac
+reload_cmds='$LD$reload_flag -o $output$reload_objs'
+case $host_os in
+  cygwin* | mingw* | pw32* | cegcc*)
+    if test "$GCC" != yes; then
+      reload_cmds=false
+    fi
+    ;;
+  darwin*)
+    if test "$GCC" = yes; then
+      reload_cmds='$LTCC $LTCFLAGS -nostdlib ${wl}-r -o $output$reload_objs'
+    else
+      reload_cmds='$LD$reload_flag -o $output$reload_objs'
+    fi
+    ;;
+esac
 
 
 
@@ -5327,150 +5182,99 @@
 
 
 
-ltmain="$ac_aux_dir/ltmain.sh"
-
-# Backslashify metacharacters that are still active within
-# double-quoted strings.
-sed_quote_subst='s/\(["`$\\]\)/\\\1/g'
-
-# Same as above, but do not quote variable references.
-double_quote_subst='s/\(["`\\]\)/\\\1/g'
-
-# Sed substitution to delay expansion of an escaped shell variable in a
-# double_quote_subst'ed string.
-delay_variable_subst='s/\\\\\\\\\\\$/\\\\\\$/g'
-
-# Sed substitution to delay expansion of an escaped single quote.
-delay_single_quote_subst='s/'\''/'\'\\\\\\\'\''/g'
-
-# Sed substitution to avoid accidental globbing in evaled expressions
-no_glob_subst='s/\*/\\\*/g'
-
-ECHO='\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\'
-ECHO=$ECHO$ECHO$ECHO$ECHO$ECHO
-ECHO=$ECHO$ECHO$ECHO$ECHO$ECHO$ECHO
+if test -n "$ac_tool_prefix"; then
+  # Extract the first word of "${ac_tool_prefix}objdump", so it can be a program name with args.
+set dummy ${ac_tool_prefix}objdump; ac_word=$2
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
+if ${ac_cv_prog_OBJDUMP+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  if test -n "$OBJDUMP"; then
+  ac_cv_prog_OBJDUMP="$OBJDUMP" # Let the user override the test.
+else
+as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+for as_dir in $PATH
+do
+  IFS=$as_save_IFS
+  test -z "$as_dir" && as_dir=.
+    for ac_exec_ext in '' $ac_executable_extensions; do
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+    ac_cv_prog_OBJDUMP="${ac_tool_prefix}objdump"
+    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+    break 2
+  fi
+done
+  done
+IFS=$as_save_IFS
 
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking how to print strings" >&5
-$as_echo_n "checking how to print strings... " >&6; }
-# Test print first, because it will be a builtin if present.
-if test "X`( print -r -- -n ) 2>/dev/null`" = X-n && \
-   test "X`print -r -- $ECHO 2>/dev/null`" = "X$ECHO"; then
-  ECHO='print -r --'
-elif test "X`printf %s $ECHO 2>/dev/null`" = "X$ECHO"; then
-  ECHO='printf %s\n'
+fi
+fi
+OBJDUMP=$ac_cv_prog_OBJDUMP
+if test -n "$OBJDUMP"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $OBJDUMP" >&5
+$as_echo "$OBJDUMP" >&6; }
 else
-  # Use this function as a fallback that always works.
-  func_fallback_echo ()
-  {
-    eval 'cat <<_LTECHO_EOF
-$1
-_LTECHO_EOF'
-  }
-  ECHO='func_fallback_echo'
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
 fi
 
-# func_echo_all arg...
-# Invoke $ECHO with all args, space-separated.
-func_echo_all ()
-{
-    $ECHO ""
-}
-
-case "$ECHO" in
-  printf*) { $as_echo "$as_me:${as_lineno-$LINENO}: result: printf" >&5
-$as_echo "printf" >&6; } ;;
-  print*) { $as_echo "$as_me:${as_lineno-$LINENO}: result: print -r" >&5
-$as_echo "print -r" >&6; } ;;
-  *) { $as_echo "$as_me:${as_lineno-$LINENO}: result: cat" >&5
-$as_echo "cat" >&6; } ;;
-esac
-
-
-
-
-
-
-
-
-
-
-
 
-
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for a sed that does not truncate output" >&5
-$as_echo_n "checking for a sed that does not truncate output... " >&6; }
-if ${ac_cv_path_SED+:} false; then :
+fi
+if test -z "$ac_cv_prog_OBJDUMP"; then
+  ac_ct_OBJDUMP=$OBJDUMP
+  # Extract the first word of "objdump", so it can be a program name with args.
+set dummy objdump; ac_word=$2
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
+if ${ac_cv_prog_ac_ct_OBJDUMP+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-            ac_script=s/aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa/bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb/
-     for ac_i in 1 2 3 4 5 6 7; do
-       ac_script="$ac_script$as_nl$ac_script"
-     done
-     echo "$ac_script" 2>/dev/null | sed 99q >conftest.sed
-     { ac_script=; unset ac_script;}
-     if test -z "$SED"; then
-  ac_path_SED_found=false
-  # Loop through the user's path and test for each of PROGNAME-LIST
-  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+  if test -n "$ac_ct_OBJDUMP"; then
+  ac_cv_prog_ac_ct_OBJDUMP="$ac_ct_OBJDUMP" # Let the user override the test.
+else
+as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
 for as_dir in $PATH
 do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
-    for ac_prog in sed gsed; do
     for ac_exec_ext in '' $ac_executable_extensions; do
-      ac_path_SED="$as_dir/$ac_prog$ac_exec_ext"
-      { test -f "$ac_path_SED" && $as_test_x "$ac_path_SED"; } || continue
-# Check for GNU ac_path_SED and select it if it is found.
-  # Check for GNU $ac_path_SED
-case `"$ac_path_SED" --version 2>&1` in
-*GNU*)
-  ac_cv_path_SED="$ac_path_SED" ac_path_SED_found=:;;
-*)
-  ac_count=0
-  $as_echo_n 0123456789 >"conftest.in"
-  while :
-  do
-    cat "conftest.in" "conftest.in" >"conftest.tmp"
-    mv "conftest.tmp" "conftest.in"
-    cp "conftest.in" "conftest.nl"
-    $as_echo '' >> "conftest.nl"
-    "$ac_path_SED" -f conftest.sed < "conftest.nl" >"conftest.out" 2>/dev/null || break
-    diff "conftest.out" "conftest.nl" >/dev/null 2>&1 || break
-    as_fn_arith $ac_count + 1 && ac_count=$as_val
-    if test $ac_count -gt ${ac_path_SED_max-0}; then
-      # Best one so far, save it but keep looking for a better one
-      ac_cv_path_SED="$ac_path_SED"
-      ac_path_SED_max=$ac_count
-    fi
-    # 10*(2^10) chars as input seems more than enough
-    test $ac_count -gt 10 && break
-  done
-  rm -f conftest.in conftest.tmp conftest.nl conftest.out;;
-esac
-
-      $ac_path_SED_found && break 3
-    done
-  done
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+    ac_cv_prog_ac_ct_OBJDUMP="objdump"
+    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+    break 2
+  fi
+done
   done
 IFS=$as_save_IFS
-  if test -z "$ac_cv_path_SED"; then
-    as_fn_error $? "no acceptable sed could be found in \$PATH" "$LINENO" 5
-  fi
+
+fi
+fi
+ac_ct_OBJDUMP=$ac_cv_prog_ac_ct_OBJDUMP
+if test -n "$ac_ct_OBJDUMP"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_ct_OBJDUMP" >&5
+$as_echo "$ac_ct_OBJDUMP" >&6; }
 else
-  ac_cv_path_SED=$SED
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
 fi
 
+  if test "x$ac_ct_OBJDUMP" = x; then
+    OBJDUMP="false"
+  else
+    case $cross_compiling:$ac_tool_warned in
+yes:)
+{ $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
+$as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+ac_tool_warned=yes ;;
+esac
+    OBJDUMP=$ac_ct_OBJDUMP
+  fi
+else
+  OBJDUMP="$ac_cv_prog_OBJDUMP"
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_path_SED" >&5
-$as_echo "$ac_cv_path_SED" >&6; }
- SED="$ac_cv_path_SED"
-  rm -f conftest.sed
-
-test -z "$SED" && SED=sed
-Xsed="$SED -e 1s/^X//"
-
 
+test -z "$OBJDUMP" && OBJDUMP=objdump
 
 
 
@@ -5480,325 +5284,233 @@
 
 
 
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for grep that handles long lines and -e" >&5
-$as_echo_n "checking for grep that handles long lines and -e... " >&6; }
-if ${ac_cv_path_GREP+:} false; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking how to recognize dependent libraries" >&5
+$as_echo_n "checking how to recognize dependent libraries... " >&6; }
+if ${lt_cv_deplibs_check_method+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  if test -z "$GREP"; then
-  ac_path_GREP_found=false
-  # Loop through the user's path and test for each of PROGNAME-LIST
-  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH$PATH_SEPARATOR/usr/xpg4/bin
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_prog in grep ggrep; do
-    for ac_exec_ext in '' $ac_executable_extensions; do
-      ac_path_GREP="$as_dir/$ac_prog$ac_exec_ext"
-      { test -f "$ac_path_GREP" && $as_test_x "$ac_path_GREP"; } || continue
-# Check for GNU ac_path_GREP and select it if it is found.
-  # Check for GNU $ac_path_GREP
-case `"$ac_path_GREP" --version 2>&1` in
-*GNU*)
-  ac_cv_path_GREP="$ac_path_GREP" ac_path_GREP_found=:;;
-*)
-  ac_count=0
-  $as_echo_n 0123456789 >"conftest.in"
-  while :
-  do
-    cat "conftest.in" "conftest.in" >"conftest.tmp"
-    mv "conftest.tmp" "conftest.in"
-    cp "conftest.in" "conftest.nl"
-    $as_echo 'GREP' >> "conftest.nl"
-    "$ac_path_GREP" -e 'GREP$' -e '-(cannot match)-' < "conftest.nl" >"conftest.out" 2>/dev/null || break
-    diff "conftest.out" "conftest.nl" >/dev/null 2>&1 || break
-    as_fn_arith $ac_count + 1 && ac_count=$as_val
-    if test $ac_count -gt ${ac_path_GREP_max-0}; then
-      # Best one so far, save it but keep looking for a better one
-      ac_cv_path_GREP="$ac_path_GREP"
-      ac_path_GREP_max=$ac_count
-    fi
-    # 10*(2^10) chars as input seems more than enough
-    test $ac_count -gt 10 && break
-  done
-  rm -f conftest.in conftest.tmp conftest.nl conftest.out;;
-esac
+  lt_cv_file_magic_cmd='$MAGIC_CMD'
+lt_cv_file_magic_test_file=
+lt_cv_deplibs_check_method='unknown'
+# Need to set the preceding variable on all platforms that support
+# interlibrary dependencies.
+# 'none' -- dependencies not supported.
+# `unknown' -- same as none, but documents that we really don't know.
+# 'pass_all' -- all dependencies passed with no checks.
+# 'test_compile' -- check by making test program.
+# 'file_magic [[regex]]' -- check by looking for files in library path
+# which responds to the $file_magic_cmd with a given extended regex.
+# If you have `file' or equivalent on your system and you're not sure
+# whether `pass_all' will *always* work, you probably want this one.
 
-      $ac_path_GREP_found && break 3
-    done
-  done
-  done
-IFS=$as_save_IFS
-  if test -z "$ac_cv_path_GREP"; then
-    as_fn_error $? "no acceptable grep could be found in $PATH$PATH_SEPARATOR/usr/xpg4/bin" "$LINENO" 5
-  fi
-else
-  ac_cv_path_GREP=$GREP
-fi
+case $host_os in
+aix[4-9]*)
+  lt_cv_deplibs_check_method=pass_all
+  ;;
 
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_path_GREP" >&5
-$as_echo "$ac_cv_path_GREP" >&6; }
- GREP="$ac_cv_path_GREP"
+beos*)
+  lt_cv_deplibs_check_method=pass_all
+  ;;
 
+bsdi[45]*)
+  lt_cv_deplibs_check_method='file_magic ELF [0-9][0-9]*-bit [ML]SB (shared object|dynamic lib)'
+  lt_cv_file_magic_cmd='/usr/bin/file -L'
+  lt_cv_file_magic_test_file=/shlib/libc.so
+  ;;
 
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for egrep" >&5
-$as_echo_n "checking for egrep... " >&6; }
-if ${ac_cv_path_EGREP+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  if echo a | $GREP -E '(a|b)' >/dev/null 2>&1
-   then ac_cv_path_EGREP="$GREP -E"
-   else
-     if test -z "$EGREP"; then
-  ac_path_EGREP_found=false
-  # Loop through the user's path and test for each of PROGNAME-LIST
-  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH$PATH_SEPARATOR/usr/xpg4/bin
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_prog in egrep; do
-    for ac_exec_ext in '' $ac_executable_extensions; do
-      ac_path_EGREP="$as_dir/$ac_prog$ac_exec_ext"
-      { test -f "$ac_path_EGREP" && $as_test_x "$ac_path_EGREP"; } || continue
-# Check for GNU ac_path_EGREP and select it if it is found.
-  # Check for GNU $ac_path_EGREP
-case `"$ac_path_EGREP" --version 2>&1` in
-*GNU*)
-  ac_cv_path_EGREP="$ac_path_EGREP" ac_path_EGREP_found=:;;
-*)
-  ac_count=0
-  $as_echo_n 0123456789 >"conftest.in"
-  while :
-  do
-    cat "conftest.in" "conftest.in" >"conftest.tmp"
-    mv "conftest.tmp" "conftest.in"
-    cp "conftest.in" "conftest.nl"
-    $as_echo 'EGREP' >> "conftest.nl"
-    "$ac_path_EGREP" 'EGREP$' < "conftest.nl" >"conftest.out" 2>/dev/null || break
-    diff "conftest.out" "conftest.nl" >/dev/null 2>&1 || break
-    as_fn_arith $ac_count + 1 && ac_count=$as_val
-    if test $ac_count -gt ${ac_path_EGREP_max-0}; then
-      # Best one so far, save it but keep looking for a better one
-      ac_cv_path_EGREP="$ac_path_EGREP"
-      ac_path_EGREP_max=$ac_count
-    fi
-    # 10*(2^10) chars as input seems more than enough
-    test $ac_count -gt 10 && break
-  done
-  rm -f conftest.in conftest.tmp conftest.nl conftest.out;;
-esac
+cygwin*)
+  # func_win32_libid is a shell function defined in ltmain.sh
+  lt_cv_deplibs_check_method='file_magic ^x86 archive import|^x86 DLL'
+  lt_cv_file_magic_cmd='func_win32_libid'
+  ;;
 
-      $ac_path_EGREP_found && break 3
-    done
-  done
-  done
-IFS=$as_save_IFS
-  if test -z "$ac_cv_path_EGREP"; then
-    as_fn_error $? "no acceptable egrep could be found in $PATH$PATH_SEPARATOR/usr/xpg4/bin" "$LINENO" 5
+mingw* | pw32*)
+  # Base MSYS/MinGW do not provide the 'file' command needed by
+  # func_win32_libid shell function, so use a weaker test based on 'objdump',
+  # unless we find 'file', for example because we are cross-compiling.
+  # func_win32_libid assumes BSD nm, so disallow it if using MS dumpbin.
+  if ( test "$lt_cv_nm_interface" = "BSD nm" && file / ) >/dev/null 2>&1; then
+    lt_cv_deplibs_check_method='file_magic ^x86 archive import|^x86 DLL'
+    lt_cv_file_magic_cmd='func_win32_libid'
+  else
+    # Keep this pattern in sync with the one in func_win32_libid.
+    lt_cv_deplibs_check_method='file_magic file format (pei*-i386(.*architecture: i386)?|pe-arm-wince|pe-x86-64)'
+    lt_cv_file_magic_cmd='$OBJDUMP -f'
   fi
-else
-  ac_cv_path_EGREP=$EGREP
-fi
-
-   fi
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_path_EGREP" >&5
-$as_echo "$ac_cv_path_EGREP" >&6; }
- EGREP="$ac_cv_path_EGREP"
+  ;;
 
+cegcc*)
+  # use the weaker test based on 'objdump'. See mingw*.
+  lt_cv_deplibs_check_method='file_magic file format pe-arm-.*little(.*architecture: arm)?'
+  lt_cv_file_magic_cmd='$OBJDUMP -f'
+  ;;
 
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for fgrep" >&5
-$as_echo_n "checking for fgrep... " >&6; }
-if ${ac_cv_path_FGREP+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  if echo 'ab*c' | $GREP -F 'ab*c' >/dev/null 2>&1
-   then ac_cv_path_FGREP="$GREP -F"
-   else
-     if test -z "$FGREP"; then
-  ac_path_FGREP_found=false
-  # Loop through the user's path and test for each of PROGNAME-LIST
-  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH$PATH_SEPARATOR/usr/xpg4/bin
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_prog in fgrep; do
-    for ac_exec_ext in '' $ac_executable_extensions; do
-      ac_path_FGREP="$as_dir/$ac_prog$ac_exec_ext"
-      { test -f "$ac_path_FGREP" && $as_test_x "$ac_path_FGREP"; } || continue
-# Check for GNU ac_path_FGREP and select it if it is found.
-  # Check for GNU $ac_path_FGREP
-case `"$ac_path_FGREP" --version 2>&1` in
-*GNU*)
-  ac_cv_path_FGREP="$ac_path_FGREP" ac_path_FGREP_found=:;;
-*)
-  ac_count=0
-  $as_echo_n 0123456789 >"conftest.in"
-  while :
-  do
-    cat "conftest.in" "conftest.in" >"conftest.tmp"
-    mv "conftest.tmp" "conftest.in"
-    cp "conftest.in" "conftest.nl"
-    $as_echo 'FGREP' >> "conftest.nl"
-    "$ac_path_FGREP" FGREP < "conftest.nl" >"conftest.out" 2>/dev/null || break
-    diff "conftest.out" "conftest.nl" >/dev/null 2>&1 || break
-    as_fn_arith $ac_count + 1 && ac_count=$as_val
-    if test $ac_count -gt ${ac_path_FGREP_max-0}; then
-      # Best one so far, save it but keep looking for a better one
-      ac_cv_path_FGREP="$ac_path_FGREP"
-      ac_path_FGREP_max=$ac_count
-    fi
-    # 10*(2^10) chars as input seems more than enough
-    test $ac_count -gt 10 && break
-  done
-  rm -f conftest.in conftest.tmp conftest.nl conftest.out;;
-esac
+darwin* | rhapsody*)
+  lt_cv_deplibs_check_method=pass_all
+  ;;
 
-      $ac_path_FGREP_found && break 3
-    done
-  done
-  done
-IFS=$as_save_IFS
-  if test -z "$ac_cv_path_FGREP"; then
-    as_fn_error $? "no acceptable fgrep could be found in $PATH$PATH_SEPARATOR/usr/xpg4/bin" "$LINENO" 5
+freebsd* | dragonfly*)
+  if echo __ELF__ | $CC -E - | $GREP __ELF__ > /dev/null; then
+    case $host_cpu in
+    i*86 )
+      # Not sure whether the presence of OpenBSD here was a mistake.
+      # Let's accept both of them until this is cleared up.
+      lt_cv_deplibs_check_method='file_magic (FreeBSD|OpenBSD|DragonFly)/i[3-9]86 (compact )?demand paged shared library'
+      lt_cv_file_magic_cmd=/usr/bin/file
+      lt_cv_file_magic_test_file=`echo /usr/lib/libc.so.*`
+      ;;
+    esac
+  else
+    lt_cv_deplibs_check_method=pass_all
   fi
-else
-  ac_cv_path_FGREP=$FGREP
-fi
+  ;;
 
-   fi
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_path_FGREP" >&5
-$as_echo "$ac_cv_path_FGREP" >&6; }
- FGREP="$ac_cv_path_FGREP"
+gnu*)
+  lt_cv_deplibs_check_method=pass_all
+  ;;
 
+haiku*)
+  lt_cv_deplibs_check_method=pass_all
+  ;;
 
-test -z "$GREP" && GREP=grep
+hpux10.20* | hpux11*)
+  lt_cv_file_magic_cmd=/usr/bin/file
+  case $host_cpu in
+  ia64*)
+    lt_cv_deplibs_check_method='file_magic (s[0-9][0-9][0-9]|ELF-[0-9][0-9]) shared object file - IA64'
+    lt_cv_file_magic_test_file=/usr/lib/hpux32/libc.so
+    ;;
+  hppa*64*)
+    lt_cv_deplibs_check_method='file_magic (s[0-9][0-9][0-9]|ELF[ -][0-9][0-9])(-bit)?( [LM]SB)? shared object( file)?[, -]* PA-RISC [0-9]\.[0-9]'
+    lt_cv_file_magic_test_file=/usr/lib/pa20_64/libc.sl
+    ;;
+  *)
+    lt_cv_deplibs_check_method='file_magic (s[0-9][0-9][0-9]|PA-RISC[0-9]\.[0-9]) shared library'
+    lt_cv_file_magic_test_file=/usr/lib/libc.sl
+    ;;
+  esac
+  ;;
 
+interix[3-9]*)
+  # PIC code is broken on Interix 3.x, that's why |\.a not |_pic\.a here
+  lt_cv_deplibs_check_method='match_pattern /lib[^/]+(\.so|\.a)$'
+  ;;
 
+irix5* | irix6* | nonstopux*)
+  case $LD in
+  *-32|*"-32 ") libmagic=32-bit;;
+  *-n32|*"-n32 ") libmagic=N32;;
+  *-64|*"-64 ") libmagic=64-bit;;
+  *) libmagic=never-match;;
+  esac
+  lt_cv_deplibs_check_method=pass_all
+  ;;
 
+# This must be Linux ELF.
+linux* | k*bsd*-gnu | kopensolaris*-gnu)
+  lt_cv_deplibs_check_method=pass_all
+  ;;
 
+netbsd*)
+  if echo __ELF__ | $CC -E - | $GREP __ELF__ > /dev/null; then
+    lt_cv_deplibs_check_method='match_pattern /lib[^/]+(\.so\.[0-9]+\.[0-9]+|_pic\.a)$'
+  else
+    lt_cv_deplibs_check_method='match_pattern /lib[^/]+(\.so|_pic\.a)$'
+  fi
+  ;;
 
+newos6*)
+  lt_cv_deplibs_check_method='file_magic ELF [0-9][0-9]*-bit [ML]SB (executable|dynamic lib)'
+  lt_cv_file_magic_cmd=/usr/bin/file
+  lt_cv_file_magic_test_file=/usr/lib/libnls.so
+  ;;
 
+*nto* | *qnx*)
+  lt_cv_deplibs_check_method=pass_all
+  ;;
 
+openbsd*)
+  if test -z "`echo __ELF__ | $CC -E - | $GREP __ELF__`" || test "$host_os-$host_cpu" = "openbsd2.8-powerpc"; then
+    lt_cv_deplibs_check_method='match_pattern /lib[^/]+(\.so\.[0-9]+\.[0-9]+|\.so|_pic\.a)$'
+  else
+    lt_cv_deplibs_check_method='match_pattern /lib[^/]+(\.so\.[0-9]+\.[0-9]+|_pic\.a)$'
+  fi
+  ;;
 
+osf3* | osf4* | osf5*)
+  lt_cv_deplibs_check_method=pass_all
+  ;;
 
+rdos*)
+  lt_cv_deplibs_check_method=pass_all
+  ;;
 
+solaris*)
+  lt_cv_deplibs_check_method=pass_all
+  ;;
 
+sysv5* | sco3.2v5* | sco5v6* | unixware* | OpenUNIX* | sysv4*uw2*)
+  lt_cv_deplibs_check_method=pass_all
+  ;;
 
+sysv4 | sysv4.3*)
+  case $host_vendor in
+  motorola)
+    lt_cv_deplibs_check_method='file_magic ELF [0-9][0-9]*-bit [ML]SB (shared object|dynamic lib) M[0-9][0-9]* Version [0-9]'
+    lt_cv_file_magic_test_file=`echo /usr/lib/libc.so*`
+    ;;
+  ncr)
+    lt_cv_deplibs_check_method=pass_all
+    ;;
+  sequent)
+    lt_cv_file_magic_cmd='/bin/file'
+    lt_cv_deplibs_check_method='file_magic ELF [0-9][0-9]*-bit [LM]SB (shared object|dynamic lib )'
+    ;;
+  sni)
+    lt_cv_file_magic_cmd='/bin/file'
+    lt_cv_deplibs_check_method="file_magic ELF [0-9][0-9]*-bit [LM]SB dynamic lib"
+    lt_cv_file_magic_test_file=/lib/libc.so
+    ;;
+  siemens)
+    lt_cv_deplibs_check_method=pass_all
+    ;;
+  pc)
+    lt_cv_deplibs_check_method=pass_all
+    ;;
+  esac
+  ;;
 
+tpf*)
+  lt_cv_deplibs_check_method=pass_all
+  ;;
+esac
 
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_deplibs_check_method" >&5
+$as_echo "$lt_cv_deplibs_check_method" >&6; }
 
+file_magic_glob=
+want_nocaseglob=no
+if test "$build" = "$host"; then
+  case $host_os in
+  mingw* | pw32*)
+    if ( shopt | grep nocaseglob ) >/dev/null 2>&1; then
+      want_nocaseglob=yes
+    else
+      file_magic_glob=`echo aAbBcCdDeEfFgGhHiIjJkKlLmMnNoOpPqQrRsStTuUvVwWxXyYzZ | $SED -e "s/\(..\)/s\/[\1]\/[\1]\/g;/g"`
+    fi
+    ;;
+  esac
+fi
 
+file_magic_cmd=$lt_cv_file_magic_cmd
+deplibs_check_method=$lt_cv_deplibs_check_method
+test -z "$deplibs_check_method" && deplibs_check_method=unknown
 
 
 
-# Check whether --with-gnu-ld was given.
-if test "${with_gnu_ld+set}" = set; then :
-  withval=$with_gnu_ld; test "$withval" = no || with_gnu_ld=yes
-else
-  with_gnu_ld=no
-fi
 
-ac_prog=ld
-if test "$GCC" = yes; then
-  # Check if gcc -print-prog-name=ld gives a path.
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for ld used by $CC" >&5
-$as_echo_n "checking for ld used by $CC... " >&6; }
-  case $host in
-  *-*-mingw*)
-    # gcc leaves a trailing carriage return which upsets mingw
-    ac_prog=`($CC -print-prog-name=ld) 2>&5 | tr -d '\015'` ;;
-  *)
-    ac_prog=`($CC -print-prog-name=ld) 2>&5` ;;
-  esac
-  case $ac_prog in
-    # Accept absolute paths.
-    [\\/]* | ?:[\\/]*)
-      re_direlt='/[^/][^/]*/\.\./'
-      # Canonicalize the pathname of ld
-      ac_prog=`$ECHO "$ac_prog"| $SED 's%\\\\%/%g'`
-      while $ECHO "$ac_prog" | $GREP "$re_direlt" > /dev/null 2>&1; do
-	ac_prog=`$ECHO $ac_prog| $SED "s%$re_direlt%/%"`
-      done
-      test -z "$LD" && LD="$ac_prog"
-      ;;
-  "")
-    # If it fails, then pretend we aren't using GCC.
-    ac_prog=ld
-    ;;
-  *)
-    # If it is relative, then search for the first ld in PATH.
-    with_gnu_ld=unknown
-    ;;
-  esac
-elif test "$with_gnu_ld" = yes; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GNU ld" >&5
-$as_echo_n "checking for GNU ld... " >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for non-GNU ld" >&5
-$as_echo_n "checking for non-GNU ld... " >&6; }
-fi
-if ${lt_cv_path_LD+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -z "$LD"; then
-  lt_save_ifs="$IFS"; IFS=$PATH_SEPARATOR
-  for ac_dir in $PATH; do
-    IFS="$lt_save_ifs"
-    test -z "$ac_dir" && ac_dir=.
-    if test -f "$ac_dir/$ac_prog" || test -f "$ac_dir/$ac_prog$ac_exeext"; then
-      lt_cv_path_LD="$ac_dir/$ac_prog"
-      # Check to see if the program is GNU ld.  I'd rather use --version,
-      # but apparently some variants of GNU ld only accept -v.
-      # Break only if it was the GNU/non-GNU ld that we prefer.
-      case `"$lt_cv_path_LD" -v 2>&1 </dev/null` in
-      *GNU* | *'with BFD'*)
-	test "$with_gnu_ld" != no && break
-	;;
-      *)
-	test "$with_gnu_ld" != yes && break
-	;;
-      esac
-    fi
-  done
-  IFS="$lt_save_ifs"
-else
-  lt_cv_path_LD="$LD" # Let the user override the test with a path.
-fi
-fi
 
-LD="$lt_cv_path_LD"
-if test -n "$LD"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $LD" >&5
-$as_echo "$LD" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-test -z "$LD" && as_fn_error $? "no acceptable ld found in \$PATH" "$LINENO" 5
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking if the linker ($LD) is GNU ld" >&5
-$as_echo_n "checking if the linker ($LD) is GNU ld... " >&6; }
-if ${lt_cv_prog_gnu_ld+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  # I'd rather use --version here, but apparently some GNU lds only accept -v.
-case `$LD -v 2>&1 </dev/null` in
-*GNU* | *'with BFD'*)
-  lt_cv_prog_gnu_ld=yes
-  ;;
-*)
-  lt_cv_prog_gnu_ld=no
-  ;;
-esac
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_prog_gnu_ld" >&5
-$as_echo "$lt_cv_prog_gnu_ld" >&6; }
-with_gnu_ld=$lt_cv_prog_gnu_ld
 
 
 
@@ -5808,76 +5520,24 @@
 
 
 
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for BSD- or MS-compatible name lister (nm)" >&5
-$as_echo_n "checking for BSD- or MS-compatible name lister (nm)... " >&6; }
-if ${lt_cv_path_NM+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -n "$NM"; then
-  # Let the user override the test.
-  lt_cv_path_NM="$NM"
-else
-  lt_nm_to_check="${ac_tool_prefix}nm"
-  if test -n "$ac_tool_prefix" && test "$build" = "$host"; then
-    lt_nm_to_check="$lt_nm_to_check nm"
-  fi
-  for lt_tmp_nm in $lt_nm_to_check; do
-    lt_save_ifs="$IFS"; IFS=$PATH_SEPARATOR
-    for ac_dir in $PATH /usr/ccs/bin/elf /usr/ccs/bin /usr/ucb /bin; do
-      IFS="$lt_save_ifs"
-      test -z "$ac_dir" && ac_dir=.
-      tmp_nm="$ac_dir/$lt_tmp_nm"
-      if test -f "$tmp_nm" || test -f "$tmp_nm$ac_exeext" ; then
-	# Check to see if the nm accepts a BSD-compat flag.
-	# Adding the `sed 1q' prevents false positives on HP-UX, which says:
-	#   nm: unknown option "B" ignored
-	# Tru64's nm complains that /dev/null is an invalid object file
-	case `"$tmp_nm" -B /dev/null 2>&1 | sed '1q'` in
-	*/dev/null* | *'Invalid file or object type'*)
-	  lt_cv_path_NM="$tmp_nm -B"
-	  break
-	  ;;
-	*)
-	  case `"$tmp_nm" -p /dev/null 2>&1 | sed '1q'` in
-	  */dev/null*)
-	    lt_cv_path_NM="$tmp_nm -p"
-	    break
-	    ;;
-	  *)
-	    lt_cv_path_NM=${lt_cv_path_NM="$tmp_nm"} # keep the first match, but
-	    continue # so that we can try to find one that supports BSD flags
-	    ;;
-	  esac
-	  ;;
-	esac
-      fi
-    done
-    IFS="$lt_save_ifs"
-  done
-  : ${lt_cv_path_NM=no}
-fi
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_path_NM" >&5
-$as_echo "$lt_cv_path_NM" >&6; }
-if test "$lt_cv_path_NM" != "no"; then
-  NM="$lt_cv_path_NM"
-else
-  # Didn't find any BSD compatible name lister, look for dumpbin.
-  if test -n "$DUMPBIN"; then :
-    # Let the user override the test.
-  else
-    if test -n "$ac_tool_prefix"; then
-  for ac_prog in dumpbin "link -dump"
-  do
-    # Extract the first word of "$ac_tool_prefix$ac_prog", so it can be a program name with args.
-set dummy $ac_tool_prefix$ac_prog; ac_word=$2
+
+
+
+
+
+
+
+
+if test -n "$ac_tool_prefix"; then
+  # Extract the first word of "${ac_tool_prefix}dlltool", so it can be a program name with args.
+set dummy ${ac_tool_prefix}dlltool; ac_word=$2
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
 $as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_prog_DUMPBIN+:} false; then :
+if ${ac_cv_prog_DLLTOOL+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  if test -n "$DUMPBIN"; then
-  ac_cv_prog_DUMPBIN="$DUMPBIN" # Let the user override the test.
+  if test -n "$DLLTOOL"; then
+  ac_cv_prog_DLLTOOL="$DLLTOOL" # Let the user override the test.
 else
 as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
 for as_dir in $PATH
@@ -5885,8 +5545,8 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_DUMPBIN="$ac_tool_prefix$ac_prog"
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+    ac_cv_prog_DLLTOOL="${ac_tool_prefix}dlltool"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
@@ -5896,32 +5556,28 @@
 
 fi
 fi
-DUMPBIN=$ac_cv_prog_DUMPBIN
-if test -n "$DUMPBIN"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $DUMPBIN" >&5
-$as_echo "$DUMPBIN" >&6; }
+DLLTOOL=$ac_cv_prog_DLLTOOL
+if test -n "$DLLTOOL"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $DLLTOOL" >&5
+$as_echo "$DLLTOOL" >&6; }
 else
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
 $as_echo "no" >&6; }
 fi
 
 
-    test -n "$DUMPBIN" && break
-  done
 fi
-if test -z "$DUMPBIN"; then
-  ac_ct_DUMPBIN=$DUMPBIN
-  for ac_prog in dumpbin "link -dump"
-do
-  # Extract the first word of "$ac_prog", so it can be a program name with args.
-set dummy $ac_prog; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_prog_ac_ct_DUMPBIN+:} false; then :
+if test -z "$ac_cv_prog_DLLTOOL"; then
+  ac_ct_DLLTOOL=$DLLTOOL
+  # Extract the first word of "dlltool", so it can be a program name with args.
+set dummy dlltool; ac_word=$2
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
+if ${ac_cv_prog_ac_ct_DLLTOOL+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  if test -n "$ac_ct_DUMPBIN"; then
-  ac_cv_prog_ac_ct_DUMPBIN="$ac_ct_DUMPBIN" # Let the user override the test.
+  if test -n "$ac_ct_DLLTOOL"; then
+  ac_cv_prog_ac_ct_DLLTOOL="$ac_ct_DLLTOOL" # Let the user override the test.
 else
 as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
 for as_dir in $PATH
@@ -5929,8 +5585,8 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_ac_ct_DUMPBIN="$ac_prog"
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+    ac_cv_prog_ac_ct_DLLTOOL="dlltool"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
@@ -5940,21 +5596,17 @@
 
 fi
 fi
-ac_ct_DUMPBIN=$ac_cv_prog_ac_ct_DUMPBIN
-if test -n "$ac_ct_DUMPBIN"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_ct_DUMPBIN" >&5
-$as_echo "$ac_ct_DUMPBIN" >&6; }
+ac_ct_DLLTOOL=$ac_cv_prog_ac_ct_DLLTOOL
+if test -n "$ac_ct_DLLTOOL"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_ct_DLLTOOL" >&5
+$as_echo "$ac_ct_DLLTOOL" >&6; }
 else
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
 $as_echo "no" >&6; }
 fi
 
-
-  test -n "$ac_ct_DUMPBIN" && break
-done
-
-  if test "x$ac_ct_DUMPBIN" = x; then
-    DUMPBIN=":"
+  if test "x$ac_ct_DLLTOOL" = x; then
+    DLLTOOL="false"
   else
     case $cross_compiling:$ac_tool_warned in
 yes:)
@@ -5962,374 +5614,74 @@
 $as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
 ac_tool_warned=yes ;;
 esac
-    DUMPBIN=$ac_ct_DUMPBIN
-  fi
-fi
-
-    case `$DUMPBIN -symbols /dev/null 2>&1 | sed '1q'` in
-    *COFF*)
-      DUMPBIN="$DUMPBIN -symbols"
-      ;;
-    *)
-      DUMPBIN=:
-      ;;
-    esac
-  fi
-
-  if test "$DUMPBIN" != ":"; then
-    NM="$DUMPBIN"
+    DLLTOOL=$ac_ct_DLLTOOL
   fi
+else
+  DLLTOOL="$ac_cv_prog_DLLTOOL"
 fi
-test -z "$NM" && NM=nm
-
-
-
 
+test -z "$DLLTOOL" && DLLTOOL=dlltool
 
 
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking the name lister ($NM) interface" >&5
-$as_echo_n "checking the name lister ($NM) interface... " >&6; }
-if ${lt_cv_nm_interface+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  lt_cv_nm_interface="BSD nm"
-  echo "int some_variable = 0;" > conftest.$ac_ext
-  (eval echo "\"\$as_me:$LINENO: $ac_compile\"" >&5)
-  (eval "$ac_compile" 2>conftest.err)
-  cat conftest.err >&5
-  (eval echo "\"\$as_me:$LINENO: $NM \\\"conftest.$ac_objext\\\"\"" >&5)
-  (eval "$NM \"conftest.$ac_objext\"" 2>conftest.err > conftest.out)
-  cat conftest.err >&5
-  (eval echo "\"\$as_me:$LINENO: output\"" >&5)
-  cat conftest.out >&5
-  if $GREP 'External.*some_variable' conftest.out > /dev/null; then
-    lt_cv_nm_interface="MS dumpbin"
-  fi
-  rm -f conftest*
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_nm_interface" >&5
-$as_echo "$lt_cv_nm_interface" >&6; }
 
-# find the maximum length of command line arguments
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking the maximum length of command line arguments" >&5
-$as_echo_n "checking the maximum length of command line arguments... " >&6; }
-if ${lt_cv_sys_max_cmd_len+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-    i=0
-  teststring="ABCD"
 
-  case $build_os in
-  msdosdjgpp*)
-    # On DJGPP, this test can blow up pretty badly due to problems in libc
-    # (any single argument exceeding 2000 bytes causes a buffer overrun
-    # during glob expansion).  Even if it were fixed, the result of this
-    # check would be larger than it should be.
-    lt_cv_sys_max_cmd_len=12288;    # 12K is about right
-    ;;
 
-  gnu*)
-    # Under GNU Hurd, this test is not required because there is
-    # no limit to the length of command line arguments.
-    # Libtool will interpret -1 as no limit whatsoever
-    lt_cv_sys_max_cmd_len=-1;
-    ;;
 
-  cygwin* | mingw* | cegcc*)
-    # On Win9x/ME, this test blows up -- it succeeds, but takes
-    # about 5 minutes as the teststring grows exponentially.
-    # Worse, since 9x/ME are not pre-emptively multitasking,
-    # you end up with a "frozen" computer, even though with patience
-    # the test eventually succeeds (with a max line length of 256k).
-    # Instead, let's just punt: use the minimum linelength reported by
-    # all of the supported platforms: 8192 (on NT/2K/XP).
-    lt_cv_sys_max_cmd_len=8192;
-    ;;
 
-  mint*)
-    # On MiNT this can take a long time and run out of memory.
-    lt_cv_sys_max_cmd_len=8192;
-    ;;
 
-  amigaos*)
-    # On AmigaOS with pdksh, this test takes hours, literally.
-    # So we just punt and use a minimum line length of 8192.
-    lt_cv_sys_max_cmd_len=8192;
-    ;;
 
-  netbsd* | freebsd* | openbsd* | darwin* | dragonfly*)
-    # This has been around since 386BSD, at least.  Likely further.
-    if test -x /sbin/sysctl; then
-      lt_cv_sys_max_cmd_len=`/sbin/sysctl -n kern.argmax`
-    elif test -x /usr/sbin/sysctl; then
-      lt_cv_sys_max_cmd_len=`/usr/sbin/sysctl -n kern.argmax`
-    else
-      lt_cv_sys_max_cmd_len=65536	# usable default for all BSDs
-    fi
-    # And add a safety zone
-    lt_cv_sys_max_cmd_len=`expr $lt_cv_sys_max_cmd_len \/ 4`
-    lt_cv_sys_max_cmd_len=`expr $lt_cv_sys_max_cmd_len \* 3`
-    ;;
 
-  interix*)
-    # We know the value 262144 and hardcode it with a safety zone (like BSD)
-    lt_cv_sys_max_cmd_len=196608
-    ;;
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking how to associate runtime and link libraries" >&5
+$as_echo_n "checking how to associate runtime and link libraries... " >&6; }
+if ${lt_cv_sharedlib_from_linklib_cmd+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  lt_cv_sharedlib_from_linklib_cmd='unknown'
 
-  osf*)
-    # Dr. Hans Ekkehard Plesser reports seeing a kernel panic running configure
-    # due to this test when exec_disable_arg_limit is 1 on Tru64. It is not
-    # nice to cause kernel panics so lets avoid the loop below.
-    # First set a reasonable default.
-    lt_cv_sys_max_cmd_len=16384
-    #
-    if test -x /sbin/sysconfig; then
-      case `/sbin/sysconfig -q proc exec_disable_arg_limit` in
-        *1*) lt_cv_sys_max_cmd_len=-1 ;;
-      esac
-    fi
-    ;;
-  sco3.2v5*)
-    lt_cv_sys_max_cmd_len=102400
-    ;;
-  sysv5* | sco5v6* | sysv4.2uw2*)
-    kargmax=`grep ARG_MAX /etc/conf/cf.d/stune 2>/dev/null`
-    if test -n "$kargmax"; then
-      lt_cv_sys_max_cmd_len=`echo $kargmax | sed 's/.*[	 ]//'`
-    else
-      lt_cv_sys_max_cmd_len=32768
-    fi
+case $host_os in
+cygwin* | mingw* | pw32* | cegcc*)
+  # two different shell functions defined in ltmain.sh
+  # decide which to use based on capabilities of $DLLTOOL
+  case `$DLLTOOL --help 2>&1` in
+  *--identify-strict*)
+    lt_cv_sharedlib_from_linklib_cmd=func_cygming_dll_for_implib
     ;;
   *)
-    lt_cv_sys_max_cmd_len=`(getconf ARG_MAX) 2> /dev/null`
-    if test -n "$lt_cv_sys_max_cmd_len"; then
-      lt_cv_sys_max_cmd_len=`expr $lt_cv_sys_max_cmd_len \/ 4`
-      lt_cv_sys_max_cmd_len=`expr $lt_cv_sys_max_cmd_len \* 3`
-    else
-      # Make teststring a little bigger before we do anything with it.
-      # a 1K string should be a reasonable start.
-      for i in 1 2 3 4 5 6 7 8 ; do
-        teststring=$teststring$teststring
-      done
-      SHELL=${SHELL-${CONFIG_SHELL-/bin/sh}}
-      # If test is not a shell built-in, we'll probably end up computing a
-      # maximum length that is only half of the actual maximum length, but
-      # we can't tell.
-      while { test "X"`func_fallback_echo "$teststring$teststring" 2>/dev/null` \
-	         = "X$teststring$teststring"; } >/dev/null 2>&1 &&
-	      test $i != 17 # 1/2 MB should be enough
-      do
-        i=`expr $i + 1`
-        teststring=$teststring$teststring
-      done
-      # Only check the string length outside the loop.
-      lt_cv_sys_max_cmd_len=`expr "X$teststring" : ".*" 2>&1`
-      teststring=
-      # Add a significant safety factor because C++ compilers can tack on
-      # massive amounts of additional arguments before passing them to the
-      # linker.  It appears as though 1/2 is a usable value.
-      lt_cv_sys_max_cmd_len=`expr $lt_cv_sys_max_cmd_len \/ 2`
-    fi
+    lt_cv_sharedlib_from_linklib_cmd=func_cygming_dll_for_implib_fallback
     ;;
   esac
+  ;;
+*)
+  # fallback: assume linklib IS sharedlib
+  lt_cv_sharedlib_from_linklib_cmd="$ECHO"
+  ;;
+esac
 
 fi
-
-if test -n $lt_cv_sys_max_cmd_len ; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_sys_max_cmd_len" >&5
-$as_echo "$lt_cv_sys_max_cmd_len" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: none" >&5
-$as_echo "none" >&6; }
-fi
-max_cmd_len=$lt_cv_sys_max_cmd_len
-
-
-
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_sharedlib_from_linklib_cmd" >&5
+$as_echo "$lt_cv_sharedlib_from_linklib_cmd" >&6; }
+sharedlib_from_linklib_cmd=$lt_cv_sharedlib_from_linklib_cmd
+test -z "$sharedlib_from_linklib_cmd" && sharedlib_from_linklib_cmd=$ECHO
 
 
 
-: ${CP="cp -f"}
-: ${MV="mv -f"}
-: ${RM="rm -f"}
 
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether the shell understands some XSI constructs" >&5
-$as_echo_n "checking whether the shell understands some XSI constructs... " >&6; }
-# Try some XSI features
-xsi_shell=no
-( _lt_dummy="a/b/c"
-  test "${_lt_dummy##*/},${_lt_dummy%/*},${_lt_dummy#??}"${_lt_dummy%"$_lt_dummy"}, \
-      = c,a/b,b/c, \
-    && eval 'test $(( 1 + 1 )) -eq 2 \
-    && test "${#_lt_dummy}" -eq 5' ) >/dev/null 2>&1 \
-  && xsi_shell=yes
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $xsi_shell" >&5
-$as_echo "$xsi_shell" >&6; }
 
 
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether the shell understands \"+=\"" >&5
-$as_echo_n "checking whether the shell understands \"+=\"... " >&6; }
-lt_shell_append=no
-( foo=bar; set foo baz; eval "$1+=\$2" && test "$foo" = barbaz ) \
-    >/dev/null 2>&1 \
-  && lt_shell_append=yes
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_shell_append" >&5
-$as_echo "$lt_shell_append" >&6; }
 
 
-if ( (MAIL=60; unset MAIL) || exit) >/dev/null 2>&1; then
-  lt_unset=unset
+if test -n "$ac_tool_prefix"; then
+  for ac_prog in ar
+  do
+    # Extract the first word of "$ac_tool_prefix$ac_prog", so it can be a program name with args.
+set dummy $ac_tool_prefix$ac_prog; ac_word=$2
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
+if ${ac_cv_prog_AR+:} false; then :
+  $as_echo_n "(cached) " >&6
 else
-  lt_unset=false
-fi
-
-
-
-
-
-# test EBCDIC or ASCII
-case `echo X|tr X '\101'` in
- A) # ASCII based system
-    # \n is not interpreted correctly by Solaris 8 /usr/ucb/tr
-  lt_SP2NL='tr \040 \012'
-  lt_NL2SP='tr \015\012 \040\040'
-  ;;
- *) # EBCDIC based system
-  lt_SP2NL='tr \100 \n'
-  lt_NL2SP='tr \r\n \100\100'
-  ;;
-esac
-
-
-
-
-
-
-
-
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking how to convert $build file names to $host format" >&5
-$as_echo_n "checking how to convert $build file names to $host format... " >&6; }
-if ${lt_cv_to_host_file_cmd+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  case $host in
-  *-*-mingw* )
-    case $build in
-      *-*-mingw* ) # actually msys
-        lt_cv_to_host_file_cmd=func_convert_file_msys_to_w32
-        ;;
-      *-*-cygwin* )
-        lt_cv_to_host_file_cmd=func_convert_file_cygwin_to_w32
-        ;;
-      * ) # otherwise, assume *nix
-        lt_cv_to_host_file_cmd=func_convert_file_nix_to_w32
-        ;;
-    esac
-    ;;
-  *-*-cygwin* )
-    case $build in
-      *-*-mingw* ) # actually msys
-        lt_cv_to_host_file_cmd=func_convert_file_msys_to_cygwin
-        ;;
-      *-*-cygwin* )
-        lt_cv_to_host_file_cmd=func_convert_file_noop
-        ;;
-      * ) # otherwise, assume *nix
-        lt_cv_to_host_file_cmd=func_convert_file_nix_to_cygwin
-        ;;
-    esac
-    ;;
-  * ) # unhandled hosts (and "normal" native builds)
-    lt_cv_to_host_file_cmd=func_convert_file_noop
-    ;;
-esac
-
-fi
-
-to_host_file_cmd=$lt_cv_to_host_file_cmd
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_to_host_file_cmd" >&5
-$as_echo "$lt_cv_to_host_file_cmd" >&6; }
-
-
-
-
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking how to convert $build file names to toolchain format" >&5
-$as_echo_n "checking how to convert $build file names to toolchain format... " >&6; }
-if ${lt_cv_to_tool_file_cmd+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  #assume ordinary cross tools, or native build.
-lt_cv_to_tool_file_cmd=func_convert_file_noop
-case $host in
-  *-*-mingw* )
-    case $build in
-      *-*-mingw* ) # actually msys
-        lt_cv_to_tool_file_cmd=func_convert_file_msys_to_w32
-        ;;
-    esac
-    ;;
-esac
-
-fi
-
-to_tool_file_cmd=$lt_cv_to_tool_file_cmd
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_to_tool_file_cmd" >&5
-$as_echo "$lt_cv_to_tool_file_cmd" >&6; }
-
-
-
-
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $LD option to reload object files" >&5
-$as_echo_n "checking for $LD option to reload object files... " >&6; }
-if ${lt_cv_ld_reload_flag+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  lt_cv_ld_reload_flag='-r'
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_ld_reload_flag" >&5
-$as_echo "$lt_cv_ld_reload_flag" >&6; }
-reload_flag=$lt_cv_ld_reload_flag
-case $reload_flag in
-"" | " "*) ;;
-*) reload_flag=" $reload_flag" ;;
-esac
-reload_cmds='$LD$reload_flag -o $output$reload_objs'
-case $host_os in
-  cygwin* | mingw* | pw32* | cegcc*)
-    if test "$GCC" != yes; then
-      reload_cmds=false
-    fi
-    ;;
-  darwin*)
-    if test "$GCC" = yes; then
-      reload_cmds='$LTCC $LTCFLAGS -nostdlib ${wl}-r -o $output$reload_objs'
-    else
-      reload_cmds='$LD$reload_flag -o $output$reload_objs'
-    fi
-    ;;
-esac
-
-
-
-
-
-
-
-
-
-if test -n "$ac_tool_prefix"; then
-  # Extract the first word of "${ac_tool_prefix}objdump", so it can be a program name with args.
-set dummy ${ac_tool_prefix}objdump; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_prog_OBJDUMP+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -n "$OBJDUMP"; then
-  ac_cv_prog_OBJDUMP="$OBJDUMP" # Let the user override the test.
+  if test -n "$AR"; then
+  ac_cv_prog_AR="$AR" # Let the user override the test.
 else
 as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
 for as_dir in $PATH
@@ -6337,8 +5689,8 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_OBJDUMP="${ac_tool_prefix}objdump"
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+    ac_cv_prog_AR="$ac_tool_prefix$ac_prog"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
@@ -6348,28 +5700,32 @@
 
 fi
 fi
-OBJDUMP=$ac_cv_prog_OBJDUMP
-if test -n "$OBJDUMP"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $OBJDUMP" >&5
-$as_echo "$OBJDUMP" >&6; }
+AR=$ac_cv_prog_AR
+if test -n "$AR"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $AR" >&5
+$as_echo "$AR" >&6; }
 else
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
 $as_echo "no" >&6; }
 fi
 
 
+    test -n "$AR" && break
+  done
 fi
-if test -z "$ac_cv_prog_OBJDUMP"; then
-  ac_ct_OBJDUMP=$OBJDUMP
-  # Extract the first word of "objdump", so it can be a program name with args.
-set dummy objdump; ac_word=$2
+if test -z "$AR"; then
+  ac_ct_AR=$AR
+  for ac_prog in ar
+do
+  # Extract the first word of "$ac_prog", so it can be a program name with args.
+set dummy $ac_prog; ac_word=$2
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
 $as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_prog_ac_ct_OBJDUMP+:} false; then :
+if ${ac_cv_prog_ac_ct_AR+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  if test -n "$ac_ct_OBJDUMP"; then
-  ac_cv_prog_ac_ct_OBJDUMP="$ac_ct_OBJDUMP" # Let the user override the test.
+  if test -n "$ac_ct_AR"; then
+  ac_cv_prog_ac_ct_AR="$ac_ct_AR" # Let the user override the test.
 else
 as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
 for as_dir in $PATH
@@ -6377,8 +5733,8 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_ac_ct_OBJDUMP="objdump"
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+    ac_cv_prog_ac_ct_AR="$ac_prog"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
@@ -6388,17 +5744,21 @@
 
 fi
 fi
-ac_ct_OBJDUMP=$ac_cv_prog_ac_ct_OBJDUMP
-if test -n "$ac_ct_OBJDUMP"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_ct_OBJDUMP" >&5
-$as_echo "$ac_ct_OBJDUMP" >&6; }
+ac_ct_AR=$ac_cv_prog_ac_ct_AR
+if test -n "$ac_ct_AR"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_ct_AR" >&5
+$as_echo "$ac_ct_AR" >&6; }
 else
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
 $as_echo "no" >&6; }
 fi
 
-  if test "x$ac_ct_OBJDUMP" = x; then
-    OBJDUMP="false"
+
+  test -n "$ac_ct_AR" && break
+done
+
+  if test "x$ac_ct_AR" = x; then
+    AR="false"
   else
     case $cross_compiling:$ac_tool_warned in
 yes:)
@@ -6406,14 +5766,12 @@
 $as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
 ac_tool_warned=yes ;;
 esac
-    OBJDUMP=$ac_ct_OBJDUMP
+    AR=$ac_ct_AR
   fi
-else
-  OBJDUMP="$ac_cv_prog_OBJDUMP"
 fi
 
-test -z "$OBJDUMP" && OBJDUMP=objdump
-
+: ${AR=ar}
+: ${AR_FLAGS=cru}
 
 
 
@@ -6422,243 +5780,60 @@
 
 
 
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking how to recognize dependent libraries" >&5
-$as_echo_n "checking how to recognize dependent libraries... " >&6; }
-if ${lt_cv_deplibs_check_method+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  lt_cv_file_magic_cmd='$MAGIC_CMD'
-lt_cv_file_magic_test_file=
-lt_cv_deplibs_check_method='unknown'
-# Need to set the preceding variable on all platforms that support
-# interlibrary dependencies.
-# 'none' -- dependencies not supported.
-# `unknown' -- same as none, but documents that we really don't know.
-# 'pass_all' -- all dependencies passed with no checks.
-# 'test_compile' -- check by making test program.
-# 'file_magic [[regex]]' -- check by looking for files in library path
-# which responds to the $file_magic_cmd with a given extended regex.
-# If you have `file' or equivalent on your system and you're not sure
-# whether `pass_all' will *always* work, you probably want this one.
 
-case $host_os in
-aix[4-9]*)
-  lt_cv_deplibs_check_method=pass_all
-  ;;
 
-beos*)
-  lt_cv_deplibs_check_method=pass_all
-  ;;
 
-bsdi[45]*)
-  lt_cv_deplibs_check_method='file_magic ELF [0-9][0-9]*-bit [ML]SB (shared object|dynamic lib)'
-  lt_cv_file_magic_cmd='/usr/bin/file -L'
-  lt_cv_file_magic_test_file=/shlib/libc.so
-  ;;
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for archiver @FILE support" >&5
+$as_echo_n "checking for archiver @FILE support... " >&6; }
+if ${lt_cv_ar_at_file+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  lt_cv_ar_at_file=no
+   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
 
-cygwin*)
-  # func_win32_libid is a shell function defined in ltmain.sh
-  lt_cv_deplibs_check_method='file_magic ^x86 archive import|^x86 DLL'
-  lt_cv_file_magic_cmd='func_win32_libid'
-  ;;
+int
+main ()
+{
 
-mingw* | pw32*)
-  # Base MSYS/MinGW do not provide the 'file' command needed by
-  # func_win32_libid shell function, so use a weaker test based on 'objdump',
-  # unless we find 'file', for example because we are cross-compiling.
-  # func_win32_libid assumes BSD nm, so disallow it if using MS dumpbin.
-  if ( test "$lt_cv_nm_interface" = "BSD nm" && file / ) >/dev/null 2>&1; then
-    lt_cv_deplibs_check_method='file_magic ^x86 archive import|^x86 DLL'
-    lt_cv_file_magic_cmd='func_win32_libid'
-  else
-    # Keep this pattern in sync with the one in func_win32_libid.
-    lt_cv_deplibs_check_method='file_magic file format (pei*-i386(.*architecture: i386)?|pe-arm-wince|pe-x86-64)'
-    lt_cv_file_magic_cmd='$OBJDUMP -f'
-  fi
-  ;;
-
-cegcc*)
-  # use the weaker test based on 'objdump'. See mingw*.
-  lt_cv_deplibs_check_method='file_magic file format pe-arm-.*little(.*architecture: arm)?'
-  lt_cv_file_magic_cmd='$OBJDUMP -f'
-  ;;
-
-darwin* | rhapsody*)
-  lt_cv_deplibs_check_method=pass_all
-  ;;
-
-freebsd* | dragonfly*)
-  if echo __ELF__ | $CC -E - | $GREP __ELF__ > /dev/null; then
-    case $host_cpu in
-    i*86 )
-      # Not sure whether the presence of OpenBSD here was a mistake.
-      # Let's accept both of them until this is cleared up.
-      lt_cv_deplibs_check_method='file_magic (FreeBSD|OpenBSD|DragonFly)/i[3-9]86 (compact )?demand paged shared library'
-      lt_cv_file_magic_cmd=/usr/bin/file
-      lt_cv_file_magic_test_file=`echo /usr/lib/libc.so.*`
-      ;;
-    esac
-  else
-    lt_cv_deplibs_check_method=pass_all
-  fi
-  ;;
-
-gnu*)
-  lt_cv_deplibs_check_method=pass_all
-  ;;
-
-haiku*)
-  lt_cv_deplibs_check_method=pass_all
-  ;;
-
-hpux10.20* | hpux11*)
-  lt_cv_file_magic_cmd=/usr/bin/file
-  case $host_cpu in
-  ia64*)
-    lt_cv_deplibs_check_method='file_magic (s[0-9][0-9][0-9]|ELF-[0-9][0-9]) shared object file - IA64'
-    lt_cv_file_magic_test_file=/usr/lib/hpux32/libc.so
-    ;;
-  hppa*64*)
-    lt_cv_deplibs_check_method='file_magic (s[0-9][0-9][0-9]|ELF[ -][0-9][0-9])(-bit)?( [LM]SB)? shared object( file)?[, -]* PA-RISC [0-9]\.[0-9]'
-    lt_cv_file_magic_test_file=/usr/lib/pa20_64/libc.sl
-    ;;
-  *)
-    lt_cv_deplibs_check_method='file_magic (s[0-9][0-9][0-9]|PA-RISC[0-9]\.[0-9]) shared library'
-    lt_cv_file_magic_test_file=/usr/lib/libc.sl
-    ;;
-  esac
-  ;;
-
-interix[3-9]*)
-  # PIC code is broken on Interix 3.x, that's why |\.a not |_pic\.a here
-  lt_cv_deplibs_check_method='match_pattern /lib[^/]+(\.so|\.a)$'
-  ;;
-
-irix5* | irix6* | nonstopux*)
-  case $LD in
-  *-32|*"-32 ") libmagic=32-bit;;
-  *-n32|*"-n32 ") libmagic=N32;;
-  *-64|*"-64 ") libmagic=64-bit;;
-  *) libmagic=never-match;;
-  esac
-  lt_cv_deplibs_check_method=pass_all
-  ;;
-
-# This must be Linux ELF.
-linux* | k*bsd*-gnu | kopensolaris*-gnu)
-  lt_cv_deplibs_check_method=pass_all
-  ;;
-
-netbsd*)
-  if echo __ELF__ | $CC -E - | $GREP __ELF__ > /dev/null; then
-    lt_cv_deplibs_check_method='match_pattern /lib[^/]+(\.so\.[0-9]+\.[0-9]+|_pic\.a)$'
-  else
-    lt_cv_deplibs_check_method='match_pattern /lib[^/]+(\.so|_pic\.a)$'
-  fi
-  ;;
-
-newos6*)
-  lt_cv_deplibs_check_method='file_magic ELF [0-9][0-9]*-bit [ML]SB (executable|dynamic lib)'
-  lt_cv_file_magic_cmd=/usr/bin/file
-  lt_cv_file_magic_test_file=/usr/lib/libnls.so
-  ;;
-
-*nto* | *qnx*)
-  lt_cv_deplibs_check_method=pass_all
-  ;;
-
-openbsd*)
-  if test -z "`echo __ELF__ | $CC -E - | $GREP __ELF__`" || test "$host_os-$host_cpu" = "openbsd2.8-powerpc"; then
-    lt_cv_deplibs_check_method='match_pattern /lib[^/]+(\.so\.[0-9]+\.[0-9]+|\.so|_pic\.a)$'
-  else
-    lt_cv_deplibs_check_method='match_pattern /lib[^/]+(\.so\.[0-9]+\.[0-9]+|_pic\.a)$'
-  fi
-  ;;
-
-osf3* | osf4* | osf5*)
-  lt_cv_deplibs_check_method=pass_all
-  ;;
-
-rdos*)
-  lt_cv_deplibs_check_method=pass_all
-  ;;
-
-solaris*)
-  lt_cv_deplibs_check_method=pass_all
-  ;;
-
-sysv5* | sco3.2v5* | sco5v6* | unixware* | OpenUNIX* | sysv4*uw2*)
-  lt_cv_deplibs_check_method=pass_all
-  ;;
-
-sysv4 | sysv4.3*)
-  case $host_vendor in
-  motorola)
-    lt_cv_deplibs_check_method='file_magic ELF [0-9][0-9]*-bit [ML]SB (shared object|dynamic lib) M[0-9][0-9]* Version [0-9]'
-    lt_cv_file_magic_test_file=`echo /usr/lib/libc.so*`
-    ;;
-  ncr)
-    lt_cv_deplibs_check_method=pass_all
-    ;;
-  sequent)
-    lt_cv_file_magic_cmd='/bin/file'
-    lt_cv_deplibs_check_method='file_magic ELF [0-9][0-9]*-bit [LM]SB (shared object|dynamic lib )'
-    ;;
-  sni)
-    lt_cv_file_magic_cmd='/bin/file'
-    lt_cv_deplibs_check_method="file_magic ELF [0-9][0-9]*-bit [LM]SB dynamic lib"
-    lt_cv_file_magic_test_file=/lib/libc.so
-    ;;
-  siemens)
-    lt_cv_deplibs_check_method=pass_all
-    ;;
-  pc)
-    lt_cv_deplibs_check_method=pass_all
-    ;;
-  esac
-  ;;
-
-tpf*)
-  lt_cv_deplibs_check_method=pass_all
-  ;;
-esac
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_compile "$LINENO"; then :
+  echo conftest.$ac_objext > conftest.lst
+      lt_ar_try='$AR $AR_FLAGS libconftest.a @conftest.lst >&5'
+      { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$lt_ar_try\""; } >&5
+  (eval $lt_ar_try) 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }
+      if test "$ac_status" -eq 0; then
+	# Ensure the archiver fails upon bogus file names.
+	rm -f conftest.$ac_objext libconftest.a
+	{ { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$lt_ar_try\""; } >&5
+  (eval $lt_ar_try) 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }
+	if test "$ac_status" -ne 0; then
+          lt_cv_ar_at_file=@
+        fi
+      fi
+      rm -f conftest.* libconftest.a
 
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_deplibs_check_method" >&5
-$as_echo "$lt_cv_deplibs_check_method" >&6; }
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 
-file_magic_glob=
-want_nocaseglob=no
-if test "$build" = "$host"; then
-  case $host_os in
-  mingw* | pw32*)
-    if ( shopt | grep nocaseglob ) >/dev/null 2>&1; then
-      want_nocaseglob=yes
-    else
-      file_magic_glob=`echo aAbBcCdDeEfFgGhHiIjJkKlLmMnNoOpPqQrRsStTuUvVwWxXyYzZ | $SED -e "s/\(..\)/s\/[\1]\/[\1]\/g;/g"`
-    fi
-    ;;
-  esac
 fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_ar_at_file" >&5
+$as_echo "$lt_cv_ar_at_file" >&6; }
 
-file_magic_cmd=$lt_cv_file_magic_cmd
-deplibs_check_method=$lt_cv_deplibs_check_method
-test -z "$deplibs_check_method" && deplibs_check_method=unknown
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
+if test "x$lt_cv_ar_at_file" = xno; then
+  archiver_list_spec=
+else
+  archiver_list_spec=$lt_cv_ar_at_file
+fi
 
 
 
@@ -6667,15 +5842,15 @@
 
 
 if test -n "$ac_tool_prefix"; then
-  # Extract the first word of "${ac_tool_prefix}dlltool", so it can be a program name with args.
-set dummy ${ac_tool_prefix}dlltool; ac_word=$2
+  # Extract the first word of "${ac_tool_prefix}strip", so it can be a program name with args.
+set dummy ${ac_tool_prefix}strip; ac_word=$2
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
 $as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_prog_DLLTOOL+:} false; then :
+if ${ac_cv_prog_STRIP+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  if test -n "$DLLTOOL"; then
-  ac_cv_prog_DLLTOOL="$DLLTOOL" # Let the user override the test.
+  if test -n "$STRIP"; then
+  ac_cv_prog_STRIP="$STRIP" # Let the user override the test.
 else
 as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
 for as_dir in $PATH
@@ -6683,8 +5858,8 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_DLLTOOL="${ac_tool_prefix}dlltool"
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+    ac_cv_prog_STRIP="${ac_tool_prefix}strip"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
@@ -6694,10 +5869,10 @@
 
 fi
 fi
-DLLTOOL=$ac_cv_prog_DLLTOOL
-if test -n "$DLLTOOL"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $DLLTOOL" >&5
-$as_echo "$DLLTOOL" >&6; }
+STRIP=$ac_cv_prog_STRIP
+if test -n "$STRIP"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $STRIP" >&5
+$as_echo "$STRIP" >&6; }
 else
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
 $as_echo "no" >&6; }
@@ -6705,17 +5880,17 @@
 
 
 fi
-if test -z "$ac_cv_prog_DLLTOOL"; then
-  ac_ct_DLLTOOL=$DLLTOOL
-  # Extract the first word of "dlltool", so it can be a program name with args.
-set dummy dlltool; ac_word=$2
+if test -z "$ac_cv_prog_STRIP"; then
+  ac_ct_STRIP=$STRIP
+  # Extract the first word of "strip", so it can be a program name with args.
+set dummy strip; ac_word=$2
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
 $as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_prog_ac_ct_DLLTOOL+:} false; then :
+if ${ac_cv_prog_ac_ct_STRIP+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  if test -n "$ac_ct_DLLTOOL"; then
-  ac_cv_prog_ac_ct_DLLTOOL="$ac_ct_DLLTOOL" # Let the user override the test.
+  if test -n "$ac_ct_STRIP"; then
+  ac_cv_prog_ac_ct_STRIP="$ac_ct_STRIP" # Let the user override the test.
 else
 as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
 for as_dir in $PATH
@@ -6723,8 +5898,8 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_ac_ct_DLLTOOL="dlltool"
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+    ac_cv_prog_ac_ct_STRIP="strip"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
@@ -6734,17 +5909,17 @@
 
 fi
 fi
-ac_ct_DLLTOOL=$ac_cv_prog_ac_ct_DLLTOOL
-if test -n "$ac_ct_DLLTOOL"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_ct_DLLTOOL" >&5
-$as_echo "$ac_ct_DLLTOOL" >&6; }
+ac_ct_STRIP=$ac_cv_prog_ac_ct_STRIP
+if test -n "$ac_ct_STRIP"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_ct_STRIP" >&5
+$as_echo "$ac_ct_STRIP" >&6; }
 else
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
 $as_echo "no" >&6; }
 fi
 
-  if test "x$ac_ct_DLLTOOL" = x; then
-    DLLTOOL="false"
+  if test "x$ac_ct_STRIP" = x; then
+    STRIP=":"
   else
     case $cross_compiling:$ac_tool_warned in
 yes:)
@@ -6752,55 +5927,13 @@
 $as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
 ac_tool_warned=yes ;;
 esac
-    DLLTOOL=$ac_ct_DLLTOOL
+    STRIP=$ac_ct_STRIP
   fi
 else
-  DLLTOOL="$ac_cv_prog_DLLTOOL"
-fi
-
-test -z "$DLLTOOL" && DLLTOOL=dlltool
-
-
-
-
-
-
-
-
-
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking how to associate runtime and link libraries" >&5
-$as_echo_n "checking how to associate runtime and link libraries... " >&6; }
-if ${lt_cv_sharedlib_from_linklib_cmd+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  lt_cv_sharedlib_from_linklib_cmd='unknown'
-
-case $host_os in
-cygwin* | mingw* | pw32* | cegcc*)
-  # two different shell functions defined in ltmain.sh
-  # decide which to use based on capabilities of $DLLTOOL
-  case `$DLLTOOL --help 2>&1` in
-  *--identify-strict*)
-    lt_cv_sharedlib_from_linklib_cmd=func_cygming_dll_for_implib
-    ;;
-  *)
-    lt_cv_sharedlib_from_linklib_cmd=func_cygming_dll_for_implib_fallback
-    ;;
-  esac
-  ;;
-*)
-  # fallback: assume linklib IS sharedlib
-  lt_cv_sharedlib_from_linklib_cmd="$ECHO"
-  ;;
-esac
-
+  STRIP="$ac_cv_prog_STRIP"
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_sharedlib_from_linklib_cmd" >&5
-$as_echo "$lt_cv_sharedlib_from_linklib_cmd" >&6; }
-sharedlib_from_linklib_cmd=$lt_cv_sharedlib_from_linklib_cmd
-test -z "$sharedlib_from_linklib_cmd" && sharedlib_from_linklib_cmd=$ECHO
 
+test -z "$STRIP" && STRIP=:
 
 
 
@@ -6808,17 +5941,15 @@
 
 
 if test -n "$ac_tool_prefix"; then
-  for ac_prog in ar
-  do
-    # Extract the first word of "$ac_tool_prefix$ac_prog", so it can be a program name with args.
-set dummy $ac_tool_prefix$ac_prog; ac_word=$2
+  # Extract the first word of "${ac_tool_prefix}ranlib", so it can be a program name with args.
+set dummy ${ac_tool_prefix}ranlib; ac_word=$2
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
 $as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_prog_AR+:} false; then :
+if ${ac_cv_prog_RANLIB+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  if test -n "$AR"; then
-  ac_cv_prog_AR="$AR" # Let the user override the test.
+  if test -n "$RANLIB"; then
+  ac_cv_prog_RANLIB="$RANLIB" # Let the user override the test.
 else
 as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
 for as_dir in $PATH
@@ -6826,8 +5957,8 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_AR="$ac_tool_prefix$ac_prog"
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+    ac_cv_prog_RANLIB="${ac_tool_prefix}ranlib"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
@@ -6837,32 +5968,28 @@
 
 fi
 fi
-AR=$ac_cv_prog_AR
-if test -n "$AR"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $AR" >&5
-$as_echo "$AR" >&6; }
+RANLIB=$ac_cv_prog_RANLIB
+if test -n "$RANLIB"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $RANLIB" >&5
+$as_echo "$RANLIB" >&6; }
 else
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
 $as_echo "no" >&6; }
 fi
 
 
-    test -n "$AR" && break
-  done
 fi
-if test -z "$AR"; then
-  ac_ct_AR=$AR
-  for ac_prog in ar
-do
-  # Extract the first word of "$ac_prog", so it can be a program name with args.
-set dummy $ac_prog; ac_word=$2
+if test -z "$ac_cv_prog_RANLIB"; then
+  ac_ct_RANLIB=$RANLIB
+  # Extract the first word of "ranlib", so it can be a program name with args.
+set dummy ranlib; ac_word=$2
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
 $as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_prog_ac_ct_AR+:} false; then :
+if ${ac_cv_prog_ac_ct_RANLIB+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  if test -n "$ac_ct_AR"; then
-  ac_cv_prog_ac_ct_AR="$ac_ct_AR" # Let the user override the test.
+  if test -n "$ac_ct_RANLIB"; then
+  ac_cv_prog_ac_ct_RANLIB="$ac_ct_RANLIB" # Let the user override the test.
 else
 as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
 for as_dir in $PATH
@@ -6870,8 +5997,8 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_ac_ct_AR="$ac_prog"
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+    ac_cv_prog_ac_ct_RANLIB="ranlib"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
@@ -6881,21 +6008,17 @@
 
 fi
 fi
-ac_ct_AR=$ac_cv_prog_ac_ct_AR
-if test -n "$ac_ct_AR"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_ct_AR" >&5
-$as_echo "$ac_ct_AR" >&6; }
+ac_ct_RANLIB=$ac_cv_prog_ac_ct_RANLIB
+if test -n "$ac_ct_RANLIB"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_ct_RANLIB" >&5
+$as_echo "$ac_ct_RANLIB" >&6; }
 else
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
 $as_echo "no" >&6; }
 fi
 
-
-  test -n "$ac_ct_AR" && break
-done
-
-  if test "x$ac_ct_AR" = x; then
-    AR="false"
+  if test "x$ac_ct_RANLIB" = x; then
+    RANLIB=":"
   else
     case $cross_compiling:$ac_tool_warned in
 yes:)
@@ -6903,302 +6026,42 @@
 $as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
 ac_tool_warned=yes ;;
 esac
-    AR=$ac_ct_AR
+    RANLIB=$ac_ct_RANLIB
   fi
+else
+  RANLIB="$ac_cv_prog_RANLIB"
 fi
 
-: ${AR=ar}
-: ${AR_FLAGS=cru}
+test -z "$RANLIB" && RANLIB=:
 
 
 
 
 
 
+# Determine commands to create old-style static archives.
+old_archive_cmds='$AR $AR_FLAGS $oldlib$oldobjs'
+old_postinstall_cmds='chmod 644 $oldlib'
+old_postuninstall_cmds=
 
+if test -n "$RANLIB"; then
+  case $host_os in
+  openbsd*)
+    old_postinstall_cmds="$old_postinstall_cmds~\$RANLIB -t \$oldlib"
+    ;;
+  *)
+    old_postinstall_cmds="$old_postinstall_cmds~\$RANLIB \$oldlib"
+    ;;
+  esac
+  old_archive_cmds="$old_archive_cmds~\$RANLIB \$oldlib"
+fi
 
-
-
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for archiver @FILE support" >&5
-$as_echo_n "checking for archiver @FILE support... " >&6; }
-if ${lt_cv_ar_at_file+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  lt_cv_ar_at_file=no
-   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-int
-main ()
-{
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  echo conftest.$ac_objext > conftest.lst
-      lt_ar_try='$AR $AR_FLAGS libconftest.a @conftest.lst >&5'
-      { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$lt_ar_try\""; } >&5
-  (eval $lt_ar_try) 2>&5
-  ac_status=$?
-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; }
-      if test "$ac_status" -eq 0; then
-	# Ensure the archiver fails upon bogus file names.
-	rm -f conftest.$ac_objext libconftest.a
-	{ { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$lt_ar_try\""; } >&5
-  (eval $lt_ar_try) 2>&5
-  ac_status=$?
-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; }
-	if test "$ac_status" -ne 0; then
-          lt_cv_ar_at_file=@
-        fi
-      fi
-      rm -f conftest.* libconftest.a
-
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_ar_at_file" >&5
-$as_echo "$lt_cv_ar_at_file" >&6; }
-
-if test "x$lt_cv_ar_at_file" = xno; then
-  archiver_list_spec=
-else
-  archiver_list_spec=$lt_cv_ar_at_file
-fi
-
-
-
-
-
-
-
-if test -n "$ac_tool_prefix"; then
-  # Extract the first word of "${ac_tool_prefix}strip", so it can be a program name with args.
-set dummy ${ac_tool_prefix}strip; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_prog_STRIP+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -n "$STRIP"; then
-  ac_cv_prog_STRIP="$STRIP" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_STRIP="${ac_tool_prefix}strip"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
-
-fi
-fi
-STRIP=$ac_cv_prog_STRIP
-if test -n "$STRIP"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $STRIP" >&5
-$as_echo "$STRIP" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-
-
-fi
-if test -z "$ac_cv_prog_STRIP"; then
-  ac_ct_STRIP=$STRIP
-  # Extract the first word of "strip", so it can be a program name with args.
-set dummy strip; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_prog_ac_ct_STRIP+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -n "$ac_ct_STRIP"; then
-  ac_cv_prog_ac_ct_STRIP="$ac_ct_STRIP" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_ac_ct_STRIP="strip"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
-
-fi
-fi
-ac_ct_STRIP=$ac_cv_prog_ac_ct_STRIP
-if test -n "$ac_ct_STRIP"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_ct_STRIP" >&5
-$as_echo "$ac_ct_STRIP" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-
-  if test "x$ac_ct_STRIP" = x; then
-    STRIP=":"
-  else
-    case $cross_compiling:$ac_tool_warned in
-yes:)
-{ $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
-$as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
-ac_tool_warned=yes ;;
-esac
-    STRIP=$ac_ct_STRIP
-  fi
-else
-  STRIP="$ac_cv_prog_STRIP"
-fi
-
-test -z "$STRIP" && STRIP=:
-
-
-
-
-
-
-if test -n "$ac_tool_prefix"; then
-  # Extract the first word of "${ac_tool_prefix}ranlib", so it can be a program name with args.
-set dummy ${ac_tool_prefix}ranlib; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_prog_RANLIB+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -n "$RANLIB"; then
-  ac_cv_prog_RANLIB="$RANLIB" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_RANLIB="${ac_tool_prefix}ranlib"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
-
-fi
-fi
-RANLIB=$ac_cv_prog_RANLIB
-if test -n "$RANLIB"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $RANLIB" >&5
-$as_echo "$RANLIB" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-
-
-fi
-if test -z "$ac_cv_prog_RANLIB"; then
-  ac_ct_RANLIB=$RANLIB
-  # Extract the first word of "ranlib", so it can be a program name with args.
-set dummy ranlib; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_prog_ac_ct_RANLIB+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -n "$ac_ct_RANLIB"; then
-  ac_cv_prog_ac_ct_RANLIB="$ac_ct_RANLIB" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_ac_ct_RANLIB="ranlib"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
-
-fi
-fi
-ac_ct_RANLIB=$ac_cv_prog_ac_ct_RANLIB
-if test -n "$ac_ct_RANLIB"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_ct_RANLIB" >&5
-$as_echo "$ac_ct_RANLIB" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-
-  if test "x$ac_ct_RANLIB" = x; then
-    RANLIB=":"
-  else
-    case $cross_compiling:$ac_tool_warned in
-yes:)
-{ $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
-$as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
-ac_tool_warned=yes ;;
-esac
-    RANLIB=$ac_ct_RANLIB
-  fi
-else
-  RANLIB="$ac_cv_prog_RANLIB"
-fi
-
-test -z "$RANLIB" && RANLIB=:
-
-
-
-
-
-
-# Determine commands to create old-style static archives.
-old_archive_cmds='$AR $AR_FLAGS $oldlib$oldobjs'
-old_postinstall_cmds='chmod 644 $oldlib'
-old_postuninstall_cmds=
-
-if test -n "$RANLIB"; then
-  case $host_os in
-  openbsd*)
-    old_postinstall_cmds="$old_postinstall_cmds~\$RANLIB -t \$oldlib"
-    ;;
-  *)
-    old_postinstall_cmds="$old_postinstall_cmds~\$RANLIB \$oldlib"
-    ;;
-  esac
-  old_archive_cmds="$old_archive_cmds~\$RANLIB \$oldlib"
-fi
-
-case $host_os in
-  darwin*)
-    lock_old_archive_extraction=yes ;;
-  *)
-    lock_old_archive_extraction=no ;;
-esac
+case $host_os in
+  darwin*)
+    lock_old_archive_extraction=yes ;;
+  *)
+    lock_old_archive_extraction=no ;;
+esac
 
 
 
@@ -7769,7 +6632,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_MANIFEST_TOOL="${ac_tool_prefix}mt"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -7809,7 +6672,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_MANIFEST_TOOL="mt"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -7889,7 +6752,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_DSYMUTIL="${ac_tool_prefix}dsymutil"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -7929,7 +6792,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_DSYMUTIL="dsymutil"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -7981,7 +6844,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_NMEDIT="${ac_tool_prefix}nmedit"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -8021,7 +6884,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_NMEDIT="nmedit"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -8073,7 +6936,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_LIPO="${ac_tool_prefix}lipo"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -8113,7 +6976,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_LIPO="lipo"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -8165,7 +7028,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_OTOOL="${ac_tool_prefix}otool"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -8205,7 +7068,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_OTOOL="otool"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -8257,7 +7120,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_OTOOL64="${ac_tool_prefix}otool64"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -8297,7 +7160,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_OTOOL64="otool64"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -8769,17 +7632,6 @@
 
 
 
-func_stripname_cnf ()
-{
-  case ${2} in
-  .*) func_stripname_result=`$ECHO "${3}" | $SED "s%^${1}%%; s%\\\\${2}\$%%"`;;
-  *)  func_stripname_result=`$ECHO "${3}" | $SED "s%^${1}%%; s%${2}\$%%"`;;
-  esac
-} # func_stripname_cnf
-
-
-
-
 
 # Set options
 
@@ -12740,538 +11592,246 @@
 
 CC="$lt_save_CC"
 
-      if test -n "$CXX" && ( test "X$CXX" != "Xno" &&
-    ( (test "X$CXX" = "Xg++" && `g++ -v >/dev/null 2>&1` ) ||
-    (test "X$CXX" != "Xg++"))) ; then
-  ac_ext=cpp
-ac_cpp='$CXXCPP $CPPFLAGS'
-ac_compile='$CXX -c $CXXFLAGS $CPPFLAGS conftest.$ac_ext >&5'
-ac_link='$CXX -o conftest$ac_exeext $CXXFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
-ac_compiler_gnu=$ac_cv_cxx_compiler_gnu
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking how to run the C++ preprocessor" >&5
-$as_echo_n "checking how to run the C++ preprocessor... " >&6; }
-if test -z "$CXXCPP"; then
-  if ${ac_cv_prog_CXXCPP+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-      # Double quotes because CXXCPP needs to be expanded
-    for CXXCPP in "$CXX -E" "/lib/cpp"
-    do
-      ac_preproc_ok=false
-for ac_cxx_preproc_warn_flag in '' yes
-do
-  # Use a header file that comes with gcc, so configuring glibc
-  # with a fresh cross-compiler works.
-  # Prefer <limits.h> to <assert.h> if __STDC__ is defined, since
-  # <limits.h> exists even on freestanding compilers.
-  # On the NeXT, cc -E runs the code through the compiler's parser,
-  # not just through cpp. "Syntax error" is here to catch this case.
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#ifdef __STDC__
-# include <limits.h>
-#else
-# include <assert.h>
-#endif
-		     Syntax error
-_ACEOF
-if ac_fn_cxx_try_cpp "$LINENO"; then :
 
-else
-  # Broken: fails on valid input.
-continue
+
+
+
+
+
+
+
+
+
+
+
+        ac_config_commands="$ac_config_commands libtool"
+
+
+
+
+# Only expand once:
+
+
+LIB_VERSION=`expr 7 - 0`.0.3
+LIB_VERSION_INFO="7:3:0"
+
+# Respect empty CFLAGS during compiler tests
+if test "x$CFLAGS" != "x"; then
+  CFLAGS=""
 fi
-rm -f conftest.err conftest.i conftest.$ac_ext
 
-  # OK, works on sane cases.  Now check whether nonexistent headers
-  # can be detected and how.
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <ac_nonexistent.h>
+# Set subsitution values for version stuff in Makefiles and anywhere else,
+# and put LIB_VERSION in config.h
+
+
+
+cat >>confdefs.h <<_ACEOF
+#define LIB_VERSION "$LIB_VERSION"
 _ACEOF
-if ac_fn_cxx_try_cpp "$LINENO"; then :
-  # Broken: success on invalid input.
-continue
-else
-  # Passes both tests.
-ac_preproc_ok=:
-break
-fi
-rm -f conftest.err conftest.i conftest.$ac_ext
 
-done
-# Because of `break', _AC_PREPROC_IFELSE's cleaning code was skipped.
-rm -f conftest.i conftest.err conftest.$ac_ext
-if $ac_preproc_ok; then :
-  break
-fi
 
-    done
-    ac_cv_prog_CXXCPP=$CXXCPP
+# Help line for root directory
 
-fi
-  CXXCPP=$ac_cv_prog_CXXCPP
+# Check whether --with-root-dir was given.
+if test "${with_root_dir+set}" = set; then :
+  withval=$with_root_dir; ROOTDIR=$withval
 else
-  ac_cv_prog_CXXCPP=$CXXCPP
+  ROOTDIR=/
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $CXXCPP" >&5
-$as_echo "$CXXCPP" >&6; }
-ac_preproc_ok=false
-for ac_cxx_preproc_warn_flag in '' yes
-do
-  # Use a header file that comes with gcc, so configuring glibc
-  # with a fresh cross-compiler works.
-  # Prefer <limits.h> to <assert.h> if __STDC__ is defined, since
-  # <limits.h> exists even on freestanding compilers.
-  # On the NeXT, cc -E runs the code through the compiler's parser,
-  # not just through cpp. "Syntax error" is here to catch this case.
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#ifdef __STDC__
-# include <limits.h>
-#else
-# include <assert.h>
-#endif
-		     Syntax error
-_ACEOF
-if ac_fn_cxx_try_cpp "$LINENO"; then :
-
-else
-  # Broken: fails on valid input.
-continue
-fi
-rm -f conftest.err conftest.i conftest.$ac_ext
 
-  # OK, works on sane cases.  Now check whether nonexistent headers
-  # can be detected and how.
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <ac_nonexistent.h>
-_ACEOF
-if ac_fn_cxx_try_cpp "$LINENO"; then :
-  # Broken: success on invalid input.
-continue
-else
-  # Passes both tests.
-ac_preproc_ok=:
-break
-fi
-rm -f conftest.err conftest.i conftest.$ac_ext
 
-done
-# Because of `break', _AC_PREPROC_IFELSE's cleaning code was skipped.
-rm -f conftest.i conftest.err conftest.$ac_ext
-if $ac_preproc_ok; then :
+# Help line for package extension
 
+# Check whether --with-pkg-ext was given.
+if test "${with_pkg_ext+set}" = set; then :
+  withval=$with_pkg_ext; PKGEXT=$withval
 else
-  { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-as_fn_error $? "C++ preprocessor \"$CXXCPP\" fails sanity check
-See \`config.log' for more details" "$LINENO" 5; }
+  PKGEXT=.pkg.tar.gz
 fi
 
-ac_ext=c
-ac_cpp='$CPP $CPPFLAGS'
-ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
-ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
-ac_compiler_gnu=$ac_cv_c_compiler_gnu
 
+# Help line for source package directory
+
+# Check whether --with-src-ext was given.
+if test "${with_src_ext+set}" = set; then :
+  withval=$with_src_ext; SRCEXT=$withval
 else
-  _lt_caught_CXX_error=yes
+  SRCEXT=.src.tar.gz
 fi
 
-ac_ext=cpp
-ac_cpp='$CXXCPP $CPPFLAGS'
-ac_compile='$CXX -c $CXXFLAGS $CPPFLAGS conftest.$ac_ext >&5'
-ac_link='$CXX -o conftest$ac_exeext $CXXFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
-ac_compiler_gnu=$ac_cv_cxx_compiler_gnu
-
-archive_cmds_need_lc_CXX=no
-allow_undefined_flag_CXX=
-always_export_symbols_CXX=no
-archive_expsym_cmds_CXX=
-compiler_needs_object_CXX=no
-export_dynamic_flag_spec_CXX=
-hardcode_direct_CXX=no
-hardcode_direct_absolute_CXX=no
-hardcode_libdir_flag_spec_CXX=
-hardcode_libdir_flag_spec_ld_CXX=
-hardcode_libdir_separator_CXX=
-hardcode_minus_L_CXX=no
-hardcode_shlibpath_var_CXX=unsupported
-hardcode_automatic_CXX=no
-inherit_rpath_CXX=no
-module_cmds_CXX=
-module_expsym_cmds_CXX=
-link_all_deplibs_CXX=unknown
-old_archive_cmds_CXX=$old_archive_cmds
-reload_flag_CXX=$reload_flag
-reload_cmds_CXX=$reload_cmds
-no_undefined_flag_CXX=
-whole_archive_flag_spec_CXX=
-enable_shared_with_static_runtimes_CXX=no
-
-# Source file extension for C++ test sources.
-ac_ext=cpp
-
-# Object file extension for compiled C++ test sources.
-objext=o
-objext_CXX=$objext
-
-# No sense in running all these tests if we already determined that
-# the CXX compiler isn't working.  Some variables (like enable_shared)
-# are currently assumed to apply to all compilers on this platform,
-# and will be corrupted by setting them based on a non-working compiler.
-if test "$_lt_caught_CXX_error" != yes; then
-  # Code to be used in simple compile tests
-  lt_simple_compile_test_code="int some_variable = 0;"
-
-  # Code to be used in simple link tests
-  lt_simple_link_test_code='int main(int, char *[]) { return(0); }'
-
-  # ltmain only uses $CC for tagged configurations so make sure $CC is set.
 
+# Help line for buildscript filename
 
+# Check whether --with-buildscript was given.
+if test "${with_buildscript+set}" = set; then :
+  withval=$with_buildscript; BUILDSCRIPT=$withval
+else
+  BUILDSCRIPT=PKGBUILD
+fi
 
 
+# Help line for changing shell used to run install scriptlets
 
+# Check whether --with-scriptlet-shell was given.
+if test "${with_scriptlet_shell+set}" = set; then :
+  withval=$with_scriptlet_shell; SCRIPTLET_SHELL=$withval
+else
+  SCRIPTLET_SHELL=/bin/sh
+fi
 
-# If no C compiler was specified, use CC.
-LTCC=${LTCC-"$CC"}
-
-# If no C compiler flags were specified, use CFLAGS.
-LTCFLAGS=${LTCFLAGS-"$CFLAGS"}
-
-# Allow CC to be a program name with arguments.
-compiler=$CC
-
-
-  # save warnings/boilerplate of simple test code
-  ac_outfile=conftest.$ac_objext
-echo "$lt_simple_compile_test_code" >conftest.$ac_ext
-eval "$ac_compile" 2>&1 >/dev/null | $SED '/^$/d; /^ *+/d' >conftest.err
-_lt_compiler_boilerplate=`cat conftest.err`
-$RM conftest*
-
-  ac_outfile=conftest.$ac_objext
-echo "$lt_simple_link_test_code" >conftest.$ac_ext
-eval "$ac_link" 2>&1 >/dev/null | $SED '/^$/d; /^ *+/d' >conftest.err
-_lt_linker_boilerplate=`cat conftest.err`
-$RM -r conftest*
 
+# Help line for using OpenSSL
 
-  # Allow CC to be a program name with arguments.
-  lt_save_CC=$CC
-  lt_save_CFLAGS=$CFLAGS
-  lt_save_LD=$LD
-  lt_save_GCC=$GCC
-  GCC=$GXX
-  lt_save_with_gnu_ld=$with_gnu_ld
-  lt_save_path_LD=$lt_cv_path_LD
-  if test -n "${lt_cv_prog_gnu_ldcxx+set}"; then
-    lt_cv_prog_gnu_ld=$lt_cv_prog_gnu_ldcxx
-  else
-    $as_unset lt_cv_prog_gnu_ld
-  fi
-  if test -n "${lt_cv_path_LDCXX+set}"; then
-    lt_cv_path_LD=$lt_cv_path_LDCXX
-  else
-    $as_unset lt_cv_path_LD
-  fi
-  test -z "${LDCXX+set}" || LD=$LDCXX
-  CC=${CXX-"c++"}
-  CFLAGS=$CXXFLAGS
-  compiler=$CC
-  compiler_CXX=$CC
-  for cc_temp in $compiler""; do
-  case $cc_temp in
-    compile | *[\\/]compile | ccache | *[\\/]ccache ) ;;
-    distcc | *[\\/]distcc | purify | *[\\/]purify ) ;;
-    \-*) ;;
-    *) break;;
-  esac
-done
-cc_basename=`$ECHO "$cc_temp" | $SED "s%.*/%%; s%^$host_alias-%%"`
+# Check whether --with-openssl was given.
+if test "${with_openssl+set}" = set; then :
+  withval=$with_openssl;
+else
+  with_openssl=check
+fi
 
 
-  if test -n "$compiler"; then
-    # We don't want -fno-exception when compiling C++ code, so set the
-    # no_builtin_flag separately
-    if test "$GXX" = yes; then
-      lt_prog_compiler_no_builtin_flag_CXX=' -fno-builtin'
-    else
-      lt_prog_compiler_no_builtin_flag_CXX=
-    fi
+# Help line for using gpgme
 
-    if test "$GXX" = yes; then
-      # Set up default GNU C++ configuration
+# Check whether --with-gpgme was given.
+if test "${with_gpgme+set}" = set; then :
+  withval=$with_gpgme;
+else
+  with_gpgme=check
+fi
 
 
+# Help line for using libcurl
 
-# Check whether --with-gnu-ld was given.
-if test "${with_gnu_ld+set}" = set; then :
-  withval=$with_gnu_ld; test "$withval" = no || with_gnu_ld=yes
+# Check whether --with-curl was given.
+if test "${with_curl+set}" = set; then :
+  withval=$with_curl;
 else
-  with_gnu_ld=no
+  with_curl=check
 fi
 
-ac_prog=ld
-if test "$GCC" = yes; then
-  # Check if gcc -print-prog-name=ld gives a path.
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for ld used by $CC" >&5
-$as_echo_n "checking for ld used by $CC... " >&6; }
-  case $host in
-  *-*-mingw*)
-    # gcc leaves a trailing carriage return which upsets mingw
-    ac_prog=`($CC -print-prog-name=ld) 2>&5 | tr -d '\015'` ;;
-  *)
-    ac_prog=`($CC -print-prog-name=ld) 2>&5` ;;
-  esac
-  case $ac_prog in
-    # Accept absolute paths.
-    [\\/]* | ?:[\\/]*)
-      re_direlt='/[^/][^/]*/\.\./'
-      # Canonicalize the pathname of ld
-      ac_prog=`$ECHO "$ac_prog"| $SED 's%\\\\%/%g'`
-      while $ECHO "$ac_prog" | $GREP "$re_direlt" > /dev/null 2>&1; do
-	ac_prog=`$ECHO $ac_prog| $SED "s%$re_direlt%/%"`
-      done
-      test -z "$LD" && LD="$ac_prog"
-      ;;
-  "")
-    # If it fails, then pretend we aren't using GCC.
-    ac_prog=ld
-    ;;
-  *)
-    # If it is relative, then search for the first ld in PATH.
-    with_gnu_ld=unknown
-    ;;
-  esac
-elif test "$with_gnu_ld" = yes; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GNU ld" >&5
-$as_echo_n "checking for GNU ld... " >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for non-GNU ld" >&5
-$as_echo_n "checking for non-GNU ld... " >&6; }
-fi
-if ${lt_cv_path_LD+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -z "$LD"; then
-  lt_save_ifs="$IFS"; IFS=$PATH_SEPARATOR
-  for ac_dir in $PATH; do
-    IFS="$lt_save_ifs"
-    test -z "$ac_dir" && ac_dir=.
-    if test -f "$ac_dir/$ac_prog" || test -f "$ac_dir/$ac_prog$ac_exeext"; then
-      lt_cv_path_LD="$ac_dir/$ac_prog"
-      # Check to see if the program is GNU ld.  I'd rather use --version,
-      # but apparently some variants of GNU ld only accept -v.
-      # Break only if it was the GNU/non-GNU ld that we prefer.
-      case `"$lt_cv_path_LD" -v 2>&1 </dev/null` in
-      *GNU* | *'with BFD'*)
-	test "$with_gnu_ld" != no && break
-	;;
-      *)
-	test "$with_gnu_ld" != yes && break
-	;;
-      esac
-    fi
-  done
-  IFS="$lt_save_ifs"
-else
-  lt_cv_path_LD="$LD" # Let the user override the test with a path.
-fi
-fi
 
-LD="$lt_cv_path_LD"
-if test -n "$LD"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $LD" >&5
-$as_echo "$LD" >&6; }
+# Help line for documentation
+# Check whether --enable-doc was given.
+if test "${enable_doc+set}" = set; then :
+  enableval=$enable_doc; wantdoc=$enableval
 else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
+  wantdoc=yes
 fi
-test -z "$LD" && as_fn_error $? "no acceptable ld found in \$PATH" "$LINENO" 5
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking if the linker ($LD) is GNU ld" >&5
-$as_echo_n "checking if the linker ($LD) is GNU ld... " >&6; }
-if ${lt_cv_prog_gnu_ld+:} false; then :
-  $as_echo_n "(cached) " >&6
+
+
+# Help line for doxygen
+# Check whether --enable-doxygen was given.
+if test "${enable_doxygen+set}" = set; then :
+  enableval=$enable_doxygen; wantdoxygen=$enableval
 else
-  # I'd rather use --version here, but apparently some GNU lds only accept -v.
-case `$LD -v 2>&1 </dev/null` in
-*GNU* | *'with BFD'*)
-  lt_cv_prog_gnu_ld=yes
-  ;;
-*)
-  lt_cv_prog_gnu_ld=no
-  ;;
-esac
+  wantdoxygen=no
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_prog_gnu_ld" >&5
-$as_echo "$lt_cv_prog_gnu_ld" >&6; }
-with_gnu_ld=$lt_cv_prog_gnu_ld
-
 
 
+# Help line for debug
+# Check whether --enable-debug was given.
+if test "${enable_debug+set}" = set; then :
+  enableval=$enable_debug; debug=$enableval
+else
+  debug=no
+fi
 
 
+# Help line for compiler warning flags
+# Check whether --enable-warningflags was given.
+if test "${enable_warningflags+set}" = set; then :
+  enableval=$enable_warningflags; warningflags=$enableval
+else
+  warningflags=no
+fi
 
 
-      # Check if GNU C++ uses GNU ld as the underlying linker, since the
-      # archiving commands below assume that GNU ld is being used.
-      if test "$with_gnu_ld" = yes; then
-        archive_cmds_CXX='$CC $pic_flag -shared -nostdlib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname $wl$soname -o $lib'
-        archive_expsym_cmds_CXX='$CC $pic_flag -shared -nostdlib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname $wl$soname ${wl}-retain-symbols-file $wl$export_symbols -o $lib'
-
-        hardcode_libdir_flag_spec_CXX='${wl}-rpath ${wl}$libdir'
-        export_dynamic_flag_spec_CXX='${wl}--export-dynamic'
-
-        # If archive_cmds runs LD, not CC, wlarc should be empty
-        # XXX I think wlarc can be eliminated in ltcf-cxx, but I need to
-        #     investigate it a little bit more. (MM)
-        wlarc='${wl}'
-
-        # ancient GNU ld didn't support --whole-archive et. al.
-        if eval "`$CC -print-prog-name=ld` --help 2>&1" |
-	  $GREP 'no-whole-archive' > /dev/null; then
-          whole_archive_flag_spec_CXX="$wlarc"'--whole-archive$convenience '"$wlarc"'--no-whole-archive'
-        else
-          whole_archive_flag_spec_CXX=
-        fi
-      else
-        with_gnu_ld=no
-        wlarc=
+# Help line for using git version in pacman version string
+# Check whether --enable-git-version was given.
+if test "${enable_git_version+set}" = set; then :
+  enableval=$enable_git_version; wantgitver=$enableval
+else
+  wantgitver=no
+fi
 
-        # A generic and very simple default shared library creation
-        # command for GNU C++ for the case where it uses the native
-        # linker, instead of GNU ld.  If possible, this setting should
-        # overridden to take advantage of the native linker features on
-        # the platform it is being used on.
-        archive_cmds_CXX='$CC -shared -nostdlib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags -o $lib'
-      fi
 
-      # Commands to make compiler produce verbose output that lists
-      # what "hidden" libraries, object files and flags are used when
-      # linking a shared library.
-      output_verbose_link_cmd='$CC -shared $CFLAGS -v conftest.$objext 2>&1 | $GREP -v "^Configured with:" | $GREP "\-L"'
+# Enable large file support if available (must be enabled before
+# testing compilation against gpgme).
+# Check whether --enable-largefile was given.
+if test "${enable_largefile+set}" = set; then :
+  enableval=$enable_largefile;
+fi
 
-    else
-      GXX=no
-      with_gnu_ld=no
-      wlarc=
-    fi
+if test "$enable_largefile" != no; then
 
-    # PORTME: fill in a description of your system's C++ link characteristics
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether the $compiler linker ($LD) supports shared libraries" >&5
-$as_echo_n "checking whether the $compiler linker ($LD) supports shared libraries... " >&6; }
-    ld_shlibs_CXX=yes
-    case $host_os in
-      aix3*)
-        # FIXME: insert proper C++ library support
-        ld_shlibs_CXX=no
-        ;;
-      aix[4-9]*)
-        if test "$host_cpu" = ia64; then
-          # On IA64, the linker does run time linking by default, so we don't
-          # have to do anything special.
-          aix_use_runtimelinking=no
-          exp_sym_flag='-Bexport'
-          no_entry_flag=""
-        else
-          aix_use_runtimelinking=no
-
-          # Test if we are trying to use run time linking or normal
-          # AIX style linking. If -brtl is somewhere in LDFLAGS, we
-          # need to do runtime linking.
-          case $host_os in aix4.[23]|aix4.[23].*|aix[5-9]*)
-	    for ld_flag in $LDFLAGS; do
-	      case $ld_flag in
-	      *-brtl*)
-	        aix_use_runtimelinking=yes
-	        break
-	        ;;
-	      esac
-	    done
-	    ;;
-          esac
-
-          exp_sym_flag='-bexport'
-          no_entry_flag='-bnoentry'
-        fi
+  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for special C compiler options needed for large files" >&5
+$as_echo_n "checking for special C compiler options needed for large files... " >&6; }
+if ${ac_cv_sys_largefile_CC+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  ac_cv_sys_largefile_CC=no
+     if test "$GCC" != yes; then
+       ac_save_CC=$CC
+       while :; do
+	 # IRIX 6.2 and later do not support large files by default,
+	 # so use the C compiler's -n32 option if that helps.
+	 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+#include <sys/types.h>
+ /* Check that off_t can represent 2**63 - 1 correctly.
+    We can't simply define LARGE_OFF_T to be 9223372036854775807,
+    since some C++ compilers masquerading as C compilers
+    incorrectly reject 9223372036854775807.  */
+#define LARGE_OFF_T (((off_t) 1 << 62) - 1 + ((off_t) 1 << 62))
+  int off_t_is_large[(LARGE_OFF_T % 2147483629 == 721
+		       && LARGE_OFF_T % 2147483647 == 1)
+		      ? 1 : -1];
+int
+main ()
+{
 
-        # When large executables or shared objects are built, AIX ld can
-        # have problems creating the table of contents.  If linking a library
-        # or program results in "error TOC overflow" add -mminimal-toc to
-        # CXXFLAGS/CFLAGS for g++/gcc.  In the cases where that is not
-        # enough to fix the problem, add -Wl,-bbigtoc to LDFLAGS.
-
-        archive_cmds_CXX=''
-        hardcode_direct_CXX=yes
-        hardcode_direct_absolute_CXX=yes
-        hardcode_libdir_separator_CXX=':'
-        link_all_deplibs_CXX=yes
-        file_list_spec_CXX='${wl}-f,'
-
-        if test "$GXX" = yes; then
-          case $host_os in aix4.[012]|aix4.[012].*)
-          # We only want to do this on AIX 4.2 and lower, the check
-          # below for broken collect2 doesn't work under 4.3+
-	  collect2name=`${CC} -print-prog-name=collect2`
-	  if test -f "$collect2name" &&
-	     strings "$collect2name" | $GREP resolve_lib_name >/dev/null
-	  then
-	    # We have reworked collect2
-	    :
-	  else
-	    # We have old collect2
-	    hardcode_direct_CXX=unsupported
-	    # It fails to find uninstalled libraries when the uninstalled
-	    # path is not listed in the libpath.  Setting hardcode_minus_L
-	    # to unsupported forces relinking
-	    hardcode_minus_L_CXX=yes
-	    hardcode_libdir_flag_spec_CXX='-L$libdir'
-	    hardcode_libdir_separator_CXX=
-	  fi
-          esac
-          shared_flag='-shared'
-	  if test "$aix_use_runtimelinking" = yes; then
-	    shared_flag="$shared_flag "'${wl}-G'
-	  fi
-        else
-          # not using gcc
-          if test "$host_cpu" = ia64; then
-	  # VisualAge C++, Version 5.5 for AIX 5L for IA-64, Beta 3 Release
-	  # chokes on -Wl,-G. The following line is correct:
-	  shared_flag='-G'
-          else
-	    if test "$aix_use_runtimelinking" = yes; then
-	      shared_flag='${wl}-G'
-	    else
-	      shared_flag='${wl}-bM:SRE'
-	    fi
-          fi
-        fi
+  ;
+  return 0;
+}
+_ACEOF
+	 if ac_fn_c_try_compile "$LINENO"; then :
+  break
+fi
+rm -f core conftest.err conftest.$ac_objext
+	 CC="$CC -n32"
+	 if ac_fn_c_try_compile "$LINENO"; then :
+  ac_cv_sys_largefile_CC=' -n32'; break
+fi
+rm -f core conftest.err conftest.$ac_objext
+	 break
+       done
+       CC=$ac_save_CC
+       rm -f conftest.$ac_ext
+    fi
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_sys_largefile_CC" >&5
+$as_echo "$ac_cv_sys_largefile_CC" >&6; }
+  if test "$ac_cv_sys_largefile_CC" != no; then
+    CC=$CC$ac_cv_sys_largefile_CC
+  fi
 
-        export_dynamic_flag_spec_CXX='${wl}-bexpall'
-        # It seems that -bexpall does not export symbols beginning with
-        # underscore (_), so it is better to generate a list of symbols to
-	# export.
-        always_export_symbols_CXX=yes
-        if test "$aix_use_runtimelinking" = yes; then
-          # Warning - without using the other runtime loading flags (-brtl),
-          # -berok will link without error, but may produce a broken library.
-          allow_undefined_flag_CXX='-berok'
-          # Determine the default libpath from the value encoded in an empty
-          # executable.
-          if test "${lt_cv_aix_libpath+set}" = set; then
-  aix_libpath=$lt_cv_aix_libpath
-else
-  if ${lt_cv_aix_libpath__CXX+:} false; then :
+  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for _FILE_OFFSET_BITS value needed for large files" >&5
+$as_echo_n "checking for _FILE_OFFSET_BITS value needed for large files... " >&6; }
+if ${ac_cv_sys_file_offset_bits+:} false; then :
   $as_echo_n "(cached) " >&6
 else
+  while :; do
   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
-
+#include <sys/types.h>
+ /* Check that off_t can represent 2**63 - 1 correctly.
+    We can't simply define LARGE_OFF_T to be 9223372036854775807,
+    since some C++ compilers masquerading as C compilers
+    incorrectly reject 9223372036854775807.  */
+#define LARGE_OFF_T (((off_t) 1 << 62) - 1 + ((off_t) 1 << 62))
+  int off_t_is_large[(LARGE_OFF_T % 2147483629 == 721
+		       && LARGE_OFF_T % 2147483647 == 1)
+		      ? 1 : -1];
 int
 main ()
 {
@@ -13280,52 +11840,67 @@
   return 0;
 }
 _ACEOF
-if ac_fn_cxx_try_link "$LINENO"; then :
-
-  lt_aix_libpath_sed='
-      /Import File Strings/,/^$/ {
-	  /^0/ {
-	      s/^0  *\([^ ]*\) *$/\1/
-	      p
-	  }
-      }'
-  lt_cv_aix_libpath__CXX=`dump -H conftest$ac_exeext 2>/dev/null | $SED -n -e "$lt_aix_libpath_sed"`
-  # Check for a 64-bit object if we didn't find anything.
-  if test -z "$lt_cv_aix_libpath__CXX"; then
-    lt_cv_aix_libpath__CXX=`dump -HX64 conftest$ac_exeext 2>/dev/null | $SED -n -e "$lt_aix_libpath_sed"`
-  fi
+if ac_fn_c_try_compile "$LINENO"; then :
+  ac_cv_sys_file_offset_bits=no; break
 fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-  if test -z "$lt_cv_aix_libpath__CXX"; then
-    lt_cv_aix_libpath__CXX="/usr/lib:/lib"
-  fi
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+#define _FILE_OFFSET_BITS 64
+#include <sys/types.h>
+ /* Check that off_t can represent 2**63 - 1 correctly.
+    We can't simply define LARGE_OFF_T to be 9223372036854775807,
+    since some C++ compilers masquerading as C compilers
+    incorrectly reject 9223372036854775807.  */
+#define LARGE_OFF_T (((off_t) 1 << 62) - 1 + ((off_t) 1 << 62))
+  int off_t_is_large[(LARGE_OFF_T % 2147483629 == 721
+		       && LARGE_OFF_T % 2147483647 == 1)
+		      ? 1 : -1];
+int
+main ()
+{
 
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_compile "$LINENO"; then :
+  ac_cv_sys_file_offset_bits=64; break
 fi
-
-  aix_libpath=$lt_cv_aix_libpath__CXX
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+  ac_cv_sys_file_offset_bits=unknown
+  break
+done
 fi
-
-          hardcode_libdir_flag_spec_CXX='${wl}-blibpath:$libdir:'"$aix_libpath"
-
-          archive_expsym_cmds_CXX='$CC -o $output_objdir/$soname $libobjs $deplibs '"\${wl}$no_entry_flag"' $compiler_flags `if test "x${allow_undefined_flag}" != "x"; then func_echo_all "${wl}${allow_undefined_flag}"; else :; fi` '"\${wl}$exp_sym_flag:\$export_symbols $shared_flag"
-        else
-          if test "$host_cpu" = ia64; then
-	    hardcode_libdir_flag_spec_CXX='${wl}-R $libdir:/usr/lib:/lib'
-	    allow_undefined_flag_CXX="-z nodefs"
-	    archive_expsym_cmds_CXX="\$CC $shared_flag"' -o $output_objdir/$soname $libobjs $deplibs '"\${wl}$no_entry_flag"' $compiler_flags ${wl}${allow_undefined_flag} '"\${wl}$exp_sym_flag:\$export_symbols"
-          else
-	    # Determine the default libpath from the value encoded in an
-	    # empty executable.
-	    if test "${lt_cv_aix_libpath+set}" = set; then
-  aix_libpath=$lt_cv_aix_libpath
-else
-  if ${lt_cv_aix_libpath__CXX+:} false; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_sys_file_offset_bits" >&5
+$as_echo "$ac_cv_sys_file_offset_bits" >&6; }
+case $ac_cv_sys_file_offset_bits in #(
+  no | unknown) ;;
+  *)
+cat >>confdefs.h <<_ACEOF
+#define _FILE_OFFSET_BITS $ac_cv_sys_file_offset_bits
+_ACEOF
+;;
+esac
+rm -rf conftest*
+  if test $ac_cv_sys_file_offset_bits = unknown; then
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking for _LARGE_FILES value needed for large files" >&5
+$as_echo_n "checking for _LARGE_FILES value needed for large files... " >&6; }
+if ${ac_cv_sys_large_files+:} false; then :
   $as_echo_n "(cached) " >&6
 else
+  while :; do
   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
-
+#include <sys/types.h>
+ /* Check that off_t can represent 2**63 - 1 correctly.
+    We can't simply define LARGE_OFF_T to be 9223372036854775807,
+    since some C++ compilers masquerading as C compilers
+    incorrectly reject 9223372036854775807.  */
+#define LARGE_OFF_T (((off_t) 1 << 62) - 1 + ((off_t) 1 << 62))
+  int off_t_is_large[(LARGE_OFF_T % 2147483629 == 721
+		       && LARGE_OFF_T % 2147483647 == 1)
+		      ? 1 : -1];
 int
 main ()
 {
@@ -13334,1751 +11909,914 @@
   return 0;
 }
 _ACEOF
-if ac_fn_cxx_try_link "$LINENO"; then :
+if ac_fn_c_try_compile "$LINENO"; then :
+  ac_cv_sys_large_files=no; break
+fi
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+#define _LARGE_FILES 1
+#include <sys/types.h>
+ /* Check that off_t can represent 2**63 - 1 correctly.
+    We can't simply define LARGE_OFF_T to be 9223372036854775807,
+    since some C++ compilers masquerading as C compilers
+    incorrectly reject 9223372036854775807.  */
+#define LARGE_OFF_T (((off_t) 1 << 62) - 1 + ((off_t) 1 << 62))
+  int off_t_is_large[(LARGE_OFF_T % 2147483629 == 721
+		       && LARGE_OFF_T % 2147483647 == 1)
+		      ? 1 : -1];
+int
+main ()
+{
 
-  lt_aix_libpath_sed='
-      /Import File Strings/,/^$/ {
-	  /^0/ {
-	      s/^0  *\([^ ]*\) *$/\1/
-	      p
-	  }
-      }'
-  lt_cv_aix_libpath__CXX=`dump -H conftest$ac_exeext 2>/dev/null | $SED -n -e "$lt_aix_libpath_sed"`
-  # Check for a 64-bit object if we didn't find anything.
-  if test -z "$lt_cv_aix_libpath__CXX"; then
-    lt_cv_aix_libpath__CXX=`dump -HX64 conftest$ac_exeext 2>/dev/null | $SED -n -e "$lt_aix_libpath_sed"`
-  fi
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_compile "$LINENO"; then :
+  ac_cv_sys_large_files=1; break
 fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-  if test -z "$lt_cv_aix_libpath__CXX"; then
-    lt_cv_aix_libpath__CXX="/usr/lib:/lib"
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+  ac_cv_sys_large_files=unknown
+  break
+done
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_sys_large_files" >&5
+$as_echo "$ac_cv_sys_large_files" >&6; }
+case $ac_cv_sys_large_files in #(
+  no | unknown) ;;
+  *)
+cat >>confdefs.h <<_ACEOF
+#define _LARGE_FILES $ac_cv_sys_large_files
+_ACEOF
+;;
+esac
+rm -rf conftest*
   fi
 
-fi
 
-  aix_libpath=$lt_cv_aix_libpath__CXX
 fi
 
-	    hardcode_libdir_flag_spec_CXX='${wl}-blibpath:$libdir:'"$aix_libpath"
-	    # Warning - without using the other run time loading flags,
-	    # -berok will link without error, but may produce a broken library.
-	    no_undefined_flag_CXX=' ${wl}-bernotok'
-	    allow_undefined_flag_CXX=' ${wl}-berok'
-	    if test "$with_gnu_ld" = yes; then
-	      # We only use this code for GNU lds that support --whole-archive.
-	      whole_archive_flag_spec_CXX='${wl}--whole-archive$convenience ${wl}--no-whole-archive'
-	    else
-	      # Exported symbols can be pulled into shared objects from archives
-	      whole_archive_flag_spec_CXX='$convenience'
-	    fi
-	    archive_cmds_need_lc_CXX=yes
-	    # This is similar to how AIX traditionally builds its shared
-	    # libraries.
-	    archive_expsym_cmds_CXX="\$CC $shared_flag"' -o $output_objdir/$soname $libobjs $deplibs ${wl}-bnoentry $compiler_flags ${wl}-bE:$export_symbols${allow_undefined_flag}~$AR $AR_FLAGS $output_objdir/$libname$release.a $output_objdir/$soname'
-          fi
-        fi
-        ;;
-
-      beos*)
-	if $LD --help 2>&1 | $GREP ': supported targets:.* elf' > /dev/null; then
-	  allow_undefined_flag_CXX=unsupported
-	  # Joseph Beckenbach <jrb3@best.com> says some releases of gcc
-	  # support --undefined.  This deserves some investigation.  FIXME
-	  archive_cmds_CXX='$CC -nostart $libobjs $deplibs $compiler_flags ${wl}-soname $wl$soname -o $lib'
-	else
-	  ld_shlibs_CXX=no
-	fi
-	;;
 
-      chorus*)
-        case $cc_basename in
-          *)
-	  # FIXME: insert proper C++ library support
-	  ld_shlibs_CXX=no
-	  ;;
-        esac
-        ;;
+# Checks for programs.
+for ac_prog in gawk mawk nawk awk
+do
+  # Extract the first word of "$ac_prog", so it can be a program name with args.
+set dummy $ac_prog; ac_word=$2
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
+if ${ac_cv_prog_AWK+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  if test -n "$AWK"; then
+  ac_cv_prog_AWK="$AWK" # Let the user override the test.
+else
+as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+for as_dir in $PATH
+do
+  IFS=$as_save_IFS
+  test -z "$as_dir" && as_dir=.
+    for ac_exec_ext in '' $ac_executable_extensions; do
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+    ac_cv_prog_AWK="$ac_prog"
+    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+    break 2
+  fi
+done
+  done
+IFS=$as_save_IFS
 
-      cygwin* | mingw* | pw32* | cegcc*)
-	case $GXX,$cc_basename in
-	,cl* | no,cl*)
-	  # Native MSVC
-	  # hardcode_libdir_flag_spec is actually meaningless, as there is
-	  # no search path for DLLs.
-	  hardcode_libdir_flag_spec_CXX=' '
-	  allow_undefined_flag_CXX=unsupported
-	  always_export_symbols_CXX=yes
-	  file_list_spec_CXX='@'
-	  # Tell ltmain to make .lib files, not .a files.
-	  libext=lib
-	  # Tell ltmain to make .dll files, not .so files.
-	  shrext_cmds=".dll"
-	  # FIXME: Setting linknames here is a bad hack.
-	  archive_cmds_CXX='$CC -o $output_objdir/$soname $libobjs $compiler_flags $deplibs -Wl,-dll~linknames='
-	  archive_expsym_cmds_CXX='if test "x`$SED 1q $export_symbols`" = xEXPORTS; then
-	      $SED -n -e 's/\\\\\\\(.*\\\\\\\)/-link\\\ -EXPORT:\\\\\\\1/' -e '1\\\!p' < $export_symbols > $output_objdir/$soname.exp;
-	    else
-	      $SED -e 's/\\\\\\\(.*\\\\\\\)/-link\\\ -EXPORT:\\\\\\\1/' < $export_symbols > $output_objdir/$soname.exp;
-	    fi~
-	    $CC -o $tool_output_objdir$soname $libobjs $compiler_flags $deplibs "@$tool_output_objdir$soname.exp" -Wl,-DLL,-IMPLIB:"$tool_output_objdir$libname.dll.lib"~
-	    linknames='
-	  # The linker will not automatically build a static lib if we build a DLL.
-	  # _LT_TAGVAR(old_archive_from_new_cmds, CXX)='true'
-	  enable_shared_with_static_runtimes_CXX=yes
-	  # Don't use ranlib
-	  old_postinstall_cmds_CXX='chmod 644 $oldlib'
-	  postlink_cmds_CXX='lt_outputfile="@OUTPUT@"~
-	    lt_tool_outputfile="@TOOL_OUTPUT@"~
-	    case $lt_outputfile in
-	      *.exe|*.EXE) ;;
-	      *)
-		lt_outputfile="$lt_outputfile.exe"
-		lt_tool_outputfile="$lt_tool_outputfile.exe"
-		;;
-	    esac~
-	    func_to_tool_file "$lt_outputfile"~
-	    if test "$MANIFEST_TOOL" != ":" && test -f "$lt_outputfile.manifest"; then
-	      $MANIFEST_TOOL -manifest "$lt_tool_outputfile.manifest" -outputresource:"$lt_tool_outputfile" || exit 1;
-	      $RM "$lt_outputfile.manifest";
-	    fi'
-	  ;;
-	*)
-	  # g++
-	  # _LT_TAGVAR(hardcode_libdir_flag_spec, CXX) is actually meaningless,
-	  # as there is no search path for DLLs.
-	  hardcode_libdir_flag_spec_CXX='-L$libdir'
-	  export_dynamic_flag_spec_CXX='${wl}--export-all-symbols'
-	  allow_undefined_flag_CXX=unsupported
-	  always_export_symbols_CXX=no
-	  enable_shared_with_static_runtimes_CXX=yes
-
-	  if $LD --help 2>&1 | $GREP 'auto-import' > /dev/null; then
-	    archive_cmds_CXX='$CC -shared -nostdlib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags -o $output_objdir/$soname ${wl}--enable-auto-image-base -Xlinker --out-implib -Xlinker $lib'
-	    # If the export-symbols file already is a .def file (1st line
-	    # is EXPORTS), use it as is; otherwise, prepend...
-	    archive_expsym_cmds_CXX='if test "x`$SED 1q $export_symbols`" = xEXPORTS; then
-	      cp $export_symbols $output_objdir/$soname.def;
-	    else
-	      echo EXPORTS > $output_objdir/$soname.def;
-	      cat $export_symbols >> $output_objdir/$soname.def;
-	    fi~
-	    $CC -shared -nostdlib $output_objdir/$soname.def $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags -o $output_objdir/$soname ${wl}--enable-auto-image-base -Xlinker --out-implib -Xlinker $lib'
-	  else
-	    ld_shlibs_CXX=no
-	  fi
-	  ;;
-	esac
-	;;
-      darwin* | rhapsody*)
+fi
+fi
+AWK=$ac_cv_prog_AWK
+if test -n "$AWK"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $AWK" >&5
+$as_echo "$AWK" >&6; }
+else
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
+fi
 
 
-  archive_cmds_need_lc_CXX=no
-  hardcode_direct_CXX=no
-  hardcode_automatic_CXX=yes
-  hardcode_shlibpath_var_CXX=unsupported
-  if test "$lt_cv_ld_force_load" = "yes"; then
-    whole_archive_flag_spec_CXX='`for conv in $convenience\"\"; do test  -n \"$conv\" && new_convenience=\"$new_convenience ${wl}-force_load,$conv\"; done; func_echo_all \"$new_convenience\"`'
-  else
-    whole_archive_flag_spec_CXX=''
-  fi
-  link_all_deplibs_CXX=yes
-  allow_undefined_flag_CXX="$_lt_dar_allow_undefined"
-  case $cc_basename in
-     ifort*) _lt_dar_can_shared=yes ;;
-     *) _lt_dar_can_shared=$GCC ;;
-  esac
-  if test "$_lt_dar_can_shared" = "yes"; then
-    output_verbose_link_cmd=func_echo_all
-    archive_cmds_CXX="\$CC -dynamiclib \$allow_undefined_flag -o \$lib \$libobjs \$deplibs \$compiler_flags -install_name \$rpath/\$soname \$verstring $_lt_dar_single_mod${_lt_dsymutil}"
-    module_cmds_CXX="\$CC \$allow_undefined_flag -o \$lib -bundle \$libobjs \$deplibs \$compiler_flags${_lt_dsymutil}"
-    archive_expsym_cmds_CXX="sed 's,^,_,' < \$export_symbols > \$output_objdir/\${libname}-symbols.expsym~\$CC -dynamiclib \$allow_undefined_flag -o \$lib \$libobjs \$deplibs \$compiler_flags -install_name \$rpath/\$soname \$verstring ${_lt_dar_single_mod}${_lt_dar_export_syms}${_lt_dsymutil}"
-    module_expsym_cmds_CXX="sed -e 's,^,_,' < \$export_symbols > \$output_objdir/\${libname}-symbols.expsym~\$CC \$allow_undefined_flag -o \$lib -bundle \$libobjs \$deplibs \$compiler_flags${_lt_dar_export_syms}${_lt_dsymutil}"
-       if test "$lt_cv_apple_cc_single_mod" != "yes"; then
-      archive_cmds_CXX="\$CC -r -keep_private_externs -nostdlib -o \${lib}-master.o \$libobjs~\$CC -dynamiclib \$allow_undefined_flag -o \$lib \${lib}-master.o \$deplibs \$compiler_flags -install_name \$rpath/\$soname \$verstring${_lt_dsymutil}"
-      archive_expsym_cmds_CXX="sed 's,^,_,' < \$export_symbols > \$output_objdir/\${libname}-symbols.expsym~\$CC -r -keep_private_externs -nostdlib -o \${lib}-master.o \$libobjs~\$CC -dynamiclib \$allow_undefined_flag -o \$lib \${lib}-master.o \$deplibs \$compiler_flags -install_name \$rpath/\$soname \$verstring${_lt_dar_export_syms}${_lt_dsymutil}"
-    fi
+  test -n "$AWK" && break
+done
 
-  else
-  ld_shlibs_CXX=no
-  fi
+   { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $CC option to accept ISO C99" >&5
+$as_echo_n "checking for $CC option to accept ISO C99... " >&6; }
+if ${ac_cv_prog_cc_c99+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  ac_cv_prog_cc_c99=no
+ac_save_CC=$CC
+cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+#include <stdarg.h>
+#include <stdbool.h>
+#include <stdlib.h>
+#include <wchar.h>
+#include <stdio.h>
 
-	;;
+// Check varargs macros.  These examples are taken from C99 6.10.3.5.
+#define debug(...) fprintf (stderr, __VA_ARGS__)
+#define showlist(...) puts (#__VA_ARGS__)
+#define report(test,...) ((test) ? puts (#test) : printf (__VA_ARGS__))
+static void
+test_varargs_macros (void)
+{
+  int x = 1234;
+  int y = 5678;
+  debug ("Flag");
+  debug ("X = %d\n", x);
+  showlist (The first, second, and third items.);
+  report (x>y, "x is %d but y is %d", x, y);
+}
 
-      dgux*)
-        case $cc_basename in
-          ec++*)
-	    # FIXME: insert proper C++ library support
-	    ld_shlibs_CXX=no
-	    ;;
-          ghcx*)
-	    # Green Hills C++ Compiler
-	    # FIXME: insert proper C++ library support
-	    ld_shlibs_CXX=no
-	    ;;
-          *)
-	    # FIXME: insert proper C++ library support
-	    ld_shlibs_CXX=no
-	    ;;
-        esac
-        ;;
+// Check long long types.
+#define BIG64 18446744073709551615ull
+#define BIG32 4294967295ul
+#define BIG_OK (BIG64 / BIG32 == 4294967297ull && BIG64 % BIG32 == 0)
+#if !BIG_OK
+  your preprocessor is broken;
+#endif
+#if BIG_OK
+#else
+  your preprocessor is broken;
+#endif
+static long long int bignum = -9223372036854775807LL;
+static unsigned long long int ubignum = BIG64;
 
-      freebsd[12]*)
-        # C++ shared libraries reported to be fairly broken before
-	# switch to ELF
-        ld_shlibs_CXX=no
-        ;;
+struct incomplete_array
+{
+  int datasize;
+  double data[];
+};
 
-      freebsd-elf*)
-        archive_cmds_need_lc_CXX=no
-        ;;
+struct named_init {
+  int number;
+  const wchar_t *name;
+  double average;
+};
 
-      freebsd* | dragonfly*)
-        # FreeBSD 3 and later use GNU C++ and GNU ld with standard ELF
-        # conventions
-        ld_shlibs_CXX=yes
-        ;;
+typedef const char *ccp;
 
-      gnu*)
-        ;;
+static inline int
+test_restrict (ccp restrict text)
+{
+  // See if C++-style comments work.
+  // Iterate through items via the restricted pointer.
+  // Also check for declarations in for loops.
+  for (unsigned int i = 0; *(text+i) != '\0'; ++i)
+    continue;
+  return 0;
+}
 
-      haiku*)
-        archive_cmds_CXX='$CC -shared $libobjs $deplibs $compiler_flags ${wl}-soname $wl$soname -o $lib'
-        link_all_deplibs_CXX=yes
-        ;;
+// Check varargs and va_copy.
+static void
+test_varargs (const char *format, ...)
+{
+  va_list args;
+  va_start (args, format);
+  va_list args_copy;
+  va_copy (args_copy, args);
 
-      hpux9*)
-        hardcode_libdir_flag_spec_CXX='${wl}+b ${wl}$libdir'
-        hardcode_libdir_separator_CXX=:
-        export_dynamic_flag_spec_CXX='${wl}-E'
-        hardcode_direct_CXX=yes
-        hardcode_minus_L_CXX=yes # Not in the search PATH,
-				             # but as the default
-				             # location of the library.
-
-        case $cc_basename in
-          CC*)
-            # FIXME: insert proper C++ library support
-            ld_shlibs_CXX=no
-            ;;
-          aCC*)
-            archive_cmds_CXX='$RM $output_objdir/$soname~$CC -b ${wl}+b ${wl}$install_libdir -o $output_objdir/$soname $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags~test $output_objdir/$soname = $lib || mv $output_objdir/$soname $lib'
-            # Commands to make compiler produce verbose output that lists
-            # what "hidden" libraries, object files and flags are used when
-            # linking a shared library.
-            #
-            # There doesn't appear to be a way to prevent this compiler from
-            # explicitly linking system object files so we need to strip them
-            # from the output so that they don't get included in the library
-            # dependencies.
-            output_verbose_link_cmd='templist=`($CC -b $CFLAGS -v conftest.$objext 2>&1) | $EGREP "\-L"`; list=""; for z in $templist; do case $z in conftest.$objext) list="$list $z";; *.$objext);; *) list="$list $z";;esac; done; func_echo_all "$list"'
-            ;;
-          *)
-            if test "$GXX" = yes; then
-              archive_cmds_CXX='$RM $output_objdir/$soname~$CC -shared -nostdlib $pic_flag ${wl}+b ${wl}$install_libdir -o $output_objdir/$soname $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags~test $output_objdir/$soname = $lib || mv $output_objdir/$soname $lib'
-            else
-              # FIXME: insert proper C++ library support
-              ld_shlibs_CXX=no
-            fi
-            ;;
-        esac
-        ;;
+  const char *str;
+  int number;
+  float fnumber;
 
-      hpux10*|hpux11*)
-        if test $with_gnu_ld = no; then
-	  hardcode_libdir_flag_spec_CXX='${wl}+b ${wl}$libdir'
-	  hardcode_libdir_separator_CXX=:
-
-          case $host_cpu in
-            hppa*64*|ia64*)
-              ;;
-            *)
-	      export_dynamic_flag_spec_CXX='${wl}-E'
-              ;;
-          esac
-        fi
-        case $host_cpu in
-          hppa*64*|ia64*)
-            hardcode_direct_CXX=no
-            hardcode_shlibpath_var_CXX=no
-            ;;
-          *)
-            hardcode_direct_CXX=yes
-            hardcode_direct_absolute_CXX=yes
-            hardcode_minus_L_CXX=yes # Not in the search PATH,
-					         # but as the default
-					         # location of the library.
-            ;;
-        esac
+  while (*format)
+    {
+      switch (*format++)
+	{
+	case 's': // string
+	  str = va_arg (args_copy, const char *);
+	  break;
+	case 'd': // int
+	  number = va_arg (args_copy, int);
+	  break;
+	case 'f': // float
+	  fnumber = va_arg (args_copy, double);
+	  break;
+	default:
+	  break;
+	}
+    }
+  va_end (args_copy);
+  va_end (args);
+}
 
-        case $cc_basename in
-          CC*)
-	    # FIXME: insert proper C++ library support
-	    ld_shlibs_CXX=no
-	    ;;
-          aCC*)
-	    case $host_cpu in
-	      hppa*64*)
-	        archive_cmds_CXX='$CC -b ${wl}+h ${wl}$soname -o $lib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags'
-	        ;;
-	      ia64*)
-	        archive_cmds_CXX='$CC -b ${wl}+h ${wl}$soname ${wl}+nodefaultrpath -o $lib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags'
-	        ;;
-	      *)
-	        archive_cmds_CXX='$CC -b ${wl}+h ${wl}$soname ${wl}+b ${wl}$install_libdir -o $lib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags'
-	        ;;
-	    esac
-	    # Commands to make compiler produce verbose output that lists
-	    # what "hidden" libraries, object files and flags are used when
-	    # linking a shared library.
-	    #
-	    # There doesn't appear to be a way to prevent this compiler from
-	    # explicitly linking system object files so we need to strip them
-	    # from the output so that they don't get included in the library
-	    # dependencies.
-	    output_verbose_link_cmd='templist=`($CC -b $CFLAGS -v conftest.$objext 2>&1) | $GREP "\-L"`; list=""; for z in $templist; do case $z in conftest.$objext) list="$list $z";; *.$objext);; *) list="$list $z";;esac; done; func_echo_all "$list"'
-	    ;;
-          *)
-	    if test "$GXX" = yes; then
-	      if test $with_gnu_ld = no; then
-	        case $host_cpu in
-	          hppa*64*)
-	            archive_cmds_CXX='$CC -shared -nostdlib -fPIC ${wl}+h ${wl}$soname -o $lib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags'
-	            ;;
-	          ia64*)
-	            archive_cmds_CXX='$CC -shared -nostdlib $pic_flag ${wl}+h ${wl}$soname ${wl}+nodefaultrpath -o $lib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags'
-	            ;;
-	          *)
-	            archive_cmds_CXX='$CC -shared -nostdlib $pic_flag ${wl}+h ${wl}$soname ${wl}+b ${wl}$install_libdir -o $lib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags'
-	            ;;
-	        esac
-	      fi
-	    else
-	      # FIXME: insert proper C++ library support
-	      ld_shlibs_CXX=no
-	    fi
-	    ;;
-        esac
-        ;;
+int
+main ()
+{
 
-      interix[3-9]*)
-	hardcode_direct_CXX=no
-	hardcode_shlibpath_var_CXX=no
-	hardcode_libdir_flag_spec_CXX='${wl}-rpath,$libdir'
-	export_dynamic_flag_spec_CXX='${wl}-E'
-	# Hack: On Interix 3.x, we cannot compile PIC because of a broken gcc.
-	# Instead, shared libraries are loaded at an image base (0x10000000 by
-	# default) and relocated if they conflict, which is a slow very memory
-	# consuming and fragmenting process.  To avoid this, we pick a random,
-	# 256 KiB-aligned image base between 0x50000000 and 0x6FFC0000 at link
-	# time.  Moving up from 0x10000000 also allows more sbrk(2) space.
-	archive_cmds_CXX='$CC -shared $pic_flag $libobjs $deplibs $compiler_flags ${wl}-h,$soname ${wl}--image-base,`expr ${RANDOM-$$} % 4096 / 2 \* 262144 + 1342177280` -o $lib'
-	archive_expsym_cmds_CXX='sed "s,^,_," $export_symbols >$output_objdir/$soname.expsym~$CC -shared $pic_flag $libobjs $deplibs $compiler_flags ${wl}-h,$soname ${wl}--retain-symbols-file,$output_objdir/$soname.expsym ${wl}--image-base,`expr ${RANDOM-$$} % 4096 / 2 \* 262144 + 1342177280` -o $lib'
-	;;
-      irix5* | irix6*)
-        case $cc_basename in
-          CC*)
-	    # SGI C++
-	    archive_cmds_CXX='$CC -shared -all -multigot $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags -soname $soname `test -n "$verstring" && func_echo_all "-set_version $verstring"` -update_registry ${output_objdir}/so_locations -o $lib'
-
-	    # Archives containing C++ object files must be created using
-	    # "CC -ar", where "CC" is the IRIX C++ compiler.  This is
-	    # necessary to make sure instantiated templates are included
-	    # in the archive.
-	    old_archive_cmds_CXX='$CC -ar -WR,-u -o $oldlib $oldobjs'
-	    ;;
-          *)
-	    if test "$GXX" = yes; then
-	      if test "$with_gnu_ld" = no; then
-	        archive_cmds_CXX='$CC -shared $pic_flag -nostdlib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname ${wl}$soname `test -n "$verstring" && func_echo_all "${wl}-set_version ${wl}$verstring"` ${wl}-update_registry ${wl}${output_objdir}/so_locations -o $lib'
-	      else
-	        archive_cmds_CXX='$CC -shared $pic_flag -nostdlib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname ${wl}$soname `test -n "$verstring" && func_echo_all "${wl}-set_version ${wl}$verstring"` -o $lib'
-	      fi
-	    fi
-	    link_all_deplibs_CXX=yes
-	    ;;
-        esac
-        hardcode_libdir_flag_spec_CXX='${wl}-rpath ${wl}$libdir'
-        hardcode_libdir_separator_CXX=:
-        inherit_rpath_CXX=yes
-        ;;
+  // Check bool.
+  _Bool success = false;
 
-      linux* | k*bsd*-gnu | kopensolaris*-gnu)
-        case $cc_basename in
-          KCC*)
-	    # Kuck and Associates, Inc. (KAI) C++ Compiler
-
-	    # KCC will only create a shared library if the output file
-	    # ends with ".so" (or ".sl" for HP-UX), so rename the library
-	    # to its proper name (with version) after linking.
-	    archive_cmds_CXX='tempext=`echo $shared_ext | $SED -e '\''s/\([^()0-9A-Za-z{}]\)/\\\\\1/g'\''`; templib=`echo $lib | $SED -e "s/\${tempext}\..*/.so/"`; $CC $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags --soname $soname -o \$templib; mv \$templib $lib'
-	    archive_expsym_cmds_CXX='tempext=`echo $shared_ext | $SED -e '\''s/\([^()0-9A-Za-z{}]\)/\\\\\1/g'\''`; templib=`echo $lib | $SED -e "s/\${tempext}\..*/.so/"`; $CC $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags --soname $soname -o \$templib ${wl}-retain-symbols-file,$export_symbols; mv \$templib $lib'
-	    # Commands to make compiler produce verbose output that lists
-	    # what "hidden" libraries, object files and flags are used when
-	    # linking a shared library.
-	    #
-	    # There doesn't appear to be a way to prevent this compiler from
-	    # explicitly linking system object files so we need to strip them
-	    # from the output so that they don't get included in the library
-	    # dependencies.
-	    output_verbose_link_cmd='templist=`$CC $CFLAGS -v conftest.$objext -o libconftest$shared_ext 2>&1 | $GREP "ld"`; rm -f libconftest$shared_ext; list=""; for z in $templist; do case $z in conftest.$objext) list="$list $z";; *.$objext);; *) list="$list $z";;esac; done; func_echo_all "$list"'
-
-	    hardcode_libdir_flag_spec_CXX='${wl}-rpath,$libdir'
-	    export_dynamic_flag_spec_CXX='${wl}--export-dynamic'
-
-	    # Archives containing C++ object files must be created using
-	    # "CC -Bstatic", where "CC" is the KAI C++ compiler.
-	    old_archive_cmds_CXX='$CC -Bstatic -o $oldlib $oldobjs'
-	    ;;
-	  icpc* | ecpc* )
-	    # Intel C++
-	    with_gnu_ld=yes
-	    # version 8.0 and above of icpc choke on multiply defined symbols
-	    # if we add $predep_objects and $postdep_objects, however 7.1 and
-	    # earlier do not add the objects themselves.
-	    case `$CC -V 2>&1` in
-	      *"Version 7."*)
-	        archive_cmds_CXX='$CC -shared $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname $wl$soname -o $lib'
-		archive_expsym_cmds_CXX='$CC -shared $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname $wl$soname ${wl}-retain-symbols-file $wl$export_symbols -o $lib'
-		;;
-	      *)  # Version 8.0 or newer
-	        tmp_idyn=
-	        case $host_cpu in
-		  ia64*) tmp_idyn=' -i_dynamic';;
-		esac
-	        archive_cmds_CXX='$CC -shared'"$tmp_idyn"' $libobjs $deplibs $compiler_flags ${wl}-soname $wl$soname -o $lib'
-		archive_expsym_cmds_CXX='$CC -shared'"$tmp_idyn"' $libobjs $deplibs $compiler_flags ${wl}-soname $wl$soname ${wl}-retain-symbols-file $wl$export_symbols -o $lib'
-		;;
-	    esac
-	    archive_cmds_need_lc_CXX=no
-	    hardcode_libdir_flag_spec_CXX='${wl}-rpath,$libdir'
-	    export_dynamic_flag_spec_CXX='${wl}--export-dynamic'
-	    whole_archive_flag_spec_CXX='${wl}--whole-archive$convenience ${wl}--no-whole-archive'
-	    ;;
-          pgCC* | pgcpp*)
-            # Portland Group C++ compiler
-	    case `$CC -V` in
-	    *pgCC\ [1-5].* | *pgcpp\ [1-5].*)
-	      prelink_cmds_CXX='tpldir=Template.dir~
-		rm -rf $tpldir~
-		$CC --prelink_objects --instantiation_dir $tpldir $objs $libobjs $compile_deplibs~
-		compile_command="$compile_command `find $tpldir -name \*.o | sort | $NL2SP`"'
-	      old_archive_cmds_CXX='tpldir=Template.dir~
-		rm -rf $tpldir~
-		$CC --prelink_objects --instantiation_dir $tpldir $oldobjs$old_deplibs~
-		$AR $AR_FLAGS $oldlib$oldobjs$old_deplibs `find $tpldir -name \*.o | sort | $NL2SP`~
-		$RANLIB $oldlib'
-	      archive_cmds_CXX='tpldir=Template.dir~
-		rm -rf $tpldir~
-		$CC --prelink_objects --instantiation_dir $tpldir $predep_objects $libobjs $deplibs $convenience $postdep_objects~
-		$CC -shared $pic_flag $predep_objects $libobjs $deplibs `find $tpldir -name \*.o | sort | $NL2SP` $postdep_objects $compiler_flags ${wl}-soname ${wl}$soname -o $lib'
-	      archive_expsym_cmds_CXX='tpldir=Template.dir~
-		rm -rf $tpldir~
-		$CC --prelink_objects --instantiation_dir $tpldir $predep_objects $libobjs $deplibs $convenience $postdep_objects~
-		$CC -shared $pic_flag $predep_objects $libobjs $deplibs `find $tpldir -name \*.o | sort | $NL2SP` $postdep_objects $compiler_flags ${wl}-soname ${wl}$soname ${wl}-retain-symbols-file ${wl}$export_symbols -o $lib'
-	      ;;
-	    *) # Version 6 and above use weak symbols
-	      archive_cmds_CXX='$CC -shared $pic_flag $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname ${wl}$soname -o $lib'
-	      archive_expsym_cmds_CXX='$CC -shared $pic_flag $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname ${wl}$soname ${wl}-retain-symbols-file ${wl}$export_symbols -o $lib'
-	      ;;
-	    esac
+  // Check restrict.
+  if (test_restrict ("String literal") == 0)
+    success = true;
+  char *restrict newvar = "Another string";
 
-	    hardcode_libdir_flag_spec_CXX='${wl}--rpath ${wl}$libdir'
-	    export_dynamic_flag_spec_CXX='${wl}--export-dynamic'
-	    whole_archive_flag_spec_CXX='${wl}--whole-archive`for conv in $convenience\"\"; do test  -n \"$conv\" && new_convenience=\"$new_convenience,$conv\"; done; func_echo_all \"$new_convenience\"` ${wl}--no-whole-archive'
-            ;;
-	  cxx*)
-	    # Compaq C++
-	    archive_cmds_CXX='$CC -shared $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname $wl$soname -o $lib'
-	    archive_expsym_cmds_CXX='$CC -shared $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname $wl$soname  -o $lib ${wl}-retain-symbols-file $wl$export_symbols'
-
-	    runpath_var=LD_RUN_PATH
-	    hardcode_libdir_flag_spec_CXX='-rpath $libdir'
-	    hardcode_libdir_separator_CXX=:
-
-	    # Commands to make compiler produce verbose output that lists
-	    # what "hidden" libraries, object files and flags are used when
-	    # linking a shared library.
-	    #
-	    # There doesn't appear to be a way to prevent this compiler from
-	    # explicitly linking system object files so we need to strip them
-	    # from the output so that they don't get included in the library
-	    # dependencies.
-	    output_verbose_link_cmd='templist=`$CC -shared $CFLAGS -v conftest.$objext 2>&1 | $GREP "ld"`; templist=`func_echo_all "$templist" | $SED "s/\(^.*ld.*\)\( .*ld .*$\)/\1/"`; list=""; for z in $templist; do case $z in conftest.$objext) list="$list $z";; *.$objext);; *) list="$list $z";;esac; done; func_echo_all "X$list" | $Xsed'
-	    ;;
-	  xl* | mpixl* | bgxl*)
-	    # IBM XL 8.0 on PPC, with GNU ld
-	    hardcode_libdir_flag_spec_CXX='${wl}-rpath ${wl}$libdir'
-	    export_dynamic_flag_spec_CXX='${wl}--export-dynamic'
-	    archive_cmds_CXX='$CC -qmkshrobj $libobjs $deplibs $compiler_flags ${wl}-soname $wl$soname -o $lib'
-	    if test "x$supports_anon_versioning" = xyes; then
-	      archive_expsym_cmds_CXX='echo "{ global:" > $output_objdir/$libname.ver~
-		cat $export_symbols | sed -e "s/\(.*\)/\1;/" >> $output_objdir/$libname.ver~
-		echo "local: *; };" >> $output_objdir/$libname.ver~
-		$CC -qmkshrobj $libobjs $deplibs $compiler_flags ${wl}-soname $wl$soname ${wl}-version-script ${wl}$output_objdir/$libname.ver -o $lib'
-	    fi
-	    ;;
-	  *)
-	    case `$CC -V 2>&1 | sed 5q` in
-	    *Sun\ C*)
-	      # Sun C++ 5.9
-	      no_undefined_flag_CXX=' -zdefs'
-	      archive_cmds_CXX='$CC -G${allow_undefined_flag} -h$soname -o $lib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags'
-	      archive_expsym_cmds_CXX='$CC -G${allow_undefined_flag} -h$soname -o $lib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-retain-symbols-file ${wl}$export_symbols'
-	      hardcode_libdir_flag_spec_CXX='-R$libdir'
-	      whole_archive_flag_spec_CXX='${wl}--whole-archive`new_convenience=; for conv in $convenience\"\"; do test -z \"$conv\" || new_convenience=\"$new_convenience,$conv\"; done; func_echo_all \"$new_convenience\"` ${wl}--no-whole-archive'
-	      compiler_needs_object_CXX=yes
-
-	      # Not sure whether something based on
-	      # $CC $CFLAGS -v conftest.$objext -o libconftest$shared_ext 2>&1
-	      # would be better.
-	      output_verbose_link_cmd='func_echo_all'
-
-	      # Archives containing C++ object files must be created using
-	      # "CC -xar", where "CC" is the Sun C++ compiler.  This is
-	      # necessary to make sure instantiated templates are included
-	      # in the archive.
-	      old_archive_cmds_CXX='$CC -xar -o $oldlib $oldobjs'
-	      ;;
-	    esac
-	    ;;
-	esac
-	;;
+  // Check varargs.
+  test_varargs ("s, d' f .", "string", 65, 34.234);
+  test_varargs_macros ();
 
-      lynxos*)
-        # FIXME: insert proper C++ library support
-	ld_shlibs_CXX=no
-	;;
+  // Check flexible array members.
+  struct incomplete_array *ia =
+    malloc (sizeof (struct incomplete_array) + (sizeof (double) * 10));
+  ia->datasize = 10;
+  for (int i = 0; i < ia->datasize; ++i)
+    ia->data[i] = i * 1.234;
 
-      m88k*)
-        # FIXME: insert proper C++ library support
-        ld_shlibs_CXX=no
-	;;
+  // Check named initializers.
+  struct named_init ni = {
+    .number = 34,
+    .name = L"Test wide string",
+    .average = 543.34343,
+  };
 
-      mvs*)
-        case $cc_basename in
-          cxx*)
-	    # FIXME: insert proper C++ library support
-	    ld_shlibs_CXX=no
-	    ;;
-	  *)
-	    # FIXME: insert proper C++ library support
-	    ld_shlibs_CXX=no
-	    ;;
-	esac
-	;;
+  ni.number = 58;
 
-      netbsd*)
-        if echo __ELF__ | $CC -E - | $GREP __ELF__ >/dev/null; then
-	  archive_cmds_CXX='$LD -Bshareable  -o $lib $predep_objects $libobjs $deplibs $postdep_objects $linker_flags'
-	  wlarc=
-	  hardcode_libdir_flag_spec_CXX='-R$libdir'
-	  hardcode_direct_CXX=yes
-	  hardcode_shlibpath_var_CXX=no
-	fi
-	# Workaround some broken pre-1.5 toolchains
-	output_verbose_link_cmd='$CC -shared $CFLAGS -v conftest.$objext 2>&1 | $GREP conftest.$objext | $SED -e "s:-lgcc -lc -lgcc::"'
-	;;
+  int dynamic_array[ni.number];
+  dynamic_array[ni.number - 1] = 543;
 
-      *nto* | *qnx*)
-        ld_shlibs_CXX=yes
-	;;
+  // work around unused variable warnings
+  return (!success || bignum == 0LL || ubignum == 0uLL || newvar[0] == 'x'
+	  || dynamic_array[ni.number - 1] != 543);
 
-      openbsd2*)
-        # C++ shared libraries are fairly broken
-	ld_shlibs_CXX=no
-	;;
+  ;
+  return 0;
+}
+_ACEOF
+for ac_arg in '' -std=gnu99 -std=c99 -c99 -AC99 -D_STDC_C99= -qlanglvl=extc99
+do
+  CC="$ac_save_CC $ac_arg"
+  if ac_fn_c_try_compile "$LINENO"; then :
+  ac_cv_prog_cc_c99=$ac_arg
+fi
+rm -f core conftest.err conftest.$ac_objext
+  test "x$ac_cv_prog_cc_c99" != "xno" && break
+done
+rm -f conftest.$ac_ext
+CC=$ac_save_CC
 
-      openbsd*)
-	if test -f /usr/libexec/ld.so; then
-	  hardcode_direct_CXX=yes
-	  hardcode_shlibpath_var_CXX=no
-	  hardcode_direct_absolute_CXX=yes
-	  archive_cmds_CXX='$CC -shared $pic_flag $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags -o $lib'
-	  hardcode_libdir_flag_spec_CXX='${wl}-rpath,$libdir'
-	  if test -z "`echo __ELF__ | $CC -E - | grep __ELF__`" || test "$host_os-$host_cpu" = "openbsd2.8-powerpc"; then
-	    archive_expsym_cmds_CXX='$CC -shared $pic_flag $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-retain-symbols-file,$export_symbols -o $lib'
-	    export_dynamic_flag_spec_CXX='${wl}-E'
-	    whole_archive_flag_spec_CXX="$wlarc"'--whole-archive$convenience '"$wlarc"'--no-whole-archive'
-	  fi
-	  output_verbose_link_cmd=func_echo_all
-	else
-	  ld_shlibs_CXX=no
-	fi
-	;;
+fi
+# AC_CACHE_VAL
+case "x$ac_cv_prog_cc_c99" in
+  x)
+    { $as_echo "$as_me:${as_lineno-$LINENO}: result: none needed" >&5
+$as_echo "none needed" >&6; } ;;
+  xno)
+    { $as_echo "$as_me:${as_lineno-$LINENO}: result: unsupported" >&5
+$as_echo "unsupported" >&6; } ;;
+  *)
+    CC="$CC $ac_cv_prog_cc_c99"
+    { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_prog_cc_c99" >&5
+$as_echo "$ac_cv_prog_cc_c99" >&6; } ;;
+esac
+if test "x$ac_cv_prog_cc_c99" != xno; then :
 
-      osf3* | osf4* | osf5*)
-        case $cc_basename in
-          KCC*)
-	    # Kuck and Associates, Inc. (KAI) C++ Compiler
-
-	    # KCC will only create a shared library if the output file
-	    # ends with ".so" (or ".sl" for HP-UX), so rename the library
-	    # to its proper name (with version) after linking.
-	    archive_cmds_CXX='tempext=`echo $shared_ext | $SED -e '\''s/\([^()0-9A-Za-z{}]\)/\\\\\1/g'\''`; templib=`echo "$lib" | $SED -e "s/\${tempext}\..*/.so/"`; $CC $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags --soname $soname -o \$templib; mv \$templib $lib'
-
-	    hardcode_libdir_flag_spec_CXX='${wl}-rpath,$libdir'
-	    hardcode_libdir_separator_CXX=:
-
-	    # Archives containing C++ object files must be created using
-	    # the KAI C++ compiler.
-	    case $host in
-	      osf3*) old_archive_cmds_CXX='$CC -Bstatic -o $oldlib $oldobjs' ;;
-	      *) old_archive_cmds_CXX='$CC -o $oldlib $oldobjs' ;;
-	    esac
-	    ;;
-          RCC*)
-	    # Rational C++ 2.4.1
-	    # FIXME: insert proper C++ library support
-	    ld_shlibs_CXX=no
-	    ;;
-          cxx*)
-	    case $host in
-	      osf3*)
-	        allow_undefined_flag_CXX=' ${wl}-expect_unresolved ${wl}\*'
-	        archive_cmds_CXX='$CC -shared${allow_undefined_flag} $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname $soname `test -n "$verstring" && func_echo_all "${wl}-set_version $verstring"` -update_registry ${output_objdir}/so_locations -o $lib'
-	        hardcode_libdir_flag_spec_CXX='${wl}-rpath ${wl}$libdir'
-		;;
-	      *)
-	        allow_undefined_flag_CXX=' -expect_unresolved \*'
-	        archive_cmds_CXX='$CC -shared${allow_undefined_flag} $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags -msym -soname $soname `test -n "$verstring" && func_echo_all "-set_version $verstring"` -update_registry ${output_objdir}/so_locations -o $lib'
-	        archive_expsym_cmds_CXX='for i in `cat $export_symbols`; do printf "%s %s\\n" -exported_symbol "\$i" >> $lib.exp; done~
-	          echo "-hidden">> $lib.exp~
-	          $CC -shared$allow_undefined_flag $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags -msym -soname $soname ${wl}-input ${wl}$lib.exp  `test -n "$verstring" && $ECHO "-set_version $verstring"` -update_registry ${output_objdir}/so_locations -o $lib~
-	          $RM $lib.exp'
-	        hardcode_libdir_flag_spec_CXX='-rpath $libdir'
-		;;
-	    esac
+fi
 
-	    hardcode_libdir_separator_CXX=:
 
-	    # Commands to make compiler produce verbose output that lists
-	    # what "hidden" libraries, object files and flags are used when
-	    # linking a shared library.
-	    #
-	    # There doesn't appear to be a way to prevent this compiler from
-	    # explicitly linking system object files so we need to strip them
-	    # from the output so that they don't get included in the library
-	    # dependencies.
-	    output_verbose_link_cmd='templist=`$CC -shared $CFLAGS -v conftest.$objext 2>&1 | $GREP "ld" | $GREP -v "ld:"`; templist=`func_echo_all "$templist" | $SED "s/\(^.*ld.*\)\( .*ld.*$\)/\1/"`; list=""; for z in $templist; do case $z in conftest.$objext) list="$list $z";; *.$objext);; *) list="$list $z";;esac; done; func_echo_all "$list"'
-	    ;;
-	  *)
-	    if test "$GXX" = yes && test "$with_gnu_ld" = no; then
-	      allow_undefined_flag_CXX=' ${wl}-expect_unresolved ${wl}\*'
-	      case $host in
-	        osf3*)
-	          archive_cmds_CXX='$CC -shared -nostdlib ${allow_undefined_flag} $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname ${wl}$soname `test -n "$verstring" && func_echo_all "${wl}-set_version ${wl}$verstring"` ${wl}-update_registry ${wl}${output_objdir}/so_locations -o $lib'
-		  ;;
-	        *)
-	          archive_cmds_CXX='$CC -shared $pic_flag -nostdlib ${allow_undefined_flag} $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-msym ${wl}-soname ${wl}$soname `test -n "$verstring" && func_echo_all "${wl}-set_version ${wl}$verstring"` ${wl}-update_registry ${wl}${output_objdir}/so_locations -o $lib'
-		  ;;
-	      esac
-
-	      hardcode_libdir_flag_spec_CXX='${wl}-rpath ${wl}$libdir'
-	      hardcode_libdir_separator_CXX=:
-
-	      # Commands to make compiler produce verbose output that lists
-	      # what "hidden" libraries, object files and flags are used when
-	      # linking a shared library.
-	      output_verbose_link_cmd='$CC -shared $CFLAGS -v conftest.$objext 2>&1 | $GREP -v "^Configured with:" | $GREP "\-L"'
-
-	    else
-	      # FIXME: insert proper C++ library support
-	      ld_shlibs_CXX=no
-	    fi
-	    ;;
-        esac
-        ;;
-
-      psos*)
-        # FIXME: insert proper C++ library support
-        ld_shlibs_CXX=no
-        ;;
-
-      sunos4*)
-        case $cc_basename in
-          CC*)
-	    # Sun C++ 4.x
-	    # FIXME: insert proper C++ library support
-	    ld_shlibs_CXX=no
-	    ;;
-          lcc*)
-	    # Lucid
-	    # FIXME: insert proper C++ library support
-	    ld_shlibs_CXX=no
-	    ;;
-          *)
-	    # FIXME: insert proper C++ library support
-	    ld_shlibs_CXX=no
-	    ;;
-        esac
-        ;;
 
-      solaris*)
-        case $cc_basename in
-          CC* | sunCC*)
-	    # Sun C++ 4.2, 5.x and Centerline C++
-            archive_cmds_need_lc_CXX=yes
-	    no_undefined_flag_CXX=' -zdefs'
-	    archive_cmds_CXX='$CC -G${allow_undefined_flag}  -h$soname -o $lib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags'
-	    archive_expsym_cmds_CXX='echo "{ global:" > $lib.exp~cat $export_symbols | $SED -e "s/\(.*\)/\1;/" >> $lib.exp~echo "local: *; };" >> $lib.exp~
-	      $CC -G${allow_undefined_flag} ${wl}-M ${wl}$lib.exp -h$soname -o $lib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags~$RM $lib.exp'
-
-	    hardcode_libdir_flag_spec_CXX='-R$libdir'
-	    hardcode_shlibpath_var_CXX=no
-	    case $host_os in
-	      solaris2.[0-5] | solaris2.[0-5].*) ;;
-	      *)
-		# The compiler driver will combine and reorder linker options,
-		# but understands `-z linker_flag'.
-	        # Supported since Solaris 2.6 (maybe 2.5.1?)
-		whole_archive_flag_spec_CXX='-z allextract$convenience -z defaultextract'
-	        ;;
-	    esac
-	    link_all_deplibs_CXX=yes
+for ac_prog in python2.7 python2.6 python2.5 python2 python
+do
+  # Extract the first word of "$ac_prog", so it can be a program name with args.
+set dummy $ac_prog; ac_word=$2
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
+if ${ac_cv_prog_PYTHON+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  if test -n "$PYTHON"; then
+  ac_cv_prog_PYTHON="$PYTHON" # Let the user override the test.
+else
+as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+for as_dir in $PATH
+do
+  IFS=$as_save_IFS
+  test -z "$as_dir" && as_dir=.
+    for ac_exec_ext in '' $ac_executable_extensions; do
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+    ac_cv_prog_PYTHON="$ac_prog"
+    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+    break 2
+  fi
+done
+  done
+IFS=$as_save_IFS
 
-	    output_verbose_link_cmd='func_echo_all'
+fi
+fi
+PYTHON=$ac_cv_prog_PYTHON
+if test -n "$PYTHON"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $PYTHON" >&5
+$as_echo "$PYTHON" >&6; }
+else
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
+fi
 
-	    # Archives containing C++ object files must be created using
-	    # "CC -xar", where "CC" is the Sun C++ compiler.  This is
-	    # necessary to make sure instantiated templates are included
-	    # in the archive.
-	    old_archive_cmds_CXX='$CC -xar -o $oldlib $oldobjs'
-	    ;;
-          gcx*)
-	    # Green Hills C++ Compiler
-	    archive_cmds_CXX='$CC -shared $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-h $wl$soname -o $lib'
 
-	    # The C++ compiler must be used to create the archive.
-	    old_archive_cmds_CXX='$CC $LDFLAGS -archive -o $oldlib $oldobjs'
-	    ;;
-          *)
-	    # GNU C++ compiler with Solaris linker
-	    if test "$GXX" = yes && test "$with_gnu_ld" = no; then
-	      no_undefined_flag_CXX=' ${wl}-z ${wl}defs'
-	      if $CC --version | $GREP -v '^2\.7' > /dev/null; then
-	        archive_cmds_CXX='$CC -shared $pic_flag -nostdlib $LDFLAGS $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-h $wl$soname -o $lib'
-	        archive_expsym_cmds_CXX='echo "{ global:" > $lib.exp~cat $export_symbols | $SED -e "s/\(.*\)/\1;/" >> $lib.exp~echo "local: *; };" >> $lib.exp~
-		  $CC -shared $pic_flag -nostdlib ${wl}-M $wl$lib.exp -o $lib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags~$RM $lib.exp'
-
-	        # Commands to make compiler produce verbose output that lists
-	        # what "hidden" libraries, object files and flags are used when
-	        # linking a shared library.
-	        output_verbose_link_cmd='$CC -shared $CFLAGS -v conftest.$objext 2>&1 | $GREP -v "^Configured with:" | $GREP "\-L"'
-	      else
-	        # g++ 2.7 appears to require `-G' NOT `-shared' on this
-	        # platform.
-	        archive_cmds_CXX='$CC -G -nostdlib $LDFLAGS $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-h $wl$soname -o $lib'
-	        archive_expsym_cmds_CXX='echo "{ global:" > $lib.exp~cat $export_symbols | $SED -e "s/\(.*\)/\1;/" >> $lib.exp~echo "local: *; };" >> $lib.exp~
-		  $CC -G -nostdlib ${wl}-M $wl$lib.exp -o $lib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags~$RM $lib.exp'
-
-	        # Commands to make compiler produce verbose output that lists
-	        # what "hidden" libraries, object files and flags are used when
-	        # linking a shared library.
-	        output_verbose_link_cmd='$CC -G $CFLAGS -v conftest.$objext 2>&1 | $GREP -v "^Configured with:" | $GREP "\-L"'
-	      fi
-
-	      hardcode_libdir_flag_spec_CXX='${wl}-R $wl$libdir'
-	      case $host_os in
-		solaris2.[0-5] | solaris2.[0-5].*) ;;
-		*)
-		  whole_archive_flag_spec_CXX='${wl}-z ${wl}allextract$convenience ${wl}-z ${wl}defaultextract'
-		  ;;
-	      esac
-	    fi
-	    ;;
-        esac
-        ;;
+  test -n "$PYTHON" && break
+done
+test -n "$PYTHON" || PYTHON="false"
 
-    sysv4*uw2* | sysv5OpenUNIX* | sysv5UnixWare7.[01].[10]* | unixware7* | sco3.2v5.0.[024]*)
-      no_undefined_flag_CXX='${wl}-z,text'
-      archive_cmds_need_lc_CXX=no
-      hardcode_shlibpath_var_CXX=no
-      runpath_var='LD_RUN_PATH'
+for ac_prog in bash bash4
+do
+  # Extract the first word of "$ac_prog", so it can be a program name with args.
+set dummy $ac_prog; ac_word=$2
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
+if ${ac_cv_path_BASH_SHELL+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  case $BASH_SHELL in
+  [\\/]* | ?:[\\/]*)
+  ac_cv_path_BASH_SHELL="$BASH_SHELL" # Let the user override the test with a path.
+  ;;
+  *)
+  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+for as_dir in $PATH
+do
+  IFS=$as_save_IFS
+  test -z "$as_dir" && as_dir=.
+    for ac_exec_ext in '' $ac_executable_extensions; do
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+    ac_cv_path_BASH_SHELL="$as_dir/$ac_word$ac_exec_ext"
+    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+    break 2
+  fi
+done
+  done
+IFS=$as_save_IFS
 
-      case $cc_basename in
-        CC*)
-	  archive_cmds_CXX='$CC -G ${wl}-h,$soname -o $lib $libobjs $deplibs $compiler_flags'
-	  archive_expsym_cmds_CXX='$CC -G ${wl}-Bexport:$export_symbols ${wl}-h,$soname -o $lib $libobjs $deplibs $compiler_flags'
-	  ;;
-	*)
-	  archive_cmds_CXX='$CC -shared ${wl}-h,$soname -o $lib $libobjs $deplibs $compiler_flags'
-	  archive_expsym_cmds_CXX='$CC -shared ${wl}-Bexport:$export_symbols ${wl}-h,$soname -o $lib $libobjs $deplibs $compiler_flags'
-	  ;;
-      esac
-      ;;
+  ;;
+esac
+fi
+BASH_SHELL=$ac_cv_path_BASH_SHELL
+if test -n "$BASH_SHELL"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $BASH_SHELL" >&5
+$as_echo "$BASH_SHELL" >&6; }
+else
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
+fi
 
-      sysv5* | sco3.2v5* | sco5v6*)
-	# Note: We can NOT use -z defs as we might desire, because we do not
-	# link with -lc, and that would cause any symbols used from libc to
-	# always be unresolved, which means just about no library would
-	# ever link correctly.  If we're not using GNU ld we use -z text
-	# though, which does catch some bad symbols but isn't as heavy-handed
-	# as -z defs.
-	no_undefined_flag_CXX='${wl}-z,text'
-	allow_undefined_flag_CXX='${wl}-z,nodefs'
-	archive_cmds_need_lc_CXX=no
-	hardcode_shlibpath_var_CXX=no
-	hardcode_libdir_flag_spec_CXX='${wl}-R,$libdir'
-	hardcode_libdir_separator_CXX=':'
-	link_all_deplibs_CXX=yes
-	export_dynamic_flag_spec_CXX='${wl}-Bexport'
-	runpath_var='LD_RUN_PATH'
 
-	case $cc_basename in
-          CC*)
-	    archive_cmds_CXX='$CC -G ${wl}-h,$soname -o $lib $libobjs $deplibs $compiler_flags'
-	    archive_expsym_cmds_CXX='$CC -G ${wl}-Bexport:$export_symbols ${wl}-h,$soname -o $lib $libobjs $deplibs $compiler_flags'
-	    old_archive_cmds_CXX='$CC -Tprelink_objects $oldobjs~
-	      '"$old_archive_cmds_CXX"
-	    reload_cmds_CXX='$CC -Tprelink_objects $reload_objs~
-	      '"$reload_cmds_CXX"
-	    ;;
-	  *)
-	    archive_cmds_CXX='$CC -shared ${wl}-h,$soname -o $lib $libobjs $deplibs $compiler_flags'
-	    archive_expsym_cmds_CXX='$CC -shared ${wl}-Bexport:$export_symbols ${wl}-h,$soname -o $lib $libobjs $deplibs $compiler_flags'
-	    ;;
-	esac
-      ;;
+  test -n "$BASH_SHELL" && break
+done
+test -n "$BASH_SHELL" || BASH_SHELL="false"
 
-      tandem*)
-        case $cc_basename in
-          NCC*)
-	    # NonStop-UX NCC 3.20
-	    # FIXME: insert proper C++ library support
-	    ld_shlibs_CXX=no
-	    ;;
-          *)
-	    # FIXME: insert proper C++ library support
-	    ld_shlibs_CXX=no
-	    ;;
-        esac
-        ;;
 
-      vxworks*)
-        # FIXME: insert proper C++ library support
-        ld_shlibs_CXX=no
-        ;;
+if test "x$BASH_SHELL" = "xfalse"; then :
+  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: *** bash >= 4.1.0 is required for pacman scripts" >&5
+$as_echo "$as_me: WARNING: *** bash >= 4.1.0 is required for pacman scripts" >&2;}
+else
+  bash_version_major=`$BASH_SHELL -c 'echo "${BASH_VERSINFO[0]}"'`
+	bash_version_minor=`$BASH_SHELL -c 'echo "${BASH_VERSINFO[1]}"'`
+	ok=yes
+	if test "$bash_version_major" -lt 4; then
+		ok=no
+	fi
+	if test "$bash_version_major" -eq 4 && test "$bash_version_minor" -lt 1; then
+		ok=no
+	fi
+	if test "$ok" = "no"; then
+		as_fn_error $? "*** bash >= 4.1.0 is required for pacman scripts" "$LINENO" 5
+	fi
+	unset bash_version_major bash_version_minor ok
+fi
 
-      *)
-        # FIXME: insert proper C++ library support
-        ld_shlibs_CXX=no
-        ;;
-    esac
+# find installed gettext
 
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ld_shlibs_CXX" >&5
-$as_echo "$ld_shlibs_CXX" >&6; }
-    test "$ld_shlibs_CXX" = no && can_build_shared=no
-
-    GCC_CXX="$GXX"
-    LD_CXX="$LD"
-
-    ## CAVEAT EMPTOR:
-    ## There is no encapsulation within the following macros, do not change
-    ## the running order or otherwise move them around unless you know exactly
-    ## what you are doing...
-    # Dependencies to place before and after the object being linked:
-predep_objects_CXX=
-postdep_objects_CXX=
-predeps_CXX=
-postdeps_CXX=
-compiler_lib_search_path_CXX=
-
-cat > conftest.$ac_ext <<_LT_EOF
-class Foo
-{
-public:
-  Foo (void) { a = 0; }
-private:
-  int a;
-};
-_LT_EOF
+  { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether NLS is requested" >&5
+$as_echo_n "checking whether NLS is requested... " >&6; }
+    # Check whether --enable-nls was given.
+if test "${enable_nls+set}" = set; then :
+  enableval=$enable_nls; USE_NLS=$enableval
+else
+  USE_NLS=yes
+fi
 
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $USE_NLS" >&5
+$as_echo "$USE_NLS" >&6; }
 
-_lt_libdeps_save_CFLAGS=$CFLAGS
-case "$CC $CFLAGS " in #(
-*\ -flto*\ *) CFLAGS="$CFLAGS -fno-lto" ;;
-*\ -fwhopr*\ *) CFLAGS="$CFLAGS -fno-whopr" ;;
-esac
 
-if { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_compile\""; } >&5
-  (eval $ac_compile) 2>&5
-  ac_status=$?
-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; }; then
-  # Parse the compiler output and extract the necessary
-  # objects, libraries and library flags.
 
-  # Sentinel used to keep track of whether or not we are before
-  # the conftest object file.
-  pre_test_object_deps_done=no
-
-  for p in `eval "$output_verbose_link_cmd"`; do
-    case ${prev}${p} in
-
-    -L* | -R* | -l*)
-       # Some compilers place space between "-{L,R}" and the path.
-       # Remove the space.
-       if test $p = "-L" ||
-          test $p = "-R"; then
-	 prev=$p
-	 continue
-       fi
 
-       # Expand the sysroot to ease extracting the directories later.
-       if test -z "$prev"; then
-         case $p in
-         -L*) func_stripname_cnf '-L' '' "$p"; prev=-L; p=$func_stripname_result ;;
-         -R*) func_stripname_cnf '-R' '' "$p"; prev=-R; p=$func_stripname_result ;;
-         -l*) func_stripname_cnf '-l' '' "$p"; prev=-l; p=$func_stripname_result ;;
-         esac
-       fi
-       case $p in
-       =*) func_stripname_cnf '=' '' "$p"; p=$lt_sysroot$func_stripname_result ;;
-       esac
-       if test "$pre_test_object_deps_done" = no; then
-	 case ${prev} in
-	 -L | -R)
-	   # Internal compiler library paths should come after those
-	   # provided the user.  The postdeps already come after the
-	   # user supplied libs so there is no need to process them.
-	   if test -z "$compiler_lib_search_path_CXX"; then
-	     compiler_lib_search_path_CXX="${prev}${p}"
-	   else
-	     compiler_lib_search_path_CXX="${compiler_lib_search_path_CXX} ${prev}${p}"
-	   fi
-	   ;;
-	 # The "-l" case would never come before the object being
-	 # linked, so don't bother handling this case.
-	 esac
-       else
-	 if test -z "$postdeps_CXX"; then
-	   postdeps_CXX="${prev}${p}"
-	 else
-	   postdeps_CXX="${postdeps_CXX} ${prev}${p}"
-	 fi
-       fi
-       prev=
-       ;;
+      GETTEXT_MACRO_VERSION=0.18
 
-    *.lto.$objext) ;; # Ignore GCC LTO objects
-    *.$objext)
-       # This assumes that the test object file only shows up
-       # once in the compiler output.
-       if test "$p" = "conftest.$objext"; then
-	 pre_test_object_deps_done=yes
-	 continue
-       fi
 
-       if test "$pre_test_object_deps_done" = no; then
-	 if test -z "$predep_objects_CXX"; then
-	   predep_objects_CXX="$p"
-	 else
-	   predep_objects_CXX="$predep_objects_CXX $p"
-	 fi
-       else
-	 if test -z "$postdep_objects_CXX"; then
-	   postdep_objects_CXX="$p"
-	 else
-	   postdep_objects_CXX="$postdep_objects_CXX $p"
-	 fi
-       fi
-       ;;
 
-    *) ;; # Ignore the rest.
 
-    esac
-  done
+# Prepare PATH_SEPARATOR.
+# The user is always right.
+if test "${PATH_SEPARATOR+set}" != set; then
+  echo "#! /bin/sh" >conf$$.sh
+  echo  "exit 0"   >>conf$$.sh
+  chmod +x conf$$.sh
+  if (PATH="/nonexistent;."; conf$$.sh) >/dev/null 2>&1; then
+    PATH_SEPARATOR=';'
+  else
+    PATH_SEPARATOR=:
+  fi
+  rm -f conf$$.sh
+fi
 
-  # Clean up.
-  rm -f a.out a.exe
+# Find out how to test for executable files. Don't use a zero-byte file,
+# as systems may use methods other than mode bits to determine executability.
+cat >conf$$.file <<_ASEOF
+#! /bin/sh
+exit 0
+_ASEOF
+chmod +x conf$$.file
+if test -x conf$$.file >/dev/null 2>&1; then
+  ac_executable_p="test -x"
 else
-  echo "libtool.m4: error: problem compiling CXX test program"
+  ac_executable_p="test -f"
 fi
+rm -f conf$$.file
 
-$RM -f confest.$objext
-CFLAGS=$_lt_libdeps_save_CFLAGS
-
-# PORTME: override above test on systems where it is broken
-case $host_os in
-interix[3-9]*)
-  # Interix 3.5 installs completely hosed .la files for C++, so rather than
-  # hack all around it, let's just trust "g++" to DTRT.
-  predep_objects_CXX=
-  postdep_objects_CXX=
-  postdeps_CXX=
-  ;;
-
-linux*)
-  case `$CC -V 2>&1 | sed 5q` in
-  *Sun\ C*)
-    # Sun C++ 5.9
-
-    # The more standards-conforming stlport4 library is
-    # incompatible with the Cstd library. Avoid specifying
-    # it if it's in CXXFLAGS. Ignore libCrun as
-    # -library=stlport4 depends on it.
-    case " $CXX $CXXFLAGS " in
-    *" -library=stlport4 "*)
-      solaris_use_stlport4=yes
-      ;;
-    esac
-
-    if test "$solaris_use_stlport4" != yes; then
-      postdeps_CXX='-library=Cstd -library=Crun'
-    fi
+# Extract the first word of "msgfmt", so it can be a program name with args.
+set dummy msgfmt; ac_word=$2
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
+if ${ac_cv_path_MSGFMT+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  case "$MSGFMT" in
+  [\\/]* | ?:[\\/]*)
+    ac_cv_path_MSGFMT="$MSGFMT" # Let the user override the test with a path.
     ;;
-  esac
-  ;;
-
-solaris*)
-  case $cc_basename in
-  CC* | sunCC*)
-    # The more standards-conforming stlport4 library is
-    # incompatible with the Cstd library. Avoid specifying
-    # it if it's in CXXFLAGS. Ignore libCrun as
-    # -library=stlport4 depends on it.
-    case " $CXX $CXXFLAGS " in
-    *" -library=stlport4 "*)
-      solaris_use_stlport4=yes
-      ;;
-    esac
-
-    # Adding this requires a known-good setup of shared libraries for
-    # Sun compiler versions before 5.6, else PIC objects from an old
-    # archive will be linked into the output, leading to subtle bugs.
-    if test "$solaris_use_stlport4" != yes; then
-      postdeps_CXX='-library=Cstd -library=Crun'
-    fi
+  *)
+    ac_save_IFS="$IFS"; IFS=$PATH_SEPARATOR
+    for ac_dir in $PATH; do
+      IFS="$ac_save_IFS"
+      test -z "$ac_dir" && ac_dir=.
+      for ac_exec_ext in '' $ac_executable_extensions; do
+        if $ac_executable_p "$ac_dir/$ac_word$ac_exec_ext"; then
+          echo "$as_me: trying $ac_dir/$ac_word..." >&5
+          if $ac_dir/$ac_word --statistics /dev/null >&5 2>&1 &&
+     (if $ac_dir/$ac_word --statistics /dev/null 2>&1 >/dev/null | grep usage >/dev/null; then exit 1; else exit 0; fi); then
+            ac_cv_path_MSGFMT="$ac_dir/$ac_word$ac_exec_ext"
+            break 2
+          fi
+        fi
+      done
+    done
+    IFS="$ac_save_IFS"
+  test -z "$ac_cv_path_MSGFMT" && ac_cv_path_MSGFMT=":"
     ;;
-  esac
-  ;;
 esac
+fi
+MSGFMT="$ac_cv_path_MSGFMT"
+if test "$MSGFMT" != ":"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $MSGFMT" >&5
+$as_echo "$MSGFMT" >&6; }
+else
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
+fi
 
+  # Extract the first word of "gmsgfmt", so it can be a program name with args.
+set dummy gmsgfmt; ac_word=$2
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
+if ${ac_cv_path_GMSGFMT+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  case $GMSGFMT in
+  [\\/]* | ?:[\\/]*)
+  ac_cv_path_GMSGFMT="$GMSGFMT" # Let the user override the test with a path.
+  ;;
+  *)
+  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+for as_dir in $PATH
+do
+  IFS=$as_save_IFS
+  test -z "$as_dir" && as_dir=.
+    for ac_exec_ext in '' $ac_executable_extensions; do
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+    ac_cv_path_GMSGFMT="$as_dir/$ac_word$ac_exec_ext"
+    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+    break 2
+  fi
+done
+  done
+IFS=$as_save_IFS
 
-case " $postdeps_CXX " in
-*" -lc "*) archive_cmds_need_lc_CXX=no ;;
+  test -z "$ac_cv_path_GMSGFMT" && ac_cv_path_GMSGFMT="$MSGFMT"
+  ;;
 esac
- compiler_lib_search_dirs_CXX=
-if test -n "${compiler_lib_search_path_CXX}"; then
- compiler_lib_search_dirs_CXX=`echo " ${compiler_lib_search_path_CXX}" | ${SED} -e 's! -L! !g' -e 's!^ !!'`
+fi
+GMSGFMT=$ac_cv_path_GMSGFMT
+if test -n "$GMSGFMT"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $GMSGFMT" >&5
+$as_echo "$GMSGFMT" >&6; }
+else
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
 fi
 
 
 
+    case `$MSGFMT --version | sed 1q | sed -e 's,^[^0-9]*,,'` in
+    '' | 0.[0-9] | 0.[0-9].* | 0.1[0-4] | 0.1[0-4].*) MSGFMT_015=: ;;
+    *) MSGFMT_015=$MSGFMT ;;
+  esac
 
+  case `$GMSGFMT --version | sed 1q | sed -e 's,^[^0-9]*,,'` in
+    '' | 0.[0-9] | 0.[0-9].* | 0.1[0-4] | 0.1[0-4].*) GMSGFMT_015=: ;;
+    *) GMSGFMT_015=$GMSGFMT ;;
+  esac
 
 
 
+# Prepare PATH_SEPARATOR.
+# The user is always right.
+if test "${PATH_SEPARATOR+set}" != set; then
+  echo "#! /bin/sh" >conf$$.sh
+  echo  "exit 0"   >>conf$$.sh
+  chmod +x conf$$.sh
+  if (PATH="/nonexistent;."; conf$$.sh) >/dev/null 2>&1; then
+    PATH_SEPARATOR=';'
+  else
+    PATH_SEPARATOR=:
+  fi
+  rm -f conf$$.sh
+fi
 
+# Find out how to test for executable files. Don't use a zero-byte file,
+# as systems may use methods other than mode bits to determine executability.
+cat >conf$$.file <<_ASEOF
+#! /bin/sh
+exit 0
+_ASEOF
+chmod +x conf$$.file
+if test -x conf$$.file >/dev/null 2>&1; then
+  ac_executable_p="test -x"
+else
+  ac_executable_p="test -f"
+fi
+rm -f conf$$.file
 
+# Extract the first word of "xgettext", so it can be a program name with args.
+set dummy xgettext; ac_word=$2
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
+if ${ac_cv_path_XGETTEXT+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  case "$XGETTEXT" in
+  [\\/]* | ?:[\\/]*)
+    ac_cv_path_XGETTEXT="$XGETTEXT" # Let the user override the test with a path.
+    ;;
+  *)
+    ac_save_IFS="$IFS"; IFS=$PATH_SEPARATOR
+    for ac_dir in $PATH; do
+      IFS="$ac_save_IFS"
+      test -z "$ac_dir" && ac_dir=.
+      for ac_exec_ext in '' $ac_executable_extensions; do
+        if $ac_executable_p "$ac_dir/$ac_word$ac_exec_ext"; then
+          echo "$as_me: trying $ac_dir/$ac_word..." >&5
+          if $ac_dir/$ac_word --omit-header --copyright-holder= --msgid-bugs-address= /dev/null >&5 2>&1 &&
+     (if $ac_dir/$ac_word --omit-header --copyright-holder= --msgid-bugs-address= /dev/null 2>&1 >/dev/null | grep usage >/dev/null; then exit 1; else exit 0; fi); then
+            ac_cv_path_XGETTEXT="$ac_dir/$ac_word$ac_exec_ext"
+            break 2
+          fi
+        fi
+      done
+    done
+    IFS="$ac_save_IFS"
+  test -z "$ac_cv_path_XGETTEXT" && ac_cv_path_XGETTEXT=":"
+    ;;
+esac
+fi
+XGETTEXT="$ac_cv_path_XGETTEXT"
+if test "$XGETTEXT" != ":"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $XGETTEXT" >&5
+$as_echo "$XGETTEXT" >&6; }
+else
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
+fi
 
+    rm -f messages.po
 
+    case `$XGETTEXT --version | sed 1q | sed -e 's,^[^0-9]*,,'` in
+    '' | 0.[0-9] | 0.[0-9].* | 0.1[0-4] | 0.1[0-4].*) XGETTEXT_015=: ;;
+    *) XGETTEXT_015=$XGETTEXT ;;
+  esac
 
 
 
+# Prepare PATH_SEPARATOR.
+# The user is always right.
+if test "${PATH_SEPARATOR+set}" != set; then
+  echo "#! /bin/sh" >conf$$.sh
+  echo  "exit 0"   >>conf$$.sh
+  chmod +x conf$$.sh
+  if (PATH="/nonexistent;."; conf$$.sh) >/dev/null 2>&1; then
+    PATH_SEPARATOR=';'
+  else
+    PATH_SEPARATOR=:
+  fi
+  rm -f conf$$.sh
+fi
 
+# Find out how to test for executable files. Don't use a zero-byte file,
+# as systems may use methods other than mode bits to determine executability.
+cat >conf$$.file <<_ASEOF
+#! /bin/sh
+exit 0
+_ASEOF
+chmod +x conf$$.file
+if test -x conf$$.file >/dev/null 2>&1; then
+  ac_executable_p="test -x"
+else
+  ac_executable_p="test -f"
+fi
+rm -f conf$$.file
 
+# Extract the first word of "msgmerge", so it can be a program name with args.
+set dummy msgmerge; ac_word=$2
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
+if ${ac_cv_path_MSGMERGE+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  case "$MSGMERGE" in
+  [\\/]* | ?:[\\/]*)
+    ac_cv_path_MSGMERGE="$MSGMERGE" # Let the user override the test with a path.
+    ;;
+  *)
+    ac_save_IFS="$IFS"; IFS=$PATH_SEPARATOR
+    for ac_dir in $PATH; do
+      IFS="$ac_save_IFS"
+      test -z "$ac_dir" && ac_dir=.
+      for ac_exec_ext in '' $ac_executable_extensions; do
+        if $ac_executable_p "$ac_dir/$ac_word$ac_exec_ext"; then
+          echo "$as_me: trying $ac_dir/$ac_word..." >&5
+          if $ac_dir/$ac_word --update -q /dev/null /dev/null >&5 2>&1; then
+            ac_cv_path_MSGMERGE="$ac_dir/$ac_word$ac_exec_ext"
+            break 2
+          fi
+        fi
+      done
+    done
+    IFS="$ac_save_IFS"
+  test -z "$ac_cv_path_MSGMERGE" && ac_cv_path_MSGMERGE=":"
+    ;;
+esac
+fi
+MSGMERGE="$ac_cv_path_MSGMERGE"
+if test "$MSGMERGE" != ":"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $MSGMERGE" >&5
+$as_echo "$MSGMERGE" >&6; }
+else
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
+fi
 
 
+        test -n "$localedir" || localedir='${datadir}/locale'
 
 
+    test -n "${XGETTEXT_EXTRA_OPTIONS+set}" || XGETTEXT_EXTRA_OPTIONS=
 
 
+  ac_config_commands="$ac_config_commands po-directories"
 
 
 
+      if test "X$prefix" = "XNONE"; then
+    acl_final_prefix="$ac_default_prefix"
+  else
+    acl_final_prefix="$prefix"
+  fi
+  if test "X$exec_prefix" = "XNONE"; then
+    acl_final_exec_prefix='${prefix}'
+  else
+    acl_final_exec_prefix="$exec_prefix"
+  fi
+  acl_save_prefix="$prefix"
+  prefix="$acl_final_prefix"
+  eval acl_final_exec_prefix=\"$acl_final_exec_prefix\"
+  prefix="$acl_save_prefix"
 
 
+# Check whether --with-gnu-ld was given.
+if test "${with_gnu_ld+set}" = set; then :
+  withval=$with_gnu_ld; test "$withval" = no || with_gnu_ld=yes
+else
+  with_gnu_ld=no
+fi
 
-
-
-
-    lt_prog_compiler_wl_CXX=
-lt_prog_compiler_pic_CXX=
-lt_prog_compiler_static_CXX=
-
-
-  # C++ specific cases for pic, static, wl, etc.
-  if test "$GXX" = yes; then
-    lt_prog_compiler_wl_CXX='-Wl,'
-    lt_prog_compiler_static_CXX='-static'
-
-    case $host_os in
-    aix*)
-      # All AIX code is PIC.
-      if test "$host_cpu" = ia64; then
-	# AIX 5 now supports IA64 processor
-	lt_prog_compiler_static_CXX='-Bstatic'
-      fi
-      ;;
-
-    amigaos*)
-      case $host_cpu in
-      powerpc)
-            # see comment about AmigaOS4 .so support
-            lt_prog_compiler_pic_CXX='-fPIC'
-        ;;
-      m68k)
-            # FIXME: we need at least 68020 code to build shared libraries, but
-            # adding the `-m68020' flag to GCC prevents building anything better,
-            # like `-m68040'.
-            lt_prog_compiler_pic_CXX='-m68020 -resident32 -malways-restore-a4'
-        ;;
-      esac
-      ;;
-
-    beos* | irix5* | irix6* | nonstopux* | osf3* | osf4* | osf5*)
-      # PIC is the default for these OSes.
-      ;;
-    mingw* | cygwin* | os2* | pw32* | cegcc*)
-      # This hack is so that the source file can tell whether it is being
-      # built for inclusion in a dll (and should export symbols for example).
-      # Although the cygwin gcc ignores -fPIC, still need this for old-style
-      # (--disable-auto-import) libraries
-      lt_prog_compiler_pic_CXX='-DDLL_EXPORT'
-      ;;
-    darwin* | rhapsody*)
-      # PIC is the default on this platform
-      # Common symbols not allowed in MH_DYLIB files
-      lt_prog_compiler_pic_CXX='-fno-common'
-      ;;
-    *djgpp*)
-      # DJGPP does not support shared libraries at all
-      lt_prog_compiler_pic_CXX=
-      ;;
-    haiku*)
-      # PIC is the default for Haiku.
-      # The "-static" flag exists, but is broken.
-      lt_prog_compiler_static_CXX=
-      ;;
-    interix[3-9]*)
-      # Interix 3.x gcc -fpic/-fPIC options generate broken code.
-      # Instead, we relocate shared libraries at runtime.
-      ;;
-    sysv4*MP*)
-      if test -d /usr/nec; then
-	lt_prog_compiler_pic_CXX=-Kconform_pic
-      fi
-      ;;
-    hpux*)
-      # PIC is the default for 64-bit PA HP-UX, but not for 32-bit
-      # PA HP-UX.  On IA64 HP-UX, PIC is the default but the pic flag
-      # sets the default TLS model and affects inlining.
-      case $host_cpu in
-      hppa*64*)
-	;;
-      *)
-	lt_prog_compiler_pic_CXX='-fPIC'
-	;;
-      esac
-      ;;
-    *qnx* | *nto*)
-      # QNX uses GNU C++, but need to define -shared option too, otherwise
-      # it will coredump.
-      lt_prog_compiler_pic_CXX='-fPIC -shared'
-      ;;
-    *)
-      lt_prog_compiler_pic_CXX='-fPIC'
-      ;;
-    esac
+# Prepare PATH_SEPARATOR.
+# The user is always right.
+if test "${PATH_SEPARATOR+set}" != set; then
+  echo "#! /bin/sh" >conf$$.sh
+  echo  "exit 0"   >>conf$$.sh
+  chmod +x conf$$.sh
+  if (PATH="/nonexistent;."; conf$$.sh) >/dev/null 2>&1; then
+    PATH_SEPARATOR=';'
   else
-    case $host_os in
-      aix[4-9]*)
-	# All AIX code is PIC.
-	if test "$host_cpu" = ia64; then
-	  # AIX 5 now supports IA64 processor
-	  lt_prog_compiler_static_CXX='-Bstatic'
-	else
-	  lt_prog_compiler_static_CXX='-bnso -bI:/lib/syscalls.exp'
-	fi
-	;;
-      chorus*)
-	case $cc_basename in
-	cxch68*)
-	  # Green Hills C++ Compiler
-	  # _LT_TAGVAR(lt_prog_compiler_static, CXX)="--no_auto_instantiation -u __main -u __premain -u _abort -r $COOL_DIR/lib/libOrb.a $MVME_DIR/lib/CC/libC.a $MVME_DIR/lib/classix/libcx.s.a"
-	  ;;
-	esac
-	;;
-      mingw* | cygwin* | os2* | pw32* | cegcc*)
-	# This hack is so that the source file can tell whether it is being
-	# built for inclusion in a dll (and should export symbols for example).
-	lt_prog_compiler_pic_CXX='-DDLL_EXPORT'
-	;;
-      dgux*)
-	case $cc_basename in
-	  ec++*)
-	    lt_prog_compiler_pic_CXX='-KPIC'
-	    ;;
-	  ghcx*)
-	    # Green Hills C++ Compiler
-	    lt_prog_compiler_pic_CXX='-pic'
-	    ;;
-	  *)
-	    ;;
-	esac
-	;;
-      freebsd* | dragonfly*)
-	# FreeBSD uses GNU C++
-	;;
-      hpux9* | hpux10* | hpux11*)
-	case $cc_basename in
-	  CC*)
-	    lt_prog_compiler_wl_CXX='-Wl,'
-	    lt_prog_compiler_static_CXX='${wl}-a ${wl}archive'
-	    if test "$host_cpu" != ia64; then
-	      lt_prog_compiler_pic_CXX='+Z'
-	    fi
-	    ;;
-	  aCC*)
-	    lt_prog_compiler_wl_CXX='-Wl,'
-	    lt_prog_compiler_static_CXX='${wl}-a ${wl}archive'
-	    case $host_cpu in
-	    hppa*64*|ia64*)
-	      # +Z the default
-	      ;;
-	    *)
-	      lt_prog_compiler_pic_CXX='+Z'
-	      ;;
-	    esac
-	    ;;
-	  *)
-	    ;;
-	esac
-	;;
-      interix*)
-	# This is c89, which is MS Visual C++ (no shared libs)
-	# Anyone wants to do a port?
-	;;
-      irix5* | irix6* | nonstopux*)
-	case $cc_basename in
-	  CC*)
-	    lt_prog_compiler_wl_CXX='-Wl,'
-	    lt_prog_compiler_static_CXX='-non_shared'
-	    # CC pic flag -KPIC is the default.
-	    ;;
-	  *)
-	    ;;
-	esac
-	;;
-      linux* | k*bsd*-gnu | kopensolaris*-gnu)
-	case $cc_basename in
-	  KCC*)
-	    # KAI C++ Compiler
-	    lt_prog_compiler_wl_CXX='--backend -Wl,'
-	    lt_prog_compiler_pic_CXX='-fPIC'
-	    ;;
-	  ecpc* )
-	    # old Intel C++ for x86_64 which still supported -KPIC.
-	    lt_prog_compiler_wl_CXX='-Wl,'
-	    lt_prog_compiler_pic_CXX='-KPIC'
-	    lt_prog_compiler_static_CXX='-static'
-	    ;;
-	  icpc* )
-	    # Intel C++, used to be incompatible with GCC.
-	    # ICC 10 doesn't accept -KPIC any more.
-	    lt_prog_compiler_wl_CXX='-Wl,'
-	    lt_prog_compiler_pic_CXX='-fPIC'
-	    lt_prog_compiler_static_CXX='-static'
-	    ;;
-	  pgCC* | pgcpp*)
-	    # Portland Group C++ compiler
-	    lt_prog_compiler_wl_CXX='-Wl,'
-	    lt_prog_compiler_pic_CXX='-fpic'
-	    lt_prog_compiler_static_CXX='-Bstatic'
-	    ;;
-	  cxx*)
-	    # Compaq C++
-	    # Make sure the PIC flag is empty.  It appears that all Alpha
-	    # Linux and Compaq Tru64 Unix objects are PIC.
-	    lt_prog_compiler_pic_CXX=
-	    lt_prog_compiler_static_CXX='-non_shared'
-	    ;;
-	  xlc* | xlC* | bgxl[cC]* | mpixl[cC]*)
-	    # IBM XL 8.0, 9.0 on PPC and BlueGene
-	    lt_prog_compiler_wl_CXX='-Wl,'
-	    lt_prog_compiler_pic_CXX='-qpic'
-	    lt_prog_compiler_static_CXX='-qstaticlink'
-	    ;;
-	  *)
-	    case `$CC -V 2>&1 | sed 5q` in
-	    *Sun\ C*)
-	      # Sun C++ 5.9
-	      lt_prog_compiler_pic_CXX='-KPIC'
-	      lt_prog_compiler_static_CXX='-Bstatic'
-	      lt_prog_compiler_wl_CXX='-Qoption ld '
-	      ;;
-	    esac
-	    ;;
-	esac
-	;;
-      lynxos*)
-	;;
-      m88k*)
-	;;
-      mvs*)
-	case $cc_basename in
-	  cxx*)
-	    lt_prog_compiler_pic_CXX='-W c,exportall'
-	    ;;
-	  *)
-	    ;;
-	esac
-	;;
-      netbsd*)
-	;;
-      *qnx* | *nto*)
-        # QNX uses GNU C++, but need to define -shared option too, otherwise
-        # it will coredump.
-        lt_prog_compiler_pic_CXX='-fPIC -shared'
-        ;;
-      osf3* | osf4* | osf5*)
-	case $cc_basename in
-	  KCC*)
-	    lt_prog_compiler_wl_CXX='--backend -Wl,'
-	    ;;
-	  RCC*)
-	    # Rational C++ 2.4.1
-	    lt_prog_compiler_pic_CXX='-pic'
-	    ;;
-	  cxx*)
-	    # Digital/Compaq C++
-	    lt_prog_compiler_wl_CXX='-Wl,'
-	    # Make sure the PIC flag is empty.  It appears that all Alpha
-	    # Linux and Compaq Tru64 Unix objects are PIC.
-	    lt_prog_compiler_pic_CXX=
-	    lt_prog_compiler_static_CXX='-non_shared'
-	    ;;
-	  *)
-	    ;;
-	esac
-	;;
-      psos*)
-	;;
-      solaris*)
-	case $cc_basename in
-	  CC* | sunCC*)
-	    # Sun C++ 4.2, 5.x and Centerline C++
-	    lt_prog_compiler_pic_CXX='-KPIC'
-	    lt_prog_compiler_static_CXX='-Bstatic'
-	    lt_prog_compiler_wl_CXX='-Qoption ld '
-	    ;;
-	  gcx*)
-	    # Green Hills C++ Compiler
-	    lt_prog_compiler_pic_CXX='-PIC'
-	    ;;
-	  *)
-	    ;;
-	esac
-	;;
-      sunos4*)
-	case $cc_basename in
-	  CC*)
-	    # Sun C++ 4.x
-	    lt_prog_compiler_pic_CXX='-pic'
-	    lt_prog_compiler_static_CXX='-Bstatic'
-	    ;;
-	  lcc*)
-	    # Lucid
-	    lt_prog_compiler_pic_CXX='-pic'
-	    ;;
-	  *)
-	    ;;
-	esac
-	;;
-      sysv5* | unixware* | sco3.2v5* | sco5v6* | OpenUNIX*)
-	case $cc_basename in
-	  CC*)
-	    lt_prog_compiler_wl_CXX='-Wl,'
-	    lt_prog_compiler_pic_CXX='-KPIC'
-	    lt_prog_compiler_static_CXX='-Bstatic'
-	    ;;
-	esac
-	;;
-      tandem*)
-	case $cc_basename in
-	  NCC*)
-	    # NonStop-UX NCC 3.20
-	    lt_prog_compiler_pic_CXX='-KPIC'
-	    ;;
-	  *)
-	    ;;
-	esac
-	;;
-      vxworks*)
-	;;
-      *)
-	lt_prog_compiler_can_build_shared_CXX=no
-	;;
-    esac
+    PATH_SEPARATOR=:
   fi
-
-case $host_os in
-  # For platforms which do not support PIC, -DPIC is meaningless:
-  *djgpp*)
-    lt_prog_compiler_pic_CXX=
+  rm -f conf$$.sh
+fi
+ac_prog=ld
+if test "$GCC" = yes; then
+  # Check if gcc -print-prog-name=ld gives a path.
+  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for ld used by GCC" >&5
+$as_echo_n "checking for ld used by GCC... " >&6; }
+  case $host in
+  *-*-mingw*)
+    # gcc leaves a trailing carriage return which upsets mingw
+    ac_prog=`($CC -print-prog-name=ld) 2>&5 | tr -d '\015'` ;;
+  *)
+    ac_prog=`($CC -print-prog-name=ld) 2>&5` ;;
+  esac
+  case $ac_prog in
+    # Accept absolute paths.
+    [\\/]* | [A-Za-z]:[\\/]*)
+      re_direlt='/[^/][^/]*/\.\./'
+      # Canonicalize the path of ld
+      ac_prog=`echo $ac_prog| sed 's%\\\\%/%g'`
+      while echo $ac_prog | grep "$re_direlt" > /dev/null 2>&1; do
+        ac_prog=`echo $ac_prog| sed "s%$re_direlt%/%"`
+      done
+      test -z "$LD" && LD="$ac_prog"
+      ;;
+  "")
+    # If it fails, then pretend we aren't using GCC.
+    ac_prog=ld
     ;;
   *)
-    lt_prog_compiler_pic_CXX="$lt_prog_compiler_pic_CXX -DPIC"
+    # If it is relative, then search for the first ld in PATH.
+    with_gnu_ld=unknown
     ;;
-esac
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $compiler option to produce PIC" >&5
-$as_echo_n "checking for $compiler option to produce PIC... " >&6; }
-if ${lt_cv_prog_compiler_pic_CXX+:} false; then :
-  $as_echo_n "(cached) " >&6
+  esac
+elif test "$with_gnu_ld" = yes; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GNU ld" >&5
+$as_echo_n "checking for GNU ld... " >&6; }
 else
-  lt_cv_prog_compiler_pic_CXX=$lt_prog_compiler_pic_CXX
+  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for non-GNU ld" >&5
+$as_echo_n "checking for non-GNU ld... " >&6; }
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_prog_compiler_pic_CXX" >&5
-$as_echo "$lt_cv_prog_compiler_pic_CXX" >&6; }
-lt_prog_compiler_pic_CXX=$lt_cv_prog_compiler_pic_CXX
-
-#
-# Check to make sure the PIC flag actually works.
-#
-if test -n "$lt_prog_compiler_pic_CXX"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking if $compiler PIC flag $lt_prog_compiler_pic_CXX works" >&5
-$as_echo_n "checking if $compiler PIC flag $lt_prog_compiler_pic_CXX works... " >&6; }
-if ${lt_cv_prog_compiler_pic_works_CXX+:} false; then :
+if ${acl_cv_path_LD+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  lt_cv_prog_compiler_pic_works_CXX=no
-   ac_outfile=conftest.$ac_objext
-   echo "$lt_simple_compile_test_code" > conftest.$ac_ext
-   lt_compiler_flag="$lt_prog_compiler_pic_CXX -DPIC"
-   # Insert the option either (1) after the last *FLAGS variable, or
-   # (2) before a word containing "conftest.", or (3) at the end.
-   # Note that $ac_compile itself does not contain backslashes and begins
-   # with a dollar sign (not a hyphen), so the echo should work correctly.
-   # The option is referenced via a variable to avoid confusing sed.
-   lt_compile=`echo "$ac_compile" | $SED \
-   -e 's:.*FLAGS}\{0,1\} :&$lt_compiler_flag :; t' \
-   -e 's: [^ ]*conftest\.: $lt_compiler_flag&:; t' \
-   -e 's:$: $lt_compiler_flag:'`
-   (eval echo "\"\$as_me:$LINENO: $lt_compile\"" >&5)
-   (eval "$lt_compile" 2>conftest.err)
-   ac_status=$?
-   cat conftest.err >&5
-   echo "$as_me:$LINENO: \$? = $ac_status" >&5
-   if (exit $ac_status) && test -s "$ac_outfile"; then
-     # The compiler can only warn and ignore the option if not recognized
-     # So say no if there are warnings other than the usual output.
-     $ECHO "$_lt_compiler_boilerplate" | $SED '/^$/d' >conftest.exp
-     $SED '/^$/d; /^ *+/d' conftest.err >conftest.er2
-     if test ! -s conftest.er2 || diff conftest.exp conftest.er2 >/dev/null; then
-       lt_cv_prog_compiler_pic_works_CXX=yes
-     fi
-   fi
-   $RM conftest*
-
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_prog_compiler_pic_works_CXX" >&5
-$as_echo "$lt_cv_prog_compiler_pic_works_CXX" >&6; }
-
-if test x"$lt_cv_prog_compiler_pic_works_CXX" = xyes; then
-    case $lt_prog_compiler_pic_CXX in
-     "" | " "*) ;;
-     *) lt_prog_compiler_pic_CXX=" $lt_prog_compiler_pic_CXX" ;;
-     esac
+  if test -z "$LD"; then
+  IFS="${IFS= 	}"; ac_save_ifs="$IFS"; IFS="${IFS}${PATH_SEPARATOR-:}"
+  for ac_dir in $PATH; do
+    test -z "$ac_dir" && ac_dir=.
+    if test -f "$ac_dir/$ac_prog" || test -f "$ac_dir/$ac_prog$ac_exeext"; then
+      acl_cv_path_LD="$ac_dir/$ac_prog"
+      # Check to see if the program is GNU ld.  I'd rather use --version,
+      # but apparently some GNU ld's only accept -v.
+      # Break only if it was the GNU/non-GNU ld that we prefer.
+      case `"$acl_cv_path_LD" -v 2>&1 < /dev/null` in
+      *GNU* | *'with BFD'*)
+        test "$with_gnu_ld" != no && break ;;
+      *)
+        test "$with_gnu_ld" != yes && break ;;
+      esac
+    fi
+  done
+  IFS="$ac_save_ifs"
 else
-    lt_prog_compiler_pic_CXX=
-     lt_prog_compiler_can_build_shared_CXX=no
+  acl_cv_path_LD="$LD" # Let the user override the test with a path.
 fi
-
 fi
 
-
-
-
-
-#
-# Check to make sure the static flag actually works.
-#
-wl=$lt_prog_compiler_wl_CXX eval lt_tmp_static_flag=\"$lt_prog_compiler_static_CXX\"
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking if $compiler static flag $lt_tmp_static_flag works" >&5
-$as_echo_n "checking if $compiler static flag $lt_tmp_static_flag works... " >&6; }
-if ${lt_cv_prog_compiler_static_works_CXX+:} false; then :
-  $as_echo_n "(cached) " >&6
+LD="$acl_cv_path_LD"
+if test -n "$LD"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $LD" >&5
+$as_echo "$LD" >&6; }
 else
-  lt_cv_prog_compiler_static_works_CXX=no
-   save_LDFLAGS="$LDFLAGS"
-   LDFLAGS="$LDFLAGS $lt_tmp_static_flag"
-   echo "$lt_simple_link_test_code" > conftest.$ac_ext
-   if (eval $ac_link 2>conftest.err) && test -s conftest$ac_exeext; then
-     # The linker can only warn and ignore the option if not recognized
-     # So say no if there are warnings
-     if test -s conftest.err; then
-       # Append any errors to the config.log.
-       cat conftest.err 1>&5
-       $ECHO "$_lt_linker_boilerplate" | $SED '/^$/d' > conftest.exp
-       $SED '/^$/d; /^ *+/d' conftest.err >conftest.er2
-       if diff conftest.exp conftest.er2 >/dev/null; then
-         lt_cv_prog_compiler_static_works_CXX=yes
-       fi
-     else
-       lt_cv_prog_compiler_static_works_CXX=yes
-     fi
-   fi
-   $RM -r conftest*
-   LDFLAGS="$save_LDFLAGS"
-
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_prog_compiler_static_works_CXX" >&5
-$as_echo "$lt_cv_prog_compiler_static_works_CXX" >&6; }
-
-if test x"$lt_cv_prog_compiler_static_works_CXX" = xyes; then
-    :
+test -z "$LD" && as_fn_error $? "no acceptable ld found in \$PATH" "$LINENO" 5
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking if the linker ($LD) is GNU ld" >&5
+$as_echo_n "checking if the linker ($LD) is GNU ld... " >&6; }
+if ${acl_cv_prog_gnu_ld+:} false; then :
+  $as_echo_n "(cached) " >&6
 else
-    lt_prog_compiler_static_CXX=
+  # I'd rather use --version here, but apparently some GNU ld's only accept -v.
+case `$LD -v 2>&1 </dev/null` in
+*GNU* | *'with BFD'*)
+  acl_cv_prog_gnu_ld=yes ;;
+*)
+  acl_cv_prog_gnu_ld=no ;;
+esac
 fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $acl_cv_prog_gnu_ld" >&5
+$as_echo "$acl_cv_prog_gnu_ld" >&6; }
+with_gnu_ld=$acl_cv_prog_gnu_ld
 
 
 
 
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking if $compiler supports -c -o file.$ac_objext" >&5
-$as_echo_n "checking if $compiler supports -c -o file.$ac_objext... " >&6; }
-if ${lt_cv_prog_compiler_c_o_CXX+:} false; then :
+                                                { $as_echo "$as_me:${as_lineno-$LINENO}: checking for shared library run path origin" >&5
+$as_echo_n "checking for shared library run path origin... " >&6; }
+if ${acl_cv_rpath+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  lt_cv_prog_compiler_c_o_CXX=no
-   $RM -r conftest 2>/dev/null
-   mkdir conftest
-   cd conftest
-   mkdir out
-   echo "$lt_simple_compile_test_code" > conftest.$ac_ext
 
-   lt_compiler_flag="-o out/conftest2.$ac_objext"
-   # Insert the option either (1) after the last *FLAGS variable, or
-   # (2) before a word containing "conftest.", or (3) at the end.
-   # Note that $ac_compile itself does not contain backslashes and begins
-   # with a dollar sign (not a hyphen), so the echo should work correctly.
-   lt_compile=`echo "$ac_compile" | $SED \
-   -e 's:.*FLAGS}\{0,1\} :&$lt_compiler_flag :; t' \
-   -e 's: [^ ]*conftest\.: $lt_compiler_flag&:; t' \
-   -e 's:$: $lt_compiler_flag:'`
-   (eval echo "\"\$as_me:$LINENO: $lt_compile\"" >&5)
-   (eval "$lt_compile" 2>out/conftest.err)
-   ac_status=$?
-   cat out/conftest.err >&5
-   echo "$as_me:$LINENO: \$? = $ac_status" >&5
-   if (exit $ac_status) && test -s out/conftest2.$ac_objext
-   then
-     # The compiler can only warn and ignore the option if not recognized
-     # So say no if there are warnings
-     $ECHO "$_lt_compiler_boilerplate" | $SED '/^$/d' > out/conftest.exp
-     $SED '/^$/d; /^ *+/d' out/conftest.err >out/conftest.er2
-     if test ! -s out/conftest.er2 || diff out/conftest.exp out/conftest.er2 >/dev/null; then
-       lt_cv_prog_compiler_c_o_CXX=yes
-     fi
-   fi
-   chmod u+w . 2>&5
-   $RM conftest*
-   # SGI C++ compiler will create directory out/ii_files/ for
-   # template instantiation
-   test -d out/ii_files && $RM out/ii_files/* && rmdir out/ii_files
-   $RM out/* && rmdir out
-   cd ..
-   $RM -r conftest
-   $RM conftest*
+    CC="$CC" GCC="$GCC" LDFLAGS="$LDFLAGS" LD="$LD" with_gnu_ld="$with_gnu_ld" \
+    ${CONFIG_SHELL-/bin/sh} "$ac_aux_dir/config.rpath" "$host" > conftest.sh
+    . ./conftest.sh
+    rm -f ./conftest.sh
+    acl_cv_rpath=done
 
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_prog_compiler_c_o_CXX" >&5
-$as_echo "$lt_cv_prog_compiler_c_o_CXX" >&6; }
-
-
-
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking if $compiler supports -c -o file.$ac_objext" >&5
-$as_echo_n "checking if $compiler supports -c -o file.$ac_objext... " >&6; }
-if ${lt_cv_prog_compiler_c_o_CXX+:} false; then :
-  $as_echo_n "(cached) " >&6
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $acl_cv_rpath" >&5
+$as_echo "$acl_cv_rpath" >&6; }
+  wl="$acl_cv_wl"
+  acl_libext="$acl_cv_libext"
+  acl_shlibext="$acl_cv_shlibext"
+  acl_libname_spec="$acl_cv_libname_spec"
+  acl_library_names_spec="$acl_cv_library_names_spec"
+  acl_hardcode_libdir_flag_spec="$acl_cv_hardcode_libdir_flag_spec"
+  acl_hardcode_libdir_separator="$acl_cv_hardcode_libdir_separator"
+  acl_hardcode_direct="$acl_cv_hardcode_direct"
+  acl_hardcode_minus_L="$acl_cv_hardcode_minus_L"
+    # Check whether --enable-rpath was given.
+if test "${enable_rpath+set}" = set; then :
+  enableval=$enable_rpath; :
 else
-  lt_cv_prog_compiler_c_o_CXX=no
-   $RM -r conftest 2>/dev/null
-   mkdir conftest
-   cd conftest
-   mkdir out
-   echo "$lt_simple_compile_test_code" > conftest.$ac_ext
-
-   lt_compiler_flag="-o out/conftest2.$ac_objext"
-   # Insert the option either (1) after the last *FLAGS variable, or
-   # (2) before a word containing "conftest.", or (3) at the end.
-   # Note that $ac_compile itself does not contain backslashes and begins
-   # with a dollar sign (not a hyphen), so the echo should work correctly.
-   lt_compile=`echo "$ac_compile" | $SED \
-   -e 's:.*FLAGS}\{0,1\} :&$lt_compiler_flag :; t' \
-   -e 's: [^ ]*conftest\.: $lt_compiler_flag&:; t' \
-   -e 's:$: $lt_compiler_flag:'`
-   (eval echo "\"\$as_me:$LINENO: $lt_compile\"" >&5)
-   (eval "$lt_compile" 2>out/conftest.err)
-   ac_status=$?
-   cat out/conftest.err >&5
-   echo "$as_me:$LINENO: \$? = $ac_status" >&5
-   if (exit $ac_status) && test -s out/conftest2.$ac_objext
-   then
-     # The compiler can only warn and ignore the option if not recognized
-     # So say no if there are warnings
-     $ECHO "$_lt_compiler_boilerplate" | $SED '/^$/d' > out/conftest.exp
-     $SED '/^$/d; /^ *+/d' out/conftest.err >out/conftest.er2
-     if test ! -s out/conftest.er2 || diff out/conftest.exp out/conftest.er2 >/dev/null; then
-       lt_cv_prog_compiler_c_o_CXX=yes
-     fi
-   fi
-   chmod u+w . 2>&5
-   $RM conftest*
-   # SGI C++ compiler will create directory out/ii_files/ for
-   # template instantiation
-   test -d out/ii_files && $RM out/ii_files/* && rmdir out/ii_files
-   $RM out/* && rmdir out
-   cd ..
-   $RM -r conftest
-   $RM conftest*
-
+  enable_rpath=yes
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_prog_compiler_c_o_CXX" >&5
-$as_echo "$lt_cv_prog_compiler_c_o_CXX" >&6; }
 
 
 
 
-hard_links="nottested"
-if test "$lt_cv_prog_compiler_c_o_CXX" = no && test "$need_locks" != no; then
-  # do not overwrite the value of need_locks provided by the user
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking if we can lock with hard links" >&5
-$as_echo_n "checking if we can lock with hard links... " >&6; }
-  hard_links=yes
-  $RM conftest*
-  ln conftest.a conftest.b 2>/dev/null && hard_links=no
-  touch conftest.a
-  ln conftest.a conftest.b 2>&5 || hard_links=no
-  ln conftest.a conftest.b 2>/dev/null && hard_links=no
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $hard_links" >&5
-$as_echo "$hard_links" >&6; }
-  if test "$hard_links" = no; then
-    { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: \`$CC' does not support \`-c -o', so \`make -j' may be unsafe" >&5
-$as_echo "$as_me: WARNING: \`$CC' does not support \`-c -o', so \`make -j' may be unsafe" >&2;}
-    need_locks=warn
-  fi
+  acl_libdirstem=lib
+  acl_libdirstem2=
+  case "$host_os" in
+    solaris*)
+                                    { $as_echo "$as_me:${as_lineno-$LINENO}: checking for 64-bit host" >&5
+$as_echo_n "checking for 64-bit host... " >&6; }
+if ${gl_cv_solaris_64bit+:} false; then :
+  $as_echo_n "(cached) " >&6
 else
-  need_locks=no
-fi
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
 
+#ifdef _LP64
+sixtyfour bits
+#endif
 
+_ACEOF
+if (eval "$ac_cpp conftest.$ac_ext") 2>&5 |
+  $EGREP "sixtyfour bits" >/dev/null 2>&1; then :
+  gl_cv_solaris_64bit=yes
+else
+  gl_cv_solaris_64bit=no
+fi
+rm -f conftest*
 
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether the $compiler linker ($LD) supports shared libraries" >&5
-$as_echo_n "checking whether the $compiler linker ($LD) supports shared libraries... " >&6; }
 
-  export_symbols_cmds_CXX='$NM $libobjs $convenience | $global_symbol_pipe | $SED '\''s/.* //'\'' | sort | uniq > $export_symbols'
-  exclude_expsyms_CXX='_GLOBAL_OFFSET_TABLE_|_GLOBAL__F[ID]_.*'
-  case $host_os in
-  aix[4-9]*)
-    # If we're using GNU nm, then we don't want the "-C" option.
-    # -C means demangle to AIX nm, but means don't demangle with GNU nm
-    # Also, AIX nm treats weak defined symbols like other global defined
-    # symbols, whereas GNU nm marks them as "W".
-    if $NM -V 2>&1 | $GREP 'GNU' > /dev/null; then
-      export_symbols_cmds_CXX='$NM -Bpg $libobjs $convenience | awk '\''{ if (((\$ 2 == "T") || (\$ 2 == "D") || (\$ 2 == "B") || (\$ 2 == "W")) && (substr(\$ 3,1,1) != ".")) { print \$ 3 } }'\'' | sort -u > $export_symbols'
-    else
-      export_symbols_cmds_CXX='$NM -BCpg $libobjs $convenience | awk '\''{ if (((\$ 2 == "T") || (\$ 2 == "D") || (\$ 2 == "B")) && (substr(\$ 3,1,1) != ".")) { print \$ 3 } }'\'' | sort -u > $export_symbols'
-    fi
-    ;;
-  pw32*)
-    export_symbols_cmds_CXX="$ltdll_cmds"
-    ;;
-  cygwin* | mingw* | cegcc*)
-    case $cc_basename in
-    cl*) ;;
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $gl_cv_solaris_64bit" >&5
+$as_echo "$gl_cv_solaris_64bit" >&6; }
+      if test $gl_cv_solaris_64bit = yes; then
+        acl_libdirstem=lib/64
+        case "$host_cpu" in
+          sparc*)        acl_libdirstem2=lib/sparcv9 ;;
+          i*86 | x86_64) acl_libdirstem2=lib/amd64 ;;
+        esac
+      fi
+      ;;
     *)
-      export_symbols_cmds_CXX='$NM $libobjs $convenience | $global_symbol_pipe | $SED -e '\''/^[BCDGRS][ ]/s/.*[ ]\([^ ]*\)/\1 DATA/;s/^.*[ ]__nm__\([^ ]*\)[ ][^ ]*/\1 DATA/;/^I[ ]/d;/^[AITW][ ]/s/.* //'\'' | sort | uniq > $export_symbols'
-      exclude_expsyms_CXX='[_]+GLOBAL_OFFSET_TABLE_|[_]+GLOBAL__[FID]_.*|[_]+head_[A-Za-z0-9_]+_dll|[A-Za-z0-9_]+_dll_iname'
+      searchpath=`(LC_ALL=C $CC -print-search-dirs) 2>/dev/null | sed -n -e 's,^libraries: ,,p' | sed -e 's,^=,,'`
+      if test -n "$searchpath"; then
+        acl_save_IFS="${IFS= 	}"; IFS=":"
+        for searchdir in $searchpath; do
+          if test -d "$searchdir"; then
+            case "$searchdir" in
+              */lib64/ | */lib64 ) acl_libdirstem=lib64 ;;
+              */../ | */.. )
+                # Better ignore directories of this form. They are misleading.
+                ;;
+              *) searchdir=`cd "$searchdir" && pwd`
+                 case "$searchdir" in
+                   */lib64 ) acl_libdirstem=lib64 ;;
+                 esac ;;
+            esac
+          fi
+        done
+        IFS="$acl_save_IFS"
+      fi
       ;;
-    esac
-    ;;
-  *)
-    export_symbols_cmds_CXX='$NM $libobjs $convenience | $global_symbol_pipe | $SED '\''s/.* //'\'' | sort | uniq > $export_symbols'
-    ;;
   esac
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ld_shlibs_CXX" >&5
-$as_echo "$ld_shlibs_CXX" >&6; }
-test "$ld_shlibs_CXX" = no && can_build_shared=no
-
-with_gnu_ld_CXX=$with_gnu_ld
-
-
-
-
+  test -n "$acl_libdirstem2" || acl_libdirstem2="$acl_libdirstem"
 
 
-#
-# Do we need to explicitly link libc?
-#
-case "x$archive_cmds_need_lc_CXX" in
-x|xyes)
-  # Assume -lc should be added
-  archive_cmds_need_lc_CXX=yes
 
-  if test "$enable_shared" = yes && test "$GCC" = yes; then
-    case $archive_cmds_CXX in
-    *'~'*)
-      # FIXME: we may have to deal with multi-command sequences.
-      ;;
-    '$CC '*)
-      # Test whether the compiler implicitly links with -lc since on some
-      # systems, -lgcc has to come before -lc. If gcc already passes -lc
-      # to ld, don't add -lc before -lgcc.
-      { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether -lc should be explicitly linked in" >&5
-$as_echo_n "checking whether -lc should be explicitly linked in... " >&6; }
-if ${lt_cv_archive_cmds_need_lc_CXX+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  $RM conftest*
-	echo "$lt_simple_compile_test_code" > conftest.$ac_ext
-
-	if { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_compile\""; } >&5
-  (eval $ac_compile) 2>&5
-  ac_status=$?
-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; } 2>conftest.err; then
-	  soname=conftest
-	  lib=conftest
-	  libobjs=conftest.$ac_objext
-	  deplibs=
-	  wl=$lt_prog_compiler_wl_CXX
-	  pic_flag=$lt_prog_compiler_pic_CXX
-	  compiler_flags=-v
-	  linker_flags=-v
-	  verstring=
-	  output_objdir=.
-	  libname=conftest
-	  lt_save_allow_undefined_flag=$allow_undefined_flag_CXX
-	  allow_undefined_flag_CXX=
-	  if { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$archive_cmds_CXX 2\>\&1 \| $GREP \" -lc \" \>/dev/null 2\>\&1\""; } >&5
-  (eval $archive_cmds_CXX 2\>\&1 \| $GREP \" -lc \" \>/dev/null 2\>\&1) 2>&5
-  ac_status=$?
-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; }
-	  then
-	    lt_cv_archive_cmds_need_lc_CXX=no
-	  else
-	    lt_cv_archive_cmds_need_lc_CXX=yes
-	  fi
-	  allow_undefined_flag_CXX=$lt_save_allow_undefined_flag
-	else
-	  cat conftest.err 1>&5
-	fi
-	$RM conftest*
-
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_archive_cmds_need_lc_CXX" >&5
-$as_echo "$lt_cv_archive_cmds_need_lc_CXX" >&6; }
-      archive_cmds_need_lc_CXX=$lt_cv_archive_cmds_need_lc_CXX
-      ;;
-    esac
-  fi
-  ;;
-esac
 
 
 
@@ -15088,27 +12826,454 @@
 
 
 
+    use_additional=yes
 
+  acl_save_prefix="$prefix"
+  prefix="$acl_final_prefix"
+  acl_save_exec_prefix="$exec_prefix"
+  exec_prefix="$acl_final_exec_prefix"
 
+    eval additional_includedir=\"$includedir\"
+    eval additional_libdir=\"$libdir\"
 
+  exec_prefix="$acl_save_exec_prefix"
+  prefix="$acl_save_prefix"
 
 
+# Check whether --with-libiconv-prefix was given.
+if test "${with_libiconv_prefix+set}" = set; then :
+  withval=$with_libiconv_prefix;
+    if test "X$withval" = "Xno"; then
+      use_additional=no
+    else
+      if test "X$withval" = "X"; then
 
+  acl_save_prefix="$prefix"
+  prefix="$acl_final_prefix"
+  acl_save_exec_prefix="$exec_prefix"
+  exec_prefix="$acl_final_exec_prefix"
 
+          eval additional_includedir=\"$includedir\"
+          eval additional_libdir=\"$libdir\"
 
+  exec_prefix="$acl_save_exec_prefix"
+  prefix="$acl_save_prefix"
 
+      else
+        additional_includedir="$withval/include"
+        additional_libdir="$withval/$acl_libdirstem"
+        if test "$acl_libdirstem2" != "$acl_libdirstem" \
+           && ! test -d "$withval/$acl_libdirstem"; then
+          additional_libdir="$withval/$acl_libdirstem2"
+        fi
+      fi
+    fi
 
+fi
 
+      LIBICONV=
+  LTLIBICONV=
+  INCICONV=
+  LIBICONV_PREFIX=
+      HAVE_LIBICONV=
+  rpathdirs=
+  ltrpathdirs=
+  names_already_handled=
+  names_next_round='iconv '
+  while test -n "$names_next_round"; do
+    names_this_round="$names_next_round"
+    names_next_round=
+    for name in $names_this_round; do
+      already_handled=
+      for n in $names_already_handled; do
+        if test "$n" = "$name"; then
+          already_handled=yes
+          break
+        fi
+      done
+      if test -z "$already_handled"; then
+        names_already_handled="$names_already_handled $name"
+                        uppername=`echo "$name" | sed -e 'y|abcdefghijklmnopqrstuvwxyz./-|ABCDEFGHIJKLMNOPQRSTUVWXYZ___|'`
+        eval value=\"\$HAVE_LIB$uppername\"
+        if test -n "$value"; then
+          if test "$value" = yes; then
+            eval value=\"\$LIB$uppername\"
+            test -z "$value" || LIBICONV="${LIBICONV}${LIBICONV:+ }$value"
+            eval value=\"\$LTLIB$uppername\"
+            test -z "$value" || LTLIBICONV="${LTLIBICONV}${LTLIBICONV:+ }$value"
+          else
+                                    :
+          fi
+        else
+                              found_dir=
+          found_la=
+          found_so=
+          found_a=
+          eval libname=\"$acl_libname_spec\"    # typically: libname=lib$name
+          if test -n "$acl_shlibext"; then
+            shrext=".$acl_shlibext"             # typically: shrext=.so
+          else
+            shrext=
+          fi
+          if test $use_additional = yes; then
+            dir="$additional_libdir"
+                                    if test -n "$acl_shlibext"; then
+              if test -f "$dir/$libname$shrext"; then
+                found_dir="$dir"
+                found_so="$dir/$libname$shrext"
+              else
+                if test "$acl_library_names_spec" = '$libname$shrext$versuffix'; then
+                  ver=`(cd "$dir" && \
+                        for f in "$libname$shrext".*; do echo "$f"; done \
+                        | sed -e "s,^$libname$shrext\\\\.,," \
+                        | sort -t '.' -n -r -k1,1 -k2,2 -k3,3 -k4,4 -k5,5 \
+                        | sed 1q ) 2>/dev/null`
+                  if test -n "$ver" && test -f "$dir/$libname$shrext.$ver"; then
+                    found_dir="$dir"
+                    found_so="$dir/$libname$shrext.$ver"
+                  fi
+                else
+                  eval library_names=\"$acl_library_names_spec\"
+                  for f in $library_names; do
+                    if test -f "$dir/$f"; then
+                      found_dir="$dir"
+                      found_so="$dir/$f"
+                      break
+                    fi
+                  done
+                fi
+              fi
+            fi
+                        if test "X$found_dir" = "X"; then
+              if test -f "$dir/$libname.$acl_libext"; then
+                found_dir="$dir"
+                found_a="$dir/$libname.$acl_libext"
+              fi
+            fi
+            if test "X$found_dir" != "X"; then
+              if test -f "$dir/$libname.la"; then
+                found_la="$dir/$libname.la"
+              fi
+            fi
+          fi
+          if test "X$found_dir" = "X"; then
+            for x in $LDFLAGS $LTLIBICONV; do
 
+  acl_save_prefix="$prefix"
+  prefix="$acl_final_prefix"
+  acl_save_exec_prefix="$exec_prefix"
+  exec_prefix="$acl_final_exec_prefix"
+  eval x=\"$x\"
+  exec_prefix="$acl_save_exec_prefix"
+  prefix="$acl_save_prefix"
 
+              case "$x" in
+                -L*)
+                  dir=`echo "X$x" | sed -e 's/^X-L//'`
+                                    if test -n "$acl_shlibext"; then
+                    if test -f "$dir/$libname$shrext"; then
+                      found_dir="$dir"
+                      found_so="$dir/$libname$shrext"
+                    else
+                      if test "$acl_library_names_spec" = '$libname$shrext$versuffix'; then
+                        ver=`(cd "$dir" && \
+                              for f in "$libname$shrext".*; do echo "$f"; done \
+                              | sed -e "s,^$libname$shrext\\\\.,," \
+                              | sort -t '.' -n -r -k1,1 -k2,2 -k3,3 -k4,4 -k5,5 \
+                              | sed 1q ) 2>/dev/null`
+                        if test -n "$ver" && test -f "$dir/$libname$shrext.$ver"; then
+                          found_dir="$dir"
+                          found_so="$dir/$libname$shrext.$ver"
+                        fi
+                      else
+                        eval library_names=\"$acl_library_names_spec\"
+                        for f in $library_names; do
+                          if test -f "$dir/$f"; then
+                            found_dir="$dir"
+                            found_so="$dir/$f"
+                            break
+                          fi
+                        done
+                      fi
+                    fi
+                  fi
+                                    if test "X$found_dir" = "X"; then
+                    if test -f "$dir/$libname.$acl_libext"; then
+                      found_dir="$dir"
+                      found_a="$dir/$libname.$acl_libext"
+                    fi
+                  fi
+                  if test "X$found_dir" != "X"; then
+                    if test -f "$dir/$libname.la"; then
+                      found_la="$dir/$libname.la"
+                    fi
+                  fi
+                  ;;
+              esac
+              if test "X$found_dir" != "X"; then
+                break
+              fi
+            done
+          fi
+          if test "X$found_dir" != "X"; then
+                        LTLIBICONV="${LTLIBICONV}${LTLIBICONV:+ }-L$found_dir -l$name"
+            if test "X$found_so" != "X"; then
+                                                        if test "$enable_rpath" = no \
+                 || test "X$found_dir" = "X/usr/$acl_libdirstem" \
+                 || test "X$found_dir" = "X/usr/$acl_libdirstem2"; then
+                                LIBICONV="${LIBICONV}${LIBICONV:+ }$found_so"
+              else
+                                                                                haveit=
+                for x in $ltrpathdirs; do
+                  if test "X$x" = "X$found_dir"; then
+                    haveit=yes
+                    break
+                  fi
+                done
+                if test -z "$haveit"; then
+                  ltrpathdirs="$ltrpathdirs $found_dir"
+                fi
+                                if test "$acl_hardcode_direct" = yes; then
+                                                      LIBICONV="${LIBICONV}${LIBICONV:+ }$found_so"
+                else
+                  if test -n "$acl_hardcode_libdir_flag_spec" && test "$acl_hardcode_minus_L" = no; then
+                                                            LIBICONV="${LIBICONV}${LIBICONV:+ }$found_so"
+                                                            haveit=
+                    for x in $rpathdirs; do
+                      if test "X$x" = "X$found_dir"; then
+                        haveit=yes
+                        break
+                      fi
+                    done
+                    if test -z "$haveit"; then
+                      rpathdirs="$rpathdirs $found_dir"
+                    fi
+                  else
+                                                                                haveit=
+                    for x in $LDFLAGS $LIBICONV; do
 
+  acl_save_prefix="$prefix"
+  prefix="$acl_final_prefix"
+  acl_save_exec_prefix="$exec_prefix"
+  exec_prefix="$acl_final_exec_prefix"
+  eval x=\"$x\"
+  exec_prefix="$acl_save_exec_prefix"
+  prefix="$acl_save_prefix"
 
+                      if test "X$x" = "X-L$found_dir"; then
+                        haveit=yes
+                        break
+                      fi
+                    done
+                    if test -z "$haveit"; then
+                      LIBICONV="${LIBICONV}${LIBICONV:+ }-L$found_dir"
+                    fi
+                    if test "$acl_hardcode_minus_L" != no; then
+                                                                                        LIBICONV="${LIBICONV}${LIBICONV:+ }$found_so"
+                    else
+                                                                                                                                                                                LIBICONV="${LIBICONV}${LIBICONV:+ }-l$name"
+                    fi
+                  fi
+                fi
+              fi
+            else
+              if test "X$found_a" != "X"; then
+                                LIBICONV="${LIBICONV}${LIBICONV:+ }$found_a"
+              else
+                                                LIBICONV="${LIBICONV}${LIBICONV:+ }-L$found_dir -l$name"
+              fi
+            fi
+                        additional_includedir=
+            case "$found_dir" in
+              */$acl_libdirstem | */$acl_libdirstem/)
+                basedir=`echo "X$found_dir" | sed -e 's,^X,,' -e "s,/$acl_libdirstem/"'*$,,'`
+                if test "$name" = 'iconv'; then
+                  LIBICONV_PREFIX="$basedir"
+                fi
+                additional_includedir="$basedir/include"
+                ;;
+              */$acl_libdirstem2 | */$acl_libdirstem2/)
+                basedir=`echo "X$found_dir" | sed -e 's,^X,,' -e "s,/$acl_libdirstem2/"'*$,,'`
+                if test "$name" = 'iconv'; then
+                  LIBICONV_PREFIX="$basedir"
+                fi
+                additional_includedir="$basedir/include"
+                ;;
+            esac
+            if test "X$additional_includedir" != "X"; then
+                                                                                                                if test "X$additional_includedir" != "X/usr/include"; then
+                haveit=
+                if test "X$additional_includedir" = "X/usr/local/include"; then
+                  if test -n "$GCC"; then
+                    case $host_os in
+                      linux* | gnu* | k*bsd*-gnu) haveit=yes;;
+                    esac
+                  fi
+                fi
+                if test -z "$haveit"; then
+                  for x in $CPPFLAGS $INCICONV; do
 
+  acl_save_prefix="$prefix"
+  prefix="$acl_final_prefix"
+  acl_save_exec_prefix="$exec_prefix"
+  exec_prefix="$acl_final_exec_prefix"
+  eval x=\"$x\"
+  exec_prefix="$acl_save_exec_prefix"
+  prefix="$acl_save_prefix"
 
+                    if test "X$x" = "X-I$additional_includedir"; then
+                      haveit=yes
+                      break
+                    fi
+                  done
+                  if test -z "$haveit"; then
+                    if test -d "$additional_includedir"; then
+                                            INCICONV="${INCICONV}${INCICONV:+ }-I$additional_includedir"
+                    fi
+                  fi
+                fi
+              fi
+            fi
+                        if test -n "$found_la"; then
+                                                        save_libdir="$libdir"
+              case "$found_la" in
+                */* | *\\*) . "$found_la" ;;
+                *) . "./$found_la" ;;
+              esac
+              libdir="$save_libdir"
+                            for dep in $dependency_libs; do
+                case "$dep" in
+                  -L*)
+                    additional_libdir=`echo "X$dep" | sed -e 's/^X-L//'`
+                                                                                                                                                                if test "X$additional_libdir" != "X/usr/$acl_libdirstem" \
+                       && test "X$additional_libdir" != "X/usr/$acl_libdirstem2"; then
+                      haveit=
+                      if test "X$additional_libdir" = "X/usr/local/$acl_libdirstem" \
+                         || test "X$additional_libdir" = "X/usr/local/$acl_libdirstem2"; then
+                        if test -n "$GCC"; then
+                          case $host_os in
+                            linux* | gnu* | k*bsd*-gnu) haveit=yes;;
+                          esac
+                        fi
+                      fi
+                      if test -z "$haveit"; then
+                        haveit=
+                        for x in $LDFLAGS $LIBICONV; do
 
+  acl_save_prefix="$prefix"
+  prefix="$acl_final_prefix"
+  acl_save_exec_prefix="$exec_prefix"
+  exec_prefix="$acl_final_exec_prefix"
+  eval x=\"$x\"
+  exec_prefix="$acl_save_exec_prefix"
+  prefix="$acl_save_prefix"
 
+                          if test "X$x" = "X-L$additional_libdir"; then
+                            haveit=yes
+                            break
+                          fi
+                        done
+                        if test -z "$haveit"; then
+                          if test -d "$additional_libdir"; then
+                                                        LIBICONV="${LIBICONV}${LIBICONV:+ }-L$additional_libdir"
+                          fi
+                        fi
+                        haveit=
+                        for x in $LDFLAGS $LTLIBICONV; do
 
+  acl_save_prefix="$prefix"
+  prefix="$acl_final_prefix"
+  acl_save_exec_prefix="$exec_prefix"
+  exec_prefix="$acl_final_exec_prefix"
+  eval x=\"$x\"
+  exec_prefix="$acl_save_exec_prefix"
+  prefix="$acl_save_prefix"
 
+                          if test "X$x" = "X-L$additional_libdir"; then
+                            haveit=yes
+                            break
+                          fi
+                        done
+                        if test -z "$haveit"; then
+                          if test -d "$additional_libdir"; then
+                                                        LTLIBICONV="${LTLIBICONV}${LTLIBICONV:+ }-L$additional_libdir"
+                          fi
+                        fi
+                      fi
+                    fi
+                    ;;
+                  -R*)
+                    dir=`echo "X$dep" | sed -e 's/^X-R//'`
+                    if test "$enable_rpath" != no; then
+                                                                  haveit=
+                      for x in $rpathdirs; do
+                        if test "X$x" = "X$dir"; then
+                          haveit=yes
+                          break
+                        fi
+                      done
+                      if test -z "$haveit"; then
+                        rpathdirs="$rpathdirs $dir"
+                      fi
+                                                                  haveit=
+                      for x in $ltrpathdirs; do
+                        if test "X$x" = "X$dir"; then
+                          haveit=yes
+                          break
+                        fi
+                      done
+                      if test -z "$haveit"; then
+                        ltrpathdirs="$ltrpathdirs $dir"
+                      fi
+                    fi
+                    ;;
+                  -l*)
+                                        names_next_round="$names_next_round "`echo "X$dep" | sed -e 's/^X-l//'`
+                    ;;
+                  *.la)
+                                                                                names_next_round="$names_next_round "`echo "X$dep" | sed -e 's,^X.*/,,' -e 's,^lib,,' -e 's,\.la$,,'`
+                    ;;
+                  *)
+                                        LIBICONV="${LIBICONV}${LIBICONV:+ }$dep"
+                    LTLIBICONV="${LTLIBICONV}${LTLIBICONV:+ }$dep"
+                    ;;
+                esac
+              done
+            fi
+          else
+                                                            LIBICONV="${LIBICONV}${LIBICONV:+ }-l$name"
+            LTLIBICONV="${LTLIBICONV}${LTLIBICONV:+ }-l$name"
+          fi
+        fi
+      fi
+    done
+  done
+  if test "X$rpathdirs" != "X"; then
+    if test -n "$acl_hardcode_libdir_separator"; then
+                        alldirs=
+      for found_dir in $rpathdirs; do
+        alldirs="${alldirs}${alldirs:+$acl_hardcode_libdir_separator}$found_dir"
+      done
+            acl_save_libdir="$libdir"
+      libdir="$alldirs"
+      eval flag=\"$acl_hardcode_libdir_flag_spec\"
+      libdir="$acl_save_libdir"
+      LIBICONV="${LIBICONV}${LIBICONV:+ }$flag"
+    else
+            for found_dir in $rpathdirs; do
+        acl_save_libdir="$libdir"
+        libdir="$found_dir"
+        eval flag=\"$acl_hardcode_libdir_flag_spec\"
+        libdir="$acl_save_libdir"
+        LIBICONV="${LIBICONV}${LIBICONV:+ }$flag"
+      done
+    fi
+  fi
+  if test "X$ltrpathdirs" != "X"; then
+            for found_dir in $ltrpathdirs; do
+      LTLIBICONV="${LTLIBICONV}${LTLIBICONV:+ }-R$found_dir"
+    done
+  fi
 
 
 
@@ -15140,713 +13305,367 @@
 
 
 
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking for CFPreferencesCopyAppValue" >&5
+$as_echo_n "checking for CFPreferencesCopyAppValue... " >&6; }
+if ${gt_cv_func_CFPreferencesCopyAppValue+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  gt_save_LIBS="$LIBS"
+     LIBS="$LIBS -Wl,-framework -Wl,CoreFoundation"
+     cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+#include <CoreFoundation/CFPreferences.h>
+int
+main ()
+{
+CFPreferencesCopyAppValue(NULL, NULL)
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_link "$LINENO"; then :
+  gt_cv_func_CFPreferencesCopyAppValue=yes
+else
+  gt_cv_func_CFPreferencesCopyAppValue=no
+fi
+rm -f core conftest.err conftest.$ac_objext \
+    conftest$ac_exeext conftest.$ac_ext
+     LIBS="$gt_save_LIBS"
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $gt_cv_func_CFPreferencesCopyAppValue" >&5
+$as_echo "$gt_cv_func_CFPreferencesCopyAppValue" >&6; }
+  if test $gt_cv_func_CFPreferencesCopyAppValue = yes; then
 
+$as_echo "#define HAVE_CFPREFERENCESCOPYAPPVALUE 1" >>confdefs.h
 
+  fi
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking for CFLocaleCopyCurrent" >&5
+$as_echo_n "checking for CFLocaleCopyCurrent... " >&6; }
+if ${gt_cv_func_CFLocaleCopyCurrent+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  gt_save_LIBS="$LIBS"
+     LIBS="$LIBS -Wl,-framework -Wl,CoreFoundation"
+     cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+#include <CoreFoundation/CFLocale.h>
+int
+main ()
+{
+CFLocaleCopyCurrent();
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_link "$LINENO"; then :
+  gt_cv_func_CFLocaleCopyCurrent=yes
+else
+  gt_cv_func_CFLocaleCopyCurrent=no
+fi
+rm -f core conftest.err conftest.$ac_objext \
+    conftest$ac_exeext conftest.$ac_ext
+     LIBS="$gt_save_LIBS"
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $gt_cv_func_CFLocaleCopyCurrent" >&5
+$as_echo "$gt_cv_func_CFLocaleCopyCurrent" >&6; }
+  if test $gt_cv_func_CFLocaleCopyCurrent = yes; then
 
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking dynamic linker characteristics" >&5
-$as_echo_n "checking dynamic linker characteristics... " >&6; }
+$as_echo "#define HAVE_CFLOCALECOPYCURRENT 1" >>confdefs.h
 
-library_names_spec=
-libname_spec='lib$name'
-soname_spec=
-shrext_cmds=".so"
-postinstall_cmds=
-postuninstall_cmds=
-finish_cmds=
-finish_eval=
-shlibpath_var=
-shlibpath_overrides_runpath=unknown
-version_type=none
-dynamic_linker="$host_os ld.so"
-sys_lib_dlsearch_path_spec="/lib /usr/lib"
-need_lib_prefix=unknown
-hardcode_into_libs=no
+  fi
+  INTL_MACOSX_LIBS=
+  if test $gt_cv_func_CFPreferencesCopyAppValue = yes || test $gt_cv_func_CFLocaleCopyCurrent = yes; then
+    INTL_MACOSX_LIBS="-Wl,-framework -Wl,CoreFoundation"
+  fi
 
-# when you set need_version to no, make sure it does not cause -set_version
-# flags to be left without arguments
-need_version=unknown
 
-case $host_os in
-aix3*)
-  version_type=linux
-  library_names_spec='${libname}${release}${shared_ext}$versuffix $libname.a'
-  shlibpath_var=LIBPATH
 
-  # AIX 3 has no versioning support, so we append a major version to the name.
-  soname_spec='${libname}${release}${shared_ext}$major'
-  ;;
 
-aix[4-9]*)
-  version_type=linux
-  need_lib_prefix=no
-  need_version=no
-  hardcode_into_libs=yes
-  if test "$host_cpu" = ia64; then
-    # AIX 5 supports IA64
-    library_names_spec='${libname}${release}${shared_ext}$major ${libname}${release}${shared_ext}$versuffix $libname${shared_ext}'
-    shlibpath_var=LD_LIBRARY_PATH
-  else
-    # With GCC up to 2.95.x, collect2 would create an import file
-    # for dependence libraries.  The import file would start with
-    # the line `#! .'.  This would cause the generated library to
-    # depend on `.', always an invalid library.  This was fixed in
-    # development snapshots of GCC prior to 3.0.
-    case $host_os in
-      aix4 | aix4.[01] | aix4.[01].*)
-      if { echo '#if __GNUC__ > 2 || (__GNUC__ == 2 && __GNUC_MINOR__ >= 97)'
-	   echo ' yes '
-	   echo '#endif'; } | ${CC} -E - | $GREP yes > /dev/null; then
-	:
-      else
-	can_build_shared=no
-      fi
-      ;;
-    esac
-    # AIX (on Power*) has no versioning support, so currently we can not hardcode correct
-    # soname into executable. Probably we can add versioning support to
-    # collect2, so additional links can be useful in future.
-    if test "$aix_use_runtimelinking" = yes; then
-      # If using run time linking (on AIX 4.2 or later) use lib<name>.so
-      # instead of lib<name>.a to let people know that these are not
-      # typical AIX shared libraries.
-      library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
-    else
-      # We preserve .a as extension for shared libraries through AIX4.2
-      # and later when we are not doing run time linking.
-      library_names_spec='${libname}${release}.a $libname.a'
-      soname_spec='${libname}${release}${shared_ext}$major'
-    fi
-    shlibpath_var=LIBPATH
-  fi
-  ;;
-
-amigaos*)
-  case $host_cpu in
-  powerpc)
-    # Since July 2007 AmigaOS4 officially supports .so libraries.
-    # When compiling the executable, add -use-dynld -Lsobjs: to the compileline.
-    library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
-    ;;
-  m68k)
-    library_names_spec='$libname.ixlibrary $libname.a'
-    # Create ${libname}_ixlibrary.a entries in /sys/libs.
-    finish_eval='for lib in `ls $libdir/*.ixlibrary 2>/dev/null`; do libname=`func_echo_all "$lib" | $SED '\''s%^.*/\([^/]*\)\.ixlibrary$%\1%'\''`; test $RM /sys/libs/${libname}_ixlibrary.a; $show "cd /sys/libs && $LN_S $lib ${libname}_ixlibrary.a"; cd /sys/libs && $LN_S $lib ${libname}_ixlibrary.a || exit 1; done'
-    ;;
-  esac
-  ;;
 
-beos*)
-  library_names_spec='${libname}${shared_ext}'
-  dynamic_linker="$host_os ld.so"
-  shlibpath_var=LIBRARY_PATH
-  ;;
 
-bsdi[45]*)
-  version_type=linux
-  need_version=no
-  library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
-  soname_spec='${libname}${release}${shared_ext}$major'
-  finish_cmds='PATH="\$PATH:/sbin" ldconfig $libdir'
-  shlibpath_var=LD_LIBRARY_PATH
-  sys_lib_search_path_spec="/shlib /usr/lib /usr/X11/lib /usr/contrib/lib /lib /usr/local/lib"
-  sys_lib_dlsearch_path_spec="/shlib /usr/lib /usr/local/lib"
-  # the default ld.so.conf also contains /usr/contrib/lib and
-  # /usr/X11R6/lib (/usr/X11 is a link to /usr/X11R6), but let us allow
-  # libtool to hard-code these into programs
-  ;;
+  LIBINTL=
+  LTLIBINTL=
+  POSUB=
 
-cygwin* | mingw* | pw32* | cegcc*)
-  version_type=windows
-  shrext_cmds=".dll"
-  need_version=no
-  need_lib_prefix=no
+    case " $gt_needs " in
+    *" need-formatstring-macros "*) gt_api_version=3 ;;
+    *" need-ngettext "*) gt_api_version=2 ;;
+    *) gt_api_version=1 ;;
+  esac
+  gt_func_gnugettext_libc="gt_cv_func_gnugettext${gt_api_version}_libc"
+  gt_func_gnugettext_libintl="gt_cv_func_gnugettext${gt_api_version}_libintl"
 
-  case $GCC,$cc_basename in
-  yes,*)
-    # gcc
-    library_names_spec='$libname.dll.a'
-    # DLL is installed to $(libdir)/../bin by postinstall_cmds
-    postinstall_cmds='base_file=`basename \${file}`~
-      dlpath=`$SHELL 2>&1 -c '\''. $dir/'\''\${base_file}'\''i; echo \$dlname'\''`~
-      dldir=$destdir/`dirname \$dlpath`~
-      test -d \$dldir || mkdir -p \$dldir~
-      $install_prog $dir/$dlname \$dldir/$dlname~
-      chmod a+x \$dldir/$dlname~
-      if test -n '\''$stripme'\'' && test -n '\''$striplib'\''; then
-        eval '\''$striplib \$dldir/$dlname'\'' || exit \$?;
-      fi'
-    postuninstall_cmds='dldll=`$SHELL 2>&1 -c '\''. $file; echo \$dlname'\''`~
-      dlpath=$dir/\$dldll~
-       $RM \$dlpath'
-    shlibpath_overrides_runpath=yes
+    if test "$USE_NLS" = "yes"; then
+    gt_use_preinstalled_gnugettext=no
 
-    case $host_os in
-    cygwin*)
-      # Cygwin DLLs use 'cyg' prefix rather than 'lib'
-      soname_spec='`echo ${libname} | sed -e 's/^lib/cyg/'``echo ${release} | $SED -e 's/[.]/-/g'`${versuffix}${shared_ext}'
 
-      ;;
-    mingw* | cegcc*)
-      # MinGW DLLs use traditional 'lib' prefix
-      soname_spec='${libname}`echo ${release} | $SED -e 's/[.]/-/g'`${versuffix}${shared_ext}'
-      ;;
-    pw32*)
-      # pw32 DLLs use 'pw' prefix rather than 'lib'
-      library_names_spec='`echo ${libname} | sed -e 's/^lib/pw/'``echo ${release} | $SED -e 's/[.]/-/g'`${versuffix}${shared_ext}'
-      ;;
-    esac
-    dynamic_linker='Win32 ld.exe'
-    ;;
+        if test $gt_api_version -ge 3; then
+          gt_revision_test_code='
+#ifndef __GNU_GETTEXT_SUPPORTED_REVISION
+#define __GNU_GETTEXT_SUPPORTED_REVISION(major) ((major) == 0 ? 0 : -1)
+#endif
+typedef int array [2 * (__GNU_GETTEXT_SUPPORTED_REVISION(0) >= 1) - 1];
+'
+        else
+          gt_revision_test_code=
+        fi
+        if test $gt_api_version -ge 2; then
+          gt_expression_test_code=' + * ngettext ("", "", 0)'
+        else
+          gt_expression_test_code=
+        fi
 
-  *,cl*)
-    # Native MSVC
-    libname_spec='$name'
-    soname_spec='${libname}`echo ${release} | $SED -e 's/[.]/-/g'`${versuffix}${shared_ext}'
-    library_names_spec='${libname}.dll.lib'
+        { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GNU gettext in libc" >&5
+$as_echo_n "checking for GNU gettext in libc... " >&6; }
+if eval \${$gt_func_gnugettext_libc+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+#include <libintl.h>
+$gt_revision_test_code
+extern int _nl_msg_cat_cntr;
+extern int *_nl_domain_bindings;
+int
+main ()
+{
+bindtextdomain ("", "");
+return * gettext ("")$gt_expression_test_code + _nl_msg_cat_cntr + *_nl_domain_bindings
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_link "$LINENO"; then :
+  eval "$gt_func_gnugettext_libc=yes"
+else
+  eval "$gt_func_gnugettext_libc=no"
+fi
+rm -f core conftest.err conftest.$ac_objext \
+    conftest$ac_exeext conftest.$ac_ext
+fi
+eval ac_res=\$$gt_func_gnugettext_libc
+	       { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_res" >&5
+$as_echo "$ac_res" >&6; }
 
-    case $build_os in
-    mingw*)
-      sys_lib_search_path_spec=
-      lt_save_ifs=$IFS
-      IFS=';'
-      for lt_path in $LIB
-      do
-        IFS=$lt_save_ifs
-        # Let DOS variable expansion print the short 8.3 style file name.
-        lt_path=`cd "$lt_path" 2>/dev/null && cmd //C "for %i in (".") do @echo %~si"`
-        sys_lib_search_path_spec="$sys_lib_search_path_spec $lt_path"
-      done
-      IFS=$lt_save_ifs
-      # Convert to MSYS style.
-      sys_lib_search_path_spec=`$ECHO "$sys_lib_search_path_spec" | sed -e 's|\\\\|/|g' -e 's| \\([a-zA-Z]\\):| /\\1|g' -e 's|^ ||'`
-      ;;
-    cygwin*)
-      # Convert to unix form, then to dos form, then back to unix form
-      # but this time dos style (no spaces!) so that the unix form looks
-      # like /cygdrive/c/PROGRA~1:/cygdr...
-      sys_lib_search_path_spec=`cygpath --path --unix "$LIB"`
-      sys_lib_search_path_spec=`cygpath --path --dos "$sys_lib_search_path_spec" 2>/dev/null`
-      sys_lib_search_path_spec=`cygpath --path --unix "$sys_lib_search_path_spec" | $SED -e "s/$PATH_SEPARATOR/ /g"`
-      ;;
-    *)
-      sys_lib_search_path_spec="$LIB"
-      if $ECHO "$sys_lib_search_path_spec" | $GREP ';[c-zC-Z]:/' >/dev/null; then
-        # It is most probably a Windows format PATH.
-        sys_lib_search_path_spec=`$ECHO "$sys_lib_search_path_spec" | $SED -e 's/;/ /g'`
-      else
-        sys_lib_search_path_spec=`$ECHO "$sys_lib_search_path_spec" | $SED -e "s/$PATH_SEPARATOR/ /g"`
-      fi
-      # FIXME: find the short name or the path components, as spaces are
-      # common. (e.g. "Program Files" -> "PROGRA~1")
-      ;;
-    esac
+        if { eval "gt_val=\$$gt_func_gnugettext_libc"; test "$gt_val" != "yes"; }; then
 
-    # DLL is installed to $(libdir)/../bin by postinstall_cmds
-    postinstall_cmds='base_file=`basename \${file}`~
-      dlpath=`$SHELL 2>&1 -c '\''. $dir/'\''\${base_file}'\''i; echo \$dlname'\''`~
-      dldir=$destdir/`dirname \$dlpath`~
-      test -d \$dldir || mkdir -p \$dldir~
-      $install_prog $dir/$dlname \$dldir/$dlname'
-    postuninstall_cmds='dldll=`$SHELL 2>&1 -c '\''. $file; echo \$dlname'\''`~
-      dlpath=$dir/\$dldll~
-       $RM \$dlpath'
-    shlibpath_overrides_runpath=yes
-    dynamic_linker='Win32 link.exe'
-    ;;
 
-  *)
-    # Assume MSVC wrapper
-    library_names_spec='${libname}`echo ${release} | $SED -e 's/[.]/-/g'`${versuffix}${shared_ext} $libname.lib'
-    dynamic_linker='Win32 ld.exe'
-    ;;
-  esac
-  # FIXME: first we should search . and the directory the executable is in
-  shlibpath_var=PATH
-  ;;
 
-darwin* | rhapsody*)
-  dynamic_linker="$host_os dyld"
-  version_type=darwin
-  need_lib_prefix=no
-  need_version=no
-  library_names_spec='${libname}${release}${major}$shared_ext ${libname}$shared_ext'
-  soname_spec='${libname}${release}${major}$shared_ext'
-  shlibpath_overrides_runpath=yes
-  shlibpath_var=DYLD_LIBRARY_PATH
-  shrext_cmds='`test .$module = .yes && echo .so || echo .dylib`'
 
-  sys_lib_dlsearch_path_spec='/usr/local/lib /lib /usr/lib'
-  ;;
 
-dgux*)
-  version_type=linux
-  need_lib_prefix=no
-  need_version=no
-  library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname$shared_ext'
-  soname_spec='${libname}${release}${shared_ext}$major'
-  shlibpath_var=LD_LIBRARY_PATH
-  ;;
+          am_save_CPPFLAGS="$CPPFLAGS"
 
-freebsd1*)
-  dynamic_linker=no
-  ;;
+  for element in $INCICONV; do
+    haveit=
+    for x in $CPPFLAGS; do
 
-freebsd* | dragonfly*)
-  # DragonFly does not have aout.  When/if they implement a new
-  # versioning mechanism, adjust this.
-  if test -x /usr/bin/objformat; then
-    objformat=`/usr/bin/objformat`
-  else
-    case $host_os in
-    freebsd[123]*) objformat=aout ;;
-    *) objformat=elf ;;
-    esac
-  fi
-  version_type=freebsd-$objformat
-  case $version_type in
-    freebsd-elf*)
-      library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext} $libname${shared_ext}'
-      need_version=no
-      need_lib_prefix=no
-      ;;
-    freebsd-*)
-      library_names_spec='${libname}${release}${shared_ext}$versuffix $libname${shared_ext}$versuffix'
-      need_version=yes
-      ;;
-  esac
-  shlibpath_var=LD_LIBRARY_PATH
-  case $host_os in
-  freebsd2*)
-    shlibpath_overrides_runpath=yes
-    ;;
-  freebsd3.[01]* | freebsdelf3.[01]*)
-    shlibpath_overrides_runpath=yes
-    hardcode_into_libs=yes
-    ;;
-  freebsd3.[2-9]* | freebsdelf3.[2-9]* | \
-  freebsd4.[0-5] | freebsdelf4.[0-5] | freebsd4.1.1 | freebsdelf4.1.1)
-    shlibpath_overrides_runpath=no
-    hardcode_into_libs=yes
-    ;;
-  *) # from 4.6 on, and DragonFly
-    shlibpath_overrides_runpath=yes
-    hardcode_into_libs=yes
-    ;;
-  esac
-  ;;
-
-gnu*)
-  version_type=linux
-  need_lib_prefix=no
-  need_version=no
-  library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}${major} ${libname}${shared_ext}'
-  soname_spec='${libname}${release}${shared_ext}$major'
-  shlibpath_var=LD_LIBRARY_PATH
-  hardcode_into_libs=yes
-  ;;
-
-haiku*)
-  version_type=linux
-  need_lib_prefix=no
-  need_version=no
-  dynamic_linker="$host_os runtime_loader"
-  library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}${major} ${libname}${shared_ext}'
-  soname_spec='${libname}${release}${shared_ext}$major'
-  shlibpath_var=LIBRARY_PATH
-  shlibpath_overrides_runpath=yes
-  sys_lib_dlsearch_path_spec='/boot/home/config/lib /boot/common/lib /boot/system/lib'
-  hardcode_into_libs=yes
-  ;;
+  acl_save_prefix="$prefix"
+  prefix="$acl_final_prefix"
+  acl_save_exec_prefix="$exec_prefix"
+  exec_prefix="$acl_final_exec_prefix"
+  eval x=\"$x\"
+  exec_prefix="$acl_save_exec_prefix"
+  prefix="$acl_save_prefix"
 
-hpux9* | hpux10* | hpux11*)
-  # Give a soname corresponding to the major version so that dld.sl refuses to
-  # link against other versions.
-  version_type=sunos
-  need_lib_prefix=no
-  need_version=no
-  case $host_cpu in
-  ia64*)
-    shrext_cmds='.so'
-    hardcode_into_libs=yes
-    dynamic_linker="$host_os dld.so"
-    shlibpath_var=LD_LIBRARY_PATH
-    shlibpath_overrides_runpath=yes # Unless +noenvvar is specified.
-    library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
-    soname_spec='${libname}${release}${shared_ext}$major'
-    if test "X$HPUX_IA64_MODE" = X32; then
-      sys_lib_search_path_spec="/usr/lib/hpux32 /usr/local/lib/hpux32 /usr/local/lib"
-    else
-      sys_lib_search_path_spec="/usr/lib/hpux64 /usr/local/lib/hpux64"
+      if test "X$x" = "X$element"; then
+        haveit=yes
+        break
+      fi
+    done
+    if test -z "$haveit"; then
+      CPPFLAGS="${CPPFLAGS}${CPPFLAGS:+ }$element"
     fi
-    sys_lib_dlsearch_path_spec=$sys_lib_search_path_spec
-    ;;
-  hppa*64*)
-    shrext_cmds='.sl'
-    hardcode_into_libs=yes
-    dynamic_linker="$host_os dld.sl"
-    shlibpath_var=LD_LIBRARY_PATH # How should we handle SHLIB_PATH
-    shlibpath_overrides_runpath=yes # Unless +noenvvar is specified.
-    library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
-    soname_spec='${libname}${release}${shared_ext}$major'
-    sys_lib_search_path_spec="/usr/lib/pa20_64 /usr/ccs/lib/pa20_64"
-    sys_lib_dlsearch_path_spec=$sys_lib_search_path_spec
-    ;;
-  *)
-    shrext_cmds='.sl'
-    dynamic_linker="$host_os dld.sl"
-    shlibpath_var=SHLIB_PATH
-    shlibpath_overrides_runpath=no # +s is required to enable SHLIB_PATH
-    library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
-    soname_spec='${libname}${release}${shared_ext}$major'
-    ;;
-  esac
-  # HP-UX runs *really* slowly unless shared libraries are mode 555, ...
-  postinstall_cmds='chmod 555 $lib'
-  # or fails outright, so override atomically:
-  install_override_mode=555
-  ;;
-
-interix[3-9]*)
-  version_type=linux
-  need_lib_prefix=no
-  need_version=no
-  library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major ${libname}${shared_ext}'
-  soname_spec='${libname}${release}${shared_ext}$major'
-  dynamic_linker='Interix 3.x ld.so.1 (PE, like ELF)'
-  shlibpath_var=LD_LIBRARY_PATH
-  shlibpath_overrides_runpath=no
-  hardcode_into_libs=yes
-  ;;
-
-irix5* | irix6* | nonstopux*)
-  case $host_os in
-    nonstopux*) version_type=nonstopux ;;
-    *)
-	if test "$lt_cv_prog_gnu_ld" = yes; then
-		version_type=linux
-	else
-		version_type=irix
-	fi ;;
-  esac
-  need_lib_prefix=no
-  need_version=no
-  soname_spec='${libname}${release}${shared_ext}$major'
-  library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major ${libname}${release}${shared_ext} $libname${shared_ext}'
-  case $host_os in
-  irix5* | nonstopux*)
-    libsuff= shlibsuff=
-    ;;
-  *)
-    case $LD in # libtool.m4 will add one of these switches to LD
-    *-32|*"-32 "|*-melf32bsmip|*"-melf32bsmip ")
-      libsuff= shlibsuff= libmagic=32-bit;;
-    *-n32|*"-n32 "|*-melf32bmipn32|*"-melf32bmipn32 ")
-      libsuff=32 shlibsuff=N32 libmagic=N32;;
-    *-64|*"-64 "|*-melf64bmip|*"-melf64bmip ")
-      libsuff=64 shlibsuff=64 libmagic=64-bit;;
-    *) libsuff= shlibsuff= libmagic=never-match;;
-    esac
-    ;;
-  esac
-  shlibpath_var=LD_LIBRARY${shlibsuff}_PATH
-  shlibpath_overrides_runpath=no
-  sys_lib_search_path_spec="/usr/lib${libsuff} /lib${libsuff} /usr/local/lib${libsuff}"
-  sys_lib_dlsearch_path_spec="/usr/lib${libsuff} /lib${libsuff}"
-  hardcode_into_libs=yes
-  ;;
-
-# No shared lib support for Linux oldld, aout, or coff.
-linux*oldld* | linux*aout* | linux*coff*)
-  dynamic_linker=no
-  ;;
+  done
 
-# This must be Linux ELF.
-linux* | k*bsd*-gnu | kopensolaris*-gnu)
-  version_type=linux
-  need_lib_prefix=no
-  need_version=no
-  library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
-  soname_spec='${libname}${release}${shared_ext}$major'
-  finish_cmds='PATH="\$PATH:/sbin" ldconfig -n $libdir'
-  shlibpath_var=LD_LIBRARY_PATH
-  shlibpath_overrides_runpath=no
 
-  # Some binutils ld are patched to set DT_RUNPATH
-  if ${lt_cv_shlibpath_overrides_runpath+:} false; then :
+  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for iconv" >&5
+$as_echo_n "checking for iconv... " >&6; }
+if ${am_cv_func_iconv+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  lt_cv_shlibpath_overrides_runpath=no
-    save_LDFLAGS=$LDFLAGS
-    save_libdir=$libdir
-    eval "libdir=/foo; wl=\"$lt_prog_compiler_wl_CXX\"; \
-	 LDFLAGS=\"\$LDFLAGS $hardcode_libdir_flag_spec_CXX\""
+
+    am_cv_func_iconv="no, consider installing GNU libiconv"
+    am_cv_lib_iconv=no
     cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
-
+#include <stdlib.h>
+#include <iconv.h>
 int
 main ()
 {
-
+iconv_t cd = iconv_open("","");
+       iconv(cd,NULL,NULL,NULL,NULL);
+       iconv_close(cd);
   ;
   return 0;
 }
 _ACEOF
-if ac_fn_cxx_try_link "$LINENO"; then :
-  if  ($OBJDUMP -p conftest$ac_exeext) 2>/dev/null | grep "RUNPATH.*$libdir" >/dev/null; then :
-  lt_cv_shlibpath_overrides_runpath=yes
+if ac_fn_c_try_link "$LINENO"; then :
+  am_cv_func_iconv=yes
 fi
+rm -f core conftest.err conftest.$ac_objext \
+    conftest$ac_exeext conftest.$ac_ext
+    if test "$am_cv_func_iconv" != yes; then
+      am_save_LIBS="$LIBS"
+      LIBS="$LIBS $LIBICONV"
+      cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+#include <stdlib.h>
+#include <iconv.h>
+int
+main ()
+{
+iconv_t cd = iconv_open("","");
+         iconv(cd,NULL,NULL,NULL,NULL);
+         iconv_close(cd);
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_link "$LINENO"; then :
+  am_cv_lib_iconv=yes
+        am_cv_func_iconv=yes
 fi
 rm -f core conftest.err conftest.$ac_objext \
     conftest$ac_exeext conftest.$ac_ext
-    LDFLAGS=$save_LDFLAGS
-    libdir=$save_libdir
+      LIBS="$am_save_LIBS"
+    fi
 
 fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $am_cv_func_iconv" >&5
+$as_echo "$am_cv_func_iconv" >&6; }
+  if test "$am_cv_func_iconv" = yes; then
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking for working iconv" >&5
+$as_echo_n "checking for working iconv... " >&6; }
+if ${am_cv_func_iconv_works+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
 
-  shlibpath_overrides_runpath=$lt_cv_shlibpath_overrides_runpath
+            am_save_LIBS="$LIBS"
+      if test $am_cv_lib_iconv = yes; then
+        LIBS="$LIBS $LIBICONV"
+      fi
+      if test "$cross_compiling" = yes; then :
+  case "$host_os" in
+           aix* | hpux*) am_cv_func_iconv_works="guessing no" ;;
+           *)            am_cv_func_iconv_works="guessing yes" ;;
+         esac
+else
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
 
-  # This implies no fast_install, which is unacceptable.
-  # Some rework will be needed to allow for fast_install
-  # before this can be enabled.
-  hardcode_into_libs=yes
+#include <iconv.h>
+#include <string.h>
+int main ()
+{
+  /* Test against AIX 5.1 bug: Failures are not distinguishable from successful
+     returns.  */
+  {
+    iconv_t cd_utf8_to_88591 = iconv_open ("ISO8859-1", "UTF-8");
+    if (cd_utf8_to_88591 != (iconv_t)(-1))
+      {
+        static const char input[] = "\342\202\254"; /* EURO SIGN */
+        char buf[10];
+        const char *inptr = input;
+        size_t inbytesleft = strlen (input);
+        char *outptr = buf;
+        size_t outbytesleft = sizeof (buf);
+        size_t res = iconv (cd_utf8_to_88591,
+                            (char **) &inptr, &inbytesleft,
+                            &outptr, &outbytesleft);
+        if (res == 0)
+          return 1;
+      }
+  }
+  /* Test against Solaris 10 bug: Failures are not distinguishable from
+     successful returns.  */
+  {
+    iconv_t cd_ascii_to_88591 = iconv_open ("ISO8859-1", "646");
+    if (cd_ascii_to_88591 != (iconv_t)(-1))
+      {
+        static const char input[] = "\263";
+        char buf[10];
+        const char *inptr = input;
+        size_t inbytesleft = strlen (input);
+        char *outptr = buf;
+        size_t outbytesleft = sizeof (buf);
+        size_t res = iconv (cd_ascii_to_88591,
+                            (char **) &inptr, &inbytesleft,
+                            &outptr, &outbytesleft);
+        if (res == 0)
+          return 1;
+      }
+  }
+#if 0 /* This bug could be worked around by the caller.  */
+  /* Test against HP-UX 11.11 bug: Positive return value instead of 0.  */
+  {
+    iconv_t cd_88591_to_utf8 = iconv_open ("utf8", "iso88591");
+    if (cd_88591_to_utf8 != (iconv_t)(-1))
+      {
+        static const char input[] = "\304rger mit b\366sen B\374bchen ohne Augenma\337";
+        char buf[50];
+        const char *inptr = input;
+        size_t inbytesleft = strlen (input);
+        char *outptr = buf;
+        size_t outbytesleft = sizeof (buf);
+        size_t res = iconv (cd_88591_to_utf8,
+                            (char **) &inptr, &inbytesleft,
+                            &outptr, &outbytesleft);
+        if ((int)res > 0)
+          return 1;
+      }
+  }
+#endif
+  /* Test against HP-UX 11.11 bug: No converter from EUC-JP to UTF-8 is
+     provided.  */
+  if (/* Try standardized names.  */
+      iconv_open ("UTF-8", "EUC-JP") == (iconv_t)(-1)
+      /* Try IRIX, OSF/1 names.  */
+      && iconv_open ("UTF-8", "eucJP") == (iconv_t)(-1)
+      /* Try AIX names.  */
+      && iconv_open ("UTF-8", "IBM-eucJP") == (iconv_t)(-1)
+      /* Try HP-UX names.  */
+      && iconv_open ("utf8", "eucJP") == (iconv_t)(-1))
+    return 1;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_run "$LINENO"; then :
+  am_cv_func_iconv_works=yes
+else
+  am_cv_func_iconv_works=no
+fi
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext \
+  conftest.$ac_objext conftest.beam conftest.$ac_ext
+fi
 
-  # Append ld.so.conf contents to the search path
-  if test -f /etc/ld.so.conf; then
-    lt_ld_extra=`awk '/^include / { system(sprintf("cd /etc; cat %s 2>/dev/null", \$2)); skip = 1; } { if (!skip) print \$0; skip = 0; }' < /etc/ld.so.conf | $SED -e 's/#.*//;/^[	 ]*hwcap[	 ]/d;s/[:,	]/ /g;s/=[^=]*$//;s/=[^= ]* / /g;s/"//g;/^$/d' | tr '\n' ' '`
-    sys_lib_dlsearch_path_spec="/lib /usr/lib $lt_ld_extra"
+      LIBS="$am_save_LIBS"
+
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $am_cv_func_iconv_works" >&5
+$as_echo "$am_cv_func_iconv_works" >&6; }
+    case "$am_cv_func_iconv_works" in
+      *no) am_func_iconv=no am_cv_lib_iconv=no ;;
+      *)   am_func_iconv=yes ;;
+    esac
+  else
+    am_func_iconv=no am_cv_lib_iconv=no
   fi
+  if test "$am_func_iconv" = yes; then
 
-  # We used to test for /lib/ld.so.1 and disable shared libraries on
-  # powerpc, because MkLinux only supported shared libraries with the
-  # GNU dynamic linker.  Since this was broken with cross compilers,
-  # most powerpc-linux boxes support dynamic linking these days and
-  # people can always --disable-shared, the test was removed, and we
-  # assume the GNU/Linux dynamic linker is in use.
-  dynamic_linker='GNU/Linux ld.so'
-  ;;
+$as_echo "#define HAVE_ICONV 1" >>confdefs.h
 
-netbsd*)
-  version_type=sunos
-  need_lib_prefix=no
-  need_version=no
-  if echo __ELF__ | $CC -E - | $GREP __ELF__ >/dev/null; then
-    library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${shared_ext}$versuffix'
-    finish_cmds='PATH="\$PATH:/sbin" ldconfig -m $libdir'
-    dynamic_linker='NetBSD (a.out) ld.so'
+  fi
+  if test "$am_cv_lib_iconv" = yes; then
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking how to link with libiconv" >&5
+$as_echo_n "checking how to link with libiconv... " >&6; }
+    { $as_echo "$as_me:${as_lineno-$LINENO}: result: $LIBICONV" >&5
+$as_echo "$LIBICONV" >&6; }
   else
-    library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major ${libname}${shared_ext}'
-    soname_spec='${libname}${release}${shared_ext}$major'
-    dynamic_linker='NetBSD ld.elf_so'
+            CPPFLAGS="$am_save_CPPFLAGS"
+    LIBICONV=
+    LTLIBICONV=
   fi
-  shlibpath_var=LD_LIBRARY_PATH
-  shlibpath_overrides_runpath=yes
-  hardcode_into_libs=yes
-  ;;
-
-newsos6)
-  version_type=linux
-  library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
-  shlibpath_var=LD_LIBRARY_PATH
-  shlibpath_overrides_runpath=yes
-  ;;
-
-*nto* | *qnx*)
-  version_type=qnx
-  need_lib_prefix=no
-  need_version=no
-  library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
-  soname_spec='${libname}${release}${shared_ext}$major'
-  shlibpath_var=LD_LIBRARY_PATH
-  shlibpath_overrides_runpath=no
-  hardcode_into_libs=yes
-  dynamic_linker='ldqnx.so'
-  ;;
-
-openbsd*)
-  version_type=sunos
-  sys_lib_dlsearch_path_spec="/usr/lib"
-  need_lib_prefix=no
-  # Some older versions of OpenBSD (3.3 at least) *do* need versioned libs.
-  case $host_os in
-    openbsd3.3 | openbsd3.3.*)	need_version=yes ;;
-    *)				need_version=no  ;;
-  esac
-  library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${shared_ext}$versuffix'
-  finish_cmds='PATH="\$PATH:/sbin" ldconfig -m $libdir'
-  shlibpath_var=LD_LIBRARY_PATH
-  if test -z "`echo __ELF__ | $CC -E - | $GREP __ELF__`" || test "$host_os-$host_cpu" = "openbsd2.8-powerpc"; then
-    case $host_os in
-      openbsd2.[89] | openbsd2.[89].*)
-	shlibpath_overrides_runpath=no
-	;;
-      *)
-	shlibpath_overrides_runpath=yes
-	;;
-      esac
-  else
-    shlibpath_overrides_runpath=yes
-  fi
-  ;;
-
-os2*)
-  libname_spec='$name'
-  shrext_cmds=".dll"
-  need_lib_prefix=no
-  library_names_spec='$libname${shared_ext} $libname.a'
-  dynamic_linker='OS/2 ld.exe'
-  shlibpath_var=LIBPATH
-  ;;
-
-osf3* | osf4* | osf5*)
-  version_type=osf
-  need_lib_prefix=no
-  need_version=no
-  soname_spec='${libname}${release}${shared_ext}$major'
-  library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
-  shlibpath_var=LD_LIBRARY_PATH
-  sys_lib_search_path_spec="/usr/shlib /usr/ccs/lib /usr/lib/cmplrs/cc /usr/lib /usr/local/lib /var/shlib"
-  sys_lib_dlsearch_path_spec="$sys_lib_search_path_spec"
-  ;;
-
-rdos*)
-  dynamic_linker=no
-  ;;
-
-solaris*)
-  version_type=linux
-  need_lib_prefix=no
-  need_version=no
-  library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
-  soname_spec='${libname}${release}${shared_ext}$major'
-  shlibpath_var=LD_LIBRARY_PATH
-  shlibpath_overrides_runpath=yes
-  hardcode_into_libs=yes
-  # ldd complains unless libraries are executable
-  postinstall_cmds='chmod +x $lib'
-  ;;
-
-sunos4*)
-  version_type=sunos
-  library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${shared_ext}$versuffix'
-  finish_cmds='PATH="\$PATH:/usr/etc" ldconfig $libdir'
-  shlibpath_var=LD_LIBRARY_PATH
-  shlibpath_overrides_runpath=yes
-  if test "$with_gnu_ld" = yes; then
-    need_lib_prefix=no
-  fi
-  need_version=yes
-  ;;
-
-sysv4 | sysv4.3*)
-  version_type=linux
-  library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
-  soname_spec='${libname}${release}${shared_ext}$major'
-  shlibpath_var=LD_LIBRARY_PATH
-  case $host_vendor in
-    sni)
-      shlibpath_overrides_runpath=no
-      need_lib_prefix=no
-      runpath_var=LD_RUN_PATH
-      ;;
-    siemens)
-      need_lib_prefix=no
-      ;;
-    motorola)
-      need_lib_prefix=no
-      need_version=no
-      shlibpath_overrides_runpath=no
-      sys_lib_search_path_spec='/lib /usr/lib /usr/ccs/lib'
-      ;;
-  esac
-  ;;
-
-sysv4*MP*)
-  if test -d /usr/nec ;then
-    version_type=linux
-    library_names_spec='$libname${shared_ext}.$versuffix $libname${shared_ext}.$major $libname${shared_ext}'
-    soname_spec='$libname${shared_ext}.$major'
-    shlibpath_var=LD_LIBRARY_PATH
-  fi
-  ;;
-
-sysv5* | sco3.2v5* | sco5v6* | unixware* | OpenUNIX* | sysv4*uw2*)
-  version_type=freebsd-elf
-  need_lib_prefix=no
-  need_version=no
-  library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext} $libname${shared_ext}'
-  soname_spec='${libname}${release}${shared_ext}$major'
-  shlibpath_var=LD_LIBRARY_PATH
-  shlibpath_overrides_runpath=yes
-  hardcode_into_libs=yes
-  if test "$with_gnu_ld" = yes; then
-    sys_lib_search_path_spec='/usr/local/lib /usr/gnu/lib /usr/ccs/lib /usr/lib /lib'
-  else
-    sys_lib_search_path_spec='/usr/ccs/lib /usr/lib'
-    case $host_os in
-      sco3.2v5*)
-        sys_lib_search_path_spec="$sys_lib_search_path_spec /lib"
-	;;
-    esac
-  fi
-  sys_lib_dlsearch_path_spec='/usr/lib'
-  ;;
-
-tpf*)
-  # TPF is a cross-target only.  Preferred cross-host = GNU/Linux.
-  version_type=linux
-  need_lib_prefix=no
-  need_version=no
-  library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
-  shlibpath_var=LD_LIBRARY_PATH
-  shlibpath_overrides_runpath=no
-  hardcode_into_libs=yes
-  ;;
-
-uts4*)
-  version_type=linux
-  library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
-  soname_spec='${libname}${release}${shared_ext}$major'
-  shlibpath_var=LD_LIBRARY_PATH
-  ;;
-
-*)
-  dynamic_linker=no
-  ;;
-esac
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $dynamic_linker" >&5
-$as_echo "$dynamic_linker" >&6; }
-test "$dynamic_linker" = no && can_build_shared=no
-
-variables_saved_for_relink="PATH $shlibpath_var $runpath_var"
-if test "$GCC" = yes; then
-  variables_saved_for_relink="$variables_saved_for_relink GCC_EXEC_PREFIX COMPILER_PATH LIBRARY_PATH"
-fi
-
-if test "${lt_cv_sys_lib_search_path_spec+set}" = set; then
-  sys_lib_search_path_spec="$lt_cv_sys_lib_search_path_spec"
-fi
-if test "${lt_cv_sys_lib_dlsearch_path_spec+set}" = set; then
-  sys_lib_dlsearch_path_spec="$lt_cv_sys_lib_dlsearch_path_spec"
-fi
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
 
 
 
@@ -15858,381 +13677,750 @@
 
 
 
+    use_additional=yes
 
+  acl_save_prefix="$prefix"
+  prefix="$acl_final_prefix"
+  acl_save_exec_prefix="$exec_prefix"
+  exec_prefix="$acl_final_exec_prefix"
 
+    eval additional_includedir=\"$includedir\"
+    eval additional_libdir=\"$libdir\"
 
+  exec_prefix="$acl_save_exec_prefix"
+  prefix="$acl_save_prefix"
 
 
+# Check whether --with-libintl-prefix was given.
+if test "${with_libintl_prefix+set}" = set; then :
+  withval=$with_libintl_prefix;
+    if test "X$withval" = "Xno"; then
+      use_additional=no
+    else
+      if test "X$withval" = "X"; then
 
+  acl_save_prefix="$prefix"
+  prefix="$acl_final_prefix"
+  acl_save_exec_prefix="$exec_prefix"
+  exec_prefix="$acl_final_exec_prefix"
 
+          eval additional_includedir=\"$includedir\"
+          eval additional_libdir=\"$libdir\"
 
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking how to hardcode library paths into programs" >&5
-$as_echo_n "checking how to hardcode library paths into programs... " >&6; }
-hardcode_action_CXX=
-if test -n "$hardcode_libdir_flag_spec_CXX" ||
-   test -n "$runpath_var_CXX" ||
-   test "X$hardcode_automatic_CXX" = "Xyes" ; then
+  exec_prefix="$acl_save_exec_prefix"
+  prefix="$acl_save_prefix"
 
-  # We can hardcode non-existent directories.
-  if test "$hardcode_direct_CXX" != no &&
-     # If the only mechanism to avoid hardcoding is shlibpath_var, we
-     # have to relink, otherwise we might link with an installed library
-     # when we should be linking with a yet-to-be-installed one
-     ## test "$_LT_TAGVAR(hardcode_shlibpath_var, CXX)" != no &&
-     test "$hardcode_minus_L_CXX" != no; then
-    # Linking always hardcodes the temporary library directory.
-    hardcode_action_CXX=relink
-  else
-    # We can link without hardcoding, and we can hardcode nonexisting dirs.
-    hardcode_action_CXX=immediate
-  fi
-else
-  # We cannot hardcode anything, or else we can only hardcode existing
-  # directories.
-  hardcode_action_CXX=unsupported
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $hardcode_action_CXX" >&5
-$as_echo "$hardcode_action_CXX" >&6; }
+      else
+        additional_includedir="$withval/include"
+        additional_libdir="$withval/$acl_libdirstem"
+        if test "$acl_libdirstem2" != "$acl_libdirstem" \
+           && ! test -d "$withval/$acl_libdirstem"; then
+          additional_libdir="$withval/$acl_libdirstem2"
+        fi
+      fi
+    fi
 
-if test "$hardcode_action_CXX" = relink ||
-   test "$inherit_rpath_CXX" = yes; then
-  # Fast installation is not supported
-  enable_fast_install=no
-elif test "$shlibpath_overrides_runpath" = yes ||
-     test "$enable_shared" = no; then
-  # Fast installation is not necessary
-  enable_fast_install=needless
 fi
 
+      LIBINTL=
+  LTLIBINTL=
+  INCINTL=
+  LIBINTL_PREFIX=
+      HAVE_LIBINTL=
+  rpathdirs=
+  ltrpathdirs=
+  names_already_handled=
+  names_next_round='intl '
+  while test -n "$names_next_round"; do
+    names_this_round="$names_next_round"
+    names_next_round=
+    for name in $names_this_round; do
+      already_handled=
+      for n in $names_already_handled; do
+        if test "$n" = "$name"; then
+          already_handled=yes
+          break
+        fi
+      done
+      if test -z "$already_handled"; then
+        names_already_handled="$names_already_handled $name"
+                        uppername=`echo "$name" | sed -e 'y|abcdefghijklmnopqrstuvwxyz./-|ABCDEFGHIJKLMNOPQRSTUVWXYZ___|'`
+        eval value=\"\$HAVE_LIB$uppername\"
+        if test -n "$value"; then
+          if test "$value" = yes; then
+            eval value=\"\$LIB$uppername\"
+            test -z "$value" || LIBINTL="${LIBINTL}${LIBINTL:+ }$value"
+            eval value=\"\$LTLIB$uppername\"
+            test -z "$value" || LTLIBINTL="${LTLIBINTL}${LTLIBINTL:+ }$value"
+          else
+                                    :
+          fi
+        else
+                              found_dir=
+          found_la=
+          found_so=
+          found_a=
+          eval libname=\"$acl_libname_spec\"    # typically: libname=lib$name
+          if test -n "$acl_shlibext"; then
+            shrext=".$acl_shlibext"             # typically: shrext=.so
+          else
+            shrext=
+          fi
+          if test $use_additional = yes; then
+            dir="$additional_libdir"
+                                    if test -n "$acl_shlibext"; then
+              if test -f "$dir/$libname$shrext"; then
+                found_dir="$dir"
+                found_so="$dir/$libname$shrext"
+              else
+                if test "$acl_library_names_spec" = '$libname$shrext$versuffix'; then
+                  ver=`(cd "$dir" && \
+                        for f in "$libname$shrext".*; do echo "$f"; done \
+                        | sed -e "s,^$libname$shrext\\\\.,," \
+                        | sort -t '.' -n -r -k1,1 -k2,2 -k3,3 -k4,4 -k5,5 \
+                        | sed 1q ) 2>/dev/null`
+                  if test -n "$ver" && test -f "$dir/$libname$shrext.$ver"; then
+                    found_dir="$dir"
+                    found_so="$dir/$libname$shrext.$ver"
+                  fi
+                else
+                  eval library_names=\"$acl_library_names_spec\"
+                  for f in $library_names; do
+                    if test -f "$dir/$f"; then
+                      found_dir="$dir"
+                      found_so="$dir/$f"
+                      break
+                    fi
+                  done
+                fi
+              fi
+            fi
+                        if test "X$found_dir" = "X"; then
+              if test -f "$dir/$libname.$acl_libext"; then
+                found_dir="$dir"
+                found_a="$dir/$libname.$acl_libext"
+              fi
+            fi
+            if test "X$found_dir" != "X"; then
+              if test -f "$dir/$libname.la"; then
+                found_la="$dir/$libname.la"
+              fi
+            fi
+          fi
+          if test "X$found_dir" = "X"; then
+            for x in $LDFLAGS $LTLIBINTL; do
 
+  acl_save_prefix="$prefix"
+  prefix="$acl_final_prefix"
+  acl_save_exec_prefix="$exec_prefix"
+  exec_prefix="$acl_final_exec_prefix"
+  eval x=\"$x\"
+  exec_prefix="$acl_save_exec_prefix"
+  prefix="$acl_save_prefix"
 
+              case "$x" in
+                -L*)
+                  dir=`echo "X$x" | sed -e 's/^X-L//'`
+                                    if test -n "$acl_shlibext"; then
+                    if test -f "$dir/$libname$shrext"; then
+                      found_dir="$dir"
+                      found_so="$dir/$libname$shrext"
+                    else
+                      if test "$acl_library_names_spec" = '$libname$shrext$versuffix'; then
+                        ver=`(cd "$dir" && \
+                              for f in "$libname$shrext".*; do echo "$f"; done \
+                              | sed -e "s,^$libname$shrext\\\\.,," \
+                              | sort -t '.' -n -r -k1,1 -k2,2 -k3,3 -k4,4 -k5,5 \
+                              | sed 1q ) 2>/dev/null`
+                        if test -n "$ver" && test -f "$dir/$libname$shrext.$ver"; then
+                          found_dir="$dir"
+                          found_so="$dir/$libname$shrext.$ver"
+                        fi
+                      else
+                        eval library_names=\"$acl_library_names_spec\"
+                        for f in $library_names; do
+                          if test -f "$dir/$f"; then
+                            found_dir="$dir"
+                            found_so="$dir/$f"
+                            break
+                          fi
+                        done
+                      fi
+                    fi
+                  fi
+                                    if test "X$found_dir" = "X"; then
+                    if test -f "$dir/$libname.$acl_libext"; then
+                      found_dir="$dir"
+                      found_a="$dir/$libname.$acl_libext"
+                    fi
+                  fi
+                  if test "X$found_dir" != "X"; then
+                    if test -f "$dir/$libname.la"; then
+                      found_la="$dir/$libname.la"
+                    fi
+                  fi
+                  ;;
+              esac
+              if test "X$found_dir" != "X"; then
+                break
+              fi
+            done
+          fi
+          if test "X$found_dir" != "X"; then
+                        LTLIBINTL="${LTLIBINTL}${LTLIBINTL:+ }-L$found_dir -l$name"
+            if test "X$found_so" != "X"; then
+                                                        if test "$enable_rpath" = no \
+                 || test "X$found_dir" = "X/usr/$acl_libdirstem" \
+                 || test "X$found_dir" = "X/usr/$acl_libdirstem2"; then
+                                LIBINTL="${LIBINTL}${LIBINTL:+ }$found_so"
+              else
+                                                                                haveit=
+                for x in $ltrpathdirs; do
+                  if test "X$x" = "X$found_dir"; then
+                    haveit=yes
+                    break
+                  fi
+                done
+                if test -z "$haveit"; then
+                  ltrpathdirs="$ltrpathdirs $found_dir"
+                fi
+                                if test "$acl_hardcode_direct" = yes; then
+                                                      LIBINTL="${LIBINTL}${LIBINTL:+ }$found_so"
+                else
+                  if test -n "$acl_hardcode_libdir_flag_spec" && test "$acl_hardcode_minus_L" = no; then
+                                                            LIBINTL="${LIBINTL}${LIBINTL:+ }$found_so"
+                                                            haveit=
+                    for x in $rpathdirs; do
+                      if test "X$x" = "X$found_dir"; then
+                        haveit=yes
+                        break
+                      fi
+                    done
+                    if test -z "$haveit"; then
+                      rpathdirs="$rpathdirs $found_dir"
+                    fi
+                  else
+                                                                                haveit=
+                    for x in $LDFLAGS $LIBINTL; do
 
+  acl_save_prefix="$prefix"
+  prefix="$acl_final_prefix"
+  acl_save_exec_prefix="$exec_prefix"
+  exec_prefix="$acl_final_exec_prefix"
+  eval x=\"$x\"
+  exec_prefix="$acl_save_exec_prefix"
+  prefix="$acl_save_prefix"
 
+                      if test "X$x" = "X-L$found_dir"; then
+                        haveit=yes
+                        break
+                      fi
+                    done
+                    if test -z "$haveit"; then
+                      LIBINTL="${LIBINTL}${LIBINTL:+ }-L$found_dir"
+                    fi
+                    if test "$acl_hardcode_minus_L" != no; then
+                                                                                        LIBINTL="${LIBINTL}${LIBINTL:+ }$found_so"
+                    else
+                                                                                                                                                                                LIBINTL="${LIBINTL}${LIBINTL:+ }-l$name"
+                    fi
+                  fi
+                fi
+              fi
+            else
+              if test "X$found_a" != "X"; then
+                                LIBINTL="${LIBINTL}${LIBINTL:+ }$found_a"
+              else
+                                                LIBINTL="${LIBINTL}${LIBINTL:+ }-L$found_dir -l$name"
+              fi
+            fi
+                        additional_includedir=
+            case "$found_dir" in
+              */$acl_libdirstem | */$acl_libdirstem/)
+                basedir=`echo "X$found_dir" | sed -e 's,^X,,' -e "s,/$acl_libdirstem/"'*$,,'`
+                if test "$name" = 'intl'; then
+                  LIBINTL_PREFIX="$basedir"
+                fi
+                additional_includedir="$basedir/include"
+                ;;
+              */$acl_libdirstem2 | */$acl_libdirstem2/)
+                basedir=`echo "X$found_dir" | sed -e 's,^X,,' -e "s,/$acl_libdirstem2/"'*$,,'`
+                if test "$name" = 'intl'; then
+                  LIBINTL_PREFIX="$basedir"
+                fi
+                additional_includedir="$basedir/include"
+                ;;
+            esac
+            if test "X$additional_includedir" != "X"; then
+                                                                                                                if test "X$additional_includedir" != "X/usr/include"; then
+                haveit=
+                if test "X$additional_includedir" = "X/usr/local/include"; then
+                  if test -n "$GCC"; then
+                    case $host_os in
+                      linux* | gnu* | k*bsd*-gnu) haveit=yes;;
+                    esac
+                  fi
+                fi
+                if test -z "$haveit"; then
+                  for x in $CPPFLAGS $INCINTL; do
 
+  acl_save_prefix="$prefix"
+  prefix="$acl_final_prefix"
+  acl_save_exec_prefix="$exec_prefix"
+  exec_prefix="$acl_final_exec_prefix"
+  eval x=\"$x\"
+  exec_prefix="$acl_save_exec_prefix"
+  prefix="$acl_save_prefix"
 
-  fi # test -n "$compiler"
-
-  CC=$lt_save_CC
-  CFLAGS=$lt_save_CFLAGS
-  LDCXX=$LD
-  LD=$lt_save_LD
-  GCC=$lt_save_GCC
-  with_gnu_ld=$lt_save_with_gnu_ld
-  lt_cv_path_LDCXX=$lt_cv_path_LD
-  lt_cv_path_LD=$lt_save_path_LD
-  lt_cv_prog_gnu_ldcxx=$lt_cv_prog_gnu_ld
-  lt_cv_prog_gnu_ld=$lt_save_with_gnu_ld
-fi # test "$_lt_caught_CXX_error" != yes
-
-ac_ext=c
-ac_cpp='$CPP $CPPFLAGS'
-ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
-ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
-ac_compiler_gnu=$ac_cv_c_compiler_gnu
-
-
-
-
-
-
-
-
-
-
-
-
-
-        ac_config_commands="$ac_config_commands libtool"
-
-
-
-
-# Only expand once:
-
+                    if test "X$x" = "X-I$additional_includedir"; then
+                      haveit=yes
+                      break
+                    fi
+                  done
+                  if test -z "$haveit"; then
+                    if test -d "$additional_includedir"; then
+                                            INCINTL="${INCINTL}${INCINTL:+ }-I$additional_includedir"
+                    fi
+                  fi
+                fi
+              fi
+            fi
+                        if test -n "$found_la"; then
+                                                        save_libdir="$libdir"
+              case "$found_la" in
+                */* | *\\*) . "$found_la" ;;
+                *) . "./$found_la" ;;
+              esac
+              libdir="$save_libdir"
+                            for dep in $dependency_libs; do
+                case "$dep" in
+                  -L*)
+                    additional_libdir=`echo "X$dep" | sed -e 's/^X-L//'`
+                                                                                                                                                                if test "X$additional_libdir" != "X/usr/$acl_libdirstem" \
+                       && test "X$additional_libdir" != "X/usr/$acl_libdirstem2"; then
+                      haveit=
+                      if test "X$additional_libdir" = "X/usr/local/$acl_libdirstem" \
+                         || test "X$additional_libdir" = "X/usr/local/$acl_libdirstem2"; then
+                        if test -n "$GCC"; then
+                          case $host_os in
+                            linux* | gnu* | k*bsd*-gnu) haveit=yes;;
+                          esac
+                        fi
+                      fi
+                      if test -z "$haveit"; then
+                        haveit=
+                        for x in $LDFLAGS $LIBINTL; do
 
-if test -n "$ac_tool_prefix"; then
-  # Extract the first word of "${ac_tool_prefix}ranlib", so it can be a program name with args.
-set dummy ${ac_tool_prefix}ranlib; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_prog_RANLIB+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -n "$RANLIB"; then
-  ac_cv_prog_RANLIB="$RANLIB" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_RANLIB="${ac_tool_prefix}ranlib"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
+  acl_save_prefix="$prefix"
+  prefix="$acl_final_prefix"
+  acl_save_exec_prefix="$exec_prefix"
+  exec_prefix="$acl_final_exec_prefix"
+  eval x=\"$x\"
+  exec_prefix="$acl_save_exec_prefix"
+  prefix="$acl_save_prefix"
 
-fi
-fi
-RANLIB=$ac_cv_prog_RANLIB
-if test -n "$RANLIB"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $RANLIB" >&5
-$as_echo "$RANLIB" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
+                          if test "X$x" = "X-L$additional_libdir"; then
+                            haveit=yes
+                            break
+                          fi
+                        done
+                        if test -z "$haveit"; then
+                          if test -d "$additional_libdir"; then
+                                                        LIBINTL="${LIBINTL}${LIBINTL:+ }-L$additional_libdir"
+                          fi
+                        fi
+                        haveit=
+                        for x in $LDFLAGS $LTLIBINTL; do
 
+  acl_save_prefix="$prefix"
+  prefix="$acl_final_prefix"
+  acl_save_exec_prefix="$exec_prefix"
+  exec_prefix="$acl_final_exec_prefix"
+  eval x=\"$x\"
+  exec_prefix="$acl_save_exec_prefix"
+  prefix="$acl_save_prefix"
 
-fi
-if test -z "$ac_cv_prog_RANLIB"; then
-  ac_ct_RANLIB=$RANLIB
-  # Extract the first word of "ranlib", so it can be a program name with args.
-set dummy ranlib; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_prog_ac_ct_RANLIB+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -n "$ac_ct_RANLIB"; then
-  ac_cv_prog_ac_ct_RANLIB="$ac_ct_RANLIB" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_ac_ct_RANLIB="ranlib"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
+                          if test "X$x" = "X-L$additional_libdir"; then
+                            haveit=yes
+                            break
+                          fi
+                        done
+                        if test -z "$haveit"; then
+                          if test -d "$additional_libdir"; then
+                                                        LTLIBINTL="${LTLIBINTL}${LTLIBINTL:+ }-L$additional_libdir"
+                          fi
+                        fi
+                      fi
+                    fi
+                    ;;
+                  -R*)
+                    dir=`echo "X$dep" | sed -e 's/^X-R//'`
+                    if test "$enable_rpath" != no; then
+                                                                  haveit=
+                      for x in $rpathdirs; do
+                        if test "X$x" = "X$dir"; then
+                          haveit=yes
+                          break
+                        fi
+                      done
+                      if test -z "$haveit"; then
+                        rpathdirs="$rpathdirs $dir"
+                      fi
+                                                                  haveit=
+                      for x in $ltrpathdirs; do
+                        if test "X$x" = "X$dir"; then
+                          haveit=yes
+                          break
+                        fi
+                      done
+                      if test -z "$haveit"; then
+                        ltrpathdirs="$ltrpathdirs $dir"
+                      fi
+                    fi
+                    ;;
+                  -l*)
+                                        names_next_round="$names_next_round "`echo "X$dep" | sed -e 's/^X-l//'`
+                    ;;
+                  *.la)
+                                                                                names_next_round="$names_next_round "`echo "X$dep" | sed -e 's,^X.*/,,' -e 's,^lib,,' -e 's,\.la$,,'`
+                    ;;
+                  *)
+                                        LIBINTL="${LIBINTL}${LIBINTL:+ }$dep"
+                    LTLIBINTL="${LTLIBINTL}${LTLIBINTL:+ }$dep"
+                    ;;
+                esac
+              done
+            fi
+          else
+                                                            LIBINTL="${LIBINTL}${LIBINTL:+ }-l$name"
+            LTLIBINTL="${LTLIBINTL}${LTLIBINTL:+ }-l$name"
+          fi
+        fi
+      fi
+    done
   done
-IFS=$as_save_IFS
+  if test "X$rpathdirs" != "X"; then
+    if test -n "$acl_hardcode_libdir_separator"; then
+                        alldirs=
+      for found_dir in $rpathdirs; do
+        alldirs="${alldirs}${alldirs:+$acl_hardcode_libdir_separator}$found_dir"
+      done
+            acl_save_libdir="$libdir"
+      libdir="$alldirs"
+      eval flag=\"$acl_hardcode_libdir_flag_spec\"
+      libdir="$acl_save_libdir"
+      LIBINTL="${LIBINTL}${LIBINTL:+ }$flag"
+    else
+            for found_dir in $rpathdirs; do
+        acl_save_libdir="$libdir"
+        libdir="$found_dir"
+        eval flag=\"$acl_hardcode_libdir_flag_spec\"
+        libdir="$acl_save_libdir"
+        LIBINTL="${LIBINTL}${LIBINTL:+ }$flag"
+      done
+    fi
+  fi
+  if test "X$ltrpathdirs" != "X"; then
+            for found_dir in $ltrpathdirs; do
+      LTLIBINTL="${LTLIBINTL}${LTLIBINTL:+ }-R$found_dir"
+    done
+  fi
 
-fi
-fi
-ac_ct_RANLIB=$ac_cv_prog_ac_ct_RANLIB
-if test -n "$ac_ct_RANLIB"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_ct_RANLIB" >&5
-$as_echo "$ac_ct_RANLIB" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
 
-  if test "x$ac_ct_RANLIB" = x; then
-    RANLIB=":"
-  else
-    case $cross_compiling:$ac_tool_warned in
-yes:)
-{ $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
-$as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
-ac_tool_warned=yes ;;
-esac
-    RANLIB=$ac_ct_RANLIB
-  fi
-else
-  RANLIB="$ac_cv_prog_RANLIB"
-fi
 
-for ac_prog in python2.7 python2.6 python2.5 python2 python
-do
-  # Extract the first word of "$ac_prog", so it can be a program name with args.
-set dummy $ac_prog; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_prog_PYTHON+:} false; then :
+
+
+
+          { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GNU gettext in libintl" >&5
+$as_echo_n "checking for GNU gettext in libintl... " >&6; }
+if eval \${$gt_func_gnugettext_libintl+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  if test -n "$PYTHON"; then
-  ac_cv_prog_PYTHON="$PYTHON" # Let the user override the test.
+  gt_save_CPPFLAGS="$CPPFLAGS"
+            CPPFLAGS="$CPPFLAGS $INCINTL"
+            gt_save_LIBS="$LIBS"
+            LIBS="$LIBS $LIBINTL"
+                        cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+#include <libintl.h>
+$gt_revision_test_code
+extern int _nl_msg_cat_cntr;
+extern
+#ifdef __cplusplus
+"C"
+#endif
+const char *_nl_expand_alias (const char *);
+int
+main ()
+{
+bindtextdomain ("", "");
+return * gettext ("")$gt_expression_test_code + _nl_msg_cat_cntr + *_nl_expand_alias ("")
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_link "$LINENO"; then :
+  eval "$gt_func_gnugettext_libintl=yes"
 else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_PYTHON="$ac_prog"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
-
+  eval "$gt_func_gnugettext_libintl=no"
 fi
+rm -f core conftest.err conftest.$ac_objext \
+    conftest$ac_exeext conftest.$ac_ext
+                        if { eval "gt_val=\$$gt_func_gnugettext_libintl"; test "$gt_val" != yes; } && test -n "$LIBICONV"; then
+              LIBS="$LIBS $LIBICONV"
+              cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+#include <libintl.h>
+$gt_revision_test_code
+extern int _nl_msg_cat_cntr;
+extern
+#ifdef __cplusplus
+"C"
+#endif
+const char *_nl_expand_alias (const char *);
+int
+main ()
+{
+bindtextdomain ("", "");
+return * gettext ("")$gt_expression_test_code + _nl_msg_cat_cntr + *_nl_expand_alias ("")
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_link "$LINENO"; then :
+  LIBINTL="$LIBINTL $LIBICONV"
+                LTLIBINTL="$LTLIBINTL $LTLIBICONV"
+                eval "$gt_func_gnugettext_libintl=yes"
+
 fi
-PYTHON=$ac_cv_prog_PYTHON
-if test -n "$PYTHON"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $PYTHON" >&5
-$as_echo "$PYTHON" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
+rm -f core conftest.err conftest.$ac_objext \
+    conftest$ac_exeext conftest.$ac_ext
+            fi
+            CPPFLAGS="$gt_save_CPPFLAGS"
+            LIBS="$gt_save_LIBS"
 fi
+eval ac_res=\$$gt_func_gnugettext_libintl
+	       { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_res" >&5
+$as_echo "$ac_res" >&6; }
+        fi
 
+                                        if { eval "gt_val=\$$gt_func_gnugettext_libc"; test "$gt_val" = "yes"; } \
+           || { { eval "gt_val=\$$gt_func_gnugettext_libintl"; test "$gt_val" = "yes"; } \
+                && test "$PACKAGE" != gettext-runtime \
+                && test "$PACKAGE" != gettext-tools; }; then
+          gt_use_preinstalled_gnugettext=yes
+        else
+                    LIBINTL=
+          LTLIBINTL=
+          INCINTL=
+        fi
 
-  test -n "$PYTHON" && break
-done
-test -n "$PYTHON" || PYTHON="false"
 
-for ac_prog in bash bash4 bash3
-do
-  # Extract the first word of "$ac_prog", so it can be a program name with args.
-set dummy $ac_prog; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_path_BASH_SHELL+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  case $BASH_SHELL in
-  [\\/]* | ?:[\\/]*)
-  ac_cv_path_BASH_SHELL="$BASH_SHELL" # Let the user override the test with a path.
-  ;;
-  *)
-  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_path_BASH_SHELL="$as_dir/$ac_word$ac_exec_ext"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
+
+    if test -n "$INTL_MACOSX_LIBS"; then
+      if test "$gt_use_preinstalled_gnugettext" = "yes" \
+         || test "$nls_cv_use_gnu_gettext" = "yes"; then
+                LIBINTL="$LIBINTL $INTL_MACOSX_LIBS"
+        LTLIBINTL="$LTLIBINTL $INTL_MACOSX_LIBS"
+      fi
+    fi
+
+    if test "$gt_use_preinstalled_gnugettext" = "yes" \
+       || test "$nls_cv_use_gnu_gettext" = "yes"; then
+
+$as_echo "#define ENABLE_NLS 1" >>confdefs.h
+
+    else
+      USE_NLS=no
+    fi
   fi
-done
+
+  { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether to use NLS" >&5
+$as_echo_n "checking whether to use NLS... " >&6; }
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $USE_NLS" >&5
+$as_echo "$USE_NLS" >&6; }
+  if test "$USE_NLS" = "yes"; then
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking where the gettext function comes from" >&5
+$as_echo_n "checking where the gettext function comes from... " >&6; }
+    if test "$gt_use_preinstalled_gnugettext" = "yes"; then
+      if { eval "gt_val=\$$gt_func_gnugettext_libintl"; test "$gt_val" = "yes"; }; then
+        gt_source="external libintl"
+      else
+        gt_source="libc"
+      fi
+    else
+      gt_source="included intl directory"
+    fi
+    { $as_echo "$as_me:${as_lineno-$LINENO}: result: $gt_source" >&5
+$as_echo "$gt_source" >&6; }
+  fi
+
+  if test "$USE_NLS" = "yes"; then
+
+    if test "$gt_use_preinstalled_gnugettext" = "yes"; then
+      if { eval "gt_val=\$$gt_func_gnugettext_libintl"; test "$gt_val" = "yes"; }; then
+        { $as_echo "$as_me:${as_lineno-$LINENO}: checking how to link with libintl" >&5
+$as_echo_n "checking how to link with libintl... " >&6; }
+        { $as_echo "$as_me:${as_lineno-$LINENO}: result: $LIBINTL" >&5
+$as_echo "$LIBINTL" >&6; }
+
+  for element in $INCINTL; do
+    haveit=
+    for x in $CPPFLAGS; do
+
+  acl_save_prefix="$prefix"
+  prefix="$acl_final_prefix"
+  acl_save_exec_prefix="$exec_prefix"
+  exec_prefix="$acl_final_exec_prefix"
+  eval x=\"$x\"
+  exec_prefix="$acl_save_exec_prefix"
+  prefix="$acl_save_prefix"
+
+      if test "X$x" = "X$element"; then
+        haveit=yes
+        break
+      fi
+    done
+    if test -z "$haveit"; then
+      CPPFLAGS="${CPPFLAGS}${CPPFLAGS:+ }$element"
+    fi
   done
-IFS=$as_save_IFS
 
-  ;;
-esac
-fi
-BASH_SHELL=$ac_cv_path_BASH_SHELL
-if test -n "$BASH_SHELL"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $BASH_SHELL" >&5
-$as_echo "$BASH_SHELL" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
+      fi
 
 
-  test -n "$BASH_SHELL" && break
-done
-test -n "$BASH_SHELL" || BASH_SHELL="false"
+$as_echo "#define HAVE_GETTEXT 1" >>confdefs.h
 
 
-# find installed gettext
+$as_echo "#define HAVE_DCGETTEXT 1" >>confdefs.h
 
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether NLS is requested" >&5
-$as_echo_n "checking whether NLS is requested... " >&6; }
-    # Check whether --enable-nls was given.
-if test "${enable_nls+set}" = set; then :
-  enableval=$enable_nls; USE_NLS=$enableval
-else
-  USE_NLS=yes
-fi
+    fi
 
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $USE_NLS" >&5
-$as_echo "$USE_NLS" >&6; }
+        POSUB=po
+  fi
 
 
 
+    INTLLIBS="$LIBINTL"
 
-      GETTEXT_MACRO_VERSION=0.18
 
 
 
 
-# Prepare PATH_SEPARATOR.
-# The user is always right.
-if test "${PATH_SEPARATOR+set}" != set; then
-  echo "#! /bin/sh" >conf$$.sh
-  echo  "exit 0"   >>conf$$.sh
-  chmod +x conf$$.sh
-  if (PATH="/nonexistent;."; conf$$.sh) >/dev/null 2>&1; then
-    PATH_SEPARATOR=';'
-  else
-    PATH_SEPARATOR=:
-  fi
-  rm -f conf$$.sh
+
+
+
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for fabs in -lm" >&5
+$as_echo_n "checking for fabs in -lm... " >&6; }
+if ${ac_cv_lib_m_fabs+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  ac_check_lib_save_LIBS=$LIBS
+LIBS="-lm  $LIBS"
+cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
+#ifdef __cplusplus
+extern "C"
+#endif
+char fabs ();
+int
+main ()
+{
+return fabs ();
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_link "$LINENO"; then :
+  ac_cv_lib_m_fabs=yes
+else
+  ac_cv_lib_m_fabs=no
+fi
+rm -f core conftest.err conftest.$ac_objext \
+    conftest$ac_exeext conftest.$ac_ext
+LIBS=$ac_check_lib_save_LIBS
 fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_m_fabs" >&5
+$as_echo "$ac_cv_lib_m_fabs" >&6; }
+if test "x$ac_cv_lib_m_fabs" = xyes; then :
+  cat >>confdefs.h <<_ACEOF
+#define HAVE_LIBM 1
+_ACEOF
+
+  LIBS="-lm $LIBS"
 
-# Find out how to test for executable files. Don't use a zero-byte file,
-# as systems may use methods other than mode bits to determine executability.
-cat >conf$$.file <<_ASEOF
-#! /bin/sh
-exit 0
-_ASEOF
-chmod +x conf$$.file
-if test -x conf$$.file >/dev/null 2>&1; then
-  ac_executable_p="test -x"
 else
-  ac_executable_p="test -f"
+  as_fn_error $? "libm is needed to compile pacman!" "$LINENO" 5
 fi
-rm -f conf$$.file
 
-# Extract the first word of "msgfmt", so it can be a program name with args.
-set dummy msgfmt; ac_word=$2
+
+# Check for libarchive
+
+
+
+
+
+
+
+if test "x$ac_cv_env_PKG_CONFIG_set" != "xset"; then
+	if test -n "$ac_tool_prefix"; then
+  # Extract the first word of "${ac_tool_prefix}pkg-config", so it can be a program name with args.
+set dummy ${ac_tool_prefix}pkg-config; ac_word=$2
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
 $as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_path_MSGFMT+:} false; then :
+if ${ac_cv_path_PKG_CONFIG+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  case "$MSGFMT" in
+  case $PKG_CONFIG in
   [\\/]* | ?:[\\/]*)
-    ac_cv_path_MSGFMT="$MSGFMT" # Let the user override the test with a path.
-    ;;
+  ac_cv_path_PKG_CONFIG="$PKG_CONFIG" # Let the user override the test with a path.
+  ;;
   *)
-    ac_save_IFS="$IFS"; IFS=$PATH_SEPARATOR
-    for ac_dir in $PATH; do
-      IFS="$ac_save_IFS"
-      test -z "$ac_dir" && ac_dir=.
-      for ac_exec_ext in '' $ac_executable_extensions; do
-        if $ac_executable_p "$ac_dir/$ac_word$ac_exec_ext"; then
-          echo "$as_me: trying $ac_dir/$ac_word..." >&5
-          if $ac_dir/$ac_word --statistics /dev/null >&5 2>&1 &&
-     (if $ac_dir/$ac_word --statistics /dev/null 2>&1 >/dev/null | grep usage >/dev/null; then exit 1; else exit 0; fi); then
-            ac_cv_path_MSGFMT="$ac_dir/$ac_word$ac_exec_ext"
-            break 2
-          fi
-        fi
-      done
-    done
-    IFS="$ac_save_IFS"
-  test -z "$ac_cv_path_MSGFMT" && ac_cv_path_MSGFMT=":"
-    ;;
+  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+for as_dir in $PATH
+do
+  IFS=$as_save_IFS
+  test -z "$as_dir" && as_dir=.
+    for ac_exec_ext in '' $ac_executable_extensions; do
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+    ac_cv_path_PKG_CONFIG="$as_dir/$ac_word$ac_exec_ext"
+    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+    break 2
+  fi
+done
+  done
+IFS=$as_save_IFS
+
+  ;;
 esac
 fi
-MSGFMT="$ac_cv_path_MSGFMT"
-if test "$MSGFMT" != ":"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $MSGFMT" >&5
-$as_echo "$MSGFMT" >&6; }
+PKG_CONFIG=$ac_cv_path_PKG_CONFIG
+if test -n "$PKG_CONFIG"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $PKG_CONFIG" >&5
+$as_echo "$PKG_CONFIG" >&6; }
 else
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
 $as_echo "no" >&6; }
 fi
 
-  # Extract the first word of "gmsgfmt", so it can be a program name with args.
-set dummy gmsgfmt; ac_word=$2
+
+fi
+if test -z "$ac_cv_path_PKG_CONFIG"; then
+  ac_pt_PKG_CONFIG=$PKG_CONFIG
+  # Extract the first word of "pkg-config", so it can be a program name with args.
+set dummy pkg-config; ac_word=$2
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
 $as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_path_GMSGFMT+:} false; then :
+if ${ac_cv_path_ac_pt_PKG_CONFIG+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  case $GMSGFMT in
+  case $ac_pt_PKG_CONFIG in
   [\\/]* | ?:[\\/]*)
-  ac_cv_path_GMSGFMT="$GMSGFMT" # Let the user override the test with a path.
+  ac_cv_path_ac_pt_PKG_CONFIG="$ac_pt_PKG_CONFIG" # Let the user override the test with a path.
   ;;
   *)
   as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
@@ -16241,8 +14429,8 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_path_GMSGFMT="$as_dir/$ac_word$ac_exec_ext"
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+    ac_cv_path_ac_pt_PKG_CONFIG="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
   fi
@@ -16250,1917 +14438,1137 @@
   done
 IFS=$as_save_IFS
 
-  test -z "$ac_cv_path_GMSGFMT" && ac_cv_path_GMSGFMT="$MSGFMT"
   ;;
 esac
 fi
-GMSGFMT=$ac_cv_path_GMSGFMT
-if test -n "$GMSGFMT"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $GMSGFMT" >&5
-$as_echo "$GMSGFMT" >&6; }
+ac_pt_PKG_CONFIG=$ac_cv_path_ac_pt_PKG_CONFIG
+if test -n "$ac_pt_PKG_CONFIG"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_pt_PKG_CONFIG" >&5
+$as_echo "$ac_pt_PKG_CONFIG" >&6; }
 else
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
 $as_echo "no" >&6; }
 fi
 
+  if test "x$ac_pt_PKG_CONFIG" = x; then
+    PKG_CONFIG=""
+  else
+    case $cross_compiling:$ac_tool_warned in
+yes:)
+{ $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
+$as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+ac_tool_warned=yes ;;
+esac
+    PKG_CONFIG=$ac_pt_PKG_CONFIG
+  fi
+else
+  PKG_CONFIG="$ac_cv_path_PKG_CONFIG"
+fi
 
+fi
+if test -n "$PKG_CONFIG"; then
+	_pkg_min_version=0.9.0
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking pkg-config is at least version $_pkg_min_version" >&5
+$as_echo_n "checking pkg-config is at least version $_pkg_min_version... " >&6; }
+	if $PKG_CONFIG --atleast-pkgconfig-version $_pkg_min_version; then
+		{ $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+$as_echo "yes" >&6; }
+	else
+		{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
+		PKG_CONFIG=""
+	fi
+fi
 
-    case `$MSGFMT --version | sed 1q | sed -e 's,^[^0-9]*,,'` in
-    '' | 0.[0-9] | 0.[0-9].* | 0.1[0-4] | 0.1[0-4].*) MSGFMT_015=: ;;
-    *) MSGFMT_015=$MSGFMT ;;
-  esac
-
-  case `$GMSGFMT --version | sed 1q | sed -e 's,^[^0-9]*,,'` in
-    '' | 0.[0-9] | 0.[0-9].* | 0.1[0-4] | 0.1[0-4].*) GMSGFMT_015=: ;;
-    *) GMSGFMT_015=$GMSGFMT ;;
-  esac
-
+pkg_failed=no
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for LIBARCHIVE" >&5
+$as_echo_n "checking for LIBARCHIVE... " >&6; }
+
+if test -n "$LIBARCHIVE_CFLAGS"; then
+    pkg_cv_LIBARCHIVE_CFLAGS="$LIBARCHIVE_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
+    { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"libarchive >= 2.8.0\""; } >&5
+  ($PKG_CONFIG --exists --print-errors "libarchive >= 2.8.0") 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; then
+  pkg_cv_LIBARCHIVE_CFLAGS=`$PKG_CONFIG --cflags "libarchive >= 2.8.0" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
+else
+  pkg_failed=yes
+fi
+ else
+    pkg_failed=untried
+fi
+if test -n "$LIBARCHIVE_LIBS"; then
+    pkg_cv_LIBARCHIVE_LIBS="$LIBARCHIVE_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
+    { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"libarchive >= 2.8.0\""; } >&5
+  ($PKG_CONFIG --exists --print-errors "libarchive >= 2.8.0") 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; then
+  pkg_cv_LIBARCHIVE_LIBS=`$PKG_CONFIG --libs "libarchive >= 2.8.0" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
+else
+  pkg_failed=yes
+fi
+ else
+    pkg_failed=untried
+fi
 
 
-# Prepare PATH_SEPARATOR.
-# The user is always right.
-if test "${PATH_SEPARATOR+set}" != set; then
-  echo "#! /bin/sh" >conf$$.sh
-  echo  "exit 0"   >>conf$$.sh
-  chmod +x conf$$.sh
-  if (PATH="/nonexistent;."; conf$$.sh) >/dev/null 2>&1; then
-    PATH_SEPARATOR=';'
-  else
-    PATH_SEPARATOR=:
-  fi
-  rm -f conf$$.sh
+
+if test $pkg_failed = yes; then
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
+
+if $PKG_CONFIG --atleast-pkgconfig-version 0.20; then
+        _pkg_short_errors_supported=yes
+else
+        _pkg_short_errors_supported=no
 fi
+	if test $_pkg_short_errors_supported = yes; then
+		LIBARCHIVE_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "libarchive >= 2.8.0" 2>&1`
+	else
+		LIBARCHIVE_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "libarchive >= 2.8.0" 2>&1`
+	fi
+	# Put the nasty error message in config.log where it belongs
+	echo "$LIBARCHIVE_PKG_ERRORS" >&5
 
-# Find out how to test for executable files. Don't use a zero-byte file,
-# as systems may use methods other than mode bits to determine executability.
-cat >conf$$.file <<_ASEOF
-#! /bin/sh
-exit 0
-_ASEOF
-chmod +x conf$$.file
-if test -x conf$$.file >/dev/null 2>&1; then
-  ac_executable_p="test -x"
+	as_fn_error $? "*** libarchive >= 2.8.0 is needed to compile pacman!" "$LINENO" 5
+elif test $pkg_failed = untried; then
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
+	as_fn_error $? "*** libarchive >= 2.8.0 is needed to compile pacman!" "$LINENO" 5
 else
-  ac_executable_p="test -f"
+	LIBARCHIVE_CFLAGS=$pkg_cv_LIBARCHIVE_CFLAGS
+	LIBARCHIVE_LIBS=$pkg_cv_LIBARCHIVE_LIBS
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+$as_echo "yes" >&6; }
+
 fi
-rm -f conf$$.file
 
-# Extract the first word of "xgettext", so it can be a program name with args.
-set dummy xgettext; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_path_XGETTEXT+:} false; then :
-  $as_echo_n "(cached) " >&6
+# Check for OpenSSL
+have_openssl=no
+if test "x$with_openssl" != "xno"; then
+
+pkg_failed=no
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for LIBSSL" >&5
+$as_echo_n "checking for LIBSSL... " >&6; }
+
+if test -n "$LIBSSL_CFLAGS"; then
+    pkg_cv_LIBSSL_CFLAGS="$LIBSSL_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
+    { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"libcrypto\""; } >&5
+  ($PKG_CONFIG --exists --print-errors "libcrypto") 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; then
+  pkg_cv_LIBSSL_CFLAGS=`$PKG_CONFIG --cflags "libcrypto" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
-  case "$XGETTEXT" in
-  [\\/]* | ?:[\\/]*)
-    ac_cv_path_XGETTEXT="$XGETTEXT" # Let the user override the test with a path.
-    ;;
-  *)
-    ac_save_IFS="$IFS"; IFS=$PATH_SEPARATOR
-    for ac_dir in $PATH; do
-      IFS="$ac_save_IFS"
-      test -z "$ac_dir" && ac_dir=.
-      for ac_exec_ext in '' $ac_executable_extensions; do
-        if $ac_executable_p "$ac_dir/$ac_word$ac_exec_ext"; then
-          echo "$as_me: trying $ac_dir/$ac_word..." >&5
-          if $ac_dir/$ac_word --omit-header --copyright-holder= --msgid-bugs-address= /dev/null >&5 2>&1 &&
-     (if $ac_dir/$ac_word --omit-header --copyright-holder= --msgid-bugs-address= /dev/null 2>&1 >/dev/null | grep usage >/dev/null; then exit 1; else exit 0; fi); then
-            ac_cv_path_XGETTEXT="$ac_dir/$ac_word$ac_exec_ext"
-            break 2
-          fi
-        fi
-      done
-    done
-    IFS="$ac_save_IFS"
-  test -z "$ac_cv_path_XGETTEXT" && ac_cv_path_XGETTEXT=":"
-    ;;
-esac
+  pkg_failed=yes
 fi
-XGETTEXT="$ac_cv_path_XGETTEXT"
-if test "$XGETTEXT" != ":"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $XGETTEXT" >&5
-$as_echo "$XGETTEXT" >&6; }
+ else
+    pkg_failed=untried
+fi
+if test -n "$LIBSSL_LIBS"; then
+    pkg_cv_LIBSSL_LIBS="$LIBSSL_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
+    { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"libcrypto\""; } >&5
+  ($PKG_CONFIG --exists --print-errors "libcrypto") 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; then
+  pkg_cv_LIBSSL_LIBS=`$PKG_CONFIG --libs "libcrypto" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
+  pkg_failed=yes
+fi
+ else
+    pkg_failed=untried
 fi
 
-    rm -f messages.po
-
-    case `$XGETTEXT --version | sed 1q | sed -e 's,^[^0-9]*,,'` in
-    '' | 0.[0-9] | 0.[0-9].* | 0.1[0-4] | 0.1[0-4].*) XGETTEXT_015=: ;;
-    *) XGETTEXT_015=$XGETTEXT ;;
-  esac
 
 
+if test $pkg_failed = yes; then
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
 
-# Prepare PATH_SEPARATOR.
-# The user is always right.
-if test "${PATH_SEPARATOR+set}" != set; then
-  echo "#! /bin/sh" >conf$$.sh
-  echo  "exit 0"   >>conf$$.sh
-  chmod +x conf$$.sh
-  if (PATH="/nonexistent;."; conf$$.sh) >/dev/null 2>&1; then
-    PATH_SEPARATOR=';'
-  else
-    PATH_SEPARATOR=:
-  fi
-  rm -f conf$$.sh
+if $PKG_CONFIG --atleast-pkgconfig-version 0.20; then
+        _pkg_short_errors_supported=yes
+else
+        _pkg_short_errors_supported=no
 fi
+	if test $_pkg_short_errors_supported = yes; then
+		LIBSSL_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "libcrypto" 2>&1`
+	else
+		LIBSSL_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "libcrypto" 2>&1`
+	fi
+	# Put the nasty error message in config.log where it belongs
+	echo "$LIBSSL_PKG_ERRORS" >&5
 
-# Find out how to test for executable files. Don't use a zero-byte file,
-# as systems may use methods other than mode bits to determine executability.
-cat >conf$$.file <<_ASEOF
-#! /bin/sh
-exit 0
-_ASEOF
-chmod +x conf$$.file
-if test -x conf$$.file >/dev/null 2>&1; then
-  ac_executable_p="test -x"
+	have_openssl=no
+elif test $pkg_failed = untried; then
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
+	have_openssl=no
 else
-  ac_executable_p="test -f"
+	LIBSSL_CFLAGS=$pkg_cv_LIBSSL_CFLAGS
+	LIBSSL_LIBS=$pkg_cv_LIBSSL_LIBS
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+$as_echo "yes" >&6; }
+
+$as_echo "#define HAVE_LIBSSL 1" >>confdefs.h
+ have_openssl=yes
+fi
+	if test "x$have_openssl" = xno -a "x$with_openssl" = xyes; then
+		as_fn_error $? "*** openssl support requested but libraries not found" "$LINENO" 5
+	fi
+fi
+ if test "$have_openssl" = "yes"; then
+  HAVE_LIBSSL_TRUE=
+  HAVE_LIBSSL_FALSE='#'
+else
+  HAVE_LIBSSL_TRUE='#'
+  HAVE_LIBSSL_FALSE=
 fi
-rm -f conf$$.file
 
-# Extract the first word of "msgmerge", so it can be a program name with args.
-set dummy msgmerge; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_path_MSGMERGE+:} false; then :
-  $as_echo_n "(cached) " >&6
+
+# Check for libcurl
+have_libcurl=no
+if test "x$with_libcurl" != "xno"; then
+
+pkg_failed=no
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for LIBCURL" >&5
+$as_echo_n "checking for LIBCURL... " >&6; }
+
+if test -n "$LIBCURL_CFLAGS"; then
+    pkg_cv_LIBCURL_CFLAGS="$LIBCURL_CFLAGS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
+    { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"libcurl >= 7.19.4\""; } >&5
+  ($PKG_CONFIG --exists --print-errors "libcurl >= 7.19.4") 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; then
+  pkg_cv_LIBCURL_CFLAGS=`$PKG_CONFIG --cflags "libcurl >= 7.19.4" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
-  case "$MSGMERGE" in
-  [\\/]* | ?:[\\/]*)
-    ac_cv_path_MSGMERGE="$MSGMERGE" # Let the user override the test with a path.
-    ;;
-  *)
-    ac_save_IFS="$IFS"; IFS=$PATH_SEPARATOR
-    for ac_dir in $PATH; do
-      IFS="$ac_save_IFS"
-      test -z "$ac_dir" && ac_dir=.
-      for ac_exec_ext in '' $ac_executable_extensions; do
-        if $ac_executable_p "$ac_dir/$ac_word$ac_exec_ext"; then
-          echo "$as_me: trying $ac_dir/$ac_word..." >&5
-          if $ac_dir/$ac_word --update -q /dev/null /dev/null >&5 2>&1; then
-            ac_cv_path_MSGMERGE="$ac_dir/$ac_word$ac_exec_ext"
-            break 2
-          fi
-        fi
-      done
-    done
-    IFS="$ac_save_IFS"
-  test -z "$ac_cv_path_MSGMERGE" && ac_cv_path_MSGMERGE=":"
-    ;;
-esac
+  pkg_failed=yes
 fi
-MSGMERGE="$ac_cv_path_MSGMERGE"
-if test "$MSGMERGE" != ":"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $MSGMERGE" >&5
-$as_echo "$MSGMERGE" >&6; }
+ else
+    pkg_failed=untried
+fi
+if test -n "$LIBCURL_LIBS"; then
+    pkg_cv_LIBCURL_LIBS="$LIBCURL_LIBS"
+ elif test -n "$PKG_CONFIG"; then
+    if test -n "$PKG_CONFIG" && \
+    { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"libcurl >= 7.19.4\""; } >&5
+  ($PKG_CONFIG --exists --print-errors "libcurl >= 7.19.4") 2>&5
+  ac_status=$?
+  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+  test $ac_status = 0; }; then
+  pkg_cv_LIBCURL_LIBS=`$PKG_CONFIG --libs "libcurl >= 7.19.4" 2>/dev/null`
+		      test "x$?" != "x0" && pkg_failed=yes
 else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
+  pkg_failed=yes
+fi
+ else
+    pkg_failed=untried
 fi
 
 
-        test -n "$localedir" || localedir='${datadir}/locale'
-
 
-    test -n "${XGETTEXT_EXTRA_OPTIONS+set}" || XGETTEXT_EXTRA_OPTIONS=
+if test $pkg_failed = yes; then
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
 
+if $PKG_CONFIG --atleast-pkgconfig-version 0.20; then
+        _pkg_short_errors_supported=yes
+else
+        _pkg_short_errors_supported=no
+fi
+	if test $_pkg_short_errors_supported = yes; then
+		LIBCURL_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "libcurl >= 7.19.4" 2>&1`
+	else
+		LIBCURL_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "libcurl >= 7.19.4" 2>&1`
+	fi
+	# Put the nasty error message in config.log where it belongs
+	echo "$LIBCURL_PKG_ERRORS" >&5
 
-  ac_config_commands="$ac_config_commands po-directories"
+	have_libcurl=no
+elif test $pkg_failed = untried; then
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
+	have_libcurl=no
+else
+	LIBCURL_CFLAGS=$pkg_cv_LIBCURL_CFLAGS
+	LIBCURL_LIBS=$pkg_cv_LIBCURL_LIBS
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+$as_echo "yes" >&6; }
 
+$as_echo "#define HAVE_LIBCURL 1" >>confdefs.h
+ have_libcurl=yes
+fi
+	if test "x$have_libcurl" = xno -a "x$with_libcurl" = xyes; then
+		as_fn_error $? "*** libcurl >= 7.19.4 is required for internal downloader support" "$LINENO" 5
+	fi
+fi
+ if test "$have_libcurl" = "yes"; then
+  HAVE_LIBCURL_TRUE=
+  HAVE_LIBCURL_FALSE='#'
+else
+  HAVE_LIBCURL_TRUE='#'
+  HAVE_LIBCURL_FALSE=
+fi
 
 
-      if test "X$prefix" = "XNONE"; then
-    acl_final_prefix="$ac_default_prefix"
-  else
-    acl_final_prefix="$prefix"
-  fi
-  if test "X$exec_prefix" = "XNONE"; then
-    acl_final_exec_prefix='${prefix}'
-  else
-    acl_final_exec_prefix="$exec_prefix"
-  fi
-  acl_save_prefix="$prefix"
-  prefix="$acl_final_prefix"
-  eval acl_final_exec_prefix=\"$acl_final_exec_prefix\"
-  prefix="$acl_save_prefix"
+# Check for gpgme
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether to link with libgpgme" >&5
+$as_echo_n "checking whether to link with libgpgme... " >&6; }
+if test "x$with_gpgme" != "xno"; then :
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+$as_echo "yes" >&6; }
+else
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
+fi
 
+have_gpgme=no
 
-# Check whether --with-gnu-ld was given.
-if test "${with_gnu_ld+set}" = set; then :
-  withval=$with_gnu_ld; test "$withval" = no || with_gnu_ld=yes
+# Check whether --with-gpgme-prefix was given.
+if test "${with_gpgme_prefix+set}" = set; then :
+  withval=$with_gpgme_prefix; gpgme_config_prefix="$withval"
 else
-  with_gnu_ld=no
+  gpgme_config_prefix=""
 fi
 
-# Prepare PATH_SEPARATOR.
-# The user is always right.
-if test "${PATH_SEPARATOR+set}" != set; then
-  echo "#! /bin/sh" >conf$$.sh
-  echo  "exit 0"   >>conf$$.sh
-  chmod +x conf$$.sh
-  if (PATH="/nonexistent;."; conf$$.sh) >/dev/null 2>&1; then
-    PATH_SEPARATOR=';'
-  else
-    PATH_SEPARATOR=:
+  if test "x$gpgme_config_prefix" != x ; then
+      GPGME_CONFIG="$gpgme_config_prefix/bin/gpgme-config"
   fi
-  rm -f conf$$.sh
-fi
-ac_prog=ld
-if test "$GCC" = yes; then
-  # Check if gcc -print-prog-name=ld gives a path.
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for ld used by GCC" >&5
-$as_echo_n "checking for ld used by GCC... " >&6; }
-  case $host in
-  *-*-mingw*)
-    # gcc leaves a trailing carriage return which upsets mingw
-    ac_prog=`($CC -print-prog-name=ld) 2>&5 | tr -d '\015'` ;;
-  *)
-    ac_prog=`($CC -print-prog-name=ld) 2>&5` ;;
-  esac
-  case $ac_prog in
-    # Accept absolute paths.
-    [\\/]* | [A-Za-z]:[\\/]*)
-      re_direlt='/[^/][^/]*/\.\./'
-      # Canonicalize the path of ld
-      ac_prog=`echo $ac_prog| sed 's%\\\\%/%g'`
-      while echo $ac_prog | grep "$re_direlt" > /dev/null 2>&1; do
-        ac_prog=`echo $ac_prog| sed "s%$re_direlt%/%"`
-      done
-      test -z "$LD" && LD="$ac_prog"
-      ;;
-  "")
-    # If it fails, then pretend we aren't using GCC.
-    ac_prog=ld
-    ;;
-  *)
-    # If it is relative, then search for the first ld in PATH.
-    with_gnu_ld=unknown
-    ;;
-  esac
-elif test "$with_gnu_ld" = yes; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GNU ld" >&5
-$as_echo_n "checking for GNU ld... " >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for non-GNU ld" >&5
-$as_echo_n "checking for non-GNU ld... " >&6; }
-fi
-if ${acl_cv_path_LD+:} false; then :
+  # Extract the first word of "gpgme-config", so it can be a program name with args.
+set dummy gpgme-config; ac_word=$2
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
+if ${ac_cv_path_GPGME_CONFIG+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  if test -z "$LD"; then
-  IFS="${IFS= 	}"; ac_save_ifs="$IFS"; IFS="${IFS}${PATH_SEPARATOR-:}"
-  for ac_dir in $PATH; do
-    test -z "$ac_dir" && ac_dir=.
-    if test -f "$ac_dir/$ac_prog" || test -f "$ac_dir/$ac_prog$ac_exeext"; then
-      acl_cv_path_LD="$ac_dir/$ac_prog"
-      # Check to see if the program is GNU ld.  I'd rather use --version,
-      # but apparently some GNU ld's only accept -v.
-      # Break only if it was the GNU/non-GNU ld that we prefer.
-      case `"$acl_cv_path_LD" -v 2>&1 < /dev/null` in
-      *GNU* | *'with BFD'*)
-        test "$with_gnu_ld" != no && break ;;
-      *)
-        test "$with_gnu_ld" != yes && break ;;
-      esac
-    fi
+  case $GPGME_CONFIG in
+  [\\/]* | ?:[\\/]*)
+  ac_cv_path_GPGME_CONFIG="$GPGME_CONFIG" # Let the user override the test with a path.
+  ;;
+  *)
+  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+for as_dir in $PATH
+do
+  IFS=$as_save_IFS
+  test -z "$as_dir" && as_dir=.
+    for ac_exec_ext in '' $ac_executable_extensions; do
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+    ac_cv_path_GPGME_CONFIG="$as_dir/$ac_word$ac_exec_ext"
+    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+    break 2
+  fi
+done
   done
-  IFS="$ac_save_ifs"
-else
-  acl_cv_path_LD="$LD" # Let the user override the test with a path.
-fi
-fi
+IFS=$as_save_IFS
 
-LD="$acl_cv_path_LD"
-if test -n "$LD"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $LD" >&5
-$as_echo "$LD" >&6; }
+  test -z "$ac_cv_path_GPGME_CONFIG" && ac_cv_path_GPGME_CONFIG="no"
+  ;;
+esac
+fi
+GPGME_CONFIG=$ac_cv_path_GPGME_CONFIG
+if test -n "$GPGME_CONFIG"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $GPGME_CONFIG" >&5
+$as_echo "$GPGME_CONFIG" >&6; }
 else
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
 $as_echo "no" >&6; }
 fi
-test -z "$LD" && as_fn_error $? "no acceptable ld found in \$PATH" "$LINENO" 5
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking if the linker ($LD) is GNU ld" >&5
-$as_echo_n "checking if the linker ($LD) is GNU ld... " >&6; }
-if ${acl_cv_prog_gnu_ld+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  # I'd rather use --version here, but apparently some GNU ld's only accept -v.
-case `$LD -v 2>&1 </dev/null` in
-*GNU* | *'with BFD'*)
-  acl_cv_prog_gnu_ld=yes ;;
-*)
-  acl_cv_prog_gnu_ld=no ;;
-esac
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $acl_cv_prog_gnu_ld" >&5
-$as_echo "$acl_cv_prog_gnu_ld" >&6; }
-with_gnu_ld=$acl_cv_prog_gnu_ld
 
 
 
+  if test "$GPGME_CONFIG" != "no" ; then
+    gpgme_version=`$GPGME_CONFIG --version`
+  fi
+  gpgme_version_major=`echo $gpgme_version | \
+               sed 's/\([0-9]*\)\.\([0-9]*\)\.\([0-9]*\).*/\1/'`
+  gpgme_version_minor=`echo $gpgme_version | \
+               sed 's/\([0-9]*\)\.\([0-9]*\)\.\([0-9]*\).*/\2/'`
+  gpgme_version_micro=`echo $gpgme_version | \
+               sed 's/\([0-9]*\)\.\([0-9]*\)\.\([0-9]*\).*/\3/'`
+
+if test "x$with_gpgme" != "xno"; then :
+     tmp=1.3.0
+  if echo "$tmp" | grep ':' >/dev/null 2>/dev/null ; then
+     req_gpgme_api=`echo "$tmp"     | sed 's/\(.*\):\(.*\)/\1/'`
+     min_gpgme_version=`echo "$tmp" | sed 's/\(.*\):\(.*\)/\2/'`
+  else
+     req_gpgme_api=0
+     min_gpgme_version="$tmp"
+  fi
+
+  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GPGME - version >= $min_gpgme_version" >&5
+$as_echo_n "checking for GPGME - version >= $min_gpgme_version... " >&6; }
+  ok=no
+  if test "$GPGME_CONFIG" != "no" ; then
+    req_major=`echo $min_gpgme_version | \
+               sed 's/\([0-9]*\)\.\([0-9]*\)\.\([0-9]*\)/\1/'`
+    req_minor=`echo $min_gpgme_version | \
+               sed 's/\([0-9]*\)\.\([0-9]*\)\.\([0-9]*\)/\2/'`
+    req_micro=`echo $min_gpgme_version | \
+               sed 's/\([0-9]*\)\.\([0-9]*\)\.\([0-9]*\)/\3/'`
+    if test "$gpgme_version_major" -gt "$req_major"; then
+        ok=yes
+    else
+        if test "$gpgme_version_major" -eq "$req_major"; then
+            if test "$gpgme_version_minor" -gt "$req_minor"; then
+               ok=yes
+            else
+               if test "$gpgme_version_minor" -eq "$req_minor"; then
+                   if test "$gpgme_version_micro" -ge "$req_micro"; then
+                     ok=yes
+                   fi
+               fi
+            fi
+        fi
+    fi
+  fi
+  if test $ok = yes; then
+     # If we have a recent GPGME, we should also check that the
+     # API is compatible.
+     if test "$req_gpgme_api" -gt 0 ; then
+        tmp=`$GPGME_CONFIG --api-version 2>/dev/null || echo 0`
+        if test "$tmp" -gt 0 ; then
+           if test "$req_gpgme_api" -ne "$tmp" ; then
+             ok=no
+           fi
+        fi
+     fi
+  fi
+  if test $ok = yes; then
+    GPGME_CFLAGS=`$GPGME_CONFIG --cflags`
+    GPGME_LIBS=`$GPGME_CONFIG --libs`
+    { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+$as_echo "yes" >&6; }
+    LIBS_save="$LIBS"
+		CPPFLAGS_save="$CPPFLAGS"
+		CFLAGS_save="$CFLAGS"
+
+		LIBS="$LIBS $GPGME_LIBS"
+		CPPFLAGS="$CPPFLAGS $GPGME_CPPFLAGS"
+		CFLAGS="$CFLAGS $GPGME_CFLAGS"
+
+		{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for sane gpgme" >&5
+$as_echo_n "checking for sane gpgme... " >&6; }
+		cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+#include <gpgme.h>
+int
+main ()
+{
+return gpgme_check_version("1.3.0");
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_link "$LINENO"; then :
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+$as_echo "yes" >&6; }
+			have_gpgme=yes
+
+$as_echo "#define HAVE_LIBGPGME 1" >>confdefs.h
 
-                                                { $as_echo "$as_me:${as_lineno-$LINENO}: checking for shared library run path origin" >&5
-$as_echo_n "checking for shared library run path origin... " >&6; }
-if ${acl_cv_rpath+:} false; then :
-  $as_echo_n "(cached) " >&6
 else
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
+			have_gpgme=no
+			unset GPGME_LIBS
+			unset GPGME_CFLAGS
+			if test "x$with_gpgme" = "xyes"; then :
+  { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
+$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
+as_fn_error $? "*** gpgme >= 1.3.0 is needed for GPG signature support
+See \`config.log' for more details" "$LINENO" 5; }
+fi
+
+fi
+rm -f core conftest.err conftest.$ac_objext \
+    conftest$ac_exeext conftest.$ac_ext
+  else
+    GPGME_CFLAGS=""
+    GPGME_LIBS=""
+    { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
+    with_gpgme=no
+  fi
 
-    CC="$CC" GCC="$GCC" LDFLAGS="$LDFLAGS" LD="$LD" with_gnu_ld="$with_gnu_ld" \
-    ${CONFIG_SHELL-/bin/sh} "$ac_aux_dir/config.rpath" "$host" > conftest.sh
-    . ./conftest.sh
-    rm -f ./conftest.sh
-    acl_cv_rpath=done
 
+
+		LIBS="$LIBS_save"
+		CPPFLAGS="$CPPFLAGS_save"
+		CFLAGS="$CFLAGS_save"
+		unset CPPFLAGS_save
+		unset CFLAGS_save
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $acl_cv_rpath" >&5
-$as_echo "$acl_cv_rpath" >&6; }
-  wl="$acl_cv_wl"
-  acl_libext="$acl_cv_libext"
-  acl_shlibext="$acl_cv_shlibext"
-  acl_libname_spec="$acl_cv_libname_spec"
-  acl_library_names_spec="$acl_cv_library_names_spec"
-  acl_hardcode_libdir_flag_spec="$acl_cv_hardcode_libdir_flag_spec"
-  acl_hardcode_libdir_separator="$acl_cv_hardcode_libdir_separator"
-  acl_hardcode_direct="$acl_cv_hardcode_direct"
-  acl_hardcode_minus_L="$acl_cv_hardcode_minus_L"
-    # Check whether --enable-rpath was given.
-if test "${enable_rpath+set}" = set; then :
-  enableval=$enable_rpath; :
+if test "x$have_gpgme" = xno -a "x$with_gpgme" = xyes; then :
+  { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
+$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
+as_fn_error $? "--with-gpgme was given, but gpgme was not found
+See \`config.log' for more details" "$LINENO" 5; }
+fi
+ if test "x$have_gpgme" = "xyes"; then
+  HAVE_LIBGPGME_TRUE=
+  HAVE_LIBGPGME_FALSE='#'
 else
-  enable_rpath=yes
+  HAVE_LIBGPGME_TRUE='#'
+  HAVE_LIBGPGME_FALSE=
 fi
 
 
+# Checks for header files.
+for ac_header in fcntl.h float.h glob.h libintl.h limits.h locale.h \
+                  mntent.h netinet/in.h netinet/tcp.h \
+                  stddef.h string.h sys/ioctl.h \
+                  sys/mnttab.h sys/mount.h \
+                  sys/param.h sys/statvfs.h sys/time.h sys/types.h \
+                  sys/ucred.h syslog.h termios.h wchar.h
+do :
+  as_ac_Header=`$as_echo "ac_cv_header_$ac_header" | $as_tr_sh`
+ac_fn_c_check_header_mongrel "$LINENO" "$ac_header" "$as_ac_Header" "$ac_includes_default"
+if eval test \"x\$"$as_ac_Header"\" = x"yes"; then :
+  cat >>confdefs.h <<_ACEOF
+#define `$as_echo "HAVE_$ac_header" | $as_tr_cpp` 1
+_ACEOF
 
+fi
 
-  acl_libdirstem=lib
-  acl_libdirstem2=
-  case "$host_os" in
-    solaris*)
-                                    { $as_echo "$as_me:${as_lineno-$LINENO}: checking for 64-bit host" >&5
-$as_echo_n "checking for 64-bit host... " >&6; }
-if ${gl_cv_solaris_64bit+:} false; then :
+done
+
+
+# Checks for typedefs, structures, and compiler characteristics.
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for inline" >&5
+$as_echo_n "checking for inline... " >&6; }
+if ${ac_cv_c_inline+:} false; then :
   $as_echo_n "(cached) " >&6
 else
+  ac_cv_c_inline=no
+for ac_kw in inline __inline__ __inline; do
   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
-
-#ifdef _LP64
-sixtyfour bits
+#ifndef __cplusplus
+typedef int foo_t;
+static $ac_kw foo_t static_foo () {return 0; }
+$ac_kw foo_t foo () {return 0; }
 #endif
 
 _ACEOF
-if (eval "$ac_cpp conftest.$ac_ext") 2>&5 |
-  $EGREP "sixtyfour bits" >/dev/null 2>&1; then :
-  gl_cv_solaris_64bit=yes
-else
-  gl_cv_solaris_64bit=no
+if ac_fn_c_try_compile "$LINENO"; then :
+  ac_cv_c_inline=$ac_kw
 fi
-rm -f conftest*
-
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+  test "$ac_cv_c_inline" != no && break
+done
 
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $gl_cv_solaris_64bit" >&5
-$as_echo "$gl_cv_solaris_64bit" >&6; }
-      if test $gl_cv_solaris_64bit = yes; then
-        acl_libdirstem=lib/64
-        case "$host_cpu" in
-          sparc*)        acl_libdirstem2=lib/sparcv9 ;;
-          i*86 | x86_64) acl_libdirstem2=lib/amd64 ;;
-        esac
-      fi
-      ;;
-    *)
-      searchpath=`(LC_ALL=C $CC -print-search-dirs) 2>/dev/null | sed -n -e 's,^libraries: ,,p' | sed -e 's,^=,,'`
-      if test -n "$searchpath"; then
-        acl_save_IFS="${IFS= 	}"; IFS=":"
-        for searchdir in $searchpath; do
-          if test -d "$searchdir"; then
-            case "$searchdir" in
-              */lib64/ | */lib64 ) acl_libdirstem=lib64 ;;
-              */../ | */.. )
-                # Better ignore directories of this form. They are misleading.
-                ;;
-              *) searchdir=`cd "$searchdir" && pwd`
-                 case "$searchdir" in
-                   */lib64 ) acl_libdirstem=lib64 ;;
-                 esac ;;
-            esac
-          fi
-        done
-        IFS="$acl_save_IFS"
-      fi
-      ;;
-  esac
-  test -n "$acl_libdirstem2" || acl_libdirstem2="$acl_libdirstem"
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_c_inline" >&5
+$as_echo "$ac_cv_c_inline" >&6; }
 
+case $ac_cv_c_inline in
+  inline | yes) ;;
+  *)
+    case $ac_cv_c_inline in
+      no) ac_val=;;
+      *) ac_val=$ac_cv_c_inline;;
+    esac
+    cat >>confdefs.h <<_ACEOF
+#ifndef __cplusplus
+#define inline $ac_val
+#endif
+_ACEOF
+    ;;
+esac
 
+ac_fn_c_find_intX_t "$LINENO" "64" "ac_cv_c_int64_t"
+case $ac_cv_c_int64_t in #(
+  no|yes) ;; #(
+  *)
 
+cat >>confdefs.h <<_ACEOF
+#define int64_t $ac_cv_c_int64_t
+_ACEOF
+;;
+esac
 
+ac_fn_c_check_type "$LINENO" "mode_t" "ac_cv_type_mode_t" "$ac_includes_default"
+if test "x$ac_cv_type_mode_t" = xyes; then :
 
+else
 
+cat >>confdefs.h <<_ACEOF
+#define mode_t int
+_ACEOF
 
+fi
 
+ac_fn_c_check_type "$LINENO" "off_t" "ac_cv_type_off_t" "$ac_includes_default"
+if test "x$ac_cv_type_off_t" = xyes; then :
 
+else
 
+cat >>confdefs.h <<_ACEOF
+#define off_t long int
+_ACEOF
 
+fi
 
-    use_additional=yes
+ac_fn_c_check_type "$LINENO" "pid_t" "ac_cv_type_pid_t" "$ac_includes_default"
+if test "x$ac_cv_type_pid_t" = xyes; then :
 
-  acl_save_prefix="$prefix"
-  prefix="$acl_final_prefix"
-  acl_save_exec_prefix="$exec_prefix"
-  exec_prefix="$acl_final_exec_prefix"
+else
 
-    eval additional_includedir=\"$includedir\"
-    eval additional_libdir=\"$libdir\"
+cat >>confdefs.h <<_ACEOF
+#define pid_t int
+_ACEOF
 
-  exec_prefix="$acl_save_exec_prefix"
-  prefix="$acl_save_prefix"
+fi
 
+ac_fn_c_check_type "$LINENO" "size_t" "ac_cv_type_size_t" "$ac_includes_default"
+if test "x$ac_cv_type_size_t" = xyes; then :
 
-# Check whether --with-libiconv-prefix was given.
-if test "${with_libiconv_prefix+set}" = set; then :
-  withval=$with_libiconv_prefix;
-    if test "X$withval" = "Xno"; then
-      use_additional=no
-    else
-      if test "X$withval" = "X"; then
+else
 
-  acl_save_prefix="$prefix"
-  prefix="$acl_final_prefix"
-  acl_save_exec_prefix="$exec_prefix"
-  exec_prefix="$acl_final_exec_prefix"
+cat >>confdefs.h <<_ACEOF
+#define size_t unsigned int
+_ACEOF
 
-          eval additional_includedir=\"$includedir\"
-          eval additional_libdir=\"$libdir\"
+fi
 
-  exec_prefix="$acl_save_exec_prefix"
-  prefix="$acl_save_prefix"
+ac_fn_c_check_type "$LINENO" "ssize_t" "ac_cv_type_ssize_t" "$ac_includes_default"
+if test "x$ac_cv_type_ssize_t" = xyes; then :
 
-      else
-        additional_includedir="$withval/include"
-        additional_libdir="$withval/$acl_libdirstem"
-        if test "$acl_libdirstem2" != "$acl_libdirstem" \
-           && ! test -d "$withval/$acl_libdirstem"; then
-          additional_libdir="$withval/$acl_libdirstem2"
-        fi
-      fi
-    fi
+else
+
+cat >>confdefs.h <<_ACEOF
+#define ssize_t int
+_ACEOF
 
 fi
 
-      LIBICONV=
-  LTLIBICONV=
-  INCICONV=
-  LIBICONV_PREFIX=
-      HAVE_LIBICONV=
-  rpathdirs=
-  ltrpathdirs=
-  names_already_handled=
-  names_next_round='iconv '
-  while test -n "$names_next_round"; do
-    names_this_round="$names_next_round"
-    names_next_round=
-    for name in $names_this_round; do
-      already_handled=
-      for n in $names_already_handled; do
-        if test "$n" = "$name"; then
-          already_handled=yes
-          break
-        fi
-      done
-      if test -z "$already_handled"; then
-        names_already_handled="$names_already_handled $name"
-                        uppername=`echo "$name" | sed -e 'y|abcdefghijklmnopqrstuvwxyz./-|ABCDEFGHIJKLMNOPQRSTUVWXYZ___|'`
-        eval value=\"\$HAVE_LIB$uppername\"
-        if test -n "$value"; then
-          if test "$value" = yes; then
-            eval value=\"\$LIB$uppername\"
-            test -z "$value" || LIBICONV="${LIBICONV}${LIBICONV:+ }$value"
-            eval value=\"\$LTLIB$uppername\"
-            test -z "$value" || LTLIBICONV="${LTLIBICONV}${LTLIBICONV:+ }$value"
-          else
-                                    :
-          fi
-        else
-                              found_dir=
-          found_la=
-          found_so=
-          found_a=
-          eval libname=\"$acl_libname_spec\"    # typically: libname=lib$name
-          if test -n "$acl_shlibext"; then
-            shrext=".$acl_shlibext"             # typically: shrext=.so
-          else
-            shrext=
-          fi
-          if test $use_additional = yes; then
-            dir="$additional_libdir"
-                                    if test -n "$acl_shlibext"; then
-              if test -f "$dir/$libname$shrext"; then
-                found_dir="$dir"
-                found_so="$dir/$libname$shrext"
-              else
-                if test "$acl_library_names_spec" = '$libname$shrext$versuffix'; then
-                  ver=`(cd "$dir" && \
-                        for f in "$libname$shrext".*; do echo "$f"; done \
-                        | sed -e "s,^$libname$shrext\\\\.,," \
-                        | sort -t '.' -n -r -k1,1 -k2,2 -k3,3 -k4,4 -k5,5 \
-                        | sed 1q ) 2>/dev/null`
-                  if test -n "$ver" && test -f "$dir/$libname$shrext.$ver"; then
-                    found_dir="$dir"
-                    found_so="$dir/$libname$shrext.$ver"
-                  fi
-                else
-                  eval library_names=\"$acl_library_names_spec\"
-                  for f in $library_names; do
-                    if test -f "$dir/$f"; then
-                      found_dir="$dir"
-                      found_so="$dir/$f"
-                      break
-                    fi
-                  done
-                fi
-              fi
-            fi
-                        if test "X$found_dir" = "X"; then
-              if test -f "$dir/$libname.$acl_libext"; then
-                found_dir="$dir"
-                found_a="$dir/$libname.$acl_libext"
-              fi
-            fi
-            if test "X$found_dir" != "X"; then
-              if test -f "$dir/$libname.la"; then
-                found_la="$dir/$libname.la"
-              fi
-            fi
-          fi
-          if test "X$found_dir" = "X"; then
-            for x in $LDFLAGS $LTLIBICONV; do
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether struct tm is in sys/time.h or time.h" >&5
+$as_echo_n "checking whether struct tm is in sys/time.h or time.h... " >&6; }
+if ${ac_cv_struct_tm+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+#include <sys/types.h>
+#include <time.h>
 
-  acl_save_prefix="$prefix"
-  prefix="$acl_final_prefix"
-  acl_save_exec_prefix="$exec_prefix"
-  exec_prefix="$acl_final_exec_prefix"
-  eval x=\"$x\"
-  exec_prefix="$acl_save_exec_prefix"
-  prefix="$acl_save_prefix"
+int
+main ()
+{
+struct tm tm;
+				     int *p = &tm.tm_sec;
+				     return !p;
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_compile "$LINENO"; then :
+  ac_cv_struct_tm=time.h
+else
+  ac_cv_struct_tm=sys/time.h
+fi
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_struct_tm" >&5
+$as_echo "$ac_cv_struct_tm" >&6; }
+if test $ac_cv_struct_tm = sys/time.h; then
 
-              case "$x" in
-                -L*)
-                  dir=`echo "X$x" | sed -e 's/^X-L//'`
-                                    if test -n "$acl_shlibext"; then
-                    if test -f "$dir/$libname$shrext"; then
-                      found_dir="$dir"
-                      found_so="$dir/$libname$shrext"
-                    else
-                      if test "$acl_library_names_spec" = '$libname$shrext$versuffix'; then
-                        ver=`(cd "$dir" && \
-                              for f in "$libname$shrext".*; do echo "$f"; done \
-                              | sed -e "s,^$libname$shrext\\\\.,," \
-                              | sort -t '.' -n -r -k1,1 -k2,2 -k3,3 -k4,4 -k5,5 \
-                              | sed 1q ) 2>/dev/null`
-                        if test -n "$ver" && test -f "$dir/$libname$shrext.$ver"; then
-                          found_dir="$dir"
-                          found_so="$dir/$libname$shrext.$ver"
-                        fi
-                      else
-                        eval library_names=\"$acl_library_names_spec\"
-                        for f in $library_names; do
-                          if test -f "$dir/$f"; then
-                            found_dir="$dir"
-                            found_so="$dir/$f"
-                            break
-                          fi
-                        done
-                      fi
-                    fi
-                  fi
-                                    if test "X$found_dir" = "X"; then
-                    if test -f "$dir/$libname.$acl_libext"; then
-                      found_dir="$dir"
-                      found_a="$dir/$libname.$acl_libext"
-                    fi
-                  fi
-                  if test "X$found_dir" != "X"; then
-                    if test -f "$dir/$libname.la"; then
-                      found_la="$dir/$libname.la"
-                    fi
-                  fi
-                  ;;
-              esac
-              if test "X$found_dir" != "X"; then
-                break
-              fi
-            done
-          fi
-          if test "X$found_dir" != "X"; then
-                        LTLIBICONV="${LTLIBICONV}${LTLIBICONV:+ }-L$found_dir -l$name"
-            if test "X$found_so" != "X"; then
-                                                        if test "$enable_rpath" = no \
-                 || test "X$found_dir" = "X/usr/$acl_libdirstem" \
-                 || test "X$found_dir" = "X/usr/$acl_libdirstem2"; then
-                                LIBICONV="${LIBICONV}${LIBICONV:+ }$found_so"
-              else
-                                                                                haveit=
-                for x in $ltrpathdirs; do
-                  if test "X$x" = "X$found_dir"; then
-                    haveit=yes
-                    break
-                  fi
-                done
-                if test -z "$haveit"; then
-                  ltrpathdirs="$ltrpathdirs $found_dir"
-                fi
-                                if test "$acl_hardcode_direct" = yes; then
-                                                      LIBICONV="${LIBICONV}${LIBICONV:+ }$found_so"
-                else
-                  if test -n "$acl_hardcode_libdir_flag_spec" && test "$acl_hardcode_minus_L" = no; then
-                                                            LIBICONV="${LIBICONV}${LIBICONV:+ }$found_so"
-                                                            haveit=
-                    for x in $rpathdirs; do
-                      if test "X$x" = "X$found_dir"; then
-                        haveit=yes
-                        break
-                      fi
-                    done
-                    if test -z "$haveit"; then
-                      rpathdirs="$rpathdirs $found_dir"
-                    fi
-                  else
-                                                                                haveit=
-                    for x in $LDFLAGS $LIBICONV; do
-
-  acl_save_prefix="$prefix"
-  prefix="$acl_final_prefix"
-  acl_save_exec_prefix="$exec_prefix"
-  exec_prefix="$acl_final_exec_prefix"
-  eval x=\"$x\"
-  exec_prefix="$acl_save_exec_prefix"
-  prefix="$acl_save_prefix"
-
-                      if test "X$x" = "X-L$found_dir"; then
-                        haveit=yes
-                        break
-                      fi
-                    done
-                    if test -z "$haveit"; then
-                      LIBICONV="${LIBICONV}${LIBICONV:+ }-L$found_dir"
-                    fi
-                    if test "$acl_hardcode_minus_L" != no; then
-                                                                                        LIBICONV="${LIBICONV}${LIBICONV:+ }$found_so"
-                    else
-                                                                                                                                                                                LIBICONV="${LIBICONV}${LIBICONV:+ }-l$name"
-                    fi
-                  fi
-                fi
-              fi
-            else
-              if test "X$found_a" != "X"; then
-                                LIBICONV="${LIBICONV}${LIBICONV:+ }$found_a"
-              else
-                                                LIBICONV="${LIBICONV}${LIBICONV:+ }-L$found_dir -l$name"
-              fi
-            fi
-                        additional_includedir=
-            case "$found_dir" in
-              */$acl_libdirstem | */$acl_libdirstem/)
-                basedir=`echo "X$found_dir" | sed -e 's,^X,,' -e "s,/$acl_libdirstem/"'*$,,'`
-                if test "$name" = 'iconv'; then
-                  LIBICONV_PREFIX="$basedir"
-                fi
-                additional_includedir="$basedir/include"
-                ;;
-              */$acl_libdirstem2 | */$acl_libdirstem2/)
-                basedir=`echo "X$found_dir" | sed -e 's,^X,,' -e "s,/$acl_libdirstem2/"'*$,,'`
-                if test "$name" = 'iconv'; then
-                  LIBICONV_PREFIX="$basedir"
-                fi
-                additional_includedir="$basedir/include"
-                ;;
-            esac
-            if test "X$additional_includedir" != "X"; then
-                                                                                                                if test "X$additional_includedir" != "X/usr/include"; then
-                haveit=
-                if test "X$additional_includedir" = "X/usr/local/include"; then
-                  if test -n "$GCC"; then
-                    case $host_os in
-                      linux* | gnu* | k*bsd*-gnu) haveit=yes;;
-                    esac
-                  fi
-                fi
-                if test -z "$haveit"; then
-                  for x in $CPPFLAGS $INCICONV; do
-
-  acl_save_prefix="$prefix"
-  prefix="$acl_final_prefix"
-  acl_save_exec_prefix="$exec_prefix"
-  exec_prefix="$acl_final_exec_prefix"
-  eval x=\"$x\"
-  exec_prefix="$acl_save_exec_prefix"
-  prefix="$acl_save_prefix"
-
-                    if test "X$x" = "X-I$additional_includedir"; then
-                      haveit=yes
-                      break
-                    fi
-                  done
-                  if test -z "$haveit"; then
-                    if test -d "$additional_includedir"; then
-                                            INCICONV="${INCICONV}${INCICONV:+ }-I$additional_includedir"
-                    fi
-                  fi
-                fi
-              fi
-            fi
-                        if test -n "$found_la"; then
-                                                        save_libdir="$libdir"
-              case "$found_la" in
-                */* | *\\*) . "$found_la" ;;
-                *) . "./$found_la" ;;
-              esac
-              libdir="$save_libdir"
-                            for dep in $dependency_libs; do
-                case "$dep" in
-                  -L*)
-                    additional_libdir=`echo "X$dep" | sed -e 's/^X-L//'`
-                                                                                                                                                                if test "X$additional_libdir" != "X/usr/$acl_libdirstem" \
-                       && test "X$additional_libdir" != "X/usr/$acl_libdirstem2"; then
-                      haveit=
-                      if test "X$additional_libdir" = "X/usr/local/$acl_libdirstem" \
-                         || test "X$additional_libdir" = "X/usr/local/$acl_libdirstem2"; then
-                        if test -n "$GCC"; then
-                          case $host_os in
-                            linux* | gnu* | k*bsd*-gnu) haveit=yes;;
-                          esac
-                        fi
-                      fi
-                      if test -z "$haveit"; then
-                        haveit=
-                        for x in $LDFLAGS $LIBICONV; do
-
-  acl_save_prefix="$prefix"
-  prefix="$acl_final_prefix"
-  acl_save_exec_prefix="$exec_prefix"
-  exec_prefix="$acl_final_exec_prefix"
-  eval x=\"$x\"
-  exec_prefix="$acl_save_exec_prefix"
-  prefix="$acl_save_prefix"
-
-                          if test "X$x" = "X-L$additional_libdir"; then
-                            haveit=yes
-                            break
-                          fi
-                        done
-                        if test -z "$haveit"; then
-                          if test -d "$additional_libdir"; then
-                                                        LIBICONV="${LIBICONV}${LIBICONV:+ }-L$additional_libdir"
-                          fi
-                        fi
-                        haveit=
-                        for x in $LDFLAGS $LTLIBICONV; do
-
-  acl_save_prefix="$prefix"
-  prefix="$acl_final_prefix"
-  acl_save_exec_prefix="$exec_prefix"
-  exec_prefix="$acl_final_exec_prefix"
-  eval x=\"$x\"
-  exec_prefix="$acl_save_exec_prefix"
-  prefix="$acl_save_prefix"
-
-                          if test "X$x" = "X-L$additional_libdir"; then
-                            haveit=yes
-                            break
-                          fi
-                        done
-                        if test -z "$haveit"; then
-                          if test -d "$additional_libdir"; then
-                                                        LTLIBICONV="${LTLIBICONV}${LTLIBICONV:+ }-L$additional_libdir"
-                          fi
-                        fi
-                      fi
-                    fi
-                    ;;
-                  -R*)
-                    dir=`echo "X$dep" | sed -e 's/^X-R//'`
-                    if test "$enable_rpath" != no; then
-                                                                  haveit=
-                      for x in $rpathdirs; do
-                        if test "X$x" = "X$dir"; then
-                          haveit=yes
-                          break
-                        fi
-                      done
-                      if test -z "$haveit"; then
-                        rpathdirs="$rpathdirs $dir"
-                      fi
-                                                                  haveit=
-                      for x in $ltrpathdirs; do
-                        if test "X$x" = "X$dir"; then
-                          haveit=yes
-                          break
-                        fi
-                      done
-                      if test -z "$haveit"; then
-                        ltrpathdirs="$ltrpathdirs $dir"
-                      fi
-                    fi
-                    ;;
-                  -l*)
-                                        names_next_round="$names_next_round "`echo "X$dep" | sed -e 's/^X-l//'`
-                    ;;
-                  *.la)
-                                                                                names_next_round="$names_next_round "`echo "X$dep" | sed -e 's,^X.*/,,' -e 's,^lib,,' -e 's,\.la$,,'`
-                    ;;
-                  *)
-                                        LIBICONV="${LIBICONV}${LIBICONV:+ }$dep"
-                    LTLIBICONV="${LTLIBICONV}${LTLIBICONV:+ }$dep"
-                    ;;
-                esac
-              done
-            fi
-          else
-                                                            LIBICONV="${LIBICONV}${LIBICONV:+ }-l$name"
-            LTLIBICONV="${LTLIBICONV}${LTLIBICONV:+ }-l$name"
-          fi
-        fi
-      fi
-    done
-  done
-  if test "X$rpathdirs" != "X"; then
-    if test -n "$acl_hardcode_libdir_separator"; then
-                        alldirs=
-      for found_dir in $rpathdirs; do
-        alldirs="${alldirs}${alldirs:+$acl_hardcode_libdir_separator}$found_dir"
-      done
-            acl_save_libdir="$libdir"
-      libdir="$alldirs"
-      eval flag=\"$acl_hardcode_libdir_flag_spec\"
-      libdir="$acl_save_libdir"
-      LIBICONV="${LIBICONV}${LIBICONV:+ }$flag"
-    else
-            for found_dir in $rpathdirs; do
-        acl_save_libdir="$libdir"
-        libdir="$found_dir"
-        eval flag=\"$acl_hardcode_libdir_flag_spec\"
-        libdir="$acl_save_libdir"
-        LIBICONV="${LIBICONV}${LIBICONV:+ }$flag"
-      done
-    fi
-  fi
-  if test "X$ltrpathdirs" != "X"; then
-            for found_dir in $ltrpathdirs; do
-      LTLIBICONV="${LTLIBICONV}${LTLIBICONV:+ }-R$found_dir"
-    done
-  fi
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking for CFPreferencesCopyAppValue" >&5
-$as_echo_n "checking for CFPreferencesCopyAppValue... " >&6; }
-if ${gt_cv_func_CFPreferencesCopyAppValue+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  gt_save_LIBS="$LIBS"
-     LIBS="$LIBS -Wl,-framework -Wl,CoreFoundation"
-     cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <CoreFoundation/CFPreferences.h>
-int
-main ()
-{
-CFPreferencesCopyAppValue(NULL, NULL)
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  gt_cv_func_CFPreferencesCopyAppValue=yes
-else
-  gt_cv_func_CFPreferencesCopyAppValue=no
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-     LIBS="$gt_save_LIBS"
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $gt_cv_func_CFPreferencesCopyAppValue" >&5
-$as_echo "$gt_cv_func_CFPreferencesCopyAppValue" >&6; }
-  if test $gt_cv_func_CFPreferencesCopyAppValue = yes; then
-
-$as_echo "#define HAVE_CFPREFERENCESCOPYAPPVALUE 1" >>confdefs.h
-
-  fi
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking for CFLocaleCopyCurrent" >&5
-$as_echo_n "checking for CFLocaleCopyCurrent... " >&6; }
-if ${gt_cv_func_CFLocaleCopyCurrent+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  gt_save_LIBS="$LIBS"
-     LIBS="$LIBS -Wl,-framework -Wl,CoreFoundation"
-     cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <CoreFoundation/CFLocale.h>
-int
-main ()
-{
-CFLocaleCopyCurrent();
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  gt_cv_func_CFLocaleCopyCurrent=yes
-else
-  gt_cv_func_CFLocaleCopyCurrent=no
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-     LIBS="$gt_save_LIBS"
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $gt_cv_func_CFLocaleCopyCurrent" >&5
-$as_echo "$gt_cv_func_CFLocaleCopyCurrent" >&6; }
-  if test $gt_cv_func_CFLocaleCopyCurrent = yes; then
-
-$as_echo "#define HAVE_CFLOCALECOPYCURRENT 1" >>confdefs.h
-
-  fi
-  INTL_MACOSX_LIBS=
-  if test $gt_cv_func_CFPreferencesCopyAppValue = yes || test $gt_cv_func_CFLocaleCopyCurrent = yes; then
-    INTL_MACOSX_LIBS="-Wl,-framework -Wl,CoreFoundation"
-  fi
-
-
-
-
-
-
-  LIBINTL=
-  LTLIBINTL=
-  POSUB=
-
-    case " $gt_needs " in
-    *" need-formatstring-macros "*) gt_api_version=3 ;;
-    *" need-ngettext "*) gt_api_version=2 ;;
-    *) gt_api_version=1 ;;
-  esac
-  gt_func_gnugettext_libc="gt_cv_func_gnugettext${gt_api_version}_libc"
-  gt_func_gnugettext_libintl="gt_cv_func_gnugettext${gt_api_version}_libintl"
-
-    if test "$USE_NLS" = "yes"; then
-    gt_use_preinstalled_gnugettext=no
-
-
-        if test $gt_api_version -ge 3; then
-          gt_revision_test_code='
-#ifndef __GNU_GETTEXT_SUPPORTED_REVISION
-#define __GNU_GETTEXT_SUPPORTED_REVISION(major) ((major) == 0 ? 0 : -1)
-#endif
-typedef int array [2 * (__GNU_GETTEXT_SUPPORTED_REVISION(0) >= 1) - 1];
-'
-        else
-          gt_revision_test_code=
-        fi
-        if test $gt_api_version -ge 2; then
-          gt_expression_test_code=' + * ngettext ("", "", 0)'
-        else
-          gt_expression_test_code=
-        fi
-
-        { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GNU gettext in libc" >&5
-$as_echo_n "checking for GNU gettext in libc... " >&6; }
-if eval \${$gt_func_gnugettext_libc+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <libintl.h>
-$gt_revision_test_code
-extern int _nl_msg_cat_cntr;
-extern int *_nl_domain_bindings;
-int
-main ()
-{
-bindtextdomain ("", "");
-return * gettext ("")$gt_expression_test_code + _nl_msg_cat_cntr + *_nl_domain_bindings
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  eval "$gt_func_gnugettext_libc=yes"
-else
-  eval "$gt_func_gnugettext_libc=no"
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-fi
-eval ac_res=\$$gt_func_gnugettext_libc
-	       { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_res" >&5
-$as_echo "$ac_res" >&6; }
-
-        if { eval "gt_val=\$$gt_func_gnugettext_libc"; test "$gt_val" != "yes"; }; then
-
-
-
-
-
-          am_save_CPPFLAGS="$CPPFLAGS"
-
-  for element in $INCICONV; do
-    haveit=
-    for x in $CPPFLAGS; do
-
-  acl_save_prefix="$prefix"
-  prefix="$acl_final_prefix"
-  acl_save_exec_prefix="$exec_prefix"
-  exec_prefix="$acl_final_exec_prefix"
-  eval x=\"$x\"
-  exec_prefix="$acl_save_exec_prefix"
-  prefix="$acl_save_prefix"
-
-      if test "X$x" = "X$element"; then
-        haveit=yes
-        break
-      fi
-    done
-    if test -z "$haveit"; then
-      CPPFLAGS="${CPPFLAGS}${CPPFLAGS:+ }$element"
-    fi
-  done
-
-
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for iconv" >&5
-$as_echo_n "checking for iconv... " >&6; }
-if ${am_cv_func_iconv+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-
-    am_cv_func_iconv="no, consider installing GNU libiconv"
-    am_cv_lib_iconv=no
-    cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <stdlib.h>
-#include <iconv.h>
-int
-main ()
-{
-iconv_t cd = iconv_open("","");
-       iconv(cd,NULL,NULL,NULL,NULL);
-       iconv_close(cd);
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  am_cv_func_iconv=yes
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-    if test "$am_cv_func_iconv" != yes; then
-      am_save_LIBS="$LIBS"
-      LIBS="$LIBS $LIBICONV"
-      cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <stdlib.h>
-#include <iconv.h>
-int
-main ()
-{
-iconv_t cd = iconv_open("","");
-         iconv(cd,NULL,NULL,NULL,NULL);
-         iconv_close(cd);
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  am_cv_lib_iconv=yes
-        am_cv_func_iconv=yes
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-      LIBS="$am_save_LIBS"
-    fi
-
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $am_cv_func_iconv" >&5
-$as_echo "$am_cv_func_iconv" >&6; }
-  if test "$am_cv_func_iconv" = yes; then
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking for working iconv" >&5
-$as_echo_n "checking for working iconv... " >&6; }
-if ${am_cv_func_iconv_works+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-
-            am_save_LIBS="$LIBS"
-      if test $am_cv_lib_iconv = yes; then
-        LIBS="$LIBS $LIBICONV"
-      fi
-      if test "$cross_compiling" = yes; then :
-  case "$host_os" in
-           aix* | hpux*) am_cv_func_iconv_works="guessing no" ;;
-           *)            am_cv_func_iconv_works="guessing yes" ;;
-         esac
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-#include <iconv.h>
-#include <string.h>
-int main ()
-{
-  /* Test against AIX 5.1 bug: Failures are not distinguishable from successful
-     returns.  */
-  {
-    iconv_t cd_utf8_to_88591 = iconv_open ("ISO8859-1", "UTF-8");
-    if (cd_utf8_to_88591 != (iconv_t)(-1))
-      {
-        static const char input[] = "\342\202\254"; /* EURO SIGN */
-        char buf[10];
-        const char *inptr = input;
-        size_t inbytesleft = strlen (input);
-        char *outptr = buf;
-        size_t outbytesleft = sizeof (buf);
-        size_t res = iconv (cd_utf8_to_88591,
-                            (char **) &inptr, &inbytesleft,
-                            &outptr, &outbytesleft);
-        if (res == 0)
-          return 1;
-      }
-  }
-  /* Test against Solaris 10 bug: Failures are not distinguishable from
-     successful returns.  */
-  {
-    iconv_t cd_ascii_to_88591 = iconv_open ("ISO8859-1", "646");
-    if (cd_ascii_to_88591 != (iconv_t)(-1))
-      {
-        static const char input[] = "\263";
-        char buf[10];
-        const char *inptr = input;
-        size_t inbytesleft = strlen (input);
-        char *outptr = buf;
-        size_t outbytesleft = sizeof (buf);
-        size_t res = iconv (cd_ascii_to_88591,
-                            (char **) &inptr, &inbytesleft,
-                            &outptr, &outbytesleft);
-        if (res == 0)
-          return 1;
-      }
-  }
-#if 0 /* This bug could be worked around by the caller.  */
-  /* Test against HP-UX 11.11 bug: Positive return value instead of 0.  */
-  {
-    iconv_t cd_88591_to_utf8 = iconv_open ("utf8", "iso88591");
-    if (cd_88591_to_utf8 != (iconv_t)(-1))
-      {
-        static const char input[] = "\304rger mit b\366sen B\374bchen ohne Augenma\337";
-        char buf[50];
-        const char *inptr = input;
-        size_t inbytesleft = strlen (input);
-        char *outptr = buf;
-        size_t outbytesleft = sizeof (buf);
-        size_t res = iconv (cd_88591_to_utf8,
-                            (char **) &inptr, &inbytesleft,
-                            &outptr, &outbytesleft);
-        if ((int)res > 0)
-          return 1;
-      }
-  }
-#endif
-  /* Test against HP-UX 11.11 bug: No converter from EUC-JP to UTF-8 is
-     provided.  */
-  if (/* Try standardized names.  */
-      iconv_open ("UTF-8", "EUC-JP") == (iconv_t)(-1)
-      /* Try IRIX, OSF/1 names.  */
-      && iconv_open ("UTF-8", "eucJP") == (iconv_t)(-1)
-      /* Try AIX names.  */
-      && iconv_open ("UTF-8", "IBM-eucJP") == (iconv_t)(-1)
-      /* Try HP-UX names.  */
-      && iconv_open ("utf8", "eucJP") == (iconv_t)(-1))
-    return 1;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_run "$LINENO"; then :
-  am_cv_func_iconv_works=yes
-else
-  am_cv_func_iconv_works=no
-fi
-rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext \
-  conftest.$ac_objext conftest.beam conftest.$ac_ext
-fi
-
-      LIBS="$am_save_LIBS"
-
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $am_cv_func_iconv_works" >&5
-$as_echo "$am_cv_func_iconv_works" >&6; }
-    case "$am_cv_func_iconv_works" in
-      *no) am_func_iconv=no am_cv_lib_iconv=no ;;
-      *)   am_func_iconv=yes ;;
-    esac
-  else
-    am_func_iconv=no am_cv_lib_iconv=no
-  fi
-  if test "$am_func_iconv" = yes; then
-
-$as_echo "#define HAVE_ICONV 1" >>confdefs.h
-
-  fi
-  if test "$am_cv_lib_iconv" = yes; then
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking how to link with libiconv" >&5
-$as_echo_n "checking how to link with libiconv... " >&6; }
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: $LIBICONV" >&5
-$as_echo "$LIBICONV" >&6; }
-  else
-            CPPFLAGS="$am_save_CPPFLAGS"
-    LIBICONV=
-    LTLIBICONV=
-  fi
-
-
-
-
-
-
-
-
-
-
-
-    use_additional=yes
-
-  acl_save_prefix="$prefix"
-  prefix="$acl_final_prefix"
-  acl_save_exec_prefix="$exec_prefix"
-  exec_prefix="$acl_final_exec_prefix"
-
-    eval additional_includedir=\"$includedir\"
-    eval additional_libdir=\"$libdir\"
-
-  exec_prefix="$acl_save_exec_prefix"
-  prefix="$acl_save_prefix"
-
-
-# Check whether --with-libintl-prefix was given.
-if test "${with_libintl_prefix+set}" = set; then :
-  withval=$with_libintl_prefix;
-    if test "X$withval" = "Xno"; then
-      use_additional=no
-    else
-      if test "X$withval" = "X"; then
-
-  acl_save_prefix="$prefix"
-  prefix="$acl_final_prefix"
-  acl_save_exec_prefix="$exec_prefix"
-  exec_prefix="$acl_final_exec_prefix"
-
-          eval additional_includedir=\"$includedir\"
-          eval additional_libdir=\"$libdir\"
-
-  exec_prefix="$acl_save_exec_prefix"
-  prefix="$acl_save_prefix"
-
-      else
-        additional_includedir="$withval/include"
-        additional_libdir="$withval/$acl_libdirstem"
-        if test "$acl_libdirstem2" != "$acl_libdirstem" \
-           && ! test -d "$withval/$acl_libdirstem"; then
-          additional_libdir="$withval/$acl_libdirstem2"
-        fi
-      fi
-    fi
-
-fi
-
-      LIBINTL=
-  LTLIBINTL=
-  INCINTL=
-  LIBINTL_PREFIX=
-      HAVE_LIBINTL=
-  rpathdirs=
-  ltrpathdirs=
-  names_already_handled=
-  names_next_round='intl '
-  while test -n "$names_next_round"; do
-    names_this_round="$names_next_round"
-    names_next_round=
-    for name in $names_this_round; do
-      already_handled=
-      for n in $names_already_handled; do
-        if test "$n" = "$name"; then
-          already_handled=yes
-          break
-        fi
-      done
-      if test -z "$already_handled"; then
-        names_already_handled="$names_already_handled $name"
-                        uppername=`echo "$name" | sed -e 'y|abcdefghijklmnopqrstuvwxyz./-|ABCDEFGHIJKLMNOPQRSTUVWXYZ___|'`
-        eval value=\"\$HAVE_LIB$uppername\"
-        if test -n "$value"; then
-          if test "$value" = yes; then
-            eval value=\"\$LIB$uppername\"
-            test -z "$value" || LIBINTL="${LIBINTL}${LIBINTL:+ }$value"
-            eval value=\"\$LTLIB$uppername\"
-            test -z "$value" || LTLIBINTL="${LTLIBINTL}${LTLIBINTL:+ }$value"
-          else
-                                    :
-          fi
-        else
-                              found_dir=
-          found_la=
-          found_so=
-          found_a=
-          eval libname=\"$acl_libname_spec\"    # typically: libname=lib$name
-          if test -n "$acl_shlibext"; then
-            shrext=".$acl_shlibext"             # typically: shrext=.so
-          else
-            shrext=
-          fi
-          if test $use_additional = yes; then
-            dir="$additional_libdir"
-                                    if test -n "$acl_shlibext"; then
-              if test -f "$dir/$libname$shrext"; then
-                found_dir="$dir"
-                found_so="$dir/$libname$shrext"
-              else
-                if test "$acl_library_names_spec" = '$libname$shrext$versuffix'; then
-                  ver=`(cd "$dir" && \
-                        for f in "$libname$shrext".*; do echo "$f"; done \
-                        | sed -e "s,^$libname$shrext\\\\.,," \
-                        | sort -t '.' -n -r -k1,1 -k2,2 -k3,3 -k4,4 -k5,5 \
-                        | sed 1q ) 2>/dev/null`
-                  if test -n "$ver" && test -f "$dir/$libname$shrext.$ver"; then
-                    found_dir="$dir"
-                    found_so="$dir/$libname$shrext.$ver"
-                  fi
-                else
-                  eval library_names=\"$acl_library_names_spec\"
-                  for f in $library_names; do
-                    if test -f "$dir/$f"; then
-                      found_dir="$dir"
-                      found_so="$dir/$f"
-                      break
-                    fi
-                  done
-                fi
-              fi
-            fi
-                        if test "X$found_dir" = "X"; then
-              if test -f "$dir/$libname.$acl_libext"; then
-                found_dir="$dir"
-                found_a="$dir/$libname.$acl_libext"
-              fi
-            fi
-            if test "X$found_dir" != "X"; then
-              if test -f "$dir/$libname.la"; then
-                found_la="$dir/$libname.la"
-              fi
-            fi
-          fi
-          if test "X$found_dir" = "X"; then
-            for x in $LDFLAGS $LTLIBINTL; do
-
-  acl_save_prefix="$prefix"
-  prefix="$acl_final_prefix"
-  acl_save_exec_prefix="$exec_prefix"
-  exec_prefix="$acl_final_exec_prefix"
-  eval x=\"$x\"
-  exec_prefix="$acl_save_exec_prefix"
-  prefix="$acl_save_prefix"
-
-              case "$x" in
-                -L*)
-                  dir=`echo "X$x" | sed -e 's/^X-L//'`
-                                    if test -n "$acl_shlibext"; then
-                    if test -f "$dir/$libname$shrext"; then
-                      found_dir="$dir"
-                      found_so="$dir/$libname$shrext"
-                    else
-                      if test "$acl_library_names_spec" = '$libname$shrext$versuffix'; then
-                        ver=`(cd "$dir" && \
-                              for f in "$libname$shrext".*; do echo "$f"; done \
-                              | sed -e "s,^$libname$shrext\\\\.,," \
-                              | sort -t '.' -n -r -k1,1 -k2,2 -k3,3 -k4,4 -k5,5 \
-                              | sed 1q ) 2>/dev/null`
-                        if test -n "$ver" && test -f "$dir/$libname$shrext.$ver"; then
-                          found_dir="$dir"
-                          found_so="$dir/$libname$shrext.$ver"
-                        fi
-                      else
-                        eval library_names=\"$acl_library_names_spec\"
-                        for f in $library_names; do
-                          if test -f "$dir/$f"; then
-                            found_dir="$dir"
-                            found_so="$dir/$f"
-                            break
-                          fi
-                        done
-                      fi
-                    fi
-                  fi
-                                    if test "X$found_dir" = "X"; then
-                    if test -f "$dir/$libname.$acl_libext"; then
-                      found_dir="$dir"
-                      found_a="$dir/$libname.$acl_libext"
-                    fi
-                  fi
-                  if test "X$found_dir" != "X"; then
-                    if test -f "$dir/$libname.la"; then
-                      found_la="$dir/$libname.la"
-                    fi
-                  fi
-                  ;;
-              esac
-              if test "X$found_dir" != "X"; then
-                break
-              fi
-            done
-          fi
-          if test "X$found_dir" != "X"; then
-                        LTLIBINTL="${LTLIBINTL}${LTLIBINTL:+ }-L$found_dir -l$name"
-            if test "X$found_so" != "X"; then
-                                                        if test "$enable_rpath" = no \
-                 || test "X$found_dir" = "X/usr/$acl_libdirstem" \
-                 || test "X$found_dir" = "X/usr/$acl_libdirstem2"; then
-                                LIBINTL="${LIBINTL}${LIBINTL:+ }$found_so"
-              else
-                                                                                haveit=
-                for x in $ltrpathdirs; do
-                  if test "X$x" = "X$found_dir"; then
-                    haveit=yes
-                    break
-                  fi
-                done
-                if test -z "$haveit"; then
-                  ltrpathdirs="$ltrpathdirs $found_dir"
-                fi
-                                if test "$acl_hardcode_direct" = yes; then
-                                                      LIBINTL="${LIBINTL}${LIBINTL:+ }$found_so"
-                else
-                  if test -n "$acl_hardcode_libdir_flag_spec" && test "$acl_hardcode_minus_L" = no; then
-                                                            LIBINTL="${LIBINTL}${LIBINTL:+ }$found_so"
-                                                            haveit=
-                    for x in $rpathdirs; do
-                      if test "X$x" = "X$found_dir"; then
-                        haveit=yes
-                        break
-                      fi
-                    done
-                    if test -z "$haveit"; then
-                      rpathdirs="$rpathdirs $found_dir"
-                    fi
-                  else
-                                                                                haveit=
-                    for x in $LDFLAGS $LIBINTL; do
-
-  acl_save_prefix="$prefix"
-  prefix="$acl_final_prefix"
-  acl_save_exec_prefix="$exec_prefix"
-  exec_prefix="$acl_final_exec_prefix"
-  eval x=\"$x\"
-  exec_prefix="$acl_save_exec_prefix"
-  prefix="$acl_save_prefix"
-
-                      if test "X$x" = "X-L$found_dir"; then
-                        haveit=yes
-                        break
-                      fi
-                    done
-                    if test -z "$haveit"; then
-                      LIBINTL="${LIBINTL}${LIBINTL:+ }-L$found_dir"
-                    fi
-                    if test "$acl_hardcode_minus_L" != no; then
-                                                                                        LIBINTL="${LIBINTL}${LIBINTL:+ }$found_so"
-                    else
-                                                                                                                                                                                LIBINTL="${LIBINTL}${LIBINTL:+ }-l$name"
-                    fi
-                  fi
-                fi
-              fi
-            else
-              if test "X$found_a" != "X"; then
-                                LIBINTL="${LIBINTL}${LIBINTL:+ }$found_a"
-              else
-                                                LIBINTL="${LIBINTL}${LIBINTL:+ }-L$found_dir -l$name"
-              fi
-            fi
-                        additional_includedir=
-            case "$found_dir" in
-              */$acl_libdirstem | */$acl_libdirstem/)
-                basedir=`echo "X$found_dir" | sed -e 's,^X,,' -e "s,/$acl_libdirstem/"'*$,,'`
-                if test "$name" = 'intl'; then
-                  LIBINTL_PREFIX="$basedir"
-                fi
-                additional_includedir="$basedir/include"
-                ;;
-              */$acl_libdirstem2 | */$acl_libdirstem2/)
-                basedir=`echo "X$found_dir" | sed -e 's,^X,,' -e "s,/$acl_libdirstem2/"'*$,,'`
-                if test "$name" = 'intl'; then
-                  LIBINTL_PREFIX="$basedir"
-                fi
-                additional_includedir="$basedir/include"
-                ;;
-            esac
-            if test "X$additional_includedir" != "X"; then
-                                                                                                                if test "X$additional_includedir" != "X/usr/include"; then
-                haveit=
-                if test "X$additional_includedir" = "X/usr/local/include"; then
-                  if test -n "$GCC"; then
-                    case $host_os in
-                      linux* | gnu* | k*bsd*-gnu) haveit=yes;;
-                    esac
-                  fi
-                fi
-                if test -z "$haveit"; then
-                  for x in $CPPFLAGS $INCINTL; do
-
-  acl_save_prefix="$prefix"
-  prefix="$acl_final_prefix"
-  acl_save_exec_prefix="$exec_prefix"
-  exec_prefix="$acl_final_exec_prefix"
-  eval x=\"$x\"
-  exec_prefix="$acl_save_exec_prefix"
-  prefix="$acl_save_prefix"
-
-                    if test "X$x" = "X-I$additional_includedir"; then
-                      haveit=yes
-                      break
-                    fi
-                  done
-                  if test -z "$haveit"; then
-                    if test -d "$additional_includedir"; then
-                                            INCINTL="${INCINTL}${INCINTL:+ }-I$additional_includedir"
-                    fi
-                  fi
-                fi
-              fi
-            fi
-                        if test -n "$found_la"; then
-                                                        save_libdir="$libdir"
-              case "$found_la" in
-                */* | *\\*) . "$found_la" ;;
-                *) . "./$found_la" ;;
-              esac
-              libdir="$save_libdir"
-                            for dep in $dependency_libs; do
-                case "$dep" in
-                  -L*)
-                    additional_libdir=`echo "X$dep" | sed -e 's/^X-L//'`
-                                                                                                                                                                if test "X$additional_libdir" != "X/usr/$acl_libdirstem" \
-                       && test "X$additional_libdir" != "X/usr/$acl_libdirstem2"; then
-                      haveit=
-                      if test "X$additional_libdir" = "X/usr/local/$acl_libdirstem" \
-                         || test "X$additional_libdir" = "X/usr/local/$acl_libdirstem2"; then
-                        if test -n "$GCC"; then
-                          case $host_os in
-                            linux* | gnu* | k*bsd*-gnu) haveit=yes;;
-                          esac
-                        fi
-                      fi
-                      if test -z "$haveit"; then
-                        haveit=
-                        for x in $LDFLAGS $LIBINTL; do
+$as_echo "#define TM_IN_SYS_TIME 1" >>confdefs.h
 
-  acl_save_prefix="$prefix"
-  prefix="$acl_final_prefix"
-  acl_save_exec_prefix="$exec_prefix"
-  exec_prefix="$acl_final_exec_prefix"
-  eval x=\"$x\"
-  exec_prefix="$acl_save_exec_prefix"
-  prefix="$acl_save_prefix"
+fi
 
-                          if test "X$x" = "X-L$additional_libdir"; then
-                            haveit=yes
-                            break
-                          fi
-                        done
-                        if test -z "$haveit"; then
-                          if test -d "$additional_libdir"; then
-                                                        LIBINTL="${LIBINTL}${LIBINTL:+ }-L$additional_libdir"
-                          fi
-                        fi
-                        haveit=
-                        for x in $LDFLAGS $LTLIBINTL; do
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for uid_t in sys/types.h" >&5
+$as_echo_n "checking for uid_t in sys/types.h... " >&6; }
+if ${ac_cv_type_uid_t+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+#include <sys/types.h>
 
-  acl_save_prefix="$prefix"
-  prefix="$acl_final_prefix"
-  acl_save_exec_prefix="$exec_prefix"
-  exec_prefix="$acl_final_exec_prefix"
-  eval x=\"$x\"
-  exec_prefix="$acl_save_exec_prefix"
-  prefix="$acl_save_prefix"
+_ACEOF
+if (eval "$ac_cpp conftest.$ac_ext") 2>&5 |
+  $EGREP "uid_t" >/dev/null 2>&1; then :
+  ac_cv_type_uid_t=yes
+else
+  ac_cv_type_uid_t=no
+fi
+rm -f conftest*
 
-                          if test "X$x" = "X-L$additional_libdir"; then
-                            haveit=yes
-                            break
-                          fi
-                        done
-                        if test -z "$haveit"; then
-                          if test -d "$additional_libdir"; then
-                                                        LTLIBINTL="${LTLIBINTL}${LTLIBINTL:+ }-L$additional_libdir"
-                          fi
-                        fi
-                      fi
-                    fi
-                    ;;
-                  -R*)
-                    dir=`echo "X$dep" | sed -e 's/^X-R//'`
-                    if test "$enable_rpath" != no; then
-                                                                  haveit=
-                      for x in $rpathdirs; do
-                        if test "X$x" = "X$dir"; then
-                          haveit=yes
-                          break
-                        fi
-                      done
-                      if test -z "$haveit"; then
-                        rpathdirs="$rpathdirs $dir"
-                      fi
-                                                                  haveit=
-                      for x in $ltrpathdirs; do
-                        if test "X$x" = "X$dir"; then
-                          haveit=yes
-                          break
-                        fi
-                      done
-                      if test -z "$haveit"; then
-                        ltrpathdirs="$ltrpathdirs $dir"
-                      fi
-                    fi
-                    ;;
-                  -l*)
-                                        names_next_round="$names_next_round "`echo "X$dep" | sed -e 's/^X-l//'`
-                    ;;
-                  *.la)
-                                                                                names_next_round="$names_next_round "`echo "X$dep" | sed -e 's,^X.*/,,' -e 's,^lib,,' -e 's,\.la$,,'`
-                    ;;
-                  *)
-                                        LIBINTL="${LIBINTL}${LIBINTL:+ }$dep"
-                    LTLIBINTL="${LTLIBINTL}${LTLIBINTL:+ }$dep"
-                    ;;
-                esac
-              done
-            fi
-          else
-                                                            LIBINTL="${LIBINTL}${LIBINTL:+ }-l$name"
-            LTLIBINTL="${LTLIBINTL}${LTLIBINTL:+ }-l$name"
-          fi
-        fi
-      fi
-    done
-  done
-  if test "X$rpathdirs" != "X"; then
-    if test -n "$acl_hardcode_libdir_separator"; then
-                        alldirs=
-      for found_dir in $rpathdirs; do
-        alldirs="${alldirs}${alldirs:+$acl_hardcode_libdir_separator}$found_dir"
-      done
-            acl_save_libdir="$libdir"
-      libdir="$alldirs"
-      eval flag=\"$acl_hardcode_libdir_flag_spec\"
-      libdir="$acl_save_libdir"
-      LIBINTL="${LIBINTL}${LIBINTL:+ }$flag"
-    else
-            for found_dir in $rpathdirs; do
-        acl_save_libdir="$libdir"
-        libdir="$found_dir"
-        eval flag=\"$acl_hardcode_libdir_flag_spec\"
-        libdir="$acl_save_libdir"
-        LIBINTL="${LIBINTL}${LIBINTL:+ }$flag"
-      done
-    fi
-  fi
-  if test "X$ltrpathdirs" != "X"; then
-            for found_dir in $ltrpathdirs; do
-      LTLIBINTL="${LTLIBINTL}${LTLIBINTL:+ }-R$found_dir"
-    done
-  fi
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_type_uid_t" >&5
+$as_echo "$ac_cv_type_uid_t" >&6; }
+if test $ac_cv_type_uid_t = no; then
 
+$as_echo "#define uid_t int" >>confdefs.h
 
 
+$as_echo "#define gid_t int" >>confdefs.h
 
+fi
 
+ac_header_dirent=no
+for ac_hdr in dirent.h sys/ndir.h sys/dir.h ndir.h; do
+  as_ac_Header=`$as_echo "ac_cv_header_dirent_$ac_hdr" | $as_tr_sh`
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_hdr that defines DIR" >&5
+$as_echo_n "checking for $ac_hdr that defines DIR... " >&6; }
+if eval \${$as_ac_Header+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+#include <sys/types.h>
+#include <$ac_hdr>
 
-          { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GNU gettext in libintl" >&5
-$as_echo_n "checking for GNU gettext in libintl... " >&6; }
-if eval \${$gt_func_gnugettext_libintl+:} false; then :
+int
+main ()
+{
+if ((DIR *) 0)
+return 0;
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_compile "$LINENO"; then :
+  eval "$as_ac_Header=yes"
+else
+  eval "$as_ac_Header=no"
+fi
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+fi
+eval ac_res=\$$as_ac_Header
+	       { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_res" >&5
+$as_echo "$ac_res" >&6; }
+if eval test \"x\$"$as_ac_Header"\" = x"yes"; then :
+  cat >>confdefs.h <<_ACEOF
+#define `$as_echo "HAVE_$ac_hdr" | $as_tr_cpp` 1
+_ACEOF
+
+ac_header_dirent=$ac_hdr; break
+fi
+
+done
+# Two versions of opendir et al. are in -ldir and -lx on SCO Xenix.
+if test $ac_header_dirent = dirent.h; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for library containing opendir" >&5
+$as_echo_n "checking for library containing opendir... " >&6; }
+if ${ac_cv_search_opendir+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  gt_save_CPPFLAGS="$CPPFLAGS"
-            CPPFLAGS="$CPPFLAGS $INCINTL"
-            gt_save_LIBS="$LIBS"
-            LIBS="$LIBS $LIBINTL"
-                        cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+  ac_func_search_save_LIBS=$LIBS
+cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
-#include <libintl.h>
-$gt_revision_test_code
-extern int _nl_msg_cat_cntr;
-extern
+
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
+#ifdef __cplusplus
+extern "C"
+#endif
+char opendir ();
+int
+main ()
+{
+return opendir ();
+  ;
+  return 0;
+}
+_ACEOF
+for ac_lib in '' dir; do
+  if test -z "$ac_lib"; then
+    ac_res="none required"
+  else
+    ac_res=-l$ac_lib
+    LIBS="-l$ac_lib  $ac_func_search_save_LIBS"
+  fi
+  if ac_fn_c_try_link "$LINENO"; then :
+  ac_cv_search_opendir=$ac_res
+fi
+rm -f core conftest.err conftest.$ac_objext \
+    conftest$ac_exeext
+  if ${ac_cv_search_opendir+:} false; then :
+  break
+fi
+done
+if ${ac_cv_search_opendir+:} false; then :
+
+else
+  ac_cv_search_opendir=no
+fi
+rm conftest.$ac_ext
+LIBS=$ac_func_search_save_LIBS
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_search_opendir" >&5
+$as_echo "$ac_cv_search_opendir" >&6; }
+ac_res=$ac_cv_search_opendir
+if test "$ac_res" != no; then :
+  test "$ac_res" = "none required" || LIBS="$ac_res $LIBS"
+
+fi
+
+else
+  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for library containing opendir" >&5
+$as_echo_n "checking for library containing opendir... " >&6; }
+if ${ac_cv_search_opendir+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  ac_func_search_save_LIBS=$LIBS
+cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
 #ifdef __cplusplus
-"C"
+extern "C"
 #endif
-const char *_nl_expand_alias (const char *);
+char opendir ();
 int
 main ()
 {
-bindtextdomain ("", "");
-return * gettext ("")$gt_expression_test_code + _nl_msg_cat_cntr + *_nl_expand_alias ("")
+return opendir ();
   ;
   return 0;
 }
 _ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  eval "$gt_func_gnugettext_libintl=yes"
-else
-  eval "$gt_func_gnugettext_libintl=no"
+for ac_lib in '' x; do
+  if test -z "$ac_lib"; then
+    ac_res="none required"
+  else
+    ac_res=-l$ac_lib
+    LIBS="-l$ac_lib  $ac_func_search_save_LIBS"
+  fi
+  if ac_fn_c_try_link "$LINENO"; then :
+  ac_cv_search_opendir=$ac_res
 fi
 rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-                        if { eval "gt_val=\$$gt_func_gnugettext_libintl"; test "$gt_val" != yes; } && test -n "$LIBICONV"; then
-              LIBS="$LIBS $LIBICONV"
-              cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <libintl.h>
-$gt_revision_test_code
-extern int _nl_msg_cat_cntr;
-extern
-#ifdef __cplusplus
-"C"
+    conftest$ac_exeext
+  if ${ac_cv_search_opendir+:} false; then :
+  break
+fi
+done
+if ${ac_cv_search_opendir+:} false; then :
+
+else
+  ac_cv_search_opendir=no
+fi
+rm conftest.$ac_ext
+LIBS=$ac_func_search_save_LIBS
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_search_opendir" >&5
+$as_echo "$ac_cv_search_opendir" >&6; }
+ac_res=$ac_cv_search_opendir
+if test "$ac_res" != no; then :
+  test "$ac_res" = "none required" || LIBS="$ac_res $LIBS"
+
+fi
+
+fi
+
+
+
+  ac_fn_c_check_member "$LINENO" "struct dirent" "d_type" "ac_cv_member_struct_dirent_d_type" "
+#include <sys/types.h>
+#ifdef HAVE_DIRENT_H
+# include <dirent.h>
+#else
+# define dirent direct
+# ifdef HAVE_SYS_NDIR_H
+#  include <sys/ndir.h>
+# endif
+# ifdef HAVE_SYS_DIR_H
+#  include <sys/dir.h>
+# endif
+# ifdef HAVE_NDIR_H
+#  include <ndir.h>
+# endif
 #endif
-const char *_nl_expand_alias (const char *);
-int
-main ()
-{
-bindtextdomain ("", "");
-return * gettext ("")$gt_expression_test_code + _nl_msg_cat_cntr + *_nl_expand_alias ("")
-  ;
-  return 0;
-}
+
+"
+if test "x$ac_cv_member_struct_dirent_d_type" = xyes; then :
+
+cat >>confdefs.h <<_ACEOF
+#define HAVE_STRUCT_DIRENT_D_TYPE 1
 _ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  LIBINTL="$LIBINTL $LIBICONV"
-                LTLIBINTL="$LTLIBINTL $LTLIBICONV"
-                eval "$gt_func_gnugettext_libintl=yes"
+
 
 fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-            fi
-            CPPFLAGS="$gt_save_CPPFLAGS"
-            LIBS="$gt_save_LIBS"
+
+
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking PATH_MAX defined" >&5
+$as_echo_n "checking PATH_MAX defined... " >&6; }
+if ${path_max_cv_defined+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+[
+#include <limits.h>
+#if defined(PATH_MAX)
+yes
+#endif
+]
+_ACEOF
+if (eval "$ac_cpp conftest.$ac_ext") 2>&5 |
+  $EGREP "yes" >/dev/null 2>&1; then :
+  path_max_cv_defined=yes
+else
+  path_max_cv_defined=no
 fi
-eval ac_res=\$$gt_func_gnugettext_libintl
-	       { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_res" >&5
-$as_echo "$ac_res" >&6; }
-        fi
+rm -f conftest*
 
-                                        if { eval "gt_val=\$$gt_func_gnugettext_libc"; test "$gt_val" = "yes"; } \
-           || { { eval "gt_val=\$$gt_func_gnugettext_libintl"; test "$gt_val" = "yes"; } \
-                && test "$PACKAGE" != gettext-runtime \
-                && test "$PACKAGE" != gettext-tools; }; then
-          gt_use_preinstalled_gnugettext=yes
-        else
-                    LIBINTL=
-          LTLIBINTL=
-          INCINTL=
-        fi
 
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $path_max_cv_defined" >&5
+$as_echo "$path_max_cv_defined" >&6; }
+  if test $path_max_cv_defined = no; then
 
+$as_echo "#define PATH_MAX 4096" >>confdefs.h
 
-    if test -n "$INTL_MACOSX_LIBS"; then
-      if test "$gt_use_preinstalled_gnugettext" = "yes" \
-         || test "$nls_cv_use_gnu_gettext" = "yes"; then
-                LIBINTL="$LIBINTL $INTL_MACOSX_LIBS"
-        LTLIBINTL="$LTLIBINTL $INTL_MACOSX_LIBS"
-      fi
-    fi
+  fi
 
-    if test "$gt_use_preinstalled_gnugettext" = "yes" \
-       || test "$nls_cv_use_gnu_gettext" = "yes"; then
 
-$as_echo "#define ENABLE_NLS 1" >>confdefs.h
+# Checks for library functions.
+for ac_header in vfork.h
+do :
+  ac_fn_c_check_header_mongrel "$LINENO" "vfork.h" "ac_cv_header_vfork_h" "$ac_includes_default"
+if test "x$ac_cv_header_vfork_h" = xyes; then :
+  cat >>confdefs.h <<_ACEOF
+#define HAVE_VFORK_H 1
+_ACEOF
 
-    else
-      USE_NLS=no
-    fi
-  fi
+fi
 
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether to use NLS" >&5
-$as_echo_n "checking whether to use NLS... " >&6; }
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $USE_NLS" >&5
-$as_echo "$USE_NLS" >&6; }
-  if test "$USE_NLS" = "yes"; then
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking where the gettext function comes from" >&5
-$as_echo_n "checking where the gettext function comes from... " >&6; }
-    if test "$gt_use_preinstalled_gnugettext" = "yes"; then
-      if { eval "gt_val=\$$gt_func_gnugettext_libintl"; test "$gt_val" = "yes"; }; then
-        gt_source="external libintl"
-      else
-        gt_source="libc"
-      fi
-    else
-      gt_source="included intl directory"
-    fi
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: $gt_source" >&5
-$as_echo "$gt_source" >&6; }
-  fi
+done
 
-  if test "$USE_NLS" = "yes"; then
+for ac_func in fork vfork
+do :
+  as_ac_var=`$as_echo "ac_cv_func_$ac_func" | $as_tr_sh`
+ac_fn_c_check_func "$LINENO" "$ac_func" "$as_ac_var"
+if eval test \"x\$"$as_ac_var"\" = x"yes"; then :
+  cat >>confdefs.h <<_ACEOF
+#define `$as_echo "HAVE_$ac_func" | $as_tr_cpp` 1
+_ACEOF
 
-    if test "$gt_use_preinstalled_gnugettext" = "yes"; then
-      if { eval "gt_val=\$$gt_func_gnugettext_libintl"; test "$gt_val" = "yes"; }; then
-        { $as_echo "$as_me:${as_lineno-$LINENO}: checking how to link with libintl" >&5
-$as_echo_n "checking how to link with libintl... " >&6; }
-        { $as_echo "$as_me:${as_lineno-$LINENO}: result: $LIBINTL" >&5
-$as_echo "$LIBINTL" >&6; }
+fi
+done
 
-  for element in $INCINTL; do
-    haveit=
-    for x in $CPPFLAGS; do
+if test "x$ac_cv_func_fork" = xyes; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for working fork" >&5
+$as_echo_n "checking for working fork... " >&6; }
+if ${ac_cv_func_fork_works+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  if test "$cross_compiling" = yes; then :
+  ac_cv_func_fork_works=cross
+else
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+$ac_includes_default
+int
+main ()
+{
 
-  acl_save_prefix="$prefix"
-  prefix="$acl_final_prefix"
-  acl_save_exec_prefix="$exec_prefix"
-  exec_prefix="$acl_final_exec_prefix"
-  eval x=\"$x\"
-  exec_prefix="$acl_save_exec_prefix"
-  prefix="$acl_save_prefix"
+	  /* By Ruediger Kuhlmann. */
+	  return fork () < 0;
+
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_run "$LINENO"; then :
+  ac_cv_func_fork_works=yes
+else
+  ac_cv_func_fork_works=no
+fi
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext \
+  conftest.$ac_objext conftest.beam conftest.$ac_ext
+fi
+
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_func_fork_works" >&5
+$as_echo "$ac_cv_func_fork_works" >&6; }
+
+else
+  ac_cv_func_fork_works=$ac_cv_func_fork
+fi
+if test "x$ac_cv_func_fork_works" = xcross; then
+  case $host in
+    *-*-amigaos* | *-*-msdosdjgpp*)
+      # Override, as these systems have only a dummy fork() stub
+      ac_cv_func_fork_works=no
+      ;;
+    *)
+      ac_cv_func_fork_works=yes
+      ;;
+  esac
+  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: result $ac_cv_func_fork_works guessed because of cross compilation" >&5
+$as_echo "$as_me: WARNING: result $ac_cv_func_fork_works guessed because of cross compilation" >&2;}
+fi
+ac_cv_func_vfork_works=$ac_cv_func_vfork
+if test "x$ac_cv_func_vfork" = xyes; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for working vfork" >&5
+$as_echo_n "checking for working vfork... " >&6; }
+if ${ac_cv_func_vfork_works+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  if test "$cross_compiling" = yes; then :
+  ac_cv_func_vfork_works=cross
+else
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+/* Thanks to Paul Eggert for this test.  */
+$ac_includes_default
+#include <sys/wait.h>
+#ifdef HAVE_VFORK_H
+# include <vfork.h>
+#endif
+/* On some sparc systems, changes by the child to local and incoming
+   argument registers are propagated back to the parent.  The compiler
+   is told about this with #include <vfork.h>, but some compilers
+   (e.g. gcc -O) don't grok <vfork.h>.  Test for this by using a
+   static variable whose address is put into a register that is
+   clobbered by the vfork.  */
+static void
+#ifdef __cplusplus
+sparc_address_test (int arg)
+# else
+sparc_address_test (arg) int arg;
+#endif
+{
+  static pid_t child;
+  if (!child) {
+    child = vfork ();
+    if (child < 0) {
+      perror ("vfork");
+      _exit(2);
+    }
+    if (!child) {
+      arg = getpid();
+      write(-1, "", 0);
+      _exit (arg);
+    }
+  }
+}
 
-      if test "X$x" = "X$element"; then
-        haveit=yes
-        break
-      fi
-    done
-    if test -z "$haveit"; then
-      CPPFLAGS="${CPPFLAGS}${CPPFLAGS:+ }$element"
-    fi
-  done
+int
+main ()
+{
+  pid_t parent = getpid ();
+  pid_t child;
 
-      fi
+  sparc_address_test (0);
 
+  child = vfork ();
 
-$as_echo "#define HAVE_GETTEXT 1" >>confdefs.h
+  if (child == 0) {
+    /* Here is another test for sparc vfork register problems.  This
+       test uses lots of local variables, at least as many local
+       variables as main has allocated so far including compiler
+       temporaries.  4 locals are enough for gcc 1.40.3 on a Solaris
+       4.1.3 sparc, but we use 8 to be safe.  A buggy compiler should
+       reuse the register of parent for one of the local variables,
+       since it will think that parent can't possibly be used any more
+       in this routine.  Assigning to the local variable will thus
+       munge parent in the parent process.  */
+    pid_t
+      p = getpid(), p1 = getpid(), p2 = getpid(), p3 = getpid(),
+      p4 = getpid(), p5 = getpid(), p6 = getpid(), p7 = getpid();
+    /* Convince the compiler that p..p7 are live; otherwise, it might
+       use the same hardware register for all 8 local variables.  */
+    if (p != p1 || p != p2 || p != p3 || p != p4
+	|| p != p5 || p != p6 || p != p7)
+      _exit(1);
 
+    /* On some systems (e.g. IRIX 3.3), vfork doesn't separate parent
+       from child file descriptors.  If the child closes a descriptor
+       before it execs or exits, this munges the parent's descriptor
+       as well.  Test for this by closing stdout in the child.  */
+    _exit(close(fileno(stdout)) != 0);
+  } else {
+    int status;
+    struct stat st;
 
-$as_echo "#define HAVE_DCGETTEXT 1" >>confdefs.h
+    while (wait(&status) != child)
+      ;
+    return (
+	 /* Was there some problem with vforking?  */
+	 child < 0
 
-    fi
+	 /* Did the child fail?  (This shouldn't happen.)  */
+	 || status
 
-        POSUB=po
-  fi
+	 /* Did the vfork/compiler bug occur?  */
+	 || parent != getpid()
 
+	 /* Did the file descriptor bug occur?  */
+	 || fstat(fileno(stdout), &st) != 0
+	 );
+  }
+}
+_ACEOF
+if ac_fn_c_try_run "$LINENO"; then :
+  ac_cv_func_vfork_works=yes
+else
+  ac_cv_func_vfork_works=no
+fi
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext \
+  conftest.$ac_objext conftest.beam conftest.$ac_ext
+fi
 
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_func_vfork_works" >&5
+$as_echo "$ac_cv_func_vfork_works" >&6; }
 
-    INTLLIBS="$LIBINTL"
+fi;
+if test "x$ac_cv_func_fork_works" = xcross; then
+  ac_cv_func_vfork_works=$ac_cv_func_vfork
+  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: result $ac_cv_func_vfork_works guessed because of cross compilation" >&5
+$as_echo "$as_me: WARNING: result $ac_cv_func_vfork_works guessed because of cross compilation" >&2;}
+fi
 
+if test "x$ac_cv_func_vfork_works" = xyes; then
 
+$as_echo "#define HAVE_WORKING_VFORK 1" >>confdefs.h
 
+else
 
+$as_echo "#define vfork fork" >>confdefs.h
 
+fi
+if test "x$ac_cv_func_fork_works" = xyes; then
 
+$as_echo "#define HAVE_WORKING_FORK 1" >>confdefs.h
 
+fi
 
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for fabs in -lm" >&5
-$as_echo_n "checking for fabs in -lm... " >&6; }
-if ${ac_cv_lib_m_fabs+:} false; then :
+# getmntent is in the standard C library on UNICOS, in -lsun on Irix 4,
+# -lseq on Dynix/PTX, -lgen on Unixware.
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for library containing getmntent" >&5
+$as_echo_n "checking for library containing getmntent... " >&6; }
+if ${ac_cv_search_getmntent+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  ac_check_lib_save_LIBS=$LIBS
-LIBS="-lm  $LIBS"
+  ac_func_search_save_LIBS=$LIBS
 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
@@ -18170,241 +15578,225 @@
 #ifdef __cplusplus
 extern "C"
 #endif
-char fabs ();
+char getmntent ();
 int
 main ()
 {
-return fabs ();
+return getmntent ();
   ;
   return 0;
 }
 _ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_m_fabs=yes
-else
-  ac_cv_lib_m_fabs=no
+for ac_lib in '' sun seq gen; do
+  if test -z "$ac_lib"; then
+    ac_res="none required"
+  else
+    ac_res=-l$ac_lib
+    LIBS="-l$ac_lib  $ac_func_search_save_LIBS"
+  fi
+  if ac_fn_c_try_link "$LINENO"; then :
+  ac_cv_search_getmntent=$ac_res
 fi
 rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-LIBS=$ac_check_lib_save_LIBS
+    conftest$ac_exeext
+  if ${ac_cv_search_getmntent+:} false; then :
+  break
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_m_fabs" >&5
-$as_echo "$ac_cv_lib_m_fabs" >&6; }
-if test "x$ac_cv_lib_m_fabs" = xyes; then :
-  cat >>confdefs.h <<_ACEOF
-#define HAVE_LIBM 1
-_ACEOF
+done
+if ${ac_cv_search_getmntent+:} false; then :
 
-  LIBS="-lm $LIBS"
+else
+  ac_cv_search_getmntent=no
+fi
+rm conftest.$ac_ext
+LIBS=$ac_func_search_save_LIBS
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_search_getmntent" >&5
+$as_echo "$ac_cv_search_getmntent" >&6; }
+ac_res=$ac_cv_search_getmntent
+if test "$ac_res" != no; then :
+  test "$ac_res" = "none required" || LIBS="$ac_res $LIBS"
+  ac_cv_func_getmntent=yes
+
+$as_echo "#define HAVE_GETMNTENT 1" >>confdefs.h
 
 else
-  as_fn_error $? "libm is needed to compile pacman!" "$LINENO" 5
+  ac_cv_func_getmntent=no
 fi
 
 
-# Check for libarchive
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for archive_read_data in -larchive" >&5
-$as_echo_n "checking for archive_read_data in -larchive... " >&6; }
-if ${ac_cv_lib_archive_archive_read_data+:} false; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether lstat correctly handles trailing slash" >&5
+$as_echo_n "checking whether lstat correctly handles trailing slash... " >&6; }
+if ${ac_cv_func_lstat_dereferences_slashed_symlink+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  ac_check_lib_save_LIBS=$LIBS
-LIBS="-larchive  $LIBS"
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+  rm -f conftest.sym conftest.file
+echo >conftest.file
+if test "$as_ln_s" = "ln -s" && ln -s conftest.file conftest.sym; then
+  if test "$cross_compiling" = yes; then :
+  ac_cv_func_lstat_dereferences_slashed_symlink=no
+else
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
-
-/* Override any GCC internal prototype to avoid an error.
-   Use char because int might match the return type of a GCC
-   builtin and then its argument prototype would still apply.  */
-#ifdef __cplusplus
-extern "C"
-#endif
-char archive_read_data ();
+$ac_includes_default
 int
 main ()
 {
-return archive_read_data ();
+struct stat sbuf;
+     /* Linux will dereference the symlink and fail, as required by POSIX.
+	That is better in the sense that it means we will not
+	have to compile and use the lstat wrapper.  */
+     return lstat ("conftest.sym/", &sbuf) == 0;
   ;
   return 0;
 }
 _ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_archive_archive_read_data=yes
+if ac_fn_c_try_run "$LINENO"; then :
+  ac_cv_func_lstat_dereferences_slashed_symlink=yes
 else
-  ac_cv_lib_archive_archive_read_data=no
+  ac_cv_func_lstat_dereferences_slashed_symlink=no
 fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-LIBS=$ac_check_lib_save_LIBS
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext \
+  conftest.$ac_objext conftest.beam conftest.$ac_ext
+fi
+
+else
+  # If the `ln -s' command failed, then we probably don't even
+  # have an lstat function.
+  ac_cv_func_lstat_dereferences_slashed_symlink=no
+fi
+rm -f conftest.sym conftest.file
+
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_func_lstat_dereferences_slashed_symlink" >&5
+$as_echo "$ac_cv_func_lstat_dereferences_slashed_symlink" >&6; }
+
+test $ac_cv_func_lstat_dereferences_slashed_symlink = yes &&
+
+cat >>confdefs.h <<_ACEOF
+#define LSTAT_FOLLOWS_SLASHED_SYMLINK 1
+_ACEOF
+
+
+if test "x$ac_cv_func_lstat_dereferences_slashed_symlink" = xno; then
+  case " $LIBOBJS " in
+  *" lstat.$ac_objext "* ) ;;
+  *) LIBOBJS="$LIBOBJS lstat.$ac_objext"
+ ;;
+esac
+
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_archive_archive_read_data" >&5
-$as_echo "$ac_cv_lib_archive_archive_read_data" >&6; }
-if test "x$ac_cv_lib_archive_archive_read_data" = xyes; then :
+
+for ac_header in stdlib.h
+do :
+  ac_fn_c_check_header_mongrel "$LINENO" "stdlib.h" "ac_cv_header_stdlib_h" "$ac_includes_default"
+if test "x$ac_cv_header_stdlib_h" = xyes; then :
   cat >>confdefs.h <<_ACEOF
-#define HAVE_LIBARCHIVE 1
+#define HAVE_STDLIB_H 1
 _ACEOF
 
-  LIBS="-larchive $LIBS"
-
-else
-  as_fn_error $? "libarchive is needed to compile pacman!" "$LINENO" 5
 fi
 
+done
 
-# Check for OpenSSL
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether to link with libssl" >&5
-$as_echo_n "checking whether to link with libssl... " >&6; }
-if test "x$with_openssl" != "xno"; then :
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }
-	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for MD5_Final in -lssl" >&5
-$as_echo_n "checking for MD5_Final in -lssl... " >&6; }
-if ${ac_cv_lib_ssl_MD5_Final+:} false; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for GNU libc compatible malloc" >&5
+$as_echo_n "checking for GNU libc compatible malloc... " >&6; }
+if ${ac_cv_func_malloc_0_nonnull+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  ac_check_lib_save_LIBS=$LIBS
-LIBS="-lssl -lcrypto $LIBS"
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+  if test "$cross_compiling" = yes; then :
+  ac_cv_func_malloc_0_nonnull=no
+else
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
-
-/* Override any GCC internal prototype to avoid an error.
-   Use char because int might match the return type of a GCC
-   builtin and then its argument prototype would still apply.  */
-#ifdef __cplusplus
-extern "C"
+#if defined STDC_HEADERS || defined HAVE_STDLIB_H
+# include <stdlib.h>
+#else
+char *malloc ();
 #endif
-char MD5_Final ();
+
 int
 main ()
 {
-return MD5_Final ();
+return ! malloc (0);
   ;
   return 0;
 }
 _ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_ssl_MD5_Final=yes
+if ac_fn_c_try_run "$LINENO"; then :
+  ac_cv_func_malloc_0_nonnull=yes
 else
-  ac_cv_lib_ssl_MD5_Final=no
+  ac_cv_func_malloc_0_nonnull=no
 fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-LIBS=$ac_check_lib_save_LIBS
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext \
+  conftest.$ac_objext conftest.beam conftest.$ac_ext
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_ssl_MD5_Final" >&5
-$as_echo "$ac_cv_lib_ssl_MD5_Final" >&6; }
-if test "x$ac_cv_lib_ssl_MD5_Final" = xyes; then :
-  cat >>confdefs.h <<_ACEOF
-#define HAVE_LIBSSL 1
-_ACEOF
-
-  LIBS="-lssl $LIBS"
 
-else
-  if test "x$with_openssl" != "xcheck"; then
-		{ { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-as_fn_error $? "--with-openssl was given, but -lssl was not found
-See \`config.log' for more details" "$LINENO" 5; }
-	fi
 fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_func_malloc_0_nonnull" >&5
+$as_echo "$ac_cv_func_malloc_0_nonnull" >&6; }
+if test $ac_cv_func_malloc_0_nonnull = yes; then :
+
+$as_echo "#define HAVE_MALLOC 1" >>confdefs.h
 
-	with_openssl=$ac_cv_lib_ssl_MD5_Final
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
- if test "x$with_openssl" = "xyes"; then
-  HAVE_LIBSSL_TRUE=
-  HAVE_LIBSSL_FALSE='#'
 else
-  HAVE_LIBSSL_TRUE='#'
-  HAVE_LIBSSL_FALSE=
+  $as_echo "#define HAVE_MALLOC 0" >>confdefs.h
+
+   case " $LIBOBJS " in
+  *" malloc.$ac_objext "* ) ;;
+  *) LIBOBJS="$LIBOBJS malloc.$ac_objext"
+ ;;
+esac
+
+
+$as_echo "#define malloc rpl_malloc" >>confdefs.h
+
 fi
 
 
-# Check for gpgme
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether to link with libgpgme" >&5
-$as_echo_n "checking whether to link with libgpgme... " >&6; }
-if test "x$with_gpgme" != "xno"; then :
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }
-	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for gpgme_check_version in -lgpgme" >&5
-$as_echo_n "checking for gpgme_check_version in -lgpgme... " >&6; }
-if ${ac_cv_lib_gpgme_gpgme_check_version+:} false; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether time.h and sys/time.h may both be included" >&5
+$as_echo_n "checking whether time.h and sys/time.h may both be included... " >&6; }
+if ${ac_cv_header_time+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  ac_check_lib_save_LIBS=$LIBS
-LIBS="-lgpgme -lgpgme $LIBS"
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
+#include <sys/types.h>
+#include <sys/time.h>
+#include <time.h>
 
-/* Override any GCC internal prototype to avoid an error.
-   Use char because int might match the return type of a GCC
-   builtin and then its argument prototype would still apply.  */
-#ifdef __cplusplus
-extern "C"
-#endif
-char gpgme_check_version ();
 int
 main ()
 {
-return gpgme_check_version ();
+if ((struct tm *) 0)
+return 0;
   ;
   return 0;
 }
 _ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_gpgme_gpgme_check_version=yes
+if ac_fn_c_try_compile "$LINENO"; then :
+  ac_cv_header_time=yes
 else
-  ac_cv_lib_gpgme_gpgme_check_version=no
+  ac_cv_header_time=no
 fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-LIBS=$ac_check_lib_save_LIBS
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_gpgme_gpgme_check_version" >&5
-$as_echo "$ac_cv_lib_gpgme_gpgme_check_version" >&6; }
-if test "x$ac_cv_lib_gpgme_gpgme_check_version" = xyes; then :
-  cat >>confdefs.h <<_ACEOF
-#define HAVE_LIBGPGME 1
-_ACEOF
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_header_time" >&5
+$as_echo "$ac_cv_header_time" >&6; }
+if test $ac_cv_header_time = yes; then
 
-  LIBS="-lgpgme $LIBS"
+$as_echo "#define TIME_WITH_SYS_TIME 1" >>confdefs.h
 
-else
-  if test "x$with_gpgme" != "xcheck"; then
-		{ { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-as_fn_error $? "--with-ggpme was given, but -lgpgme was not found
-See \`config.log' for more details" "$LINENO" 5; }
-	fi
 fi
 
-	with_gpgme=$ac_cv_lib_gpgme_gpgme_check_version
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
- if test "x$with_gpgme" = "xyes"; then
-  HAVE_LIBGPGME_TRUE=
-  HAVE_LIBGPGME_FALSE='#'
-else
-  HAVE_LIBGPGME_TRUE='#'
-  HAVE_LIBGPGME_FALSE=
-fi
 
 
-# Checks for header files.
-for ac_header in fcntl.h float.h glob.h libintl.h limits.h locale.h \
-                  mntent.h netinet/in.h netinet/tcp.h \
-                  stddef.h string.h sys/ioctl.h \
-                  sys/mnttab.h sys/mount.h \
-                  sys/param.h sys/statvfs.h sys/time.h sys/types.h \
-                  sys/ucred.h syslog.h termios.h wchar.h
+
+  for ac_header in $ac_header_list
 do :
   as_ac_Header=`$as_echo "ac_cv_header_$ac_header" | $as_tr_sh`
-ac_fn_c_check_header_mongrel "$LINENO" "$ac_header" "$as_ac_Header" "$ac_includes_default"
+ac_fn_c_check_header_compile "$LINENO" "$ac_header" "$as_ac_Header" "$ac_includes_default
+"
 if eval test \"x\$"$as_ac_Header"\" = x"yes"; then :
   cat >>confdefs.h <<_ACEOF
 #define `$as_echo "HAVE_$ac_header" | $as_tr_cpp` 1
@@ -18415,1179 +15807,964 @@
 done
 
 
-# Checks for typedefs, structures, and compiler characteristics.
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for inline" >&5
-$as_echo_n "checking for inline... " >&6; }
-if ${ac_cv_c_inline+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  ac_cv_c_inline=no
-for ac_kw in inline __inline__ __inline; do
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#ifndef __cplusplus
-typedef int foo_t;
-static $ac_kw foo_t static_foo () {return 0; }
-$ac_kw foo_t foo () {return 0; }
-#endif
-
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  ac_cv_c_inline=$ac_kw
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-  test "$ac_cv_c_inline" != no && break
-done
-
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_c_inline" >&5
-$as_echo "$ac_cv_c_inline" >&6; }
 
-case $ac_cv_c_inline in
-  inline | yes) ;;
-  *)
-    case $ac_cv_c_inline in
-      no) ac_val=;;
-      *) ac_val=$ac_cv_c_inline;;
-    esac
-    cat >>confdefs.h <<_ACEOF
-#ifndef __cplusplus
-#define inline $ac_val
-#endif
-_ACEOF
-    ;;
-esac
 
-ac_fn_c_find_intX_t "$LINENO" "64" "ac_cv_c_int64_t"
-case $ac_cv_c_int64_t in #(
-  no|yes) ;; #(
-  *)
 
-cat >>confdefs.h <<_ACEOF
-#define int64_t $ac_cv_c_int64_t
-_ACEOF
-;;
-esac
 
-ac_fn_c_check_type "$LINENO" "mode_t" "ac_cv_type_mode_t" "$ac_includes_default"
-if test "x$ac_cv_type_mode_t" = xyes; then :
 
-else
 
-cat >>confdefs.h <<_ACEOF
-#define mode_t int
+  for ac_func in $ac_func_list
+do :
+  as_ac_var=`$as_echo "ac_cv_func_$ac_func" | $as_tr_sh`
+ac_fn_c_check_func "$LINENO" "$ac_func" "$as_ac_var"
+if eval test \"x\$"$as_ac_var"\" = x"yes"; then :
+  cat >>confdefs.h <<_ACEOF
+#define `$as_echo "HAVE_$ac_func" | $as_tr_cpp` 1
 _ACEOF
 
 fi
+done
 
-ac_fn_c_check_type "$LINENO" "off_t" "ac_cv_type_off_t" "$ac_includes_default"
-if test "x$ac_cv_type_off_t" = xyes; then :
-
-else
 
-cat >>confdefs.h <<_ACEOF
-#define off_t long int
-_ACEOF
 
-fi
 
-ac_fn_c_check_type "$LINENO" "pid_t" "ac_cv_type_pid_t" "$ac_includes_default"
-if test "x$ac_cv_type_pid_t" = xyes; then :
 
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for working mktime" >&5
+$as_echo_n "checking for working mktime... " >&6; }
+if ${ac_cv_func_working_mktime+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  if test "$cross_compiling" = yes; then :
+  ac_cv_func_working_mktime=no
 else
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+/* Test program from Paul Eggert and Tony Leneis.  */
+#ifdef TIME_WITH_SYS_TIME
+# include <sys/time.h>
+# include <time.h>
+#else
+# ifdef HAVE_SYS_TIME_H
+#  include <sys/time.h>
+# else
+#  include <time.h>
+# endif
+#endif
 
-cat >>confdefs.h <<_ACEOF
-#define pid_t int
-_ACEOF
+#include <limits.h>
+#include <stdlib.h>
 
-fi
+#ifdef HAVE_UNISTD_H
+# include <unistd.h>
+#endif
 
-ac_fn_c_check_type "$LINENO" "size_t" "ac_cv_type_size_t" "$ac_includes_default"
-if test "x$ac_cv_type_size_t" = xyes; then :
+#ifndef HAVE_ALARM
+# define alarm(X) /* empty */
+#endif
 
-else
+/* Work around redefinition to rpl_putenv by other config tests.  */
+#undef putenv
 
-cat >>confdefs.h <<_ACEOF
-#define size_t unsigned int
-_ACEOF
+static time_t time_t_max;
+static time_t time_t_min;
+
+/* Values we'll use to set the TZ environment variable.  */
+static const char *tz_strings[] = {
+  (const char *) 0, "TZ=GMT0", "TZ=JST-9",
+  "TZ=EST+3EDT+2,M10.1.0/00:00:00,M2.3.0/00:00:00"
+};
+#define N_STRINGS (sizeof (tz_strings) / sizeof (tz_strings[0]))
 
-fi
+/* Return 0 if mktime fails to convert a date in the spring-forward gap.
+   Based on a problem report from Andreas Jaeger.  */
+static int
+spring_forward_gap ()
+{
+  /* glibc (up to about 1998-10-07) failed this test. */
+  struct tm tm;
 
-ac_fn_c_check_type "$LINENO" "ssize_t" "ac_cv_type_ssize_t" "$ac_includes_default"
-if test "x$ac_cv_type_ssize_t" = xyes; then :
+  /* Use the portable POSIX.1 specification "TZ=PST8PDT,M4.1.0,M10.5.0"
+     instead of "TZ=America/Vancouver" in order to detect the bug even
+     on systems that don't support the Olson extension, or don't have the
+     full zoneinfo tables installed.  */
+  putenv ((char*) "TZ=PST8PDT,M4.1.0,M10.5.0");
 
-else
+  tm.tm_year = 98;
+  tm.tm_mon = 3;
+  tm.tm_mday = 5;
+  tm.tm_hour = 2;
+  tm.tm_min = 0;
+  tm.tm_sec = 0;
+  tm.tm_isdst = -1;
+  return mktime (&tm) != (time_t) -1;
+}
 
-cat >>confdefs.h <<_ACEOF
-#define ssize_t int
-_ACEOF
+static int
+mktime_test1 (time_t now)
+{
+  struct tm *lt;
+  return ! (lt = localtime (&now)) || mktime (lt) == now;
+}
 
-fi
+static int
+mktime_test (time_t now)
+{
+  return (mktime_test1 (now)
+	  && mktime_test1 ((time_t) (time_t_max - now))
+	  && mktime_test1 ((time_t) (time_t_min + now)));
+}
 
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether struct tm is in sys/time.h or time.h" >&5
-$as_echo_n "checking whether struct tm is in sys/time.h or time.h... " >&6; }
-if ${ac_cv_struct_tm+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <sys/types.h>
-#include <time.h>
+static int
+irix_6_4_bug ()
+{
+  /* Based on code from Ariel Faigon.  */
+  struct tm tm;
+  tm.tm_year = 96;
+  tm.tm_mon = 3;
+  tm.tm_mday = 0;
+  tm.tm_hour = 0;
+  tm.tm_min = 0;
+  tm.tm_sec = 0;
+  tm.tm_isdst = -1;
+  mktime (&tm);
+  return tm.tm_mon == 2 && tm.tm_mday == 31;
+}
 
-int
-main ()
+static int
+bigtime_test (int j)
 {
-struct tm tm;
-				     int *p = &tm.tm_sec;
-				     return !p;
-  ;
-  return 0;
+  struct tm tm;
+  time_t now;
+  tm.tm_year = tm.tm_mon = tm.tm_mday = tm.tm_hour = tm.tm_min = tm.tm_sec = j;
+  now = mktime (&tm);
+  if (now != (time_t) -1)
+    {
+      struct tm *lt = localtime (&now);
+      if (! (lt
+	     && lt->tm_year == tm.tm_year
+	     && lt->tm_mon == tm.tm_mon
+	     && lt->tm_mday == tm.tm_mday
+	     && lt->tm_hour == tm.tm_hour
+	     && lt->tm_min == tm.tm_min
+	     && lt->tm_sec == tm.tm_sec
+	     && lt->tm_yday == tm.tm_yday
+	     && lt->tm_wday == tm.tm_wday
+	     && ((lt->tm_isdst < 0 ? -1 : 0 < lt->tm_isdst)
+		  == (tm.tm_isdst < 0 ? -1 : 0 < tm.tm_isdst))))
+	return 0;
+    }
+  return 1;
 }
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  ac_cv_struct_tm=time.h
-else
-  ac_cv_struct_tm=sys/time.h
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_struct_tm" >&5
-$as_echo "$ac_cv_struct_tm" >&6; }
-if test $ac_cv_struct_tm = sys/time.h; then
 
-$as_echo "#define TM_IN_SYS_TIME 1" >>confdefs.h
+static int
+year_2050_test ()
+{
+  /* The correct answer for 2050-02-01 00:00:00 in Pacific time,
+     ignoring leap seconds.  */
+  unsigned long int answer = 2527315200UL;
 
-fi
+  struct tm tm;
+  time_t t;
+  tm.tm_year = 2050 - 1900;
+  tm.tm_mon = 2 - 1;
+  tm.tm_mday = 1;
+  tm.tm_hour = tm.tm_min = tm.tm_sec = 0;
+  tm.tm_isdst = -1;
 
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for uid_t in sys/types.h" >&5
-$as_echo_n "checking for uid_t in sys/types.h... " >&6; }
-if ${ac_cv_type_uid_t+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <sys/types.h>
+  /* Use the portable POSIX.1 specification "TZ=PST8PDT,M4.1.0,M10.5.0"
+     instead of "TZ=America/Vancouver" in order to detect the bug even
+     on systems that don't support the Olson extension, or don't have the
+     full zoneinfo tables installed.  */
+  putenv ((char*) "TZ=PST8PDT,M4.1.0,M10.5.0");
 
-_ACEOF
-if (eval "$ac_cpp conftest.$ac_ext") 2>&5 |
-  $EGREP "uid_t" >/dev/null 2>&1; then :
-  ac_cv_type_uid_t=yes
-else
-  ac_cv_type_uid_t=no
-fi
-rm -f conftest*
+  t = mktime (&tm);
 
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_type_uid_t" >&5
-$as_echo "$ac_cv_type_uid_t" >&6; }
-if test $ac_cv_type_uid_t = no; then
+  /* Check that the result is either a failure, or close enough
+     to the correct answer that we can assume the discrepancy is
+     due to leap seconds.  */
+  return (t == (time_t) -1
+	  || (0 < t && answer - 120 <= t && t <= answer + 120));
+}
 
-$as_echo "#define uid_t int" >>confdefs.h
+int
+main ()
+{
+  time_t t, delta;
+  int i, j;
 
+  /* This test makes some buggy mktime implementations loop.
+     Give up after 60 seconds; a mktime slower than that
+     isn't worth using anyway.  */
+  alarm (60);
 
-$as_echo "#define gid_t int" >>confdefs.h
+  for (;;)
+    {
+      t = (time_t_max << 1) + 1;
+      if (t <= time_t_max)
+	break;
+      time_t_max = t;
+    }
+  time_t_min = - ((time_t) ~ (time_t) 0 == (time_t) -1) - time_t_max;
 
-fi
+  delta = time_t_max / 997; /* a suitable prime number */
+  for (i = 0; i < N_STRINGS; i++)
+    {
+      if (tz_strings[i])
+	putenv ((char*) tz_strings[i]);
 
-ac_header_dirent=no
-for ac_hdr in dirent.h sys/ndir.h sys/dir.h ndir.h; do
-  as_ac_Header=`$as_echo "ac_cv_header_dirent_$ac_hdr" | $as_tr_sh`
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_hdr that defines DIR" >&5
-$as_echo_n "checking for $ac_hdr that defines DIR... " >&6; }
-if eval \${$as_ac_Header+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <sys/types.h>
-#include <$ac_hdr>
+      for (t = 0; t <= time_t_max - delta; t += delta)
+	if (! mktime_test (t))
+	  return 1;
+      if (! (mktime_test ((time_t) 1)
+	     && mktime_test ((time_t) (60 * 60))
+	     && mktime_test ((time_t) (60 * 60 * 24))))
+	return 1;
 
-int
-main ()
-{
-if ((DIR *) 0)
-return 0;
-  ;
-  return 0;
+      for (j = 1; ; j <<= 1)
+	if (! bigtime_test (j))
+	  return 1;
+	else if (INT_MAX / 2 < j)
+	  break;
+      if (! bigtime_test (INT_MAX))
+	return 1;
+    }
+  return ! (irix_6_4_bug () && spring_forward_gap () && year_2050_test ());
 }
 _ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  eval "$as_ac_Header=yes"
+if ac_fn_c_try_run "$LINENO"; then :
+  ac_cv_func_working_mktime=yes
 else
-  eval "$as_ac_Header=no"
+  ac_cv_func_working_mktime=no
 fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext \
+  conftest.$ac_objext conftest.beam conftest.$ac_ext
 fi
-eval ac_res=\$$as_ac_Header
-	       { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_res" >&5
-$as_echo "$ac_res" >&6; }
-if eval test \"x\$"$as_ac_Header"\" = x"yes"; then :
-  cat >>confdefs.h <<_ACEOF
-#define `$as_echo "HAVE_$ac_hdr" | $as_tr_cpp` 1
-_ACEOF
 
-ac_header_dirent=$ac_hdr; break
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_func_working_mktime" >&5
+$as_echo "$ac_cv_func_working_mktime" >&6; }
+if test $ac_cv_func_working_mktime = no; then
+  case " $LIBOBJS " in
+  *" mktime.$ac_objext "* ) ;;
+  *) LIBOBJS="$LIBOBJS mktime.$ac_objext"
+ ;;
+esac
+
 fi
 
-done
-# Two versions of opendir et al. are in -ldir and -lx on SCO Xenix.
-if test $ac_header_dirent = dirent.h; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for library containing opendir" >&5
-$as_echo_n "checking for library containing opendir... " >&6; }
-if ${ac_cv_search_opendir+:} false; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for working strcoll" >&5
+$as_echo_n "checking for working strcoll... " >&6; }
+if ${ac_cv_func_strcoll_works+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  ac_func_search_save_LIBS=$LIBS
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+  if test "$cross_compiling" = yes; then :
+  ac_cv_func_strcoll_works=no
+else
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
-
-/* Override any GCC internal prototype to avoid an error.
-   Use char because int might match the return type of a GCC
-   builtin and then its argument prototype would still apply.  */
-#ifdef __cplusplus
-extern "C"
-#endif
-char opendir ();
+$ac_includes_default
 int
 main ()
 {
-return opendir ();
+return (strcoll ("abc", "def") >= 0 ||
+	 strcoll ("ABC", "DEF") >= 0 ||
+	 strcoll ("123", "456") >= 0)
   ;
   return 0;
 }
 _ACEOF
-for ac_lib in '' dir; do
-  if test -z "$ac_lib"; then
-    ac_res="none required"
-  else
-    ac_res=-l$ac_lib
-    LIBS="-l$ac_lib  $ac_func_search_save_LIBS"
-  fi
-  if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_search_opendir=$ac_res
+if ac_fn_c_try_run "$LINENO"; then :
+  ac_cv_func_strcoll_works=yes
+else
+  ac_cv_func_strcoll_works=no
 fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext
-  if ${ac_cv_search_opendir+:} false; then :
-  break
+rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext \
+  conftest.$ac_objext conftest.beam conftest.$ac_ext
 fi
-done
-if ${ac_cv_search_opendir+:} false; then :
 
-else
-  ac_cv_search_opendir=no
 fi
-rm conftest.$ac_ext
-LIBS=$ac_func_search_save_LIBS
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_func_strcoll_works" >&5
+$as_echo "$ac_cv_func_strcoll_works" >&6; }
+if test $ac_cv_func_strcoll_works = yes; then
+
+$as_echo "#define HAVE_STRCOLL 1" >>confdefs.h
+
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_search_opendir" >&5
-$as_echo "$ac_cv_search_opendir" >&6; }
-ac_res=$ac_cv_search_opendir
-if test "$ac_res" != no; then :
-  test "$ac_res" = "none required" || LIBS="$ac_res $LIBS"
+
+for ac_func in dup2 getcwd geteuid getmntinfo gettimeofday memmove memset \
+                mkdir realpath regcomp rmdir setenv setlocale strcasecmp \
+                strchr strcspn strdup strerror strndup strrchr strsep strstr \
+                strtol swprintf tcflush wcwidth uname
+do :
+  as_ac_var=`$as_echo "ac_cv_func_$ac_func" | $as_tr_sh`
+ac_fn_c_check_func "$LINENO" "$ac_func" "$as_ac_var"
+if eval test \"x\$"$as_ac_var"\" = x"yes"; then :
+  cat >>confdefs.h <<_ACEOF
+#define `$as_echo "HAVE_$ac_func" | $as_tr_cpp` 1
+_ACEOF
 
 fi
+done
 
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for library containing opendir" >&5
-$as_echo_n "checking for library containing opendir... " >&6; }
-if ${ac_cv_search_opendir+:} false; then :
+ac_fn_c_check_member "$LINENO" "struct stat" "st_blksize" "ac_cv_member_struct_stat_st_blksize" "#include <sys/stat.h>
+"
+if test "x$ac_cv_member_struct_stat_st_blksize" = xyes; then :
+
+cat >>confdefs.h <<_ACEOF
+#define HAVE_STRUCT_STAT_ST_BLKSIZE 1
+_ACEOF
+
+
+fi
+
+
+# For the diskspace code
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking filesystem statistics type" >&5
+$as_echo_n "checking filesystem statistics type... " >&6; }
+if ${fs_stats_cv_type+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  ac_func_search_save_LIBS=$LIBS
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+  ac_fn_c_check_func "$LINENO" "getmntinfo" "ac_cv_func_getmntinfo"
+if test "x$ac_cv_func_getmntinfo" = xyes; then :
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
-/* Override any GCC internal prototype to avoid an error.
-   Use char because int might match the return type of a GCC
-   builtin and then its argument prototype would still apply.  */
-#ifdef __cplusplus
-extern "C"
+# include <sys/param.h>
+# include <sys/mount.h>
+#if HAVE_SYS_UCRED_H
+#include <sys/ucred.h>
 #endif
-char opendir ();
+extern int getmntinfo (struct statfs **, int);
+
 int
 main ()
 {
-return opendir ();
+
   ;
   return 0;
 }
 _ACEOF
-for ac_lib in '' x; do
-  if test -z "$ac_lib"; then
-    ac_res="none required"
-  else
-    ac_res=-l$ac_lib
-    LIBS="-l$ac_lib  $ac_func_search_save_LIBS"
-  fi
-  if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_search_opendir=$ac_res
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext
-  if ${ac_cv_search_opendir+:} false; then :
-  break
-fi
-done
-if ${ac_cv_search_opendir+:} false; then :
-
+if ac_fn_c_try_compile "$LINENO"; then :
+  fs_stats_cv_type="struct statfs"
 else
-  ac_cv_search_opendir=no
+  fs_stats_cv_type="struct statvfs"
 fi
-rm conftest.$ac_ext
-LIBS=$ac_func_search_save_LIBS
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+else
+  ac_fn_c_check_func "$LINENO" "getmntent" "ac_cv_func_getmntent"
+if test "x$ac_cv_func_getmntent" = xyes; then :
+  fs_stats_cv_type="struct statvfs"
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_search_opendir" >&5
-$as_echo "$ac_cv_search_opendir" >&6; }
-ac_res=$ac_cv_search_opendir
-if test "$ac_res" != no; then :
-  test "$ac_res" = "none required" || LIBS="$ac_res $LIBS"
+
 
 fi
 
+
 fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $fs_stats_cv_type" >&5
+$as_echo "$fs_stats_cv_type" >&6; }
 
+cat >>confdefs.h <<_ACEOF
+#define FSSTATSTYPE $fs_stats_cv_type
+_ACEOF
 
+  if test $ac_cv_func_getmntinfo = yes; then
+    if test "$fs_stats_cv_type" = "struct statvfs"; then
 
-  ac_fn_c_check_member "$LINENO" "struct dirent" "d_type" "ac_cv_member_struct_dirent_d_type" "
-#include <sys/types.h>
-#ifdef HAVE_DIRENT_H
-# include <dirent.h>
-#else
-# define dirent direct
-# ifdef HAVE_SYS_NDIR_H
-#  include <sys/ndir.h>
-# endif
-# ifdef HAVE_SYS_DIR_H
-#  include <sys/dir.h>
-# endif
-# ifdef HAVE_NDIR_H
-#  include <ndir.h>
-# endif
-#endif
+$as_echo "#define HAVE_GETMNTINFO_STATVFS 1" >>confdefs.h
+
+    else
+
+$as_echo "#define HAVE_GETMNTINFO_STATFS 1" >>confdefs.h
+
+    fi
+  fi
 
+ac_fn_c_check_member "$LINENO" "struct statvfs" "f_flag" "ac_cv_member_struct_statvfs_f_flag" "#include <sys/statvfs.h>
 "
-if test "x$ac_cv_member_struct_dirent_d_type" = xyes; then :
+if test "x$ac_cv_member_struct_statvfs_f_flag" = xyes; then :
 
 cat >>confdefs.h <<_ACEOF
-#define HAVE_STRUCT_DIRENT_D_TYPE 1
+#define HAVE_STRUCT_STATVFS_F_FLAG 1
 _ACEOF
 
 
 fi
 
+ac_fn_c_check_member "$LINENO" "struct statfs" "f_flags" "ac_cv_member_struct_statfs_f_flags" "#include <sys/param.h>
+                  #include <sys/mount.h>
+"
+if test "x$ac_cv_member_struct_statfs_f_flags" = xyes; then :
 
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking PATH_MAX defined" >&5
-$as_echo_n "checking PATH_MAX defined... " >&6; }
-if ${path_max_cv_defined+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-[
-#include <limits.h>
-#if defined(PATH_MAX)
-yes
-#endif
-]
+cat >>confdefs.h <<_ACEOF
+#define HAVE_STRUCT_STATFS_F_FLAGS 1
 _ACEOF
-if (eval "$ac_cpp conftest.$ac_ext") 2>&5 |
-  $EGREP "yes" >/dev/null 2>&1; then :
-  path_max_cv_defined=yes
-else
-  path_max_cv_defined=no
-fi
-rm -f conftest*
 
 
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $path_max_cv_defined" >&5
-$as_echo "$path_max_cv_defined" >&6; }
-  if test $path_max_cv_defined = no; then
 
-$as_echo "#define PATH_MAX 4096" >>confdefs.h
 
-  fi
+# Check if we can use symbol visibility support in GCC
 
 
-# Checks for library functions.
-for ac_header in vfork.h
-do :
-  ac_fn_c_check_header_mongrel "$LINENO" "vfork.h" "ac_cv_header_vfork_h" "$ac_includes_default"
-if test "x$ac_cv_header_vfork_h" = xyes; then :
-  cat >>confdefs.h <<_ACEOF
-#define HAVE_VFORK_H 1
-_ACEOF
+  if test "X$CC" != "X"; then
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether ${CC} accepts -fvisibility=internal" >&5
+$as_echo_n "checking whether ${CC} accepts -fvisibility=internal... " >&6; }
+if ${visibility_cv_cc+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  visibility_old_cflags="$CFLAGS"
+       CFLAGS="$CFLAGS -fvisibility=internal"
+       cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+
+int
+main ()
+{
 
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_compile "$LINENO"; then :
+  visibility_cv_cc=yes
+else
+  visibility_cv_cc=no
 fi
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+       CFLAGS="$visibility_old_cflags"
 
-done
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $visibility_cv_cc" >&5
+$as_echo "$visibility_cv_cc" >&6; }
+    if test $visibility_cv_cc = yes; then
 
-for ac_func in fork vfork
-do :
-  as_ac_var=`$as_echo "ac_cv_func_$ac_func" | $as_tr_sh`
-ac_fn_c_check_func "$LINENO" "$ac_func" "$as_ac_var"
-if eval test \"x\$"$as_ac_var"\" = x"yes"; then :
-  cat >>confdefs.h <<_ACEOF
-#define `$as_echo "HAVE_$ac_func" | $as_tr_cpp` 1
-_ACEOF
+$as_echo "#define ENABLE_VISIBILITY_CC 1" >>confdefs.h
 
+    fi
+     if test "x$visibility_cv_cc" = "xyes"; then
+  ENABLE_VISIBILITY_CC_TRUE=
+  ENABLE_VISIBILITY_CC_FALSE='#'
+else
+  ENABLE_VISIBILITY_CC_TRUE='#'
+  ENABLE_VISIBILITY_CC_FALSE=
 fi
-done
 
-if test "x$ac_cv_func_fork" = xyes; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for working fork" >&5
-$as_echo_n "checking for working fork... " >&6; }
-if ${ac_cv_func_fork_works+:} false; then :
+  fi
+
+# Check if we have -fgnu89-inline flag
+
+
+  if test "X$CC" != "X"; then
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking for -fgnu89-inline" >&5
+$as_echo_n "checking for -fgnu89-inline... " >&6; }
+if ${gnu89_inline_cv_cc+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  if test "$cross_compiling" = yes; then :
-  ac_cv_func_fork_works=cross
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+   gnu89_inline_old_cflags="$CFLAGS"
+      CFLAGS="$CFLAGS -fgnu89-inline"
+      cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
-$ac_includes_default
+
 int
 main ()
 {
 
-	  /* By Ruediger Kuhlmann. */
-	  return fork () < 0;
-
   ;
   return 0;
 }
 _ACEOF
-if ac_fn_c_try_run "$LINENO"; then :
-  ac_cv_func_fork_works=yes
+if ac_fn_c_try_compile "$LINENO"; then :
+  gnu89_inline_cv_cc=yes
 else
-  ac_cv_func_fork_works=no
-fi
-rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext \
-  conftest.$ac_objext conftest.beam conftest.$ac_ext
+  gnu89_inline_cv_cc=no
 fi
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+      CFLAGS="$gnu89_inline_old_cflags"
 
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_func_fork_works" >&5
-$as_echo "$ac_cv_func_fork_works" >&6; }
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $gnu89_inline_cv_cc" >&5
+$as_echo "$gnu89_inline_cv_cc" >&6; }
+    if test $gnu89_inline_cv_cc = yes; then
 
+$as_echo "#define ENABLE_GNU89_INLINE_CC 1" >>confdefs.h
+
+    fi
+     if test "x$gnu89_inline_cv_cc" = "xyes"; then
+  ENABLE_GNU89_INLINE_CC_TRUE=
+  ENABLE_GNU89_INLINE_CC_FALSE='#'
 else
-  ac_cv_func_fork_works=$ac_cv_func_fork
-fi
-if test "x$ac_cv_func_fork_works" = xcross; then
-  case $host in
-    *-*-amigaos* | *-*-msdosdjgpp*)
-      # Override, as these systems have only a dummy fork() stub
-      ac_cv_func_fork_works=no
-      ;;
-    *)
-      ac_cv_func_fork_works=yes
-      ;;
-  esac
-  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: result $ac_cv_func_fork_works guessed because of cross compilation" >&5
-$as_echo "$as_me: WARNING: result $ac_cv_func_fork_works guessed because of cross compilation" >&2;}
+  ENABLE_GNU89_INLINE_CC_TRUE='#'
+  ENABLE_GNU89_INLINE_CC_FALSE=
 fi
-ac_cv_func_vfork_works=$ac_cv_func_vfork
-if test "x$ac_cv_func_vfork" = xyes; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for working vfork" >&5
-$as_echo_n "checking for working vfork... " >&6; }
-if ${ac_cv_func_vfork_works+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test "$cross_compiling" = yes; then :
-  ac_cv_func_vfork_works=cross
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-/* Thanks to Paul Eggert for this test.  */
-$ac_includes_default
-#include <sys/wait.h>
-#ifdef HAVE_VFORK_H
-# include <vfork.h>
-#endif
-/* On some sparc systems, changes by the child to local and incoming
-   argument registers are propagated back to the parent.  The compiler
-   is told about this with #include <vfork.h>, but some compilers
-   (e.g. gcc -O) don't grok <vfork.h>.  Test for this by using a
-   static variable whose address is put into a register that is
-   clobbered by the vfork.  */
-static void
-#ifdef __cplusplus
-sparc_address_test (int arg)
-# else
-sparc_address_test (arg) int arg;
-#endif
-{
-  static pid_t child;
-  if (!child) {
-    child = vfork ();
-    if (child < 0) {
-      perror ("vfork");
-      _exit(2);
-    }
-    if (!child) {
-      arg = getpid();
-      write(-1, "", 0);
-      _exit (arg);
-    }
-  }
-}
-
-int
-main ()
-{
-  pid_t parent = getpid ();
-  pid_t child;
 
-  sparc_address_test (0);
+  fi
 
-  child = vfork ();
 
-  if (child == 0) {
-    /* Here is another test for sparc vfork register problems.  This
-       test uses lots of local variables, at least as many local
-       variables as main has allocated so far including compiler
-       temporaries.  4 locals are enough for gcc 1.40.3 on a Solaris
-       4.1.3 sparc, but we use 8 to be safe.  A buggy compiler should
-       reuse the register of parent for one of the local variables,
-       since it will think that parent can't possibly be used any more
-       in this routine.  Assigning to the local variable will thus
-       munge parent in the parent process.  */
-    pid_t
-      p = getpid(), p1 = getpid(), p2 = getpid(), p3 = getpid(),
-      p4 = getpid(), p5 = getpid(), p6 = getpid(), p7 = getpid();
-    /* Convince the compiler that p..p7 are live; otherwise, it might
-       use the same hardware register for all 8 local variables.  */
-    if (p != p1 || p != p2 || p != p3 || p != p4
-	|| p != p5 || p != p6 || p != p7)
-      _exit(1);
+# Host-dependant definitions
+INODECMD="stat -c '%i %n'"
+SIZECMD="stat -c %s"
+SEDINPLACE="sed -i"
+STRIP_BINARIES="--strip-all"
+STRIP_SHARED="--strip-unneeded"
+STRIP_STATIC="--strip-debug"
+case "${host_os}" in
+	*bsd*)
+		INODECMD="stat -f '%i %n'"
+		SIZECMD="stat -f %z"
+		SEDINPLACE="sed -i \"\""
+		;;
+	cygwin*)
+		host_os_cygwin=yes
 
-    /* On some systems (e.g. IRIX 3.3), vfork doesn't separate parent
-       from child file descriptors.  If the child closes a descriptor
-       before it execs or exits, this munges the parent's descriptor
-       as well.  Test for this by closing stdout in the child.  */
-    _exit(close(fileno(stdout)) != 0);
-  } else {
-    int status;
-    struct stat st;
+$as_echo "#define CYGWIN 1" >>confdefs.h
 
-    while (wait(&status) != child)
-      ;
-    return (
-	 /* Was there some problem with vforking?  */
-	 child < 0
+		;;
+	darwin*)
+		host_os_darwin=yes
+		INODECMD="/usr/bin/stat -f '%i %n'"
+		SIZECMD="/usr/bin/stat -f %z"
+		SEDINPLACE="/usr/bin/sed -i ''"
+		STRIP_BINARIES=""
+		STRIP_SHARED="-S"
+		STRIP_STATIC="-S"
+		;;
+esac
 
-	 /* Did the child fail?  (This shouldn't happen.)  */
-	 || status
+ if test "x$host_os_cygwin" = "xyes"; then
+  CYGWIN_TRUE=
+  CYGWIN_FALSE='#'
+else
+  CYGWIN_TRUE='#'
+  CYGWIN_FALSE=
+fi
 
-	 /* Did the vfork/compiler bug occur?  */
-	 || parent != getpid()
+ if test "x$host_os_darwin" = "xyes"; then
+  DARWIN_TRUE=
+  DARWIN_FALSE='#'
+else
+  DARWIN_TRUE='#'
+  DARWIN_FALSE=
+fi
 
-	 /* Did the file descriptor bug occur?  */
-	 || fstat(fileno(stdout), &st) != 0
-	 );
-  }
-}
-_ACEOF
-if ac_fn_c_try_run "$LINENO"; then :
-  ac_cv_func_vfork_works=yes
+for ac_prog in du
+do
+  # Extract the first word of "$ac_prog", so it can be a program name with args.
+set dummy $ac_prog; ac_word=$2
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
+if ${ac_cv_path_DUPATH+:} false; then :
+  $as_echo_n "(cached) " >&6
 else
-  ac_cv_func_vfork_works=no
+  case $DUPATH in
+  [\\/]* | ?:[\\/]*)
+  ac_cv_path_DUPATH="$DUPATH" # Let the user override the test with a path.
+  ;;
+  *)
+  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+for as_dir in /usr/bin$PATH_SEPARATOR/bin
+do
+  IFS=$as_save_IFS
+  test -z "$as_dir" && as_dir=.
+    for ac_exec_ext in '' $ac_executable_extensions; do
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+    ac_cv_path_DUPATH="$as_dir/$ac_word$ac_exec_ext"
+    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+    break 2
+  fi
+done
+  done
+IFS=$as_save_IFS
+
+  ;;
+esac
 fi
-rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext \
-  conftest.$ac_objext conftest.beam conftest.$ac_ext
+DUPATH=$ac_cv_path_DUPATH
+if test -n "$DUPATH"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $DUPATH" >&5
+$as_echo "$DUPATH" >&6; }
+else
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
 fi
 
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_func_vfork_works" >&5
-$as_echo "$ac_cv_func_vfork_works" >&6; }
 
-fi;
-if test "x$ac_cv_func_fork_works" = xcross; then
-  ac_cv_func_vfork_works=$ac_cv_func_vfork
-  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: result $ac_cv_func_vfork_works guessed because of cross compilation" >&5
-$as_echo "$as_me: WARNING: result $ac_cv_func_vfork_works guessed because of cross compilation" >&2;}
-fi
+  test -n "$DUPATH" && break
+done
+test -n "$DUPATH" || DUPATH="du"
+
+
+
 
-if test "x$ac_cv_func_vfork_works" = xyes; then
 
-$as_echo "#define HAVE_WORKING_VFORK 1" >>confdefs.h
 
-else
 
-$as_echo "#define vfork fork" >>confdefs.h
 
-fi
-if test "x$ac_cv_func_fork_works" = xyes; then
+# Variables plugged into makepkg.conf
+CARCH="${host%%-*}"
+CHOST="${host}"
 
-$as_echo "#define HAVE_WORKING_FORK 1" >>confdefs.h
 
-fi
 
-# getmntent is in the standard C library on UNICOS, in -lsun on Irix 4,
-# -lseq on Dynix/PTX, -lgen on Unixware.
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for library containing getmntent" >&5
-$as_echo_n "checking for library containing getmntent... " >&6; }
-if ${ac_cv_search_getmntent+:} false; then :
+# Check for documentation support and status
+for ac_prog in asciidoc
+do
+  # Extract the first word of "$ac_prog", so it can be a program name with args.
+set dummy $ac_prog; ac_word=$2
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
+if ${ac_cv_prog_ASCIIDOC+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  ac_func_search_save_LIBS=$LIBS
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-/* Override any GCC internal prototype to avoid an error.
-   Use char because int might match the return type of a GCC
-   builtin and then its argument prototype would still apply.  */
-#ifdef __cplusplus
-extern "C"
-#endif
-char getmntent ();
-int
-main ()
-{
-return getmntent ();
-  ;
-  return 0;
-}
-_ACEOF
-for ac_lib in '' sun seq gen; do
-  if test -z "$ac_lib"; then
-    ac_res="none required"
-  else
-    ac_res=-l$ac_lib
-    LIBS="-l$ac_lib  $ac_func_search_save_LIBS"
+  if test -n "$ASCIIDOC"; then
+  ac_cv_prog_ASCIIDOC="$ASCIIDOC" # Let the user override the test.
+else
+as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+for as_dir in $PATH
+do
+  IFS=$as_save_IFS
+  test -z "$as_dir" && as_dir=.
+    for ac_exec_ext in '' $ac_executable_extensions; do
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+    ac_cv_prog_ASCIIDOC="$ac_prog"
+    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+    break 2
   fi
-  if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_search_getmntent=$ac_res
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext
-  if ${ac_cv_search_getmntent+:} false; then :
-  break
-fi
 done
-if ${ac_cv_search_getmntent+:} false; then :
+  done
+IFS=$as_save_IFS
 
-else
-  ac_cv_search_getmntent=no
 fi
-rm conftest.$ac_ext
-LIBS=$ac_func_search_save_LIBS
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_search_getmntent" >&5
-$as_echo "$ac_cv_search_getmntent" >&6; }
-ac_res=$ac_cv_search_getmntent
-if test "$ac_res" != no; then :
-  test "$ac_res" = "none required" || LIBS="$ac_res $LIBS"
-  ac_cv_func_getmntent=yes
+ASCIIDOC=$ac_cv_prog_ASCIIDOC
+if test -n "$ASCIIDOC"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ASCIIDOC" >&5
+$as_echo "$ASCIIDOC" >&6; }
+else
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
+fi
 
-$as_echo "#define HAVE_GETMNTENT 1" >>confdefs.h
 
+  test -n "$ASCIIDOC" && break
+done
+
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for building documentation" >&5
+$as_echo_n "checking for building documentation... " >&6; }
+if test "x$wantdoc" = "xyes" ; then
+	if test $ASCIIDOC ; then
+		{ $as_echo "$as_me:${as_lineno-$LINENO}: result: yes, enabled by configure" >&5
+$as_echo "yes, enabled by configure" >&6; }
+	else
+		asciidoc="(warning : asciidoc not installed)"
+		{ $as_echo "$as_me:${as_lineno-$LINENO}: result: yes $asciidoc" >&5
+$as_echo "yes $asciidoc" >&6; }
+	fi
+	wantdoc=yes
 else
-  ac_cv_func_getmntent=no
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no, disabled by configure" >&5
+$as_echo "no, disabled by configure" >&6; }
+	wantdoc=no
+fi
+ if test "x$wantdoc" = "xyes"; then
+  WANT_DOC_TRUE=
+  WANT_DOC_FALSE='#'
+else
+  WANT_DOC_TRUE='#'
+  WANT_DOC_FALSE=
 fi
 
 
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether lstat correctly handles trailing slash" >&5
-$as_echo_n "checking whether lstat correctly handles trailing slash... " >&6; }
-if ${ac_cv_func_lstat_dereferences_slashed_symlink+:} false; then :
+# Check for doxygen support and status
+for ac_prog in doxygen
+do
+  # Extract the first word of "$ac_prog", so it can be a program name with args.
+set dummy $ac_prog; ac_word=$2
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+$as_echo_n "checking for $ac_word... " >&6; }
+if ${ac_cv_prog_DOXYGEN+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  rm -f conftest.sym conftest.file
-echo >conftest.file
-if test "$as_ln_s" = "ln -s" && ln -s conftest.file conftest.sym; then
-  if test "$cross_compiling" = yes; then :
-  ac_cv_func_lstat_dereferences_slashed_symlink=no
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-$ac_includes_default
-int
-main ()
-{
-struct stat sbuf;
-     /* Linux will dereference the symlink and fail, as required by POSIX.
-	That is better in the sense that it means we will not
-	have to compile and use the lstat wrapper.  */
-     return lstat ("conftest.sym/", &sbuf) == 0;
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_run "$LINENO"; then :
-  ac_cv_func_lstat_dereferences_slashed_symlink=yes
+  if test -n "$DOXYGEN"; then
+  ac_cv_prog_DOXYGEN="$DOXYGEN" # Let the user override the test.
 else
-  ac_cv_func_lstat_dereferences_slashed_symlink=no
+as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+for as_dir in $PATH
+do
+  IFS=$as_save_IFS
+  test -z "$as_dir" && as_dir=.
+    for ac_exec_ext in '' $ac_executable_extensions; do
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
+    ac_cv_prog_DOXYGEN="$ac_prog"
+    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+    break 2
+  fi
+done
+  done
+IFS=$as_save_IFS
+
 fi
-rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext \
-  conftest.$ac_objext conftest.beam conftest.$ac_ext
 fi
-
+DOXYGEN=$ac_cv_prog_DOXYGEN
+if test -n "$DOXYGEN"; then
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $DOXYGEN" >&5
+$as_echo "$DOXYGEN" >&6; }
 else
-  # If the `ln -s' command failed, then we probably don't even
-  # have an lstat function.
-  ac_cv_func_lstat_dereferences_slashed_symlink=no
-fi
-rm -f conftest.sym conftest.file
-
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_func_lstat_dereferences_slashed_symlink" >&5
-$as_echo "$ac_cv_func_lstat_dereferences_slashed_symlink" >&6; }
-
-test $ac_cv_func_lstat_dereferences_slashed_symlink = yes &&
-
-cat >>confdefs.h <<_ACEOF
-#define LSTAT_FOLLOWS_SLASHED_SYMLINK 1
-_ACEOF
 
 
-if test "x$ac_cv_func_lstat_dereferences_slashed_symlink" = xno; then
-  case " $LIBOBJS " in
-  *" lstat.$ac_objext "* ) ;;
-  *) LIBOBJS="$LIBOBJS lstat.$ac_objext"
- ;;
-esac
+  test -n "$DOXYGEN" && break
+done
 
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for doxygen" >&5
+$as_echo_n "checking for doxygen... " >&6; }
+if test "x$wantdoxygen" = "xyes" ; then
+	if test $DOXYGEN ; then
+		{ $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+$as_echo "yes" >&6; }
+		usedoxygen=yes
+	else
+		{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no, doxygen missing" >&5
+$as_echo "no, doxygen missing" >&6; }
+		usedoxygen=no
+	fi
+else
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no, disabled by configure" >&5
+$as_echo "no, disabled by configure" >&6; }
+	usedoxygen=no
+fi
+ if test "x$usedoxygen" = "xyes"; then
+  USE_DOXYGEN_TRUE=
+  USE_DOXYGEN_FALSE='#'
+else
+  USE_DOXYGEN_TRUE='#'
+  USE_DOXYGEN_FALSE=
 fi
 
-for ac_header in stdlib.h
-do :
-  ac_fn_c_check_header_mongrel "$LINENO" "stdlib.h" "ac_cv_header_stdlib_h" "$ac_includes_default"
-if test "x$ac_cv_header_stdlib_h" = xyes; then :
-  cat >>confdefs.h <<_ACEOF
-#define HAVE_STDLIB_H 1
-_ACEOF
 
-fi
+# Enable or disable debug code
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for debug mode request" >&5
+$as_echo_n "checking for debug mode request... " >&6; }
+if test "x$debug" = "xyes" ; then
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+$as_echo "yes" >&6; }
 
-done
+$as_echo "#define PACMAN_DEBUG /**/" >>confdefs.h
 
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for GNU libc compatible malloc" >&5
-$as_echo_n "checking for GNU libc compatible malloc... " >&6; }
-if ${ac_cv_func_malloc_0_nonnull+:} false; then :
+	# Check for -fstack-protector availability
+
+  { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether libssp exists" >&5
+$as_echo_n "checking whether libssp exists... " >&6; }
+if ${ssp_cv_lib+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  if test "$cross_compiling" = yes; then :
-  ac_cv_func_malloc_0_nonnull=no
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+  ssp_old_libs="$LIBS"
+     LIBS="$LIBS -lssp"
+     cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
-#if defined STDC_HEADERS || defined HAVE_STDLIB_H
-# include <stdlib.h>
-#else
-char *malloc ();
-#endif
 
 int
 main ()
 {
-return ! malloc (0);
+
   ;
   return 0;
 }
 _ACEOF
-if ac_fn_c_try_run "$LINENO"; then :
-  ac_cv_func_malloc_0_nonnull=yes
+if ac_fn_c_try_link "$LINENO"; then :
+  ssp_cv_lib=yes
 else
-  ac_cv_func_malloc_0_nonnull=no
-fi
-rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext \
-  conftest.$ac_objext conftest.beam conftest.$ac_ext
+  ssp_cv_lib=no
 fi
+rm -f core conftest.err conftest.$ac_objext \
+    conftest$ac_exeext conftest.$ac_ext
+     LIBS="$ssp_old_libs"
 
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_func_malloc_0_nonnull" >&5
-$as_echo "$ac_cv_func_malloc_0_nonnull" >&6; }
-if test $ac_cv_func_malloc_0_nonnull = yes; then :
-
-$as_echo "#define HAVE_MALLOC 1" >>confdefs.h
-
-else
-  $as_echo "#define HAVE_MALLOC 0" >>confdefs.h
-
-   case " $LIBOBJS " in
-  *" malloc.$ac_objext "* ) ;;
-  *) LIBOBJS="$LIBOBJS malloc.$ac_objext"
- ;;
-esac
-
-
-$as_echo "#define malloc rpl_malloc" >>confdefs.h
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ssp_cv_lib" >&5
+$as_echo "$ssp_cv_lib" >&6; }
+  if test $ssp_cv_lib = yes; then
+    LIBS="$LIBS -lssp"
+  fi
 
-fi
 
 
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether time.h and sys/time.h may both be included" >&5
-$as_echo_n "checking whether time.h and sys/time.h may both be included... " >&6; }
-if ${ac_cv_header_time+:} false; then :
+  if test "X$CC" != "X"; then
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether ${CC} accepts -fstack-protector-all" >&5
+$as_echo_n "checking whether ${CC} accepts -fstack-protector-all... " >&6; }
+if ${ssp_cv_cc+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+  ssp_old_cflags="$CFLAGS"
+       CFLAGS="$CFLAGS -fstack-protector-all"
+       cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
-#include <sys/types.h>
-#include <sys/time.h>
-#include <time.h>
 
 int
 main ()
 {
-if ((struct tm *) 0)
-return 0;
+
   ;
   return 0;
 }
 _ACEOF
 if ac_fn_c_try_compile "$LINENO"; then :
-  ac_cv_header_time=yes
+  ssp_cv_cc=yes
 else
-  ac_cv_header_time=no
+  ssp_cv_cc=no
 fi
 rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_header_time" >&5
-$as_echo "$ac_cv_header_time" >&6; }
-if test $ac_cv_header_time = yes; then
-
-$as_echo "#define TIME_WITH_SYS_TIME 1" >>confdefs.h
-
-fi
-
-
-
-
-  for ac_header in $ac_header_list
-do :
-  as_ac_Header=`$as_echo "ac_cv_header_$ac_header" | $as_tr_sh`
-ac_fn_c_check_header_compile "$LINENO" "$ac_header" "$as_ac_Header" "$ac_includes_default
-"
-if eval test \"x\$"$as_ac_Header"\" = x"yes"; then :
-  cat >>confdefs.h <<_ACEOF
-#define `$as_echo "HAVE_$ac_header" | $as_tr_cpp` 1
-_ACEOF
-
-fi
-
-done
-
-
-
-
-
-
-
-
-  for ac_func in $ac_func_list
-do :
-  as_ac_var=`$as_echo "ac_cv_func_$ac_func" | $as_tr_sh`
-ac_fn_c_check_func "$LINENO" "$ac_func" "$as_ac_var"
-if eval test \"x\$"$as_ac_var"\" = x"yes"; then :
-  cat >>confdefs.h <<_ACEOF
-#define `$as_echo "HAVE_$ac_func" | $as_tr_cpp` 1
-_ACEOF
+       CFLAGS="$ssp_old_cflags"
 
 fi
-done
-
-
-
-
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for working mktime" >&5
-$as_echo_n "checking for working mktime... " >&6; }
-if ${ac_cv_func_working_mktime+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test "$cross_compiling" = yes; then :
-  ac_cv_func_working_mktime=no
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-/* Test program from Paul Eggert and Tony Leneis.  */
-#ifdef TIME_WITH_SYS_TIME
-# include <sys/time.h>
-# include <time.h>
-#else
-# ifdef HAVE_SYS_TIME_H
-#  include <sys/time.h>
-# else
-#  include <time.h>
-# endif
-#endif
-
-#include <limits.h>
-#include <stdlib.h>
-
-#ifdef HAVE_UNISTD_H
-# include <unistd.h>
-#endif
-
-#ifndef HAVE_ALARM
-# define alarm(X) /* empty */
-#endif
-
-/* Work around redefinition to rpl_putenv by other config tests.  */
-#undef putenv
-
-static time_t time_t_max;
-static time_t time_t_min;
-
-/* Values we'll use to set the TZ environment variable.  */
-static const char *tz_strings[] = {
-  (const char *) 0, "TZ=GMT0", "TZ=JST-9",
-  "TZ=EST+3EDT+2,M10.1.0/00:00:00,M2.3.0/00:00:00"
-};
-#define N_STRINGS (sizeof (tz_strings) / sizeof (tz_strings[0]))
-
-/* Return 0 if mktime fails to convert a date in the spring-forward gap.
-   Based on a problem report from Andreas Jaeger.  */
-static int
-spring_forward_gap ()
-{
-  /* glibc (up to about 1998-10-07) failed this test. */
-  struct tm tm;
-
-  /* Use the portable POSIX.1 specification "TZ=PST8PDT,M4.1.0,M10.5.0"
-     instead of "TZ=America/Vancouver" in order to detect the bug even
-     on systems that don't support the Olson extension, or don't have the
-     full zoneinfo tables installed.  */
-  putenv ((char*) "TZ=PST8PDT,M4.1.0,M10.5.0");
-
-  tm.tm_year = 98;
-  tm.tm_mon = 3;
-  tm.tm_mday = 5;
-  tm.tm_hour = 2;
-  tm.tm_min = 0;
-  tm.tm_sec = 0;
-  tm.tm_isdst = -1;
-  return mktime (&tm) != (time_t) -1;
-}
-
-static int
-mktime_test1 (time_t now)
-{
-  struct tm *lt;
-  return ! (lt = localtime (&now)) || mktime (lt) == now;
-}
-
-static int
-mktime_test (time_t now)
-{
-  return (mktime_test1 (now)
-	  && mktime_test1 ((time_t) (time_t_max - now))
-	  && mktime_test1 ((time_t) (time_t_min + now)));
-}
-
-static int
-irix_6_4_bug ()
-{
-  /* Based on code from Ariel Faigon.  */
-  struct tm tm;
-  tm.tm_year = 96;
-  tm.tm_mon = 3;
-  tm.tm_mday = 0;
-  tm.tm_hour = 0;
-  tm.tm_min = 0;
-  tm.tm_sec = 0;
-  tm.tm_isdst = -1;
-  mktime (&tm);
-  return tm.tm_mon == 2 && tm.tm_mday == 31;
-}
-
-static int
-bigtime_test (int j)
-{
-  struct tm tm;
-  time_t now;
-  tm.tm_year = tm.tm_mon = tm.tm_mday = tm.tm_hour = tm.tm_min = tm.tm_sec = j;
-  now = mktime (&tm);
-  if (now != (time_t) -1)
-    {
-      struct tm *lt = localtime (&now);
-      if (! (lt
-	     && lt->tm_year == tm.tm_year
-	     && lt->tm_mon == tm.tm_mon
-	     && lt->tm_mday == tm.tm_mday
-	     && lt->tm_hour == tm.tm_hour
-	     && lt->tm_min == tm.tm_min
-	     && lt->tm_sec == tm.tm_sec
-	     && lt->tm_yday == tm.tm_yday
-	     && lt->tm_wday == tm.tm_wday
-	     && ((lt->tm_isdst < 0 ? -1 : 0 < lt->tm_isdst)
-		  == (tm.tm_isdst < 0 ? -1 : 0 < tm.tm_isdst))))
-	return 0;
-    }
-  return 1;
-}
-
-static int
-year_2050_test ()
-{
-  /* The correct answer for 2050-02-01 00:00:00 in Pacific time,
-     ignoring leap seconds.  */
-  unsigned long int answer = 2527315200UL;
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ssp_cv_cc" >&5
+$as_echo "$ssp_cv_cc" >&6; }
+    if test $ssp_cv_cc = yes; then
+      CFLAGS="$CFLAGS -fstack-protector-all"
 
-  struct tm tm;
-  time_t t;
-  tm.tm_year = 2050 - 1900;
-  tm.tm_mon = 2 - 1;
-  tm.tm_mday = 1;
-  tm.tm_hour = tm.tm_min = tm.tm_sec = 0;
-  tm.tm_isdst = -1;
+$as_echo "#define ENABLE_SSP_CC 1" >>confdefs.h
 
-  /* Use the portable POSIX.1 specification "TZ=PST8PDT,M4.1.0,M10.5.0"
-     instead of "TZ=America/Vancouver" in order to detect the bug even
-     on systems that don't support the Olson extension, or don't have the
-     full zoneinfo tables installed.  */
-  putenv ((char*) "TZ=PST8PDT,M4.1.0,M10.5.0");
+    fi
+  fi
 
-  t = mktime (&tm);
 
-  /* Check that the result is either a failure, or close enough
-     to the correct answer that we can assume the discrepancy is
-     due to leap seconds.  */
-  return (t == (time_t) -1
-	  || (0 < t && answer - 120 <= t && t <= answer + 120));
-}
 
+  if test "X$CC" != "X"; then
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking for FORTIFY_SOURCE support" >&5
+$as_echo_n "checking for FORTIFY_SOURCE support... " >&6; }
+    fs_old_cppflags="$CPPFLAGS"
+    fs_old_cflags="$CFLAGS"
+    CPPFLAGS="$CPPFLAGS -D_FORTIFY_SOURCE=2"
+    CFLAGS="$CFLAGS -Werror"
+    cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+#include <features.h>
 int
 main ()
 {
-  time_t t, delta;
-  int i, j;
-
-  /* This test makes some buggy mktime implementations loop.
-     Give up after 60 seconds; a mktime slower than that
-     isn't worth using anyway.  */
-  alarm (60);
-
-  for (;;)
-    {
-      t = (time_t_max << 1) + 1;
-      if (t <= time_t_max)
-	break;
-      time_t_max = t;
-    }
-  time_t_min = - ((time_t) ~ (time_t) 0 == (time_t) -1) - time_t_max;
-
-  delta = time_t_max / 997; /* a suitable prime number */
-  for (i = 0; i < N_STRINGS; i++)
-    {
-      if (tz_strings[i])
-	putenv ((char*) tz_strings[i]);
 
-      for (t = 0; t <= time_t_max - delta; t += delta)
-	if (! mktime_test (t))
-	  return 1;
-      if (! (mktime_test ((time_t) 1)
-	     && mktime_test ((time_t) (60 * 60))
-	     && mktime_test ((time_t) (60 * 60 * 24))))
-	return 1;
+      int main() {
+      #if !(__GNUC_PREREQ (4, 1) )
+      #error No FORTIFY_SOURCE support
+      #endif
+        return 0;
+      }
 
-      for (j = 1; ; j <<= 1)
-	if (! bigtime_test (j))
-	  return 1;
-	else if (INT_MAX / 2 < j)
-	  break;
-      if (! bigtime_test (INT_MAX))
-	return 1;
-    }
-  return ! (irix_6_4_bug () && spring_forward_gap () && year_2050_test ());
+  ;
+  return 0;
 }
 _ACEOF
-if ac_fn_c_try_run "$LINENO"; then :
-  ac_cv_func_working_mktime=yes
+if ac_fn_c_try_compile "$LINENO"; then :
+
+      { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+$as_echo "yes" >&6; }
+      CFLAGS="$df_old_cflags"
+
 else
-  ac_cv_func_working_mktime=no
-fi
-rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext \
-  conftest.$ac_objext conftest.beam conftest.$ac_ext
-fi
+
+      { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
+      CPPFLAGS="$df_old_cppflags"
+      CFLAGS="$df_old_cflags"
 
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_func_working_mktime" >&5
-$as_echo "$ac_cv_func_working_mktime" >&6; }
-if test $ac_cv_func_working_mktime = no; then
-  case " $LIBOBJS " in
-  *" mktime.$ac_objext "* ) ;;
-  *) LIBOBJS="$LIBOBJS mktime.$ac_objext"
- ;;
-esac
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+  fi
 
+	WARNING_CFLAGS="-g -Wall -Werror"
+else
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
+	WARNING_CFLAGS="-Wall"
 fi
 
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for working strcoll" >&5
-$as_echo_n "checking for working strcoll... " >&6; }
-if ${ac_cv_func_strcoll_works+:} false; then :
+# Enable or disable compiler warning flags
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for excessive compiler warning flags" >&5
+$as_echo_n "checking for excessive compiler warning flags... " >&6; }
+if test "x$warningflags" = "xyes" ; then
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+$as_echo "yes" >&6; }
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler handles -Wcast-align" >&5
+$as_echo_n "checking whether compiler handles -Wcast-align... " >&6; }
+if ${cflags_cv_warn__Wcast_align+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  if test "$cross_compiling" = yes; then :
-  ac_cv_func_strcoll_works=no
-else
+
+  save_CFLAGS="$CFLAGS"
+  CFLAGS="${CFLAGS} -Wcast-align"
   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
-$ac_includes_default
+
 int
 main ()
 {
-return (strcoll ("abc", "def") >= 0 ||
-	 strcoll ("ABC", "DEF") >= 0 ||
-	 strcoll ("123", "456") >= 0)
+
   ;
   return 0;
 }
 _ACEOF
-if ac_fn_c_try_run "$LINENO"; then :
-  ac_cv_func_strcoll_works=yes
+if ac_fn_c_try_compile "$LINENO"; then :
+  cflags_cv_warn__Wcast_align=yes
 else
-  ac_cv_func_strcoll_works=no
-fi
-rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext \
-  conftest.$ac_objext conftest.beam conftest.$ac_ext
+  cflags_cv_warn__Wcast_align=no
 fi
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+  CFLAGS="$save_CFLAGS"
 
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_func_strcoll_works" >&5
-$as_echo "$ac_cv_func_strcoll_works" >&6; }
-if test $ac_cv_func_strcoll_works = yes; then
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cflags_cv_warn__Wcast_align" >&5
+$as_echo "$cflags_cv_warn__Wcast_align" >&6; }
+if test "x$cflags_cv_warn__Wcast_align" = xyes; then :
+  as_fn_append WARNING_CFLAGS " -Wcast-align"
+fi
 
-$as_echo "#define HAVE_STRCOLL 1" >>confdefs.h
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler handles -Wclobbered" >&5
+$as_echo_n "checking whether compiler handles -Wclobbered... " >&6; }
+if ${cflags_cv_warn__Wclobbered+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
 
-fi
+  save_CFLAGS="$CFLAGS"
+  CFLAGS="${CFLAGS} -Wclobbered"
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
 
-for ac_func in dup2 getcwd geteuid getmntinfo gettimeofday memmove memset \
-                mkdir realpath regcomp rmdir setenv setlocale strcasecmp \
-                strchr strcspn strdup strerror strndup strrchr strsep strstr \
-                strtol swprintf tcflush wcwidth uname
-do :
-  as_ac_var=`$as_echo "ac_cv_func_$ac_func" | $as_tr_sh`
-ac_fn_c_check_func "$LINENO" "$ac_func" "$as_ac_var"
-if eval test \"x\$"$as_ac_var"\" = x"yes"; then :
-  cat >>confdefs.h <<_ACEOF
-#define `$as_echo "HAVE_$ac_func" | $as_tr_cpp` 1
-_ACEOF
+int
+main ()
+{
 
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_compile "$LINENO"; then :
+  cflags_cv_warn__Wclobbered=yes
+else
+  cflags_cv_warn__Wclobbered=no
 fi
-done
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+  CFLAGS="$save_CFLAGS"
 
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cflags_cv_warn__Wclobbered" >&5
+$as_echo "$cflags_cv_warn__Wclobbered" >&6; }
+if test "x$cflags_cv_warn__Wclobbered" = xyes; then :
+  as_fn_append WARNING_CFLAGS " -Wclobbered"
+fi
 
-# For the diskspace code
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking filesystem statistics type" >&5
-$as_echo_n "checking filesystem statistics type... " >&6; }
-if ${fs_stats_cv_type+:} false; then :
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler handles -Wempty-body" >&5
+$as_echo_n "checking whether compiler handles -Wempty-body... " >&6; }
+if ${cflags_cv_warn__Wempty_body+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  ac_fn_c_check_func "$LINENO" "getmntinfo" "ac_cv_func_getmntinfo"
-if test "x$ac_cv_func_getmntinfo" = xyes; then :
+
+  save_CFLAGS="$CFLAGS"
+  CFLAGS="${CFLAGS} -Wempty-body"
   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
-# include <sys/param.h>
-# include <sys/mount.h>
-#if HAVE_SYS_UCRED_H
-#include <sys/ucred.h>
-#endif
-extern int getmntinfo (struct statfs **, int);
-
 int
 main ()
 {
@@ -19597,95 +16774,99 @@
 }
 _ACEOF
 if ac_fn_c_try_compile "$LINENO"; then :
-  fs_stats_cv_type="struct statfs"
+  cflags_cv_warn__Wempty_body=yes
 else
-  fs_stats_cv_type="struct statvfs"
+  cflags_cv_warn__Wempty_body=no
 fi
 rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-else
-  ac_fn_c_check_func "$LINENO" "getmntent" "ac_cv_func_getmntent"
-if test "x$ac_cv_func_getmntent" = xyes; then :
-  fs_stats_cv_type="struct statvfs"
-fi
-
+  CFLAGS="$save_CFLAGS"
 
 fi
-
-
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cflags_cv_warn__Wempty_body" >&5
+$as_echo "$cflags_cv_warn__Wempty_body" >&6; }
+if test "x$cflags_cv_warn__Wempty_body" = xyes; then :
+  as_fn_append WARNING_CFLAGS " -Wempty-body"
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $fs_stats_cv_type" >&5
-$as_echo "$fs_stats_cv_type" >&6; }
-
-cat >>confdefs.h <<_ACEOF
-#define FSSTATSTYPE $fs_stats_cv_type
-_ACEOF
 
-  if test $ac_cv_func_getmntinfo = yes; then
-    if test "$fs_stats_cv_type" = "struct statvfs"; then
-
-$as_echo "#define HAVE_GETMNTINFO_STATVFS 1" >>confdefs.h
-
-    else
-
-$as_echo "#define HAVE_GETMNTINFO_STATFS 1" >>confdefs.h
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler handles -Wfloat-equal" >&5
+$as_echo_n "checking whether compiler handles -Wfloat-equal... " >&6; }
+if ${cflags_cv_warn__Wfloat_equal+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
 
-    fi
-  fi
+  save_CFLAGS="$CFLAGS"
+  CFLAGS="${CFLAGS} -Wfloat-equal"
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
 
-ac_fn_c_check_member "$LINENO" "struct statvfs" "f_flag" "ac_cv_member_struct_statvfs_f_flag" "#include <sys/statvfs.h>
-"
-if test "x$ac_cv_member_struct_statvfs_f_flag" = xyes; then :
+int
+main ()
+{
 
-cat >>confdefs.h <<_ACEOF
-#define HAVE_STRUCT_STATVFS_F_FLAG 1
+  ;
+  return 0;
+}
 _ACEOF
-
+if ac_fn_c_try_compile "$LINENO"; then :
+  cflags_cv_warn__Wfloat_equal=yes
+else
+  cflags_cv_warn__Wfloat_equal=no
+fi
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+  CFLAGS="$save_CFLAGS"
 
 fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cflags_cv_warn__Wfloat_equal" >&5
+$as_echo "$cflags_cv_warn__Wfloat_equal" >&6; }
+if test "x$cflags_cv_warn__Wfloat_equal" = xyes; then :
+  as_fn_append WARNING_CFLAGS " -Wfloat-equal"
+fi
 
-ac_fn_c_check_member "$LINENO" "struct statfs" "f_flags" "ac_cv_member_struct_statfs_f_flags" "#include <sys/param.h>
-                  #include <sys/mount.h>
-"
-if test "x$ac_cv_member_struct_statfs_f_flags" = xyes; then :
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler handles -Wformat-nonliteral" >&5
+$as_echo_n "checking whether compiler handles -Wformat-nonliteral... " >&6; }
+if ${cflags_cv_warn__Wformat_nonliteral+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
 
-cat >>confdefs.h <<_ACEOF
-#define HAVE_STRUCT_STATFS_F_FLAGS 1
-_ACEOF
+  save_CFLAGS="$CFLAGS"
+  CFLAGS="${CFLAGS} -Wformat-nonliteral"
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
 
+int
+main ()
+{
 
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_compile "$LINENO"; then :
+  cflags_cv_warn__Wformat_nonliteral=yes
+else
+  cflags_cv_warn__Wformat_nonliteral=no
 fi
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+  CFLAGS="$save_CFLAGS"
 
-
-# Enable large file support if available
-# Check whether --enable-largefile was given.
-if test "${enable_largefile+set}" = set; then :
-  enableval=$enable_largefile;
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cflags_cv_warn__Wformat_nonliteral" >&5
+$as_echo "$cflags_cv_warn__Wformat_nonliteral" >&6; }
+if test "x$cflags_cv_warn__Wformat_nonliteral" = xyes; then :
+  as_fn_append WARNING_CFLAGS " -Wformat-nonliteral"
 fi
 
-if test "$enable_largefile" != no; then
-
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for special C compiler options needed for large files" >&5
-$as_echo_n "checking for special C compiler options needed for large files... " >&6; }
-if ${ac_cv_sys_largefile_CC+:} false; then :
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler handles -Wformat-security" >&5
+$as_echo_n "checking whether compiler handles -Wformat-security... " >&6; }
+if ${cflags_cv_warn__Wformat_security+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  ac_cv_sys_largefile_CC=no
-     if test "$GCC" != yes; then
-       ac_save_CC=$CC
-       while :; do
-	 # IRIX 6.2 and later do not support large files by default,
-	 # so use the C compiler's -n32 option if that helps.
-	 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <sys/types.h>
- /* Check that off_t can represent 2**63 - 1 correctly.
-    We can't simply define LARGE_OFF_T to be 9223372036854775807,
-    since some C++ compilers masquerading as C compilers
-    incorrectly reject 9223372036854775807.  */
-#define LARGE_OFF_T (((off_t) 1 << 62) - 1 + ((off_t) 1 << 62))
-  int off_t_is_large[(LARGE_OFF_T % 2147483629 == 721
-		       && LARGE_OFF_T % 2147483647 == 1)
-		      ? 1 : -1];
+
+  save_CFLAGS="$CFLAGS"
+  CFLAGS="${CFLAGS} -Wformat-security"
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+
 int
 main ()
 {
@@ -19694,44 +16875,32 @@
   return 0;
 }
 _ACEOF
-	 if ac_fn_c_try_compile "$LINENO"; then :
-  break
+if ac_fn_c_try_compile "$LINENO"; then :
+  cflags_cv_warn__Wformat_security=yes
+else
+  cflags_cv_warn__Wformat_security=no
 fi
-rm -f core conftest.err conftest.$ac_objext
-	 CC="$CC -n32"
-	 if ac_fn_c_try_compile "$LINENO"; then :
-  ac_cv_sys_largefile_CC=' -n32'; break
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+  CFLAGS="$save_CFLAGS"
+
 fi
-rm -f core conftest.err conftest.$ac_objext
-	 break
-       done
-       CC=$ac_save_CC
-       rm -f conftest.$ac_ext
-    fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cflags_cv_warn__Wformat_security" >&5
+$as_echo "$cflags_cv_warn__Wformat_security" >&6; }
+if test "x$cflags_cv_warn__Wformat_security" = xyes; then :
+  as_fn_append WARNING_CFLAGS " -Wformat-security"
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_sys_largefile_CC" >&5
-$as_echo "$ac_cv_sys_largefile_CC" >&6; }
-  if test "$ac_cv_sys_largefile_CC" != no; then
-    CC=$CC$ac_cv_sys_largefile_CC
-  fi
 
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for _FILE_OFFSET_BITS value needed for large files" >&5
-$as_echo_n "checking for _FILE_OFFSET_BITS value needed for large files... " >&6; }
-if ${ac_cv_sys_file_offset_bits+:} false; then :
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler handles -Wignored-qualifiers" >&5
+$as_echo_n "checking whether compiler handles -Wignored-qualifiers... " >&6; }
+if ${cflags_cv_warn__Wignored_qualifiers+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  while :; do
+
+  save_CFLAGS="$CFLAGS"
+  CFLAGS="${CFLAGS} -Wignored-qualifiers"
   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
-#include <sys/types.h>
- /* Check that off_t can represent 2**63 - 1 correctly.
-    We can't simply define LARGE_OFF_T to be 9223372036854775807,
-    since some C++ compilers masquerading as C compilers
-    incorrectly reject 9223372036854775807.  */
-#define LARGE_OFF_T (((off_t) 1 << 62) - 1 + ((off_t) 1 << 62))
-  int off_t_is_large[(LARGE_OFF_T % 2147483629 == 721
-		       && LARGE_OFF_T % 2147483647 == 1)
-		      ? 1 : -1];
+
 int
 main ()
 {
@@ -19741,21 +16910,31 @@
 }
 _ACEOF
 if ac_fn_c_try_compile "$LINENO"; then :
-  ac_cv_sys_file_offset_bits=no; break
+  cflags_cv_warn__Wignored_qualifiers=yes
+else
+  cflags_cv_warn__Wignored_qualifiers=no
 fi
 rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+  CFLAGS="$save_CFLAGS"
+
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cflags_cv_warn__Wignored_qualifiers" >&5
+$as_echo "$cflags_cv_warn__Wignored_qualifiers" >&6; }
+if test "x$cflags_cv_warn__Wignored_qualifiers" = xyes; then :
+  as_fn_append WARNING_CFLAGS " -Wignored-qualifiers"
+fi
+
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler handles -Winit-self" >&5
+$as_echo_n "checking whether compiler handles -Winit-self... " >&6; }
+if ${cflags_cv_warn__Winit_self+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+
+  save_CFLAGS="$CFLAGS"
+  CFLAGS="${CFLAGS} -Winit-self"
   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
-#define _FILE_OFFSET_BITS 64
-#include <sys/types.h>
- /* Check that off_t can represent 2**63 - 1 correctly.
-    We can't simply define LARGE_OFF_T to be 9223372036854775807,
-    since some C++ compilers masquerading as C compilers
-    incorrectly reject 9223372036854775807.  */
-#define LARGE_OFF_T (((off_t) 1 << 62) - 1 + ((off_t) 1 << 62))
-  int off_t_is_large[(LARGE_OFF_T % 2147483629 == 721
-		       && LARGE_OFF_T % 2147483647 == 1)
-		      ? 1 : -1];
+
 int
 main ()
 {
@@ -19765,42 +16944,31 @@
 }
 _ACEOF
 if ac_fn_c_try_compile "$LINENO"; then :
-  ac_cv_sys_file_offset_bits=64; break
+  cflags_cv_warn__Winit_self=yes
+else
+  cflags_cv_warn__Winit_self=no
 fi
 rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-  ac_cv_sys_file_offset_bits=unknown
-  break
-done
+  CFLAGS="$save_CFLAGS"
+
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_sys_file_offset_bits" >&5
-$as_echo "$ac_cv_sys_file_offset_bits" >&6; }
-case $ac_cv_sys_file_offset_bits in #(
-  no | unknown) ;;
-  *)
-cat >>confdefs.h <<_ACEOF
-#define _FILE_OFFSET_BITS $ac_cv_sys_file_offset_bits
-_ACEOF
-;;
-esac
-rm -rf conftest*
-  if test $ac_cv_sys_file_offset_bits = unknown; then
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking for _LARGE_FILES value needed for large files" >&5
-$as_echo_n "checking for _LARGE_FILES value needed for large files... " >&6; }
-if ${ac_cv_sys_large_files+:} false; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cflags_cv_warn__Winit_self" >&5
+$as_echo "$cflags_cv_warn__Winit_self" >&6; }
+if test "x$cflags_cv_warn__Winit_self" = xyes; then :
+  as_fn_append WARNING_CFLAGS " -Winit-self"
+fi
+
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler handles -Wlogical-op" >&5
+$as_echo_n "checking whether compiler handles -Wlogical-op... " >&6; }
+if ${cflags_cv_warn__Wlogical_op+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  while :; do
+
+  save_CFLAGS="$CFLAGS"
+  CFLAGS="${CFLAGS} -Wlogical-op"
   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
-#include <sys/types.h>
- /* Check that off_t can represent 2**63 - 1 correctly.
-    We can't simply define LARGE_OFF_T to be 9223372036854775807,
-    since some C++ compilers masquerading as C compilers
-    incorrectly reject 9223372036854775807.  */
-#define LARGE_OFF_T (((off_t) 1 << 62) - 1 + ((off_t) 1 << 62))
-  int off_t_is_large[(LARGE_OFF_T % 2147483629 == 721
-		       && LARGE_OFF_T % 2147483647 == 1)
-		      ? 1 : -1];
+
 int
 main ()
 {
@@ -19810,21 +16978,31 @@
 }
 _ACEOF
 if ac_fn_c_try_compile "$LINENO"; then :
-  ac_cv_sys_large_files=no; break
+  cflags_cv_warn__Wlogical_op=yes
+else
+  cflags_cv_warn__Wlogical_op=no
 fi
 rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+  CFLAGS="$save_CFLAGS"
+
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cflags_cv_warn__Wlogical_op" >&5
+$as_echo "$cflags_cv_warn__Wlogical_op" >&6; }
+if test "x$cflags_cv_warn__Wlogical_op" = xyes; then :
+  as_fn_append WARNING_CFLAGS " -Wlogical-op"
+fi
+
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler handles -Wmissing-declarations" >&5
+$as_echo_n "checking whether compiler handles -Wmissing-declarations... " >&6; }
+if ${cflags_cv_warn__Wmissing_declarations+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+
+  save_CFLAGS="$CFLAGS"
+  CFLAGS="${CFLAGS} -Wmissing-declarations"
   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
-#define _LARGE_FILES 1
-#include <sys/types.h>
- /* Check that off_t can represent 2**63 - 1 correctly.
-    We can't simply define LARGE_OFF_T to be 9223372036854775807,
-    since some C++ compilers masquerading as C compilers
-    incorrectly reject 9223372036854775807.  */
-#define LARGE_OFF_T (((off_t) 1 << 62) - 1 + ((off_t) 1 << 62))
-  int off_t_is_large[(LARGE_OFF_T % 2147483629 == 721
-		       && LARGE_OFF_T % 2147483647 == 1)
-		      ? 1 : -1];
+
 int
 main ()
 {
@@ -19834,40 +17012,29 @@
 }
 _ACEOF
 if ac_fn_c_try_compile "$LINENO"; then :
-  ac_cv_sys_large_files=1; break
+  cflags_cv_warn__Wmissing_declarations=yes
+else
+  cflags_cv_warn__Wmissing_declarations=no
 fi
 rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-  ac_cv_sys_large_files=unknown
-  break
-done
+  CFLAGS="$save_CFLAGS"
+
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_sys_large_files" >&5
-$as_echo "$ac_cv_sys_large_files" >&6; }
-case $ac_cv_sys_large_files in #(
-  no | unknown) ;;
-  *)
-cat >>confdefs.h <<_ACEOF
-#define _LARGE_FILES $ac_cv_sys_large_files
-_ACEOF
-;;
-esac
-rm -rf conftest*
-  fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cflags_cv_warn__Wmissing_declarations" >&5
+$as_echo "$cflags_cv_warn__Wmissing_declarations" >&6; }
+if test "x$cflags_cv_warn__Wmissing_declarations" = xyes; then :
+  as_fn_append WARNING_CFLAGS " -Wmissing-declarations"
 fi
 
-
-# Check if we can use symbol visibility support in GCC
-
-
-  if test "X$CC" != "X"; then
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether ${CC} accepts -fvisibility=internal" >&5
-$as_echo_n "checking whether ${CC} accepts -fvisibility=internal... " >&6; }
-if ${visibility_cv_cc+:} false; then :
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler handles -Wmissing-field-initializers" >&5
+$as_echo_n "checking whether compiler handles -Wmissing-field-initializers... " >&6; }
+if ${cflags_cv_warn__Wmissing_field_initializers+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  visibility_old_cflags="$CFLAGS"
-       CFLAGS="$CFLAGS -fvisibility=internal"
-       cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+
+  save_CFLAGS="$CFLAGS"
+  CFLAGS="${CFLAGS} -Wmissing-field-initializers"
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
 int
@@ -19879,43 +17046,63 @@
 }
 _ACEOF
 if ac_fn_c_try_compile "$LINENO"; then :
-  visibility_cv_cc=yes
+  cflags_cv_warn__Wmissing_field_initializers=yes
 else
-  visibility_cv_cc=no
+  cflags_cv_warn__Wmissing_field_initializers=no
 fi
 rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-       CFLAGS="$visibility_old_cflags"
+  CFLAGS="$save_CFLAGS"
 
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $visibility_cv_cc" >&5
-$as_echo "$visibility_cv_cc" >&6; }
-    if test $visibility_cv_cc = yes; then
-
-$as_echo "#define ENABLE_VISIBILITY_CC 1" >>confdefs.h
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cflags_cv_warn__Wmissing_field_initializers" >&5
+$as_echo "$cflags_cv_warn__Wmissing_field_initializers" >&6; }
+if test "x$cflags_cv_warn__Wmissing_field_initializers" = xyes; then :
+  as_fn_append WARNING_CFLAGS " -Wmissing-field-initializers"
+fi
 
-    fi
-     if test "x$visibility_cv_cc" = "xyes"; then
-  ENABLE_VISIBILITY_CC_TRUE=
-  ENABLE_VISIBILITY_CC_FALSE='#'
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler handles -Wmissing-parameter-type" >&5
+$as_echo_n "checking whether compiler handles -Wmissing-parameter-type... " >&6; }
+if ${cflags_cv_warn__Wmissing_parameter_type+:} false; then :
+  $as_echo_n "(cached) " >&6
 else
-  ENABLE_VISIBILITY_CC_TRUE='#'
-  ENABLE_VISIBILITY_CC_FALSE=
-fi
 
-  fi
+  save_CFLAGS="$CFLAGS"
+  CFLAGS="${CFLAGS} -Wmissing-parameter-type"
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
 
-# Check if we have -fgnu89-inline flag
+int
+main ()
+{
+
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_compile "$LINENO"; then :
+  cflags_cv_warn__Wmissing_parameter_type=yes
+else
+  cflags_cv_warn__Wmissing_parameter_type=no
+fi
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+  CFLAGS="$save_CFLAGS"
 
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cflags_cv_warn__Wmissing_parameter_type" >&5
+$as_echo "$cflags_cv_warn__Wmissing_parameter_type" >&6; }
+if test "x$cflags_cv_warn__Wmissing_parameter_type" = xyes; then :
+  as_fn_append WARNING_CFLAGS " -Wmissing-parameter-type"
+fi
 
-  if test "X$CC" != "X"; then
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking for -fgnu89-inline" >&5
-$as_echo_n "checking for -fgnu89-inline... " >&6; }
-if ${gnu89_inline_cv_cc+:} false; then :
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler handles -Wmissing-prototypes" >&5
+$as_echo_n "checking whether compiler handles -Wmissing-prototypes... " >&6; }
+if ${cflags_cv_warn__Wmissing_prototypes+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-   gnu89_inline_old_cflags="$CFLAGS"
-      CFLAGS="$CFLAGS -fgnu89-inline"
-      cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+
+  save_CFLAGS="$CFLAGS"
+  CFLAGS="${CFLAGS} -Wmissing-prototypes"
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
 int
@@ -19927,301 +17114,369 @@
 }
 _ACEOF
 if ac_fn_c_try_compile "$LINENO"; then :
-  gnu89_inline_cv_cc=yes
+  cflags_cv_warn__Wmissing_prototypes=yes
 else
-  gnu89_inline_cv_cc=no
+  cflags_cv_warn__Wmissing_prototypes=no
 fi
 rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-      CFLAGS="$gnu89_inline_old_cflags"
+  CFLAGS="$save_CFLAGS"
 
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $gnu89_inline_cv_cc" >&5
-$as_echo "$gnu89_inline_cv_cc" >&6; }
-    if test $gnu89_inline_cv_cc = yes; then
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cflags_cv_warn__Wmissing_prototypes" >&5
+$as_echo "$cflags_cv_warn__Wmissing_prototypes" >&6; }
+if test "x$cflags_cv_warn__Wmissing_prototypes" = xyes; then :
+  as_fn_append WARNING_CFLAGS " -Wmissing-prototypes"
+fi
 
-$as_echo "#define ENABLE_GNU89_INLINE_CC 1" >>confdefs.h
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler handles -Wold-style-declaration" >&5
+$as_echo_n "checking whether compiler handles -Wold-style-declaration... " >&6; }
+if ${cflags_cv_warn__Wold_style_declaration+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
 
-    fi
-     if test "x$gnu89_inline_cv_cc" = "xyes"; then
-  ENABLE_GNU89_INLINE_CC_TRUE=
-  ENABLE_GNU89_INLINE_CC_FALSE='#'
+  save_CFLAGS="$CFLAGS"
+  CFLAGS="${CFLAGS} -Wold-style-declaration"
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+
+int
+main ()
+{
+
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_compile "$LINENO"; then :
+  cflags_cv_warn__Wold_style_declaration=yes
 else
-  ENABLE_GNU89_INLINE_CC_TRUE='#'
-  ENABLE_GNU89_INLINE_CC_FALSE=
+  cflags_cv_warn__Wold_style_declaration=no
 fi
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+  CFLAGS="$save_CFLAGS"
 
-  fi
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cflags_cv_warn__Wold_style_declaration" >&5
+$as_echo "$cflags_cv_warn__Wold_style_declaration" >&6; }
+if test "x$cflags_cv_warn__Wold_style_declaration" = xyes; then :
+  as_fn_append WARNING_CFLAGS " -Wold-style-declaration"
+fi
 
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler handles -Woverride-init" >&5
+$as_echo_n "checking whether compiler handles -Woverride-init... " >&6; }
+if ${cflags_cv_warn__Woverride_init+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
 
-# Host-dependant definitions
-SIZECMD="stat -c %s"
-SEDINPLACE="sed -i"
-STRIP_BINARIES="--strip-all"
-STRIP_SHARED="--strip-unneeded"
-STRIP_STATIC="--strip-debug"
-case "${host_os}" in
-	*bsd*)
-		SIZECMD="stat -f %z"
-		SEDINPLACE="sed -i \"\""
-		;;
-	cygwin*)
-		host_os_cygwin=yes
-		CFLAGS="$CFLAGS -DCYGWIN"
-		;;
-	darwin*)
-		host_os_darwin=yes
-		SIZECMD="/usr/bin/stat -f %z"
-		SEDINPLACE="/usr/bin/sed -i ''"
-		STRIP_BINARIES=""
-		STRIP_SHARED="-S"
-		STRIP_STATIC="-S"
-		;;
-esac
+  save_CFLAGS="$CFLAGS"
+  CFLAGS="${CFLAGS} -Woverride-init"
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
 
- if test "x$host_os_cygwin" = "xyes"; then
-  CYGWIN_TRUE=
-  CYGWIN_FALSE='#'
+int
+main ()
+{
+
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_compile "$LINENO"; then :
+  cflags_cv_warn__Woverride_init=yes
 else
-  CYGWIN_TRUE='#'
-  CYGWIN_FALSE=
+  cflags_cv_warn__Woverride_init=no
 fi
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+  CFLAGS="$save_CFLAGS"
 
- if test "x$host_os_darwin" = "xyes"; then
-  DARWIN_TRUE=
-  DARWIN_FALSE='#'
-else
-  DARWIN_TRUE='#'
-  DARWIN_FALSE=
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cflags_cv_warn__Woverride_init" >&5
+$as_echo "$cflags_cv_warn__Woverride_init" >&6; }
+if test "x$cflags_cv_warn__Woverride_init" = xyes; then :
+  as_fn_append WARNING_CFLAGS " -Woverride-init"
 fi
 
-for ac_prog in du
-do
-  # Extract the first word of "$ac_prog", so it can be a program name with args.
-set dummy $ac_prog; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_path_DUPATH+:} false; then :
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler handles -Wpointer-arith" >&5
+$as_echo_n "checking whether compiler handles -Wpointer-arith... " >&6; }
+if ${cflags_cv_warn__Wpointer_arith+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  case $DUPATH in
-  [\\/]* | ?:[\\/]*)
-  ac_cv_path_DUPATH="$DUPATH" # Let the user override the test with a path.
-  ;;
-  *)
-  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in /usr/bin$PATH_SEPARATOR/bin
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_path_DUPATH="$as_dir/$ac_word$ac_exec_ext"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
 
-  ;;
-esac
-fi
-DUPATH=$ac_cv_path_DUPATH
-if test -n "$DUPATH"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $DUPATH" >&5
-$as_echo "$DUPATH" >&6; }
+  save_CFLAGS="$CFLAGS"
+  CFLAGS="${CFLAGS} -Wpointer-arith"
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+
+int
+main ()
+{
+
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_compile "$LINENO"; then :
+  cflags_cv_warn__Wpointer_arith=yes
 else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
+  cflags_cv_warn__Wpointer_arith=no
 fi
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+  CFLAGS="$save_CFLAGS"
 
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cflags_cv_warn__Wpointer_arith" >&5
+$as_echo "$cflags_cv_warn__Wpointer_arith" >&6; }
+if test "x$cflags_cv_warn__Wpointer_arith" = xyes; then :
+  as_fn_append WARNING_CFLAGS " -Wpointer-arith"
+fi
 
-  test -n "$DUPATH" && break
-done
-test -n "$DUPATH" || DUPATH="du"
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler handles -Wredundant-decls" >&5
+$as_echo_n "checking whether compiler handles -Wredundant-decls... " >&6; }
+if ${cflags_cv_warn__Wredundant_decls+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
 
+  save_CFLAGS="$CFLAGS"
+  CFLAGS="${CFLAGS} -Wredundant-decls"
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
 
+int
+main ()
+{
 
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_compile "$LINENO"; then :
+  cflags_cv_warn__Wredundant_decls=yes
+else
+  cflags_cv_warn__Wredundant_decls=no
+fi
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+  CFLAGS="$save_CFLAGS"
 
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cflags_cv_warn__Wredundant_decls" >&5
+$as_echo "$cflags_cv_warn__Wredundant_decls" >&6; }
+if test "x$cflags_cv_warn__Wredundant_decls" = xyes; then :
+  as_fn_append WARNING_CFLAGS " -Wredundant-decls"
+fi
 
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler handles -Wshadow" >&5
+$as_echo_n "checking whether compiler handles -Wshadow... " >&6; }
+if ${cflags_cv_warn__Wshadow+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
 
+  save_CFLAGS="$CFLAGS"
+  CFLAGS="${CFLAGS} -Wshadow"
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
 
-# Variables plugged into makepkg.conf
-CARCH="${host%%-*}"
-CHOST="${host}"
+int
+main ()
+{
 
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_compile "$LINENO"; then :
+  cflags_cv_warn__Wshadow=yes
+else
+  cflags_cv_warn__Wshadow=no
+fi
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+  CFLAGS="$save_CFLAGS"
 
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cflags_cv_warn__Wshadow" >&5
+$as_echo "$cflags_cv_warn__Wshadow" >&6; }
+if test "x$cflags_cv_warn__Wshadow" = xyes; then :
+  as_fn_append WARNING_CFLAGS " -Wshadow"
+fi
 
-# Check for documentation support and status
-for ac_prog in asciidoc
-do
-  # Extract the first word of "$ac_prog", so it can be a program name with args.
-set dummy $ac_prog; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_prog_ASCIIDOC+:} false; then :
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler handles -Wsign-compare" >&5
+$as_echo_n "checking whether compiler handles -Wsign-compare... " >&6; }
+if ${cflags_cv_warn__Wsign_compare+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  if test -n "$ASCIIDOC"; then
-  ac_cv_prog_ASCIIDOC="$ASCIIDOC" # Let the user override the test.
+
+  save_CFLAGS="$CFLAGS"
+  CFLAGS="${CFLAGS} -Wsign-compare"
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+
+int
+main ()
+{
+
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_compile "$LINENO"; then :
+  cflags_cv_warn__Wsign_compare=yes
 else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_ASCIIDOC="$ac_prog"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
+  cflags_cv_warn__Wsign_compare=no
+fi
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+  CFLAGS="$save_CFLAGS"
 
 fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cflags_cv_warn__Wsign_compare" >&5
+$as_echo "$cflags_cv_warn__Wsign_compare" >&6; }
+if test "x$cflags_cv_warn__Wsign_compare" = xyes; then :
+  as_fn_append WARNING_CFLAGS " -Wsign-compare"
 fi
-ASCIIDOC=$ac_cv_prog_ASCIIDOC
-if test -n "$ASCIIDOC"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ASCIIDOC" >&5
-$as_echo "$ASCIIDOC" >&6; }
+
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler handles -Wstrict-aliasing" >&5
+$as_echo_n "checking whether compiler handles -Wstrict-aliasing... " >&6; }
+if ${cflags_cv_warn__Wstrict_aliasing+:} false; then :
+  $as_echo_n "(cached) " >&6
 else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
 
+  save_CFLAGS="$CFLAGS"
+  CFLAGS="${CFLAGS} -Wstrict-aliasing"
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
 
-  test -n "$ASCIIDOC" && break
-done
+int
+main ()
+{
 
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for building documentation" >&5
-$as_echo_n "checking for building documentation... " >&6; }
-if test "x$wantdoc" = "xyes" ; then
-	if test $ASCIIDOC ; then
-		{ $as_echo "$as_me:${as_lineno-$LINENO}: result: yes, enabled by configure" >&5
-$as_echo "yes, enabled by configure" >&6; }
-	else
-		asciidoc="(warning : asciidoc not installed)"
-		{ $as_echo "$as_me:${as_lineno-$LINENO}: result: yes $asciidoc" >&5
-$as_echo "yes $asciidoc" >&6; }
-	fi
-	wantdoc=yes
-else
-	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no, disabled by configure" >&5
-$as_echo "no, disabled by configure" >&6; }
-	wantdoc=no
-fi
- if test "x$wantdoc" = "xyes"; then
-  WANT_DOC_TRUE=
-  WANT_DOC_FALSE='#'
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_compile "$LINENO"; then :
+  cflags_cv_warn__Wstrict_aliasing=yes
 else
-  WANT_DOC_TRUE='#'
-  WANT_DOC_FALSE=
+  cflags_cv_warn__Wstrict_aliasing=no
 fi
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+  CFLAGS="$save_CFLAGS"
 
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cflags_cv_warn__Wstrict_aliasing" >&5
+$as_echo "$cflags_cv_warn__Wstrict_aliasing" >&6; }
+if test "x$cflags_cv_warn__Wstrict_aliasing" = xyes; then :
+  as_fn_append WARNING_CFLAGS " -Wstrict-aliasing"
+fi
 
-# Check for doxygen support and status
-for ac_prog in doxygen
-do
-  # Extract the first word of "$ac_prog", so it can be a program name with args.
-set dummy $ac_prog; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_prog_DOXYGEN+:} false; then :
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler handles -Wstrict-overflow=5" >&5
+$as_echo_n "checking whether compiler handles -Wstrict-overflow=5... " >&6; }
+if ${cflags_cv_warn__Wstrict_overflow_5+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  if test -n "$DOXYGEN"; then
-  ac_cv_prog_DOXYGEN="$DOXYGEN" # Let the user override the test.
+
+  save_CFLAGS="$CFLAGS"
+  CFLAGS="${CFLAGS} -Wstrict-overflow=5"
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+
+int
+main ()
+{
+
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_compile "$LINENO"; then :
+  cflags_cv_warn__Wstrict_overflow_5=yes
 else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_DOXYGEN="$ac_prog"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
+  cflags_cv_warn__Wstrict_overflow_5=no
+fi
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+  CFLAGS="$save_CFLAGS"
 
 fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cflags_cv_warn__Wstrict_overflow_5" >&5
+$as_echo "$cflags_cv_warn__Wstrict_overflow_5" >&6; }
+if test "x$cflags_cv_warn__Wstrict_overflow_5" = xyes; then :
+  as_fn_append WARNING_CFLAGS " -Wstrict-overflow=5"
 fi
-DOXYGEN=$ac_cv_prog_DOXYGEN
-if test -n "$DOXYGEN"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $DOXYGEN" >&5
-$as_echo "$DOXYGEN" >&6; }
+
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler handles -Wstrict-prototypes" >&5
+$as_echo_n "checking whether compiler handles -Wstrict-prototypes... " >&6; }
+if ${cflags_cv_warn__Wstrict_prototypes+:} false; then :
+  $as_echo_n "(cached) " >&6
 else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
 
+  save_CFLAGS="$CFLAGS"
+  CFLAGS="${CFLAGS} -Wstrict-prototypes"
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
 
-  test -n "$DOXYGEN" && break
-done
+int
+main ()
+{
 
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for doxygen" >&5
-$as_echo_n "checking for doxygen... " >&6; }
-if test "x$wantdoxygen" = "xyes" ; then
-	if test $DOXYGEN ; then
-		{ $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }
-		usedoxygen=yes
-	else
-		{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no, doxygen missing" >&5
-$as_echo "no, doxygen missing" >&6; }
-		usedoxygen=no
-	fi
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_compile "$LINENO"; then :
+  cflags_cv_warn__Wstrict_prototypes=yes
 else
-	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no, disabled by configure" >&5
-$as_echo "no, disabled by configure" >&6; }
-	usedoxygen=no
+  cflags_cv_warn__Wstrict_prototypes=no
 fi
- if test "x$usedoxygen" = "xyes"; then
-  USE_DOXYGEN_TRUE=
-  USE_DOXYGEN_FALSE='#'
-else
-  USE_DOXYGEN_TRUE='#'
-  USE_DOXYGEN_FALSE=
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+  CFLAGS="$save_CFLAGS"
+
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cflags_cv_warn__Wstrict_prototypes" >&5
+$as_echo "$cflags_cv_warn__Wstrict_prototypes" >&6; }
+if test "x$cflags_cv_warn__Wstrict_prototypes" = xyes; then :
+  as_fn_append WARNING_CFLAGS " -Wstrict-prototypes"
 fi
 
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler handles -Wtype-limits" >&5
+$as_echo_n "checking whether compiler handles -Wtype-limits... " >&6; }
+if ${cflags_cv_warn__Wtype_limits+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
 
-# Enable or disable debug code
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for debug mode request" >&5
-$as_echo_n "checking for debug mode request... " >&6; }
-if test "x$debug" = "xyes" ; then
-	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }
+  save_CFLAGS="$CFLAGS"
+  CFLAGS="${CFLAGS} -Wtype-limits"
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
 
-$as_echo "#define PACMAN_DEBUG /**/" >>confdefs.h
+int
+main ()
+{
 
-	# Check for mcheck
-	for ac_header in mcheck.h
-do :
-  ac_fn_c_check_header_mongrel "$LINENO" "mcheck.h" "ac_cv_header_mcheck_h" "$ac_includes_default"
-if test "x$ac_cv_header_mcheck_h" = xyes; then :
-  cat >>confdefs.h <<_ACEOF
-#define HAVE_MCHECK_H 1
+  ;
+  return 0;
+}
 _ACEOF
-
+if ac_fn_c_try_compile "$LINENO"; then :
+  cflags_cv_warn__Wtype_limits=yes
+else
+  cflags_cv_warn__Wtype_limits=no
 fi
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+  CFLAGS="$save_CFLAGS"
 
-done
-
-	# Check for -fstack-protector availability
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cflags_cv_warn__Wtype_limits" >&5
+$as_echo "$cflags_cv_warn__Wtype_limits" >&6; }
+if test "x$cflags_cv_warn__Wtype_limits" = xyes; then :
+  as_fn_append WARNING_CFLAGS " -Wtype-limits"
+fi
 
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether libssp exists" >&5
-$as_echo_n "checking whether libssp exists... " >&6; }
-if ${ssp_cv_lib+:} false; then :
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler handles -Wuninitialized" >&5
+$as_echo_n "checking whether compiler handles -Wuninitialized... " >&6; }
+if ${cflags_cv_warn__Wuninitialized+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  ssp_old_libs="$LIBS"
-     LIBS="$LIBS -lssp"
-     cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+
+  save_CFLAGS="$CFLAGS"
+  CFLAGS="${CFLAGS} -Wuninitialized"
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
 int
@@ -20232,33 +17487,30 @@
   return 0;
 }
 _ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  ssp_cv_lib=yes
+if ac_fn_c_try_compile "$LINENO"; then :
+  cflags_cv_warn__Wuninitialized=yes
 else
-  ssp_cv_lib=no
+  cflags_cv_warn__Wuninitialized=no
 fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-     LIBS="$ssp_old_libs"
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+  CFLAGS="$save_CFLAGS"
 
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ssp_cv_lib" >&5
-$as_echo "$ssp_cv_lib" >&6; }
-  if test $ssp_cv_lib = yes; then
-    LIBS="$LIBS -lssp"
-  fi
-
-
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cflags_cv_warn__Wuninitialized" >&5
+$as_echo "$cflags_cv_warn__Wuninitialized" >&6; }
+if test "x$cflags_cv_warn__Wuninitialized" = xyes; then :
+  as_fn_append WARNING_CFLAGS " -Wuninitialized"
+fi
 
-  if test "X$CC" != "X"; then
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether ${CC} accepts -fstack-protector-all" >&5
-$as_echo_n "checking whether ${CC} accepts -fstack-protector-all... " >&6; }
-if ${ssp_cv_cc+:} false; then :
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler handles -Wunused-but-set-parameter" >&5
+$as_echo_n "checking whether compiler handles -Wunused-but-set-parameter... " >&6; }
+if ${cflags_cv_warn__Wunused_but_set_parameter+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  ssp_old_cflags="$CFLAGS"
-       CFLAGS="$CFLAGS -fstack-protector-all"
-       cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+
+  save_CFLAGS="$CFLAGS"
+  CFLAGS="${CFLAGS} -Wunused-but-set-parameter"
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
 int
@@ -20270,67 +17522,91 @@
 }
 _ACEOF
 if ac_fn_c_try_compile "$LINENO"; then :
-  ssp_cv_cc=yes
+  cflags_cv_warn__Wunused_but_set_parameter=yes
 else
-  ssp_cv_cc=no
+  cflags_cv_warn__Wunused_but_set_parameter=no
 fi
 rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-       CFLAGS="$ssp_old_cflags"
+  CFLAGS="$save_CFLAGS"
 
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ssp_cv_cc" >&5
-$as_echo "$ssp_cv_cc" >&6; }
-    if test $ssp_cv_cc = yes; then
-      CFLAGS="$CFLAGS -fstack-protector-all"
-
-$as_echo "#define ENABLE_SSP_CC 1" >>confdefs.h
-
-    fi
-  fi
-
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cflags_cv_warn__Wunused_but_set_parameter" >&5
+$as_echo "$cflags_cv_warn__Wunused_but_set_parameter" >&6; }
+if test "x$cflags_cv_warn__Wunused_but_set_parameter" = xyes; then :
+  as_fn_append WARNING_CFLAGS " -Wunused-but-set-parameter"
+fi
 
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler handles -Wunused-parameter" >&5
+$as_echo_n "checking whether compiler handles -Wunused-parameter... " >&6; }
+if ${cflags_cv_warn__Wunused_parameter+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
 
-  if test "X$CC" != "X"; then
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking for FORTIFY_SOURCE support" >&5
-$as_echo_n "checking for FORTIFY_SOURCE support... " >&6; }
-    cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+  save_CFLAGS="$CFLAGS"
+  CFLAGS="${CFLAGS} -Wunused-parameter"
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
-#include <features.h>
+
 int
 main ()
 {
 
-      int main() {
-      #if !(__GNUC_PREREQ (4, 1) )
-      #error No FORTIFY_SOURCE support
-      #endif
-        return 0;
-      }
-
   ;
   return 0;
 }
 _ACEOF
 if ac_fn_c_try_compile "$LINENO"; then :
+  cflags_cv_warn__Wunused_parameter=yes
+else
+  cflags_cv_warn__Wunused_parameter=no
+fi
+rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+  CFLAGS="$save_CFLAGS"
 
-      { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }
-      CFLAGS="$CFLAGS -D_FORTIFY_SOURCE=2"
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cflags_cv_warn__Wunused_parameter" >&5
+$as_echo "$cflags_cv_warn__Wunused_parameter" >&6; }
+if test "x$cflags_cv_warn__Wunused_parameter" = xyes; then :
+  as_fn_append WARNING_CFLAGS " -Wunused-parameter"
+fi
 
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether compiler handles -Wwrite-strings" >&5
+$as_echo_n "checking whether compiler handles -Wwrite-strings... " >&6; }
+if ${cflags_cv_warn__Wwrite_strings+:} false; then :
+  $as_echo_n "(cached) " >&6
 else
 
-      { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
+  save_CFLAGS="$CFLAGS"
+  CFLAGS="${CFLAGS} -Wwrite-strings"
+  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+
+int
+main ()
+{
 
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_compile "$LINENO"; then :
+  cflags_cv_warn__Wwrite_strings=yes
+else
+  cflags_cv_warn__Wwrite_strings=no
 fi
 rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-  fi
+  CFLAGS="$save_CFLAGS"
+
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cflags_cv_warn__Wwrite_strings" >&5
+$as_echo "$cflags_cv_warn__Wwrite_strings" >&6; }
+if test "x$cflags_cv_warn__Wwrite_strings" = xyes; then :
+  as_fn_append WARNING_CFLAGS " -Wwrite-strings"
+fi
 
-	CFLAGS="$CFLAGS -g -Wall -Werror"
 else
 	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
 $as_echo "no" >&6; }
-	CFLAGS="$CFLAGS -Wall"
 fi
 
 # Enable or disable use of git version in pacman version string
@@ -20355,7 +17631,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_GIT="$ac_prog"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -20426,6 +17702,11 @@
 
 # Set root directory
 
+
+cat >>confdefs.h <<_ACEOF
+#define ROOTDIR "$ROOTDIR"
+_ACEOF
+
 # Set package file extension
 
 
@@ -20447,9 +17728,16 @@
 #define BUILDSCRIPT "$BUILDSCRIPT"
 _ACEOF
 
+# Set shell used by install scriptlets
+
+
+cat >>confdefs.h <<_ACEOF
+#define SCRIPTLET_SHELL "$SCRIPTLET_SHELL"
+_ACEOF
+
 
 # Configuration files
-ac_config_files="$ac_config_files lib/libalpm/Makefile lib/libalpm/po/Makefile.in src/pacman/Makefile src/pacman/po/Makefile.in src/util/Makefile scripts/Makefile scripts/po/Makefile.in doc/Makefile etc/Makefile test/pacman/Makefile test/pacman/tests/Makefile test/util/Makefile contrib/Makefile Makefile"
+ac_config_files="$ac_config_files lib/libalpm/Makefile lib/libalpm/po/Makefile.in lib/libalpm/libalpm.pc src/pacman/Makefile src/pacman/po/Makefile.in src/util/Makefile scripts/Makefile scripts/po/Makefile.in doc/Makefile etc/Makefile test/pacman/Makefile test/pacman/tests/Makefile test/scripts/Makefile test/util/Makefile contrib/Makefile Makefile"
 
 cat >confcache <<\_ACEOF
 # This file is a shell script that caches the results of configure
@@ -20560,6 +17848,14 @@
 LTLIBOBJS=$ac_ltlibobjs
 
 
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking that generated files are newer than configure" >&5
+$as_echo_n "checking that generated files are newer than configure... " >&6; }
+   if test -n "$am_sleep_pid"; then
+     # Hide warnings about reused PIDs.
+     wait $am_sleep_pid 2>/dev/null
+   fi
+   { $as_echo "$as_me:${as_lineno-$LINENO}: result: done" >&5
+$as_echo "done" >&6; }
  if test -n "$EXEEXT"; then
   am__EXEEXT_TRUE=
   am__EXEEXT_FALSE='#'
@@ -20576,14 +17872,14 @@
   as_fn_error $? "conditional \"am__fastdepCC\" was never defined.
 Usually this means the macro was only invoked conditionally." "$LINENO" 5
 fi
-if test -z "${am__fastdepCXX_TRUE}" && test -z "${am__fastdepCXX_FALSE}"; then
-  as_fn_error $? "conditional \"am__fastdepCXX\" was never defined.
-Usually this means the macro was only invoked conditionally." "$LINENO" 5
-fi
 if test -z "${HAVE_LIBSSL_TRUE}" && test -z "${HAVE_LIBSSL_FALSE}"; then
   as_fn_error $? "conditional \"HAVE_LIBSSL\" was never defined.
 Usually this means the macro was only invoked conditionally." "$LINENO" 5
 fi
+if test -z "${HAVE_LIBCURL_TRUE}" && test -z "${HAVE_LIBCURL_FALSE}"; then
+  as_fn_error $? "conditional \"HAVE_LIBCURL\" was never defined.
+Usually this means the macro was only invoked conditionally." "$LINENO" 5
+fi
 if test -z "${HAVE_LIBGPGME_TRUE}" && test -z "${HAVE_LIBGPGME_FALSE}"; then
   as_fn_error $? "conditional \"HAVE_LIBGPGME\" was never defined.
 Usually this means the macro was only invoked conditionally." "$LINENO" 5
@@ -20914,16 +18210,16 @@
     # ... but there are two gotchas:
     # 1) On MSYS, both `ln -s file dir' and `ln file dir' fail.
     # 2) DJGPP < 2.04 has no symlinks; `ln -s' creates a wrapper executable.
-    # In both cases, we have to default to `cp -p'.
+    # In both cases, we have to default to `cp -pR'.
     ln -s conf$$.file conf$$.dir 2>/dev/null && test ! -f conf$$.exe ||
-      as_ln_s='cp -p'
+      as_ln_s='cp -pR'
   elif ln conf$$.file conf$$ 2>/dev/null; then
     as_ln_s=ln
   else
-    as_ln_s='cp -p'
+    as_ln_s='cp -pR'
   fi
 else
-  as_ln_s='cp -p'
+  as_ln_s='cp -pR'
 fi
 rm -f conf$$ conf$$.exe conf$$.dir/conf$$.file conf$$.file
 rmdir conf$$.dir 2>/dev/null
@@ -20983,28 +18279,16 @@
   as_mkdir_p=false
 fi
 
-if test -x / >/dev/null 2>&1; then
-  as_test_x='test -x'
-else
-  if ls -dL / >/dev/null 2>&1; then
-    as_ls_L_option=L
-  else
-    as_ls_L_option=
-  fi
-  as_test_x='
-    eval sh -c '\''
-      if test -d "$1"; then
-	test -d "$1/.";
-      else
-	case $1 in #(
-	-*)set "./$1";;
-	esac;
-	case `ls -ld'$as_ls_L_option' "$1" 2>/dev/null` in #((
-	???[sx]*):;;*)false;;esac;fi
-    '\'' sh
-  '
-fi
-as_executable_p=$as_test_x
+
+# as_fn_executable_p FILE
+# -----------------------
+# Test if FILE is an executable regular file.
+as_fn_executable_p ()
+{
+  test -f "$1" && test -x "$1"
+} # as_fn_executable_p
+as_test_x='test -x'
+as_executable_p=as_fn_executable_p
 
 # Sed expression to map a string onto a valid CPP name.
 as_tr_cpp="eval sed 'y%*$as_cr_letters%P$as_cr_LETTERS%;s%[^_$as_cr_alnum]%_%g'"
@@ -21026,7 +18310,7 @@
 # values after options handling.
 ac_log="
 This file was extended by pacman $as_me 4.0.3, which was
-generated by GNU Autoconf 2.68.  Invocation command line was
+generated by GNU Autoconf 2.69.  Invocation command line was
 
   CONFIG_FILES    = $CONFIG_FILES
   CONFIG_HEADERS  = $CONFIG_HEADERS
@@ -21092,10 +18376,10 @@
 ac_cs_config="`$as_echo "$ac_configure_args" | sed 's/^ //; s/[\\""\`\$]/\\\\&/g'`"
 ac_cs_version="\\
 pacman config.status 4.0.3
-configured by $0, generated by GNU Autoconf 2.68,
+configured by $0, generated by GNU Autoconf 2.69,
   with options \\"\$ac_cs_config\\"
 
-Copyright (C) 2010 Free Software Foundation, Inc.
+Copyright (C) 2012 Free Software Foundation, Inc.
 This config.status script is free software; the Free Software Foundation
 gives unlimited permission to copy, distribute and modify it."
 
@@ -21186,7 +18470,7 @@
 _ACEOF
 cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
 if \$ac_cs_recheck; then
-  set X '$SHELL' '$0' $ac_configure_args \$ac_configure_extra_args --no-create --no-recursion
+  set X $SHELL '$0' $ac_configure_args \$ac_configure_extra_args --no-create --no-recursion
   shift
   \$as_echo "running CONFIG_SHELL=$SHELL \$*" >&6
   CONFIG_SHELL='$SHELL'
@@ -21350,61 +18634,6 @@
 enable_dlopen_self_static='`$ECHO "$enable_dlopen_self_static" | $SED "$delay_single_quote_subst"`'
 old_striplib='`$ECHO "$old_striplib" | $SED "$delay_single_quote_subst"`'
 striplib='`$ECHO "$striplib" | $SED "$delay_single_quote_subst"`'
-compiler_lib_search_dirs='`$ECHO "$compiler_lib_search_dirs" | $SED "$delay_single_quote_subst"`'
-predep_objects='`$ECHO "$predep_objects" | $SED "$delay_single_quote_subst"`'
-postdep_objects='`$ECHO "$postdep_objects" | $SED "$delay_single_quote_subst"`'
-predeps='`$ECHO "$predeps" | $SED "$delay_single_quote_subst"`'
-postdeps='`$ECHO "$postdeps" | $SED "$delay_single_quote_subst"`'
-compiler_lib_search_path='`$ECHO "$compiler_lib_search_path" | $SED "$delay_single_quote_subst"`'
-LD_CXX='`$ECHO "$LD_CXX" | $SED "$delay_single_quote_subst"`'
-reload_flag_CXX='`$ECHO "$reload_flag_CXX" | $SED "$delay_single_quote_subst"`'
-reload_cmds_CXX='`$ECHO "$reload_cmds_CXX" | $SED "$delay_single_quote_subst"`'
-old_archive_cmds_CXX='`$ECHO "$old_archive_cmds_CXX" | $SED "$delay_single_quote_subst"`'
-compiler_CXX='`$ECHO "$compiler_CXX" | $SED "$delay_single_quote_subst"`'
-GCC_CXX='`$ECHO "$GCC_CXX" | $SED "$delay_single_quote_subst"`'
-lt_prog_compiler_no_builtin_flag_CXX='`$ECHO "$lt_prog_compiler_no_builtin_flag_CXX" | $SED "$delay_single_quote_subst"`'
-lt_prog_compiler_pic_CXX='`$ECHO "$lt_prog_compiler_pic_CXX" | $SED "$delay_single_quote_subst"`'
-lt_prog_compiler_wl_CXX='`$ECHO "$lt_prog_compiler_wl_CXX" | $SED "$delay_single_quote_subst"`'
-lt_prog_compiler_static_CXX='`$ECHO "$lt_prog_compiler_static_CXX" | $SED "$delay_single_quote_subst"`'
-lt_cv_prog_compiler_c_o_CXX='`$ECHO "$lt_cv_prog_compiler_c_o_CXX" | $SED "$delay_single_quote_subst"`'
-archive_cmds_need_lc_CXX='`$ECHO "$archive_cmds_need_lc_CXX" | $SED "$delay_single_quote_subst"`'
-enable_shared_with_static_runtimes_CXX='`$ECHO "$enable_shared_with_static_runtimes_CXX" | $SED "$delay_single_quote_subst"`'
-export_dynamic_flag_spec_CXX='`$ECHO "$export_dynamic_flag_spec_CXX" | $SED "$delay_single_quote_subst"`'
-whole_archive_flag_spec_CXX='`$ECHO "$whole_archive_flag_spec_CXX" | $SED "$delay_single_quote_subst"`'
-compiler_needs_object_CXX='`$ECHO "$compiler_needs_object_CXX" | $SED "$delay_single_quote_subst"`'
-old_archive_from_new_cmds_CXX='`$ECHO "$old_archive_from_new_cmds_CXX" | $SED "$delay_single_quote_subst"`'
-old_archive_from_expsyms_cmds_CXX='`$ECHO "$old_archive_from_expsyms_cmds_CXX" | $SED "$delay_single_quote_subst"`'
-archive_cmds_CXX='`$ECHO "$archive_cmds_CXX" | $SED "$delay_single_quote_subst"`'
-archive_expsym_cmds_CXX='`$ECHO "$archive_expsym_cmds_CXX" | $SED "$delay_single_quote_subst"`'
-module_cmds_CXX='`$ECHO "$module_cmds_CXX" | $SED "$delay_single_quote_subst"`'
-module_expsym_cmds_CXX='`$ECHO "$module_expsym_cmds_CXX" | $SED "$delay_single_quote_subst"`'
-with_gnu_ld_CXX='`$ECHO "$with_gnu_ld_CXX" | $SED "$delay_single_quote_subst"`'
-allow_undefined_flag_CXX='`$ECHO "$allow_undefined_flag_CXX" | $SED "$delay_single_quote_subst"`'
-no_undefined_flag_CXX='`$ECHO "$no_undefined_flag_CXX" | $SED "$delay_single_quote_subst"`'
-hardcode_libdir_flag_spec_CXX='`$ECHO "$hardcode_libdir_flag_spec_CXX" | $SED "$delay_single_quote_subst"`'
-hardcode_libdir_flag_spec_ld_CXX='`$ECHO "$hardcode_libdir_flag_spec_ld_CXX" | $SED "$delay_single_quote_subst"`'
-hardcode_libdir_separator_CXX='`$ECHO "$hardcode_libdir_separator_CXX" | $SED "$delay_single_quote_subst"`'
-hardcode_direct_CXX='`$ECHO "$hardcode_direct_CXX" | $SED "$delay_single_quote_subst"`'
-hardcode_direct_absolute_CXX='`$ECHO "$hardcode_direct_absolute_CXX" | $SED "$delay_single_quote_subst"`'
-hardcode_minus_L_CXX='`$ECHO "$hardcode_minus_L_CXX" | $SED "$delay_single_quote_subst"`'
-hardcode_shlibpath_var_CXX='`$ECHO "$hardcode_shlibpath_var_CXX" | $SED "$delay_single_quote_subst"`'
-hardcode_automatic_CXX='`$ECHO "$hardcode_automatic_CXX" | $SED "$delay_single_quote_subst"`'
-inherit_rpath_CXX='`$ECHO "$inherit_rpath_CXX" | $SED "$delay_single_quote_subst"`'
-link_all_deplibs_CXX='`$ECHO "$link_all_deplibs_CXX" | $SED "$delay_single_quote_subst"`'
-always_export_symbols_CXX='`$ECHO "$always_export_symbols_CXX" | $SED "$delay_single_quote_subst"`'
-export_symbols_cmds_CXX='`$ECHO "$export_symbols_cmds_CXX" | $SED "$delay_single_quote_subst"`'
-exclude_expsyms_CXX='`$ECHO "$exclude_expsyms_CXX" | $SED "$delay_single_quote_subst"`'
-include_expsyms_CXX='`$ECHO "$include_expsyms_CXX" | $SED "$delay_single_quote_subst"`'
-prelink_cmds_CXX='`$ECHO "$prelink_cmds_CXX" | $SED "$delay_single_quote_subst"`'
-postlink_cmds_CXX='`$ECHO "$postlink_cmds_CXX" | $SED "$delay_single_quote_subst"`'
-file_list_spec_CXX='`$ECHO "$file_list_spec_CXX" | $SED "$delay_single_quote_subst"`'
-hardcode_action_CXX='`$ECHO "$hardcode_action_CXX" | $SED "$delay_single_quote_subst"`'
-compiler_lib_search_dirs_CXX='`$ECHO "$compiler_lib_search_dirs_CXX" | $SED "$delay_single_quote_subst"`'
-predep_objects_CXX='`$ECHO "$predep_objects_CXX" | $SED "$delay_single_quote_subst"`'
-postdep_objects_CXX='`$ECHO "$postdep_objects_CXX" | $SED "$delay_single_quote_subst"`'
-predeps_CXX='`$ECHO "$predeps_CXX" | $SED "$delay_single_quote_subst"`'
-postdeps_CXX='`$ECHO "$postdeps_CXX" | $SED "$delay_single_quote_subst"`'
-compiler_lib_search_path_CXX='`$ECHO "$compiler_lib_search_path_CXX" | $SED "$delay_single_quote_subst"`'
 
 LTCC='$LTCC'
 LTCFLAGS='$LTCFLAGS'
@@ -21483,39 +18712,7 @@
 install_override_mode \
 finish_eval \
 old_striplib \
-striplib \
-compiler_lib_search_dirs \
-predep_objects \
-postdep_objects \
-predeps \
-postdeps \
-compiler_lib_search_path \
-LD_CXX \
-reload_flag_CXX \
-compiler_CXX \
-lt_prog_compiler_no_builtin_flag_CXX \
-lt_prog_compiler_pic_CXX \
-lt_prog_compiler_wl_CXX \
-lt_prog_compiler_static_CXX \
-lt_cv_prog_compiler_c_o_CXX \
-export_dynamic_flag_spec_CXX \
-whole_archive_flag_spec_CXX \
-compiler_needs_object_CXX \
-with_gnu_ld_CXX \
-allow_undefined_flag_CXX \
-no_undefined_flag_CXX \
-hardcode_libdir_flag_spec_CXX \
-hardcode_libdir_flag_spec_ld_CXX \
-hardcode_libdir_separator_CXX \
-exclude_expsyms_CXX \
-include_expsyms_CXX \
-file_list_spec_CXX \
-compiler_lib_search_dirs_CXX \
-predep_objects_CXX \
-postdep_objects_CXX \
-predeps_CXX \
-postdeps_CXX \
-compiler_lib_search_path_CXX; do
+striplib; do
     case \`eval \\\\\$ECHO \\\\""\\\\\$\$var"\\\\"\` in
     *[\\\\\\\`\\"\\\$]*)
       eval "lt_\$var=\\\\\\"\\\`\\\$ECHO \\"\\\$\$var\\" | \\\$SED \\"\\\$sed_quote_subst\\"\\\`\\\\\\""
@@ -21545,18 +18742,7 @@
 postuninstall_cmds \
 finish_cmds \
 sys_lib_search_path_spec \
-sys_lib_dlsearch_path_spec \
-reload_cmds_CXX \
-old_archive_cmds_CXX \
-old_archive_from_new_cmds_CXX \
-old_archive_from_expsyms_cmds_CXX \
-archive_cmds_CXX \
-archive_expsym_cmds_CXX \
-module_cmds_CXX \
-module_expsym_cmds_CXX \
-export_symbols_cmds_CXX \
-prelink_cmds_CXX \
-postlink_cmds_CXX; do
+sys_lib_dlsearch_path_spec; do
     case \`eval \\\\\$ECHO \\\\""\\\\\$\$var"\\\\"\` in
     *[\\\\\\\`\\"\\\$]*)
       eval "lt_\$var=\\\\\\"\\\`\\\$ECHO \\"\\\$\$var\\" | \\\$SED -e \\"\\\$double_quote_subst\\" -e \\"\\\$sed_quote_subst\\" -e \\"\\\$delay_variable_subst\\"\\\`\\\\\\""
@@ -21586,8 +18772,6 @@
 
 
 
-
-
 # Capture the value of obsolete ALL_LINGUAS because we need it to compute
     # POFILES, UPDATEPOFILES, DUMMYPOFILES, GMOFILES, CATALOGS. But hide it
     # from automake < 1.5.
@@ -21610,6 +18794,7 @@
     "po-directories") CONFIG_COMMANDS="$CONFIG_COMMANDS po-directories" ;;
     "lib/libalpm/Makefile") CONFIG_FILES="$CONFIG_FILES lib/libalpm/Makefile" ;;
     "lib/libalpm/po/Makefile.in") CONFIG_FILES="$CONFIG_FILES lib/libalpm/po/Makefile.in" ;;
+    "lib/libalpm/libalpm.pc") CONFIG_FILES="$CONFIG_FILES lib/libalpm/libalpm.pc" ;;
     "src/pacman/Makefile") CONFIG_FILES="$CONFIG_FILES src/pacman/Makefile" ;;
     "src/pacman/po/Makefile.in") CONFIG_FILES="$CONFIG_FILES src/pacman/po/Makefile.in" ;;
     "src/util/Makefile") CONFIG_FILES="$CONFIG_FILES src/util/Makefile" ;;
@@ -21619,6 +18804,7 @@
     "etc/Makefile") CONFIG_FILES="$CONFIG_FILES etc/Makefile" ;;
     "test/pacman/Makefile") CONFIG_FILES="$CONFIG_FILES test/pacman/Makefile" ;;
     "test/pacman/tests/Makefile") CONFIG_FILES="$CONFIG_FILES test/pacman/tests/Makefile" ;;
+    "test/scripts/Makefile") CONFIG_FILES="$CONFIG_FILES test/scripts/Makefile" ;;
     "test/util/Makefile") CONFIG_FILES="$CONFIG_FILES test/util/Makefile" ;;
     "contrib/Makefile") CONFIG_FILES="$CONFIG_FILES contrib/Makefile" ;;
     "Makefile") CONFIG_FILES="$CONFIG_FILES Makefile" ;;
@@ -22231,7 +19417,7 @@
     # Strip MF so we end up with the name of the file.
     mf=`echo "$mf" | sed -e 's/:.*$//'`
     # Check whether this is an Automake generated Makefile or not.
-    # We used to match only the files named `Makefile.in', but
+    # We used to match only the files named 'Makefile.in', but
     # some people rename them; so instead we look at the file content.
     # Grep'ing the first line is not enough: some people post-process
     # each Makefile.in and add a new line on top of each file to say so.
@@ -22265,21 +19451,19 @@
       continue
     fi
     # Extract the definition of DEPDIR, am__include, and am__quote
-    # from the Makefile without running `make'.
+    # from the Makefile without running 'make'.
     DEPDIR=`sed -n 's/^DEPDIR = //p' < "$mf"`
     test -z "$DEPDIR" && continue
     am__include=`sed -n 's/^am__include = //p' < "$mf"`
     test -z "am__include" && continue
     am__quote=`sed -n 's/^am__quote = //p' < "$mf"`
-    # When using ansi2knr, U may be empty or an underscore; expand it
-    U=`sed -n 's/^U = //p' < "$mf"`
     # Find all dependency output files, they are included files with
     # $(DEPDIR) in their names.  We invoke sed twice because it is the
     # simplest approach to changing $(DEPDIR) to its actual value in the
     # expansion.
     for file in `sed -n "
       s/^$am__include $am__quote\(.*(DEPDIR).*\)$am__quote"'$/\1/p' <"$mf" | \
-	 sed -e 's/\$(DEPDIR)/'"$DEPDIR"'/g' -e 's/\$U/'"$U"'/g'`; do
+	 sed -e 's/\$(DEPDIR)/'"$DEPDIR"'/g'`; do
       # Make sure the directory exists.
       test -f "$dirpart/$file" && continue
       fdir=`$as_dirname -- "$file" ||
@@ -22362,7 +19546,7 @@
 
 
 # The names of the tagged configurations supported by this script.
-available_tags="CXX "
+available_tags=""
 
 # ### BEGIN LIBTOOL CONFIG
 
@@ -22750,20 +19934,6 @@
 # How to hardcode a shared library path into an executable.
 hardcode_action=$hardcode_action
 
-# The directories searched by this compiler when creating a shared library.
-compiler_lib_search_dirs=$lt_compiler_lib_search_dirs
-
-# Dependencies to place before and after the objects being linked to
-# create a shared library.
-predep_objects=$lt_predep_objects
-postdep_objects=$lt_postdep_objects
-predeps=$lt_predeps
-postdeps=$lt_postdeps
-
-# The library search path used internally by the compiler when linking
-# a shared library.
-compiler_lib_search_path=$lt_compiler_lib_search_path
-
 # ### END LIBTOOL CONFIG
 
 _LT_EOF
@@ -22956,163 +20126,6 @@
     (rm -f "$ofile" && cp "$cfgfile" "$ofile" && rm -f "$cfgfile")
   chmod +x "$ofile"
 
-
-    cat <<_LT_EOF >> "$ofile"
-
-# ### BEGIN LIBTOOL TAG CONFIG: CXX
-
-# The linker used to build libraries.
-LD=$lt_LD_CXX
-
-# How to create reloadable object files.
-reload_flag=$lt_reload_flag_CXX
-reload_cmds=$lt_reload_cmds_CXX
-
-# Commands used to build an old-style archive.
-old_archive_cmds=$lt_old_archive_cmds_CXX
-
-# A language specific compiler.
-CC=$lt_compiler_CXX
-
-# Is the compiler the GNU compiler?
-with_gcc=$GCC_CXX
-
-# Compiler flag to turn off builtin functions.
-no_builtin_flag=$lt_lt_prog_compiler_no_builtin_flag_CXX
-
-# Additional compiler flags for building library objects.
-pic_flag=$lt_lt_prog_compiler_pic_CXX
-
-# How to pass a linker flag through the compiler.
-wl=$lt_lt_prog_compiler_wl_CXX
-
-# Compiler flag to prevent dynamic linking.
-link_static_flag=$lt_lt_prog_compiler_static_CXX
-
-# Does compiler simultaneously support -c and -o options?
-compiler_c_o=$lt_lt_cv_prog_compiler_c_o_CXX
-
-# Whether or not to add -lc for building shared libraries.
-build_libtool_need_lc=$archive_cmds_need_lc_CXX
-
-# Whether or not to disallow shared libs when runtime libs are static.
-allow_libtool_libs_with_static_runtimes=$enable_shared_with_static_runtimes_CXX
-
-# Compiler flag to allow reflexive dlopens.
-export_dynamic_flag_spec=$lt_export_dynamic_flag_spec_CXX
-
-# Compiler flag to generate shared objects directly from archives.
-whole_archive_flag_spec=$lt_whole_archive_flag_spec_CXX
-
-# Whether the compiler copes with passing no objects directly.
-compiler_needs_object=$lt_compiler_needs_object_CXX
-
-# Create an old-style archive from a shared archive.
-old_archive_from_new_cmds=$lt_old_archive_from_new_cmds_CXX
-
-# Create a temporary old-style archive to link instead of a shared archive.
-old_archive_from_expsyms_cmds=$lt_old_archive_from_expsyms_cmds_CXX
-
-# Commands used to build a shared archive.
-archive_cmds=$lt_archive_cmds_CXX
-archive_expsym_cmds=$lt_archive_expsym_cmds_CXX
-
-# Commands used to build a loadable module if different from building
-# a shared archive.
-module_cmds=$lt_module_cmds_CXX
-module_expsym_cmds=$lt_module_expsym_cmds_CXX
-
-# Whether we are building with GNU ld or not.
-with_gnu_ld=$lt_with_gnu_ld_CXX
-
-# Flag that allows shared libraries with undefined symbols to be built.
-allow_undefined_flag=$lt_allow_undefined_flag_CXX
-
-# Flag that enforces no undefined symbols.
-no_undefined_flag=$lt_no_undefined_flag_CXX
-
-# Flag to hardcode \$libdir into a binary during linking.
-# This must work even if \$libdir does not exist
-hardcode_libdir_flag_spec=$lt_hardcode_libdir_flag_spec_CXX
-
-# If ld is used when linking, flag to hardcode \$libdir into a binary
-# during linking.  This must work even if \$libdir does not exist.
-hardcode_libdir_flag_spec_ld=$lt_hardcode_libdir_flag_spec_ld_CXX
-
-# Whether we need a single "-rpath" flag with a separated argument.
-hardcode_libdir_separator=$lt_hardcode_libdir_separator_CXX
-
-# Set to "yes" if using DIR/libNAME\${shared_ext} during linking hardcodes
-# DIR into the resulting binary.
-hardcode_direct=$hardcode_direct_CXX
-
-# Set to "yes" if using DIR/libNAME\${shared_ext} during linking hardcodes
-# DIR into the resulting binary and the resulting library dependency is
-# "absolute",i.e impossible to change by setting \${shlibpath_var} if the
-# library is relocated.
-hardcode_direct_absolute=$hardcode_direct_absolute_CXX
-
-# Set to "yes" if using the -LDIR flag during linking hardcodes DIR
-# into the resulting binary.
-hardcode_minus_L=$hardcode_minus_L_CXX
-
-# Set to "yes" if using SHLIBPATH_VAR=DIR during linking hardcodes DIR
-# into the resulting binary.
-hardcode_shlibpath_var=$hardcode_shlibpath_var_CXX
-
-# Set to "yes" if building a shared library automatically hardcodes DIR
-# into the library and all subsequent libraries and executables linked
-# against it.
-hardcode_automatic=$hardcode_automatic_CXX
-
-# Set to yes if linker adds runtime paths of dependent libraries
-# to runtime path list.
-inherit_rpath=$inherit_rpath_CXX
-
-# Whether libtool must link a program against all its dependency libraries.
-link_all_deplibs=$link_all_deplibs_CXX
-
-# Set to "yes" if exported symbols are required.
-always_export_symbols=$always_export_symbols_CXX
-
-# The commands to list exported symbols.
-export_symbols_cmds=$lt_export_symbols_cmds_CXX
-
-# Symbols that should not be listed in the preloaded symbols.
-exclude_expsyms=$lt_exclude_expsyms_CXX
-
-# Symbols that must always be exported.
-include_expsyms=$lt_include_expsyms_CXX
-
-# Commands necessary for linking programs (against libraries) with templates.
-prelink_cmds=$lt_prelink_cmds_CXX
-
-# Commands necessary for finishing linking programs.
-postlink_cmds=$lt_postlink_cmds_CXX
-
-# Specify filename containing input files.
-file_list_spec=$lt_file_list_spec_CXX
-
-# How to hardcode a shared library path into an executable.
-hardcode_action=$hardcode_action_CXX
-
-# The directories searched by this compiler when creating a shared library.
-compiler_lib_search_dirs=$lt_compiler_lib_search_dirs_CXX
-
-# Dependencies to place before and after the objects being linked to
-# create a shared library.
-predep_objects=$lt_predep_objects_CXX
-postdep_objects=$lt_postdep_objects_CXX
-predeps=$lt_predeps_CXX
-postdeps=$lt_postdeps_CXX
-
-# The library search path used internally by the compiler when linking
-# a shared library.
-compiler_lib_search_path=$lt_compiler_lib_search_path_CXX
-
-# ### END LIBTOOL TAG CONFIG: CXX
-_LT_EOF
-
  ;;
     "po-directories":C)
     for ac_file in $CONFIG_FILES; do
@@ -23280,13 +20293,14 @@
 
     compiler               : ${CC}
     preprocessor flags     : ${CPPFLAGS}
-    compiler flags         : ${CFLAGS}
+    compiler flags         : ${WARNING_CFLAGS} ${CFLAGS}
     defines                : ${DEFS}
-    library flags          : ${LIBS}
+    library flags          : ${LIBS} ${LIBSSL_LIBS} ${LIBARCHIVE_LIBS} ${LIBCURL_LIBS} ${GPGME_LIBS}
     linker flags           : ${LDFLAGS}
 
     Architecture           : ${CARCH}
     Host Type              : ${CHOST}
+    File inode command     : ${INODECMD}
     Filesize command       : ${SIZECMD}
     In-place sed command   : ${SEDINPLACE}
 
@@ -23302,12 +20316,14 @@
     build script name      : ${BUILDSCRIPT}
 
   Compilation options:
-    Use libcurl            : ${with_libcurl}
-    Use GPGME              : ${with_gpgme}
-    Use OpenSSL            : ${with_openssl}
+    Use libcurl            : ${have_libcurl}
+    Use GPGME              : ${have_gpgme}
+    Use OpenSSL            : ${have_openssl}
     Run make in doc/ dir   : ${wantdoc} ${asciidoc}
     Doxygen support        : ${usedoxygen}
     debug support          : ${debug}
+    extra warning flags    : ${warningflags}
+    use git version        : ${wantgitver}
 "
 
 # vim:set ts=2 sw=2 noet:
diff -x '.*' -aur pacman-4.0.3/configure.ac pacman/configure.ac
--- pacman-4.0.3/configure.ac	2012-04-07 15:51:42.000000000 +0000
+++ pacman/configure.ac	2012-10-15 18:11:52.477419551 +0000
@@ -55,13 +55,22 @@
 AC_INIT([pacman], [pacman_version], [pacman-dev@archlinux.org])
 AC_CONFIG_SRCDIR([config.h.in])
 AC_CONFIG_HEADERS([config.h])
+AC_CONFIG_MACRO_DIR([m4])
+AC_CONFIG_AUX_DIR([build-aux])
 
 AC_CANONICAL_HOST
-AM_INIT_AUTOMAKE
+AM_INIT_AUTOMAKE([1.11])
+AM_SILENT_RULES([yes])
 
+LT_INIT
 LIB_VERSION=`expr lib_current - lib_age`.lib_age.lib_revision
 LIB_VERSION_INFO="lib_current:lib_revision:lib_age"
 
+# Respect empty CFLAGS during compiler tests
+if test "x$CFLAGS" != "x"; then
+  CFLAGS=""
+fi
+
 # Set subsitution values for version stuff in Makefiles and anywhere else,
 # and put LIB_VERSION in config.h
 AC_SUBST(LIB_VERSION)
@@ -88,6 +97,12 @@
 	AS_HELP_STRING([--with-buildscript=name], [set the build script name used by makepkg]),
 	[BUILDSCRIPT=$withval], [BUILDSCRIPT=PKGBUILD])
 
+# Help line for changing shell used to run install scriptlets
+AC_ARG_WITH(scriptlet-shell,
+	AS_HELP_STRING([--with-scriptlet-shell=shell],
+		[set the full path to the shell used to run install scriptlets]),
+	[SCRIPTLET_SHELL=$withval], [SCRIPTLET_SHELL=/bin/sh])
+
 # Help line for using OpenSSL
 AC_ARG_WITH(openssl,
 	AS_HELP_STRING([--with-openssl], [use OpenSSL crypto implementations instead of internal routines]),
@@ -98,8 +113,10 @@
 	AS_HELP_STRING([--with-gpgme], [use GPGME for PGP signature verification]),
 	[], [with_gpgme=check])
 
-# Check for useable libcurl
-LIBCURL_CHECK_CONFIG([yes], [7.19.4], [with_libcurl=yes], [with_libcurl=no])
+# Help line for using libcurl
+AC_ARG_WITH(curl,
+	AS_HELP_STRING([--with-libcurl], [use libcurl for the internal downloader]),
+	[], [with_curl=check])
 
 # Help line for documentation
 AC_ARG_ENABLE(doc,
@@ -116,23 +133,43 @@
 	AS_HELP_STRING([--enable-debug], [enable debugging support]),
 	[debug=$enableval], [debug=no])
 
+# Help line for compiler warning flags
+AC_ARG_ENABLE(warningflags,
+	AS_HELP_STRING([--enable-warningflags], [enable extra compiler warning flags]),
+	[warningflags=$enableval], [warningflags=no])
+
 # Help line for using git version in pacman version string
 AC_ARG_ENABLE(git-version,
 	AS_HELP_STRING([--enable-git-version],
 		[enable use of git version in version string if available]),
 	[wantgitver=$enableval], [wantgitver=no])
 
+# Enable large file support if available (must be enabled before
+# testing compilation against gpgme).
+AC_SYS_LARGEFILE
+
 # Checks for programs.
 AC_PROG_AWK
 AC_PROG_CC_C99
-AC_PROG_CXX
 AC_PROG_INSTALL
-AC_PROG_LN_S
-AC_PROG_MAKE_SET
-AC_PROG_LIBTOOL
-AC_PROG_RANLIB
 AC_CHECK_PROGS([PYTHON], [python2.7 python2.6 python2.5 python2 python], [false])
-AC_PATH_PROGS([BASH_SHELL], [bash bash4 bash3], [false])
+AC_PATH_PROGS([BASH_SHELL], [bash bash4], [false])
+
+AS_IF([test "x$BASH_SHELL" = "xfalse"],
+	AC_MSG_WARN([*** bash >= 4.1.0 is required for pacman scripts]),
+	[bash_version_major=`$BASH_SHELL -c 'echo "${BASH_VERSINFO[[0]]}"'`
+	bash_version_minor=`$BASH_SHELL -c 'echo "${BASH_VERSINFO[[1]]}"'`
+	ok=yes
+	if test "$bash_version_major" -lt 4; then
+		ok=no
+	fi
+	if test "$bash_version_major" -eq 4 && test "$bash_version_minor" -lt 1; then
+		ok=no
+	fi
+	if test "$ok" = "no"; then
+		AC_MSG_ERROR([*** bash >= 4.1.0 is required for pacman scripts])
+	fi
+	unset bash_version_major bash_version_minor ok])
 
 # find installed gettext
 AM_GNU_GETTEXT([external], [need-ngettext])
@@ -142,34 +179,72 @@
 	AC_MSG_ERROR([libm is needed to compile pacman!]))
 
 # Check for libarchive
-AC_CHECK_LIB([archive], [archive_read_data], ,
-	AC_MSG_ERROR([libarchive is needed to compile pacman!]))
+PKG_CHECK_MODULES(LIBARCHIVE, [libarchive >= 2.8.0], ,
+	AC_MSG_ERROR([*** libarchive >= 2.8.0 is needed to compile pacman!]))
 
 # Check for OpenSSL
-AC_MSG_CHECKING(whether to link with libssl)
-AS_IF([test "x$with_openssl" != "xno"],
-	[AC_MSG_RESULT(yes)
-	AC_CHECK_LIB([ssl], [MD5_Final], ,
-	[if test "x$with_openssl" != "xcheck"; then
-		AC_MSG_FAILURE([--with-openssl was given, but -lssl was not found])
-	fi],
-	[-lcrypto])
-	with_openssl=$ac_cv_lib_ssl_MD5_Final],
-	AC_MSG_RESULT(no))
-AM_CONDITIONAL([HAVE_LIBSSL], [test "x$with_openssl" = "xyes"])
+have_openssl=no
+if test "x$with_openssl" != "xno"; then
+	PKG_CHECK_MODULES(LIBSSL, [libcrypto],
+		[AC_DEFINE(HAVE_LIBSSL, 1, [Define if libcrypto is available]) have_openssl=yes], have_openssl=no)
+	if test "x$have_openssl" = xno -a "x$with_openssl" = xyes; then
+		AC_MSG_ERROR([*** openssl support requested but libraries not found])
+	fi
+fi
+AM_CONDITIONAL(HAVE_LIBSSL, [test "$have_openssl" = "yes"])
+
+# Check for libcurl
+have_libcurl=no
+if test "x$with_libcurl" != "xno"; then
+	PKG_CHECK_MODULES(LIBCURL, [libcurl >= 7.19.4],
+		[AC_DEFINE(HAVE_LIBCURL, 1, [Define if libcurl is available]) have_libcurl=yes], have_libcurl=no)
+	if test "x$have_libcurl" = xno -a "x$with_libcurl" = xyes; then
+		AC_MSG_ERROR([*** libcurl >= 7.19.4 is required for internal downloader support])
+	fi
+fi
+AM_CONDITIONAL(HAVE_LIBCURL, [test "$have_libcurl" = "yes"])
 
 # Check for gpgme
 AC_MSG_CHECKING(whether to link with libgpgme)
 AS_IF([test "x$with_gpgme" != "xno"],
-	[AC_MSG_RESULT(yes)
-	AC_CHECK_LIB([gpgme], [gpgme_check_version], ,
-	[if test "x$with_gpgme" != "xcheck"; then
-		AC_MSG_FAILURE([--with-ggpme was given, but -lgpgme was not found])
-	fi],
-	[-lgpgme])
-	with_gpgme=$ac_cv_lib_gpgme_gpgme_check_version],
-	AC_MSG_RESULT(no))
-AM_CONDITIONAL([HAVE_LIBGPGME], [test "x$with_gpgme" = "xyes"])
+	[AC_MSG_RESULT([yes])],
+	[AC_MSG_RESULT([no])])
+
+have_gpgme=no
+AS_IF([test "x$with_gpgme" != "xno"],
+	[AM_PATH_GPGME([1.3.0],
+		[LIBS_save="$LIBS"
+		CPPFLAGS_save="$CPPFLAGS"
+		CFLAGS_save="$CFLAGS"
+
+		LIBS="$LIBS $GPGME_LIBS"
+		CPPFLAGS="$CPPFLAGS $GPGME_CPPFLAGS"
+		CFLAGS="$CFLAGS $GPGME_CFLAGS"
+
+		AC_MSG_CHECKING([for sane gpgme])
+		AC_LINK_IFELSE(
+			[AC_LANG_PROGRAM(
+				[[#include <gpgme.h>]],
+				[[return gpgme_check_version("1.3.0");]])],
+			[AC_MSG_RESULT([yes])
+			have_gpgme=yes
+			AC_DEFINE([HAVE_LIBGPGME], [1], [Define if gpgme should be used to provide GPG signature support.])],
+			[AC_MSG_RESULT([no])
+			have_gpgme=no
+			unset GPGME_LIBS
+			unset GPGME_CFLAGS]
+			AS_IF([test "x$with_gpgme" = "xyes"],
+				[AC_MSG_FAILURE([*** gpgme >= 1.3.0 is needed for GPG signature support])])
+			)],
+		[with_gpgme=no])]
+		[LIBS="$LIBS_save"
+		CPPFLAGS="$CPPFLAGS_save"
+		CFLAGS="$CFLAGS_save"
+		unset CPPFLAGS_save
+		unset CFLAGS_save])
+AS_IF([test "x$have_gpgme" = xno -a "x$with_gpgme" = xyes],
+	[AC_MSG_FAILURE([--with-gpgme was given, but gpgme was not found])])
+AM_CONDITIONAL([HAVE_LIBGPGME], [test "x$have_gpgme" = "xyes"])
 
 # Checks for header files.
 AC_CHECK_HEADERS([fcntl.h float.h glob.h libintl.h limits.h locale.h \
@@ -203,6 +278,7 @@
                 mkdir realpath regcomp rmdir setenv setlocale strcasecmp \
                 strchr strcspn strdup strerror strndup strrchr strsep strstr \
                 strtol swprintf tcflush wcwidth uname])
+AC_CHECK_MEMBERS([struct stat.st_blksize],,,[[#include <sys/stat.h>]])
 
 # For the diskspace code
 FS_STATS_TYPE
@@ -210,15 +286,13 @@
 AC_CHECK_MEMBERS([struct statfs.f_flags],,,[[#include <sys/param.h>
                   #include <sys/mount.h>]])
 
-# Enable large file support if available
-AC_SYS_LARGEFILE
-
 # Check if we can use symbol visibility support in GCC
 GCC_VISIBILITY_CC
 # Check if we have -fgnu89-inline flag
 GCC_GNU89_INLINE_CC
 
 # Host-dependant definitions
+INODECMD="stat -c '%i %n'"
 SIZECMD="stat -c %s"
 SEDINPLACE="sed -i"
 STRIP_BINARIES="--strip-all"
@@ -226,15 +300,17 @@
 STRIP_STATIC="--strip-debug"
 case "${host_os}" in
 	*bsd*)
+		INODECMD="stat -f '%i %n'"
 		SIZECMD="stat -f %z"
 		SEDINPLACE="sed -i \"\""
 		;;
 	cygwin*)
 		host_os_cygwin=yes
-		CFLAGS="$CFLAGS -DCYGWIN"
+		AC_DEFINE([CYGWIN], [1], [Define if host OS is cygwin])
 		;;
 	darwin*)
 		host_os_darwin=yes
+		INODECMD="/usr/bin/stat -f '%i %n'"
 		SIZECMD="/usr/bin/stat -f %z"
 		SEDINPLACE="/usr/bin/sed -i ''"
 		STRIP_BINARIES=""
@@ -246,6 +322,7 @@
 AM_CONDITIONAL([CYGWIN], test "x$host_os_cygwin" = "xyes")
 AM_CONDITIONAL([DARWIN], test "x$host_os_darwin" = "xyes")
 AC_PATH_PROGS([DUPATH], [du], [du], [/usr/bin$PATH_SEPARATOR/bin] )
+AC_SUBST(INODECMD)
 AC_SUBST(SIZECMD)
 AC_SUBST(SEDINPLACE)
 AC_SUBST(STRIP_BINARIES)
@@ -297,16 +374,49 @@
 if test "x$debug" = "xyes" ; then
 	AC_MSG_RESULT(yes)
 	AC_DEFINE([PACMAN_DEBUG], , [Enable debug code])
-	# Check for mcheck
-	AC_CHECK_HEADERS([mcheck.h])
 	# Check for -fstack-protector availability
 	GCC_STACK_PROTECT_LIB
 	GCC_STACK_PROTECT_CC
 	GCC_FORTIFY_SOURCE_CC
-	CFLAGS="$CFLAGS -g -Wall -Werror"
+	WARNING_CFLAGS="-g -Wall -Werror"
+else
+	AC_MSG_RESULT(no)
+	WARNING_CFLAGS="-Wall"
+fi
+
+# Enable or disable compiler warning flags
+AC_MSG_CHECKING(for excessive compiler warning flags)
+if test "x$warningflags" = "xyes" ; then
+	AC_MSG_RESULT(yes)
+	CFLAGS_ADD([-Wcast-align], [WARNING_CFLAGS])
+	CFLAGS_ADD([-Wclobbered], [WARNING_CFLAGS])
+	CFLAGS_ADD([-Wempty-body], [WARNING_CFLAGS])
+	CFLAGS_ADD([-Wfloat-equal], [WARNING_CFLAGS])
+	CFLAGS_ADD([-Wformat-nonliteral], [WARNING_CFLAGS])
+	CFLAGS_ADD([-Wformat-security], [WARNING_CFLAGS])
+	CFLAGS_ADD([-Wignored-qualifiers], [WARNING_CFLAGS])
+	CFLAGS_ADD([-Winit-self], [WARNING_CFLAGS])
+	CFLAGS_ADD([-Wlogical-op], [WARNING_CFLAGS])
+	CFLAGS_ADD([-Wmissing-declarations], [WARNING_CFLAGS])
+	CFLAGS_ADD([-Wmissing-field-initializers], [WARNING_CFLAGS])
+	CFLAGS_ADD([-Wmissing-parameter-type], [WARNING_CFLAGS])
+	CFLAGS_ADD([-Wmissing-prototypes], [WARNING_CFLAGS])
+	CFLAGS_ADD([-Wold-style-declaration], [WARNING_CFLAGS])
+	CFLAGS_ADD([-Woverride-init], [WARNING_CFLAGS])
+	CFLAGS_ADD([-Wpointer-arith], [WARNING_CFLAGS])
+	CFLAGS_ADD([-Wredundant-decls], [WARNING_CFLAGS])
+	CFLAGS_ADD([-Wshadow], [WARNING_CFLAGS])
+	CFLAGS_ADD([-Wsign-compare], [WARNING_CFLAGS])
+	CFLAGS_ADD([-Wstrict-aliasing], [WARNING_CFLAGS])
+	CFLAGS_ADD([-Wstrict-overflow=5], [WARNING_CFLAGS])
+	CFLAGS_ADD([-Wstrict-prototypes], [WARNING_CFLAGS])
+	CFLAGS_ADD([-Wtype-limits], [WARNING_CFLAGS])
+	CFLAGS_ADD([-Wuninitialized], [WARNING_CFLAGS])
+	CFLAGS_ADD([-Wunused-but-set-parameter], [WARNING_CFLAGS])
+	CFLAGS_ADD([-Wunused-parameter], [WARNING_CFLAGS])
+	CFLAGS_ADD([-Wwrite-strings], [WARNING_CFLAGS])
 else
 	AC_MSG_RESULT(no)
-	CFLAGS="$CFLAGS -Wall"
 fi
 
 # Enable or disable use of git version in pacman version string
@@ -330,6 +440,7 @@
 
 # Set root directory
 AC_SUBST(ROOTDIR)
+AC_DEFINE_UNQUOTED([ROOTDIR], "$ROOTDIR", [The location of the root operating directory])
 # Set package file extension
 AC_SUBST(PKGEXT)
 AC_DEFINE_UNQUOTED([PKGEXT], "$PKGEXT", [The file extension used by pacman packages])
@@ -339,11 +450,15 @@
 # Set makepkg build script name
 AC_SUBST(BUILDSCRIPT)
 AC_DEFINE_UNQUOTED([BUILDSCRIPT], "$BUILDSCRIPT", [The build script name used by makepkg])
+# Set shell used by install scriptlets
+AC_SUBST(SCRIPTLET_SHELL)
+AC_DEFINE_UNQUOTED([SCRIPTLET_SHELL], "$SCRIPTLET_SHELL", [The full path of the shell used to run install scriptlets])
 
 # Configuration files
 AC_CONFIG_FILES([
 lib/libalpm/Makefile
 lib/libalpm/po/Makefile.in
+lib/libalpm/libalpm.pc
 src/pacman/Makefile
 src/pacman/po/Makefile.in
 src/util/Makefile
@@ -353,6 +468,7 @@
 etc/Makefile
 test/pacman/Makefile
 test/pacman/tests/Makefile
+test/scripts/Makefile
 test/util/Makefile
 contrib/Makefile
 Makefile
@@ -373,13 +489,14 @@
 
     compiler               : ${CC}
     preprocessor flags     : ${CPPFLAGS}
-    compiler flags         : ${CFLAGS}
+    compiler flags         : ${WARNING_CFLAGS} ${CFLAGS}
     defines                : ${DEFS}
-    library flags          : ${LIBS}
+    library flags          : ${LIBS} ${LIBSSL_LIBS} ${LIBARCHIVE_LIBS} ${LIBCURL_LIBS} ${GPGME_LIBS}
     linker flags           : ${LDFLAGS}
 
     Architecture           : ${CARCH}
     Host Type              : ${CHOST}
+    File inode command     : ${INODECMD}
     Filesize command       : ${SIZECMD}
     In-place sed command   : ${SEDINPLACE}
 
@@ -395,12 +512,14 @@
     build script name      : ${BUILDSCRIPT}
 
   Compilation options:
-    Use libcurl            : ${with_libcurl}
-    Use GPGME              : ${with_gpgme}
-    Use OpenSSL            : ${with_openssl}
+    Use libcurl            : ${have_libcurl}
+    Use GPGME              : ${have_gpgme}
+    Use OpenSSL            : ${have_openssl}
     Run make in doc/ dir   : ${wantdoc} ${asciidoc}
     Doxygen support        : ${usedoxygen}
     debug support          : ${debug}
+    extra warning flags    : ${warningflags}
+    use git version        : ${wantgitver}
 "
 
 # vim:set ts=2 sw=2 noet:
diff -x '.*' -aur pacman-4.0.3/contrib/Makefile.am pacman/contrib/Makefile.am
--- pacman-4.0.3/contrib/Makefile.am	2011-12-13 16:11:01.000000000 +0000
+++ pacman/contrib/Makefile.am	2012-10-15 18:11:52.477419551 +0000
@@ -1,12 +1,26 @@
-OURSCRIPTS = \
+# enforce that all scripts have a --help and --version option
+AUTOMAKE_OPTIONS = std-options
+
+bin_SCRIPTS = \
+  $(OURSCRIPTS)
+
+BASHSCRIPTS = \
 	bacman \
 	paccache \
 	pacdiff \
 	paclist \
 	paclog-pkglist \
 	pacscripts \
-	pacsearch \
-	pacsysclean
+	pacsysclean \
+	rankmirrors \
+	updpkgsums
+
+OTHERSCRIPTS = \
+	pacsearch
+
+OURSCRIPTS = \
+	$(BASHSCRIPTS) \
+	$(OTHERSCRIPTS)
 
 OURFILES = \
 	bash_completion \
@@ -14,15 +28,17 @@
 
 EXTRA_DIST = \
 	PKGBUILD.vim \
-	bacman.in \
+	bacman.sh.in \
 	bash_completion.in \
-	paccache.in \
-	paclog-pkglist.in \
-	pacdiff.in \
-	paclist.in \
-	pacscripts.in \
+	paccache.sh.in \
+	paclog-pkglist.sh.in \
+	pacdiff.sh.in \
+	paclist.sh.in \
+	pacscripts.sh.in \
 	pacsearch.in \
-	pacsysclean.in \
+	pacsysclean.sh.in \
+	rankmirrors.sh.in
+	updpkgsums.sh.in \
 	vimprojects \
 	zsh_completion.in \
 	README
@@ -30,39 +46,62 @@
 # Files that should be removed, but which Automake does not know.
 MOSTLYCLEANFILES = $(OURSCRIPTS) $(OURFILES) *.tmp
 
+if USE_GIT_VERSION
+GIT_VERSION := $(shell sh -c 'git describe --abbrev=4 --dirty | sed s/^v//')
+REAL_PACKAGE_VERSION = $(GIT_VERSION)
+else
+REAL_PACKAGE_VERSION = $(PACKAGE_VERSION)
+endif
+
 edit = sed \
 	-e 's|@sysconfdir[@]|$(sysconfdir)|g' \
 	-e 's|@localstatedir[@]|$(localstatedir)|g' \
+	-e 's|@PACKAGE_VERSION[@]|$(REAL_PACKAGE_VERSION)|g' \
 	-e 's|@SIZECMD[@]|$(SIZECMD)|g' \
+	-e 's|@SCRIPTNAME[@]|$@|g' \
 	-e '1s|!/bin/bash|!$(BASH_SHELL)|g'
 
-$(OURSCRIPTS): Makefile
-	@echo '    ' GEN $@;
-	@$(RM) $@ $@.tmp
-	@$(edit) $(srcdir)/$@.in >$@.tmp
-	@chmod +x $@.tmp
-	@chmod a-w $@.tmp
-	@mv $@.tmp $@
+$(OTHERSCRIPTS): Makefile
+	$(AM_V_at)$(RM) $@ $@.tmp
+	$(AM_V_GEN)$(edit) $(srcdir)/$@.in >$@.tmp
+	$(AM_V_at)chmod +x,a-w $@.tmp
+	$(AM_V_at)mv $@.tmp $@
+
+$(BASHSCRIPTS): Makefile
+	$(AM_V_at)$(RM) $@
+	$(AM_V_GEN)test -f $(srcdir)/$@.sh.in && m4 -P -I $(srcdir) $(srcdir)/$@.sh.in | $(edit) >$@
+	$(AM_V_at)chmod +x,a-w $@
+	@$(BASH_SHELL) -O extglob -n $@
 
 $(OURFILES): Makefile
-	@echo '    ' GEN $@;
-	@$(RM) $@ $@.tmp
-	@$(edit) $(srcdir)/$@.in >$@.tmp
-	@chmod a-w $@.tmp
-	@mv $@.tmp $@
+	$(AM_V_at)$(RM) $@ $@.tmp
+	$(AM_V_GEN)$(edit) $(srcdir)/$@.in >$@.tmp
+	$(AM_V_at)chmod a-w $@.tmp
+	$(AM_V_at)mv $@.tmp $@
 
 all-am: $(OURSCRIPTS) $(OURFILES)
 
-bacman: $(srcdir)/bacman.in
+install-data-local:
+	$(MKDIR_P) $(DESTDIR)$(sysconfdir)/bash_completion.d/
+	$(INSTALL_DATA) bash_completion $(DESTDIR)$(sysconfdir)/bash_completion.d/pacman
+	$(MKDIR_P) $(DESTDIR)$(datarootdir)/zsh/site-functions/
+	$(INSTALL_DATA) zsh_completion $(DESTDIR)$(datarootdir)/zsh/site-functions/_pacman
+
+uninstall-local:
+	$(RM) $(DESTDIR)$(sysconfdir)/bash_completion.d/pacman
+	$(RM) $(DESTDIR)$(datarootdir)/zsh/site-functions/_pacman
+
+bacman: $(srcdir)/bacman.sh.in
 bash_completion: $(srcdir)/bash_completion.in
-paccache: $(srcdir)/paccache.in
-pacdiff: $(srcdir)/pacdiff.in
-paclist: $(srcdir)/paclist.in
-paclog-pkglist: $(srcdir)/paclog-pkglist.in
-pacscripts: $(srcdir)/pacscripts.in
+paccache: $(srcdir)/paccache.sh.in $(top_srcdir)/scripts/library/parseopts.sh $(top_srcdir)/scripts/library/size_to_human.sh
+pacdiff: $(srcdir)/pacdiff.sh.in
+paclist: $(srcdir)/paclist.sh.in
+paclog-pkglist: $(srcdir)/paclog-pkglist.sh.in
+pacscripts: $(srcdir)/pacscripts.sh.in
 pacsearch: $(srcdir)/pacsearch.in
-pacsysclean: $(srcdir)/pacsysclean.in
-pactree: $(srcdir)/pactree.in
+pacsysclean: $(srcdir)/pacsysclean.sh.in
+rankmirrors: $(srcdir)/rankmirrors.sh.in
+updpkgsums: $(srcdir)/updpkgsums.sh.in
 zsh_completion: $(srcdir)/zsh_completion.in
 
 # vim:set ts=2 sw=2 noet:
diff -x '.*' -aur pacman-4.0.3/contrib/Makefile.in pacman/contrib/Makefile.in
--- pacman-4.0.3/contrib/Makefile.in	2012-04-07 15:58:13.000000000 +0000
+++ pacman/contrib/Makefile.in	2012-10-15 18:12:22.489542067 +0000
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.11.4 from Makefile.am.
+# Makefile.in generated by automake 1.12 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -14,6 +14,7 @@
 # PARTICULAR PURPOSE.
 
 @SET_MAKE@
+
 VPATH = @srcdir@
 am__make_dryrun = \
   { \
@@ -51,23 +52,60 @@
 build_triplet = @build@
 host_triplet = @host@
 subdir = contrib
-DIST_COMMON = README $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+DIST_COMMON = README $(srcdir)/Makefile.am $(srcdir)/Makefile.in \
+	$(top_srcdir)/build-aux/mkinstalldirs
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/m4/gettext.m4 \
+am__aclocal_m4_deps = $(top_srcdir)/m4/acinclude.m4 \
+	$(top_srcdir)/m4/gettext.m4 $(top_srcdir)/m4/gpgme.m4 \
 	$(top_srcdir)/m4/iconv.m4 $(top_srcdir)/m4/intlmacosx.m4 \
 	$(top_srcdir)/m4/lib-ld.m4 $(top_srcdir)/m4/lib-link.m4 \
-	$(top_srcdir)/m4/lib-prefix.m4 $(top_srcdir)/m4/libcurl.m4 \
-	$(top_srcdir)/m4/libtool.m4 $(top_srcdir)/m4/ltoptions.m4 \
-	$(top_srcdir)/m4/ltsugar.m4 $(top_srcdir)/m4/ltversion.m4 \
-	$(top_srcdir)/m4/lt~obsolete.m4 $(top_srcdir)/m4/nls.m4 \
+	$(top_srcdir)/m4/lib-prefix.m4 $(top_srcdir)/m4/libtool.m4 \
+	$(top_srcdir)/m4/ltoptions.m4 $(top_srcdir)/m4/ltsugar.m4 \
+	$(top_srcdir)/m4/ltversion.m4 $(top_srcdir)/m4/lt~obsolete.m4 \
+	$(top_srcdir)/m4/nls.m4 $(top_srcdir)/m4/pkg.m4 \
 	$(top_srcdir)/m4/po.m4 $(top_srcdir)/m4/progtest.m4 \
-	$(top_srcdir)/acinclude.m4 $(top_srcdir)/configure.ac
+	$(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
-mkinstalldirs = $(SHELL) $(top_srcdir)/mkinstalldirs
+mkinstalldirs = $(SHELL) $(top_srcdir)/build-aux/mkinstalldirs
 CONFIG_HEADER = $(top_builddir)/config.h
 CONFIG_CLEAN_FILES =
 CONFIG_CLEAN_VPATH_FILES =
+am__vpath_adj_setup = srcdirstrip=`echo "$(srcdir)" | sed 's|.|.|g'`;
+am__vpath_adj = case $$p in \
+    $(srcdir)/*) f=`echo "$$p" | sed "s|^$$srcdirstrip/||"`;; \
+    *) f=$$p;; \
+  esac;
+am__strip_dir = f=`echo $$p | sed -e 's|^.*/||'`;
+am__install_max = 40
+am__nobase_strip_setup = \
+  srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*|]/\\\\&/g'`
+am__nobase_strip = \
+  for p in $$list; do echo "$$p"; done | sed -e "s|$$srcdirstrip/||"
+am__nobase_list = $(am__nobase_strip_setup); \
+  for p in $$list; do echo "$$p $$p"; done | \
+  sed "s| $$srcdirstrip/| |;"' / .*\//!s/ .*/ ./; s,\( .*\)/[^/]*$$,\1,' | \
+  $(AWK) 'BEGIN { files["."] = "" } { files[$$2] = files[$$2] " " $$1; \
+    if (++n[$$2] == $(am__install_max)) \
+      { print $$2, files[$$2]; n[$$2] = 0; files[$$2] = "" } } \
+    END { for (dir in files) print dir, files[dir] }'
+am__base_list = \
+  sed '$$!N;$$!N;$$!N;$$!N;$$!N;$$!N;$$!N;s/\n/ /g' | \
+  sed '$$!N;$$!N;$$!N;$$!N;s/\n/ /g'
+am__uninstall_files_from_dir = { \
+  test -z "$$files" \
+    || { test ! -d "$$dir" && test ! -f "$$dir" && test ! -r "$$dir"; } \
+    || { echo " ( cd '$$dir' && rm -f" $$files ")"; \
+         $(am__cd) "$$dir" && rm -f $$files; }; \
+  }
+am__installdirs = "$(DESTDIR)$(bindir)"
+SCRIPTS = $(bin_SCRIPTS)
+AM_V_GEN = $(am__v_GEN_@AM_V@)
+am__v_GEN_ = $(am__v_GEN_@AM_DEFAULT_V@)
+am__v_GEN_0 = @echo "  GEN     " $@;
+AM_V_at = $(am__v_at_@AM_V@)
+am__v_at_ = $(am__v_at_@AM_DEFAULT_V@)
+am__v_at_0 = @
 SOURCES =
 DIST_SOURCES =
 am__can_run_installinfo = \
@@ -78,6 +116,7 @@
 DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
 ACLOCAL = @ACLOCAL@
 AMTAR = @AMTAR@
+AM_DEFAULT_VERBOSITY = @AM_DEFAULT_VERBOSITY@
 AR = @AR@
 ASCIIDOC = @ASCIIDOC@
 AUTOCONF = @AUTOCONF@
@@ -93,10 +132,6 @@
 CHOST = @CHOST@
 CPP = @CPP@
 CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXCPP = @CXXCPP@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
 CYGPATH_W = @CYGPATH_W@
 DEFS = @DEFS@
 DEPDIR = @DEPDIR@
@@ -115,7 +150,11 @@
 GIT = @GIT@
 GMSGFMT = @GMSGFMT@
 GMSGFMT_015 = @GMSGFMT_015@
+GPGME_CFLAGS = @GPGME_CFLAGS@
+GPGME_CONFIG = @GPGME_CONFIG@
+GPGME_LIBS = @GPGME_LIBS@
 GREP = @GREP@
+INODECMD = @INODECMD@
 INSTALL = @INSTALL@
 INSTALL_DATA = @INSTALL_DATA@
 INSTALL_PROGRAM = @INSTALL_PROGRAM@
@@ -125,12 +164,16 @@
 INTL_MACOSX_LIBS = @INTL_MACOSX_LIBS@
 LD = @LD@
 LDFLAGS = @LDFLAGS@
-LIBCURL = @LIBCURL@
-LIBCURL_CPPFLAGS = @LIBCURL_CPPFLAGS@
+LIBARCHIVE_CFLAGS = @LIBARCHIVE_CFLAGS@
+LIBARCHIVE_LIBS = @LIBARCHIVE_LIBS@
+LIBCURL_CFLAGS = @LIBCURL_CFLAGS@
+LIBCURL_LIBS = @LIBCURL_LIBS@
 LIBICONV = @LIBICONV@
 LIBINTL = @LIBINTL@
 LIBOBJS = @LIBOBJS@
 LIBS = @LIBS@
+LIBSSL_CFLAGS = @LIBSSL_CFLAGS@
+LIBSSL_LIBS = @LIBSSL_LIBS@
 LIBTOOL = @LIBTOOL@
 LIB_VERSION = @LIB_VERSION@
 LIB_VERSION_INFO = @LIB_VERSION_INFO@
@@ -160,10 +203,14 @@
 PACKAGE_VERSION = @PACKAGE_VERSION@
 PATH_SEPARATOR = @PATH_SEPARATOR@
 PKGEXT = @PKGEXT@
+PKG_CONFIG = @PKG_CONFIG@
+PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
+PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 POSUB = @POSUB@
 PYTHON = @PYTHON@
 RANLIB = @RANLIB@
 ROOTDIR = @ROOTDIR@
+SCRIPTLET_SHELL = @SCRIPTLET_SHELL@
 SED = @SED@
 SEDINPLACE = @SEDINPLACE@
 SET_MAKE = @SET_MAKE@
@@ -176,17 +223,16 @@
 STRIP_STATIC = @STRIP_STATIC@
 USE_NLS = @USE_NLS@
 VERSION = @VERSION@
+WARNING_CFLAGS = @WARNING_CFLAGS@
 XGETTEXT = @XGETTEXT@
 XGETTEXT_015 = @XGETTEXT_015@
 XGETTEXT_EXTRA_OPTIONS = @XGETTEXT_EXTRA_OPTIONS@
-_libcurl_config = @_libcurl_config@
 abs_builddir = @abs_builddir@
 abs_srcdir = @abs_srcdir@
 abs_top_builddir = @abs_top_builddir@
 abs_top_srcdir = @abs_top_srcdir@
 ac_ct_AR = @ac_ct_AR@
 ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
 ac_ct_DUMPBIN = @ac_ct_DUMPBIN@
 am__include = @am__include@
 am__leading_dot = @am__leading_dot@
@@ -233,15 +279,29 @@
 top_build_prefix = @top_build_prefix@
 top_builddir = @top_builddir@
 top_srcdir = @top_srcdir@
-OURSCRIPTS = \
+
+# enforce that all scripts have a --help and --version option
+AUTOMAKE_OPTIONS = std-options
+bin_SCRIPTS = \
+  $(OURSCRIPTS)
+
+BASHSCRIPTS = \
 	bacman \
 	paccache \
 	pacdiff \
 	paclist \
 	paclog-pkglist \
 	pacscripts \
-	pacsearch \
-	pacsysclean
+	pacsysclean \
+	rankmirrors \
+	updpkgsums
+
+OTHERSCRIPTS = \
+	pacsearch
+
+OURSCRIPTS = \
+	$(BASHSCRIPTS) \
+	$(OTHERSCRIPTS)
 
 OURFILES = \
 	bash_completion \
@@ -249,26 +309,29 @@
 
 EXTRA_DIST = \
 	PKGBUILD.vim \
-	bacman.in \
+	bacman.sh.in \
 	bash_completion.in \
-	paccache.in \
-	paclog-pkglist.in \
-	pacdiff.in \
-	paclist.in \
-	pacscripts.in \
+	paccache.sh.in \
+	paclog-pkglist.sh.in \
+	pacdiff.sh.in \
+	paclist.sh.in \
+	pacscripts.sh.in \
 	pacsearch.in \
-	pacsysclean.in \
-	vimprojects \
-	zsh_completion.in \
-	README
+	pacsysclean.sh.in \
+	rankmirrors.sh.in
 
 
 # Files that should be removed, but which Automake does not know.
 MOSTLYCLEANFILES = $(OURSCRIPTS) $(OURFILES) *.tmp
+@USE_GIT_VERSION_TRUE@GIT_VERSION := $(shell sh -c 'git describe --abbrev=4 --dirty | sed s/^v//')
+@USE_GIT_VERSION_FALSE@REAL_PACKAGE_VERSION = $(PACKAGE_VERSION)
+@USE_GIT_VERSION_TRUE@REAL_PACKAGE_VERSION = $(GIT_VERSION)
 edit = sed \
 	-e 's|@sysconfdir[@]|$(sysconfdir)|g' \
 	-e 's|@localstatedir[@]|$(localstatedir)|g' \
+	-e 's|@PACKAGE_VERSION[@]|$(REAL_PACKAGE_VERSION)|g' \
 	-e 's|@SIZECMD[@]|$(SIZECMD)|g' \
+	-e 's|@SCRIPTNAME[@]|$@|g' \
 	-e '1s|!/bin/bash|!$(BASH_SHELL)|g'
 
 all: all-am
@@ -304,6 +367,56 @@
 $(ACLOCAL_M4):  $(am__aclocal_m4_deps)
 	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
 $(am__aclocal_m4_deps):
+install-binSCRIPTS: $(bin_SCRIPTS)
+	@$(NORMAL_INSTALL)
+	@list='$(bin_SCRIPTS)'; test -n "$(bindir)" || list=; \
+	if test -n "$$list"; then \
+	  echo " $(MKDIR_P) '$(DESTDIR)$(bindir)'"; \
+	  $(MKDIR_P) "$(DESTDIR)$(bindir)" || exit 1; \
+	fi; \
+	for p in $$list; do \
+	  if test -f "$$p"; then d=; else d="$(srcdir)/"; fi; \
+	  if test -f "$$d$$p"; then echo "$$d$$p"; echo "$$p"; else :; fi; \
+	done | \
+	sed -e 'p;s,.*/,,;n' \
+	    -e 'h;s|.*|.|' \
+	    -e 'p;x;s,.*/,,;$(transform)' | sed 'N;N;N;s,\n, ,g' | \
+	$(AWK) 'BEGIN { files["."] = ""; dirs["."] = 1; } \
+	  { d=$$3; if (dirs[d] != 1) { print "d", d; dirs[d] = 1 } \
+	    if ($$2 == $$4) { files[d] = files[d] " " $$1; \
+	      if (++n[d] == $(am__install_max)) { \
+		print "f", d, files[d]; n[d] = 0; files[d] = "" } } \
+	    else { print "f", d "/" $$4, $$1 } } \
+	  END { for (d in files) print "f", d, files[d] }' | \
+	while read type dir files; do \
+	     if test "$$dir" = .; then dir=; else dir=/$$dir; fi; \
+	     test -z "$$files" || { \
+	       echo " $(INSTALL_SCRIPT) $$files '$(DESTDIR)$(bindir)$$dir'"; \
+	       $(INSTALL_SCRIPT) $$files "$(DESTDIR)$(bindir)$$dir" || exit $$?; \
+	     } \
+	; done
+
+uninstall-binSCRIPTS:
+	@$(NORMAL_UNINSTALL)
+	@list='$(bin_SCRIPTS)'; test -n "$(bindir)" || exit 0; \
+	files=`for p in $$list; do echo "$$p"; done | \
+	       sed -e 's,.*/,,;$(transform)'`; \
+	dir='$(DESTDIR)$(bindir)'; $(am__uninstall_files_from_dir)
+
+installcheck-binSCRIPTS: $(bin_SCRIPTS)
+	bad=0; pid=$$$$; list="$(bin_SCRIPTS)"; for p in $$list; do \
+	  case ' $(AM_INSTALLCHECK_STD_OPTIONS_EXEMPT) ' in \
+	   *" $$p "* | *" $(srcdir)/$$p "*) continue;; \
+	  esac; \
+	  f=`echo "$$p" | sed 's,^.*/,,;$(transform)'`; \
+	  for opt in --help --version; do \
+	    if "$(DESTDIR)$(bindir)/$$f" $$opt >c$${pid}_.out \
+	         2>c$${pid}_.err </dev/null \
+		 && test -n "`cat c$${pid}_.out`" \
+		 && test -z "`cat c$${pid}_.err`"; then :; \
+	    else echo "$$f does not support $$opt" 1>&2; bad=1; fi; \
+	  done; \
+	done; rm -f c$${pid}_.???; exit $$bad
 
 mostlyclean-libtool:
 	-rm -f *.lo
@@ -316,6 +429,8 @@
 ctags: CTAGS
 CTAGS:
 
+cscope cscopelist:
+
 
 distdir: $(DISTFILES)
 	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
@@ -349,8 +464,11 @@
 	done
 check-am: all-am
 check: check-am
-all-am: Makefile
+all-am: Makefile $(SCRIPTS)
 installdirs:
+	for dir in "$(DESTDIR)$(bindir)"; do \
+	  test -z "$$dir" || $(MKDIR_P) "$$dir"; \
+	done
 install: install-am
 install-exec: install-exec-am
 install-data: install-data-am
@@ -402,13 +520,13 @@
 
 info-am:
 
-install-data-am:
+install-data-am: install-data-local
 
 install-dvi: install-dvi-am
 
 install-dvi-am:
 
-install-exec-am:
+install-exec-am: install-binSCRIPTS
 
 install-html: install-html-am
 
@@ -428,7 +546,7 @@
 
 install-ps-am:
 
-installcheck-am:
+installcheck-am: installcheck-binSCRIPTS
 
 maintainer-clean: maintainer-clean-am
 	-rm -f Makefile
@@ -446,49 +564,69 @@
 
 ps-am:
 
-uninstall-am:
+uninstall-am: uninstall-binSCRIPTS uninstall-local
 
 .MAKE: install-am install-strip
 
 .PHONY: all all-am check check-am clean clean-generic clean-libtool \
 	distclean distclean-generic distclean-libtool distdir dvi \
 	dvi-am html html-am info info-am install install-am \
-	install-data install-data-am install-dvi install-dvi-am \
-	install-exec install-exec-am install-html install-html-am \
-	install-info install-info-am install-man install-pdf \
-	install-pdf-am install-ps install-ps-am install-strip \
-	installcheck installcheck-am installdirs maintainer-clean \
-	maintainer-clean-generic mostlyclean mostlyclean-generic \
-	mostlyclean-libtool pdf pdf-am ps ps-am uninstall uninstall-am
-
-
-$(OURSCRIPTS): Makefile
-	@echo '    ' GEN $@;
-	@$(RM) $@ $@.tmp
-	@$(edit) $(srcdir)/$@.in >$@.tmp
-	@chmod +x $@.tmp
-	@chmod a-w $@.tmp
-	@mv $@.tmp $@
+	install-binSCRIPTS install-data install-data-am \
+	install-data-local install-dvi install-dvi-am install-exec \
+	install-exec-am install-html install-html-am install-info \
+	install-info-am install-man install-pdf install-pdf-am \
+	install-ps install-ps-am install-strip installcheck \
+	installcheck-am installcheck-binSCRIPTS installdirs \
+	maintainer-clean maintainer-clean-generic mostlyclean \
+	mostlyclean-generic mostlyclean-libtool pdf pdf-am ps ps-am \
+	uninstall uninstall-am uninstall-binSCRIPTS uninstall-local
+
+	updpkgsums.sh.in \
+	vimprojects \
+	zsh_completion.in \
+	README
+
+$(OTHERSCRIPTS): Makefile
+	$(AM_V_at)$(RM) $@ $@.tmp
+	$(AM_V_GEN)$(edit) $(srcdir)/$@.in >$@.tmp
+	$(AM_V_at)chmod +x,a-w $@.tmp
+	$(AM_V_at)mv $@.tmp $@
+
+$(BASHSCRIPTS): Makefile
+	$(AM_V_at)$(RM) $@
+	$(AM_V_GEN)test -f $(srcdir)/$@.sh.in && m4 -P -I $(srcdir) $(srcdir)/$@.sh.in | $(edit) >$@
+	$(AM_V_at)chmod +x,a-w $@
+	@$(BASH_SHELL) -O extglob -n $@
 
 $(OURFILES): Makefile
-	@echo '    ' GEN $@;
-	@$(RM) $@ $@.tmp
-	@$(edit) $(srcdir)/$@.in >$@.tmp
-	@chmod a-w $@.tmp
-	@mv $@.tmp $@
+	$(AM_V_at)$(RM) $@ $@.tmp
+	$(AM_V_GEN)$(edit) $(srcdir)/$@.in >$@.tmp
+	$(AM_V_at)chmod a-w $@.tmp
+	$(AM_V_at)mv $@.tmp $@
 
 all-am: $(OURSCRIPTS) $(OURFILES)
 
-bacman: $(srcdir)/bacman.in
+install-data-local:
+	$(MKDIR_P) $(DESTDIR)$(sysconfdir)/bash_completion.d/
+	$(INSTALL_DATA) bash_completion $(DESTDIR)$(sysconfdir)/bash_completion.d/pacman
+	$(MKDIR_P) $(DESTDIR)$(datarootdir)/zsh/site-functions/
+	$(INSTALL_DATA) zsh_completion $(DESTDIR)$(datarootdir)/zsh/site-functions/_pacman
+
+uninstall-local:
+	$(RM) $(DESTDIR)$(sysconfdir)/bash_completion.d/pacman
+	$(RM) $(DESTDIR)$(datarootdir)/zsh/site-functions/_pacman
+
+bacman: $(srcdir)/bacman.sh.in
 bash_completion: $(srcdir)/bash_completion.in
-paccache: $(srcdir)/paccache.in
-pacdiff: $(srcdir)/pacdiff.in
-paclist: $(srcdir)/paclist.in
-paclog-pkglist: $(srcdir)/paclog-pkglist.in
-pacscripts: $(srcdir)/pacscripts.in
+paccache: $(srcdir)/paccache.sh.in $(top_srcdir)/scripts/library/parseopts.sh $(top_srcdir)/scripts/library/size_to_human.sh
+pacdiff: $(srcdir)/pacdiff.sh.in
+paclist: $(srcdir)/paclist.sh.in
+paclog-pkglist: $(srcdir)/paclog-pkglist.sh.in
+pacscripts: $(srcdir)/pacscripts.sh.in
 pacsearch: $(srcdir)/pacsearch.in
-pacsysclean: $(srcdir)/pacsysclean.in
-pactree: $(srcdir)/pactree.in
+pacsysclean: $(srcdir)/pacsysclean.sh.in
+rankmirrors: $(srcdir)/rankmirrors.sh.in
+updpkgsums: $(srcdir)/updpkgsums.sh.in
 zsh_completion: $(srcdir)/zsh_completion.in
 
 # vim:set ts=2 sw=2 noet:
diff -x '.*' -aur pacman-4.0.3/contrib/PKGBUILD.vim pacman/contrib/PKGBUILD.vim
--- pacman-4.0.3/contrib/PKGBUILD.vim	2011-10-12 19:04:25.000000000 +0000
+++ pacman/contrib/PKGBUILD.vim	2012-10-15 18:11:52.477419551 +0000
@@ -69,8 +69,8 @@
 " license
 syn keyword pb_k_license license contained
 " echo $(pacman -Ql licenses | grep '/usr/share/licenses/common/' | cut -d'/' -f6 | sort -u)
-syn keyword pbLicense  APACHE CCPL CDDL CPL EPL FDL FDL1.2 FDL1.3 GPL GPL2 GPL3 LGPL LGPL2.1 LGPL3 LPPL MPL PerlArtistic PHP PSF RALINK RUBY ZPL contained
-" special cases from http://wiki.archlinux.org/index.php/Arch_Packaging_Standards
+syn keyword pbLicense  AGPL AGPL3 Apache APACHE Artistic2.0 CCPL CDDL CPL EPL FDL FDL1.2 FDL1.3 GPL GPL2 GPL3 LGPL LGPL2.1 LGPL3 LPPL MPL PerlArtistic PHP PSF RUBY W3C ZPL contained
+" special cases from https://wiki.archlinux.org/index.php/Arch_Packaging_Standards
 syn keyword pbLicenseSpecial  BSD MIT ZLIB Python contained
 syn match pbLicenseCustom /custom\(:[[:alnum:]]*\)*/ contained
 syn match pbIllegalLicense /[^='"() ]/ contained contains=pbLicenseCustom,pbLicenseSpecial,pbLicense
@@ -108,7 +108,7 @@
 syn region pbOptdependsGroup start=/^optdepends=(/ end=/)/ contains=pb_k_optdepends,pbValidOptdepends,shDoubleQuote,shSingleQuote
 
 " checkdepends
-syn keyword pb_k_ckdepends ckdepends contained
+syn keyword pb_k_ckdepends checkdepends contained
 syn match pbValidCkdepends /\([[:alnum:]]\|+\|-\|_\)*/ contained
 syn region pbCkdependsGroup start=/^checkdepends=(/ end=/)/ contains=pb_k_ckdepends,pbValidCkdepends,shDoubleQuote,shSingleQuote
 
@@ -176,12 +176,45 @@
 hi def link pbSha1Hash Error
 hi def link pbValidSha1sums  Number
 
+" sha256sums
+syn keyword pb_k_sha256sums sha256sums contained
+syn match pbIllegalSha256sums /[^='"()\/ ]/ contained contains=pbValidSha256sums
+syn match pbValidSha256sums /\x\{64\}/ contained
+syn region pbSha256sumsGroup start=/^sha256sums/ end=/)/ contains=pb_k_sha256sums,pbSha256Quotes,pbSha256Hash,pbIllegalSha256sums keepend
+syn match pbSha256Quotes /'.*'\|".*"/ contained contains=pbSha256Hash,pbIllegalSha256sums
+syn match pbSha256Hash /\x\+/ contained contains=pbValidSha256sums
+hi def link pbSha256Quotes Keyword
+hi def link pbSha256Hash Error
+hi def link pbValidSha256sums  Number
+
+" sha384sums
+syn keyword pb_k_sha384sums sha384sums contained
+syn match pbIllegalSha384sums /[^='"()\/ ]/ contained contains=pbValidSha384sums
+syn match pbValidSha384sums /\x\{96\}/ contained
+syn region pbSha384sumsGroup start=/^sha384sums/ end=/)/ contains=pb_k_sha384sums,pbSha384Quotes,pbSha384Hash,pbIllegalSha384sums keepend
+syn match pbSha384Quotes /'.*'\|".*"/ contained contains=pbSha384Hash,pbIllegalSha384sums
+syn match pbSha384Hash /\x\+/ contained contains=pbValidSha384sums
+hi def link pbSha384Quotes Keyword
+hi def link pbSha384Hash Error
+hi def link pbValidSha384sums  Number
+
+" sha512sums
+syn keyword pb_k_sha512sums sha512sums contained
+syn match pbIllegalSha512sums /[^='"()\/ ]/ contained contains=pbValidSha512sums
+syn match pbValidSha512sums /\x\{128\}/ contained
+syn region pbSha512sumsGroup start=/^sha512sums/ end=/)/ contains=pb_k_sha512sums,pbSha512Quotes,pbSha512Hash,pbIllegalSha512sums keepend
+syn match pbSha512Quotes /'.*'\|".*"/ contained contains=pbSha512Hash,pbIllegalSha512sums
+syn match pbSha512Hash /\x\+/ contained contains=pbValidSha512sums
+hi def link pbSha512Quotes Keyword
+hi def link pbSha512Hash Error
+hi def link pbValidSha512sums  Number
+
 " options
 syn keyword pb_k_options options contained
-syn match pbOptions /\(no\)\?\(strip\|docs\|libtool\|emptydirs\|zipman\|ccache\|distcc\|makeflags\|buildflags\)/ contained
+syn match pbOptions /\(no\)\?\(strip\|docs\|libtool\|emptydirs\|zipman\|purge\|upx\|fakeroot\|distcc\|color\|ccache\|check\|sign\|makeflags\|buildflags\)/ contained
 syn match   pbOptionsNeg     /\!/ contained
 syn match   pbOptionsDeprec  /no/ contained
-syn region pbOptionsGroup start=/^options=(/ end=/)/ contains=pb_k_options,pbOptions,pbOptionsNeg,pbOptionsDeprec,pbIllegalOption,shDoubleQuote,shSingleQuote
+syn region pbOptionsGroup start=/^options=(/ end=/)/ contains=pb_k_options,pbOptions,pbOptionsNeg,pbOptionsDeprec,pbIllegalOption
 syn match pbIllegalOption /[^!"'()= ]/ contained contains=pbOptionsDeprec,pbOptions
 
 " noextract
@@ -258,6 +291,15 @@
 hi def link pb_k_sha1sums pbKeywords
 hi def link pbIllegalSha1sums Error
 
+hi def link pb_k_sha256sums pbKeywords
+hi def link pbIllegalSha256sums Error
+
+hi def link pb_k_sha384sums pbKeywords
+hi def link pbIllegalSha384sums Error
+
+hi def link pb_k_sha512sums pbKeywords
+hi def link pbIllegalSha512sums Error
+
 hi def link pb_k_options pbKeywords
 hi def link pbOptionsDeprec Todo
 hi def link pbIllegalOption Error
Only in pacman-4.0.3/contrib: bacman.in
Only in pacman/contrib: bacman.sh.in
diff -x '.*' -aur pacman-4.0.3/contrib/bash_completion.in pacman/contrib/bash_completion.in
--- pacman-4.0.3/contrib/bash_completion.in	2012-01-19 22:28:04.000000000 +0000
+++ pacman/contrib/bash_completion.in	2012-10-15 18:11:52.477419551 +0000
@@ -27,17 +27,44 @@
   local r="\s-(-${1#* }\s|\w*${1% *})"; [[ $COMP_LINE =~ $r ]]
 }
 
+_pacman_keyids() {
+  \pacman-key --list-keys 2>/dev/null | awk '
+    $1 == "pub" {
+      # key id
+      split($2, a, "/"); print a[2]
+    }
+    $1 == "uid" {
+      # email
+      if (match($NF, /<[^>]+>/))
+        print substr($NF, RSTART + 1, RLENGTH - 2)
+    }'
+}
+
 _pacman_key() {
-  local cur opts prev
+  local o cur opts prev wantfiles
   COMPREPLY=()
   _get_comp_words_by_ref cur prev
-  if [[ $cur = -* &&
-      $prev != -@(a|-add|c|-config|g|-gpgdir|h|-help|import?(-trustdb)) ]]; then
-    opts=('add delete export finger help list-keys recv-keys updatedb verify version
-           config edit-key gpgdir import import-trustdb init keyserver list-sigs
-           lsign-key populate refresh-keys'
-          'a d e f h l r u v V')
+  opts=('add delete export finger help list-keys recv-keys updatedb verify
+         version config edit-key gpgdir import import-trustdb init keyserver
+         list-sigs lsign-key populate refresh-keys'
+        'a d e f h l r u v V')
+
+  # operations for which we want to complete keyids
+  for o in 'd delete' 'e export' 'f finger' 'l list-keys' 'r recv-keys' \
+      'edit-key' 'list-sigs' 'refresh-keys'; do
+    _arch_incomp "$o" && break
+    unset o
+  done
+
+  # options for which we want file completion
+  wantfiles='-@(c|-config|g|-gpgdir)'
+
+  if [[ $prev = 'pacman-key' || ( $cur = -* && $prev != $wantfiles ) ]]; then
     _arch_ptr2comp opts
+  elif [[ $prev = @(-k|--keyserver) ]]; then
+    return
+  elif [[ $prev != $wantfiles && $o ]]; then
+    COMPREPLY=($(compgen -W '$(_pacman_keyids)' -- "$cur"))
   fi
   true
 }
@@ -47,9 +74,9 @@
   COMPREPLY=()
   _get_comp_words_by_ref cur prev
   if [[ $cur = -* && ! $prev =~ ^-(-(config|help)$|\w*[Chp]) ]]; then
-    opts=('allsource asroot check clean config force geninteg help holdver ignorearch
-           install log nobuild nocheck nocolor noconfirm nodeps noextract noprogressbar
-           nosign pkg repackage rmdeps sign skipinteg source syncdeps'
+    opts=('allsource asdeps asroot check clean config force geninteg help holdver ignorearch
+           install log nobuild nocheck nocolor noconfirm nodeps noextract
+           noprogressbar nosign pkg repackage rmdeps sign skipinteg source syncdeps'
           'A L R S c d e f g h i m o p r s')
     _arch_ptr2comp opts
   fi
@@ -76,8 +103,8 @@
   remove=('cascade dbonly nodeps nosave print recursive unneeded' 'c n p s u')
   sync=('asdeps asexplicit clean dbonly downloadonly force groups ignore ignoregroup
          info list needed nodeps print refresh recursive search sysupgrade'
-        'c f g i l p s u w y')
-  upgrade=('asdeps asexplicit force needed nodeps print recursive' 'f p')
+        'c g i l p s u w y')
+  upgrade=('asdeps asexplicit force needed nodeps print recursive' 'p')
   common=('arch cachedir config dbpath debug help logfile noconfirm
            noprogressbar noscriptlet quiet root verbose' 'b d h q r v')
   core=('database help query remove sync upgrade version' 'D Q R S U V h')
@@ -111,18 +138,11 @@
   true
 }
 
-if [[ $(type -t compopt) = "builtin" ]]; then
-  _pacman_file() {
-    compopt -o filenames; _filedir 'pkg.tar*'
-  }
-  complete -F _pacman -o default pacman
-else
-  _pacman_file() {
-    _filedir 'pkg.tar*'
-  }
-  complete -F _pacman -o filenames -o default pacman
-fi
+_pacman_file() {
+  compopt -o filenames; _filedir 'pkg.tar*'
+}
 
+complete -F _pacman -o default pacman
 complete -F _makepkg -o default makepkg
 complete -F _pacman_key -o default pacman-key
 
Only in pacman-4.0.3/contrib: paccache.in
Only in pacman/contrib: paccache.sh.in
Only in pacman-4.0.3/contrib: pacdiff.in
Only in pacman/contrib: pacdiff.sh.in
Only in pacman-4.0.3/contrib: paclist.in
Only in pacman/contrib: paclist.sh.in
Only in pacman-4.0.3/contrib: paclog-pkglist.in
Only in pacman/contrib: paclog-pkglist.sh.in
Only in pacman-4.0.3/contrib: pacscripts.in
Only in pacman/contrib: pacscripts.sh.in
diff -x '.*' -aur pacman-4.0.3/contrib/pacsearch.in pacman/contrib/pacsearch.in
--- pacman-4.0.3/contrib/pacsearch.in	2011-10-12 19:04:25.000000000 +0000
+++ pacman/contrib/pacsearch.in	2012-10-15 18:11:52.477419551 +0000
@@ -24,22 +24,32 @@
 use strict;
 use warnings;
 
-my $progname = "pacsearch";
-my $version = "2.0";
+my $myname = 'pacsearch';
+my $myver = '@PACKAGE_VERSION@';
+
+sub usage {
+	print "$myname - Add color and install information to a pacman -Ss search\n";
+	print "Usage:   $myname <pattern>\n";
+	print "Example: $myname ^gnome\n";
+}
+
+sub version {
+	printf "%s %s\n", $myname, $myver;
+	print "Copyright (C) 2008-2011 Dan McGee <dan\@archlinux.org>\n\n";
+	print "Based off original shell script version:\n";
+	print "Copyright (C) 2006-2007 Dan McGee <dan\@archlinux.org>\n";
+}
 
 if ($#ARGV lt 0 || $ARGV[0] eq "--help" || $ARGV[0] eq "-h") {
-	print "$progname - Add color and install information to a pacman -Ss search\n";
-	print "Usage:   $progname <pattern>\n";
-	print "Example: $progname ^gnome\n";
+	usage;
 	if ($#ARGV lt 0) {
 		exit 1;
 	}
 	exit 0;
 }
 
-if ($ARGV[0] eq "--version" || $ARGV[0] eq "-v") {
-	print "$progname version $version\n";
-	print "Copyright (C) 2006-2011 Dan McGee\n";
+if ($ARGV[0] eq "--version" || $ARGV[0] eq "-V") {
+	version;
 	exit 0;
 }
 
Only in pacman-4.0.3/contrib: pacsysclean.in
Only in pacman/contrib: pacsysclean.sh.in
Only in pacman/contrib: rankmirrors.sh.in
Only in pacman/contrib: updpkgsums.sh.in
diff -x '.*' -aur pacman-4.0.3/contrib/zsh_completion.in pacman/contrib/zsh_completion.in
--- pacman-4.0.3/contrib/zsh_completion.in	2012-01-19 22:28:04.000000000 +0000
+++ pacman/contrib/zsh_completion.in	2012-10-15 18:11:52.477419551 +0000
@@ -1,4 +1,4 @@
-#compdef pacman pacman.static=pacman
+#compdef pacman pacman.static=pacman pacman-key makepkg
 
 # copy this file to /usr/share/zsh/site-functions/_pacman
 
@@ -32,8 +32,8 @@
 # options for passing to _arguments: options for --upgrade commands
 _pacman_opts_pkgfile=(
 	'-d[Skip dependency checks]'
-	'-f[Overwrite conflicting files]'
 	'--dbonly[Only remove database entry, do not remove files]'
+	'--force[Overwrite conflicting files]'
 	'--needed[Do not reinstall up to date packages]'
 	'--recursive[Reinstall all dependencies of target packages]'
 	'*:package file:_files -g "*.pkg.tar*(.)"'
@@ -85,7 +85,6 @@
 # options for passing to _arguments: options for --sync command
 _pacman_opts_sync_modifiers=(
 	'-d[Skip dependency checks]'
-	'-f[Overwrite conflicting files]'
 	'-i[View package information]'
 	'-l[List all packages in a repository]'
 	'-p[Print download URIs for each package to be installed]'
@@ -98,6 +97,7 @@
 		_pacman_completions_all_groups'
 	'--asdeps[Install packages as non-explicitly installed]'
 	'--asexplicit[Install packages as explicitly installed]'
+	'--force[Overwrite conflicting files]'
 )
 
 # handles --help subcommand
@@ -286,7 +286,7 @@
 }
 
 # main dispatcher
-_pacman() {
+_pacman_zsh_comp() {
 	case $words[2] in
 		-Q*g*) # ipkg groups
 			_arguments -s : \
@@ -332,5 +332,204 @@
 	esac
 }
 
-# run the main dispatcher
-_pacman "$@"
+_key_shortopts=(
+    '-h[show help]' \
+    '-a[Add the specified keys (empty for stdin)]: :_files'
+    '-d[Remove the Specified keyids]:*: :_keys'
+    '-e[Export the specified or all keyids]:*: :_keys'
+    '-f[List fingreprint for specidied or all keyids]:*: :_keys'
+    '-l[List the specified or all keys]:*: :_keys'
+    '-r[Fetch the specified keyids]:*: :_keys'
+    '-u[Update the trustdb of pacman]'
+    '-v[Verify the file specified by the signature]: :_files -g "*.sig"'
+    '-V[Show program version]'
+    )
+
+_key_longopts=(
+    '--help[show help]'
+    '--add[Add the specified keys (empty for stdin)]: :_files'
+    '--delete[Remove the Specified keyids]:*: :_keys'
+    '--export[Export the specified or all keyids]:*: :_keys'
+    '--finger[List fingreprint for specidied or all keyids]:*: :_keys'
+    '--list-keys[List the specified or all keys]:*: :_keys'
+    '--recv-keys[Fetch the specified keyids]:*: :_keys'
+    '--updatedb[Update the trustdb of pacman]'
+    '--verify[Verify the file specified by the signature]: :_files -g "*.sig"'
+    '--version[Show program version]'
+    '--edit-key[Present a menu for key management task on keyids]:*: :_keys'
+    '--import[Imports pubring.gpg from dir(s)]: :_files -g "*.gpg"'
+    '--import-tb[Imports ownertrust values from trustdb.gpg in dir(s)]: :_files -g "*.gpg"'
+    '--init[Ensure the keyring is properly initialized]'
+    '--list-sigs[List keys and their signatures]:*: :_keys'
+    '--lsign-key[Locally sign the specified keyid]:*: :_keys'
+    '--populate[Reload the default keys from the (given) keyrings in '/usr/share/pacman/keyrings']: :_path_files -W /usr/share/pacman/keyrings'
+    '--refresh-keys[Update specified or all keys from a keyserver]:*: :_keys'
+    )
+
+_pacman_key_options=(
+  '--config[Use an alternate config file (instead of /etc/pacman.con)]: :_files'
+  '--gpgdir[Set an alternate directory for GnuPG (instead of /etc/pacman.d/gnupg)]: :_files -/'
+  '--keyserver[Specify a keyserver to use if necessary]'
+  )
+
+_pacman_key() {
+  case $words[CURRENT] in
+    --*)
+      _arguments -s : \
+        "$_pacman_key_options[@]" \
+        "$_key_longopts[@]"
+      ;;
+    -*)
+      _arguments -s : \
+        "$_pacman_key_options[@]" \
+        "$_key_shortopts[@]" \
+        "$_key_longopts[@]"
+      ;;
+    *)
+      i=$#;
+      while [[ $words[$i] != -* ]] && [[ $words[$i] != "pacman-key" ]];do
+        i=$(($i-1))
+      done
+      case $i in
+        --*)
+        _arguments -s : \
+          "$_pacman_key_options[@]" \
+          "$_key_longopts[@]"
+        ;;
+      -*)
+        _arguments -s : \
+          "$_pacman_key_options[@]" \
+          "$_key_shortopts[@]" \
+          "$_key_longopts[@]"
+        ;;
+      *) return 1;;
+    esac
+    ;;
+  esac
+}
+
+_keys() {
+  local keylist keys
+  keylist=$(pacman-key --list-keys 2>/dev/null | awk '
+      $1 == "pub" {
+        # key id
+        split($2, a, "/"); print a[2]
+      }
+      $1 == "uid" {
+        # email
+        if (match($NF, /<[^>]+>/))
+          print substr($NF, RSTART + 1, RLENGTH - 2)
+      #this adds support for names as well if that is ever added
+        }
+      $1 == "uid" {
+      for (i=2;i<NF;i++) {printf "%s%s",sep, $i;sep=" "}; printf "\n"
+      }' |sed -e 's/(.*)//g' -e 's/^\ //g' -e 's/\ *$//g' |uniq
+        )
+        keys=(${(s:/:)${keylist//$'\n'/\/}})
+  _describe -t modules 'keys in keyring' keys && return 0
+}
+
+_makepkg_shortopts=(
+    '*-s[Install missing dependencies with pacman]'
+    '*-i[Install package after successful build]'
+    '*-A[Ignore incomplete arch field in PKGBUILD]'
+    '*-c[Clean up work files after build]'
+    '*-d[Skip all dependency checks]'
+    '*-e[Do not extract source files (use existing src/ dir)]'
+    '*-f[Overwrite existing package]'
+    '*-g[Generate integrity checks for source files]'
+    '*-h[Show help message and exit]'
+    '*-L[Log package build process]'
+    '*-m[Disable colorized output messages]'
+    '*-o[Download and extract files only]'
+    '-p[Use an alternate build script (instead of 'PKGBUILD')]: :_files'
+    '*-r[Remove installed dependencies after a successful build]'
+    '*-R[Repackage contents of the package without rebuilding]'
+    '*-S[Generate a source-only tarball without downloading sources]'
+    )
+
+_makepkg_action_none(){
+  _arguments \
+		"$_makepkg_shortopts[@]"\
+    "$_makepkg_longopts[@]"
+}
+_makepkg_longopts=(
+  '--ignorearch[Ignore incomplete arch field in PKGBUILD]'
+  '--clean[Clean up work files after build]'
+  '--nodeps[Skip all dependency checks]'
+  '--noextract[Do not extract source files (use existing src/ dir)]'
+  '--force[Overwrite existing package]'
+  '--geninteg[Generate integrity checks for source files]'
+  '--help[Show help message and exit]'
+  '--install[Install package after successful build]'
+  '--log[Log package build process]'
+  '--nocolor[Disable colorized output messages]'
+  '--nobuild[Download and extract files only]'
+  '--rmdeps[Remove installed dependencies after a successful build]'
+  '--repackage[Repackage contents of the package without rebuilding]'
+  '--syncdeps[Install missing dependencies with pacman]'
+  '--source[Generate a source-only tarball without downloading sources]'
+  '--allsource[Generate a source-only tarball including downloaded source]'
+  '--asroot[Allow makepkg to run as root user]'
+  '--check[Run check() function in the PKGBUILD]'
+  '--config[Use an alternate config file instead of '/etc/makepkg.conf']: :_files'
+  '--holdver[Prevent automatic version bumping for development PKGBUILDs]'
+  '--key[Specify key to use for gpg signing instead of the default]: :_keys'
+  '--nocheck[Do not run the check() function in the PKGBUILD]'
+  '--nosign[Do not create a signature for the package]'
+  '--pkg[Only build listed packages from a split package]'
+  '--sign[Sign the resulting package with gpg]'
+  '--skipchecksums[Do not verify checksums of the source files]'
+  '--skipinteg[do not perform any verification checks on source files]'
+  '--skippgpcheck[Do not verify source files with PGP signatures]'
+  '--noconfirm[do not ask for confirmation when resolving dependencies]'
+  '--asdeps[Install packages as non-explicitly installed]'
+  '--noprogressbar[Do not show a progress bar when downloading files]'
+  )
+_makepkg(){
+    case $words[CURRENT] in
+      -*)
+        _arguments -s -w : \
+          "$_makepkg_shortopts[@]" \
+          "$_makepkg_longopts[@]"
+        ;;
+      --* )
+        _arguments -s \
+          "$_makepkg_longopts[@]"
+        ;;
+      - )_makepkg_action_none ;;
+      * )
+        i=$#
+        while [[ $words[i] != -* ]] && [[ $words[$i] != "makepkg" ]];do
+          i=$((i-1));
+        done
+        case $words[$i] in
+          -*)
+            _arguments -s -w : \
+              "$_makepkg_shortopts[@]" \
+              "$_makepkg_longopts[@]"
+            ;;
+          --* )
+            _arguments -s \
+              "$_makepkg_longopts[@]"
+            ;;
+          - )_makepkg_action_none ;;
+          * ) return 1 ;;
+        esac
+      ;;
+    esac
+}
+_pacman_comp() {
+  case "$service" in
+    makepkg)
+      _makepkg "$@";;
+    pacman-key)
+      _pacman_key "$@";;
+    pacman)
+      _pacman_zsh_comp "$@";;
+    *)
+      _message "Error";;
+  esac
+}
+
+_pacman_comp "$@"
Only in pacman-4.0.3: depcomp
diff -x '.*' -aur pacman-4.0.3/doc/Makefile.am pacman/doc/Makefile.am
--- pacman-4.0.3/doc/Makefile.am	2012-01-03 01:15:47.000000000 +0000
+++ pacman/doc/Makefile.am	2012-10-15 18:11:52.477419551 +0000
@@ -10,6 +10,7 @@
 	vercmp.8 \
 	pkgdelta.8 \
 	pacman-key.8 \
+	pactree.8 \
 	PKGBUILD.5 \
 	makepkg.conf.5 \
 	pacman.conf.5 \
@@ -24,6 +25,7 @@
 	vercmp.8.html \
 	pkgdelta.8.html \
 	pacman-key.8.html \
+	pactree.8.html \
 	PKGBUILD.5.html \
 	makepkg.conf.5.html \
 	pacman.conf.5.html \
@@ -48,6 +50,7 @@
 	vercmp.8.txt \
 	pkgdelta.8.txt \
 	pacman-key.8.txt \
+	pactree.8.txt \
 	PKGBUILD.5.txt \
 	PKGBUILD-example.txt \
 	makepkg.conf.5.txt \
@@ -90,8 +93,12 @@
 
 html: $(HTML_DOCS)
 
-website: html
-	bsdtar czf website.tar.gz $(HTML_DOCS) \
+website: website.tar.gz
+
+.PHONY: html website
+
+website.tar.gz: html
+	$(AM_V_GEN)bsdtar czf $@ $(HTML_DOCS) \
 		asciidoc-override.css \
 		-C /etc/asciidoc/stylesheets/ \
 		asciidoc.css \
@@ -119,15 +126,15 @@
 
 # These rules are due to the includes and files of the asciidoc text
 $(ASCIIDOC_MANS): asciidoc.conf footer.txt Makefile.am
-	a2x $(A2X_OPTS) --asciidoc-opts="$(ASCIIDOC_OPTS) --out-file=./$@.xml" $(srcdir)/$@.txt
+	$(AM_V_GEN)a2x $(A2X_OPTS) --asciidoc-opts="$(ASCIIDOC_OPTS) --out-file=./$@.xml" $(srcdir)/$@.txt
 
 %.html: %.txt
-	asciidoc $(ASCIIDOC_OPTS) $*.txt
-	dos2unix $@
+	$(AM_V_GEN)asciidoc $(ASCIIDOC_OPTS) -o - $*.txt | \
+		sed -e 's/\r$$//' > $@
 
 HACKING.html: ../HACKING
-	asciidoc $(ASCIIDOC_OPTS) -o $@ ../HACKING
-	dos2unix $@
+	$(AM_V_GEN)asciidoc $(ASCIIDOC_OPTS) -o - ../HACKING | \
+		sed -e 's/\r$$//' > $@
 
 # Customizations for certain HTML docs
 $(HTML_MANPAGES): asciidoc.conf footer.txt Makefile.am
@@ -144,6 +151,7 @@
 vercmp.8 vercmp.8.html: vercmp.8.txt
 pkgdelta.8 pkgdelta.8.html: pkgdelta.8.txt
 pacman-key.8 pacman-key.8.html: pacman-key.8.txt
+pactree.8 pactree.8.html: pactree.8.txt
 PKGBUILD.5 PKGBUILD.5.html: PKGBUILD.5.txt PKGBUILD-example.txt
 makepkg.conf.5 makepkg.conf.5.html: makepkg.conf.5.txt
 pacman.conf.5 pacman.conf.5.html: pacman.conf.5.txt
diff -x '.*' -aur pacman-4.0.3/doc/Makefile.in pacman/doc/Makefile.in
--- pacman-4.0.3/doc/Makefile.in	2012-04-07 15:58:13.000000000 +0000
+++ pacman/doc/Makefile.in	2012-10-15 18:12:22.589289773 +0000
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.11.4 from Makefile.am.
+# Makefile.in generated by automake 1.12 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -57,23 +57,30 @@
 @USE_DOXYGEN_TRUE@am__append_1 = $(DOXYGEN_MANS)
 subdir = doc
 DIST_COMMON = $(dist_man_MANS) $(srcdir)/Makefile.am \
-	$(srcdir)/Makefile.in
+	$(srcdir)/Makefile.in $(top_srcdir)/build-aux/mkinstalldirs
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/m4/gettext.m4 \
+am__aclocal_m4_deps = $(top_srcdir)/m4/acinclude.m4 \
+	$(top_srcdir)/m4/gettext.m4 $(top_srcdir)/m4/gpgme.m4 \
 	$(top_srcdir)/m4/iconv.m4 $(top_srcdir)/m4/intlmacosx.m4 \
 	$(top_srcdir)/m4/lib-ld.m4 $(top_srcdir)/m4/lib-link.m4 \
-	$(top_srcdir)/m4/lib-prefix.m4 $(top_srcdir)/m4/libcurl.m4 \
-	$(top_srcdir)/m4/libtool.m4 $(top_srcdir)/m4/ltoptions.m4 \
-	$(top_srcdir)/m4/ltsugar.m4 $(top_srcdir)/m4/ltversion.m4 \
-	$(top_srcdir)/m4/lt~obsolete.m4 $(top_srcdir)/m4/nls.m4 \
+	$(top_srcdir)/m4/lib-prefix.m4 $(top_srcdir)/m4/libtool.m4 \
+	$(top_srcdir)/m4/ltoptions.m4 $(top_srcdir)/m4/ltsugar.m4 \
+	$(top_srcdir)/m4/ltversion.m4 $(top_srcdir)/m4/lt~obsolete.m4 \
+	$(top_srcdir)/m4/nls.m4 $(top_srcdir)/m4/pkg.m4 \
 	$(top_srcdir)/m4/po.m4 $(top_srcdir)/m4/progtest.m4 \
-	$(top_srcdir)/acinclude.m4 $(top_srcdir)/configure.ac
+	$(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
-mkinstalldirs = $(SHELL) $(top_srcdir)/mkinstalldirs
+mkinstalldirs = $(SHELL) $(top_srcdir)/build-aux/mkinstalldirs
 CONFIG_HEADER = $(top_builddir)/config.h
 CONFIG_CLEAN_FILES =
 CONFIG_CLEAN_VPATH_FILES =
+AM_V_GEN = $(am__v_GEN_@AM_V@)
+am__v_GEN_ = $(am__v_GEN_@AM_DEFAULT_V@)
+am__v_GEN_0 = @echo "  GEN     " $@;
+AM_V_at = $(am__v_at_@AM_V@)
+am__v_at_ = $(am__v_at_@AM_DEFAULT_V@)
+am__v_at_0 = @
 SOURCES =
 DIST_SOURCES =
 am__can_run_installinfo = \
@@ -119,6 +126,7 @@
 pkgdatadir = ${datadir}/${PACKAGE}
 ACLOCAL = @ACLOCAL@
 AMTAR = @AMTAR@
+AM_DEFAULT_VERBOSITY = @AM_DEFAULT_VERBOSITY@
 AR = @AR@
 ASCIIDOC = @ASCIIDOC@
 AUTOCONF = @AUTOCONF@
@@ -134,10 +142,6 @@
 CHOST = @CHOST@
 CPP = @CPP@
 CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXCPP = @CXXCPP@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
 CYGPATH_W = @CYGPATH_W@
 DEFS = @DEFS@
 DEPDIR = @DEPDIR@
@@ -156,7 +160,11 @@
 GIT = @GIT@
 GMSGFMT = @GMSGFMT@
 GMSGFMT_015 = @GMSGFMT_015@
+GPGME_CFLAGS = @GPGME_CFLAGS@
+GPGME_CONFIG = @GPGME_CONFIG@
+GPGME_LIBS = @GPGME_LIBS@
 GREP = @GREP@
+INODECMD = @INODECMD@
 INSTALL = @INSTALL@
 INSTALL_DATA = @INSTALL_DATA@
 INSTALL_PROGRAM = @INSTALL_PROGRAM@
@@ -166,12 +174,16 @@
 INTL_MACOSX_LIBS = @INTL_MACOSX_LIBS@
 LD = @LD@
 LDFLAGS = @LDFLAGS@
-LIBCURL = @LIBCURL@
-LIBCURL_CPPFLAGS = @LIBCURL_CPPFLAGS@
+LIBARCHIVE_CFLAGS = @LIBARCHIVE_CFLAGS@
+LIBARCHIVE_LIBS = @LIBARCHIVE_LIBS@
+LIBCURL_CFLAGS = @LIBCURL_CFLAGS@
+LIBCURL_LIBS = @LIBCURL_LIBS@
 LIBICONV = @LIBICONV@
 LIBINTL = @LIBINTL@
 LIBOBJS = @LIBOBJS@
 LIBS = @LIBS@
+LIBSSL_CFLAGS = @LIBSSL_CFLAGS@
+LIBSSL_LIBS = @LIBSSL_LIBS@
 LIBTOOL = @LIBTOOL@
 LIB_VERSION = @LIB_VERSION@
 LIB_VERSION_INFO = @LIB_VERSION_INFO@
@@ -201,10 +213,14 @@
 PACKAGE_VERSION = @PACKAGE_VERSION@
 PATH_SEPARATOR = @PATH_SEPARATOR@
 PKGEXT = @PKGEXT@
+PKG_CONFIG = @PKG_CONFIG@
+PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
+PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 POSUB = @POSUB@
 PYTHON = @PYTHON@
 RANLIB = @RANLIB@
 ROOTDIR = @ROOTDIR@
+SCRIPTLET_SHELL = @SCRIPTLET_SHELL@
 SED = @SED@
 SEDINPLACE = @SEDINPLACE@
 SET_MAKE = @SET_MAKE@
@@ -217,17 +233,16 @@
 STRIP_STATIC = @STRIP_STATIC@
 USE_NLS = @USE_NLS@
 VERSION = @VERSION@
+WARNING_CFLAGS = @WARNING_CFLAGS@
 XGETTEXT = @XGETTEXT@
 XGETTEXT_015 = @XGETTEXT_015@
 XGETTEXT_EXTRA_OPTIONS = @XGETTEXT_EXTRA_OPTIONS@
-_libcurl_config = @_libcurl_config@
 abs_builddir = @abs_builddir@
 abs_srcdir = @abs_srcdir@
 abs_top_builddir = @abs_top_builddir@
 abs_top_srcdir = @abs_top_srcdir@
 ac_ct_AR = @ac_ct_AR@
 ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
 ac_ct_DUMPBIN = @ac_ct_DUMPBIN@
 am__include = @am__include@
 am__leading_dot = @am__leading_dot@
@@ -281,6 +296,7 @@
 	vercmp.8 \
 	pkgdelta.8 \
 	pacman-key.8 \
+	pactree.8 \
 	PKGBUILD.5 \
 	makepkg.conf.5 \
 	pacman.conf.5 \
@@ -294,6 +310,7 @@
 	vercmp.8.html \
 	pkgdelta.8.html \
 	pacman-key.8.html \
+	pactree.8.html \
 	PKGBUILD.5.html \
 	makepkg.conf.5.html \
 	pacman.conf.5.html \
@@ -318,6 +335,7 @@
 	vercmp.8.txt \
 	pkgdelta.8.txt \
 	pacman-key.8.txt \
+	pactree.8.txt \
 	PKGBUILD.5.txt \
 	PKGBUILD-example.txt \
 	makepkg.conf.5.txt \
@@ -528,6 +546,8 @@
 ctags: CTAGS
 CTAGS:
 
+cscope cscopelist:
+
 
 distdir: $(DISTFILES)
 	@list='$(MANS)'; if test -n "$$list"; then \
@@ -536,10 +556,10 @@
 	    if test -f "$$d$$p"; then echo "$$d$$p"; else :; fi; done`; \
 	  if test -n "$$list" && \
 	    grep 'ab help2man is required to generate this page' $$list >/dev/null; then \
-	    echo "error: found man pages containing the \`missing help2man' replacement text:" >&2; \
+	    echo "error: found man pages containing the 'missing help2man' replacement text:" >&2; \
 	    grep -l 'ab help2man is required to generate this page' $$list | sed 's/^/         /' >&2; \
 	    echo "       to fix them, install help2man, remove and regenerate the man pages;" >&2; \
-	    echo "       typically \`make maintainer-clean' will remove them" >&2; \
+	    echo "       typically 'make maintainer-clean' will remove them" >&2; \
 	    exit 1; \
 	  else :; fi; \
 	else :; fi
@@ -711,8 +731,12 @@
 
 html: $(HTML_DOCS)
 
-website: html
-	bsdtar czf website.tar.gz $(HTML_DOCS) \
+website: website.tar.gz
+
+.PHONY: html website
+
+website.tar.gz: html
+	$(AM_V_GEN)bsdtar czf $@ $(HTML_DOCS) \
 		asciidoc-override.css \
 		-C /etc/asciidoc/stylesheets/ \
 		asciidoc.css \
@@ -723,15 +747,15 @@
 
 # These rules are due to the includes and files of the asciidoc text
 $(ASCIIDOC_MANS): asciidoc.conf footer.txt Makefile.am
-	a2x $(A2X_OPTS) --asciidoc-opts="$(ASCIIDOC_OPTS) --out-file=./$@.xml" $(srcdir)/$@.txt
+	$(AM_V_GEN)a2x $(A2X_OPTS) --asciidoc-opts="$(ASCIIDOC_OPTS) --out-file=./$@.xml" $(srcdir)/$@.txt
 
 %.html: %.txt
-	asciidoc $(ASCIIDOC_OPTS) $*.txt
-	dos2unix $@
+	$(AM_V_GEN)asciidoc $(ASCIIDOC_OPTS) -o - $*.txt | \
+		sed -e 's/\r$$//' > $@
 
 HACKING.html: ../HACKING
-	asciidoc $(ASCIIDOC_OPTS) -o $@ ../HACKING
-	dos2unix $@
+	$(AM_V_GEN)asciidoc $(ASCIIDOC_OPTS) -o - ../HACKING | \
+		sed -e 's/\r$$//' > $@
 
 # Customizations for certain HTML docs
 $(HTML_MANPAGES): asciidoc.conf footer.txt Makefile.am
@@ -748,6 +772,7 @@
 vercmp.8 vercmp.8.html: vercmp.8.txt
 pkgdelta.8 pkgdelta.8.html: pkgdelta.8.txt
 pacman-key.8 pacman-key.8.html: pacman-key.8.txt
+pactree.8 pactree.8.html: pactree.8.txt
 PKGBUILD.5 PKGBUILD.5.html: PKGBUILD.5.txt PKGBUILD-example.txt
 makepkg.conf.5 makepkg.conf.5.html: makepkg.conf.5.txt
 pacman.conf.5 pacman.conf.5.html: pacman.conf.5.txt
Only in pacman-4.0.3/doc: PKGBUILD.5
diff -x '.*' -aur pacman-4.0.3/doc/PKGBUILD.5.txt pacman/doc/PKGBUILD.5.txt
--- pacman-4.0.3/doc/PKGBUILD.5.txt	2011-11-15 14:17:08.000000000 +0000
+++ pacman/doc/PKGBUILD.5.txt	2012-10-15 18:11:52.477419551 +0000
@@ -40,12 +40,18 @@
 
 *pkgname (array)*::
 	Either the name of the package or an array of names for split packages.
-	Because it will be used in the package filename, this has to be unix-friendly.
-	Members of the array are not allowed to start with hyphens.
+	Valid characters for members of this array are alphanumerics, and any of
+	the following characters: ```@ . _ + -`''. Additionally, names are not
+	allowed to start with hyphens.
 
 *pkgver*::
 	The version of the software as released from the author (e.g., '2.7.1').
 	The variable is not allowed to contain colons or hyphens.
++
+The `pkgver` variable can be automatically updated by providing a `pkgver()` function
+in the PKGBUILD that outputs the new package version.  This is run after downloading
+and extracting the sources so can use those files in determining the new `pkgver`.
+This is most useful when used with sources from version control systems (see below).
 
 *pkgrel*::
 	This is the release number specific to the Arch Linux release. This
@@ -108,6 +114,10 @@
 with weird URLs and for handling multiple source files with the same
 name. The syntax is: `source=('filename::url')`.
 +
+makepkg also supports building developmental versions of packages using sources
+downloaded from version control systems (VCS). For more information, see
+<<VCS,Using VCS Sources>> below.
++
 Files in the source array with extensions `.sig`, `.sign` or `.asc` are recognized by
 makepkg as PGP signatures and will be automatically used to verify the integrity
 of the corresponding source file.
@@ -120,9 +130,10 @@
 *md5sums (array)*::
 	This array contains an MD5 hash for every source file specified in the
 	source array (in the same order). makepkg will use this to verify source
-	file integrity during subsequent builds. To easily generate md5sums, run
-	`makepkg -g >> PKGBUILD`. If desired, move the md5sums line to an
-	appropriate location.
+	file integrity during subsequent builds. If 'SKIP' is put in the array
+	in place of a normal hash, the integrity check for that source file will
+	be skipped. To easily generate md5sums, run ``makepkg -g >> PKGBUILD''.
+	If desired, move the md5sums line to an appropriate location.
 
 *sha1sums, sha256sums, sha384sums, sha512sums (arrays)*::
 	Alternative integrity checks that makepkg supports; these all behave
@@ -252,10 +263,10 @@
 		with distcc.
 
 	*buildflags*;;
-		Allow the use of user-specific buildflags (CFLAGS, CXXFLAGS, LDFLAGS)
-		during build as specified in linkman:makepkg.conf[5]. More useful in
-		its negative form `!buildflags` with select packages that have problems
-		building with custom buildflags.
+		Allow the use of user-specific buildflags (CPPFLAGS, CFLAGS, CXXFLAGS,
+		LDFLAGS) during build as specified in linkman:makepkg.conf[5]. More
+		useful in its negative form `!buildflags` with select packages that
+		have problems building with custom buildflags.
 
 	*makeflags*;;
 		Allow the use of user-specific makeflags during build as specified
@@ -294,6 +305,15 @@
 recommended to use the bash `local` keyword to scope the variable to inside
 the build function.
 
+prepare() Function
+------------------
+An optional prepare() function can be specified in which operations that are
+to be run in order to prepare the sources for building (such as patching) are
+performed. This function is run after the source extraction and before the
+build() function and is skipped when source extraction is skipped. The
+function is run in `bash -e` mode, meaning any command that exits with a
+non-zero status will cause the function to exit.
+
 check() Function
 ----------------
 An optional check() function can be specified in which a packages test-suite
@@ -322,9 +342,9 @@
 All options and directives for the split packages default to the global values
 given in the PKGBUILD. Nevertheless, the following ones can be overridden within
 each split package's packaging function:
-`pkgver`, `pkgrel`, `epoch`, `pkgdesc`, `arch`, `license`, `groups`, `depends`,
-`optdepends`, `provides`, `conflicts`, `replaces`, `backup`, `options`,
-`install` and `changelog`.
+`pkgver`, `pkgrel`, `epoch`, `pkgdesc`, `arch`, `url`, `license`, `groups`,
+`depends`, `optdepends`, `provides`, `conflicts`, `replaces`, `backup`,
+`options`, `install` and `changelog`.
 
 An optional global directive is available when building a split package:
 
@@ -381,69 +401,43 @@
 template install file is available in '{pkgdatadir}' as 'proto.install' for
 reference with all of the available functions defined.
 
+Using VCS Sources[[VCS]]
+------------------------
+Building a developmental version of a package using sources from a version control
+system (VCS) is enabled by specifying the source in the form
+`source=('folder::url#fragment')`. Currently makepkg supports the `bzr`, `git`, `hg` and
+`svn` protocols.
+
+The source URL is divided into three components:
+
+*folder*::
+	(optional) Specifies an alternate folder name for makepkg to download the VCS
+	source into.
 
-Development Directives
-----------------------
-makepkg supports building development versions of packages without having to
-manually update the pkgver in the PKGBUILD. This was formerly done using the
-separate utility 'versionpkg'. In order to utilize this functionality, your
-PKGBUILD must use correct variable names depending on the SCM being fetched
-from (e.g., 'makepkg-git', 'mplayer-svn').
-
-*CVS*::
-	The generated pkgver will be the date the package is built.
-
-	*_cvsroot*;;
-		The root of the CVS repository.
-
-	*_cvsmod*;;
-		The CVS module to fetch.
-
-*SVN*::
-	The generated pkgver will be the latest SVN revision number.
-
-	*_svntrunk*;;
-		The trunk of the SVN repository.
-
-	*_svnmod*;;
-		The SVN module to fetch.
-
-*Git*::
-	The generated pkgver will be the date the package is built.
-
-	*_gitroot*;;
-		The URL (all protocols supported) to the GIT repository.
-
-	*_gitname*;;
-		GIT tag or branch to use.
-
-*Mercurial*::
-	The generated pkgver will be the hg tip revision number.
-
-	*_hgroot*;;
-		The URL of the mercurial repository.
-
-	*_hgrepo*;;
-		The repository to follow.
-
-*Darcs*::
-	The generated pkgver will be the date the package is built.
-
-	*_darcstrunk*;;
-		URL to the repository trunk.
-
-	*_darcsmod*;;
-		Darcs module to use.
-
-*Bazaar*::
-	The generated pkgver will be the latest Bazaar revision number (revno).
+*url*::
+	The url to the VCS repo. This must include the the vcs in the URL protocol for
+	makepkg to recognize this as a VCS source.  If the protocol does not include
+	the VCS name, it can be added by prefixing the URL with `vcs+`. For example,
+	using a git repository over `http` would have a source URL in the form
+	`git+http://...`.
+
+*fragment*::
+	(optional) Allows specifying a revision number or branch for makepkg to checkout
+	from the VCS. For example, to checkout a given revision, the source line would
+	have the format `source=(url#revision=123)`. The available fragments depends on
+	the VCS being used:
+
+	*bzr*;;
+		revision (see `bzr help revisionspec` for details)
 
-	*_bzrtrunk*;;
-		URL to the bazaar repository.
+	*git*;;
+		branch, commit, tag
 
-	*_bzrmod*;;
-		Bazaar module to use.
+	*hg*;;
+		branch, revision, tag
 
+	*svn*;;
+		revision
 
 Example
 -------
diff -x '.*' -aur pacman-4.0.3/doc/index.txt pacman/doc/index.txt
--- pacman-4.0.3/doc/index.txt	2012-04-07 15:52:36.000000000 +0000
+++ pacman/doc/index.txt	2012-10-15 18:11:52.481286991 +0000
@@ -218,7 +218,7 @@
 ~~~~~~~~~~~~~~~
 Although the package manager itself is quite simple, many scripts have been
 developed that help automate building and installing packages. These are used
-extensively in link:http://archlinux.org/[Arch Linux]. Most of these utilities
+extensively in link:http://www.archlinux.org/[Arch Linux]. Most of these utilities
 are available in the Arch Linux projects
 link:http://projects.archlinux.org/[code browser].
 
@@ -238,31 +238,9 @@
 if it helps.
 
 You can also post a bug to the Arch Linux bug tracker
-link:http://bugs.archlinux.org/index.php?project=3[Flyspray]. Be sure to file
+link:https://bugs.archlinux.org/index.php?project=3[Flyspray]. Be sure to file
 bugs under the Pacman project.
 
-Pacman/libalpm in the Wild
---------------------------
-Although Arch Linux is the primary user of pacman and libalpm, other
-distributions and projects also use pacman as a package management tool. In
-addition, there have been several projects started to provide a frontend GUI to
-pacman and/or libalpm.
-
-Arch derivatives:
-
-* link:http://archie.dotsrc.org/[Archie] - Arch Live on steroids
-* link:http://www.faunos.com/[FaunOS] - A portable, fully integrated operating system based on Arch Linux
-* link:http://larch.berlios.de/[larch] - A live CD/DVD/USB-stick construction kit for Arch Linux
-
-Other distributions:
-
-* link:http://www.delilinux.org/[DeLi Linux] - "Desktop Light" Linux, a Linux distribution for old computers
-* link:http://www.frugalware.org/[Frugalware Linux] - A general purpose Linux distribution for intermediate users (pacman is forked and maintained separately)
-
-Pacman/libalpm frontends:
-
-* link:http://shaman.iskrembilen.com/[Shaman] - A GUI frontend using Qt and libalpm
-
 Copyright
 ---------
 pacman is Copyright (C) 2006-2012 Pacman Development Team
Only in pacman-4.0.3/doc: libalpm.3
Only in pacman-4.0.3/doc: makepkg.8
diff -x '.*' -aur pacman-4.0.3/doc/makepkg.8.txt pacman/doc/makepkg.8.txt
--- pacman-4.0.3/doc/makepkg.8.txt	2012-02-03 16:05:08.000000000 +0000
+++ pacman/doc/makepkg.8.txt	2012-10-15 18:11:52.481286991 +0000
@@ -59,11 +59,11 @@
 	installed.
 
 *-e, \--noextract*::
-	Do not extract source files; use whatever source already exists in the
-	src/ directory. This is handy if you want to go into src/ and manually
-	patch or tweak code, then make a package out of the result. Keep in mind
-	that creating a patch may be a better solution to allow others to use
-	your PKGBUILD.
+	Do not extract source files or run the prepare() function (if present);
+	use whatever source already exists in the $srcdir/ directory. This is
+	handy if you want to go into $srcdir/ and manually patch or tweak code,
+	then make a package out of the result. Keep in mind that creating a
+	patch may be a better solution to allow others to use your PKGBUILD.
 
 *-f, \--force*::
 	makepkg will not build a package if a built package already exists in
@@ -71,11 +71,6 @@
 	default to the current directory. This allows the built package to be
 	overwritten.
 
-*--forcever*::
-	This is a hidden option that should *not* be used unless you really know
-	what you are doing. makepkg uses this internally when calling itself to
-	set the new development pkgver of the package.
-
 *-g, \--geninteg*::
 	For each source file in the source array of PKGBUILD, download the file
 	if required and generate integrity checks. The integrity checks generated
@@ -96,10 +91,9 @@
 *-h, \--help*::
 	Output syntax and command line options.
 
-*\--holdver*::
-	Useful when building development versions of packages. Prevents makepkg
-	from automatically bumping the pkgver to the latest revision number in
-	the package's development tree.
+*--holdver*::
+	When using VCS sources (linkman:PKGBUILD[5]) any currently checked out source
+	will not be updated to the latest revision.
 
 *-i, \--install*::
 	Install or upgrade the package after a successful build using
@@ -116,9 +110,9 @@
 	Disable color in output messages.
 
 *-o, \--nobuild*::
-	Download and extract files only, but do not build them. Useful with the
-	'\--noextract' option if you wish to tweak the files in src/ before
-	building.
+	Download and extract files, run the prepare() function, but do not build
+	them. Useful with the '\--noextract' option if you wish to tweak the files
+	in $srcdir/ before building.
 
 *-p* <buildscript>::
 	Read the package script `buildscript` instead of the `PKGBUILD` default;
@@ -152,8 +146,9 @@
 	such as a chroot or remote builder. It will also satisfy requirements of
 	the GPL when distributing binary packages.
 
-*\--pkg <list>*::
-	Only build listed packages from a split package.
+*\--pkg* <list>::
+	Only build listed packages from a split package. Multiple packages should
+	be comma separated in the list. This option can be specified multiple times.
 
 *\--check*::
 	Run the check() function in the PKGBUILD, overriding the setting in
@@ -178,6 +173,10 @@
 	(Passed to pacman) Prevent pacman from waiting for user input before
 	proceeding with operations.
 
+*\--asdeps*::
+	(Passed to pacman) Install packages as non-explicitly installed (used
+	with -i / --install).
+
 *\--noprogressbar*::
 	(Passed to pacman) Prevent pacman from displaying a progress bar;
 	useful if you are redirecting makepkg output to file.
@@ -207,6 +206,10 @@
 	Folder where the downloaded sources will be stored. Overrides the
 	corresponding value defined in linkman:makepkg.conf[5].
 
+**PACKAGER=**"John Doe <john@doe.com>"::
+	String to identify the creator of the resulting package. Overrides
+	the corresponding value defined in linkman:makepkg.conf[5].
+
 **BUILDDIR=**"/path/to/folder"::
 	Folder where the package will be built. Overrides the corresponding
 	value defined in linkman:makepkg.conf[5].
Only in pacman-4.0.3/doc: makepkg.conf.5
diff -x '.*' -aur pacman-4.0.3/doc/makepkg.conf.5.txt pacman/doc/makepkg.conf.5.txt
--- pacman-4.0.3/doc/makepkg.conf.5.txt	2011-12-01 04:30:22.000000000 +0000
+++ pacman/doc/makepkg.conf.5.txt	2012-10-15 18:11:52.481286991 +0000
@@ -25,6 +25,10 @@
 NOTE: This does not guarantee that all package Makefiles will use your exported
 variables. Some of them are non-standard.
 
+The system-wide configuration file is found in {sysconfdir}/makepkg.conf.
+Individual options can be overridden (or added to) on a per user basis in
+~/.makepkg.conf.
+
 The default file is fairly well commented, so it may be easiest to simply
 follow directions given there for customization.
 
@@ -51,6 +55,9 @@
 	A string such as ``i686-pc-linux-gnu'', do not touch unless you know what
 	you are doing. This can be commented out by most users if desired.
 
+**CPPFLAGS=**"cppflags"::
+	Flags used for the C preprocessor; see CFLAGS for more info.
+
 **CFLAGS=**"cflags"::
 	Flags used for the C compiler. This is a key part to the use of makepkg.
 	Usually several options are specified, and the most common string resembles
@@ -213,6 +220,10 @@
 	This value is used when querying a package to see who was the builder.
 	It is recommended you change this to your name and email address.
 
+**COMPRESSGZ=**"(gzip -c -f -n)", **COMPRESSBZ2=**"(bzip2 -c -f)", **COMPRESSXZ=**"(xz -c -z -)", **COMPRESSZ=**"(compress -c -f)"::
+	Sets the command and options used when compressing compiled or source
+	packages in the named format.
+
 **PKGEXT=**".pkg.tar.gz", **SRCEXT=**".src.tar.gz"::
 	Sets the compression used when making compiled or source packages. The
 	current valid suffixes are `.tar`, `.tar.gz`, `.tar.bz2`, `.tar.xz`, and
Only in pacman-4.0.3/doc: pacman-key.8
diff -x '.*' -aur pacman-4.0.3/doc/pacman-key.8.txt pacman/doc/pacman-key.8.txt
--- pacman-4.0.3/doc/pacman-key.8.txt	2012-03-05 17:57:30.000000000 +0000
+++ pacman/doc/pacman-key.8.txt	2012-10-15 18:11:52.481286991 +0000
@@ -12,7 +12,7 @@
 
 Synopsis
 --------
-'pacman-key' [options]
+'pacman-key' [options] operation [targets]
 
 
 Description
@@ -26,45 +26,40 @@
 the '\--homedir' option pointing at the pacman keyring (located in
 +{sysconfdir}/pacman.d/gnupg+ by default).
 
-
-Options
--------
-*-a, \--add* [file(s)]::
+Invoking pacman-key consists of supplying an operation with any potential
+options and targets to operate on. Depending on the operation, a 'target' may
+be a valid key identifier, filename, or directory.
+
+Operations
+----------
+*-a, \--add*::
 	Add the key(s) contained in the specified file or files to pacman's
 	keyring. If a key already exists, update it.
 
-*\--config* <file>::
-	Use an alternate config file instead of the +{sysconfdir}/pacman.conf+
-	default.
-
-*-d, \--delete* <keyid(s)>::
+*-d, \--delete*::
 	Remove the key(s) identified by the specified keyid(s) from pacman's
 	keyring.
 
-*-e, \--export* [keyid(s)]::
+*-e, \--export*::
 	Export key(s) identified by the specified keyid(s) to 'stdout'. If no keyid
 	is specified, all keys will be exported.
 
-*\--edit-key* <keyid(s)>::
+*\--edit-key*::
 	Present a menu for key management task on the specified keyid(s). Useful
 	for adjusting a keys trust level.
 
-*-f, \--finger* [keyid(s)]::
+*-f, \--finger*::
 	List a fingerprint for each specified keyid, or for all known keys if no
 	keyids are specified.
 
-*\--gpgdir* <dir>::
-	Set an alternate home directory for GnuPG. If unspecified, the value is
-	read from +{sysconfdir}/pacman.conf+.
-
 *-h, \--help*::
 	Output syntax and command line options.
 
-*\--import* <dir(s)>::
+*\--import*::
 	Imports keys from `pubring.gpg` into the public keyring from the specified
 	directories.
 
-*\--import-trustdb* <dir(s)> ::
+*\--import-trustdb*::
 	Imports ownertrust values from `trustdb.gpg` into the shared trust database
 	from the specified directories.
 
@@ -72,42 +67,53 @@
 	Ensure the keyring is properly initialized and has the required access
 	permissions.
 
-*\--keyserver* <keyserver>::
-	Use the specified keyserver if the operation requires one. This will take
-	precedence over any keyserver option specified in a `gpg.conf`
-	configuration file. Running '\--init' with this option will set the default
-	keyserver if one was not already configured.
-
-*-l, \--list-keys* [keyid(s)]::
+*-l, \--list-keys*::
 	Lists all or specified keys from the public keyring.
 
-*\--list-sigs* [keyid(s)]::
+*\--list-sigs*::
 	Same as '\--list-keys', but the signatures are listed too.
 
-*\--lsign-key* <keyid>::
+*\--lsign-key*::
 	Locally sign the given key. This is primarily used to root the web of trust
 	in the local private key generated by '\--init'.
 
-*-r, \--recv-keys* <keyid(s)>::
+*-r, \--recv-keys*::
 	Equivalent to '\--recv-keys' in GnuPG.
 
-*\--refresh-keys* [keyid(s)]::
+*\--refresh-keys*::
 	Equivalent to '\--refresh-keys' in GnuPG.
 
-*\--populate* [keyring(s)]::
+*\--populate*::
 	Reload the default keys from the (optionally provided) keyrings in
 	+{pkgdatadir}/keyrings+. For more information, see
 	<<SC,Providing a Keyring for Import>> below.
 
 *-u, \--updatedb*::
-	Equivalent to '\--check-trustdb' in GnuPG.
-
-*-v, \--verify* <signature>::
-	Verify the given signature file.
+	Equivalent to '\--check-trustdb' in GnuPG. This operation can be specified with
+	other operations.
 
 *-V, \--version*::
 	Displays the program version.
 
+*-v, \--verify*::
+	Verify the file(s) specified by the signature(s).
+
+Options
+-------
+*\--config* <file>::
+	Use an alternate config file instead of the +{sysconfdir}/pacman.conf+
+	default.
+
+*\--gpgdir* <dir>::
+	Set an alternate home directory for GnuPG. If unspecified, the value is
+	read from +{sysconfdir}/pacman.conf+.
+
+*\--keyserver* <keyserver>::
+	Use the specified keyserver if the operation requires one. This will take
+	precedence over any keyserver option specified in a `gpg.conf`
+	configuration file. Running '\--init' with this option will set the default
+	keyserver if one was not already configured.
+
 
 Providing a Keyring for Import
 ------------------------------
Only in pacman-4.0.3/doc: pacman.8
diff -x '.*' -aur pacman-4.0.3/doc/pacman.8.txt pacman/doc/pacman.8.txt
--- pacman-4.0.3/doc/pacman.8.txt	2012-02-15 21:57:20.000000000 +0000
+++ pacman/doc/pacman.8.txt	2012-10-15 18:11:52.481286991 +0000
@@ -70,10 +70,10 @@
 In addition to packages, groups can be specified as well. For example, if
 gnome is a defined package group, then `pacman -S gnome` will provide a
 prompt allowing you to select which packages to install from a numbered list.
-The package selection is specified using a space separated list of package
-numbers. Sequential packages may be selected by specifying the first and last
-package numbers separated by a hyphen (`-`). Excluding packages is achieved by
-prefixing a number or range of numbers with a caret (`^`).
+The package selection is specified using a space and/or comma separated list of
+package numbers. Sequential packages may be selected by specifying the first
+and last package numbers separated by a hyphen (`-`). Excluding packages is
+achieved by prefixing a number or range of numbers with a caret (`^`).
 +
 Packages that provide other packages are also handled. For example, `pacman -S
 foo` will first look for a foo package. If foo is not found, packages that
@@ -201,7 +201,7 @@
 
 Upgrade Options (apply to '-S' and '-U')[[UO]]
 --------------------------------------------
-*-f, \--force*::
+*\--force*::
 	Bypass file conflict checks and overwrite conflicting files. If the
 	package that is about to be installed contains files that are already
 	installed, this option will cause all those files to be overwritten.
@@ -232,13 +232,6 @@
 *\--needed*::
 	Do not reinstall the targets that are already up to date.
 
-*\--recursive*::
-	Recursively reinstall all dependencies of the targets. This forces upgrades
-	or reinstalls of all dependencies without requiring explicit version
-	requirements. This is most useful in combination with the '\--needed' flag,
-	which will induce a deep dependency upgrade without any unnecessary
-	reinstalls.
-
 
 Query Options[[QO]]
 -------------------
@@ -408,9 +401,6 @@
 	will force a refresh of all package lists even if they appear to be up
 	to date.
 
-*\--needed*::
-	Do not reinstall the targets that are already up to date.
-
 
 Handling Config Files[[HCF]]
 ----------------------------
Only in pacman-4.0.3/doc: pacman.conf.5
diff -x '.*' -aur pacman-4.0.3/doc/pacman.conf.5.txt pacman/doc/pacman.conf.5.txt
--- pacman-4.0.3/doc/pacman.conf.5.txt	2011-10-12 19:04:25.000000000 +0000
+++ pacman/doc/pacman.conf.5.txt	2012-10-15 18:11:52.481286991 +0000
@@ -86,24 +86,17 @@
 
 *HoldPkg =* package ...::
 	If a user tries to '\--remove' a package that's listed in `HoldPkg`,
-	pacman will ask for confirmation before proceeding.
+	pacman will ask for confirmation before proceeding. Shell-style glob
+	patterns are allowed.
 
 *IgnorePkg =* package ...::
 	Instructs pacman to ignore any upgrades for this package when performing
-	a '\--sysupgrade'.
-
-*SyncFirst =* package ...::
-	Instructs pacman to check for newer version of these packages before any
-	sync operation. The user will have the choice to either cancel the current
-	operation and upgrade these packages first or go on with the current
-	operation. This option is typically used with the 'pacman' package.
-	*NOTE*: when a `SyncFirst` transaction takes place, no command line flags
-	(e.g. '\--force') are honored. If this is not ideal, disabling `SyncFirst`
-	and performing a manual sync of the involved packages may be required.
+	a '\--sysupgrade'. Shell-style glob patterns are allowed.
 
 *IgnoreGroup =* group ...::
 	Instructs pacman to ignore any upgrades for all packages in this
-	group when performing a '\--sysupgrade'.
+	group when performing a '\--sysupgrade'. Shell-style glob patterns are
+	allowed.
 
 *Include =* path::
 	Include another config file. This file can include repositories or
@@ -134,7 +127,8 @@
 	a package install/upgrade, and the new files will be installed with a
 	'.pacnew' extension.
 	These files refer to files in the package archive, so do not include the
-	leading slash (the RootDir) when specifying them.
+	leading slash (the RootDir) when specifying them. Shell-style glob patterns
+	are allowed.
 
 *NoExtract =* file ...::
 	All files listed with a `NoExtract` directive will never be extracted from
@@ -143,7 +137,8 @@
 	'index.php', then you would not want the 'index.html' file to be extracted
 	from the 'apache' package.
 	These files refer to files in the package archive, so do not include the
-	leading slash (the RootDir) when specifying them.
+	leading slash (the RootDir) when specifying them. Shell-style glob patterns
+	are allowed.
 
 *CleanMethod =* KeepInstalled &| KeepCurrent::
 	If set to `KeepInstalled` (the default), the '-Sc' operation will clean
@@ -164,9 +159,13 @@
 	Log action messages through syslog(). This will insert log entries into
 	+{localstatedir}/log/messages+ or equivalent.
 
-*UseDelta*::
-	Download delta files instead of complete packages if possible.  Requires
-	the xdelta3 program to be installed.
+*UseDelta* [= ratio]::
+	Download delta files instead of complete packages if possible. Requires
+	the `xdelta3` program to be installed. If a ratio is specified (e.g.,
+	`0.5`), then it is used as a cutoff for determining whether to use deltas.
+	Allowed values are between `0.0` and `2.0`; sensible values are between
+	`0.2` and `0.9`.  Using a value above `1.0` is not recommended.  The
+	default is `0.7` if left unspecified.
 
 *TotalDownload*::
 	When downloading, display the amount downloaded, download rate, ETA,
Only in pacman/doc: pactree.8.txt
Only in pacman-4.0.3/doc: pkgdelta.8
diff -x '.*' -aur pacman-4.0.3/doc/pkgdelta.8.txt pacman/doc/pkgdelta.8.txt
--- pacman-4.0.3/doc/pkgdelta.8.txt	2011-10-13 19:41:49.000000000 +0000
+++ pacman/doc/pkgdelta.8.txt	2012-10-15 18:11:52.481286991 +0000
@@ -11,7 +11,7 @@
 
 Synopsis
 --------
-'pkgdelta' [-q] <package1> <package2>
+'pkgdelta' [options] <package1> <package2>
 
 
 Description
@@ -27,6 +27,17 @@
 
 Options
 -------
+*--max-delta-size <ratio>*::
+	Only create delta files if the delta is smaller than ratio * package_size.
+	Possible values: 0.0 to 2.0.
+	Recommended values: 0.2 to 0.9.
+	Default value: 0.7
+
+*--min-pkg-size <size>*::
+	Minimal size of the package file in bytes to be considered for delta creation.
+	Default value: 1048576 bytes = 1MiB. This may be any absolute size in bytes, or
+	a human readable value such as `4 MiB` or `3.5MB`.
+
 *-q, \--quiet*::
 	Be quiet. Do not output anything but warnings and errors.
 
Only in pacman-4.0.3/doc: repo-add.8
Only in pacman-4.0.3/doc: vercmp.8
diff -x '.*' -aur pacman-4.0.3/etc/Makefile.am pacman/etc/Makefile.am
--- pacman-4.0.3/etc/Makefile.am	2011-10-12 19:04:25.000000000 +0000
+++ pacman/etc/Makefile.am	2012-10-15 18:11:52.481286991 +0000
@@ -22,10 +22,9 @@
 	-e 's|@ROOTDIR[@]|$(ROOTDIR)|g'
 
 $(dist_sysconf_DATA): Makefile
-	@echo '    ' GEN $@;
-	@$(RM) $@ $@.tmp
-	@$(edit) `test -f ./$@.in || echo $(srcdir)/`$@.in >$@.tmp
-	@mv $@.tmp $@
+	$(AM_V_at)$(RM) $@ $@.tmp
+	$(AM_V_GEN)$(edit) `test -f ./$@.in || echo $(srcdir)/`$@.in >$@.tmp
+	$(AM_V_at)mv $@.tmp $@
 
 makepkg.conf: $(srcdir)/makepkg.conf.in
 pacman.conf: $(srcdir)/pacman.conf.in
diff -x '.*' -aur pacman-4.0.3/etc/Makefile.in pacman/etc/Makefile.in
--- pacman-4.0.3/etc/Makefile.in	2012-04-07 15:58:14.000000000 +0000
+++ pacman/etc/Makefile.in	2012-10-15 18:12:22.665540787 +0000
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.11.4 from Makefile.am.
+# Makefile.in generated by automake 1.12 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -53,23 +53,30 @@
 host_triplet = @host@
 subdir = etc
 DIST_COMMON = $(dist_sysconf_DATA) $(srcdir)/Makefile.am \
-	$(srcdir)/Makefile.in
+	$(srcdir)/Makefile.in $(top_srcdir)/build-aux/mkinstalldirs
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/m4/gettext.m4 \
+am__aclocal_m4_deps = $(top_srcdir)/m4/acinclude.m4 \
+	$(top_srcdir)/m4/gettext.m4 $(top_srcdir)/m4/gpgme.m4 \
 	$(top_srcdir)/m4/iconv.m4 $(top_srcdir)/m4/intlmacosx.m4 \
 	$(top_srcdir)/m4/lib-ld.m4 $(top_srcdir)/m4/lib-link.m4 \
-	$(top_srcdir)/m4/lib-prefix.m4 $(top_srcdir)/m4/libcurl.m4 \
-	$(top_srcdir)/m4/libtool.m4 $(top_srcdir)/m4/ltoptions.m4 \
-	$(top_srcdir)/m4/ltsugar.m4 $(top_srcdir)/m4/ltversion.m4 \
-	$(top_srcdir)/m4/lt~obsolete.m4 $(top_srcdir)/m4/nls.m4 \
+	$(top_srcdir)/m4/lib-prefix.m4 $(top_srcdir)/m4/libtool.m4 \
+	$(top_srcdir)/m4/ltoptions.m4 $(top_srcdir)/m4/ltsugar.m4 \
+	$(top_srcdir)/m4/ltversion.m4 $(top_srcdir)/m4/lt~obsolete.m4 \
+	$(top_srcdir)/m4/nls.m4 $(top_srcdir)/m4/pkg.m4 \
 	$(top_srcdir)/m4/po.m4 $(top_srcdir)/m4/progtest.m4 \
-	$(top_srcdir)/acinclude.m4 $(top_srcdir)/configure.ac
+	$(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
-mkinstalldirs = $(SHELL) $(top_srcdir)/mkinstalldirs
+mkinstalldirs = $(SHELL) $(top_srcdir)/build-aux/mkinstalldirs
 CONFIG_HEADER = $(top_builddir)/config.h
 CONFIG_CLEAN_FILES =
 CONFIG_CLEAN_VPATH_FILES =
+AM_V_GEN = $(am__v_GEN_@AM_V@)
+am__v_GEN_ = $(am__v_GEN_@AM_DEFAULT_V@)
+am__v_GEN_0 = @echo "  GEN     " $@;
+AM_V_at = $(am__v_at_@AM_V@)
+am__v_at_ = $(am__v_at_@AM_DEFAULT_V@)
+am__v_at_0 = @
 SOURCES =
 DIST_SOURCES =
 am__can_run_installinfo = \
@@ -109,6 +116,7 @@
 DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
 ACLOCAL = @ACLOCAL@
 AMTAR = @AMTAR@
+AM_DEFAULT_VERBOSITY = @AM_DEFAULT_VERBOSITY@
 AR = @AR@
 ASCIIDOC = @ASCIIDOC@
 AUTOCONF = @AUTOCONF@
@@ -124,10 +132,6 @@
 CHOST = @CHOST@
 CPP = @CPP@
 CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXCPP = @CXXCPP@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
 CYGPATH_W = @CYGPATH_W@
 DEFS = @DEFS@
 DEPDIR = @DEPDIR@
@@ -146,7 +150,11 @@
 GIT = @GIT@
 GMSGFMT = @GMSGFMT@
 GMSGFMT_015 = @GMSGFMT_015@
+GPGME_CFLAGS = @GPGME_CFLAGS@
+GPGME_CONFIG = @GPGME_CONFIG@
+GPGME_LIBS = @GPGME_LIBS@
 GREP = @GREP@
+INODECMD = @INODECMD@
 INSTALL = @INSTALL@
 INSTALL_DATA = @INSTALL_DATA@
 INSTALL_PROGRAM = @INSTALL_PROGRAM@
@@ -156,12 +164,16 @@
 INTL_MACOSX_LIBS = @INTL_MACOSX_LIBS@
 LD = @LD@
 LDFLAGS = @LDFLAGS@
-LIBCURL = @LIBCURL@
-LIBCURL_CPPFLAGS = @LIBCURL_CPPFLAGS@
+LIBARCHIVE_CFLAGS = @LIBARCHIVE_CFLAGS@
+LIBARCHIVE_LIBS = @LIBARCHIVE_LIBS@
+LIBCURL_CFLAGS = @LIBCURL_CFLAGS@
+LIBCURL_LIBS = @LIBCURL_LIBS@
 LIBICONV = @LIBICONV@
 LIBINTL = @LIBINTL@
 LIBOBJS = @LIBOBJS@
 LIBS = @LIBS@
+LIBSSL_CFLAGS = @LIBSSL_CFLAGS@
+LIBSSL_LIBS = @LIBSSL_LIBS@
 LIBTOOL = @LIBTOOL@
 LIB_VERSION = @LIB_VERSION@
 LIB_VERSION_INFO = @LIB_VERSION_INFO@
@@ -191,10 +203,14 @@
 PACKAGE_VERSION = @PACKAGE_VERSION@
 PATH_SEPARATOR = @PATH_SEPARATOR@
 PKGEXT = @PKGEXT@
+PKG_CONFIG = @PKG_CONFIG@
+PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
+PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 POSUB = @POSUB@
 PYTHON = @PYTHON@
 RANLIB = @RANLIB@
 ROOTDIR = @ROOTDIR@
+SCRIPTLET_SHELL = @SCRIPTLET_SHELL@
 SED = @SED@
 SEDINPLACE = @SEDINPLACE@
 SET_MAKE = @SET_MAKE@
@@ -207,17 +223,16 @@
 STRIP_STATIC = @STRIP_STATIC@
 USE_NLS = @USE_NLS@
 VERSION = @VERSION@
+WARNING_CFLAGS = @WARNING_CFLAGS@
 XGETTEXT = @XGETTEXT@
 XGETTEXT_015 = @XGETTEXT_015@
 XGETTEXT_EXTRA_OPTIONS = @XGETTEXT_EXTRA_OPTIONS@
-_libcurl_config = @_libcurl_config@
 abs_builddir = @abs_builddir@
 abs_srcdir = @abs_srcdir@
 abs_top_builddir = @abs_top_builddir@
 abs_top_srcdir = @abs_top_srcdir@
 ac_ct_AR = @ac_ct_AR@
 ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
 ac_ct_DUMPBIN = @ac_ct_DUMPBIN@
 am__include = @am__include@
 am__leading_dot = @am__leading_dot@
@@ -331,7 +346,7 @@
 	@list='$(dist_sysconf_DATA)'; test -n "$(sysconfdir)" || list=; \
 	if test -n "$$list"; then \
 	  echo " $(MKDIR_P) '$(DESTDIR)$(sysconfdir)'"; \
-	  $(MKDIR_P) '$(DESTDIR)$(sysconfdir)' || exit 1; \
+	  $(MKDIR_P) "$(DESTDIR)$(sysconfdir)" || exit 1; \
 	fi; \
 	for p in $$list; do \
 	  if test -f "$$p"; then d=; else d="$(srcdir)/"; fi; \
@@ -353,6 +368,8 @@
 ctags: CTAGS
 CTAGS:
 
+cscope cscopelist:
+
 
 distdir: $(DISTFILES)
 	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
@@ -504,10 +521,9 @@
 
 
 $(dist_sysconf_DATA): Makefile
-	@echo '    ' GEN $@;
-	@$(RM) $@ $@.tmp
-	@$(edit) `test -f ./$@.in || echo $(srcdir)/`$@.in >$@.tmp
-	@mv $@.tmp $@
+	$(AM_V_at)$(RM) $@ $@.tmp
+	$(AM_V_GEN)$(edit) `test -f ./$@.in || echo $(srcdir)/`$@.in >$@.tmp
+	$(AM_V_at)mv $@.tmp $@
 
 makepkg.conf: $(srcdir)/makepkg.conf.in
 pacman.conf: $(srcdir)/pacman.conf.in
Only in pacman-4.0.3/etc: makepkg.conf
diff -x '.*' -aur pacman-4.0.3/etc/makepkg.conf.in pacman/etc/makepkg.conf.in
--- pacman-4.0.3/etc/makepkg.conf.in	2011-11-15 15:37:42.000000000 +0000
+++ pacman/etc/makepkg.conf.in	2012-10-15 18:11:52.481286991 +0000
@@ -8,9 +8,9 @@
 #
 #-- The download utilities that makepkg should use to acquire sources
 #  Format: 'protocol::agent'
-DLAGENTS=('ftp::/usr/bin/curl -fC - --ftp-pasv --retry 3 --retry-delay 3 -o %o %u'
-          'http::/usr/bin/curl -fLC - --retry 3 --retry-delay 3 -o %o %u'
-          'https::/usr/bin/curl -fLC - --retry 3 --retry-delay 3 -o %o %u'
+DLAGENTS=('ftp::/usr/bin/curl -qfC - --ftp-pasv --retry 3 --retry-delay 3 -o %o %u'
+          'http::/usr/bin/curl -qb "" -fLC - --retry 3 --retry-delay 3 -o %o %u'
+          'https::/usr/bin/curl -qb "" -fLC - --retry 3 --retry-delay 3 -o %o %u'
           'rsync::/usr/bin/rsync --no-motd -z %u %o'
           'scp::/usr/bin/scp -C %u %o')
 
@@ -27,6 +27,7 @@
 CHOST="@CHOST@"
 
 #-- Compiler and Linker Flags
+#CPPFLAGS=""
 #CFLAGS="-O2 -pipe"
 #CXXFLAGS="-O2 -pipe"
 #LDFLAGS=""
@@ -107,6 +108,16 @@
 #GPGKEY=""
 
 #########################################################################
+# COMPRESSION DEFAULTS
+#########################################################################
+#
+COMPRESSGZ=(gzip -c -f -n)
+COMPRESSBZ2=(bzip2 -c -f)
+COMPRESSXZ=(xz -c -z -)
+COMPRESSZ=(compress -c -f)
+
+
+#########################################################################
 # EXTENSION DEFAULTS
 #########################################################################
 #
Only in pacman-4.0.3/etc: pacman.conf
diff -x '.*' -aur pacman-4.0.3/etc/pacman.conf.in pacman/etc/pacman.conf.in
--- pacman-4.0.3/etc/pacman.conf.in	2011-10-12 19:04:25.000000000 +0000
+++ pacman/etc/pacman.conf.in	2012-10-15 18:11:52.481286991 +0000
@@ -15,11 +15,10 @@
 #LogFile     = @localstatedir@/log/pacman.log
 #GPGDir      = @sysconfdir@/pacman.d/gnupg/
 HoldPkg     = pacman glibc
-# If upgrades are available for these packages they will be asked for first
-SyncFirst   = pacman
 #XferCommand = /usr/bin/curl -C - -f %u > %o
 #XferCommand = /usr/bin/wget --passive-ftp -c -O %o %u
 #CleanMethod = KeepInstalled
+#UseDelta    = 0.7
 Architecture = auto
 
 # Pacman won't upgrade packages listed in IgnorePkg and members of IgnoreGroup
@@ -31,7 +30,6 @@
 
 # Misc options
 #UseSyslog
-#UseDelta
 #TotalDownload
 CheckSpace
 #VerbosePkgLists
Only in pacman-4.0.3: install-sh
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/Makefile.am pacman/lib/libalpm/Makefile.am
--- pacman-4.0.3/lib/libalpm/Makefile.am	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/Makefile.am	2012-10-15 18:11:52.481286991 +0000
@@ -7,7 +7,10 @@
 
 DEFS = -DLOCALEDIR=\"@localedir@\" @DEFS@
 
-AM_CFLAGS = -pedantic -D_GNU_SOURCE
+AM_CPPFLAGS = \
+	-imacros $(top_builddir)/config.h
+
+AM_CFLAGS = -pedantic -D_GNU_SOURCE $(WARNING_CFLAGS)
 
 if ENABLE_VISIBILITY_CC
 if DARWIN
@@ -20,6 +23,9 @@
 AM_CFLAGS += -fgnu89-inline
 endif
 
+pkgconfigdir = $(libdir)/pkgconfig
+pkgconfig_DATA = libalpm.pc
+
 libalpm_la_SOURCES = \
 	add.h add.c \
 	alpm.h alpm.c \
@@ -35,6 +41,7 @@
 	diskspace.h diskspace.c \
 	dload.h dload.c \
 	error.c \
+	filelist.h filelist.c \
 	graph.h graph.c \
 	group.h group.c \
 	handle.h handle.c \
@@ -60,7 +67,20 @@
 	base64.h base64.c
 endif
 
-libalpm_la_LDFLAGS = -no-undefined -version-info $(LIB_VERSION_INFO) @LIBCURL@
-libalpm_la_LIBADD = $(LTLIBINTL)
+libalpm_la_LDFLAGS = -no-undefined -version-info $(LIB_VERSION_INFO)
+
+libalpm_la_CFLAGS = \
+	$(AM_CFLAGS) \
+	$(GPGME_CFLAGS) \
+	$(LIBARCHIVE_CFLAGS) \
+	$(LIBCURL_CFLAGS) \
+	$(LIBSSL_CFLAGS)
+
+libalpm_la_LIBADD = \
+	$(LTLIBINTL) \
+	$(GPGME_LIBS) \
+	$(LIBARCHIVE_LIBS) \
+	$(LIBCURL_LIBS) \
+	$(LIBSSL_LIBS)
 
 # vim:set ts=2 sw=2 noet:
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/Makefile.in pacman/lib/libalpm/Makefile.in
--- pacman-4.0.3/lib/libalpm/Makefile.in	2012-04-07 15:58:14.000000000 +0000
+++ pacman/lib/libalpm/Makefile.in	2012-10-15 18:12:22.933288983 +0000
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.11.4 from Makefile.am.
+# Makefile.in generated by automake 1.12 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -16,6 +16,7 @@
 @SET_MAKE@
 
 
+
 VPATH = @srcdir@
 am__make_dryrun = \
   { \
@@ -64,22 +65,25 @@
 
 subdir = lib/libalpm
 DIST_COMMON = $(include_HEADERS) $(srcdir)/Makefile.am \
-	$(srcdir)/Makefile.in
+	$(srcdir)/Makefile.in $(srcdir)/libalpm.pc.in \
+	$(top_srcdir)/build-aux/depcomp \
+	$(top_srcdir)/build-aux/mkinstalldirs
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/m4/gettext.m4 \
+am__aclocal_m4_deps = $(top_srcdir)/m4/acinclude.m4 \
+	$(top_srcdir)/m4/gettext.m4 $(top_srcdir)/m4/gpgme.m4 \
 	$(top_srcdir)/m4/iconv.m4 $(top_srcdir)/m4/intlmacosx.m4 \
 	$(top_srcdir)/m4/lib-ld.m4 $(top_srcdir)/m4/lib-link.m4 \
-	$(top_srcdir)/m4/lib-prefix.m4 $(top_srcdir)/m4/libcurl.m4 \
-	$(top_srcdir)/m4/libtool.m4 $(top_srcdir)/m4/ltoptions.m4 \
-	$(top_srcdir)/m4/ltsugar.m4 $(top_srcdir)/m4/ltversion.m4 \
-	$(top_srcdir)/m4/lt~obsolete.m4 $(top_srcdir)/m4/nls.m4 \
+	$(top_srcdir)/m4/lib-prefix.m4 $(top_srcdir)/m4/libtool.m4 \
+	$(top_srcdir)/m4/ltoptions.m4 $(top_srcdir)/m4/ltsugar.m4 \
+	$(top_srcdir)/m4/ltversion.m4 $(top_srcdir)/m4/lt~obsolete.m4 \
+	$(top_srcdir)/m4/nls.m4 $(top_srcdir)/m4/pkg.m4 \
 	$(top_srcdir)/m4/po.m4 $(top_srcdir)/m4/progtest.m4 \
-	$(top_srcdir)/acinclude.m4 $(top_srcdir)/configure.ac
+	$(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
-mkinstalldirs = $(SHELL) $(top_srcdir)/mkinstalldirs
+mkinstalldirs = $(SHELL) $(top_srcdir)/build-aux/mkinstalldirs
 CONFIG_HEADER = $(top_builddir)/config.h
-CONFIG_CLEAN_FILES =
+CONFIG_CLEAN_FILES = libalpm.pc
 CONFIG_CLEAN_VPATH_FILES =
 am__vpath_adj_setup = srcdirstrip=`echo "$(srcdir)" | sed 's|.|.|g'`;
 am__vpath_adj = case $$p in \
@@ -108,44 +112,70 @@
     || { echo " ( cd '$$dir' && rm -f" $$files ")"; \
          $(am__cd) "$$dir" && rm -f $$files; }; \
   }
-am__installdirs = "$(DESTDIR)$(libdir)" "$(DESTDIR)$(includedir)"
+am__installdirs = "$(DESTDIR)$(libdir)" "$(DESTDIR)$(pkgconfigdir)" \
+	"$(DESTDIR)$(includedir)"
 LTLIBRARIES = $(lib_LTLIBRARIES)
 am__DEPENDENCIES_1 =
-libalpm_la_DEPENDENCIES = $(am__DEPENDENCIES_1)
+libalpm_la_DEPENDENCIES = $(am__DEPENDENCIES_1) $(am__DEPENDENCIES_1) \
+	$(am__DEPENDENCIES_1) $(am__DEPENDENCIES_1) \
+	$(am__DEPENDENCIES_1)
 am__libalpm_la_SOURCES_DIST = add.h add.c alpm.h alpm.c alpm_list.h \
 	alpm_list.c backup.h backup.c be_local.c be_package.c \
 	be_sync.c conflict.h conflict.c db.h db.c delta.h delta.c \
 	deps.h deps.c diskspace.h diskspace.c dload.h dload.c error.c \
-	graph.h graph.c group.h group.c handle.h handle.c log.h log.c \
-	package.h package.c pkghash.h pkghash.c rawstr.c remove.h \
-	remove.c signing.c signing.h sync.h sync.c trans.h trans.c \
-	util.h util.c version.c md5.h md5.c sha2.h sha2.c base64.h \
-	base64.c
-@HAVE_LIBSSL_FALSE@am__objects_1 = md5.lo sha2.lo
-@HAVE_LIBGPGME_TRUE@am__objects_2 = base64.lo
-am_libalpm_la_OBJECTS = add.lo alpm.lo alpm_list.lo backup.lo \
-	be_local.lo be_package.lo be_sync.lo conflict.lo db.lo \
-	delta.lo deps.lo diskspace.lo dload.lo error.lo graph.lo \
-	group.lo handle.lo log.lo package.lo pkghash.lo rawstr.lo \
-	remove.lo signing.lo sync.lo trans.lo util.lo version.lo \
-	$(am__objects_1) $(am__objects_2)
+	filelist.h filelist.c graph.h graph.c group.h group.c handle.h \
+	handle.c log.h log.c package.h package.c pkghash.h pkghash.c \
+	rawstr.c remove.h remove.c signing.c signing.h sync.h sync.c \
+	trans.h trans.c util.h util.c version.c md5.h md5.c sha2.h \
+	sha2.c base64.h base64.c
+@HAVE_LIBSSL_FALSE@am__objects_1 = libalpm_la-md5.lo \
+@HAVE_LIBSSL_FALSE@	libalpm_la-sha2.lo
+@HAVE_LIBGPGME_TRUE@am__objects_2 = libalpm_la-base64.lo
+am_libalpm_la_OBJECTS = libalpm_la-add.lo libalpm_la-alpm.lo \
+	libalpm_la-alpm_list.lo libalpm_la-backup.lo \
+	libalpm_la-be_local.lo libalpm_la-be_package.lo \
+	libalpm_la-be_sync.lo libalpm_la-conflict.lo libalpm_la-db.lo \
+	libalpm_la-delta.lo libalpm_la-deps.lo libalpm_la-diskspace.lo \
+	libalpm_la-dload.lo libalpm_la-error.lo libalpm_la-filelist.lo \
+	libalpm_la-graph.lo libalpm_la-group.lo libalpm_la-handle.lo \
+	libalpm_la-log.lo libalpm_la-package.lo libalpm_la-pkghash.lo \
+	libalpm_la-rawstr.lo libalpm_la-remove.lo \
+	libalpm_la-signing.lo libalpm_la-sync.lo libalpm_la-trans.lo \
+	libalpm_la-util.lo libalpm_la-version.lo $(am__objects_1) \
+	$(am__objects_2)
 libalpm_la_OBJECTS = $(am_libalpm_la_OBJECTS)
-libalpm_la_LINK = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) \
-	$(LIBTOOLFLAGS) --mode=link $(CCLD) $(AM_CFLAGS) $(CFLAGS) \
-	$(libalpm_la_LDFLAGS) $(LDFLAGS) -o $@
+AM_V_lt = $(am__v_lt_@AM_V@)
+am__v_lt_ = $(am__v_lt_@AM_DEFAULT_V@)
+am__v_lt_0 = --silent
+libalpm_la_LINK = $(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) \
+	$(LIBTOOLFLAGS) --mode=link $(CCLD) $(libalpm_la_CFLAGS) \
+	$(CFLAGS) $(libalpm_la_LDFLAGS) $(LDFLAGS) -o $@
 DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
-depcomp = $(SHELL) $(top_srcdir)/depcomp
+depcomp = $(SHELL) $(top_srcdir)/build-aux/depcomp
 am__depfiles_maybe = depfiles
 am__mv = mv -f
 COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
 	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
-LTCOMPILE = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
-	--mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
-	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+LTCOMPILE = $(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) \
+	$(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) \
+	$(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) \
+	$(AM_CFLAGS) $(CFLAGS)
+AM_V_CC = $(am__v_CC_@AM_V@)
+am__v_CC_ = $(am__v_CC_@AM_DEFAULT_V@)
+am__v_CC_0 = @echo "  CC      " $@;
+AM_V_at = $(am__v_at_@AM_V@)
+am__v_at_ = $(am__v_at_@AM_DEFAULT_V@)
+am__v_at_0 = @
 CCLD = $(CC)
-LINK = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
-	--mode=link $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) \
-	$(LDFLAGS) -o $@
+LINK = $(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) \
+	$(LIBTOOLFLAGS) --mode=link $(CCLD) $(AM_CFLAGS) $(CFLAGS) \
+	$(AM_LDFLAGS) $(LDFLAGS) -o $@
+AM_V_CCLD = $(am__v_CCLD_@AM_V@)
+am__v_CCLD_ = $(am__v_CCLD_@AM_DEFAULT_V@)
+am__v_CCLD_0 = @echo "  CCLD    " $@;
+AM_V_GEN = $(am__v_GEN_@AM_V@)
+am__v_GEN_ = $(am__v_GEN_@AM_DEFAULT_V@)
+am__v_GEN_0 = @echo "  GEN     " $@;
 SOURCES = $(libalpm_la_SOURCES)
 DIST_SOURCES = $(am__libalpm_la_SOURCES_DIST)
 RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
@@ -160,6 +190,7 @@
     n|no|NO) false;; \
     *) (install-info --version) >/dev/null 2>&1;; \
   esac
+DATA = $(pkgconfig_DATA)
 HEADERS = $(include_HEADERS)
 RECURSIVE_CLEAN_TARGETS = mostlyclean-recursive clean-recursive	\
   distclean-recursive maintainer-clean-recursive
@@ -197,6 +228,7 @@
   reldir="$$dir2"
 ACLOCAL = @ACLOCAL@
 AMTAR = @AMTAR@
+AM_DEFAULT_VERBOSITY = @AM_DEFAULT_VERBOSITY@
 AR = @AR@
 ASCIIDOC = @ASCIIDOC@
 AUTOCONF = @AUTOCONF@
@@ -212,10 +244,6 @@
 CHOST = @CHOST@
 CPP = @CPP@
 CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXCPP = @CXXCPP@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
 CYGPATH_W = @CYGPATH_W@
 DEFS = -DLOCALEDIR=\"@localedir@\" @DEFS@
 DEPDIR = @DEPDIR@
@@ -234,7 +262,11 @@
 GIT = @GIT@
 GMSGFMT = @GMSGFMT@
 GMSGFMT_015 = @GMSGFMT_015@
+GPGME_CFLAGS = @GPGME_CFLAGS@
+GPGME_CONFIG = @GPGME_CONFIG@
+GPGME_LIBS = @GPGME_LIBS@
 GREP = @GREP@
+INODECMD = @INODECMD@
 INSTALL = @INSTALL@
 INSTALL_DATA = @INSTALL_DATA@
 INSTALL_PROGRAM = @INSTALL_PROGRAM@
@@ -244,12 +276,16 @@
 INTL_MACOSX_LIBS = @INTL_MACOSX_LIBS@
 LD = @LD@
 LDFLAGS = @LDFLAGS@
-LIBCURL = @LIBCURL@
-LIBCURL_CPPFLAGS = @LIBCURL_CPPFLAGS@
+LIBARCHIVE_CFLAGS = @LIBARCHIVE_CFLAGS@
+LIBARCHIVE_LIBS = @LIBARCHIVE_LIBS@
+LIBCURL_CFLAGS = @LIBCURL_CFLAGS@
+LIBCURL_LIBS = @LIBCURL_LIBS@
 LIBICONV = @LIBICONV@
 LIBINTL = @LIBINTL@
 LIBOBJS = @LIBOBJS@
 LIBS = @LIBS@
+LIBSSL_CFLAGS = @LIBSSL_CFLAGS@
+LIBSSL_LIBS = @LIBSSL_LIBS@
 LIBTOOL = @LIBTOOL@
 LIB_VERSION = @LIB_VERSION@
 LIB_VERSION_INFO = @LIB_VERSION_INFO@
@@ -279,10 +315,14 @@
 PACKAGE_VERSION = @PACKAGE_VERSION@
 PATH_SEPARATOR = @PATH_SEPARATOR@
 PKGEXT = @PKGEXT@
+PKG_CONFIG = @PKG_CONFIG@
+PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
+PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 POSUB = @POSUB@
 PYTHON = @PYTHON@
 RANLIB = @RANLIB@
 ROOTDIR = @ROOTDIR@
+SCRIPTLET_SHELL = @SCRIPTLET_SHELL@
 SED = @SED@
 SEDINPLACE = @SEDINPLACE@
 SET_MAKE = @SET_MAKE@
@@ -295,17 +335,16 @@
 STRIP_STATIC = @STRIP_STATIC@
 USE_NLS = @USE_NLS@
 VERSION = @VERSION@
+WARNING_CFLAGS = @WARNING_CFLAGS@
 XGETTEXT = @XGETTEXT@
 XGETTEXT_015 = @XGETTEXT_015@
 XGETTEXT_EXTRA_OPTIONS = @XGETTEXT_EXTRA_OPTIONS@
-_libcurl_config = @_libcurl_config@
 abs_builddir = @abs_builddir@
 abs_srcdir = @abs_srcdir@
 abs_top_builddir = @abs_top_builddir@
 abs_top_srcdir = @abs_top_srcdir@
 ac_ct_AR = @ac_ct_AR@
 ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
 ac_ct_DUMPBIN = @ac_ct_DUMPBIN@
 am__include = @am__include@
 am__leading_dot = @am__leading_dot@
@@ -356,18 +395,36 @@
 SUBDIRS = po
 lib_LTLIBRARIES = libalpm.la
 include_HEADERS = alpm_list.h alpm.h
-AM_CFLAGS = -pedantic -D_GNU_SOURCE $(am__append_1) $(am__append_2) \
-	$(am__append_3)
+AM_CPPFLAGS = \
+	-imacros $(top_builddir)/config.h
+
+AM_CFLAGS = -pedantic -D_GNU_SOURCE $(WARNING_CFLAGS) $(am__append_1) \
+	$(am__append_2) $(am__append_3)
+pkgconfigdir = $(libdir)/pkgconfig
+pkgconfig_DATA = libalpm.pc
 libalpm_la_SOURCES = add.h add.c alpm.h alpm.c alpm_list.h alpm_list.c \
 	backup.h backup.c be_local.c be_package.c be_sync.c conflict.h \
 	conflict.c db.h db.c delta.h delta.c deps.h deps.c diskspace.h \
-	diskspace.c dload.h dload.c error.c graph.h graph.c group.h \
-	group.c handle.h handle.c log.h log.c package.h package.c \
-	pkghash.h pkghash.c rawstr.c remove.h remove.c signing.c \
-	signing.h sync.h sync.c trans.h trans.c util.h util.c \
-	version.c $(am__append_4) $(am__append_5)
-libalpm_la_LDFLAGS = -no-undefined -version-info $(LIB_VERSION_INFO) @LIBCURL@
-libalpm_la_LIBADD = $(LTLIBINTL)
+	diskspace.c dload.h dload.c error.c filelist.h filelist.c \
+	graph.h graph.c group.h group.c handle.h handle.c log.h log.c \
+	package.h package.c pkghash.h pkghash.c rawstr.c remove.h \
+	remove.c signing.c signing.h sync.h sync.c trans.h trans.c \
+	util.h util.c version.c $(am__append_4) $(am__append_5)
+libalpm_la_LDFLAGS = -no-undefined -version-info $(LIB_VERSION_INFO)
+libalpm_la_CFLAGS = \
+	$(AM_CFLAGS) \
+	$(GPGME_CFLAGS) \
+	$(LIBARCHIVE_CFLAGS) \
+	$(LIBCURL_CFLAGS) \
+	$(LIBSSL_CFLAGS)
+
+libalpm_la_LIBADD = \
+	$(LTLIBINTL) \
+	$(GPGME_LIBS) \
+	$(LIBARCHIVE_LIBS) \
+	$(LIBCURL_LIBS) \
+	$(LIBSSL_LIBS)
+
 all: all-recursive
 
 .SUFFIXES:
@@ -402,6 +459,8 @@
 $(ACLOCAL_M4):  $(am__aclocal_m4_deps)
 	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
 $(am__aclocal_m4_deps):
+libalpm.pc: $(top_builddir)/config.status $(srcdir)/libalpm.pc.in
+	cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@
 install-libLTLIBRARIES: $(lib_LTLIBRARIES)
 	@$(NORMAL_INSTALL)
 	@list='$(lib_LTLIBRARIES)'; test -n "$(libdir)" || list=; \
@@ -412,7 +471,7 @@
 	done; \
 	test -z "$$list2" || { \
 	  echo " $(MKDIR_P) '$(DESTDIR)$(libdir)'"; \
-	  $(MKDIR_P) '$(DESTDIR)$(libdir)' || exit 1; \
+	  $(MKDIR_P) "$(DESTDIR)$(libdir)" || exit 1; \
 	  echo " $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(INSTALL) $(INSTALL_STRIP_FLAG) $$list2 '$(DESTDIR)$(libdir)'"; \
 	  $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(INSTALL) $(INSTALL_STRIP_FLAG) $$list2 "$(DESTDIR)$(libdir)"; \
 	}
@@ -428,14 +487,16 @@
 
 clean-libLTLIBRARIES:
 	-test -z "$(lib_LTLIBRARIES)" || rm -f $(lib_LTLIBRARIES)
-	@list='$(lib_LTLIBRARIES)'; for p in $$list; do \
-	  dir="`echo $$p | sed -e 's|/[^/]*$$||'`"; \
-	  test "$$dir" != "$$p" || dir=.; \
-	  echo "rm -f \"$${dir}/so_locations\""; \
-	  rm -f "$${dir}/so_locations"; \
-	done
+	@list='$(lib_LTLIBRARIES)'; \
+	locs=`for p in $$list; do echo $$p; done | \
+	      sed 's|^[^/]*$$|.|; s|/[^/]*$$||; s|$$|/so_locations|' | \
+	      sort -u`; \
+	test -z "$$locs" || { \
+	  echo rm -f $${locs}; \
+	  rm -f $${locs}; \
+	}
 libalpm.la: $(libalpm_la_OBJECTS) $(libalpm_la_DEPENDENCIES) $(EXTRA_libalpm_la_DEPENDENCIES) 
-	$(libalpm_la_LINK) -rpath $(libdir) $(libalpm_la_OBJECTS) $(libalpm_la_LIBADD) $(LIBS)
+	$(AM_V_CCLD)$(libalpm_la_LINK) -rpath $(libdir) $(libalpm_la_OBJECTS) $(libalpm_la_LIBADD) $(LIBS)
 
 mostlyclean-compile:
 	-rm -f *.$(OBJEXT)
@@ -443,69 +504,308 @@
 distclean-compile:
 	-rm -f *.tab.c
 
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/add.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/alpm.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/alpm_list.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/backup.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/base64.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/be_local.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/be_package.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/be_sync.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/conflict.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/db.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/delta.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/deps.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/diskspace.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dload.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/error.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/graph.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/group.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/handle.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/log.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/md5.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/package.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/pkghash.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/rawstr.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/remove.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/sha2.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/signing.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/sync.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/trans.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/util.Plo@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/version.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-add.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-alpm.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-alpm_list.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-backup.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-base64.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-be_local.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-be_package.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-be_sync.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-conflict.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-db.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-delta.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-deps.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-diskspace.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-dload.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-error.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-filelist.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-graph.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-group.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-handle.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-log.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-md5.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-package.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-pkghash.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-rawstr.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-remove.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-sha2.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-signing.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-sync.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-trans.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-util.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libalpm_la-version.Plo@am__quote@
 
 .c.o:
-@am__fastdepCC_TRUE@	$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
-@am__fastdepCC_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(COMPILE) -c $<
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c $<
 
 .c.obj:
-@am__fastdepCC_TRUE@	$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
-@am__fastdepCC_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(COMPILE) -c `$(CYGPATH_W) '$<'`
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c `$(CYGPATH_W) '$<'`
 
 .c.lo:
-@am__fastdepCC_TRUE@	$(LTCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
-@am__fastdepCC_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Plo
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='$<' object='$@' libtool=yes @AMDEPBACKSLASH@
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LTCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LTCOMPILE) -c -o $@ $<
+
+libalpm_la-add.lo: add.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-add.lo -MD -MP -MF $(DEPDIR)/libalpm_la-add.Tpo -c -o libalpm_la-add.lo `test -f 'add.c' || echo '$(srcdir)/'`add.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-add.Tpo $(DEPDIR)/libalpm_la-add.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='add.c' object='libalpm_la-add.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-add.lo `test -f 'add.c' || echo '$(srcdir)/'`add.c
+
+libalpm_la-alpm.lo: alpm.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-alpm.lo -MD -MP -MF $(DEPDIR)/libalpm_la-alpm.Tpo -c -o libalpm_la-alpm.lo `test -f 'alpm.c' || echo '$(srcdir)/'`alpm.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-alpm.Tpo $(DEPDIR)/libalpm_la-alpm.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='alpm.c' object='libalpm_la-alpm.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-alpm.lo `test -f 'alpm.c' || echo '$(srcdir)/'`alpm.c
+
+libalpm_la-alpm_list.lo: alpm_list.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-alpm_list.lo -MD -MP -MF $(DEPDIR)/libalpm_la-alpm_list.Tpo -c -o libalpm_la-alpm_list.lo `test -f 'alpm_list.c' || echo '$(srcdir)/'`alpm_list.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-alpm_list.Tpo $(DEPDIR)/libalpm_la-alpm_list.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='alpm_list.c' object='libalpm_la-alpm_list.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-alpm_list.lo `test -f 'alpm_list.c' || echo '$(srcdir)/'`alpm_list.c
+
+libalpm_la-backup.lo: backup.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-backup.lo -MD -MP -MF $(DEPDIR)/libalpm_la-backup.Tpo -c -o libalpm_la-backup.lo `test -f 'backup.c' || echo '$(srcdir)/'`backup.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-backup.Tpo $(DEPDIR)/libalpm_la-backup.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='backup.c' object='libalpm_la-backup.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-backup.lo `test -f 'backup.c' || echo '$(srcdir)/'`backup.c
+
+libalpm_la-be_local.lo: be_local.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-be_local.lo -MD -MP -MF $(DEPDIR)/libalpm_la-be_local.Tpo -c -o libalpm_la-be_local.lo `test -f 'be_local.c' || echo '$(srcdir)/'`be_local.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-be_local.Tpo $(DEPDIR)/libalpm_la-be_local.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='be_local.c' object='libalpm_la-be_local.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-be_local.lo `test -f 'be_local.c' || echo '$(srcdir)/'`be_local.c
+
+libalpm_la-be_package.lo: be_package.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-be_package.lo -MD -MP -MF $(DEPDIR)/libalpm_la-be_package.Tpo -c -o libalpm_la-be_package.lo `test -f 'be_package.c' || echo '$(srcdir)/'`be_package.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-be_package.Tpo $(DEPDIR)/libalpm_la-be_package.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='be_package.c' object='libalpm_la-be_package.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-be_package.lo `test -f 'be_package.c' || echo '$(srcdir)/'`be_package.c
+
+libalpm_la-be_sync.lo: be_sync.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-be_sync.lo -MD -MP -MF $(DEPDIR)/libalpm_la-be_sync.Tpo -c -o libalpm_la-be_sync.lo `test -f 'be_sync.c' || echo '$(srcdir)/'`be_sync.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-be_sync.Tpo $(DEPDIR)/libalpm_la-be_sync.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='be_sync.c' object='libalpm_la-be_sync.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-be_sync.lo `test -f 'be_sync.c' || echo '$(srcdir)/'`be_sync.c
+
+libalpm_la-conflict.lo: conflict.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-conflict.lo -MD -MP -MF $(DEPDIR)/libalpm_la-conflict.Tpo -c -o libalpm_la-conflict.lo `test -f 'conflict.c' || echo '$(srcdir)/'`conflict.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-conflict.Tpo $(DEPDIR)/libalpm_la-conflict.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='conflict.c' object='libalpm_la-conflict.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-conflict.lo `test -f 'conflict.c' || echo '$(srcdir)/'`conflict.c
+
+libalpm_la-db.lo: db.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-db.lo -MD -MP -MF $(DEPDIR)/libalpm_la-db.Tpo -c -o libalpm_la-db.lo `test -f 'db.c' || echo '$(srcdir)/'`db.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-db.Tpo $(DEPDIR)/libalpm_la-db.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='db.c' object='libalpm_la-db.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-db.lo `test -f 'db.c' || echo '$(srcdir)/'`db.c
+
+libalpm_la-delta.lo: delta.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-delta.lo -MD -MP -MF $(DEPDIR)/libalpm_la-delta.Tpo -c -o libalpm_la-delta.lo `test -f 'delta.c' || echo '$(srcdir)/'`delta.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-delta.Tpo $(DEPDIR)/libalpm_la-delta.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='delta.c' object='libalpm_la-delta.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-delta.lo `test -f 'delta.c' || echo '$(srcdir)/'`delta.c
+
+libalpm_la-deps.lo: deps.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-deps.lo -MD -MP -MF $(DEPDIR)/libalpm_la-deps.Tpo -c -o libalpm_la-deps.lo `test -f 'deps.c' || echo '$(srcdir)/'`deps.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-deps.Tpo $(DEPDIR)/libalpm_la-deps.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='deps.c' object='libalpm_la-deps.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-deps.lo `test -f 'deps.c' || echo '$(srcdir)/'`deps.c
+
+libalpm_la-diskspace.lo: diskspace.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-diskspace.lo -MD -MP -MF $(DEPDIR)/libalpm_la-diskspace.Tpo -c -o libalpm_la-diskspace.lo `test -f 'diskspace.c' || echo '$(srcdir)/'`diskspace.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-diskspace.Tpo $(DEPDIR)/libalpm_la-diskspace.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='diskspace.c' object='libalpm_la-diskspace.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-diskspace.lo `test -f 'diskspace.c' || echo '$(srcdir)/'`diskspace.c
+
+libalpm_la-dload.lo: dload.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-dload.lo -MD -MP -MF $(DEPDIR)/libalpm_la-dload.Tpo -c -o libalpm_la-dload.lo `test -f 'dload.c' || echo '$(srcdir)/'`dload.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-dload.Tpo $(DEPDIR)/libalpm_la-dload.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='dload.c' object='libalpm_la-dload.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-dload.lo `test -f 'dload.c' || echo '$(srcdir)/'`dload.c
+
+libalpm_la-error.lo: error.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-error.lo -MD -MP -MF $(DEPDIR)/libalpm_la-error.Tpo -c -o libalpm_la-error.lo `test -f 'error.c' || echo '$(srcdir)/'`error.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-error.Tpo $(DEPDIR)/libalpm_la-error.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='error.c' object='libalpm_la-error.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-error.lo `test -f 'error.c' || echo '$(srcdir)/'`error.c
+
+libalpm_la-filelist.lo: filelist.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-filelist.lo -MD -MP -MF $(DEPDIR)/libalpm_la-filelist.Tpo -c -o libalpm_la-filelist.lo `test -f 'filelist.c' || echo '$(srcdir)/'`filelist.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-filelist.Tpo $(DEPDIR)/libalpm_la-filelist.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='filelist.c' object='libalpm_la-filelist.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-filelist.lo `test -f 'filelist.c' || echo '$(srcdir)/'`filelist.c
+
+libalpm_la-graph.lo: graph.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-graph.lo -MD -MP -MF $(DEPDIR)/libalpm_la-graph.Tpo -c -o libalpm_la-graph.lo `test -f 'graph.c' || echo '$(srcdir)/'`graph.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-graph.Tpo $(DEPDIR)/libalpm_la-graph.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='graph.c' object='libalpm_la-graph.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-graph.lo `test -f 'graph.c' || echo '$(srcdir)/'`graph.c
+
+libalpm_la-group.lo: group.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-group.lo -MD -MP -MF $(DEPDIR)/libalpm_la-group.Tpo -c -o libalpm_la-group.lo `test -f 'group.c' || echo '$(srcdir)/'`group.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-group.Tpo $(DEPDIR)/libalpm_la-group.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='group.c' object='libalpm_la-group.lo' libtool=yes @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(LTCOMPILE) -c -o $@ $<
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-group.lo `test -f 'group.c' || echo '$(srcdir)/'`group.c
+
+libalpm_la-handle.lo: handle.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-handle.lo -MD -MP -MF $(DEPDIR)/libalpm_la-handle.Tpo -c -o libalpm_la-handle.lo `test -f 'handle.c' || echo '$(srcdir)/'`handle.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-handle.Tpo $(DEPDIR)/libalpm_la-handle.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='handle.c' object='libalpm_la-handle.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-handle.lo `test -f 'handle.c' || echo '$(srcdir)/'`handle.c
+
+libalpm_la-log.lo: log.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-log.lo -MD -MP -MF $(DEPDIR)/libalpm_la-log.Tpo -c -o libalpm_la-log.lo `test -f 'log.c' || echo '$(srcdir)/'`log.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-log.Tpo $(DEPDIR)/libalpm_la-log.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='log.c' object='libalpm_la-log.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-log.lo `test -f 'log.c' || echo '$(srcdir)/'`log.c
+
+libalpm_la-package.lo: package.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-package.lo -MD -MP -MF $(DEPDIR)/libalpm_la-package.Tpo -c -o libalpm_la-package.lo `test -f 'package.c' || echo '$(srcdir)/'`package.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-package.Tpo $(DEPDIR)/libalpm_la-package.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='package.c' object='libalpm_la-package.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-package.lo `test -f 'package.c' || echo '$(srcdir)/'`package.c
+
+libalpm_la-pkghash.lo: pkghash.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-pkghash.lo -MD -MP -MF $(DEPDIR)/libalpm_la-pkghash.Tpo -c -o libalpm_la-pkghash.lo `test -f 'pkghash.c' || echo '$(srcdir)/'`pkghash.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-pkghash.Tpo $(DEPDIR)/libalpm_la-pkghash.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='pkghash.c' object='libalpm_la-pkghash.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-pkghash.lo `test -f 'pkghash.c' || echo '$(srcdir)/'`pkghash.c
+
+libalpm_la-rawstr.lo: rawstr.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-rawstr.lo -MD -MP -MF $(DEPDIR)/libalpm_la-rawstr.Tpo -c -o libalpm_la-rawstr.lo `test -f 'rawstr.c' || echo '$(srcdir)/'`rawstr.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-rawstr.Tpo $(DEPDIR)/libalpm_la-rawstr.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='rawstr.c' object='libalpm_la-rawstr.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-rawstr.lo `test -f 'rawstr.c' || echo '$(srcdir)/'`rawstr.c
+
+libalpm_la-remove.lo: remove.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-remove.lo -MD -MP -MF $(DEPDIR)/libalpm_la-remove.Tpo -c -o libalpm_la-remove.lo `test -f 'remove.c' || echo '$(srcdir)/'`remove.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-remove.Tpo $(DEPDIR)/libalpm_la-remove.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='remove.c' object='libalpm_la-remove.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-remove.lo `test -f 'remove.c' || echo '$(srcdir)/'`remove.c
+
+libalpm_la-signing.lo: signing.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-signing.lo -MD -MP -MF $(DEPDIR)/libalpm_la-signing.Tpo -c -o libalpm_la-signing.lo `test -f 'signing.c' || echo '$(srcdir)/'`signing.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-signing.Tpo $(DEPDIR)/libalpm_la-signing.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='signing.c' object='libalpm_la-signing.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-signing.lo `test -f 'signing.c' || echo '$(srcdir)/'`signing.c
+
+libalpm_la-sync.lo: sync.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-sync.lo -MD -MP -MF $(DEPDIR)/libalpm_la-sync.Tpo -c -o libalpm_la-sync.lo `test -f 'sync.c' || echo '$(srcdir)/'`sync.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-sync.Tpo $(DEPDIR)/libalpm_la-sync.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='sync.c' object='libalpm_la-sync.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-sync.lo `test -f 'sync.c' || echo '$(srcdir)/'`sync.c
+
+libalpm_la-trans.lo: trans.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-trans.lo -MD -MP -MF $(DEPDIR)/libalpm_la-trans.Tpo -c -o libalpm_la-trans.lo `test -f 'trans.c' || echo '$(srcdir)/'`trans.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-trans.Tpo $(DEPDIR)/libalpm_la-trans.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='trans.c' object='libalpm_la-trans.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-trans.lo `test -f 'trans.c' || echo '$(srcdir)/'`trans.c
+
+libalpm_la-util.lo: util.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-util.lo -MD -MP -MF $(DEPDIR)/libalpm_la-util.Tpo -c -o libalpm_la-util.lo `test -f 'util.c' || echo '$(srcdir)/'`util.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-util.Tpo $(DEPDIR)/libalpm_la-util.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='util.c' object='libalpm_la-util.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-util.lo `test -f 'util.c' || echo '$(srcdir)/'`util.c
+
+libalpm_la-version.lo: version.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-version.lo -MD -MP -MF $(DEPDIR)/libalpm_la-version.Tpo -c -o libalpm_la-version.lo `test -f 'version.c' || echo '$(srcdir)/'`version.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-version.Tpo $(DEPDIR)/libalpm_la-version.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='version.c' object='libalpm_la-version.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-version.lo `test -f 'version.c' || echo '$(srcdir)/'`version.c
+
+libalpm_la-md5.lo: md5.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-md5.lo -MD -MP -MF $(DEPDIR)/libalpm_la-md5.Tpo -c -o libalpm_la-md5.lo `test -f 'md5.c' || echo '$(srcdir)/'`md5.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-md5.Tpo $(DEPDIR)/libalpm_la-md5.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='md5.c' object='libalpm_la-md5.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-md5.lo `test -f 'md5.c' || echo '$(srcdir)/'`md5.c
+
+libalpm_la-sha2.lo: sha2.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-sha2.lo -MD -MP -MF $(DEPDIR)/libalpm_la-sha2.Tpo -c -o libalpm_la-sha2.lo `test -f 'sha2.c' || echo '$(srcdir)/'`sha2.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-sha2.Tpo $(DEPDIR)/libalpm_la-sha2.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='sha2.c' object='libalpm_la-sha2.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-sha2.lo `test -f 'sha2.c' || echo '$(srcdir)/'`sha2.c
+
+libalpm_la-base64.lo: base64.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -MT libalpm_la-base64.lo -MD -MP -MF $(DEPDIR)/libalpm_la-base64.Tpo -c -o libalpm_la-base64.lo `test -f 'base64.c' || echo '$(srcdir)/'`base64.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libalpm_la-base64.Tpo $(DEPDIR)/libalpm_la-base64.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='base64.c' object='libalpm_la-base64.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libalpm_la_CFLAGS) $(CFLAGS) -c -o libalpm_la-base64.lo `test -f 'base64.c' || echo '$(srcdir)/'`base64.c
 
 mostlyclean-libtool:
 	-rm -f *.lo
 
 clean-libtool:
 	-rm -rf .libs _libs
+install-pkgconfigDATA: $(pkgconfig_DATA)
+	@$(NORMAL_INSTALL)
+	@list='$(pkgconfig_DATA)'; test -n "$(pkgconfigdir)" || list=; \
+	if test -n "$$list"; then \
+	  echo " $(MKDIR_P) '$(DESTDIR)$(pkgconfigdir)'"; \
+	  $(MKDIR_P) "$(DESTDIR)$(pkgconfigdir)" || exit 1; \
+	fi; \
+	for p in $$list; do \
+	  if test -f "$$p"; then d=; else d="$(srcdir)/"; fi; \
+	  echo "$$d$$p"; \
+	done | $(am__base_list) | \
+	while read files; do \
+	  echo " $(INSTALL_DATA) $$files '$(DESTDIR)$(pkgconfigdir)'"; \
+	  $(INSTALL_DATA) $$files "$(DESTDIR)$(pkgconfigdir)" || exit $$?; \
+	done
+
+uninstall-pkgconfigDATA:
+	@$(NORMAL_UNINSTALL)
+	@list='$(pkgconfig_DATA)'; test -n "$(pkgconfigdir)" || list=; \
+	files=`for p in $$list; do echo $$p; done | sed -e 's|^.*/||'`; \
+	dir='$(DESTDIR)$(pkgconfigdir)'; $(am__uninstall_files_from_dir)
 install-includeHEADERS: $(include_HEADERS)
 	@$(NORMAL_INSTALL)
 	@list='$(include_HEADERS)'; test -n "$(includedir)" || list=; \
 	if test -n "$$list"; then \
 	  echo " $(MKDIR_P) '$(DESTDIR)$(includedir)'"; \
-	  $(MKDIR_P) '$(DESTDIR)$(includedir)' || exit 1; \
+	  $(MKDIR_P) "$(DESTDIR)$(includedir)" || exit 1; \
 	fi; \
 	for p in $$list; do \
 	  if test -f "$$p"; then d=; else d="$(srcdir)/"; fi; \
@@ -523,11 +823,11 @@
 	dir='$(DESTDIR)$(includedir)'; $(am__uninstall_files_from_dir)
 
 # This directory's subdirectories are mostly independent; you can cd
-# into them and run `make' without going through this Makefile.
-# To change the values of `make' variables: instead of editing Makefiles,
-# (1) if the variable is set in `config.status', edit `config.status'
-#     (which will cause the Makefiles to be regenerated when you run `make');
-# (2) otherwise, pass the desired values on the `make' command line.
+# into them and run 'make' without going through this Makefile.
+# To change the values of 'make' variables: instead of editing Makefiles,
+# (1) if the variable is set in 'config.status', edit 'config.status'
+#     (which will cause the Makefiles to be regenerated when you run 'make');
+# (2) otherwise, pass the desired values on the 'make' command line.
 $(RECURSIVE_TARGETS):
 	@fail= failcom='exit 1'; \
 	for f in x $$MAKEFLAGS; do \
@@ -591,6 +891,10 @@
 	list='$(SUBDIRS)'; for subdir in $$list; do \
 	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) ctags); \
 	done
+cscopelist-recursive:
+	list='$(SUBDIRS)'; for subdir in $$list; do \
+	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) cscopelist); \
+	done
 
 ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
 	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
@@ -654,6 +958,20 @@
 	  && $(am__cd) $(top_srcdir) \
 	  && gtags -i $(GTAGS_ARGS) "$$here"
 
+cscopelist: cscopelist-recursive $(HEADERS) $(SOURCES) $(LISP)
+	list='$(SOURCES) $(HEADERS) $(LISP)'; \
+	case "$(srcdir)" in \
+	  [\\/]* | ?:[\\/]*) sdir="$(srcdir)" ;; \
+	  *) sdir=$(subdir)/$(srcdir) ;; \
+	esac; \
+	for i in $$list; do \
+	  if test -f "$$i"; then \
+	    echo "$(subdir)/$$i"; \
+	  else \
+	    echo "$$sdir/$$i"; \
+	  fi; \
+	done >> $(top_builddir)/cscope.files
+
 distclean-tags:
 	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
 
@@ -714,10 +1032,10 @@
 	done
 check-am: all-am
 check: check-recursive
-all-am: Makefile $(LTLIBRARIES) $(HEADERS)
+all-am: Makefile $(LTLIBRARIES) $(DATA) $(HEADERS)
 installdirs: installdirs-recursive
 installdirs-am:
-	for dir in "$(DESTDIR)$(libdir)" "$(DESTDIR)$(includedir)"; do \
+	for dir in "$(DESTDIR)$(libdir)" "$(DESTDIR)$(pkgconfigdir)" "$(DESTDIR)$(includedir)"; do \
 	  test -z "$$dir" || $(MKDIR_P) "$$dir"; \
 	done
 install: install-recursive
@@ -773,7 +1091,7 @@
 
 info-am:
 
-install-data-am: install-includeHEADERS
+install-data-am: install-includeHEADERS install-pkgconfigDATA
 
 install-dvi: install-dvi-recursive
 
@@ -819,27 +1137,30 @@
 
 ps-am:
 
-uninstall-am: uninstall-includeHEADERS uninstall-libLTLIBRARIES
+uninstall-am: uninstall-includeHEADERS uninstall-libLTLIBRARIES \
+	uninstall-pkgconfigDATA
 
-.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) ctags-recursive \
-	install-am install-strip tags-recursive
+.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) \
+	cscopelist-recursive ctags-recursive install-am install-strip \
+	tags-recursive
 
 .PHONY: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) CTAGS GTAGS \
 	all all-am check check-am clean clean-generic \
-	clean-libLTLIBRARIES clean-libtool ctags ctags-recursive \
-	distclean distclean-compile distclean-generic \
-	distclean-libtool distclean-tags distdir dvi dvi-am html \
-	html-am info info-am install install-am install-data \
-	install-data-am install-dvi install-dvi-am install-exec \
-	install-exec-am install-html install-html-am \
-	install-includeHEADERS install-info install-info-am \
-	install-libLTLIBRARIES install-man install-pdf install-pdf-am \
-	install-ps install-ps-am install-strip installcheck \
-	installcheck-am installdirs installdirs-am maintainer-clean \
-	maintainer-clean-generic mostlyclean mostlyclean-compile \
-	mostlyclean-generic mostlyclean-libtool pdf pdf-am ps ps-am \
-	tags tags-recursive uninstall uninstall-am \
-	uninstall-includeHEADERS uninstall-libLTLIBRARIES
+	clean-libLTLIBRARIES clean-libtool cscopelist \
+	cscopelist-recursive ctags ctags-recursive distclean \
+	distclean-compile distclean-generic distclean-libtool \
+	distclean-tags distdir dvi dvi-am html html-am info info-am \
+	install install-am install-data install-data-am install-dvi \
+	install-dvi-am install-exec install-exec-am install-html \
+	install-html-am install-includeHEADERS install-info \
+	install-info-am install-libLTLIBRARIES install-man install-pdf \
+	install-pdf-am install-pkgconfigDATA install-ps install-ps-am \
+	install-strip installcheck installcheck-am installdirs \
+	installdirs-am maintainer-clean maintainer-clean-generic \
+	mostlyclean mostlyclean-compile mostlyclean-generic \
+	mostlyclean-libtool pdf pdf-am ps ps-am tags tags-recursive \
+	uninstall uninstall-am uninstall-includeHEADERS \
+	uninstall-libLTLIBRARIES uninstall-pkgconfigDATA
 
 
 # vim:set ts=2 sw=2 noet:
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/add.c pacman/lib/libalpm/add.c
--- pacman-4.0.3/lib/libalpm/add.c	2011-10-27 19:38:51.000000000 +0000
+++ pacman/lib/libalpm/add.c	2012-10-15 18:11:52.481286991 +0000
@@ -1,7 +1,7 @@
 /*
  *  add.c
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -18,19 +18,15 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <stdlib.h>
 #include <errno.h>
-#include <time.h>
 #include <string.h>
 #include <limits.h>
 #include <fcntl.h>
 #include <sys/types.h>
 #include <sys/stat.h>
 #include <unistd.h>
-#include <inttypes.h> /* int64_t */
-#include <stdint.h> /* intmax_t */
+#include <stdint.h> /* int64_t */
 
 /* libarchive */
 #include <archive.h>
@@ -132,6 +128,18 @@
 	return 0;
 }
 
+static int try_rename(alpm_handle_t *handle, const char *src, const char *dest)
+{
+	if(rename(src, dest)) {
+		_alpm_log(handle, ALPM_LOG_ERROR, _("could not rename %s to %s (%s)\n"),
+				src, dest, strerror(errno));
+		alpm_logaction(handle, "error: could not rename %s to %s (%s)\n",
+				src, dest, strerror(errno));
+		return 1;
+	}
+	return 0;
+}
+
 static int extract_single_file(alpm_handle_t *handle, struct archive *archive,
 		struct archive_entry *entry, alpm_pkg_t *newpkg, alpm_pkg_t *oldpkg)
 {
@@ -146,8 +154,6 @@
 	entryname = archive_entry_pathname(entry);
 	entrymode = archive_entry_mode(entry);
 
-	memset(filename, 0, PATH_MAX); /* just to be sure */
-
 	if(strcmp(entryname, ".INSTALL") == 0) {
 		/* the install script goes inside the db */
 		snprintf(filename, PATH_MAX, "%s%s-%s/install",
@@ -170,7 +176,7 @@
 	}
 
 	/* if a file is in NoExtract then we never extract it */
-	if(alpm_list_find_str(handle->noextract, entryname)) {
+	if(alpm_list_find(handle->noextract, entryname, _alpm_fnmatch)) {
 		_alpm_log(handle, ALPM_LOG_DEBUG, "%s is in NoExtract, skipping extraction\n",
 				entryname);
 		alpm_logaction(handle, "note: %s is in NoExtract, skipping extraction\n",
@@ -250,7 +256,7 @@
 		} else if(S_ISREG(entrymode)) {
 			/* case 4,7: */
 			/* if file is in NoUpgrade, don't touch it */
-			if(alpm_list_find_str(handle->noupgrade, entryname)) {
+			if(alpm_list_find(handle->noupgrade, entryname, _alpm_fnmatch)) {
 				notouch = 1;
 			} else {
 				alpm_backup_t *backup;
@@ -282,17 +288,18 @@
 	STRDUP(entryname_orig, entryname, RET_ERR(handle, ALPM_ERR_MEMORY, -1));
 
 	if(needbackup) {
-		char checkfile[PATH_MAX];
+		char *checkfile;
 		char *hash_local = NULL, *hash_pkg = NULL;
-		int ret;
+		size_t len;
 
-		snprintf(checkfile, PATH_MAX, "%s.paccheck", filename);
-
-		ret = perform_extraction(handle, archive, entry, checkfile, entryname_orig);
-		if(ret == 1) {
-			/* error */
-			FREE(entryname_orig);
-			return 1;
+		len = strlen(filename) + 10;
+		MALLOC(checkfile, len,
+				errors++; handle->pm_errno = ALPM_ERR_MEMORY; goto needbackup_cleanup);
+		snprintf(checkfile, len, "%s.paccheck", filename);
+
+		if(perform_extraction(handle, archive, entry, checkfile, entryname_orig)) {
+			errors++;
+			goto needbackup_cleanup;
 		}
 
 		hash_local = alpm_compute_md5sum(filename);
@@ -320,29 +327,26 @@
 			if(hash_local && hash_pkg && strcmp(hash_local, hash_pkg) != 0) {
 				/* looks like we have a local file that has a different hash as the
 				 * file in the package, move it to a .pacorig */
-				char newpath[PATH_MAX];
-				snprintf(newpath, PATH_MAX, "%s.pacorig", filename);
+				char *newpath;
+				size_t newlen = strlen(filename) + 9;
+				MALLOC(newpath, newlen,
+						errors++; handle->pm_errno = ALPM_ERR_MEMORY; goto needbackup_cleanup);
+				snprintf(newpath, newlen, "%s.pacorig", filename);
 
 				/* move the existing file to the "pacorig" */
-				if(rename(filename, newpath)) {
-					_alpm_log(handle, ALPM_LOG_ERROR, _("could not rename %s to %s (%s)\n"),
-							filename, newpath, strerror(errno));
-					alpm_logaction(handle, "error: could not rename %s to %s (%s)\n",
-							filename, newpath, strerror(errno));
+				if(try_rename(handle, filename, newpath)) {
+						errors++;
 					errors++;
 				} else {
 					/* rename the file we extracted to the real name */
-					if(rename(checkfile, filename)) {
-						_alpm_log(handle, ALPM_LOG_ERROR, _("could not rename %s to %s (%s)\n"),
-								checkfile, filename, strerror(errno));
-						alpm_logaction(handle, "error: could not rename %s to %s (%s)\n",
-								checkfile, filename, strerror(errno));
+					if(try_rename(handle, checkfile, filename)) {
 						errors++;
 					} else {
 						_alpm_log(handle, ALPM_LOG_WARNING, _("%s saved as %s\n"), filename, newpath);
 						alpm_logaction(handle, "warning: %s saved as %s\n", filename, newpath);
 					}
 				}
+				free(newpath);
 			} else {
 				/* local file is identical to pkg one, so just remove pkg one */
 				unlink(checkfile);
@@ -356,11 +360,7 @@
 					_alpm_log(handle, ALPM_LOG_DEBUG, "action: installing new file: %s\n",
 							entryname_orig);
 
-					if(rename(checkfile, filename)) {
-						_alpm_log(handle, ALPM_LOG_ERROR, _("could not rename %s to %s (%s)\n"),
-								checkfile, filename, strerror(errno));
-						alpm_logaction(handle, "error: could not rename %s to %s (%s)\n",
-								checkfile, filename, strerror(errno));
+					if(try_rename(handle, checkfile, filename)) {
 						errors++;
 					}
 				} else {
@@ -382,29 +382,30 @@
 				_alpm_log(handle, ALPM_LOG_DEBUG, "action: leaving existing file in place\n");
 				unlink(checkfile);
 			} else {
-				char newpath[PATH_MAX];
+				char *newpath;
+				size_t newlen = strlen(filename) + 8;
 				_alpm_log(handle, ALPM_LOG_DEBUG, "action: keeping current file and installing"
 						" new one with .pacnew ending\n");
-				snprintf(newpath, PATH_MAX, "%s.pacnew", filename);
-				if(rename(checkfile, newpath)) {
-					_alpm_log(handle, ALPM_LOG_ERROR, _("could not install %s as %s (%s)\n"),
-							filename, newpath, strerror(errno));
-					alpm_logaction(handle, "error: could not install %s as %s (%s)\n",
-							filename, newpath, strerror(errno));
+				MALLOC(newpath, newlen,
+						errors++; handle->pm_errno = ALPM_ERR_MEMORY; goto needbackup_cleanup);
+				snprintf(newpath, newlen, "%s.pacnew", filename);
+				if(try_rename(handle, checkfile, newpath)) {
+					errors++;
 				} else {
 					_alpm_log(handle, ALPM_LOG_WARNING, _("%s installed as %s\n"),
 							filename, newpath);
 					alpm_logaction(handle, "warning: %s installed as %s\n",
 							filename, newpath);
 				}
+				free(newpath);
 			}
 		}
 
-		FREE(hash_local);
-		FREE(hash_pkg);
+needbackup_cleanup:
+		free(checkfile);
+		free(hash_local);
+		free(hash_pkg);
 	} else {
-		int ret;
-
 		/* we didn't need a backup */
 		if(notouch) {
 			/* change the path to a .pacnew extension */
@@ -423,11 +424,11 @@
 			unlink(filename);
 		}
 
-		ret = perform_extraction(handle, archive, entry, filename, entryname_orig);
-		if(ret == 1) {
+		if(perform_extraction(handle, archive, entry, filename, entryname_orig)) {
 			/* error */
-			FREE(entryname_orig);
-			return 1;
+			free(entryname_orig);
+			errors++;
+			return errors;
 		}
 
 		/* calculate an hash if this is in newpkg's backup */
@@ -444,7 +445,7 @@
 			backup->hash = newhash;
 		}
 	}
-	FREE(entryname_orig);
+	free(entryname_orig);
 	return errors;
 }
 
@@ -488,8 +489,9 @@
 	if(alpm_pkg_has_scriptlet(newpkg) &&
 			!(trans->flags & ALPM_TRANS_FLAG_NOSCRIPTLET)) {
 		const char *scriptlet_name = is_upgrade ? "pre_upgrade" : "pre_install";
-		_alpm_runscriptlet(handle, pkgfile,
-				scriptlet_name, newpkg->version, NULL, 1);
+
+		_alpm_runscriptlet(handle, pkgfile, scriptlet_name,
+				newpkg->version, oldpkg ? oldpkg->version : NULL, 1);
 	}
 
 	/* we override any pre-set reason if we have alldeps or allexplicit set */
@@ -521,31 +523,20 @@
 	if(!(trans->flags & ALPM_TRANS_FLAG_DBONLY)) {
 		struct archive *archive;
 		struct archive_entry *entry;
-		int cwdfd;
+		struct stat buf;
+		int fd, cwdfd;
 
 		_alpm_log(handle, ALPM_LOG_DEBUG, "extracting files\n");
 
-		if((archive = archive_read_new()) == NULL) {
-			handle->pm_errno = ALPM_ERR_LIBARCHIVE;
-			ret = -1;
-			goto cleanup;
-		}
-
-		archive_read_support_compression_all(archive);
-		archive_read_support_format_all(archive);
-
-		_alpm_log(handle, ALPM_LOG_DEBUG, "archive: %s\n", pkgfile);
-		if(archive_read_open_filename(archive, pkgfile,
-					ALPM_BUFFER_SIZE) != ARCHIVE_OK) {
-			handle->pm_errno = ALPM_ERR_PKG_OPEN;
+		fd = _alpm_open_archive(db->handle, pkgfile, &buf,
+				&archive, ALPM_ERR_PKG_OPEN);
+		if(fd < 0) {
 			ret = -1;
 			goto cleanup;
 		}
 
 		/* save the cwd so we can restore it later */
-		do {
-			cwdfd = open(".", O_RDONLY);
-		} while(cwdfd == -1 && errno == EINTR);
+		OPEN(cwdfd, ".", O_RDONLY);
 		if(cwdfd < 0) {
 			_alpm_log(handle, ALPM_LOG_ERROR, _("could not get current working directory\n"));
 		}
@@ -554,6 +545,8 @@
 		if(chdir(handle->root) != 0) {
 			_alpm_log(handle, ALPM_LOG_ERROR, _("could not change directory to %s (%s)\n"),
 					handle->root, strerror(errno));
+			archive_read_finish(archive);
+			CLOSE(fd);
 			ret = -1;
 			goto cleanup;
 		}
@@ -595,6 +588,7 @@
 			errors += extract_single_file(handle, archive, entry, newpkg, oldpkg);
 		}
 		archive_read_finish(archive);
+		CLOSE(fd);
 
 		/* restore the old cwd if we have it */
 		if(cwdfd >= 0) {
@@ -602,7 +596,7 @@
 				_alpm_log(handle, ALPM_LOG_ERROR,
 						_("could not restore working directory (%s)\n"), strerror(errno));
 			}
-			close(cwdfd);
+			CLOSE(cwdfd);
 		}
 
 		if(errors) {
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/add.h pacman/lib/libalpm/add.h
--- pacman-4.0.3/lib/libalpm/add.h	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/add.h	2012-10-15 18:11:52.481286991 +0000
@@ -1,7 +1,7 @@
 /*
  *  add.h
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/alpm.c pacman/lib/libalpm/alpm.c
--- pacman-4.0.3/lib/libalpm/alpm.c	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/alpm.c	2012-10-15 18:11:52.481286991 +0000
@@ -1,7 +1,7 @@
 /*
  *  alpm.c
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *  Copyright (c) 2005 by Aurelien Foret <orelien@chez.com>
  *  Copyright (c) 2005 by Christian Hamar <krics@linuxforum.hu>
@@ -21,8 +21,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #ifdef HAVE_LIBCURL
 #include <curl/curl.h>
 #endif
@@ -47,9 +45,9 @@
  * @return a context handle on success, NULL on error, err will be set if provided
  */
 alpm_handle_t SYMEXPORT *alpm_initialize(const char *root, const char *dbpath,
-		enum _alpm_errno_t *err)
+		alpm_errno_t *err)
 {
-	enum _alpm_errno_t myerr;
+	alpm_errno_t myerr;
 	const char *lf = "db.lck";
 	size_t lockfilelen;
 	alpm_handle_t *myhandle = _alpm_handle_new();
@@ -108,7 +106,7 @@
 		myhandle->db_local = NULL;
 	}
 
-	if(alpm_db_unregister_all(myhandle) == -1) {
+	if(alpm_unregister_all_syncdbs(myhandle) == -1) {
 		ret = -1;
 	}
 
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/alpm.h pacman/lib/libalpm/alpm.h
--- pacman-4.0.3/lib/libalpm/alpm.h	2012-02-07 04:09:10.000000000 +0000
+++ pacman/lib/libalpm/alpm.h	2012-10-15 18:11:52.481286991 +0000
@@ -1,7 +1,7 @@
 /*
  * alpm.h
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *  Copyright (c) 2005 by Aurelien Foret <orelien@chez.com>
  *  Copyright (c) 2005 by Christian Hamar <krics@linuxforum.hu>
@@ -27,14 +27,12 @@
 extern "C" {
 #endif
 
-#include <sys/types.h> /* for off_t */
-#include <time.h> /* for time_t */
-#include <stdarg.h> /* for va_list */
+#include <stdint.h>    /* int64_t */
+#include <sys/types.h> /* off_t */
+#include <stdarg.h>    /* va_list */
 
 #include <alpm_list.h>
 
-#define DEPRECATED __attribute__((deprecated))
-
 /*
  * Arch Linux Package Management library
  */
@@ -44,15 +42,14 @@
  * @{
  */
 
+typedef int64_t alpm_time_t;
+
 /*
  * Enumerations
  * These ones are used in multiple contexts, so are forward-declared.
  */
 
-/**
- * Install reasons.
- * Why the package was installed.
- */
+/** Package install reasons. */
 typedef enum _alpm_pkgreason_t {
 	/** Explicitly requested by the user. */
 	ALPM_PKG_REASON_EXPLICIT = 0,
@@ -60,12 +57,22 @@
 	ALPM_PKG_REASON_DEPEND = 1
 } alpm_pkgreason_t;
 
+/** Location a package object was loaded from. */
 typedef enum _alpm_pkgfrom_t {
-	PKG_FROM_FILE = 1,
-	PKG_FROM_LOCALDB,
-	PKG_FROM_SYNCDB
+	ALPM_PKG_FROM_FILE = 1,
+	ALPM_PKG_FROM_LOCALDB,
+	ALPM_PKG_FROM_SYNCDB
 } alpm_pkgfrom_t;
 
+/** Location a package object was loaded from. */
+typedef enum _alpm_pkgvalidation_t {
+	ALPM_PKG_VALIDATION_UNKNOWN = 0,
+	ALPM_PKG_VALIDATION_NONE = (1 << 0),
+	ALPM_PKG_VALIDATION_MD5SUM = (1 << 1),
+	ALPM_PKG_VALIDATION_SHA256SUM = (1 << 2),
+	ALPM_PKG_VALIDATION_SIGNATURE = (1 << 3)
+} alpm_pkgvalidation_t;
+
 /** Types of version constraints in dependency specs. */
 typedef enum _alpm_depmod_t {
   /** No version constraint */
@@ -92,9 +99,7 @@
 	ALPM_FILECONFLICT_FILESYSTEM
 } alpm_fileconflicttype_t;
 
-/**
- * PGP signature verification options
- */
+/** PGP signature verification options */
 typedef enum _alpm_siglevel_t {
 	ALPM_SIG_PACKAGE = (1 << 0),
 	ALPM_SIG_PACKAGE_OPTIONAL = (1 << 1),
@@ -109,9 +114,7 @@
 	ALPM_SIG_USE_DEFAULT = (1 << 31)
 } alpm_siglevel_t;
 
-/**
- * PGP signature verification status return codes
- */
+/** PGP signature verification status return codes */
 typedef enum _alpm_sigstatus_t {
 	ALPM_SIGSTATUS_VALID,
 	ALPM_SIGSTATUS_KEY_EXPIRED,
@@ -121,9 +124,7 @@
 	ALPM_SIGSTATUS_INVALID
 } alpm_sigstatus_t;
 
-/**
- * PGP signature verification status return codes
- */
+/** PGP signature verification status return codes */
 typedef enum _alpm_sigvalidity_t {
 	ALPM_SIGVALIDITY_FULL,
 	ALPM_SIGVALIDITY_MARGINAL,
@@ -144,6 +145,7 @@
 typedef struct _alpm_depend_t {
 	char *name;
 	char *version;
+	char *desc;
 	unsigned long name_hash;
 	alpm_depmod_t mod;
 } alpm_depend_t;
@@ -152,7 +154,7 @@
 typedef struct _alpm_depmissing_t {
 	char *target;
 	alpm_depend_t *depend;
-	/* this is used in case of remove dependency error only */
+	/* this is used only in the case of a remove dependency error */
 	char *causingpkg;
 } alpm_depmissing_t;
 
@@ -222,11 +224,15 @@
 	char *uid;
 	char *name;
 	char *email;
-	time_t created;
-	time_t expires;
+	alpm_time_t created;
+	alpm_time_t expires;
+	unsigned int length;
+	unsigned int revoked;
+	char pubkey_algo;
 } alpm_pgpkey_t;
 
-/** Signature result. Contains the key, status, and validity of a given
+/**
+ * Signature result. Contains the key, status, and validity of a given
  * signature.
  */
 typedef struct _alpm_sigresult_t {
@@ -235,7 +241,8 @@
 	alpm_sigvalidity_t validity;
 } alpm_sigresult_t;
 
-/** Signature list. Contains the number of signatures found and a pointer to an
+/**
+ * Signature list. Contains the number of signatures found and a pointer to an
  * array of results.  The array is of size count.
  */
 typedef struct _alpm_siglist_t {
@@ -247,9 +254,7 @@
  * Logging facilities
  */
 
-/**
- * Logging Levels
- */
+/** Logging Levels */
 typedef enum _alpm_loglevel_t {
 	ALPM_LOG_ERROR    = 1,
 	ALPM_LOG_WARNING  = (1 << 1),
@@ -260,7 +265,8 @@
 typedef void (*alpm_cb_log)(alpm_loglevel_t, const char *, va_list);
 int alpm_logaction(alpm_handle_t *handle, const char *fmt, ...);
 
-/** Events.
+/**
+ * Events.
  * NULL parameters are passed to in all events unless specified otherwise.
  */
 typedef enum _alpm_event_t {
@@ -341,13 +347,18 @@
 	/** Disk space usage will be computed for a package */
 	ALPM_EVENT_DISKSPACE_START,
 	/** Disk space usage was computed for a package */
-	ALPM_EVENT_DISKSPACE_DONE,
+	ALPM_EVENT_DISKSPACE_DONE
 } alpm_event_t;
 
 /** Event callback */
 typedef void (*alpm_cb_event)(alpm_event_t, void *, void *);
 
-/** Questions */
+/**
+ * Questions.
+ * Unlike the events or progress enumerations, this enum has bitmask values
+ * so a frontend can use a bitmask map to supply preselected answers to the
+ * different types of questions.
+ */
 typedef enum _alpm_question_t {
 	ALPM_QUESTION_INSTALL_IGNOREPKG = 1,
 	ALPM_QUESTION_REPLACE_PKG = (1 << 1),
@@ -370,7 +381,7 @@
 	ALPM_PROGRESS_CONFLICTS_START,
 	ALPM_PROGRESS_DISKSPACE_START,
 	ALPM_PROGRESS_INTEGRITY_START,
-	ALPM_PROGRESS_LOAD_START,
+	ALPM_PROGRESS_LOAD_START
 } alpm_progress_t;
 
 /** Progress callback */
@@ -530,8 +541,8 @@
 /** Sets the targeted architecture. */
 int alpm_option_set_arch(alpm_handle_t *handle, const char *arch);
 
-int alpm_option_get_usedelta(alpm_handle_t *handle);
-int alpm_option_set_usedelta(alpm_handle_t *handle, int usedelta);
+double alpm_option_get_deltaratio(alpm_handle_t *handle);
+int alpm_option_set_deltaratio(alpm_handle_t *handle, double ratio);
 
 int alpm_option_get_checkspace(alpm_handle_t *handle);
 int alpm_option_set_checkspace(alpm_handle_t *handle, int checkspace);
@@ -552,7 +563,7 @@
  * libalpm functions.
  * @return a reference to the local database
  */
-alpm_db_t *alpm_option_get_localdb(alpm_handle_t *handle);
+alpm_db_t *alpm_get_localdb(alpm_handle_t *handle);
 
 /** Get the list of sync databases.
  * Returns a list of alpm_db_t structures, one for each registered
@@ -560,7 +571,7 @@
  * @param handle the context handle
  * @return a reference to an internal list of alpm_db_t structures
  */
-alpm_list_t *alpm_option_get_syncdbs(alpm_handle_t *handle);
+alpm_list_t *alpm_get_syncdbs(alpm_handle_t *handle);
 
 /** Register a sync database of packages.
  * @param handle the context handle
@@ -569,20 +580,20 @@
  * database; note that this must be a '.sig' file type verification
  * @return an alpm_db_t* on success (the value), NULL on error
  */
-alpm_db_t *alpm_db_register_sync(alpm_handle_t *handle, const char *treename,
+alpm_db_t *alpm_register_syncdb(alpm_handle_t *handle, const char *treename,
 		alpm_siglevel_t level);
 
-/** Unregister a package database.
- * @param db pointer to the package database to unregister
+/** Unregister all package databases.
+ * @param handle the context handle
  * @return 0 on success, -1 on error (pm_errno is set accordingly)
  */
-int alpm_db_unregister(alpm_db_t *db);
+int alpm_unregister_all_syncdbs(alpm_handle_t *handle);
 
-/** Unregister all package databases.
- * @param handle the context handle
+/** Unregister a package database.
+ * @param db pointer to the package database to unregister
  * @return 0 on success, -1 on error (pm_errno is set accordingly)
  */
-int alpm_db_unregister_all(alpm_handle_t *handle);
+int alpm_db_unregister(alpm_db_t *db);
 
 /** Get the name of a package database.
  * @param db pointer to the package database
@@ -615,7 +626,7 @@
 int alpm_db_remove_server(alpm_db_t *db, const char *url);
 /** @} */
 
-int alpm_db_update(int level, alpm_db_t *db);
+int alpm_db_update(int force, alpm_db_t *db);
 
 /** Get a package entry from a package database.
  * @param db pointer to the package database to get the package from
@@ -635,7 +646,7 @@
  * @param name of the group
  * @return the groups entry on success, NULL on error
  */
-alpm_group_t *alpm_db_readgroup(alpm_db_t *db, const char *name);
+alpm_group_t *alpm_db_get_group(alpm_db_t *db, const char *name);
 
 /** Get the group cache of a package database.
  * @param db pointer to the package database to get the group from
@@ -648,16 +659,7 @@
  * @param needles a list of regular expressions to search for
  * @return the list of packages matching all regular expressions on success, NULL on error
  */
-alpm_list_t *alpm_db_search(alpm_db_t *db, const alpm_list_t* needles);
-
-/** Set install reason for a package in db.
- * @param handle the context handle
- * @param pkg the package to update
- * @param reason the new install reason
- * @return 0 on success, -1 on error (pm_errno is set accordingly)
- */
-int alpm_db_set_pkgreason(alpm_handle_t *handle, alpm_pkg_t *pkg,
-		alpm_pkgreason_t reason);
+alpm_list_t *alpm_db_search(alpm_db_t *db, const alpm_list_t *needles);
 
 /** @} */
 
@@ -754,13 +756,13 @@
  * @param pkg a pointer to package
  * @return the timestamp of the build time
  */
-time_t alpm_pkg_get_builddate(alpm_pkg_t *pkg);
+alpm_time_t alpm_pkg_get_builddate(alpm_pkg_t *pkg);
 
 /** Returns the install timestamp of the package.
  * @param pkg a pointer to package
  * @return the timestamp of the install time
  */
-time_t alpm_pkg_get_installdate(alpm_pkg_t *pkg);
+alpm_time_t alpm_pkg_get_installdate(alpm_pkg_t *pkg);
 
 /** Returns the packager's name.
  * @param pkg a pointer to package
@@ -827,7 +829,7 @@
 
 /** Returns the list of package optional dependencies.
  * @param pkg a pointer to package
- * @return a reference to an internal list of strings.
+ * @return a reference to an internal list of alpm_depend_t structures.
  */
 alpm_list_t *alpm_pkg_get_optdepends(alpm_pkg_t *pkg);
 
@@ -869,7 +871,7 @@
  * "<filename>\t<md5sum>", where the given md5sum is that of
  * the file as provided by the package.
  * @param pkg a pointer to package
- * @return a reference to an internal list of strings.
+ * @return a reference to a list of alpm_backup_t objects
  */
 alpm_list_t *alpm_pkg_get_backup(alpm_pkg_t *pkg);
 
@@ -887,6 +889,12 @@
  */
 const char *alpm_pkg_get_base64_sig(alpm_pkg_t *pkg);
 
+/** Returns the method used to validate a package during install.
+ * @param pkg a pointer to package
+ * @return an enum member giving the validation method
+ */
+alpm_pkgvalidation_t alpm_pkg_get_validation(alpm_pkg_t *pkg);
+
 /* End of alpm_pkg_t accessors */
 /* @} */
 
@@ -928,10 +936,34 @@
 
 alpm_list_t *alpm_pkg_unused_deltas(alpm_pkg_t *pkg);
 
+/** Set install reason for a package in the local database.
+ * The provided package object must be from the local database or this method
+ * will fail. The write to the local database is performed immediately.
+ * @param pkg the package to update
+ * @param reason the new install reason
+ * @return 0 on success, -1 on error (pm_errno is set accordingly)
+ */
+int alpm_pkg_set_reason(alpm_pkg_t *pkg, alpm_pkgreason_t reason);
+
+
 /* End of alpm_pkg */
 /** @} */
 
 /*
+ * Filelists
+ */
+
+/** Determines whether a package filelist contains a given path.
+ * The provided path should be relative to the install root with no leading
+ * slashes, e.g. "etc/localtime". When searching for directories, the path must
+ * have a trailing slash.
+ * @param filelist a pointer to a package filelist
+ * @param path the path to search for in the package
+ * @return a pointer to the matching file or NULL if not found
+ */
+alpm_file_t *alpm_filelist_contains(alpm_filelist_t *filelist, const char *path);
+
+/*
  * Signatures
  */
 
@@ -1107,13 +1139,13 @@
  */
 
 /* checksums */
-char *alpm_compute_md5sum(const char *name);
+char *alpm_compute_md5sum(const char *filename);
 char *alpm_compute_sha256sum(const char *filename);
 
 /** @addtogroup alpm_api_errors Error Codes
  * @{
  */
-enum _alpm_errno_t {
+typedef enum _alpm_errno_t {
 	ALPM_ERR_MEMORY = 1,
 	ALPM_ERR_SYSTEM,
 	ALPM_ERR_BADPERMS,
@@ -1177,19 +1209,19 @@
 	ALPM_ERR_LIBCURL,
 	ALPM_ERR_EXTERNAL_DOWNLOAD,
 	ALPM_ERR_GPGME
-};
+} alpm_errno_t;
 
 /** Returns the current error code from the handle. */
-enum _alpm_errno_t alpm_errno(alpm_handle_t *handle);
+alpm_errno_t alpm_errno(alpm_handle_t *handle);
 
 /** Returns the string corresponding to an error number. */
-const char *alpm_strerror(enum _alpm_errno_t err);
+const char *alpm_strerror(alpm_errno_t err);
 
 /* End of alpm_api_errors */
 /** @} */
 
 alpm_handle_t *alpm_initialize(const char *root, const char *dbpath,
-		enum _alpm_errno_t *err);
+		alpm_errno_t *err);
 int alpm_release(alpm_handle_t *handle);
 
 enum alpm_caps {
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/alpm_list.c pacman/lib/libalpm/alpm_list.c
--- pacman-4.0.3/lib/libalpm/alpm_list.c	2012-02-02 06:05:16.000000000 +0000
+++ pacman/lib/libalpm/alpm_list.c	2012-10-15 18:11:52.485417724 +0000
@@ -1,7 +1,7 @@
 /*
  *  alpm_list.c
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -204,7 +204,8 @@
  *
  * @return the resultant list
  */
-alpm_list_t SYMEXPORT *alpm_list_mmerge(alpm_list_t *left, alpm_list_t *right, alpm_list_fn_cmp fn)
+alpm_list_t SYMEXPORT *alpm_list_mmerge(alpm_list_t *left, alpm_list_t *right,
+		alpm_list_fn_cmp fn)
 {
 	alpm_list_t *newlist, *lp, *tail_ptr, *left_tail_ptr, *right_tail_ptr;
 
@@ -273,20 +274,26 @@
  *
  * @return the resultant list
  */
-alpm_list_t SYMEXPORT *alpm_list_msort(alpm_list_t *list, size_t n, alpm_list_fn_cmp fn)
+alpm_list_t SYMEXPORT *alpm_list_msort(alpm_list_t *list, size_t n,
+		alpm_list_fn_cmp fn)
 {
 	if(n > 1) {
-		alpm_list_t *left = list;
-		alpm_list_t *lastleft = alpm_list_nth(list, n/2 - 1);
-		alpm_list_t *right = lastleft->next;
+		size_t half = n / 2;
+		size_t i = half - 1;
+		alpm_list_t *left = list, *lastleft = list, *right;
+
+		while(i--) {
+			lastleft = lastleft->next;
+		}
+		right = lastleft->next;
 
 		/* tidy new lists */
 		lastleft->next = NULL;
 		right->prev = left->prev;
 		left->prev = lastleft;
 
-		left = alpm_list_msort(left, n/2, fn);
-		right = alpm_list_msort(right, n - (n/2), fn);
+		left = alpm_list_msort(left, half, fn);
+		right = alpm_list_msort(right, n - half, fn);
 		list = alpm_list_mmerge(left, right, fn);
 	}
 	return list;
@@ -579,19 +586,6 @@
 	}
 }
 
-/**
- * @brief Get the data member of a list node.
- *
- * @param node the list node
- *
- * @return the contained data, or NULL if none
- */
-void SYMEXPORT *alpm_list_getdata(const alpm_list_t *node)
-{
-	if(node == NULL) return NULL;
-	return node->data;
-}
-
 /* Misc */
 
 /**
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/alpm_list.h pacman/lib/libalpm/alpm_list.h
--- pacman-4.0.3/lib/libalpm/alpm_list.h	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/alpm_list.h	2012-10-15 18:11:52.485417724 +0000
@@ -1,7 +1,7 @@
 /*
  *  alpm_list.h
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -71,7 +71,6 @@
 alpm_list_t *alpm_list_next(const alpm_list_t *list);
 alpm_list_t *alpm_list_previous(const alpm_list_t *list);
 alpm_list_t *alpm_list_last(const alpm_list_t *list);
-void *alpm_list_getdata(const alpm_list_t *entry);
 
 /* misc */
 size_t alpm_list_count(const alpm_list_t *list);
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/backup.c pacman/lib/libalpm/backup.c
--- pacman-4.0.3/lib/libalpm/backup.c	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/backup.c	2012-10-15 18:11:52.485417724 +0000
@@ -1,7 +1,7 @@
 /*
  *  backup.c
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2005 by Judd Vinet <jvinet@zeroflux.org>
  *  Copyright (c) 2005 by Aurelien Foret <orelien@chez.com>
  *  Copyright (c) 2005 by Christian Hamar <krics@linuxforum.hu>
@@ -21,8 +21,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <stdlib.h>
 #include <string.h>
 
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/backup.h pacman/lib/libalpm/backup.h
--- pacman-4.0.3/lib/libalpm/backup.h	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/backup.h	2012-10-15 18:11:52.485417724 +0000
@@ -1,7 +1,7 @@
 /*
  *  backup.h
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/base64.c pacman/lib/libalpm/base64.c
--- pacman-4.0.3/lib/libalpm/base64.c	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/base64.c	2012-10-15 18:11:52.485417724 +0000
@@ -32,6 +32,8 @@
  *  * removal of SELF_TEST code
  */
 
+#include <stdint.h>
+
 #include "base64.h"
 
 static const unsigned char base64_enc_map[64] =
@@ -62,6 +64,7 @@
      49,  50,  51, 127, 127, 127, 127, 127
 };
 
+#if 0
 /*
  * Encode a buffer into base64 format
  */
@@ -124,6 +127,7 @@
 
     return( 0 );
 }
+#endif
 
 /*
  * Decode a base64-formatted buffer
@@ -131,8 +135,8 @@
 int base64_decode( unsigned char *dst, size_t *dlen,
                    const unsigned char *src, size_t slen )
 {
-    size_t i, j, n;
-    unsigned long x;
+    size_t i, n;
+    uint32_t j, x;
     unsigned char *p;
 
     for( i = j = n = 0; i < slen; i++ )
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/base64.h pacman/lib/libalpm/base64.h
--- pacman-4.0.3/lib/libalpm/base64.h	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/base64.h	2012-10-15 18:11:52.485417724 +0000
@@ -30,6 +30,7 @@
 #define POLARSSL_ERR_BASE64_BUFFER_TOO_SMALL               -0x0010  /**< Output buffer too small. */
 #define POLARSSL_ERR_BASE64_INVALID_CHARACTER              -0x0012  /**< Invalid character in input. */
 
+#if 0
 /**
  * \brief          Encode a buffer into base64 format
  *
@@ -47,6 +48,7 @@
  */
 int base64_encode( unsigned char *dst, size_t *dlen,
                    const unsigned char *src, size_t slen );
+#endif
 
 /**
  * \brief          Decode a base64-formatted buffer
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/be_local.c pacman/lib/libalpm/be_local.c
--- pacman-4.0.3/lib/libalpm/be_local.c	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/be_local.c	2012-10-15 18:11:52.485417724 +0000
@@ -1,7 +1,7 @@
 /*
  *  be_local.c : backend for the local database
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -18,8 +18,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <unistd.h>
 #include <stdio.h>
 #include <stdlib.h>
@@ -28,7 +26,6 @@
 #include <stdint.h> /* intmax_t */
 #include <sys/stat.h>
 #include <dirent.h>
-#include <time.h>
 #include <limits.h> /* PATH_MAX */
 
 /* libalpm */
@@ -40,6 +37,7 @@
 #include "handle.h"
 #include "package.h"
 #include "deps.h"
+#include "filelist.h"
 
 static int local_db_read(alpm_pkg_t *info, alpm_dbinfrq_t inforeq);
 
@@ -69,13 +67,13 @@
 	return pkg->url;
 }
 
-static time_t _cache_get_builddate(alpm_pkg_t *pkg)
+static alpm_time_t _cache_get_builddate(alpm_pkg_t *pkg)
 {
 	LAZY_LOAD(INFRQ_DESC, 0);
 	return pkg->builddate;
 }
 
-static time_t _cache_get_installdate(alpm_pkg_t *pkg)
+static alpm_time_t _cache_get_installdate(alpm_pkg_t *pkg)
 {
 	LAZY_LOAD(INFRQ_DESC, 0);
 	return pkg->installdate;
@@ -105,6 +103,12 @@
 	return pkg->reason;
 }
 
+static alpm_pkgvalidation_t _cache_get_validation(alpm_pkg_t *pkg)
+{
+	LAZY_LOAD(INFRQ_DESC, -1);
+	return pkg->validation;
+}
+
 static alpm_list_t *_cache_get_licenses(alpm_pkg_t *pkg)
 {
 	LAZY_LOAD(INFRQ_DESC, NULL);
@@ -226,6 +230,7 @@
 	.get_arch        = _cache_get_arch,
 	.get_isize       = _cache_get_isize,
 	.get_reason      = _cache_get_reason,
+	.get_validation  = _cache_get_validation,
 	.has_scriptlet   = _cache_has_scriptlet,
 	.get_licenses    = _cache_get_licenses,
 	.get_groups      = _cache_get_groups,
@@ -401,12 +406,11 @@
 		rewinddir(dbdir);
 	}
 	if(est_count >= 2) {
-		/* subtract the two extra pointers to get # of children */
+		/* subtract the '.' and '..' pointers to get # of children */
 		est_count -= 2;
 	}
 
-	/* initialize hash at 50% full */
-	db->pkgcache = _alpm_pkghash_create(est_count * 2);
+	db->pkgcache = _alpm_pkghash_create(est_count);
 	if(db->pkgcache == NULL){
 		closedir(dbdir);
 		RET_ERR(db->handle, ALPM_ERR_MEMORY, -1);
@@ -445,7 +449,7 @@
 			continue;
 		}
 
-		pkg->origin = PKG_FROM_LOCALDB;
+		pkg->origin = ALPM_PKG_FROM_LOCALDB;
 		pkg->origin_data.db = db;
 		pkg->ops = &local_pkg_ops;
 		pkg->handle = db->handle;
@@ -475,7 +479,8 @@
 }
 
 /* Note: the return value must be freed by the caller */
-char *_alpm_local_db_pkgpath(alpm_db_t *db, alpm_pkg_t *info, const char *filename)
+char *_alpm_local_db_pkgpath(alpm_db_t *db, alpm_pkg_t *info,
+		const char *filename)
 {
 	size_t len;
 	char *pkgpath;
@@ -492,7 +497,7 @@
 
 #define READ_NEXT() do { \
 	if(fgets(line, sizeof(line), fp) == NULL && !feof(fp)) goto error; \
-	_alpm_strip_newline(line); \
+	_alpm_strip_newline(line, 0); \
 } while(0)
 
 #define READ_AND_STORE(f) do { \
@@ -505,7 +510,7 @@
 	if(fgets(line, sizeof(line), fp) == NULL) {\
 		if(!feof(fp)) goto error; else break; \
 	} \
-	if(_alpm_strip_newline(line) == 0) break; \
+	if(_alpm_strip_newline(line, 0) == 0) break; \
 	STRDUP(linedup, line, goto error); \
 	f = alpm_list_add(f, linedup); \
 } while(1) /* note the while(1) and not (0) */
@@ -514,7 +519,7 @@
 	if(fgets(line, sizeof(line), fp) == NULL) {\
 		if(!feof(fp)) goto error; else break; \
 	} \
-	if(_alpm_strip_newline(line) == 0) break; \
+	if(_alpm_strip_newline(line, 0) == 0) break; \
 	f = alpm_list_add(f, _alpm_splitdep(line)); \
 } while(1) /* note the while(1) and not (0) */
 
@@ -522,7 +527,6 @@
 {
 	FILE *fp = NULL;
 	char line[1024];
-	char *pkgpath;
 	alpm_db_t *db = info->origin_data.db;
 
 	/* bitmask logic here:
@@ -541,18 +545,10 @@
 		return -1;
 	}
 
-	_alpm_log(db->handle, ALPM_LOG_FUNCTION, "loading package data for %s : level=0x%x\n",
+	_alpm_log(db->handle, ALPM_LOG_FUNCTION,
+			"loading package data for %s : level=0x%x\n",
 			info->name, inforeq);
 
-	pkgpath = _alpm_local_db_pkgpath(db, info, NULL);
-	if(!pkgpath || access(pkgpath, F_OK)) {
-		/* directory doesn't exist or can't be opened */
-		_alpm_log(db->handle, ALPM_LOG_DEBUG, "cannot find '%s-%s' in db '%s'\n",
-				info->name, info->version, db->treename);
-		goto error;
-	}
-	free(pkgpath);
-
 	/* clear out 'line', to be certain - and to make valgrind happy */
 	memset(line, 0, sizeof(line));
 
@@ -569,7 +565,7 @@
 			if(fgets(line, sizeof(line), fp) == NULL && !feof(fp)) {
 				goto error;
 			}
-			if(_alpm_strip_newline(line) == 0) {
+			if(_alpm_strip_newline(line, 0) == 0) {
 				/* length of stripped line was zero */
 				continue;
 			}
@@ -606,6 +602,26 @@
 			} else if(strcmp(line, "%REASON%") == 0) {
 				READ_NEXT();
 				info->reason = (alpm_pkgreason_t)atoi(line);
+			} else if(strcmp(line, "%VALIDATION%") == 0) {
+				alpm_list_t *i, *v = NULL;
+				READ_AND_STORE_ALL(v);
+				for(i = v; i; i = alpm_list_next(i))
+				{
+					if(strcmp(i->data, "none") == 0) {
+						info->validation |= ALPM_PKG_VALIDATION_NONE;
+					} else if(strcmp(i->data, "md5") == 0) {
+						info->validation |= ALPM_PKG_VALIDATION_MD5SUM;
+					} else if(strcmp(i->data, "sha256") == 0) {
+						info->validation |= ALPM_PKG_VALIDATION_SHA256SUM;
+					} else if(strcmp(i->data, "pgp") == 0) {
+						info->validation |= ALPM_PKG_VALIDATION_SIGNATURE;
+					} else {
+						_alpm_log(db->handle, ALPM_LOG_WARNING,
+								_("unknown validation type for package %s: %s\n"),
+								info->name, (const char *)i->data);
+					}
+				}
+				FREELIST(v);
 			} else if(strcmp(line, "%SIZE%") == 0) {
 				READ_NEXT();
 				info->isize = _alpm_strtoofft(line);
@@ -614,7 +630,7 @@
 			} else if(strcmp(line, "%DEPENDS%") == 0) {
 				READ_AND_SPLITDEP(info->depends);
 			} else if(strcmp(line, "%OPTDEPENDS%") == 0) {
-				READ_AND_STORE_ALL(info->optdepends);
+				READ_AND_SPLITDEP(info->optdepends);
 			} else if(strcmp(line, "%CONFLICTS%") == 0) {
 				READ_AND_SPLITDEP(info->conflicts);
 			} else if(strcmp(line, "%PROVIDES%") == 0) {
@@ -636,12 +652,13 @@
 		}
 		free(path);
 		while(fgets(line, sizeof(line), fp)) {
-			_alpm_strip_newline(line);
+			_alpm_strip_newline(line, 0);
 			if(strcmp(line, "%FILES%") == 0) {
-				size_t files_count = 0, files_size = 0;
+				size_t files_count = 0, files_size = 0, len;
 				alpm_file_t *files = NULL;
 
-				while(fgets(line, sizeof(line), fp) && _alpm_strip_newline(line)) {
+				while(fgets(line, sizeof(line), fp) &&
+						(len = _alpm_strip_newline(line, 0))) {
 					if(files_count >= files_size) {
 						size_t old_size = files_size;
 						if(files_size == 0) {
@@ -651,7 +668,7 @@
 						}
 						files = realloc(files, sizeof(alpm_file_t) * files_size);
 						if(!files) {
-							ALLOC_FAIL(sizeof(alpm_file_t) * files_size);
+							_alpm_alloc_fail(sizeof(alpm_file_t) * files_size);
 							goto error;
 						}
 						/* ensure all new memory is zeroed out, in both the initial
@@ -659,16 +676,25 @@
 						memset(files + old_size, 0,
 								sizeof(alpm_file_t) * (files_size - old_size));
 					}
-					STRDUP(files[files_count].name, line, goto error);
-					/* TODO: lstat file, get mode/size */
+					/* since we know the length of the file string already,
+					 * we can do malloc + memcpy rather than strdup */
+					len += 1;
+					files[files_count].name = malloc(len);
+					if(files[files_count].name == NULL) {
+						_alpm_alloc_fail(len);
+						goto error;
+					}
+					memcpy(files[files_count].name, line, len);
 					files_count++;
 				}
 				/* attempt to hand back any memory we don't need */
 				files = realloc(files, sizeof(alpm_file_t) * files_count);
+				/* make sure the list is sorted */
+				qsort(files, files_count, sizeof(alpm_file_t), _alpm_files_cmp);
 				info->files.count = files_count;
 				info->files.files = files;
 			} else if(strcmp(line, "%BACKUP%") == 0) {
-				while(fgets(line, sizeof(line), fp) && _alpm_strip_newline(line)) {
+				while(fgets(line, sizeof(line), fp) && _alpm_strip_newline(line, 0)) {
 					alpm_backup_t *backup;
 					CALLOC(backup, 1, sizeof(alpm_backup_t), goto error);
 					if(_alpm_split_backup(line, &backup)) {
@@ -727,6 +753,23 @@
 	return retval;
 }
 
+static void write_deps(FILE *fp, const char *header, alpm_list_t *deplist)
+{
+	alpm_list_t *lp;
+	if(!deplist) {
+		return;
+	}
+	fputs(header, fp);
+	fputc('\n', fp);
+	for(lp = deplist; lp; lp = lp->next) {
+		char *depstring = alpm_dep_compute_string(lp->data);
+		fputs(depstring, fp);
+		fputc('\n', fp);
+		free(depstring);
+	}
+	fputc('\n', fp);
+}
+
 int _alpm_local_db_write(alpm_db_t *db, alpm_pkg_t *info, alpm_dbinfrq_t inforeq)
 {
 	FILE *fp = NULL;
@@ -744,7 +787,8 @@
 	/* DESC */
 	if(inforeq & INFRQ_DESC) {
 		char *path;
-		_alpm_log(db->handle, ALPM_LOG_DEBUG, "writing %s-%s DESC information back to db\n",
+		_alpm_log(db->handle, ALPM_LOG_DEBUG,
+				"writing %s-%s DESC information back to db\n",
 				info->name, info->version);
 		path = _alpm_local_db_pkgpath(db, info, "desc");
 		if(!path || (fp = fopen(path, "w")) == NULL) {
@@ -761,44 +805,21 @@
 			fprintf(fp, "%%DESC%%\n"
 							"%s\n\n", info->desc);
 		}
-		if(info->groups) {
-			fputs("%GROUPS%\n", fp);
-			for(lp = info->groups; lp; lp = lp->next) {
-				fprintf(fp, "%s\n", (char *)lp->data);
-			}
-			fprintf(fp, "\n");
-		}
-		if(info->replaces) {
-			fputs("%REPLACES%\n", fp);
-			for(lp = info->replaces; lp; lp = lp->next) {
-				char *depstring = alpm_dep_compute_string(lp->data);
-				fprintf(fp, "%s\n", depstring);
-				free(depstring);
-			}
-			fprintf(fp, "\n");
-		}
 		if(info->url) {
 			fprintf(fp, "%%URL%%\n"
 							"%s\n\n", info->url);
 		}
-		if(info->licenses) {
-			fputs("%LICENSE%\n", fp);
-			for(lp = info->licenses; lp; lp = lp->next) {
-				fprintf(fp, "%s\n", (char *)lp->data);
-			}
-			fprintf(fp, "\n");
-		}
 		if(info->arch) {
 			fprintf(fp, "%%ARCH%%\n"
 							"%s\n\n", info->arch);
 		}
 		if(info->builddate) {
 			fprintf(fp, "%%BUILDDATE%%\n"
-							"%ld\n\n", info->builddate);
+							"%jd\n\n", (intmax_t)info->builddate);
 		}
 		if(info->installdate) {
 			fprintf(fp, "%%INSTALLDATE%%\n"
-							"%ld\n\n", info->installdate);
+							"%jd\n\n", (intmax_t)info->installdate);
 		}
 		if(info->packager) {
 			fprintf(fp, "%%PACKAGER%%\n"
@@ -813,41 +834,45 @@
 			fprintf(fp, "%%REASON%%\n"
 							"%u\n\n", info->reason);
 		}
-		if(info->depends) {
-			fputs("%DEPENDS%\n", fp);
-			for(lp = info->depends; lp; lp = lp->next) {
-				char *depstring = alpm_dep_compute_string(lp->data);
-				fprintf(fp, "%s\n", depstring);
-				free(depstring);
-			}
-			fprintf(fp, "\n");
-		}
-		if(info->optdepends) {
-			fputs("%OPTDEPENDS%\n", fp);
-			for(lp = info->optdepends; lp; lp = lp->next) {
-				fprintf(fp, "%s\n", (char *)lp->data);
-			}
-			fprintf(fp, "\n");
-		}
-		if(info->conflicts) {
-			fputs("%CONFLICTS%\n", fp);
-			for(lp = info->conflicts; lp; lp = lp->next) {
-				char *depstring = alpm_dep_compute_string(lp->data);
-				fprintf(fp, "%s\n", depstring);
-				free(depstring);
-			}
-			fprintf(fp, "\n");
-		}
-		if(info->provides) {
-			fputs("%PROVIDES%\n", fp);
-			for(lp = info->provides; lp; lp = lp->next) {
-				char *depstring = alpm_dep_compute_string(lp->data);
-				fprintf(fp, "%s\n", depstring);
-				free(depstring);
+		if(info->groups) {
+			fputs("%GROUPS%\n", fp);
+			for(lp = info->groups; lp; lp = lp->next) {
+				fputs(lp->data, fp);
+				fputc('\n', fp);
+			}
+			fputc('\n', fp);
+		}
+		if(info->licenses) {
+			fputs("%LICENSE%\n", fp);
+			for(lp = info->licenses; lp; lp = lp->next) {
+				fputs(lp->data, fp);
+				fputc('\n', fp);
 			}
-			fprintf(fp, "\n");
+			fputc('\n', fp);
+		}
+		if(info->validation) {
+			fputs("%VALIDATION%\n", fp);
+			if(info->validation & ALPM_PKG_VALIDATION_NONE) {
+				fputs("none\n", fp);
+			}
+			if(info->validation & ALPM_PKG_VALIDATION_MD5SUM) {
+				fputs("md5\n", fp);
+			}
+			if(info->validation & ALPM_PKG_VALIDATION_SHA256SUM) {
+				fputs("sha256\n", fp);
+			}
+			if(info->validation & ALPM_PKG_VALIDATION_SIGNATURE) {
+				fputs("pgp\n", fp);
+			}
+			fputc('\n', fp);
 		}
 
+		write_deps(fp, "%REPLACES%", info->replaces);
+		write_deps(fp, "%DEPENDS%", info->depends);
+		write_deps(fp, "%OPTDEPENDS%", info->optdepends);
+		write_deps(fp, "%CONFLICTS%", info->conflicts);
+		write_deps(fp, "%PROVIDES%", info->provides);
+
 		fclose(fp);
 		fp = NULL;
 	}
@@ -855,7 +880,8 @@
 	/* FILES */
 	if(inforeq & INFRQ_FILES) {
 		char *path;
-		_alpm_log(db->handle, ALPM_LOG_DEBUG, "writing %s-%s FILES information back to db\n",
+		_alpm_log(db->handle, ALPM_LOG_DEBUG,
+				"writing %s-%s FILES information back to db\n",
 				info->name, info->version);
 		path = _alpm_local_db_pkgpath(db, info, "files");
 		if(!path || (fp = fopen(path, "w")) == NULL) {
@@ -868,20 +894,21 @@
 		free(path);
 		if(info->files.count) {
 			size_t i;
-			fprintf(fp, "%%FILES%%\n");
+			fputs("%FILES%\n", fp);
 			for(i = 0; i < info->files.count; i++) {
 				const alpm_file_t *file = info->files.files + i;
-				fprintf(fp, "%s\n", file->name);
+				fputs(file->name, fp);
+				fputc('\n', fp);
 			}
-			fprintf(fp, "\n");
+			fputc('\n', fp);
 		}
 		if(info->backup) {
-			fprintf(fp, "%%BACKUP%%\n");
+			fputs("%BACKUP%\n", fp);
 			for(lp = info->backup; lp; lp = lp->next) {
 				const alpm_backup_t *backup = lp->data;
 				fprintf(fp, "%s\t%s\n", backup->name, backup->hash);
 			}
-			fprintf(fp, "\n");
+			fputc('\n', fp);
 		}
 		fclose(fp);
 		fp = NULL;
@@ -903,17 +930,71 @@
 int _alpm_local_db_remove(alpm_db_t *db, alpm_pkg_t *info)
 {
 	int ret = 0;
-	char *pkgpath = _alpm_local_db_pkgpath(db, info, NULL);
+	DIR *dirp;
+	struct dirent *dp;
+	char *pkgpath;
+	size_t pkgpath_len;
 
-	/* TODO explicit file removes and then an rmdir? */
-	ret = _alpm_rmrf(pkgpath);
-	free(pkgpath);
-	if(ret != 0) {
+	pkgpath = _alpm_local_db_pkgpath(db, info, NULL);
+	if(!pkgpath) {
+		return -1;
+	}
+	pkgpath_len = strlen(pkgpath);
+
+	dirp = opendir(pkgpath);
+	if(!dirp) {
+		return -1;
+	}
+	/* go through the local DB entry, removing the files within, which we know
+	 * are not nested directories of any kind. */
+	for(dp = readdir(dirp); dp != NULL; dp = readdir(dirp)) {
+		if(strcmp(dp->d_name, "..") != 0 && strcmp(dp->d_name, ".") != 0) {
+			char name[PATH_MAX];
+			if(pkgpath_len + strlen(dp->d_name) + 2 > PATH_MAX) {
+				/* file path is too long to remove, hmm. */
+				ret = -1;
+			} else {
+				sprintf(name, "%s/%s", pkgpath, dp->d_name);
+				if(unlink(name)) {
+					ret = -1;
+				}
+			}
+		}
+	}
+	closedir(dirp);
+
+	/* after removing all enclosed files, we can remove the directory itself. */
+	if(rmdir(pkgpath)) {
 		ret = -1;
 	}
+	free(pkgpath);
 	return ret;
 }
 
+int SYMEXPORT alpm_pkg_set_reason(alpm_pkg_t *pkg, alpm_pkgreason_t reason)
+{
+	ASSERT(pkg != NULL, return -1);
+	ASSERT(pkg->origin == ALPM_PKG_FROM_LOCALDB,
+			RET_ERR(pkg->handle, ALPM_ERR_WRONG_ARGS, -1));
+	ASSERT(pkg->origin_data.db == pkg->handle->db_local,
+			RET_ERR(pkg->handle, ALPM_ERR_WRONG_ARGS, -1));
+
+	_alpm_log(pkg->handle, ALPM_LOG_DEBUG,
+			"setting install reason %u for %s\n", reason, pkg->name);
+	if(alpm_pkg_get_reason(pkg) == reason) {
+		/* we are done */
+		return 0;
+	}
+	/* set reason (in pkgcache) */
+	pkg->reason = reason;
+	/* write DESC */
+	if(_alpm_local_db_write(pkg->handle->db_local, pkg, INFRQ_DESC)) {
+		RET_ERR(pkg->handle, ALPM_ERR_DB_WRITE, -1);
+	}
+
+	return 0;
+}
+
 struct db_operations local_db_ops = {
 	.validate         = local_db_validate,
 	.populate         = local_db_populate,
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/be_package.c pacman/lib/libalpm/be_package.c
--- pacman-4.0.3/lib/libalpm/be_package.c	2012-03-05 17:44:34.000000000 +0000
+++ pacman/lib/libalpm/be_package.c	2012-10-15 18:11:52.485417724 +0000
@@ -1,7 +1,7 @@
 /*
  *  be_package.c : backend for packages
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -18,11 +18,12 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <stdlib.h>
 #include <string.h>
 #include <errno.h>
+#include <sys/types.h>
+#include <sys/stat.h>
+#include <fcntl.h>
 
 /* libarchive */
 #include <archive.h>
@@ -35,7 +36,13 @@
 #include "log.h"
 #include "handle.h"
 #include "package.h"
-#include "deps.h" /* _alpm_splitdep */
+#include "deps.h"
+#include "filelist.h"
+
+struct package_changelog {
+	struct archive *archive;
+	int fd;
+};
 
 /**
  * Open a package changelog for reading. Similar to fopen in functionality,
@@ -47,31 +54,38 @@
 {
 	ASSERT(pkg != NULL, return NULL);
 
-	struct archive *archive = NULL;
+	struct package_changelog *changelog;
+	struct archive *archive;
 	struct archive_entry *entry;
 	const char *pkgfile = pkg->origin_data.file;
+	struct stat buf;
+	int fd;
 
-	if((archive = archive_read_new()) == NULL) {
-		RET_ERR(pkg->handle, ALPM_ERR_LIBARCHIVE, NULL);
-	}
-
-	archive_read_support_compression_all(archive);
-	archive_read_support_format_all(archive);
-
-	if(archive_read_open_filename(archive, pkgfile,
-				ALPM_BUFFER_SIZE) != ARCHIVE_OK) {
-		RET_ERR(pkg->handle, ALPM_ERR_PKG_OPEN, NULL);
+	fd = _alpm_open_archive(pkg->handle, pkgfile, &buf,
+			&archive, ALPM_ERR_PKG_OPEN);
+	if(fd < 0) {
+		return NULL;
 	}
 
 	while(archive_read_next_header(archive, &entry) == ARCHIVE_OK) {
 		const char *entry_name = archive_entry_pathname(entry);
 
 		if(strcmp(entry_name, ".CHANGELOG") == 0) {
-			return archive;
+			changelog = malloc(sizeof(struct package_changelog));
+			if(!changelog) {
+				pkg->handle->pm_errno = ALPM_ERR_MEMORY;
+				archive_read_finish(archive);
+				CLOSE(fd);
+				return NULL;
+			}
+			changelog->archive = archive;
+			changelog->fd = fd;
+			return changelog;
 		}
 	}
 	/* we didn't find a changelog */
 	archive_read_finish(archive);
+	CLOSE(fd);
 	errno = ENOENT;
 
 	return NULL;
@@ -89,7 +103,8 @@
 static size_t _package_changelog_read(void *ptr, size_t size,
 		const alpm_pkg_t UNUSED *pkg, void *fp)
 {
-	ssize_t sret = archive_read_data((struct archive *)fp, ptr, size);
+	struct package_changelog *changelog = fp;
+	ssize_t sret = archive_read_data(changelog->archive, ptr, size);
 	/* Report error (negative values) */
 	if(sret < 0) {
 		RET_ERR(pkg->handle, ALPM_ERR_LIBARCHIVE, 0);
@@ -107,7 +122,12 @@
  */
 static int _package_changelog_close(const alpm_pkg_t UNUSED *pkg, void *fp)
 {
-	return archive_read_finish((struct archive *)fp);
+	int ret;
+	struct package_changelog *changelog = fp;
+	ret = archive_read_finish(changelog->archive);
+	CLOSE(changelog->fd);
+	free(changelog);
+	return ret;
 }
 
 /** Package file operations struct accessor. We implement this as a method
@@ -149,21 +169,24 @@
 
 	/* loop until we reach EOF or other error */
 	while((ret = _alpm_archive_fgets(a, &buf)) == ARCHIVE_OK) {
-		size_t len = _alpm_strip_newline(buf.line);
+		size_t len = _alpm_strip_newline(buf.line, buf.real_line_size);
 
 		linenum++;
-		if(len == 0 || buf.line[0] == '#') {
+		key = buf.line;
+		if(len == 0 || key[0] == '#') {
 			continue;
 		}
-		ptr = buf.line;
-		key = strsep(&ptr, "=");
-		if(key == NULL || ptr == NULL) {
-			_alpm_log(handle, ALPM_LOG_DEBUG, "%s: syntax error in description file line %d\n",
-								newpkg->name ? newpkg->name : "error", linenum);
+		/* line is always in this format: "key = value"
+		 * we can be sure the " = " exists, so look for that */
+		ptr = memchr(key, ' ', len);
+		if(!ptr || (size_t)(ptr - key + 2) > len || memcmp(ptr, " = ", 3) != 0) {
+			_alpm_log(handle, ALPM_LOG_DEBUG,
+					"%s: syntax error in description file line %d\n",
+					newpkg->name ? newpkg->name : "error", linenum);
 		} else {
-			key = _alpm_strtrim(key);
-			while(*ptr == ' ') ptr++;
-			ptr = _alpm_strtrim(ptr);
+			/* NULL the end of the key portion, move ptr to start of value */
+			*ptr = '\0';
+			ptr += 3;
 			if(strcmp(key, "pkgname") == 0) {
 				STRDUP(newpkg->name, ptr, return -1);
 				newpkg->name_hash = _alpm_hash_sdbm(newpkg->name);
@@ -192,7 +215,8 @@
 				alpm_depend_t *dep = _alpm_splitdep(ptr);
 				newpkg->depends = alpm_list_add(newpkg->depends, dep);
 			} else if(strcmp(key, "optdepend") == 0) {
-				newpkg->optdepends = alpm_list_add(newpkg->optdepends, strdup(ptr));
+				alpm_depend_t *optdep = _alpm_splitdep(ptr);
+				newpkg->optdepends = alpm_list_add(newpkg->optdepends, optdep);
 			} else if(strcmp(key, "conflict") == 0) {
 				alpm_depend_t *conflict = _alpm_splitdep(ptr);
 				newpkg->conflicts = alpm_list_add(newpkg->conflicts, conflict);
@@ -225,53 +249,6 @@
 	return 0;
 }
 
-static void files_merge(alpm_file_t a[], alpm_file_t b[], alpm_file_t c[],
-		size_t m, size_t n)
-{
-	size_t i = 0, j = 0, k = 0;
-	while(i < m && j < n) {
-		if(strcmp(a[i].name, b[j].name) < 0) {
-			c[k++] = a[i++];
-		} else {
-			c[k++] = b[j++];
-		}
-	}
-	while(i < m) {
-		c[k++] = a[i++];
-	}
-	while(j < n) {
-		c[k++] = b[j++];
-	}
-}
-
-static alpm_file_t *files_msort(alpm_file_t *files, size_t n)
-{
-	alpm_file_t *work;
-	size_t blocksize = 1;
-
-	CALLOC(work, n, sizeof(alpm_file_t), return NULL);
-
-	for(blocksize = 1; blocksize < n; blocksize *= 2) {
-		size_t i, max_extent = 0;
-		for(i = 0; i < n - blocksize; i += 2 * blocksize) {
-			/* this limits our actual merge to the length of the array, since we will
-			 * not likely be a perfect power of two. */
-			size_t right_blocksize = blocksize;
-			if(i + blocksize * 2 > n) {
-				right_blocksize = n - i - blocksize;
-			}
-			files_merge(files + i, files + i + blocksize, work + i,
-					blocksize, right_blocksize);
-			max_extent = i + blocksize + right_blocksize;
-		}
-		/* ensure we only copy what we actually touched on this merge pass,
-		 * no more, no less */
-		memcpy(files, work, max_extent * sizeof(alpm_file_t));
-	}
-	free(work);
-	return files;
-}
-
 /**
  * Validate a package.
  * @param handle the context handle
@@ -280,11 +257,12 @@
  * sha256sum, and/or base64 signature)
  * @param level the required level of signature verification
  * @param sigdata signature data from the package to pass back
+ * @param validation successful validations performed on the package file
  * @return 0 if package is fully valid, -1 and pm_errno otherwise
  */
 int _alpm_pkg_validate_internal(alpm_handle_t *handle,
 		const char *pkgfile, alpm_pkg_t *syncpkg, alpm_siglevel_t level,
-		alpm_siglist_t **sigdata)
+		alpm_siglist_t **sigdata, alpm_pkgvalidation_t *validation)
 {
 	int has_sig;
 	handle->pm_errno = 0;
@@ -294,8 +272,15 @@
 	}
 
 	/* attempt to access the package file, ensure it exists */
-	if(access(pkgfile, R_OK) != 0) {
-		RET_ERR(handle, ALPM_ERR_PKG_NOT_FOUND, -1);
+	if(_alpm_access(handle, NULL, pkgfile, R_OK) != 0) {
+		if(errno == ENOENT) {
+			handle->pm_errno = ALPM_ERR_PKG_NOT_FOUND;
+		} else if(errno == EACCES) {
+			handle->pm_errno = ALPM_ERR_BADPERMS;
+		} else {
+			handle->pm_errno = ALPM_ERR_PKG_OPEN;
+		}
+		return -1;
 	}
 
 	/* can we get away with skipping checksums? */
@@ -316,17 +301,23 @@
 		if(syncpkg->md5sum && !syncpkg->sha256sum) {
 			_alpm_log(handle, ALPM_LOG_DEBUG, "md5sum: %s\n", syncpkg->md5sum);
 			_alpm_log(handle, ALPM_LOG_DEBUG, "checking md5sum for %s\n", pkgfile);
-			if(_alpm_test_checksum(pkgfile, syncpkg->md5sum, ALPM_CSUM_MD5) != 0) {
+			if(_alpm_test_checksum(pkgfile, syncpkg->md5sum, ALPM_PKG_VALIDATION_MD5SUM) != 0) {
 				RET_ERR(handle, ALPM_ERR_PKG_INVALID_CHECKSUM, -1);
 			}
+			if(validation) {
+				*validation |= ALPM_PKG_VALIDATION_MD5SUM;
+			}
 		}
 
 		if(syncpkg->sha256sum) {
 			_alpm_log(handle, ALPM_LOG_DEBUG, "sha256sum: %s\n", syncpkg->sha256sum);
 			_alpm_log(handle, ALPM_LOG_DEBUG, "checking sha256sum for %s\n", pkgfile);
-			if(_alpm_test_checksum(pkgfile, syncpkg->sha256sum, ALPM_CSUM_SHA256) != 0) {
+			if(_alpm_test_checksum(pkgfile, syncpkg->sha256sum, ALPM_PKG_VALIDATION_SHA256SUM) != 0) {
 				RET_ERR(handle, ALPM_ERR_PKG_INVALID_CHECKSUM, -1);
 			}
+			if(validation) {
+				*validation |= ALPM_PKG_VALIDATION_SHA256SUM;
+			}
 		}
 	}
 
@@ -340,6 +331,13 @@
 			handle->pm_errno = ALPM_ERR_PKG_INVALID_SIG;
 			return -1;
 		}
+		if(validation && has_sig) {
+			*validation |= ALPM_PKG_VALIDATION_SIGNATURE;
+		}
+	}
+
+	if (validation && !*validation) {
+		*validation = ALPM_PKG_VALIDATION_NONE;
 	}
 
 	return 0;
@@ -355,10 +353,10 @@
 alpm_pkg_t *_alpm_pkg_load_internal(alpm_handle_t *handle,
 		const char *pkgfile, int full)
 {
-	int ret, config = 0;
+	int ret, fd, config = 0;
 	struct archive *archive;
 	struct archive_entry *entry;
-	alpm_pkg_t *newpkg = NULL;
+	alpm_pkg_t *newpkg;
 	struct stat st;
 	size_t files_size = 0;
 
@@ -366,33 +364,26 @@
 		RET_ERR(handle, ALPM_ERR_WRONG_ARGS, NULL);
 	}
 
-	/* attempt to stat the package file, ensure it exists */
-	if(stat(pkgfile, &st) == 0) {
-		newpkg = _alpm_pkg_new();
-		if(newpkg == NULL) {
-			RET_ERR(handle, ALPM_ERR_MEMORY, NULL);
+	fd = _alpm_open_archive(handle, pkgfile, &st, &archive, ALPM_ERR_PKG_OPEN);
+	if(fd < 0) {
+		if(errno == ENOENT) {
+			handle->pm_errno = ALPM_ERR_PKG_NOT_FOUND;
+		} else if(errno == EACCES) {
+			handle->pm_errno = ALPM_ERR_BADPERMS;
+		} else {
+			handle->pm_errno = ALPM_ERR_PKG_OPEN;
 		}
-		newpkg->filename = strdup(pkgfile);
-		newpkg->size = st.st_size;
-	} else {
-		/* couldn't stat the pkgfile, return an error */
-		RET_ERR(handle, ALPM_ERR_PKG_NOT_FOUND, NULL);
-	}
-
-	/* try to create an archive object to read in the package */
-	if((archive = archive_read_new()) == NULL) {
-		_alpm_pkg_free(newpkg);
-		RET_ERR(handle, ALPM_ERR_LIBARCHIVE, NULL);
+		return NULL;
 	}
 
-	archive_read_support_compression_all(archive);
-	archive_read_support_format_all(archive);
-
-	if(archive_read_open_filename(archive, pkgfile,
-				ALPM_BUFFER_SIZE) != ARCHIVE_OK) {
-		handle->pm_errno = ALPM_ERR_PKG_OPEN;
+	newpkg = _alpm_pkg_new();
+	if(newpkg == NULL) {
+		handle->pm_errno = ALPM_ERR_MEMORY;
 		goto error;
 	}
+	STRDUP(newpkg->filename, pkgfile,
+			handle->pm_errno = ALPM_ERR_MEMORY; goto error);
+	newpkg->size = st.st_size;
 
 	_alpm_log(handle, ALPM_LOG_DEBUG, "starting package load for %s\n", pkgfile);
 
@@ -439,7 +430,7 @@
 				newfiles = realloc(newpkg->files.files,
 						sizeof(alpm_file_t) * files_size);
 				if(!newfiles) {
-					ALLOC_FAIL(sizeof(alpm_file_t) * files_size);
+					_alpm_alloc_fail(sizeof(alpm_file_t) * files_size);
 					goto error;
 				}
 				/* ensure all new memory is zeroed out, in both the initial
@@ -481,13 +472,15 @@
 	}
 
 	archive_read_finish(archive);
+	CLOSE(fd);
 
 	/* internal fields for package struct */
-	newpkg->origin = PKG_FROM_FILE;
+	newpkg->origin = ALPM_PKG_FROM_FILE;
 	newpkg->origin_data.file = strdup(pkgfile);
 	newpkg->ops = get_file_pkg_ops();
 	newpkg->handle = handle;
 	newpkg->infolevel = INFRQ_BASE | INFRQ_DESC | INFRQ_SCRIPTLET;
+	newpkg->validation = ALPM_PKG_VALIDATION_NONE;
 
 	if(full) {
 		if(newpkg->files.files) {
@@ -497,8 +490,9 @@
 			/* "checking for conflicts" requires a sorted list, ensure that here */
 			_alpm_log(handle, ALPM_LOG_DEBUG,
 					"sorting package filelist for %s\n", pkgfile);
-			newpkg->files.files = files_msort(newpkg->files.files,
-					newpkg->files.count);
+
+			qsort(newpkg->files.files, newpkg->files.count,
+					sizeof(alpm_file_t), _alpm_files_cmp);
 		}
 		newpkg->infolevel |= INFRQ_FILES;
 	}
@@ -510,6 +504,9 @@
 error:
 	_alpm_pkg_free(newpkg);
 	archive_read_finish(archive);
+	if(fd >= 0) {
+		CLOSE(fd);
+	}
 
 	return NULL;
 }
@@ -517,10 +514,13 @@
 int SYMEXPORT alpm_pkg_load(alpm_handle_t *handle, const char *filename, int full,
 		alpm_siglevel_t level, alpm_pkg_t **pkg)
 {
+	alpm_pkgvalidation_t validation = 0;
+
 	CHECK_HANDLE(handle, return -1);
 	ASSERT(pkg != NULL, RET_ERR(handle, ALPM_ERR_WRONG_ARGS, -1));
 
-	if(_alpm_pkg_validate_internal(handle, filename, NULL, level, NULL) == -1) {
+	if(_alpm_pkg_validate_internal(handle, filename, NULL, level, NULL,
+				&validation) == -1) {
 		/* pm_errno is set by pkg_validate */
 		return -1;
 	}
@@ -529,6 +529,7 @@
 		/* pm_errno is set by pkg_load */
 		return -1;
 	}
+	(*pkg)->validation = validation;
 
 	return 0;
 }
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/be_sync.c pacman/lib/libalpm/be_sync.c
--- pacman-4.0.3/lib/libalpm/be_sync.c	2011-10-27 19:39:31.000000000 +0000
+++ pacman/lib/libalpm/be_sync.c	2012-10-15 18:11:52.485417724 +0000
@@ -1,7 +1,7 @@
 /*
  *  be_sync.c : backend for sync databases
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -18,10 +18,10 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <errno.h>
+#include <sys/types.h>
 #include <sys/stat.h>
+#include <fcntl.h>
 #include <unistd.h>
 
 /* libarchive */
@@ -86,7 +86,7 @@
 	}
 
 	/* we can skip any validation if the database doesn't exist */
-	if(access(dbpath, R_OK) != 0 && errno == ENOENT) {
+	if(_alpm_access(db->handle, NULL, dbpath, R_OK) != 0 && errno == ENOENT) {
 		db->status &= ~DB_STATUS_EXISTS;
 		db->status |= DB_STATUS_MISSING;
 		_alpm_log(db->handle, ALPM_LOG_WARNING,
@@ -142,7 +142,7 @@
  *
  * Example:
  * @code
- * alpm_list_t *syncs = alpm_option_get_syncdbs();
+ * alpm_list_t *syncs = alpm_get_syncdbs();
  * for(i = syncs; i; i = alpm_list_next(i)) {
  *     alpm_db_t *db = alpm_list_getdata(i);
  *     result = alpm_db_update(0, db);
@@ -212,6 +212,7 @@
 
 		/* print server + filename into a buffer */
 		len = strlen(server) + strlen(db->treename) + 5;
+		/* TODO fix leak syncpath and umask unset */
 		MALLOC(payload.fileurl, len, RET_ERR(handle, ALPM_ERR_MEMORY, -1));
 		snprintf(payload.fileurl, len, "%s/%s.db", server, db->treename);
 		payload.handle = handle;
@@ -234,6 +235,7 @@
 			/* if we downloaded a DB, we want the .sig from the same server */
 			/* print server + filename into a buffer (leave space for .sig) */
 			len = strlen(server) + strlen(db->treename) + 9;
+			/* TODO fix leak syncpath and umask unset */
 			MALLOC(payload.fileurl, len, RET_ERR(handle, ALPM_ERR_MEMORY, -1));
 			snprintf(payload.fileurl, len, "%s/%s.db.sig", server, db->treename);
 			payload.handle = handle;
@@ -294,6 +296,29 @@
 static int sync_db_read(alpm_db_t *db, struct archive *archive,
 		struct archive_entry *entry, alpm_pkg_t **likely_pkg);
 
+static alpm_pkgvalidation_t _sync_get_validation(alpm_pkg_t *pkg)
+{
+	if(pkg->validation) {
+		return pkg->validation;
+	}
+
+	if(pkg->md5sum) {
+		pkg->validation |= ALPM_PKG_VALIDATION_MD5SUM;
+	}
+	if(pkg->sha256sum) {
+		pkg->validation |= ALPM_PKG_VALIDATION_SHA256SUM;
+	}
+	if(pkg->base64_sig) {
+		pkg->validation |= ALPM_PKG_VALIDATION_SIGNATURE;
+	}
+
+	if(!pkg->validation) {
+		pkg->validation |= ALPM_PKG_VALIDATION_NONE;
+	}
+
+	return pkg->validation;
+}
+
 static alpm_pkg_t *load_pkg_for_entry(alpm_db_t *db, const char *entryname,
 		const char **entry_filename, alpm_pkg_t *likely_pkg)
 {
@@ -316,7 +341,8 @@
 		return NULL;
 	}
 
-	if(likely_pkg && strcmp(likely_pkg->name, pkgname) == 0) {
+	if(likely_pkg && pkgname_hash == likely_pkg->name_hash
+			&& strcmp(likely_pkg->name, pkgname) == 0) {
 		pkg = likely_pkg;
 	} else {
 		pkg = _alpm_pkghash_find(db->pkgcache, pkgname);
@@ -331,9 +357,10 @@
 		pkg->version = pkgver;
 		pkg->name_hash = pkgname_hash;
 
-		pkg->origin = PKG_FROM_SYNCDB;
+		pkg->origin = ALPM_PKG_FROM_SYNCDB;
 		pkg->origin_data.db = db;
 		pkg->ops = &default_pkg_ops;
+		pkg->ops->get_validation = _sync_get_validation;
 		pkg->handle = db->handle;
 
 		/* add to the collection */
@@ -348,61 +375,38 @@
 	return pkg;
 }
 
-/*
- * This is the data table used to generate the estimating function below.
- * "Weighted Avg" means averaging the bottom table values; thus each repo, big
- * or small, will have equal influence.  "Unweighted Avg" means averaging the
- * sums of the top table columns, thus each package has equal influence.  The
- * final values are calculated by (surprise) averaging the averages, because
- * why the hell not.
- *
- * Database   Pkgs  tar      bz2     gz      xz
- * community  2096  5294080  256391  421227  301296
- * core        180   460800   25257   36850   29356
- * extra      2606  6635520  294647  470818  339392
- * multilib    126   327680   16120   23261   18732
- * testing      76   204800   10902   14348   12100
- *
- * Bytes Per Package
- * community  2096  2525.80  122.32  200.97  143.75
- * core        180  2560.00  140.32  204.72  163.09
- * extra      2606  2546.25  113.06  180.67  130.23
- * multilib    126  2600.63  127.94  184.61  148.67
- * testing      76  2694.74  143.45  188.79  159.21
-
- * Weighted Avg     2585.48  129.42  191.95  148.99
- * Unweighted Avg   2543.39  118.74  190.16  137.93
- * Average of Avgs  2564.44  124.08  191.06  143.46
- */
+/* This function doesn't work as well as one might think, as size of database
+ * entries varies considerably. Adding signatures nearly doubles the size of a
+ * single entry; deltas also can make for large variations in size. These
+ * current values are heavily influenced by Arch Linux; databases with no
+ * deltas and a single signature per package. */
 static size_t estimate_package_count(struct stat *st, struct archive *archive)
 {
-	unsigned int per_package;
+	int per_package;
 
 	switch(archive_compression(archive)) {
 		case ARCHIVE_COMPRESSION_NONE:
-			per_package = 2564;
+			per_package = 3015;
 			break;
 		case ARCHIVE_COMPRESSION_GZIP:
-			per_package = 191;
+		case ARCHIVE_COMPRESSION_COMPRESS:
+			per_package = 464;
 			break;
 		case ARCHIVE_COMPRESSION_BZIP2:
-			per_package = 124;
-			break;
-		case ARCHIVE_COMPRESSION_COMPRESS:
-			per_package = 193;
+			per_package = 394;
 			break;
 		case ARCHIVE_COMPRESSION_LZMA:
 		case ARCHIVE_COMPRESSION_XZ:
-			per_package = 143;
+			per_package = 400;
 			break;
 #ifdef ARCHIVE_COMPRESSION_UU
 		case ARCHIVE_COMPRESSION_UU:
-			per_package = 3543;
+			per_package = 3015 * 4 / 3;
 			break;
 #endif
 		default:
 			/* assume it is at least somewhat compressed */
-			per_package = 200;
+			per_package = 500;
 	}
 	return (size_t)((st->st_size / per_package) + 1);
 }
@@ -411,7 +415,7 @@
 {
 	const char *dbpath;
 	size_t est_count;
-	int count = 0;
+	int count, fd;
 	struct stat buf;
 	struct archive *archive;
 	struct archive_entry *entry;
@@ -423,38 +427,24 @@
 	if(db->status & DB_STATUS_MISSING) {
 		RET_ERR(db->handle, ALPM_ERR_DB_NOT_FOUND, -1);
 	}
-
-	if((archive = archive_read_new()) == NULL) {
-		RET_ERR(db->handle, ALPM_ERR_LIBARCHIVE, -1);
-	}
-
-	archive_read_support_compression_all(archive);
-	archive_read_support_format_all(archive);
-
 	dbpath = _alpm_db_path(db);
 	if(!dbpath) {
 		/* pm_errno set in _alpm_db_path() */
 		return -1;
 	}
 
-	_alpm_log(db->handle, ALPM_LOG_DEBUG, "opening database archive %s\n", dbpath);
-
-	if(archive_read_open_filename(archive, dbpath,
-				ALPM_BUFFER_SIZE) != ARCHIVE_OK) {
-		_alpm_log(db->handle, ALPM_LOG_ERROR, _("could not open file %s: %s\n"), dbpath,
-				archive_error_string(archive));
-		archive_read_finish(archive);
-		RET_ERR(db->handle, ALPM_ERR_DB_OPEN, -1);
-	}
-	if(stat(dbpath, &buf) != 0) {
-		RET_ERR(db->handle, ALPM_ERR_DB_OPEN, -1);
+	fd = _alpm_open_archive(db->handle, dbpath, &buf,
+			&archive, ALPM_ERR_DB_OPEN);
+	if(fd < 0) {
+		return -1;
 	}
 	est_count = estimate_package_count(&buf, archive);
 
-	/* initialize hash at 66% full */
-	db->pkgcache = _alpm_pkghash_create(est_count * 3 / 2);
+	db->pkgcache = _alpm_pkghash_create(est_count);
 	if(db->pkgcache == NULL) {
-		RET_ERR(db->handle, ALPM_ERR_MEMORY, -1);
+		db->handle->pm_errno = ALPM_ERR_MEMORY;
+		count = -1;
+		goto cleanup;
 	}
 
 	while(archive_read_next_header(archive, &entry) == ARCHIVE_OK) {
@@ -473,21 +463,26 @@
 	}
 
 	count = alpm_list_count(db->pkgcache->list);
-
 	if(count > 0) {
-		db->pkgcache->list = alpm_list_msort(db->pkgcache->list, (size_t)count, _alpm_pkg_cmp);
+		db->pkgcache->list = alpm_list_msort(db->pkgcache->list,
+				(size_t)count, _alpm_pkg_cmp);
 	}
-	archive_read_finish(archive);
-	_alpm_log(db->handle, ALPM_LOG_DEBUG, "added %d packages to package cache for db '%s'\n",
+	_alpm_log(db->handle, ALPM_LOG_DEBUG,
+			"added %d packages to package cache for db '%s'\n",
 			count, db->treename);
 
+cleanup:
+	archive_read_finish(archive);
+	if(fd >= 0) {
+		CLOSE(fd);
+	}
 	return count;
 }
 
 #define READ_NEXT() do { \
 	if(_alpm_archive_fgets(archive, &buf) != ARCHIVE_OK) goto error; \
 	line = buf.line; \
-	_alpm_strip_newline(line); \
+	_alpm_strip_newline(line, buf.real_line_size); \
 } while(0)
 
 #define READ_AND_STORE(f) do { \
@@ -498,14 +493,14 @@
 #define READ_AND_STORE_ALL(f) do { \
 	char *linedup; \
 	if(_alpm_archive_fgets(archive, &buf) != ARCHIVE_OK) goto error; \
-	if(_alpm_strip_newline(buf.line) == 0) break; \
+	if(_alpm_strip_newline(buf.line, buf.real_line_size) == 0) break; \
 	STRDUP(linedup, buf.line, goto error); \
 	f = alpm_list_add(f, linedup); \
 } while(1) /* note the while(1) and not (0) */
 
 #define READ_AND_SPLITDEP(f) do { \
 	if(_alpm_archive_fgets(archive, &buf) != ARCHIVE_OK) goto error; \
-	if(_alpm_strip_newline(buf.line) == 0) break; \
+	if(_alpm_strip_newline(buf.line, buf.real_line_size) == 0) break; \
 	f = alpm_list_add(f, _alpm_splitdep(line)); \
 } while(1) /* note the while(1) and not (0) */
 
@@ -544,7 +539,7 @@
 		int ret;
 		while((ret = _alpm_archive_fgets(archive, &buf)) == ARCHIVE_OK) {
 			char *line = buf.line;
-			if(_alpm_strip_newline(line) == 0) {
+			if(_alpm_strip_newline(line, buf.real_line_size) == 0) {
 				/* length of stripped line was zero */
 				continue;
 			}
@@ -595,7 +590,19 @@
 			} else if(strcmp(line, "%DEPENDS%") == 0) {
 				READ_AND_SPLITDEP(pkg->depends);
 			} else if(strcmp(line, "%OPTDEPENDS%") == 0) {
-				READ_AND_STORE_ALL(pkg->optdepends);
+				READ_AND_SPLITDEP(pkg->optdepends);
+			} else if(strcmp(line, "%MAKEDEPENDS%") == 0) {
+				/* currently unused */
+				while(1) {
+					READ_NEXT();
+					if(strlen(line) == 0) break;
+				}
+			} else if(strcmp(line, "%CHECKDEPENDS%") == 0) {
+				/* currently unused */
+				while(1) {
+					READ_NEXT();
+					if(strlen(line) == 0) break;
+				}
 			} else if(strcmp(line, "%CONFLICTS%") == 0) {
 				READ_AND_SPLITDEP(pkg->conflicts);
 			} else if(strcmp(line, "%PROVIDES%") == 0) {
@@ -605,7 +612,8 @@
 				while(1) {
 					READ_NEXT();
 					if(strlen(line) == 0) break;
-					pkg->deltas = alpm_list_add(pkg->deltas, _alpm_delta_parse(line));
+					pkg->deltas = alpm_list_add(pkg->deltas,
+							_alpm_delta_parse(db->handle, line));
 				}
 			}
 		}
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/conflict.c pacman/lib/libalpm/conflict.c
--- pacman-4.0.3/lib/libalpm/conflict.c	2011-10-26 22:29:38.000000000 +0000
+++ pacman/lib/libalpm/conflict.c	2012-10-15 18:11:52.485417724 +0000
@@ -1,7 +1,7 @@
 /*
  *  conflict.c
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *  Copyright (c) 2005 by Aurelien Foret <orelien@chez.com>
  *  Copyright (c) 2006 by David Kimpe <dnaku@frugalware.org>
@@ -22,8 +22,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <stdlib.h>
 #include <stdio.h>
 #include <string.h>
@@ -40,6 +38,7 @@
 #include "util.h"
 #include "log.h"
 #include "deps.h"
+#include "filelist.h"
 
 static alpm_conflict_t *conflict_new(alpm_pkg_t *pkg1, alpm_pkg_t *pkg2,
 		alpm_depend_t *reason)
@@ -215,67 +214,6 @@
 	return _alpm_innerconflicts(handle, pkglist);
 }
 
-static const int DIFFERENCE = 0;
-static const int INTERSECT = 1;
-/* Returns a set operation on the provided two lists of files.
- * Pre-condition: both lists are sorted!
- * When done, free the list but NOT the contained data.
- *
- * Operations:
- *   DIFFERENCE - a difference operation is performed. filesA - filesB.
- *   INTERSECT - an intersection operation is performed. filesA & filesB.
- */
-static alpm_list_t *filelist_operation(alpm_filelist_t *filesA,
-		alpm_filelist_t *filesB, int operation)
-{
-	alpm_list_t *ret = NULL;
-	size_t ctrA = 0, ctrB = 0;
-
-	while(ctrA < filesA->count && ctrB < filesB->count) {
-		alpm_file_t *fileA = filesA->files + ctrA;
-		alpm_file_t *fileB = filesB->files + ctrB;
-		const char *strA = fileA->name;
-		const char *strB = fileB->name;
-		/* skip directories, we don't care about them */
-		if(strA[strlen(strA)-1] == '/') {
-			ctrA++;
-		} else if(strB[strlen(strB)-1] == '/') {
-			ctrB++;
-		} else {
-			int cmp = strcmp(strA, strB);
-			if(cmp < 0) {
-				if(operation == DIFFERENCE) {
-					/* item only in filesA, qualifies as a difference */
-					ret = alpm_list_add(ret, fileA);
-				}
-				ctrA++;
-			} else if(cmp > 0) {
-				ctrB++;
-			} else {
-				if(operation == INTERSECT) {
-					/* item in both, qualifies as an intersect */
-					ret = alpm_list_add(ret, fileA);
-				}
-				ctrA++;
-				ctrB++;
-			}
-	  }
-	}
-
-	/* if doing a difference, ensure we have completely emptied pA */
-	while(operation == DIFFERENCE && ctrA < filesA->count) {
-		alpm_file_t *fileA = filesA->files + ctrA;
-		const char *strA = fileA->name;
-		/* skip directories */
-		if(strA[strlen(strA)-1] != '/') {
-			ret = alpm_list_add(ret, fileA);
-		}
-		ctrA++;
-	}
-
-	return ret;
-}
-
 /* Adds alpm_fileconflict_t to a conflicts list. Pass the conflicts list, the
  * conflicting file path, and either two packages or one package and NULL.
  */
@@ -314,29 +252,45 @@
 	FREE(conflict);
 }
 
-const alpm_file_t *_alpm_filelist_contains(alpm_filelist_t *filelist,
-		const char *name)
-{
-	size_t i;
-	const alpm_file_t *file = filelist->files;
-	for(i = 0; i < filelist->count; i++) {
-		if(strcmp(file->name, name) == 0) {
-			return file;
-		}
-		file++;
-	}
-	return NULL;
-}
-
-static int dir_belongsto_pkg(const char *root, const char *dirpath,
+static int dir_belongsto_pkg(alpm_handle_t *handle, const char *dirpath,
 		alpm_pkg_t *pkg)
 {
+	alpm_list_t *i;
 	struct stat sbuf;
 	char path[PATH_MAX];
 	char abspath[PATH_MAX];
-	struct dirent *ent = NULL;
 	DIR *dir;
+	struct dirent *ent = NULL;
+	const char *root = handle->root;
 
+	/* check directory is actually in package - used for subdirectory checks */
+	if(!alpm_filelist_contains(alpm_pkg_get_files(pkg), dirpath)) {
+		_alpm_log(handle, ALPM_LOG_DEBUG,
+				"directory %s not in package %s\n", dirpath, pkg->name);
+		return 0;
+	}
+
+	/* TODO: this is an overly strict check but currently pacman will not
+	 * overwrite a directory with a file (case 10/11 in add.c). Adjusting that
+	 * is not simple as even if the directory is being unowned by a conflicting
+	 * package, pacman does not sort this to ensure all required directory
+	 * "removals" happen before installation of file/symlink */
+
+	/* check that no other _installed_ package owns the directory */
+	for(i = _alpm_db_get_pkgcache(handle->db_local); i; i = i->next) {
+		if(pkg == i->data) {
+			continue;
+		}
+
+		if(alpm_filelist_contains(alpm_pkg_get_files(i->data), dirpath)) {
+			_alpm_log(handle, ALPM_LOG_DEBUG,
+					"file %s also in package %s\n", dirpath,
+					((alpm_pkg_t*)i->data)->name);
+			return 0;
+		}
+	}
+
+	/* check all files in directory are owned by the package */
 	snprintf(abspath, PATH_MAX, "%s%s", root, dirpath);
 	dir = opendir(abspath);
 	if(dir == NULL) {
@@ -349,23 +303,25 @@
 		if(strcmp(name, ".") == 0 || strcmp(name, "..") == 0) {
 			continue;
 		}
-		snprintf(path, PATH_MAX, "%s/%s", dirpath, name);
+		snprintf(path, PATH_MAX, "%s%s", dirpath, name);
 		snprintf(abspath, PATH_MAX, "%s%s", root, path);
 		if(stat(abspath, &sbuf) != 0) {
 			continue;
 		}
 		if(S_ISDIR(sbuf.st_mode)) {
-			if(dir_belongsto_pkg(root, path, pkg)) {
+			if(dir_belongsto_pkg(handle, path, pkg)) {
 				continue;
 			} else {
 				closedir(dir);
 				return 0;
 			}
 		} else {
-			if(_alpm_filelist_contains(alpm_pkg_get_files(pkg), path)) {
+			if(alpm_filelist_contains(alpm_pkg_get_files(pkg), path)) {
 				continue;
 			} else {
 				closedir(dir);
+				_alpm_log(handle, ALPM_LOG_DEBUG,
+						"unowned file %s found in directory\n", path);
 				return 0;
 			}
 		}
@@ -378,16 +334,19 @@
  * 1: check every target against every target
  * 2: check every target against the filesystem */
 alpm_list_t *_alpm_db_find_fileconflicts(alpm_handle_t *handle,
-		alpm_list_t *upgrade, alpm_list_t *remove)
+		alpm_list_t *upgrade, alpm_list_t *rem)
 {
 	alpm_list_t *i, *conflicts = NULL;
 	size_t numtargs = alpm_list_count(upgrade);
 	size_t current;
+	size_t rootlen;
 
 	if(!upgrade) {
 		return NULL;
 	}
 
+	rootlen = strlen(handle->root);
+
 	/* TODO this whole function needs a huge change, which hopefully will
 	 * be possible with real transactions. Right now we only do half as much
 	 * here as we do when we actually extract files in add.c with our 12
@@ -408,8 +367,8 @@
 		for(j = i->next; j; j = j->next) {
 			alpm_list_t *common_files;
 			alpm_pkg_t *p2 = j->data;
-			common_files = filelist_operation(alpm_pkg_get_files(p1),
-					alpm_pkg_get_files(p2), INTERSECT);
+			common_files = _alpm_filelist_intersection(alpm_pkg_get_files(p1),
+					alpm_pkg_get_files(p2));
 
 			if(common_files) {
 				alpm_list_t *k;
@@ -441,8 +400,8 @@
 		if(dbpkg) {
 			alpm_list_t *difference;
 			/* older ver of package currently installed */
-			difference = filelist_operation(alpm_pkg_get_files(p1),
-					alpm_pkg_get_files(dbpkg), DIFFERENCE);
+			difference = _alpm_filelist_difference(alpm_pkg_get_files(p1),
+					alpm_pkg_get_files(dbpkg));
 			tmpfiles.count = alpm_list_count(difference);
 			tmpfiles.files = alpm_list_to_array(difference, tmpfiles.count,
 					sizeof(alpm_file_t));
@@ -461,8 +420,9 @@
 			int resolved_conflict = 0;
 			struct stat lsbuf;
 			char path[PATH_MAX];
+			size_t pathlen;
 
-			snprintf(path, PATH_MAX, "%s%s", handle->root, filestr);
+			pathlen = snprintf(path, PATH_MAX, "%s%s", handle->root, filestr);
 
 			/* stat the file - if it exists, do some checks */
 			if(_alpm_lstat(path, &lsbuf) != 0) {
@@ -486,15 +446,15 @@
 				/* if we made it to here, we want all subsequent path comparisons to
 				 * not include the trailing slash. This allows things like file ->
 				 * directory replacements. */
-				path[strlen(path) - 1] = '\0';
+				path[pathlen - 1] = '\0';
 			}
 
-			relative_path = path + strlen(handle->root);
+			relative_path = path + rootlen;
 
 			/* Check remove list (will we remove the conflicting local file?) */
-			for(k = remove; k && !resolved_conflict; k = k->next) {
+			for(k = rem; k && !resolved_conflict; k = k->next) {
 				alpm_pkg_t *rempkg = k->data;
-				if(rempkg && _alpm_filelist_contains(alpm_pkg_get_files(rempkg),
+				if(rempkg && alpm_filelist_contains(alpm_pkg_get_files(rempkg),
 							relative_path)) {
 					_alpm_log(handle, ALPM_LOG_DEBUG,
 							"local file will be removed, not a conflict\n");
@@ -511,7 +471,7 @@
 				alpm_pkg_t *localp2 = _alpm_db_get_pkgfromcache(handle->db_local, p2->name);
 
 				/* localp2->files will be removed (target conflicts are handled by CHECK 1) */
-				if(localp2 && _alpm_filelist_contains(alpm_pkg_get_files(localp2), filestr)) {
+				if(localp2 && alpm_filelist_contains(alpm_pkg_get_files(localp2), filestr)) {
 					/* skip removal of file, but not add. this will prevent a second
 					 * package from removing the file when it was already installed
 					 * by its new owner (whether the file is in backup array or not */
@@ -527,11 +487,11 @@
 			if(!resolved_conflict && S_ISDIR(lsbuf.st_mode) && dbpkg) {
 				char *dir = malloc(strlen(filestr) + 2);
 				sprintf(dir, "%s/", filestr);
-				if(_alpm_filelist_contains(alpm_pkg_get_files(dbpkg), dir)) {
+				if(alpm_filelist_contains(alpm_pkg_get_files(dbpkg), dir)) {
 					_alpm_log(handle, ALPM_LOG_DEBUG,
-							"check if all files in %s belongs to %s\n",
+							"checking if all files in %s belong to %s\n",
 							dir, dbpkg->name);
-					resolved_conflict = dir_belongsto_pkg(handle->root, filestr, dbpkg);
+					resolved_conflict = dir_belongsto_pkg(handle, dir, dbpkg);
 				}
 				free(dir);
 			}
@@ -541,17 +501,15 @@
 			 * consideration cannot itself be a link, as it might be unowned- path
 			 * components can be safely checked as all directories are "unowned". */
 			if(!resolved_conflict && dbpkg && !S_ISLNK(lsbuf.st_mode)) {
-				char *rpath = calloc(PATH_MAX, sizeof(char));
-				const char *relative_rpath;
+				char rpath[PATH_MAX];
 				if(realpath(path, rpath)) {
-					relative_rpath = rpath + strlen(handle->root);
-					if(_alpm_filelist_contains(alpm_pkg_get_files(dbpkg), relative_rpath)) {
+					const char *relative_rpath = rpath + rootlen;
+					if(alpm_filelist_contains(alpm_pkg_get_files(dbpkg), relative_rpath)) {
 						_alpm_log(handle, ALPM_LOG_DEBUG,
 								"package contained the resolved realpath\n");
 						resolved_conflict = 1;
 					}
 				}
-				free(rpath);
 			}
 
 			/* is the file unowned and in the backup list of the new package? */
@@ -559,7 +517,7 @@
 				alpm_list_t *local_pkgs = _alpm_db_get_pkgcache(handle->db_local);
 				int found = 0;
 				for(k = local_pkgs; k && !found; k = k->next) {
-					if(_alpm_filelist_contains(alpm_pkg_get_files(k->data), filestr)) {
+					if(alpm_filelist_contains(alpm_pkg_get_files(k->data), filestr)) {
 							found = 1;
 					}
 				}
@@ -575,7 +533,7 @@
 				if(handle->pm_errno == ALPM_ERR_MEMORY) {
 					FREELIST(conflicts);
 					if(dbpkg) {
-						/* only freed if it was generated from filelist_operation() */
+						/* only freed if it was generated from _alpm_filelist_difference() */
 						free(tmpfiles.files);
 					}
 					return NULL;
@@ -583,7 +541,7 @@
 			}
 		}
 		if(dbpkg) {
-			/* only freed if it was generated from filelist_operation() */
+			/* only freed if it was generated from _alpm_filelist_difference() */
 			free(tmpfiles.files);
 		}
 	}
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/conflict.h pacman/lib/libalpm/conflict.h
--- pacman-4.0.3/lib/libalpm/conflict.h	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/conflict.h	2012-10-15 18:11:52.485417724 +0000
@@ -1,7 +1,7 @@
 /*
  *  conflict.h
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -33,9 +33,6 @@
 
 void _alpm_fileconflict_free(alpm_fileconflict_t *conflict);
 
-const alpm_file_t *_alpm_filelist_contains(alpm_filelist_t *filelist,
-		const char *name);
-
 #endif /* _ALPM_CONFLICT_H */
 
 /* vim: set ts=2 sw=2 noet: */
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/db.c pacman/lib/libalpm/db.c
--- pacman-4.0.3/lib/libalpm/db.c	2011-12-29 20:23:11.000000000 +0000
+++ pacman/lib/libalpm/db.c	2012-10-15 18:11:52.485417724 +0000
@@ -1,7 +1,7 @@
 /*
  *  db.c
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *  Copyright (c) 2005 by Aurelien Foret <orelien@chez.com>
  *  Copyright (c) 2005 by Christian Hamar <krics@linuxforum.hu>
@@ -22,8 +22,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
@@ -45,7 +43,7 @@
  */
 
 /** Register a sync database of packages. */
-alpm_db_t SYMEXPORT *alpm_db_register_sync(alpm_handle_t *handle,
+alpm_db_t SYMEXPORT *alpm_register_syncdb(alpm_handle_t *handle,
 		const char *treename, alpm_siglevel_t level)
 {
 	/* Sanity checks */
@@ -70,7 +68,7 @@
 }
 
 /** Unregister all package databases. */
-int SYMEXPORT alpm_db_unregister_all(alpm_handle_t *handle)
+int SYMEXPORT alpm_unregister_all_syncdbs(alpm_handle_t *handle)
 {
 	alpm_list_t *i;
 	alpm_db_t *db;
@@ -109,7 +107,7 @@
 	} else {
 		/* Warning : this function shouldn't be used to unregister all sync
 		 * databases by walking through the list returned by
-		 * alpm_option_get_syncdbs, because the db is removed from that list here.
+		 * alpm_get_syncdbs, because the db is removed from that list here.
 		 */
 		void *data;
 		handle->dbs_sync = alpm_list_remove(handle->dbs_sync,
@@ -138,7 +136,7 @@
 int SYMEXPORT alpm_db_set_servers(alpm_db_t *db, alpm_list_t *servers)
 {
 	ASSERT(db != NULL, return -1);
-	if(db->servers) FREELIST(db->servers);
+	FREELIST(db->servers);
 	db->servers = servers;
 	return 0;
 }
@@ -263,7 +261,7 @@
 }
 
 /** Get a group entry from a package database. */
-alpm_group_t SYMEXPORT *alpm_db_readgroup(alpm_db_t *db, const char *name)
+alpm_group_t SYMEXPORT *alpm_db_get_group(alpm_db_t *db, const char *name)
 {
 	ASSERT(db != NULL, return NULL);
 	db->handle->pm_errno = 0;
@@ -283,7 +281,7 @@
 }
 
 /** Searches a database. */
-alpm_list_t SYMEXPORT *alpm_db_search(alpm_db_t *db, const alpm_list_t* needles)
+alpm_list_t SYMEXPORT *alpm_db_search(alpm_db_t *db, const alpm_list_t *needles)
 {
 	ASSERT(db != NULL, return NULL);
 	db->handle->pm_errno = 0;
@@ -291,32 +289,6 @@
 	return _alpm_db_search(db, needles);
 }
 
-/** Set install reason for a package in db. */
-int SYMEXPORT alpm_db_set_pkgreason(alpm_handle_t *handle, alpm_pkg_t *pkg,
-		alpm_pkgreason_t reason)
-{
-	CHECK_HANDLE(handle, return -1);
-	ASSERT(pkg != NULL, RET_ERR(handle, ALPM_ERR_WRONG_ARGS, -1));
-	ASSERT(pkg->origin == PKG_FROM_LOCALDB,
-			RET_ERR(handle, ALPM_ERR_WRONG_ARGS, -1));
-	ASSERT(pkg->origin_data.db == handle->db_local,
-			RET_ERR(handle, ALPM_ERR_WRONG_ARGS, -1));
-
-	_alpm_log(handle, ALPM_LOG_DEBUG,
-			"setting install reason %u for %s\n", reason, pkg->name);
-	if(alpm_pkg_get_reason(pkg) == reason) {
-		/* we are done */
-		return 0;
-	}
-	/* set reason (in pkgcache) */
-	pkg->reason = reason;
-	/* write DESC */
-	if(_alpm_local_db_write(handle->db_local, pkg, INFRQ_DESC)) {
-		RET_ERR(handle, ALPM_ERR_DB_WRITE, -1);
-	}
-
-	return 0;
-}
 
 /** @} */
 
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/db.h pacman/lib/libalpm/db.h
--- pacman-4.0.3/lib/libalpm/db.h	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/db.h	2012-10-15 18:11:52.485417724 +0000
@@ -1,7 +1,7 @@
 /*
  *  db.h
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *  Copyright (c) 2005 by Aurelien Foret <orelien@chez.com>
  *  Copyright (c) 2006 by Miklos Vajna <vmiklos@frugalware.org>
@@ -22,8 +22,6 @@
 #ifndef _ALPM_DB_H
 #define _ALPM_DB_H
 
-#include <time.h>
-
 /* libarchive */
 #include <archive.h>
 #include <archive_entry.h>
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/delta.c pacman/lib/libalpm/delta.c
--- pacman-4.0.3/lib/libalpm/delta.c	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/delta.c	2012-10-15 18:11:52.485417724 +0000
@@ -1,7 +1,7 @@
 /*
  *  delta.c
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2007-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -18,8 +18,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <stdlib.h>
 #include <string.h>
 #include <stdint.h> /* intmax_t */
@@ -266,7 +264,8 @@
 alpm_list_t SYMEXPORT *alpm_pkg_unused_deltas(alpm_pkg_t *pkg)
 {
 	ASSERT(pkg != NULL, return NULL);
-	return find_unused(pkg->deltas, pkg->filename, pkg->size * MAX_DELTA_RATIO);
+	return find_unused(pkg->deltas, pkg->filename,
+			pkg->size * pkg->handle->deltaratio);
 }
 
 /** @} */
@@ -275,51 +274,54 @@
  * This function assumes that the string is in the correct format.
  * This format is as follows:
  * $deltafile $deltamd5 $deltasize $oldfile $newfile
+ * @param handle the context handle
  * @param line the string to parse
  * @return A pointer to the new alpm_delta_t object
  */
-/* TODO this does not really belong here, but in a parsing lib */
-alpm_delta_t *_alpm_delta_parse(char *line)
+alpm_delta_t *_alpm_delta_parse(alpm_handle_t *handle, const char *line)
 {
 	alpm_delta_t *delta;
-	char *tmp = line, *tmp2;
-	regex_t reg;
+	const int num_matches = 6;
+	size_t len;
+	regmatch_t pmatch[num_matches];
+	char filesize[32];
+
+	/* this is so we only have to compile the pattern once */
+	if(!handle->delta_regex_compiled) {
+		/* $deltafile $deltamd5 $deltasize $oldfile $newfile*/
+		regcomp(&handle->delta_regex,
+				"^([^[:space:]]+) ([[:xdigit:]]{32}) ([[:digit:]]+)"
+				" ([^[:space:]]+) ([^[:space:]]+)$",
+				REG_EXTENDED | REG_NEWLINE);
+		handle->delta_regex_compiled = 1;
+	}
 
-	regcomp(&reg,
-			"^[^[:space:]]* [[:xdigit:]]{32} [[:digit:]]*"
-			" [^[:space:]]* [^[:space:]]*$",
-			REG_EXTENDED | REG_NOSUB | REG_NEWLINE);
-	if(regexec(&reg, line, 0, 0, 0) != 0) {
+	if(regexec(&handle->delta_regex, line, num_matches, pmatch, 0) != 0) {
 		/* delta line is invalid, return NULL */
-		regfree(&reg);
 		return NULL;
 	}
-	regfree(&reg);
 
 	CALLOC(delta, 1, sizeof(alpm_delta_t), return NULL);
 
-	tmp2 = tmp;
-	tmp = strchr(tmp, ' ');
-	*(tmp++) = '\0';
-	STRDUP(delta->delta, tmp2, return NULL);
-
-	tmp2 = tmp;
-	tmp = strchr(tmp, ' ');
-	*(tmp++) = '\0';
-	STRDUP(delta->delta_md5, tmp2, return NULL);
-
-	tmp2 = tmp;
-	tmp = strchr(tmp, ' ');
-	*(tmp++) = '\0';
-	delta->delta_size = _alpm_strtoofft(tmp2);
-
-	tmp2 = tmp;
-	tmp = strchr(tmp, ' ');
-	*(tmp++) = '\0';
-	STRDUP(delta->from, tmp2, return NULL);
+	/* start at index 1 -- match 0 is the entire match */
+	len = pmatch[1].rm_eo - pmatch[1].rm_so;
+	STRNDUP(delta->delta, &line[pmatch[1].rm_so], len, return NULL);
+
+	len = pmatch[2].rm_eo - pmatch[2].rm_so;
+	STRNDUP(delta->delta_md5, &line[pmatch[2].rm_so], len, return NULL);
+
+	len = pmatch[3].rm_eo - pmatch[3].rm_so;
+	if(len < sizeof(filesize)) {
+		strncpy(filesize, &line[pmatch[3].rm_so], len);
+		filesize[len] = '\0';
+		delta->delta_size = _alpm_strtoofft(filesize);
+	}
+
+	len = pmatch[4].rm_eo - pmatch[4].rm_so;
+	STRNDUP(delta->from, &line[pmatch[4].rm_so], len, return NULL);
 
-	tmp2 = tmp;
-	STRDUP(delta->to, tmp2, return NULL);
+	len = pmatch[5].rm_eo - pmatch[5].rm_so;
+	STRNDUP(delta->to, &line[pmatch[5].rm_so], len, return NULL);
 
 	return delta;
 }
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/delta.h pacman/lib/libalpm/delta.h
--- pacman-4.0.3/lib/libalpm/delta.h	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/delta.h	2012-10-15 18:11:52.485417724 +0000
@@ -1,7 +1,7 @@
 /*
  *  delta.h
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2007-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -20,21 +20,16 @@
 #ifndef _ALPM_DELTA_H
 #define _ALPM_DELTA_H
 
-#include "config.h" /* ensure off_t is correct length */
-
 #include <sys/types.h> /* off_t */
 
 #include "alpm.h"
 
-alpm_delta_t *_alpm_delta_parse(char *line);
+alpm_delta_t *_alpm_delta_parse(alpm_handle_t *handle, const char *line);
 void _alpm_delta_free(alpm_delta_t *delta);
 alpm_delta_t *_alpm_delta_dup(const alpm_delta_t *delta);
 off_t _alpm_shortest_delta_path(alpm_handle_t *handle, alpm_list_t *deltas,
 		const char *to, alpm_list_t **path);
 
-/* max percent of package size to download deltas */
-#define MAX_DELTA_RATIO 0.7
-
 #endif /* _ALPM_DELTA_H */
 
 /* vim: set ts=2 sw=2 noet: */
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/deps.c pacman/lib/libalpm/deps.c
--- pacman-4.0.3/lib/libalpm/deps.c	2012-02-15 21:57:20.000000000 +0000
+++ pacman/lib/libalpm/deps.c	2012-10-15 18:11:52.485417724 +0000
@@ -1,7 +1,7 @@
 /*
  *  deps.c
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *  Copyright (c) 2005 by Aurelien Foret <orelien@chez.com>
  *  Copyright (c) 2005, 2006 by Miklos Vajna <vmiklos@frugalware.org>
@@ -20,8 +20,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <stdlib.h>
 #include <stdio.h>
 #include <string.h>
@@ -41,6 +39,7 @@
 {
 	FREE(dep->name);
 	FREE(dep->version);
+	FREE(dep->desc);
 	FREE(dep);
 }
 
@@ -159,15 +158,17 @@
 			else if(nextchild->state == -1) {
 				alpm_pkg_t *vertexpkg = vertex->data;
 				alpm_pkg_t *childpkg = nextchild->data;
-				const char *message;
 
 				_alpm_log(handle, ALPM_LOG_WARNING, _("dependency cycle detected:\n"));
 				if(reverse) {
-					message =_("%s will be removed after its %s dependency\n");
+					_alpm_log(handle, ALPM_LOG_WARNING,
+							_("%s will be removed after its %s dependency\n"),
+							vertexpkg->name, childpkg->name);
 				} else {
-					message =_("%s will be installed before its %s dependency\n");
+					_alpm_log(handle, ALPM_LOG_WARNING,
+							_("%s will be installed before its %s dependency\n"),
+							vertexpkg->name, childpkg->name);
 				}
-				_alpm_log(handle, ALPM_LOG_WARNING, message, vertexpkg->name, childpkg->name);
 			}
 		}
 		if(!found) {
@@ -204,8 +205,10 @@
 
 static int no_dep_version(alpm_handle_t *handle)
 {
-	int flags = alpm_trans_get_flags(handle);
-	return flags != -1 && (flags & ALPM_TRANS_FLAG_NODEPVERSION);
+	if(!handle->trans) {
+		return 0;
+	}
+	return (handle->trans->flags & ALPM_TRANS_FLAG_NODEPVERSION);
 }
 
 static alpm_depend_t *filtered_depend(alpm_depend_t *dep, int nodepversion)
@@ -266,7 +269,7 @@
  * @return an alpm_list_t* of alpm_depmissing_t pointers.
  */
 alpm_list_t SYMEXPORT *alpm_checkdeps(alpm_handle_t *handle,
-		alpm_list_t *pkglist, alpm_list_t *remove, alpm_list_t *upgrade,
+		alpm_list_t *pkglist, alpm_list_t *rem, alpm_list_t *upgrade,
 		int reversedeps)
 {
 	alpm_list_t *i, *j;
@@ -278,7 +281,7 @@
 
 	for(i = pkglist; i; i = i->next) {
 		alpm_pkg_t *pkg = i->data;
-		if(_alpm_pkg_find(remove, pkg->name) || _alpm_pkg_find(upgrade, pkg->name)) {
+		if(_alpm_pkg_find(rem, pkg->name) || _alpm_pkg_find(upgrade, pkg->name)) {
 			modified = alpm_list_add(modified, pkg);
 		} else {
 			dblist = alpm_list_add(dblist, pkg);
@@ -395,7 +398,7 @@
 			/* any version will satisfy the requirement */
 			satisfy = (provision->name_hash == dep->name_hash
 					&& strcmp(provision->name, dep->name) == 0);
-		} else if (provision->mod == ALPM_DEP_MOD_EQ) {
+		} else if(provision->mod == ALPM_DEP_MOD_EQ) {
 			/* provision specifies a version, so try it out */
 			satisfy = (provision->name_hash == dep->name_hash
 					&& strcmp(provision->name, dep->name) == 0
@@ -409,7 +412,7 @@
 alpm_depend_t *_alpm_splitdep(const char *depstring)
 {
 	alpm_depend_t *depend;
-	const char *ptr, *version;
+	const char *ptr, *version, *desc;
 	size_t deplen;
 
 	if(depstring == NULL) {
@@ -417,7 +420,17 @@
 	}
 
 	MALLOC(depend, sizeof(alpm_depend_t), return NULL);
-	deplen = strlen(depstring);
+
+	/* Note the extra space in ": " to avoid matching the epoch */
+	if((desc = strstr(depstring, ": ")) != NULL) {
+		STRDUP(depend->desc, desc + 2, return NULL);
+		deplen = desc - depstring;
+	} else {
+		/* no description- point desc at NULL at end of string for later use */
+		depend->desc = NULL;
+		deplen = strlen(depstring);
+		desc = depstring + deplen;
+	}
 
 	/* Find a version comparator if one exists. If it does, set the type and
 	 * increment the ptr accordingly so we can copy the right strings. */
@@ -442,21 +455,18 @@
 		depend->mod = ALPM_DEP_MOD_EQ;
 		version = ptr + 1;
 	} else {
-		/* no version specified, leave ptr NULL and set version to NULL */
+		/* no version specified, set ptr to end of string and version to NULL */
+		ptr = depstring + deplen;
 		depend->mod = ALPM_DEP_MOD_ANY;
 		depend->version = NULL;
 		version = NULL;
 	}
 
 	/* copy the right parts to the right places */
-	if(ptr) {
-		STRNDUP(depend->name, depstring, ptr - depstring, return NULL);
-	} else {
-		STRDUP(depend->name, depstring, return NULL);
-	}
+	STRNDUP(depend->name, depstring, ptr - depstring, return NULL);
 	depend->name_hash = _alpm_hash_sdbm(depend->name);
 	if(version) {
-		STRDUP(depend->version, version, return NULL);
+		STRNDUP(depend->version, version, desc - version, return NULL);
 	}
 
 	return depend;
@@ -468,8 +478,9 @@
 	CALLOC(newdep, 1, sizeof(alpm_depend_t), return NULL);
 
 	STRDUP(newdep->name, dep->name, return NULL);
-	newdep->name_hash = dep->name_hash;
 	STRDUP(newdep->version, dep->version, return NULL);
+	STRDUP(newdep->desc, dep->desc, return NULL);
+	newdep->name_hash = dep->name_hash;
 	newdep->mod = dep->mod;
 
 	return newdep;
@@ -639,14 +650,14 @@
 	count = alpm_list_count(providers);
 	if(count >= 1) {
 		/* default to first provider if there is no QUESTION callback */
-		int index = 0;
+		int idx = 0;
 		if(count > 1) {
 			/* if there is more than one provider, we ask the user */
 			QUESTION(handle, ALPM_QUESTION_SELECT_PROVIDER,
-					providers, dep, NULL, &index);
+					providers, dep, NULL, &idx);
 		}
-		if(index >= 0 && index < count) {
-			alpm_list_t *nth = alpm_list_nth(providers, index);
+		if(idx >= 0 && idx < count) {
+			alpm_list_t *nth = alpm_list_nth(providers, idx);
 			alpm_pkg_t *pkg = nth->data;
 			alpm_list_free(providers);
 			return pkg;
@@ -711,7 +722,7 @@
  */
 int _alpm_resolvedeps(alpm_handle_t *handle, alpm_list_t *localpkgs,
 		alpm_pkg_t *pkg, alpm_list_t *preferred, alpm_list_t **packages,
-		alpm_list_t *remove, alpm_list_t **data)
+		alpm_list_t *rem, alpm_list_t **data)
 {
 	int ret = 0;
 	alpm_list_t *i, *j;
@@ -734,7 +745,7 @@
 	for(i = alpm_list_last(*packages); i; i = i->next) {
 		alpm_pkg_t *tpkg = i->data;
 		targ = alpm_list_add(NULL, tpkg);
-		deps = alpm_checkdeps(handle, localpkgs, remove, targ, 0);
+		deps = alpm_checkdeps(handle, localpkgs, rem, targ, 0);
 		alpm_list_free(targ);
 
 		for(j = deps; j; j = j->next) {
@@ -792,7 +803,7 @@
  */
 char SYMEXPORT *alpm_dep_compute_string(const alpm_depend_t *dep)
 {
-	const char *name, *opr, *ver;
+	const char *name, *opr, *ver, *desc_delim, *desc;
 	char *str;
 	size_t len;
 
@@ -834,12 +845,21 @@
 		ver = "";
 	}
 
+	if(dep->desc) {
+		desc_delim = ": ";
+		desc = dep->desc;
+	} else {
+		desc_delim = "";
+		desc = "";
+	}
+
 	/* we can always compute len and print the string like this because opr
 	 * and ver will be empty when ALPM_DEP_MOD_ANY is the depend type. the
 	 * reassignments above also ensure we do not do a strlen(NULL). */
-	len = strlen(name) + strlen(opr) + strlen(ver) + 1;
+	len = strlen(name) + strlen(opr) + strlen(ver)
+		+ strlen(desc_delim) + strlen(desc) + 1;
 	MALLOC(str, len, return NULL);
-	snprintf(str, len, "%s%s%s", name, opr, ver);
+	snprintf(str, len, "%s%s%s%s%s", name, opr, ver, desc_delim, desc);
 
 	return str;
 }
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/deps.h pacman/lib/libalpm/deps.h
--- pacman-4.0.3/lib/libalpm/deps.h	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/deps.h	2012-10-15 18:11:52.485417724 +0000
@@ -1,7 +1,7 @@
 /*
  *  deps.h
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *  Copyright (c) 2005 by Aurelien Foret <orelien@chez.com>
  *  Copyright (c) 2006 by Miklos Vajna <vmiklos@frugalware.org>
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/diskspace.c pacman/lib/libalpm/diskspace.c
--- pacman-4.0.3/lib/libalpm/diskspace.c	2012-02-20 05:04:04.000000000 +0000
+++ pacman/lib/libalpm/diskspace.c	2012-10-15 18:11:52.485417724 +0000
@@ -17,8 +17,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <stdio.h>
 #include <errno.h>
 
@@ -60,6 +58,37 @@
 	return -strcmp(mp1->mount_dir, mp2->mount_dir);
 }
 
+static void mount_point_list_free(alpm_list_t *mount_points)
+{
+	alpm_list_t *i;
+
+	for(i = mount_points; i; i = i->next) {
+		alpm_mountpoint_t *data = i->data;
+		FREE(data->mount_dir);
+	}
+	FREELIST(mount_points);
+}
+
+static int mount_point_load_fsinfo(alpm_handle_t *handle, alpm_mountpoint_t *mountpoint)
+{
+#if defined(HAVE_GETMNTENT)
+	/* grab the filesystem usage */
+	if(statvfs(mountpoint->mount_dir, &(mountpoint->fsp)) != 0) {
+		_alpm_log(handle, ALPM_LOG_WARNING,
+				_("could not get filesystem information for %s: %s\n"),
+				mountpoint->mount_dir, strerror(errno));
+		mountpoint->fsinfo_loaded = MOUNT_FSINFO_FAIL;
+		return -1;
+	}
+
+	_alpm_log(handle, ALPM_LOG_DEBUG, "loading fsinfo for %s\n", mountpoint->mount_dir);
+	mountpoint->read_only = mountpoint->fsp.f_flag & ST_RDONLY;
+	mountpoint->fsinfo_loaded = MOUNT_FSINFO_LOADED;
+#endif
+
+	return 0;
+}
+
 static alpm_list_t *mount_point_list(alpm_handle_t *handle)
 {
 	alpm_list_t *mount_points = NULL, *ptr;
@@ -73,28 +102,15 @@
 	fp = setmntent(MOUNTED, "r");
 
 	if(fp == NULL) {
+		_alpm_log(handle, ALPM_LOG_ERROR, _("could not open file: %s: %s\n"),
+				MOUNTED, strerror(errno));
 		return NULL;
 	}
 
 	while((mnt = getmntent(fp))) {
-		struct statvfs fsp;
-		if(!mnt) {
-			_alpm_log(handle, ALPM_LOG_WARNING,
-					_("could not get filesystem information\n"));
-			continue;
-		}
-		if(statvfs(mnt->mnt_dir, &fsp) != 0) {
-			_alpm_log(handle, ALPM_LOG_WARNING,
-					_("could not get filesystem information for %s: %s\n"),
-					mnt->mnt_dir, strerror(errno));
-			continue;
-		}
-
 		CALLOC(mp, 1, sizeof(alpm_mountpoint_t), RET_ERR(handle, ALPM_ERR_MEMORY, NULL));
 		mp->mount_dir = strdup(mnt->mnt_dir);
 		mp->mount_dir_len = strlen(mp->mount_dir);
-		memcpy(&(mp->fsp), &fsp, sizeof(struct statvfs));
-		mp->read_only = fsp.f_flag & ST_RDONLY;
 
 		mount_points = alpm_list_add(mount_points, mp);
 	}
@@ -109,23 +125,15 @@
 	fp = fopen("/etc/mnttab", "r");
 
 	if(fp == NULL) {
+		_alpm_log(handle, ALPM_LOG_ERROR, _("could not open file %s: %s\n"),
+				"/etc/mnttab", strerror(errno));
 		return NULL;
 	}
 
 	while((ret = getmntent(fp, &mnt)) == 0) {
-		struct statvfs fsp;
-		if(statvfs(mnt->mnt_mountp, &fsp) != 0) {
-			_alpm_log(handle, ALPM_LOG_WARNING,
-					_("could not get filesystem information for %s: %s\n"),
-					mnt->mnt_mountp, strerror(errno));
-			continue;
-		}
-
 		CALLOC(mp, 1, sizeof(alpm_mountpoint_t), RET_ERR(handle, ALPM_ERR_MEMORY, NULL));
 		mp->mount_dir = strdup(mnt->mnt_mountp);
 		mp->mount_dir_len = strlen(mp->mount_dir);
-		memcpy(&(mp->fsp), &fsp, sizeof(struct statvfs));
-		mp->read_only = fsp.f_flag & ST_RDONLY;
 
 		mount_points = alpm_list_add(mount_points, mp);
 	}
@@ -144,6 +152,8 @@
 	entries = getmntinfo(&fsp, MNT_NOWAIT);
 
 	if(entries < 0) {
+		_alpm_log(handle, ALPM_LOG_ERROR,
+				_("could not get filesystem information\n"));
 		return NULL;
 	}
 
@@ -158,6 +168,9 @@
 		mp->read_only = fsp->f_flags & MNT_RDONLY;
 #endif
 
+		/* we don't support lazy loading on this platform */
+		mp->fsinfo_loaded = MOUNT_FSINFO_LOADED;
+
 		mount_points = alpm_list_add(mount_points, mp);
 	}
 #endif
@@ -166,7 +179,7 @@
 			mount_point_cmp);
 	for(ptr = mount_points; ptr != NULL; ptr = ptr->next) {
 		mp = ptr->data;
-		_alpm_log(handle, ALPM_LOG_DEBUG, "mountpoint: %s\n", mp->mount_dir);
+		_alpm_log(handle, ALPM_LOG_DEBUG, "discovered mountpoint: %s\n", mp->mount_dir);
 	}
 	return mount_points;
 }
@@ -215,6 +228,7 @@
 		alpm_mountpoint_t *mp;
 		struct stat st;
 		char path[PATH_MAX];
+		blkcnt_t remove_size;
 		const char *filename = file->name;
 
 		snprintf(path, PATH_MAX, "%s%s", handle->root, filename);
@@ -233,9 +247,21 @@
 			continue;
 		}
 
+		/* don't check a mount that we know we can't stat */
+		if(mp && mp->fsinfo_loaded == MOUNT_FSINFO_FAIL) {
+			continue;
+		}
+
+		/* lazy load filesystem info */
+		if(mp->fsinfo_loaded == MOUNT_FSINFO_UNLOADED) {
+			if(mount_point_load_fsinfo(handle, mp) < 0) {
+				continue;
+			}
+		}
+
 		/* the addition of (divisor - 1) performs ceil() with integer division */
-		mp->blocks_needed -=
-			(st.st_size + mp->fsp.f_bsize - 1) / mp->fsp.f_bsize;
+		remove_size = (st.st_size + mp->fsp.f_bsize - 1) / mp->fsp.f_bsize;
+		mp->blocks_needed -= remove_size;
 		mp->used |= USED_REMOVE;
 	}
 
@@ -256,6 +282,7 @@
 		const alpm_file_t *file = filelist->files + i;
 		alpm_mountpoint_t *mp;
 		char path[PATH_MAX];
+		blkcnt_t install_size;
 		const char *filename = file->name;
 
 		/* libarchive reports these as zero size anyways */
@@ -279,15 +306,108 @@
 			continue;
 		}
 
+		/* don't check a mount that we know we can't stat */
+		if(mp && mp->fsinfo_loaded == MOUNT_FSINFO_FAIL) {
+			continue;
+		}
+
+		/* lazy load filesystem info */
+		if(mp->fsinfo_loaded == MOUNT_FSINFO_UNLOADED) {
+			if(mount_point_load_fsinfo(handle, mp) < 0) {
+				continue;
+			}
+		}
+
 		/* the addition of (divisor - 1) performs ceil() with integer division */
-		mp->blocks_needed +=
-			(file->size + mp->fsp.f_bsize - 1) / mp->fsp.f_bsize;
+		install_size = (file->size + mp->fsp.f_bsize - 1) / mp->fsp.f_bsize;
+		mp->blocks_needed += install_size;
 		mp->used |= USED_INSTALL;
 	}
 
 	return 0;
 }
 
+static int check_mountpoint(alpm_handle_t *handle, alpm_mountpoint_t *mp)
+{
+	/* cushion is roughly min(5% capacity, 20MiB) */
+	fsblkcnt_t fivepc = (mp->fsp.f_blocks / 20) + 1;
+	fsblkcnt_t twentymb = (20 * 1024 * 1024 / mp->fsp.f_bsize) + 1;
+	fsblkcnt_t cushion = fivepc < twentymb ? fivepc : twentymb;
+	blkcnt_t needed = mp->max_blocks_needed + cushion;
+
+	_alpm_log(handle, ALPM_LOG_DEBUG,
+			"partition %s, needed %jd, cushion %ju, free %ju\n",
+			mp->mount_dir, (intmax_t)mp->max_blocks_needed,
+			(uintmax_t)cushion, (uintmax_t)mp->fsp.f_bfree);
+	if(needed >= 0 && (fsblkcnt_t)needed > mp->fsp.f_bfree) {
+		_alpm_log(handle, ALPM_LOG_ERROR,
+				_("Partition %s too full: %jd blocks needed, %jd blocks free\n"),
+				mp->mount_dir, (intmax_t)needed, (uintmax_t)mp->fsp.f_bfree);
+		return 1;
+	}
+	return 0;
+}
+
+int _alpm_check_downloadspace(alpm_handle_t *handle, const char *cachedir,
+		size_t num_files, off_t *file_sizes)
+{
+	alpm_list_t *mount_points;
+	alpm_mountpoint_t *cachedir_mp;
+	char resolved_cachedir[PATH_MAX];
+	size_t j;
+	int error = 0;
+
+	/* resolve the cachedir path to ensure we check the right mountpoint.  We
+	 * handle failures silently, and continue to use the possibly unresolved
+	 * path. */
+	if(realpath(cachedir, resolved_cachedir) != NULL) {
+		cachedir = resolved_cachedir;
+	}
+
+	mount_points = mount_point_list(handle);
+	if(mount_points == NULL) {
+		_alpm_log(handle, ALPM_LOG_ERROR, _("could not determine filesystem mount points\n"));
+		return -1;
+	}
+
+	cachedir_mp = match_mount_point(mount_points, cachedir);
+	if(cachedir_mp == NULL) {
+		_alpm_log(handle, ALPM_LOG_ERROR, _("could not determine cachedir mount point %s\n"),
+				cachedir);
+		error = 1;
+		goto finish;
+	}
+
+	if(cachedir_mp->fsinfo_loaded == MOUNT_FSINFO_UNLOADED) {
+		if(mount_point_load_fsinfo(handle, cachedir_mp)) {
+			error = 1;
+			goto finish;
+		}
+	}
+
+	/* there's no need to check for a R/O mounted filesystem here, as
+	 * _alpm_filecache_setup will never give us a non-writable directory */
+
+	/* round up the size of each file to the nearest block and accumulate */
+	for(j = 0; j < num_files; j++) {
+		cachedir_mp->max_blocks_needed += (file_sizes[j] + cachedir_mp->fsp.f_bsize + 1) /
+			cachedir_mp->fsp.f_bsize;
+	}
+
+	if(check_mountpoint(handle, cachedir_mp)) {
+		error = 1;
+	}
+
+finish:
+	mount_point_list_free(mount_points);
+
+	if(error) {
+		RET_ERR(handle, ALPM_ERR_DISK_SPACE, -1);
+	}
+
+	return 0;
+}
+
 int _alpm_check_diskspace(alpm_handle_t *handle)
 {
 	alpm_list_t *mount_points, *i;
@@ -356,32 +476,13 @@
 			_alpm_log(handle, ALPM_LOG_ERROR, _("Partition %s is mounted read only\n"),
 					data->mount_dir);
 			error = 1;
-		} else if(data->used & USED_INSTALL) {
-			/* cushion is roughly min(5% capacity, 20MiB) */
-			fsblkcnt_t fivepc = (data->fsp.f_blocks / 20) + 1;
-			fsblkcnt_t twentymb = (20 * 1024 * 1024 / data->fsp.f_bsize) + 1;
-			fsblkcnt_t cushion = fivepc < twentymb ? fivepc : twentymb;
-			blkcnt_t needed = data->max_blocks_needed + cushion;
-
-			_alpm_log(handle, ALPM_LOG_DEBUG,
-					"partition %s, needed %jd, cushion %ju, free %ju\n",
-					data->mount_dir, (intmax_t)data->max_blocks_needed,
-					(uintmax_t)cushion, (uintmax_t)data->fsp.f_bfree);
-			if(needed >= 0 && (fsblkcnt_t)needed > data->fsp.f_bfree) {
-				_alpm_log(handle, ALPM_LOG_ERROR,
-						_("Partition %s too full: %jd blocks needed, %jd blocks free\n"),
-						data->mount_dir, (intmax_t)needed, (uintmax_t)data->fsp.f_bfree);
-				error = 1;
-			}
+		} else if(data->used & USED_INSTALL && check_mountpoint(handle, data)) {
+			error = 1;
 		}
 	}
 
 finish:
-	for(i = mount_points; i; i = i->next) {
-		alpm_mountpoint_t *data = i->data;
-		FREE(data->mount_dir);
-	}
-	FREELIST(mount_points);
+	mount_point_list_free(mount_points);
 
 	if(error) {
 		RET_ERR(handle, ALPM_ERR_DISK_SPACE, -1);
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/diskspace.h pacman/lib/libalpm/diskspace.h
--- pacman-4.0.3/lib/libalpm/diskspace.h	2012-02-20 04:54:45.000000000 +0000
+++ pacman/lib/libalpm/diskspace.h	2012-10-15 18:11:52.485417724 +0000
@@ -1,7 +1,7 @@
 /*
  *  diskspace.h
  *
- *  Copyright (c) 2010-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2010-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -37,6 +37,12 @@
 	USED_INSTALL = (1 << 1),
 };
 
+enum mount_fsinfo {
+	MOUNT_FSINFO_UNLOADED = 0,
+	MOUNT_FSINFO_LOADED,
+	MOUNT_FSINFO_FAIL,
+};
+
 typedef struct __alpm_mountpoint_t {
 	/* mount point information */
 	char *mount_dir;
@@ -46,10 +52,13 @@
 	blkcnt_t max_blocks_needed;
 	enum mount_used_level used;
 	int read_only;
+	enum mount_fsinfo fsinfo_loaded;
 	FSSTATSTYPE fsp;
 } alpm_mountpoint_t;
 
 int _alpm_check_diskspace(alpm_handle_t *handle);
+int _alpm_check_downloadspace(alpm_handle_t *handle, const char *cachedir,
+		size_t num_files, off_t *file_sizes);
 
 #endif /* _ALPM_DISKSPACE_H */
 
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/dload.c pacman/lib/libalpm/dload.c
--- pacman-4.0.3/lib/libalpm/dload.c	2012-04-07 15:09:04.000000000 +0000
+++ pacman/lib/libalpm/dload.c	2012-10-15 18:11:52.489286696 +0000
@@ -18,8 +18,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <stdlib.h>
 #include <stdio.h>
 #include <errno.h>
@@ -324,7 +322,7 @@
 	}
 }
 
-static void mask_signal(int signal, void (*handler)(int),
+static void mask_signal(int signum, void (*handler)(int),
 		struct sigaction *origaction)
 {
 	struct sigaction newaction;
@@ -333,13 +331,13 @@
 	sigemptyset(&newaction.sa_mask);
 	newaction.sa_flags = 0;
 
-	sigaction(signal, NULL, origaction);
-	sigaction(signal, &newaction, NULL);
+	sigaction(signum, NULL, origaction);
+	sigaction(signum, &newaction, NULL);
 }
 
-static void unmask_signal(int signal, struct sigaction sa)
+static void unmask_signal(int signum, struct sigaction *sa)
 {
-	sigaction(signal, &sa, NULL);
+	sigaction(signum, sa, NULL);
 }
 
 static FILE *create_tempfile(struct dload_payload *payload, const char *localpath)
@@ -357,9 +355,7 @@
 			fchmod(fd, ~(_getumask()) & 0666) ||
 			!(fp = fdopen(fd, payload->tempfile_openmode))) {
 		unlink(randpath);
-		if(fd >= 0) {
-			close(fd);
-		}
+		CLOSE(fd);
 		_alpm_log(payload->handle, ALPM_LOG_ERROR,
 				_("failed to create temporary file for download\n"));
 		return NULL;
@@ -409,7 +405,8 @@
 		RET_ERR(handle, ALPM_ERR_SERVER_BAD_URL, -1);
 	}
 
-	if(strlen(payload->remote_name) > 0 && strcmp(payload->remote_name, ".sig") != 0) {
+	if(payload->remote_name && strlen(payload->remote_name) > 0 &&
+			strcmp(payload->remote_name, ".sig") != 0) {
 		payload->destfile_name = get_fullpath(localpath, payload->remote_name, "");
 		payload->tempfile_name = get_fullpath(localpath, payload->remote_name, ".part");
 		if(!payload->destfile_name || !payload->tempfile_name) {
@@ -431,6 +428,10 @@
 	if(localf == NULL) {
 		localf = fopen(payload->tempfile_name, payload->tempfile_openmode);
 		if(localf == NULL) {
+			handle->pm_errno = ALPM_ERR_RETRIEVE;
+			_alpm_log(handle, ALPM_LOG_ERROR,
+					_("could not open file %s: %s\n"),
+					payload->tempfile_name, strerror(errno));
 			goto cleanup;
 		}
 	}
@@ -582,8 +583,8 @@
 	}
 
 	/* restore the old signal handlers */
-	unmask_signal(SIGINT, orig_sig_int);
-	unmask_signal(SIGPIPE, orig_sig_pipe);
+	unmask_signal(SIGINT, &orig_sig_int);
+	unmask_signal(SIGPIPE, &orig_sig_pipe);
 	/* if we were interrupted, trip the old handler */
 	if(dload_interrupted) {
 		raise(SIGINT);
@@ -622,18 +623,18 @@
 
 static char *filecache_find_url(alpm_handle_t *handle, const char *url)
 {
-	const char *basename = strrchr(url, '/');
+	const char *filebase = strrchr(url, '/');
 
-	if(basename == NULL) {
+	if(filebase == NULL) {
 		return NULL;
 	}
 
-	basename++;
-	if(basename == '\0') {
+	filebase++;
+	if(filebase == '\0') {
 		return NULL;
 	}
 
-	return _alpm_filecache_find(handle, basename);
+	return _alpm_filecache_find(handle, filebase);
 }
 
 /** Fetch a remote pkg. */
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/dload.h pacman/lib/libalpm/dload.h
--- pacman-4.0.3/lib/libalpm/dload.h	2011-10-14 12:38:23.000000000 +0000
+++ pacman/lib/libalpm/dload.h	2012-10-15 18:11:52.489286696 +0000
@@ -1,7 +1,7 @@
 /*
  *  dload.h
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -23,8 +23,6 @@
 #include "alpm_list.h"
 #include "alpm.h"
 
-#include <time.h>
-
 struct dload_payload {
 	alpm_handle_t *handle;
 	const char *tempfile_openmode;
@@ -40,6 +38,7 @@
 	int allow_resume;
 	int errors_ok;
 	int unlink_on_fail;
+	alpm_list_t *servers;
 #ifdef HAVE_LIBCURL
 	CURLcode curlerr;       /* last error produced by curl */
 #endif
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/error.c pacman/lib/libalpm/error.c
--- pacman-4.0.3/lib/libalpm/error.c	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/error.c	2012-10-15 18:11:52.489286696 +0000
@@ -1,7 +1,7 @@
 /*
  *  error.c
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -18,8 +18,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #ifdef HAVE_LIBCURL
 #include <curl/curl.h>
 #endif
@@ -29,12 +27,12 @@
 #include "alpm.h"
 #include "handle.h"
 
-enum _alpm_errno_t SYMEXPORT alpm_errno(alpm_handle_t *handle)
+alpm_errno_t SYMEXPORT alpm_errno(alpm_handle_t *handle)
 {
 	return handle->pm_errno;
 }
 
-const char SYMEXPORT *alpm_strerror(enum _alpm_errno_t err)
+const char SYMEXPORT *alpm_strerror(alpm_errno_t err)
 {
 	switch(err) {
 		/* System */
@@ -43,7 +41,7 @@
 		case ALPM_ERR_SYSTEM:
 			return _("unexpected system error");
 		case ALPM_ERR_BADPERMS:
-			return _("insufficient privileges");
+			return _("permission denied");
 		case ALPM_ERR_NOT_A_FILE:
 			return _("could not find or read file");
 		case ALPM_ERR_NOT_A_DIR:
Only in pacman/lib/libalpm: filelist.c
Only in pacman/lib/libalpm: filelist.h
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/graph.c pacman/lib/libalpm/graph.c
--- pacman-4.0.3/lib/libalpm/graph.c	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/graph.c	2012-10-15 18:11:52.489286696 +0000
@@ -1,7 +1,7 @@
 /*
  *  graph.c - helpful graph structure and setup/teardown methods
  *
- *  Copyright (c) 2007-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2007-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -17,8 +17,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include "graph.h"
 #include "util.h"
 #include "log.h"
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/graph.h pacman/lib/libalpm/graph.h
--- pacman-4.0.3/lib/libalpm/graph.h	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/graph.h	2012-10-15 18:11:52.489286696 +0000
@@ -1,7 +1,7 @@
 /*
  *  graph.h - helpful graph structure and setup/teardown methods
  *
- *  Copyright (c) 2007-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2007-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -19,8 +19,6 @@
 #ifndef _ALPM_GRAPH_H
 #define _ALPM_GRAPH_H
 
-#include "config.h" /* ensure off_t is correct length */
-
 #include <sys/types.h> /* off_t */
 
 #include "alpm_list.h"
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/group.c pacman/lib/libalpm/group.c
--- pacman-4.0.3/lib/libalpm/group.c	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/group.c	2012-10-15 18:11:52.489286696 +0000
@@ -1,7 +1,7 @@
 /*
  *  group.c
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -18,8 +18,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <stdlib.h>
 #include <string.h>
 
@@ -32,7 +30,7 @@
 
 alpm_group_t *_alpm_group_new(const char *name)
 {
-	alpm_group_t* grp;
+	alpm_group_t *grp;
 
 	CALLOC(grp, 1, sizeof(alpm_group_t), return NULL);
 	STRDUP(grp->name, name, free(grp); return NULL);
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/group.h pacman/lib/libalpm/group.h
--- pacman-4.0.3/lib/libalpm/group.h	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/group.h	2012-10-15 18:11:52.489286696 +0000
@@ -1,7 +1,7 @@
 /*
  *  group.h
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/handle.c pacman/lib/libalpm/handle.c
--- pacman-4.0.3/lib/libalpm/handle.c	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/handle.c	2012-10-15 18:11:52.489286696 +0000
@@ -1,7 +1,7 @@
 /*
  *  handle.c
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *  Copyright (c) 2005 by Aurelien Foret <orelien@chez.com>
  *  Copyright (c) 2005, 2006 by Miklos Vajna <vmiklos@frugalware.org>
@@ -20,8 +20,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <errno.h>
 #include <stdlib.h>
 #include <string.h>
@@ -36,6 +34,7 @@
 #include "alpm_list.h"
 #include "util.h"
 #include "log.h"
+#include "delta.h"
 #include "trans.h"
 #include "alpm.h"
 
@@ -44,6 +43,7 @@
 	alpm_handle_t *handle;
 
 	CALLOC(handle, 1, sizeof(alpm_handle_t), return NULL);
+	handle->deltaratio = 0.0;
 
 	return handle;
 }
@@ -69,6 +69,8 @@
 	curl_easy_cleanup(handle->curl);
 #endif
 
+	regfree(&handle->delta_regex);
+
 	/* free memory */
 	_alpm_trans_free(handle->trans);
 	FREE(handle->root);
@@ -251,10 +253,10 @@
 	return handle->arch;
 }
 
-int SYMEXPORT alpm_option_get_usedelta(alpm_handle_t *handle)
+double SYMEXPORT alpm_option_get_deltaratio(alpm_handle_t *handle)
 {
 	CHECK_HANDLE(handle, return -1);
-	return handle->usedelta;
+	return handle->deltaratio;
 }
 
 int SYMEXPORT alpm_option_get_checkspace(alpm_handle_t *handle)
@@ -263,18 +265,6 @@
 	return handle->checkspace;
 }
 
-alpm_db_t SYMEXPORT *alpm_option_get_localdb(alpm_handle_t *handle)
-{
-	CHECK_HANDLE(handle, return NULL);
-	return handle->db_local;
-}
-
-alpm_list_t SYMEXPORT *alpm_option_get_syncdbs(alpm_handle_t *handle)
-{
-	CHECK_HANDLE(handle, return NULL);
-	return handle->dbs_sync;
-}
-
 int SYMEXPORT alpm_option_set_logcb(alpm_handle_t *handle, alpm_cb_log cb)
 {
 	CHECK_HANDLE(handle, return -1);
@@ -339,11 +329,11 @@
 	return new_path;
 }
 
-enum _alpm_errno_t _alpm_set_directory_option(const char *value,
+alpm_errno_t _alpm_set_directory_option(const char *value,
 		char **storage, int must_exist)
  {
 	struct stat st;
-	char *real = NULL;
+	char real[PATH_MAX];
 	const char *path;
 
 	path = value;
@@ -354,9 +344,7 @@
 		if(stat(path, &st) == -1 || !S_ISDIR(st.st_mode)) {
 			return ALPM_ERR_NOT_A_DIR;
 		}
-		CALLOC(real, PATH_MAX, sizeof(char), return ALPM_ERR_MEMORY);
 		if(!realpath(path, real)) {
-			free(real);
 			return ALPM_ERR_NOT_A_DIR;
 		}
 		path = real;
@@ -369,7 +357,6 @@
 	if(!*storage) {
 		return ALPM_ERR_MEMORY;
 	}
-	free(real);
 	return 0;
 }
 
@@ -596,10 +583,13 @@
 	return 0;
 }
 
-int SYMEXPORT alpm_option_set_usedelta(alpm_handle_t *handle, int usedelta)
+int SYMEXPORT alpm_option_set_deltaratio(alpm_handle_t *handle, double ratio)
 {
 	CHECK_HANDLE(handle, return -1);
-	handle->usedelta = usedelta;
+	if(ratio < 0.0 || ratio > 2.0) {
+		RET_ERR(handle, ALPM_ERR_WRONG_ARGS, -1);
+	}
+	handle->deltaratio = ratio;
 	return 0;
 }
 
@@ -630,4 +620,16 @@
 	return handle->siglevel;
 }
 
+alpm_db_t SYMEXPORT *alpm_get_localdb(alpm_handle_t *handle)
+{
+	CHECK_HANDLE(handle, return NULL);
+	return handle->db_local;
+}
+
+alpm_list_t SYMEXPORT *alpm_get_syncdbs(alpm_handle_t *handle)
+{
+	CHECK_HANDLE(handle, return NULL);
+	return handle->dbs_sync;
+}
+
 /* vim: set ts=2 sw=2 noet: */
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/handle.h pacman/lib/libalpm/handle.h
--- pacman-4.0.3/lib/libalpm/handle.h	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/handle.h	2012-10-15 18:11:52.489286696 +0000
@@ -1,7 +1,7 @@
 /*
  *  handle.h
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -22,6 +22,7 @@
 
 #include <stdio.h>
 #include <sys/types.h>
+#include <regex.h>
 
 #include "alpm_list.h"
 #include "alpm.h"
@@ -86,14 +87,18 @@
 	alpm_list_t *ignoregroup; /* List of groups to ignore */
 
 	/* options */
-	int usesyslog;           /* Use syslog instead of logfile? */ /* TODO move to frontend */
 	char *arch;              /* Architecture of packages we should allow */
-	int usedelta;            /* Download deltas if possible */
+	double deltaratio;       /* Download deltas if possible; a ratio value */
+	int usesyslog;           /* Use syslog instead of logfile? */ /* TODO move to frontend */
 	int checkspace;          /* Check disk space before installing */
 	alpm_siglevel_t siglevel;   /* Default signature verification level */
 
 	/* error code */
-	enum _alpm_errno_t pm_errno;
+	alpm_errno_t pm_errno;
+
+	/* for delta parsing efficiency */
+	int delta_regex_compiled;
+	regex_t delta_regex;
 };
 
 alpm_handle_t *_alpm_handle_new(void);
@@ -102,7 +107,7 @@
 int _alpm_handle_lock(alpm_handle_t *handle);
 int _alpm_handle_unlock(alpm_handle_t *handle);
 
-enum _alpm_errno_t _alpm_set_directory_option(const char *value,
+alpm_errno_t _alpm_set_directory_option(const char *value,
 		char **storage, int must_exist);
 
 #endif /* _ALPM_HANDLE_H */
Only in pacman/lib/libalpm: libalpm.pc.in
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/log.c pacman/lib/libalpm/log.c
--- pacman-4.0.3/lib/libalpm/log.c	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/log.c	2012-10-15 18:11:52.489286696 +0000
@@ -1,7 +1,7 @@
 /*
  *  log.c
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -18,8 +18,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <stdio.h>
 #include <stdarg.h>
 #include <errno.h>
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/log.h pacman/lib/libalpm/log.h
--- pacman-4.0.3/lib/libalpm/log.h	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/log.h	2012-10-15 18:11:52.489286696 +0000
@@ -1,7 +1,7 @@
 /*
  *  log.h
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/md5.c pacman/lib/libalpm/md5.c
--- pacman-4.0.3/lib/libalpm/md5.c	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/md5.c	2012-10-15 18:11:52.489286696 +0000
@@ -33,33 +33,34 @@
  *  GPL. This is from version 1.0.0 of the library, and has been modified
  *  as following, which may be helpful for future updates:
  *  * remove "polarssl/config.h" include
- *  * change include from "polarssl/sha2.h" to "sha2.h"
+ *  * change include from "polarssl/md5.h" to "md5.h"
  *  * removal of HMAC code
  *  * removal of SELF_TEST code
- *  * removal of ipad and opad from the md5_context struct in sha2.h
+ *  * removal of ipad and opad from the md5_context struct in md5.h
  *  * increase the size of buffer for performance reasons
- *  * various static changes
+ *  * change 'unsigned long' to uint32_t
  */
 
 #include <stdio.h>
+#include <stdint.h>
 
 #include "md5.h"
 
 /*
  * 32-bit integer manipulation macros (little endian)
  */
-#ifndef GET_ULONG_LE
-#define GET_ULONG_LE(n,b,i)                             \
+#ifndef GET_U32_LE
+#define GET_U32_LE(n,b,i)                               \
 {                                                       \
-    (n) = ( (unsigned long) (b)[(i)    ]       )        \
-        | ( (unsigned long) (b)[(i) + 1] <<  8 )        \
-        | ( (unsigned long) (b)[(i) + 2] << 16 )        \
-        | ( (unsigned long) (b)[(i) + 3] << 24 );       \
+    (n) = ( (uint32_t) (b)[(i)    ]       )             \
+        | ( (uint32_t) (b)[(i) + 1] <<  8 )             \
+        | ( (uint32_t) (b)[(i) + 2] << 16 )             \
+        | ( (uint32_t) (b)[(i) + 3] << 24 );            \
 }
 #endif
 
-#ifndef PUT_ULONG_LE
-#define PUT_ULONG_LE(n,b,i)                             \
+#ifndef PUT_U32_LE
+#define PUT_U32_LE(n,b,i)                               \
 {                                                       \
     (b)[(i)    ] = (unsigned char) ( (n)       );       \
     (b)[(i) + 1] = (unsigned char) ( (n) >>  8 );       \
@@ -84,24 +85,24 @@
 
 static void md5_process( md5_context *ctx, const unsigned char data[64] )
 {
-    unsigned long X[16], A, B, C, D;
+    uint32_t X[16], A, B, C, D;
 
-    GET_ULONG_LE( X[ 0], data,  0 );
-    GET_ULONG_LE( X[ 1], data,  4 );
-    GET_ULONG_LE( X[ 2], data,  8 );
-    GET_ULONG_LE( X[ 3], data, 12 );
-    GET_ULONG_LE( X[ 4], data, 16 );
-    GET_ULONG_LE( X[ 5], data, 20 );
-    GET_ULONG_LE( X[ 6], data, 24 );
-    GET_ULONG_LE( X[ 7], data, 28 );
-    GET_ULONG_LE( X[ 8], data, 32 );
-    GET_ULONG_LE( X[ 9], data, 36 );
-    GET_ULONG_LE( X[10], data, 40 );
-    GET_ULONG_LE( X[11], data, 44 );
-    GET_ULONG_LE( X[12], data, 48 );
-    GET_ULONG_LE( X[13], data, 52 );
-    GET_ULONG_LE( X[14], data, 56 );
-    GET_ULONG_LE( X[15], data, 60 );
+    GET_U32_LE( X[ 0], data,  0 );
+    GET_U32_LE( X[ 1], data,  4 );
+    GET_U32_LE( X[ 2], data,  8 );
+    GET_U32_LE( X[ 3], data, 12 );
+    GET_U32_LE( X[ 4], data, 16 );
+    GET_U32_LE( X[ 5], data, 20 );
+    GET_U32_LE( X[ 6], data, 24 );
+    GET_U32_LE( X[ 7], data, 28 );
+    GET_U32_LE( X[ 8], data, 32 );
+    GET_U32_LE( X[ 9], data, 36 );
+    GET_U32_LE( X[10], data, 40 );
+    GET_U32_LE( X[11], data, 44 );
+    GET_U32_LE( X[12], data, 48 );
+    GET_U32_LE( X[13], data, 52 );
+    GET_U32_LE( X[14], data, 56 );
+    GET_U32_LE( X[15], data, 60 );
 
 #define S(x,n) ((x << n) | ((x & 0xFFFFFFFF) >> (32 - n)))
 
@@ -211,7 +212,7 @@
 static void md5_update( md5_context *ctx, const unsigned char *input, size_t ilen )
 {
     size_t fill;
-    unsigned long left;
+    uint32_t left;
 
     if( ilen <= 0 )
         return;
@@ -219,10 +220,10 @@
     left = ctx->total[0] & 0x3F;
     fill = 64 - left;
 
-    ctx->total[0] += (unsigned long) ilen;
+    ctx->total[0] += (uint32_t) ilen;
     ctx->total[0] &= 0xFFFFFFFF;
 
-    if( ctx->total[0] < (unsigned long) ilen )
+    if( ctx->total[0] < (uint32_t) ilen )
         ctx->total[1]++;
 
     if( left && ilen >= fill )
@@ -262,16 +263,16 @@
  */
 static void md5_finish( md5_context *ctx, unsigned char output[16] )
 {
-    unsigned long last, padn;
-    unsigned long high, low;
+    uint32_t last, padn;
+    uint32_t high, low;
     unsigned char msglen[8];
 
     high = ( ctx->total[0] >> 29 )
          | ( ctx->total[1] <<  3 );
     low  = ( ctx->total[0] <<  3 );
 
-    PUT_ULONG_LE( low,  msglen, 0 );
-    PUT_ULONG_LE( high, msglen, 4 );
+    PUT_U32_LE( low,  msglen, 0 );
+    PUT_U32_LE( high, msglen, 4 );
 
     last = ctx->total[0] & 0x3F;
     padn = ( last < 56 ) ? ( 56 - last ) : ( 120 - last );
@@ -279,10 +280,10 @@
     md5_update( ctx, (unsigned char *) md5_padding, padn );
     md5_update( ctx, msglen, 8 );
 
-    PUT_ULONG_LE( ctx->state[0], output,  0 );
-    PUT_ULONG_LE( ctx->state[1], output,  4 );
-    PUT_ULONG_LE( ctx->state[2], output,  8 );
-    PUT_ULONG_LE( ctx->state[3], output, 12 );
+    PUT_U32_LE( ctx->state[0], output,  0 );
+    PUT_U32_LE( ctx->state[1], output,  4 );
+    PUT_U32_LE( ctx->state[2], output,  8 );
+    PUT_U32_LE( ctx->state[3], output, 12 );
 }
 
 /*
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/package.c pacman/lib/libalpm/package.c
--- pacman-4.0.3/lib/libalpm/package.c	2011-11-15 14:40:23.000000000 +0000
+++ pacman/lib/libalpm/package.c	2012-10-15 18:11:52.489286696 +0000
@@ -1,7 +1,7 @@
 /*
  *  package.c
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *  Copyright (c) 2005 by Aurelien Foret <orelien@chez.com>
  *  Copyright (c) 2005, 2006 by Christian Hamar <krics@linuxforum.hu>
@@ -21,8 +21,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <stdlib.h>
 #include <string.h>
 #include <sys/types.h>
@@ -48,7 +46,7 @@
 	ASSERT(pkg != NULL, return -1);
 
 	/* Only free packages loaded in user space */
-	if(pkg->origin == PKG_FROM_FILE) {
+	if(pkg->origin == ALPM_PKG_FROM_FILE) {
 		_alpm_pkg_free(pkg);
 	}
 
@@ -64,12 +62,12 @@
 	ASSERT(pkg != NULL, return -1);
 	pkg->handle->pm_errno = 0;
 	/* We only inspect packages from sync repositories */
-	ASSERT(pkg->origin == PKG_FROM_SYNCDB,
+	ASSERT(pkg->origin == ALPM_PKG_FROM_SYNCDB,
 			RET_ERR(pkg->handle, ALPM_ERR_WRONG_ARGS, -1));
 
 	fpath = _alpm_filecache_find(pkg->handle, pkg->filename);
 
-	retval = _alpm_test_checksum(fpath, pkg->md5sum, ALPM_CSUM_MD5);
+	retval = _alpm_test_checksum(fpath, pkg->md5sum, ALPM_PKG_VALIDATION_MD5SUM);
 
 	if(retval == 0) {
 		return 0;
@@ -87,12 +85,13 @@
  * populated package structures. */
 static const char *_pkg_get_desc(alpm_pkg_t *pkg)        { return pkg->desc; }
 static const char *_pkg_get_url(alpm_pkg_t *pkg)         { return pkg->url; }
-static time_t _pkg_get_builddate(alpm_pkg_t *pkg)        { return pkg->builddate; }
-static time_t _pkg_get_installdate(alpm_pkg_t *pkg)      { return pkg->installdate; }
+static alpm_time_t _pkg_get_builddate(alpm_pkg_t *pkg)   { return pkg->builddate; }
+static alpm_time_t _pkg_get_installdate(alpm_pkg_t *pkg) { return pkg->installdate; }
 static const char *_pkg_get_packager(alpm_pkg_t *pkg)    { return pkg->packager; }
 static const char *_pkg_get_arch(alpm_pkg_t *pkg)        { return pkg->arch; }
 static off_t _pkg_get_isize(alpm_pkg_t *pkg)             { return pkg->isize; }
-static alpm_pkgreason_t _pkg_get_reason(alpm_pkg_t *pkg)    { return pkg->reason; }
+static alpm_pkgreason_t _pkg_get_reason(alpm_pkg_t *pkg) { return pkg->reason; }
+static alpm_pkgvalidation_t _pkg_get_validation(alpm_pkg_t *pkg) { return pkg->validation; }
 static int _pkg_has_scriptlet(alpm_pkg_t *pkg)           { return pkg->scriptlet; }
 
 static alpm_list_t *_pkg_get_licenses(alpm_pkg_t *pkg)   { return pkg->licenses; }
@@ -136,6 +135,7 @@
 	.get_arch        = _pkg_get_arch,
 	.get_isize       = _pkg_get_isize,
 	.get_reason      = _pkg_get_reason,
+	.get_validation  = _pkg_get_validation,
 	.has_scriptlet   = _pkg_has_scriptlet,
 
 	.get_licenses    = _pkg_get_licenses,
@@ -200,14 +200,14 @@
 	return pkg->ops->get_url(pkg);
 }
 
-time_t SYMEXPORT alpm_pkg_get_builddate(alpm_pkg_t *pkg)
+alpm_time_t SYMEXPORT alpm_pkg_get_builddate(alpm_pkg_t *pkg)
 {
 	ASSERT(pkg != NULL, return -1);
 	pkg->handle->pm_errno = 0;
 	return pkg->ops->get_builddate(pkg);
 }
 
-time_t SYMEXPORT alpm_pkg_get_installdate(alpm_pkg_t *pkg)
+alpm_time_t SYMEXPORT alpm_pkg_get_installdate(alpm_pkg_t *pkg)
 {
 	ASSERT(pkg != NULL, return -1);
 	pkg->handle->pm_errno = 0;
@@ -270,6 +270,13 @@
 	return pkg->ops->get_reason(pkg);
 }
 
+alpm_pkgvalidation_t SYMEXPORT alpm_pkg_get_validation(alpm_pkg_t *pkg)
+{
+	ASSERT(pkg != NULL, return -1);
+	pkg->handle->pm_errno = 0;
+	return pkg->ops->get_validation(pkg);
+}
+
 alpm_list_t SYMEXPORT *alpm_pkg_get_licenses(alpm_pkg_t *pkg)
 {
 	ASSERT(pkg != NULL, return NULL);
@@ -344,7 +351,7 @@
 {
 	/* Sanity checks */
 	ASSERT(pkg != NULL, return NULL);
-	ASSERT(pkg->origin != PKG_FROM_FILE, return NULL);
+	ASSERT(pkg->origin != ALPM_PKG_FROM_FILE, return NULL);
 	pkg->handle->pm_errno = 0;
 
 	return pkg->origin_data.db;
@@ -411,7 +418,7 @@
 	ASSERT(pkg != NULL, return NULL);
 	pkg->handle->pm_errno = 0;
 
-	if(pkg->origin == PKG_FROM_FILE) {
+	if(pkg->origin == ALPM_PKG_FROM_FILE) {
 		/* The sane option; search locally for things that require this. */
 		find_requiredby(pkg, pkg->handle->db_local, &reqs);
 	} else {
@@ -443,24 +450,24 @@
 	return dest;
 }
 
-/* Helper function for comparing files list entries
- */
-int _alpm_files_cmp(const void *f1, const void *f2)
-{
-	const alpm_file_t *file1 = f1;
-	const alpm_file_t *file2 = f2;
-	return strcmp(file1->name, file2->name);
-}
-
 alpm_pkg_t *_alpm_pkg_new(void)
 {
-	alpm_pkg_t* pkg;
+	alpm_pkg_t *pkg;
 
 	CALLOC(pkg, 1, sizeof(alpm_pkg_t), return NULL);
 
 	return pkg;
 }
 
+static alpm_list_t *list_depdup(alpm_list_t *old)
+{
+	alpm_list_t *i, *new = NULL;
+	for(i = old; i; i = i->next) {
+		new = alpm_list_add(new, _alpm_dep_dup(i->data));
+	}
+	return new;
+}
+
 /**
  * Duplicate a package data struct.
  * @param pkg the package to duplicate
@@ -509,10 +516,19 @@
 	newpkg->reason = pkg->reason;
 
 	newpkg->licenses   = alpm_list_strdup(pkg->licenses);
-	for(i = pkg->replaces; i; i = i->next) {
-		newpkg->replaces = alpm_list_add(newpkg->replaces, _alpm_dep_dup(i->data));
-	}
+	newpkg->replaces   = list_depdup(pkg->replaces);
 	newpkg->groups     = alpm_list_strdup(pkg->groups);
+	for(i = pkg->backup; i; i = i->next) {
+		newpkg->backup = alpm_list_add(newpkg->backup, _alpm_backup_dup(i->data));
+	}
+	newpkg->depends    = list_depdup(pkg->depends);
+	newpkg->optdepends = list_depdup(pkg->optdepends);
+	newpkg->conflicts  = list_depdup(pkg->conflicts);
+	newpkg->provides   = list_depdup(pkg->provides);
+	for(i = pkg->deltas; i; i = i->next) {
+		newpkg->deltas = alpm_list_add(newpkg->deltas, _alpm_delta_dup(i->data));
+	}
+
 	if(pkg->files.count) {
 		size_t filenum;
 		size_t len = sizeof(alpm_file_t) * pkg->files.count;
@@ -525,27 +541,11 @@
 		}
 		newpkg->files.count = pkg->files.count;
 	}
-	for(i = pkg->backup; i; i = i->next) {
-		newpkg->backup = alpm_list_add(newpkg->backup, _alpm_backup_dup(i->data));
-	}
-	for(i = pkg->depends; i; i = i->next) {
-		newpkg->depends = alpm_list_add(newpkg->depends, _alpm_dep_dup(i->data));
-	}
-	newpkg->optdepends = alpm_list_strdup(pkg->optdepends);
-	for(i = pkg->conflicts; i; i = i->next) {
-		newpkg->conflicts = alpm_list_add(newpkg->conflicts, _alpm_dep_dup(i->data));
-	}
-	for(i = pkg->provides; i; i = i->next) {
-		newpkg->provides = alpm_list_add(newpkg->provides, _alpm_dep_dup(i->data));
-	}
-	for(i = pkg->deltas; i; i = i->next) {
-		newpkg->deltas = alpm_list_add(newpkg->deltas, _alpm_delta_dup(i->data));
-	}
 
 	/* internal */
 	newpkg->infolevel = pkg->infolevel;
 	newpkg->origin = pkg->origin;
-	if(newpkg->origin == PKG_FROM_FILE) {
+	if(newpkg->origin == ALPM_PKG_FROM_FILE) {
 		newpkg->origin_data.file = strdup(pkg->origin_data.file);
 	} else {
 		newpkg->origin_data.db = pkg->origin_data.db;
@@ -561,6 +561,12 @@
 	RET_ERR(pkg->handle, ALPM_ERR_MEMORY, -1);
 }
 
+static void free_deplist(alpm_list_t *deps)
+{
+	alpm_list_free_inner(deps, (alpm_list_fn_free)_alpm_dep_free);
+	alpm_list_free(deps);
+}
+
 void _alpm_pkg_free(alpm_pkg_t *pkg)
 {
 	if(pkg == NULL) {
@@ -579,8 +585,7 @@
 	FREE(pkg->arch);
 
 	FREELIST(pkg->licenses);
-	alpm_list_free_inner(pkg->replaces, (alpm_list_fn_free)_alpm_dep_free);
-	alpm_list_free(pkg->replaces);
+	free_deplist(pkg->replaces);
 	FREELIST(pkg->groups);
 	if(pkg->files.count) {
 		size_t i;
@@ -591,27 +596,24 @@
 	}
 	alpm_list_free_inner(pkg->backup, (alpm_list_fn_free)_alpm_backup_free);
 	alpm_list_free(pkg->backup);
-	alpm_list_free_inner(pkg->depends, (alpm_list_fn_free)_alpm_dep_free);
-	alpm_list_free(pkg->depends);
-	FREELIST(pkg->optdepends);
-	alpm_list_free_inner(pkg->conflicts, (alpm_list_fn_free)_alpm_dep_free);
-	alpm_list_free(pkg->conflicts);
-	alpm_list_free_inner(pkg->provides, (alpm_list_fn_free)_alpm_dep_free);
-	alpm_list_free(pkg->provides);
+	free_deplist(pkg->depends);
+	free_deplist(pkg->optdepends);
+	free_deplist(pkg->conflicts);
+	free_deplist(pkg->provides);
 	alpm_list_free_inner(pkg->deltas, (alpm_list_fn_free)_alpm_delta_free);
 	alpm_list_free(pkg->deltas);
 	alpm_list_free(pkg->delta_path);
 	alpm_list_free(pkg->removes);
 
-	if(pkg->origin == PKG_FROM_FILE) {
+	if(pkg->origin == ALPM_PKG_FROM_FILE) {
 		FREE(pkg->origin_data.file);
 	}
 	FREE(pkg);
 }
 
 /* This function should be used when removing a target from upgrade/sync target list
- * Case 1: If pkg is a loaded package file (PKG_FROM_FILE), it will be freed.
- * Case 2: If pkg is a pkgcache entry (PKG_FROM_CACHE), it won't be freed,
+ * Case 1: If pkg is a loaded package file (ALPM_PKG_FROM_FILE), it will be freed.
+ * Case 2: If pkg is a pkgcache entry (ALPM_PKG_FROM_CACHE), it won't be freed,
  *         only the transaction specific fields of pkg will be freed.
  */
 void _alpm_pkg_free_trans(alpm_pkg_t *pkg)
@@ -620,7 +622,7 @@
 		return;
 	}
 
-	if(pkg->origin == PKG_FROM_FILE) {
+	if(pkg->origin == ALPM_PKG_FROM_FILE) {
 		_alpm_pkg_free(pkg);
 		return;
 	}
@@ -690,14 +692,14 @@
 	alpm_list_t *groups = NULL;
 
 	/* first see if the package is ignored */
-	if(alpm_list_find_str(handle->ignorepkg, pkg->name)) {
+	if(alpm_list_find(handle->ignorepkg, pkg->name, _alpm_fnmatch)) {
 		return 1;
 	}
 
 	/* next see if the package is in a group that is ignored */
-	for(groups = handle->ignoregroup; groups; groups = groups->next) {
+	for(groups = alpm_pkg_get_groups(pkg); groups; groups = groups->next) {
 		char *grp = groups->data;
-		if(alpm_list_find_str(alpm_pkg_get_groups(pkg), grp)) {
+		if(alpm_list_find(handle->ignoregroup, grp, _alpm_fnmatch)) {
 			return 1;
 		}
 	}
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/package.h pacman/lib/libalpm/package.h
--- pacman-4.0.3/lib/libalpm/package.h	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/package.h	2012-10-15 18:11:52.489286696 +0000
@@ -1,7 +1,7 @@
 /*
  *  package.h
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *  Copyright (c) 2005 by Aurelien Foret <orelien@chez.com>
  *  Copyright (c) 2006 by David Kimpe <dnaku@frugalware.org>
@@ -24,10 +24,7 @@
 #ifndef _ALPM_PACKAGE_H
 #define _ALPM_PACKAGE_H
 
-#include "config.h" /* ensure off_t is correct length */
-
 #include <sys/types.h> /* off_t */
-#include <time.h> /* time_t */
 
 #include "alpm.h"
 #include "backup.h"
@@ -44,12 +41,13 @@
 struct pkg_operations {
 	const char *(*get_desc) (alpm_pkg_t *);
 	const char *(*get_url) (alpm_pkg_t *);
-	time_t (*get_builddate) (alpm_pkg_t *);
-	time_t (*get_installdate) (alpm_pkg_t *);
+	alpm_time_t (*get_builddate) (alpm_pkg_t *);
+	alpm_time_t (*get_installdate) (alpm_pkg_t *);
 	const char *(*get_packager) (alpm_pkg_t *);
 	const char *(*get_arch) (alpm_pkg_t *);
 	off_t (*get_isize) (alpm_pkg_t *);
 	alpm_pkgreason_t (*get_reason) (alpm_pkg_t *);
+	alpm_pkgvalidation_t (*get_validation) (alpm_pkg_t *);
 	int (*has_scriptlet) (alpm_pkg_t *);
 
 	alpm_list_t *(*get_licenses) (alpm_pkg_t *);
@@ -89,8 +87,8 @@
 	char *base64_sig;
 	char *arch;
 
-	time_t builddate;
-	time_t installdate;
+	alpm_time_t builddate;
+	alpm_time_t installdate;
 
 	off_t size;
 	off_t isize;
@@ -99,6 +97,7 @@
 	int scriptlet;
 
 	alpm_pkgreason_t reason;
+	alpm_pkgvalidation_t validation;
 	alpm_dbinfrq_t infolevel;
 	alpm_pkgfrom_t origin;
 	/* origin == PKG_FROM_FILE, use pkg->origin_data.file
@@ -127,16 +126,15 @@
 };
 
 alpm_file_t *_alpm_file_copy(alpm_file_t *dest, const alpm_file_t *src);
-int _alpm_files_cmp(const void *f1, const void *f2);
 
-alpm_pkg_t* _alpm_pkg_new(void);
+alpm_pkg_t *_alpm_pkg_new(void);
 int _alpm_pkg_dup(alpm_pkg_t *pkg, alpm_pkg_t **new_ptr);
 void _alpm_pkg_free(alpm_pkg_t *pkg);
 void _alpm_pkg_free_trans(alpm_pkg_t *pkg);
 
 int _alpm_pkg_validate_internal(alpm_handle_t *handle,
 		const char *pkgfile, alpm_pkg_t *syncpkg, alpm_siglevel_t level,
-		alpm_siglist_t **sigdata);
+		alpm_siglist_t **sigdata, alpm_pkgvalidation_t *validation);
 alpm_pkg_t *_alpm_pkg_load_internal(alpm_handle_t *handle,
 		const char *pkgfile, int full);
 
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/pkghash.c pacman/lib/libalpm/pkghash.c
--- pacman-4.0.3/lib/libalpm/pkghash.c	2012-01-31 17:24:55.000000000 +0000
+++ pacman/lib/libalpm/pkghash.c	2012-10-15 18:11:52.489286696 +0000
@@ -1,7 +1,7 @@
 /*
  *  pkghash.c
  *
- *  Copyright (c) 2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2011-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -26,42 +26,51 @@
  *
  * The maximum table size is the last prime under 1,000,000.  That is
  * more than an order of magnitude greater than the number of packages
- * in any Linux distribution.
+ * in any Linux distribution, and well under UINT_MAX.
  */
-static const size_t prime_list[] =
+static const unsigned int prime_list[] =
 {
-	11ul, 13ul, 17ul, 19ul, 23ul, 29ul, 31ul, 37ul, 41ul, 43ul, 47ul,
-	53ul, 59ul, 61ul, 67ul, 71ul, 73ul, 79ul, 83ul, 89ul, 97ul, 103ul,
-	109ul, 113ul, 127ul, 137ul, 139ul, 149ul, 157ul, 167ul, 179ul, 193ul,
-	199ul, 211ul, 227ul, 241ul, 257ul, 277ul, 293ul, 313ul, 337ul, 359ul,
-	383ul, 409ul, 439ul, 467ul, 503ul, 541ul, 577ul, 619ul, 661ul, 709ul,
-	761ul, 823ul, 887ul, 953ul, 1031ul, 1109ul, 1193ul, 1289ul, 1381ul,
-	1493ul, 1613ul, 1741ul, 1879ul, 2029ul, 2179ul, 2357ul, 2549ul,
-	2753ul, 2971ul, 3209ul, 3469ul, 3739ul, 4027ul, 4349ul, 4703ul,
-	5087ul, 5503ul, 5953ul, 6427ul, 6949ul, 7517ul, 8123ul, 8783ul,
-	9497ul, 10273ul, 11113ul, 12011ul, 12983ul, 14033ul, 15173ul,
-	16411ul, 17749ul, 19183ul, 20753ul, 22447ul, 24281ul, 26267ul,
-	28411ul, 30727ul, 33223ul, 35933ul, 38873ul, 42043ul, 45481ul,
-	49201ul, 53201ul, 57557ul, 62233ul, 67307ul, 72817ul, 78779ul,
-	85229ul, 92203ul, 99733ul, 107897ul, 116731ul, 126271ul, 136607ul,
-	147793ul, 159871ul, 172933ul, 187091ul, 202409ul, 218971ul, 236897ul,
-	256279ul, 277261ul, 299951ul, 324503ul, 351061ul, 379787ul, 410857ul,
-	444487ul, 480881ul, 520241ul, 562841ul, 608903ul, 658753ul, 712697ul,
-	771049ul, 834181ul, 902483ul, 976369ul
+	11u, 13u, 17u, 19u, 23u, 29u, 31u, 37u, 41u, 43u, 47u,
+	53u, 59u, 61u, 67u, 71u, 73u, 79u, 83u, 89u, 97u, 103u,
+	109u, 113u, 127u, 137u, 139u, 149u, 157u, 167u, 179u, 193u,
+	199u, 211u, 227u, 241u, 257u, 277u, 293u, 313u, 337u, 359u,
+	383u, 409u, 439u, 467u, 503u, 541u, 577u, 619u, 661u, 709u,
+	761u, 823u, 887u, 953u, 1031u, 1109u, 1193u, 1289u, 1381u,
+	1493u, 1613u, 1741u, 1879u, 2029u, 2179u, 2357u, 2549u,
+	2753u, 2971u, 3209u, 3469u, 3739u, 4027u, 4349u, 4703u,
+	5087u, 5503u, 5953u, 6427u, 6949u, 7517u, 8123u, 8783u,
+	9497u, 10273u, 11113u, 12011u, 12983u, 14033u, 15173u,
+	16411u, 17749u, 19183u, 20753u, 22447u, 24281u, 26267u,
+	28411u, 30727u, 33223u, 35933u, 38873u, 42043u, 45481u,
+	49201u, 53201u, 57557u, 62233u, 67307u, 72817u, 78779u,
+	85229u, 92203u, 99733u, 107897u, 116731u, 126271u, 136607u,
+	147793u, 159871u, 172933u, 187091u, 202409u, 218971u, 236897u,
+	256279u, 277261u, 299951u, 324503u, 351061u, 379787u, 410857u,
+	444487u, 480881u, 520241u, 562841u, 608903u, 658753u, 712697u,
+	771049u, 834181u, 902483u, 976369u
 };
 
-/* Allocate a hash table with at least "size" buckets */
-alpm_pkghash_t *_alpm_pkghash_create(size_t size)
+/* How far forward do we look when linear probing for a spot? */
+static const unsigned int stride = 1;
+/* What is the maximum load percentage of our hash table? */
+static const double max_hash_load = 0.68;
+/* Initial load percentage given a certain size */
+static const double initial_hash_load = 0.58;
+
+/* Allocate a hash table with space for at least "size" elements */
+alpm_pkghash_t *_alpm_pkghash_create(unsigned int size)
 {
 	alpm_pkghash_t *hash = NULL;
-	size_t i, loopsize;
+	unsigned int i, loopsize;
 
 	CALLOC(hash, 1, sizeof(alpm_pkghash_t), return NULL);
+	size = size / initial_hash_load + 1;
 
 	loopsize = sizeof(prime_list) / sizeof(*prime_list);
 	for(i = 0; i < loopsize; i++) {
 		if(prime_list[i] > size) {
 			hash->buckets = prime_list[i];
+			hash->limit = hash->buckets * max_hash_load;
 			break;
 		}
 	}
@@ -78,15 +87,19 @@
 	return hash;
 }
 
-static size_t get_hash_position(unsigned long name_hash, alpm_pkghash_t *hash)
+static unsigned int get_hash_position(unsigned long name_hash,
+		alpm_pkghash_t *hash)
 {
-	size_t position;
+	unsigned int position;
 
 	position = name_hash % hash->buckets;
 
 	/* collision resolution using open addressing with linear probing */
 	while(hash->hash_table[position] != NULL) {
-		position = (position + 1) % hash->buckets;
+		position += stride;
+		while(position >= hash->buckets) {
+			position -= hash->buckets;
+		}
 	}
 
 	return position;
@@ -96,7 +109,7 @@
 static alpm_pkghash_t *rehash(alpm_pkghash_t *oldhash)
 {
 	alpm_pkghash_t *newhash;
-	size_t newsize, position, i;
+	unsigned int newsize, i;
 
 	/* Hash tables will need resized in two cases:
 	 *  - adding packages to the local database
@@ -129,8 +142,7 @@
 	for(i = 0; i < oldhash->buckets; i++) {
 		if(oldhash->hash_table[i] != NULL) {
 			alpm_pkg_t *package = oldhash->hash_table[i]->data;
-
-			position = get_hash_position(package->name_hash, newhash);
+			unsigned int position = get_hash_position(package->name_hash, newhash);
 
 			newhash->hash_table[position] = oldhash->hash_table[i];
 			oldhash->hash_table[i] = NULL;
@@ -144,16 +156,17 @@
 	return newhash;
 }
 
-static alpm_pkghash_t *pkghash_add_pkg(alpm_pkghash_t *hash, alpm_pkg_t *pkg, int sorted)
+static alpm_pkghash_t *pkghash_add_pkg(alpm_pkghash_t *hash, alpm_pkg_t *pkg,
+		int sorted)
 {
 	alpm_list_t *ptr;
-	size_t position;
+	unsigned int position;
 
 	if(pkg == NULL || hash == NULL) {
 		return hash;
 	}
 
-	if((hash->entries + 1) / MAX_HASH_LOAD > hash->buckets) {
+	if(hash->entries >= hash->limit) {
 		hash = rehash(hash);
 	}
 
@@ -189,7 +202,8 @@
 	return pkghash_add_pkg(hash, pkg, 1);
 }
 
-static size_t move_one_entry(alpm_pkghash_t *hash, size_t start, size_t end)
+static unsigned int move_one_entry(alpm_pkghash_t *hash,
+		unsigned int start, unsigned int end)
 {
 	/* Iterate backwards from 'end' to 'start', seeing if any of the items
 	 * would hash to 'start'. If we find one, we move it there and break.  If
@@ -201,7 +215,7 @@
 	while(end != start) {
 		alpm_list_t *i = hash->hash_table[end];
 		alpm_pkg_t *info = i->data;
-		size_t new_position = get_hash_position(info->name_hash, hash);
+		unsigned int new_position = get_hash_position(info->name_hash, hash);
 
 		if(new_position == start) {
 			hash->hash_table[start] = i;
@@ -212,7 +226,7 @@
 		/* the odd math ensures we are always positive, e.g.
 		 * e.g. (0 - 1) % 47      == -1
 		 * e.g. (47 + 0 - 1) % 47 == 46 */
-		end = (hash->buckets + end - 1) % hash->buckets;
+		end = (hash->buckets + end - stride) % hash->buckets;
 	}
 	return end;
 }
@@ -230,7 +244,7 @@
 		alpm_pkg_t **data)
 {
 	alpm_list_t *i;
-	size_t position;
+	unsigned int position;
 
 	if(data) {
 		*data = NULL;
@@ -246,7 +260,7 @@
 
 		if(info->name_hash == pkg->name_hash &&
 					strcmp(info->name, pkg->name) == 0) {
-			size_t stop, prev;
+			unsigned int stop, prev;
 
 			/* remove from list and hash */
 			hash->list = alpm_list_remove_item(hash->list, i);
@@ -260,11 +274,17 @@
 			/* Potentially move entries following removed entry to keep open
 			 * addressing collision resolution working. We start by finding the
 			 * next null bucket to know how far we have to look. */
-			stop = (position + 1) % hash->buckets;
+			stop = position + stride;
+			while(stop >= hash->buckets) {
+				stop -= hash->buckets;
+			}
 			while(hash->hash_table[stop] != NULL && stop != position) {
-				stop = (stop + 1) % hash->buckets;
+				stop += stride;
+				while(stop >= hash->buckets) {
+					stop -= hash->buckets;
+				}
 			}
-			stop = (hash->buckets + stop - 1) % hash->buckets;
+			stop = (hash->buckets + stop - stride) % hash->buckets;
 
 			/* We now search backwards from stop to position. If we find an
 			 * item that now hashes to position, we will move it, and then try
@@ -277,7 +297,10 @@
 			return hash;
 		}
 
-		position = (position + 1) % hash->buckets;
+		position += stride;
+		while(position >= hash->buckets) {
+			position -= hash->buckets;
+		}
 	}
 
 	return hash;
@@ -285,8 +308,8 @@
 
 void _alpm_pkghash_free(alpm_pkghash_t *hash)
 {
-	size_t i;
 	if(hash != NULL) {
+		unsigned int i;
 		for(i = 0; i < hash->buckets; i++) {
 			free(hash->hash_table[i]);
 		}
@@ -299,7 +322,7 @@
 {
 	alpm_list_t *lp;
 	unsigned long name_hash;
-	size_t position;
+	unsigned int position;
 
 	if(name == NULL || hash == NULL) {
 		return NULL;
@@ -316,7 +339,10 @@
 			return info;
 		}
 
-		position = (position + 1) % hash->buckets;
+		position += stride;
+		while(position >= hash->buckets) {
+			position -= hash->buckets;
+		}
 	}
 
 	return NULL;
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/pkghash.h pacman/lib/libalpm/pkghash.h
--- pacman-4.0.3/lib/libalpm/pkghash.h	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/pkghash.h	2012-10-15 18:11:52.489286696 +0000
@@ -1,7 +1,7 @@
 /*
  *  pkghash.h
  *
- *  Copyright (c) 2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2011-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -35,17 +35,19 @@
 struct __alpm_pkghash_t {
 	/** data held by the hash table */
 	alpm_list_t **hash_table;
-	/** number of buckets in hash table */
-	size_t buckets;
-	/** number of entries in hash table */
-	size_t entries;
 	/** head node of the hash table data in normal list format */
 	alpm_list_t *list;
+	/** number of buckets in hash table */
+	unsigned int buckets;
+	/** number of entries in hash table */
+	unsigned int entries;
+	/** max number of entries before a resize is needed */
+	unsigned int limit;
 };
 
 typedef struct __alpm_pkghash_t alpm_pkghash_t;
 
-alpm_pkghash_t *_alpm_pkghash_create(size_t size);
+alpm_pkghash_t *_alpm_pkghash_create(unsigned int size);
 
 alpm_pkghash_t *_alpm_pkghash_add(alpm_pkghash_t *hash, alpm_pkg_t *pkg);
 alpm_pkghash_t *_alpm_pkghash_add_sorted(alpm_pkghash_t *hash, alpm_pkg_t *pkg);
@@ -55,6 +57,4 @@
 
 alpm_pkg_t *_alpm_pkghash_find(alpm_pkghash_t *hash, const char *name);
 
-#define MAX_HASH_LOAD 0.7
-
 #endif /* _ALPM_PKGHASH_H */
Only in pacman-4.0.3/lib/libalpm/po: ca.gmo
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/ca.po pacman/lib/libalpm/po/ca.po
--- pacman-4.0.3/lib/libalpm/po/ca.po	2012-04-07 16:08:54.000000000 +0000
+++ pacman/lib/libalpm/po/ca.po	2012-10-15 18:11:52.489286696 +0000
@@ -10,7 +10,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2011-10-11 14:03+0000\n"
 "Last-Translator: Dan McGee <dpmcgee@gmail.com>\n"
 "Language-Team: Catalan (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/lib/libalpm/po: cs.gmo
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/cs.po pacman/lib/libalpm/po/cs.po
--- pacman-4.0.3/lib/libalpm/po/cs.po	2012-04-07 16:08:55.000000000 +0000
+++ pacman/lib/libalpm/po/cs.po	2012-10-15 18:11:52.493421932 +0000
@@ -11,7 +11,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2011-10-15 08:43+0000\n"
 "Last-Translator: Vojtěch Gondžala <vojtech.gondzala@gmail.com>\n"
 "Language-Team: Czech (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/lib/libalpm/po: da.gmo
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/da.po pacman/lib/libalpm/po/da.po
--- pacman-4.0.3/lib/libalpm/po/da.po	2012-04-07 16:08:55.000000000 +0000
+++ pacman/lib/libalpm/po/da.po	2012-10-15 18:11:52.493421932 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-04-01 12:21+0000\n"
 "Last-Translator: jakobw <jakob.wadsager@gmail.com>\n"
 "Language-Team: Danish (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/lib/libalpm/po: de.gmo
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/de.po pacman/lib/libalpm/po/de.po
--- pacman-4.0.3/lib/libalpm/po/de.po	2012-04-07 16:08:55.000000000 +0000
+++ pacman/lib/libalpm/po/de.po	2012-10-15 18:11:52.493421932 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2011-10-07 09:26+0000\n"
 "Last-Translator: Matthias Gorissen <matthias@archlinux.de>\n"
 "Language-Team: German (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/lib/libalpm/po: el.gmo
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/el.po pacman/lib/libalpm/po/el.po
--- pacman-4.0.3/lib/libalpm/po/el.po	2012-04-07 16:08:55.000000000 +0000
+++ pacman/lib/libalpm/po/el.po	2012-10-15 18:11:52.493421932 +0000
@@ -10,7 +10,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2011-10-06 10:43+0000\n"
 "Last-Translator: Christos Nouskas <nous@archlinux.us>\n"
 "Language-Team: Greek (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/lib/libalpm/po: en_GB.gmo
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/en_GB.po pacman/lib/libalpm/po/en_GB.po
--- pacman-4.0.3/lib/libalpm/po/en_GB.po	2012-04-07 16:08:55.000000000 +0000
+++ pacman/lib/libalpm/po/en_GB.po	2012-10-15 18:11:52.493421932 +0000
@@ -8,7 +8,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2011-10-06 03:57+0000\n"
 "Last-Translator: Dan McGee <dpmcgee@gmail.com>\n"
 "Language-Team: LANGUAGE <LL@li.org>\n"
Only in pacman-4.0.3/lib/libalpm/po: es.gmo
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/es.po pacman/lib/libalpm/po/es.po
--- pacman-4.0.3/lib/libalpm/po/es.po	2012-04-07 16:08:55.000000000 +0000
+++ pacman/lib/libalpm/po/es.po	2012-10-15 18:11:52.493421932 +0000
@@ -12,7 +12,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2011-10-06 16:10+0000\n"
 "Last-Translator: juantascon <juantascon@gmail.com>\n"
 "Language-Team: Spanish (Castilian) (http://www.transifex.net/projects/p/"
Only in pacman-4.0.3/lib/libalpm/po: fi.gmo
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/fi.po pacman/lib/libalpm/po/fi.po
--- pacman-4.0.3/lib/libalpm/po/fi.po	2012-04-07 16:08:55.000000000 +0000
+++ pacman/lib/libalpm/po/fi.po	2012-10-15 18:11:52.493421932 +0000
@@ -13,7 +13,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2011-10-07 18:48+0000\n"
 "Last-Translator: Dan McGee <dpmcgee@gmail.com>\n"
 "Language-Team: Finnish (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/lib/libalpm/po: fr.gmo
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/fr.po pacman/lib/libalpm/po/fr.po
--- pacman-4.0.3/lib/libalpm/po/fr.po	2012-04-07 16:08:55.000000000 +0000
+++ pacman/lib/libalpm/po/fr.po	2012-10-15 18:11:52.497298964 +0000
@@ -11,7 +11,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-02-06 20:08+0000\n"
 "Last-Translator: jiehong <ma.jiehong@gmail.com>\n"
 "Language-Team: French (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/lib/libalpm/po: hu.gmo
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/hu.po pacman/lib/libalpm/po/hu.po
--- pacman-4.0.3/lib/libalpm/po/hu.po	2012-04-07 16:08:55.000000000 +0000
+++ pacman/lib/libalpm/po/hu.po	2012-10-15 18:11:52.497298964 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2011-10-08 10:04+0000\n"
 "Last-Translator: György Balló <ballogy@freestart.hu>\n"
 "Language-Team: Hungarian (http://www.transifex.net/projects/p/archlinux-"
Only in pacman-4.0.3/lib/libalpm/po: it.gmo
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/it.po pacman/lib/libalpm/po/it.po
--- pacman-4.0.3/lib/libalpm/po/it.po	2012-04-07 16:08:55.000000000 +0000
+++ pacman/lib/libalpm/po/it.po	2012-10-15 18:11:52.497298964 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-02-16 15:25+0000\n"
 "Last-Translator: Giovanni Scafora <giovanni@archlinux.org>\n"
 "Language-Team: Italian (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/lib/libalpm/po: kk.gmo
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/kk.po pacman/lib/libalpm/po/kk.po
--- pacman-4.0.3/lib/libalpm/po/kk.po	2012-04-07 16:08:55.000000000 +0000
+++ pacman/lib/libalpm/po/kk.po	2012-10-15 18:11:52.497298964 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2011-10-06 03:39+0000\n"
 "Last-Translator: Dan McGee <dpmcgee@gmail.com>\n"
 "Language-Team: Kazakh (http://www.transifex.net/projects/p/archlinux-pacman/"
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/libalpm.pot pacman/lib/libalpm/po/libalpm.pot
--- pacman-4.0.3/lib/libalpm/po/libalpm.pot	2012-04-07 16:08:54.000000000 +0000
+++ pacman/lib/libalpm/po/libalpm.pot	2012-10-15 18:11:52.497298964 +0000
@@ -6,9 +6,9 @@
 #, fuzzy
 msgid ""
 msgstr ""
-"Project-Id-Version: pacman 4.0.3\n"
+"Project-Id-Version: pacman 4.0.2\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
 "Language-Team: LANGUAGE <LL@li.org>\n"
Only in pacman-4.0.3/lib/libalpm/po: lt.gmo
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/lt.po pacman/lib/libalpm/po/lt.po
--- pacman-4.0.3/lib/libalpm/po/lt.po	2012-04-07 16:08:55.000000000 +0000
+++ pacman/lib/libalpm/po/lt.po	2012-10-15 18:11:52.497298964 +0000
@@ -10,7 +10,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-02-05 07:37+0000\n"
 "Last-Translator: Algimantas Margevičius <margevicius.algimantas@gmail.com>\n"
 "Language-Team: Lithuanian (http://www.transifex.net/projects/p/archlinux-"
Only in pacman-4.0.3/lib/libalpm/po: nb.gmo
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/nb.po pacman/lib/libalpm/po/nb.po
--- pacman-4.0.3/lib/libalpm/po/nb.po	2012-04-07 16:08:55.000000000 +0000
+++ pacman/lib/libalpm/po/nb.po	2012-10-15 18:11:52.497298964 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2011-10-14 16:36+0000\n"
 "Last-Translator: Alexander Rødseth <rodseth@gmail.com>\n"
 "Language-Team: Norwegian Bokmål (http://www.transifex.net/projects/p/"
Only in pacman-4.0.3/lib/libalpm/po: pl.gmo
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/pl.po pacman/lib/libalpm/po/pl.po
--- pacman-4.0.3/lib/libalpm/po/pl.po	2012-04-07 16:08:55.000000000 +0000
+++ pacman/lib/libalpm/po/pl.po	2012-10-15 18:11:52.501417446 +0000
@@ -8,7 +8,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2011-10-08 09:10+0000\n"
 "Last-Translator: Bartek Piotrowski <barthalion@gmail.com>\n"
 "Language-Team: Polish (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/lib/libalpm/po: pt.gmo
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/pt.po pacman/lib/libalpm/po/pt.po
--- pacman-4.0.3/lib/libalpm/po/pt.po	2012-04-07 16:08:55.000000000 +0000
+++ pacman/lib/libalpm/po/pt.po	2012-10-15 18:11:52.501417446 +0000
@@ -8,7 +8,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2011-10-12 13:05+0000\n"
 "Last-Translator: Gaspar Santos <omeuviolino@gmail.com>\n"
 "Language-Team: Portuguese (http://www.transifex.net/projects/p/archlinux-"
Only in pacman-4.0.3/lib/libalpm/po: pt_BR.gmo
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/pt_BR.po pacman/lib/libalpm/po/pt_BR.po
--- pacman-4.0.3/lib/libalpm/po/pt_BR.po	2012-04-07 16:08:55.000000000 +0000
+++ pacman/lib/libalpm/po/pt_BR.po	2012-10-15 18:11:52.501417446 +0000
@@ -12,7 +12,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-02-27 22:06+0000\n"
 "Last-Translator: Rafael Ferreira <rafael.f.f1@gmail.com>\n"
 "Language-Team: Portuguese (Brazil) (http://www.transifex.net/projects/p/"
Only in pacman-4.0.3/lib/libalpm/po: ro.gmo
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/ro.po pacman/lib/libalpm/po/ro.po
--- pacman-4.0.3/lib/libalpm/po/ro.po	2012-04-07 16:08:55.000000000 +0000
+++ pacman/lib/libalpm/po/ro.po	2012-10-15 18:11:52.501417446 +0000
@@ -11,7 +11,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2011-10-06 17:25+0000\n"
 "Last-Translator: Mihai Coman <mihai@m1x.ro>\n"
 "Language-Team: Romanian (http://www.transifex.net/projects/p/archlinux-"
Only in pacman-4.0.3/lib/libalpm/po: ru.gmo
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/ru.po pacman/lib/libalpm/po/ru.po
--- pacman-4.0.3/lib/libalpm/po/ru.po	2012-04-07 16:08:55.000000000 +0000
+++ pacman/lib/libalpm/po/ru.po	2012-10-15 18:11:52.501417446 +0000
@@ -11,7 +11,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-01-17 16:22+0000\n"
 "Last-Translator: partizan <serg.partizan@gmail.com>\n"
 "Language-Team: Russian (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/lib/libalpm/po: sk.gmo
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/sk.po pacman/lib/libalpm/po/sk.po
--- pacman-4.0.3/lib/libalpm/po/sk.po	2012-04-07 16:08:55.000000000 +0000
+++ pacman/lib/libalpm/po/sk.po	2012-10-15 18:11:52.501417446 +0000
@@ -10,7 +10,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2011-10-08 19:38+0000\n"
 "Last-Translator: jose1711 <jose1711@gmail.com>\n"
 "Language-Team: Slovak (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/lib/libalpm/po: sr.gmo
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/sr.po pacman/lib/libalpm/po/sr.po
--- pacman-4.0.3/lib/libalpm/po/sr.po	2012-04-07 16:08:55.000000000 +0000
+++ pacman/lib/libalpm/po/sr.po	2012-10-15 18:11:52.501417446 +0000
@@ -8,7 +8,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2011-10-11 17:15+0000\n"
 "Last-Translator: Slobodan Terzić <githzerai06@gmail.com>\n"
 "Language-Team: Serbian (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/lib/libalpm/po: sr@latin.gmo
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/sr@latin.po pacman/lib/libalpm/po/sr@latin.po
--- pacman-4.0.3/lib/libalpm/po/sr@latin.po	2012-04-07 16:08:55.000000000 +0000
+++ pacman/lib/libalpm/po/sr@latin.po	2012-10-15 18:11:52.501417446 +0000
@@ -8,7 +8,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2011-10-12 15:08+0000\n"
 "Last-Translator: Slobodan Terzić <githzerai06@gmail.com>\n"
 "Language-Team: Serbian (Latin) (http://www.transifex.net/projects/p/"
Only in pacman-4.0.3/lib/libalpm/po: stamp-po
Only in pacman-4.0.3/lib/libalpm/po: sv.gmo
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/sv.po pacman/lib/libalpm/po/sv.po
--- pacman-4.0.3/lib/libalpm/po/sv.po	2012-04-07 16:08:55.000000000 +0000
+++ pacman/lib/libalpm/po/sv.po	2012-10-15 18:11:52.501417446 +0000
@@ -8,7 +8,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2011-11-15 15:42+0000\n"
 "Last-Translator: Fredrik Halldal <f.halldal@gmail.com>\n"
 "Language-Team: Swedish (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/lib/libalpm/po: tr.gmo
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/tr.po pacman/lib/libalpm/po/tr.po
--- pacman-4.0.3/lib/libalpm/po/tr.po	2012-04-07 16:08:55.000000000 +0000
+++ pacman/lib/libalpm/po/tr.po	2012-10-15 18:11:52.501417446 +0000
@@ -10,7 +10,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2011-10-23 09:34+0000\n"
 "Last-Translator: Atilla Öntaş <tarakbumba@gmail.com>\n"
 "Language-Team: Turkish (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/lib/libalpm/po: uk.gmo
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/uk.po pacman/lib/libalpm/po/uk.po
--- pacman-4.0.3/lib/libalpm/po/uk.po	2012-04-07 16:08:55.000000000 +0000
+++ pacman/lib/libalpm/po/uk.po	2012-10-15 18:11:52.501417446 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2011-10-10 20:43+0000\n"
 "Last-Translator: Данило Коростіль <ted.korostiled@gmail.com>\n"
 "Language-Team: Ukrainian (http://www.transifex.net/projects/p/archlinux-"
Only in pacman-4.0.3/lib/libalpm/po: zh_CN.gmo
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/zh_CN.po pacman/lib/libalpm/po/zh_CN.po
--- pacman-4.0.3/lib/libalpm/po/zh_CN.po	2012-04-07 16:08:55.000000000 +0000
+++ pacman/lib/libalpm/po/zh_CN.po	2012-10-15 18:11:52.505292182 +0000
@@ -10,7 +10,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2011-11-15 02:39+0000\n"
 "Last-Translator: 甘 露 <rhythm.gan@gmail.com>\n"
 "Language-Team: Chinese (China) (http://www.transifex.net/projects/p/"
Only in pacman-4.0.3/lib/libalpm/po: zh_TW.gmo
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/po/zh_TW.po pacman/lib/libalpm/po/zh_TW.po
--- pacman-4.0.3/lib/libalpm/po/zh_TW.po	2012-04-07 16:08:55.000000000 +0000
+++ pacman/lib/libalpm/po/zh_TW.po	2012-10-15 18:11:52.505292182 +0000
@@ -8,7 +8,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2011-10-06 03:39+0000\n"
 "Last-Translator: Dan McGee <dpmcgee@gmail.com>\n"
 "Language-Team: Chinese (Taiwan) (http://www.transifex.net/projects/p/"
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/remove.c pacman/lib/libalpm/remove.c
--- pacman-4.0.3/lib/libalpm/remove.c	2012-01-19 04:23:54.000000000 +0000
+++ pacman/lib/libalpm/remove.c	2012-10-15 18:11:52.505292182 +0000
@@ -22,8 +22,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <stdlib.h>
 #include <errno.h>
 #include <string.h>
@@ -43,8 +41,16 @@
 #include "db.h"
 #include "deps.h"
 #include "handle.h"
-#include "conflict.h"
+#include "filelist.h"
 
+/**
+ * @brief Add a package removal action to the transaction.
+ *
+ * @param handle the context handle
+ * @param pkg the package to uninstall
+ *
+ * @return 0 on success, -1 on error
+ */
 int SYMEXPORT alpm_remove_pkg(alpm_handle_t *handle, alpm_pkg_t *pkg)
 {
 	const char *pkgname;
@@ -75,6 +81,14 @@
 	return 0;
 }
 
+/**
+ * @brief Add dependencies to the removal transaction for cascading.
+ *
+ * @param handle the context handle
+ * @param lp list of missing dependencies caused by the removal transaction
+ *
+ * @return 0 on success, -1 on error
+ */
 static int remove_prepare_cascade(alpm_handle_t *handle, alpm_list_t *lp)
 {
 	alpm_trans_t *trans = handle->trans;
@@ -107,6 +121,12 @@
 	return 0;
 }
 
+/**
+ * @brief Remove needed packages from the removal transaction.
+ *
+ * @param handle the context handle
+ * @param lp list of missing dependencies caused by the removal transaction
+ */
 static void remove_prepare_keep_needed(alpm_handle_t *handle, alpm_list_t *lp)
 {
 	alpm_trans_t *trans = handle->trans;
@@ -137,12 +157,16 @@
 	}
 }
 
-/** Transaction preparation for remove actions.
+/**
+ * @brief Transaction preparation for remove actions.
+ *
  * This functions takes a pointer to a alpm_list_t which will be
  * filled with a list of alpm_depmissing_t* objects representing
  * the packages blocking the transaction.
+ *
  * @param handle the context handle
  * @param data a pointer to an alpm_list_t* to fill
+ *
  * @return 0 on success, -1 on error
  */
 int _alpm_remove_prepare(alpm_handle_t *handle, alpm_list_t **data)
@@ -211,12 +235,21 @@
 	return 0;
 }
 
+/**
+ * @brief Check if alpm can delete a file.
+ *
+ * @param handle the context handle
+ * @param file file to be removed
+ * @param skip_remove list of files that will not be removed
+ *
+ * @return 1 if the file can be deleted, 0 if it cannot be deleted
+ */
 static int can_remove_file(alpm_handle_t *handle, const alpm_file_t *file,
 		alpm_list_t *skip_remove)
 {
 	char filepath[PATH_MAX];
 
-	if(alpm_list_find_str(skip_remove, file->name)) {
+	if(alpm_list_find(skip_remove, file->name, _alpm_fnmatch)) {
 		/* return success because we will never actually remove this file */
 		return 1;
 	}
@@ -237,10 +270,22 @@
 	return 1;
 }
 
-/* Helper function for iterating through a package's file and deleting them
- * Used by _alpm_remove_commit. */
-static int unlink_file(alpm_handle_t *handle, alpm_pkg_t *info,
-		const alpm_file_t *fileobj, alpm_list_t *skip_remove, int nosave)
+/**
+ * @brief Unlink a package file, backing it up if necessary.
+ *
+ * @param handle the context handle
+ * @param oldpkg the package being removed
+ * @param newpkg the package replacing \a oldpkg
+ * @param fileobj file to remove
+ * @param skip_remove list of files that shouldn't be removed
+ * @param nosave whether files should be backed up
+ *
+ * @return 0 on success, -1 if there was an error unlinking the file, 1 if the
+ * file was skipped or did not exist
+ */
+static int unlink_file(alpm_handle_t *handle, alpm_pkg_t *oldpkg,
+		alpm_pkg_t *newpkg, const alpm_file_t *fileobj, alpm_list_t *skip_remove,
+		int nosave)
 {
 	struct stat buf;
 	char file[PATH_MAX];
@@ -250,7 +295,7 @@
 	/* check the remove skip list before removing the file.
 	 * see the big comment block in db_find_fileconflicts() for an
 	 * explanation. */
-	if(alpm_list_find_str(skip_remove, fileobj->name)) {
+	if(alpm_list_find(skip_remove, fileobj->name, _alpm_fnmatch)) {
 		_alpm_log(handle, ALPM_LOG_DEBUG,
 				"%s is in skip_remove, skipping removal\n", file);
 		return 1;
@@ -274,6 +319,10 @@
 		} else if(files < 0) {
 			_alpm_log(handle, ALPM_LOG_DEBUG,
 					"keeping directory %s (could not count files)\n", file);
+		} else if(newpkg && alpm_filelist_contains(alpm_pkg_get_files(newpkg),
+					fileobj->name)) {
+			_alpm_log(handle, ALPM_LOG_DEBUG,
+					"keeping directory %s (in new package)\n", file);
 		} else {
 			/* one last check- does any other package own this file? */
 			alpm_list_t *local, *local_pkgs;
@@ -285,11 +334,12 @@
 
 				/* we duplicated the package when we put it in the removal list, so we
 				 * so we can't use direct pointer comparison here. */
-				if(_alpm_pkg_cmp(info, local_pkg) == 0) {
+				if(oldpkg->name_hash == local_pkg->name_hash
+						&& strcmp(oldpkg->name, local_pkg->name) == 0) {
 					continue;
 				}
 				filelist = alpm_pkg_get_files(local_pkg);
-				if(_alpm_filelist_contains(filelist, fileobj->name)) {
+				if(alpm_filelist_contains(filelist, fileobj->name)) {
 					_alpm_log(handle, ALPM_LOG_DEBUG,
 							"keeping directory %s (owned by %s)\n", file, local_pkg->name);
 					found = 1;
@@ -308,7 +358,7 @@
 		}
 	} else {
 		/* if the file needs backup and has been modified, back it up to .pacsave */
-		alpm_backup_t *backup = _alpm_needbackup(fileobj->name, info);
+		alpm_backup_t *backup = _alpm_needbackup(fileobj->name, oldpkg);
 		if(backup) {
 			if(nosave) {
 				_alpm_log(handle, ALPM_LOG_DEBUG, "transaction is set to NOSAVE, not backing up '%s'\n", file);
@@ -350,38 +400,28 @@
 	return 0;
 }
 
-int _alpm_remove_single_package(alpm_handle_t *handle,
+/**
+ * @brief Remove a package's files, optionally skipping its replacement's
+ * files.
+ *
+ * @param handle the context handle
+ * @param oldpkg package to remove
+ * @param newpkg package to replace \a oldpkg (optional)
+ * @param targ_count current index within the transaction (1-based)
+ * @param pkg_count the number of packages affected by the transaction
+ *
+ * @return 0 on success, -1 if alpm lacks permission to delete some of the
+ * files, >0 the number of files alpm was unable to delete
+ */
+static int remove_package_files(alpm_handle_t *handle,
 		alpm_pkg_t *oldpkg, alpm_pkg_t *newpkg,
 		size_t targ_count, size_t pkg_count)
 {
 	alpm_list_t *skip_remove;
-	size_t filenum = 0, position = 0;
-	const char *pkgname = oldpkg->name;
-	const char *pkgver = oldpkg->version;
 	alpm_filelist_t *filelist;
 	size_t i;
-
-	if(newpkg) {
-		_alpm_log(handle, ALPM_LOG_DEBUG, "removing old package first (%s-%s)\n",
-				pkgname, pkgver);
-	} else {
-		EVENT(handle, ALPM_EVENT_REMOVE_START, oldpkg, NULL);
-		_alpm_log(handle, ALPM_LOG_DEBUG, "removing package %s-%s\n",
-				pkgname, pkgver);
-
-		/* run the pre-remove scriptlet if it exists  */
-		if(alpm_pkg_has_scriptlet(oldpkg) &&
-				!(handle->trans->flags & ALPM_TRANS_FLAG_NOSCRIPTLET)) {
-			char *scriptlet = _alpm_local_db_pkgpath(handle->db_local,
-					oldpkg, "install");
-			_alpm_runscriptlet(handle, scriptlet, "pre_remove", pkgver, NULL, 0);
-			free(scriptlet);
-		}
-	}
-
-	if(handle->trans->flags & ALPM_TRANS_FLAG_DBONLY) {
-		goto db;
-	}
+	int err = 0;
+	int nosave = handle->trans->flags & ALPM_TRANS_FLAG_NOSAVE;
 
 	if(newpkg) {
 		alpm_filelist_t *newfiles;
@@ -396,7 +436,7 @@
 		for(b = alpm_pkg_get_backup(newpkg); b; b = b->next) {
 			const alpm_backup_t *backup = b->data;
 			/* safety check (fix the upgrade026 pactest) */
-			if(!_alpm_filelist_contains(newfiles, backup->name)) {
+			if(!alpm_filelist_contains(newfiles, backup->name)) {
 				continue;
 			}
 			_alpm_log(handle, ALPM_LOG_DEBUG, "adding %s to the skip_remove array\n",
@@ -412,54 +452,100 @@
 		alpm_file_t *file = filelist->files + i;
 		if(!can_remove_file(handle, file, skip_remove)) {
 			_alpm_log(handle, ALPM_LOG_DEBUG,
-					"not removing package '%s', can't remove all files\n", pkgname);
+					"not removing package '%s', can't remove all files\n",
+					oldpkg->name);
+			FREELIST(skip_remove);
 			RET_ERR(handle, ALPM_ERR_PKG_CANT_REMOVE, -1);
 		}
-		filenum++;
 	}
 
-	_alpm_log(handle, ALPM_LOG_DEBUG, "removing %ld files\n", (unsigned long)filenum);
+	_alpm_log(handle, ALPM_LOG_DEBUG, "removing %zd files\n", filelist->count);
 
 	if(!newpkg) {
 		/* init progress bar, but only on true remove transactions */
-		PROGRESS(handle, ALPM_PROGRESS_REMOVE_START, pkgname, 0,
+		PROGRESS(handle, ALPM_PROGRESS_REMOVE_START, oldpkg->name, 0,
 				pkg_count, targ_count);
 	}
 
 	/* iterate through the list backwards, unlinking files */
 	for(i = filelist->count; i > 0; i--) {
 		alpm_file_t *file = filelist->files + i - 1;
-		int percent;
-		/* TODO: check return code and handle accordingly */
-		unlink_file(handle, oldpkg, file, skip_remove,
-				handle->trans->flags & ALPM_TRANS_FLAG_NOSAVE);
+		if(unlink_file(handle, oldpkg, newpkg, file, skip_remove, nosave) < 0) {
+			err++;
+		}
 
 		if(!newpkg) {
 			/* update progress bar after each file */
-			percent = (position * 100) / filenum;
-			PROGRESS(handle, ALPM_PROGRESS_REMOVE_START, pkgname,
+			int percent = ((filelist->count - i) * 100) / filelist->count;
+			PROGRESS(handle, ALPM_PROGRESS_REMOVE_START, oldpkg->name,
 					percent, pkg_count, targ_count);
 		}
-		position++;
 	}
 	FREELIST(skip_remove);
 
 	if(!newpkg) {
 		/* set progress to 100% after we finish unlinking files */
-		PROGRESS(handle, ALPM_PROGRESS_REMOVE_START, pkgname, 100,
+		PROGRESS(handle, ALPM_PROGRESS_REMOVE_START, oldpkg->name, 100,
 				pkg_count, targ_count);
+	}
+
+	return err;
+}
+
+/**
+ * @brief Remove a package from the filesystem.
+ *
+ * @param handle the context handle
+ * @param oldpkg package to remove
+ * @param newpkg package to replace \a oldpkg (optional)
+ * @param targ_count current index within the transaction (1-based)
+ * @param pkg_count the number of packages affected by the transaction
+ *
+ * @return 0
+ */
+int _alpm_remove_single_package(alpm_handle_t *handle,
+		alpm_pkg_t *oldpkg, alpm_pkg_t *newpkg,
+		size_t targ_count, size_t pkg_count)
+{
+	const char *pkgname = oldpkg->name;
+	const char *pkgver = oldpkg->version;
+
+	if(newpkg) {
+		_alpm_log(handle, ALPM_LOG_DEBUG, "removing old package first (%s-%s)\n",
+				pkgname, pkgver);
+	} else {
+		EVENT(handle, ALPM_EVENT_REMOVE_START, oldpkg, NULL);
+		_alpm_log(handle, ALPM_LOG_DEBUG, "removing package %s-%s\n",
+				pkgname, pkgver);
 
-		/* run the post-remove script if it exists  */
+		/* run the pre-remove scriptlet if it exists  */
 		if(alpm_pkg_has_scriptlet(oldpkg) &&
 				!(handle->trans->flags & ALPM_TRANS_FLAG_NOSCRIPTLET)) {
 			char *scriptlet = _alpm_local_db_pkgpath(handle->db_local,
 					oldpkg, "install");
-			_alpm_runscriptlet(handle, scriptlet, "post_remove", pkgver, NULL, 0);
+			_alpm_runscriptlet(handle, scriptlet, "pre_remove", pkgver, NULL, 0);
 			free(scriptlet);
 		}
 	}
 
-db:
+	if(!(handle->trans->flags & ALPM_TRANS_FLAG_DBONLY)) {
+		/* TODO check returned errors if any */
+		remove_package_files(handle, oldpkg, newpkg, targ_count, pkg_count);
+	}
+
+	/* run the post-remove script if it exists  */
+	if(!newpkg && alpm_pkg_has_scriptlet(oldpkg) &&
+			!(handle->trans->flags & ALPM_TRANS_FLAG_NOSCRIPTLET)) {
+		char *scriptlet = _alpm_local_db_pkgpath(handle->db_local,
+				oldpkg, "install");
+		_alpm_runscriptlet(handle, scriptlet, "post_remove", pkgver, NULL, 0);
+		free(scriptlet);
+	}
+
+	if(!newpkg) {
+		EVENT(handle, ALPM_EVENT_REMOVE_DONE, oldpkg, NULL);
+	}
+
 	/* remove the package from the database */
 	_alpm_log(handle, ALPM_LOG_DEBUG, "removing database entry '%s'\n", pkgname);
 	if(_alpm_local_db_remove(handle->db_local, oldpkg) == -1) {
@@ -472,14 +558,18 @@
 				pkgname);
 	}
 
-	if(!newpkg) {
-		/* TODO: awesome! we're passing invalid pointers. */
-		EVENT(handle, ALPM_EVENT_REMOVE_DONE, oldpkg, NULL);
-	}
-
+	/* TODO: useful return values */
 	return 0;
 }
 
+/**
+ * @brief Remove packages in the current transaction.
+ *
+ * @param handle the context handle
+ * @param run_ldconfig whether to run ld_config after removing the packages
+ *
+ * @return 0 on success, -1 if errors occurred while removing files
+ */
 int _alpm_remove_packages(alpm_handle_t *handle, int run_ldconfig)
 {
 	alpm_list_t *targ;
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/remove.h pacman/lib/libalpm/remove.h
--- pacman-4.0.3/lib/libalpm/remove.h	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/remove.h	2012-10-15 18:11:52.505292182 +0000
@@ -1,7 +1,7 @@
 /*
  *  remove.h
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/sha2.c pacman/lib/libalpm/sha2.c
--- pacman-4.0.3/lib/libalpm/sha2.c	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/sha2.c	2012-10-15 18:11:52.505292182 +0000
@@ -38,28 +38,29 @@
  *  * removal of SELF_TEST code
  *  * removal of ipad and opad from the sha2_context struct in sha2.h
  *  * increase the size of buffer for performance reasons
- *  * various static changes
+ *  * change 'unsigned long' to uint32_t
  */
 
 #include <stdio.h>
+#include <stdint.h>
 
 #include "sha2.h"
 
 /*
  * 32-bit integer manipulation macros (big endian)
  */
-#ifndef GET_ULONG_BE
-#define GET_ULONG_BE(n,b,i)                             \
+#ifndef GET_U32_BE
+#define GET_U32_BE(n,b,i)                               \
 {                                                       \
-    (n) = ( (unsigned long) (b)[(i)    ] << 24 )        \
-        | ( (unsigned long) (b)[(i) + 1] << 16 )        \
-        | ( (unsigned long) (b)[(i) + 2] <<  8 )        \
-        | ( (unsigned long) (b)[(i) + 3]       );       \
+    (n) = ( (uint32_t) (b)[(i)    ] << 24 )             \
+        | ( (uint32_t) (b)[(i) + 1] << 16 )             \
+        | ( (uint32_t) (b)[(i) + 2] <<  8 )             \
+        | ( (uint32_t) (b)[(i) + 3]       );            \
 }
 #endif
 
-#ifndef PUT_ULONG_BE
-#define PUT_ULONG_BE(n,b,i)                             \
+#ifndef PUT_U32_BE
+#define PUT_U32_BE(n,b,i)                               \
 {                                                       \
     (b)[(i)    ] = (unsigned char) ( (n) >> 24 );       \
     (b)[(i) + 1] = (unsigned char) ( (n) >> 16 );       \
@@ -106,25 +107,25 @@
 
 static void sha2_process( sha2_context *ctx, const unsigned char data[64] )
 {
-    unsigned long temp1, temp2, W[64];
-    unsigned long A, B, C, D, E, F, G, H;
+    uint32_t temp1, temp2, W[64];
+    uint32_t A, B, C, D, E, F, G, H;
 
-    GET_ULONG_BE( W[ 0], data,  0 );
-    GET_ULONG_BE( W[ 1], data,  4 );
-    GET_ULONG_BE( W[ 2], data,  8 );
-    GET_ULONG_BE( W[ 3], data, 12 );
-    GET_ULONG_BE( W[ 4], data, 16 );
-    GET_ULONG_BE( W[ 5], data, 20 );
-    GET_ULONG_BE( W[ 6], data, 24 );
-    GET_ULONG_BE( W[ 7], data, 28 );
-    GET_ULONG_BE( W[ 8], data, 32 );
-    GET_ULONG_BE( W[ 9], data, 36 );
-    GET_ULONG_BE( W[10], data, 40 );
-    GET_ULONG_BE( W[11], data, 44 );
-    GET_ULONG_BE( W[12], data, 48 );
-    GET_ULONG_BE( W[13], data, 52 );
-    GET_ULONG_BE( W[14], data, 56 );
-    GET_ULONG_BE( W[15], data, 60 );
+    GET_U32_BE( W[ 0], data,  0 );
+    GET_U32_BE( W[ 1], data,  4 );
+    GET_U32_BE( W[ 2], data,  8 );
+    GET_U32_BE( W[ 3], data, 12 );
+    GET_U32_BE( W[ 4], data, 16 );
+    GET_U32_BE( W[ 5], data, 20 );
+    GET_U32_BE( W[ 6], data, 24 );
+    GET_U32_BE( W[ 7], data, 28 );
+    GET_U32_BE( W[ 8], data, 32 );
+    GET_U32_BE( W[ 9], data, 36 );
+    GET_U32_BE( W[10], data, 40 );
+    GET_U32_BE( W[11], data, 44 );
+    GET_U32_BE( W[12], data, 48 );
+    GET_U32_BE( W[13], data, 52 );
+    GET_U32_BE( W[14], data, 56 );
+    GET_U32_BE( W[15], data, 60 );
 
 #define  SHR(x,n) ((x & 0xFFFFFFFF) >> n)
 #define ROTR(x,n) (SHR(x,n) | (x << (32 - n)))
@@ -241,7 +242,7 @@
 static void sha2_update( sha2_context *ctx, const unsigned char *input, size_t ilen )
 {
     size_t fill;
-    unsigned long left;
+    uint32_t left;
 
     if( ilen <= 0 )
         return;
@@ -249,10 +250,10 @@
     left = ctx->total[0] & 0x3F;
     fill = 64 - left;
 
-    ctx->total[0] += (unsigned long) ilen;
+    ctx->total[0] += (uint32_t) ilen;
     ctx->total[0] &= 0xFFFFFFFF;
 
-    if( ctx->total[0] < (unsigned long) ilen )
+    if( ctx->total[0] < (uint32_t) ilen )
         ctx->total[1]++;
 
     if( left && ilen >= fill )
@@ -292,16 +293,16 @@
  */
 static void sha2_finish( sha2_context *ctx, unsigned char output[32] )
 {
-    unsigned long last, padn;
-    unsigned long high, low;
+    uint32_t last, padn;
+    uint32_t high, low;
     unsigned char msglen[8];
 
     high = ( ctx->total[0] >> 29 )
          | ( ctx->total[1] <<  3 );
     low  = ( ctx->total[0] <<  3 );
 
-    PUT_ULONG_BE( high, msglen, 0 );
-    PUT_ULONG_BE( low,  msglen, 4 );
+    PUT_U32_BE( high, msglen, 0 );
+    PUT_U32_BE( low,  msglen, 4 );
 
     last = ctx->total[0] & 0x3F;
     padn = ( last < 56 ) ? ( 56 - last ) : ( 120 - last );
@@ -309,16 +310,16 @@
     sha2_update( ctx, (unsigned char *) sha2_padding, padn );
     sha2_update( ctx, msglen, 8 );
 
-    PUT_ULONG_BE( ctx->state[0], output,  0 );
-    PUT_ULONG_BE( ctx->state[1], output,  4 );
-    PUT_ULONG_BE( ctx->state[2], output,  8 );
-    PUT_ULONG_BE( ctx->state[3], output, 12 );
-    PUT_ULONG_BE( ctx->state[4], output, 16 );
-    PUT_ULONG_BE( ctx->state[5], output, 20 );
-    PUT_ULONG_BE( ctx->state[6], output, 24 );
+    PUT_U32_BE( ctx->state[0], output,  0 );
+    PUT_U32_BE( ctx->state[1], output,  4 );
+    PUT_U32_BE( ctx->state[2], output,  8 );
+    PUT_U32_BE( ctx->state[3], output, 12 );
+    PUT_U32_BE( ctx->state[4], output, 16 );
+    PUT_U32_BE( ctx->state[5], output, 20 );
+    PUT_U32_BE( ctx->state[6], output, 24 );
 
     if( ctx->is224 == 0 )
-        PUT_ULONG_BE( ctx->state[7], output, 28 );
+        PUT_U32_BE( ctx->state[7], output, 28 );
 }
 
 /*
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/signing.c pacman/lib/libalpm/signing.c
--- pacman-4.0.3/lib/libalpm/signing.c	2012-03-28 14:55:14.000000000 +0000
+++ pacman/lib/libalpm/signing.c	2012-10-15 18:11:52.505292182 +0000
@@ -17,8 +17,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <stdlib.h>
 #include <stdio.h>
 #include <string.h>
@@ -210,9 +208,9 @@
 	} else {
 		_alpm_log(handle, ALPM_LOG_DEBUG, "gpg error: %s\n", gpgme_strerror(err));
 	}
+	gpgme_key_unref(key);
 
 error:
-	gpgme_key_unref(key);
 	gpgme_release(ctx);
 	return ret;
 }
@@ -292,11 +290,34 @@
 	pgpkey->email = key->uids->email;
 	pgpkey->created = key->subkeys->timestamp;
 	pgpkey->expires = key->subkeys->expires;
-	gpgme_release(ctx);
-	return 1;
+	pgpkey->length = key->subkeys->length;
+	pgpkey->revoked = key->subkeys->revoked;
+
+	switch (key->subkeys->pubkey_algo) {
+		case GPGME_PK_RSA:
+		case GPGME_PK_RSA_E:
+		case GPGME_PK_RSA_S:
+			pgpkey->pubkey_algo = 'R';
+			break;
+
+		case GPGME_PK_DSA:
+			pgpkey->pubkey_algo = 'D';
+			break;
+
+		case GPGME_PK_ELG_E:
+		case GPGME_PK_ELG:
+		case GPGME_PK_ECDSA:
+		case GPGME_PK_ECDH:
+			pgpkey->pubkey_algo = 'E';
+			break;
+	}
+
+	ret = 1;
 
 error:
-	_alpm_log(handle, ALPM_LOG_DEBUG, "gpg error: %s\n", gpgme_strerror(err));
+	if(ret != 1) {
+		_alpm_log(handle, ALPM_LOG_DEBUG, "gpg error: %s\n", gpgme_strerror(err));
+	}
 	free(full_fpr);
 	gpgme_release(ctx);
 	return ret;
@@ -418,8 +439,13 @@
 
 	if(!base64_sig) {
 		sigpath = _alpm_sigpath(handle, path);
-		/* this will just help debugging */
-		_alpm_access(handle, NULL, sigpath, R_OK);
+		if(_alpm_access(handle, NULL, sigpath, R_OK) != 0
+				|| (sigfile = fopen(sigpath, "rb")) == NULL) {
+			_alpm_log(handle, ALPM_LOG_DEBUG, "sig path %s could not be opened\n",
+					sigpath);
+			handle->pm_errno = ALPM_ERR_SIG_MISSING;
+			goto error;
+		}
 	}
 
 	/* does the file we are verifying exist? */
@@ -429,17 +455,6 @@
 		goto error;
 	}
 
-	/* does the sig file exist (if we didn't get the data directly)? */
-	if(!base64_sig) {
-		sigfile = fopen(sigpath, "rb");
-		if(sigfile == NULL) {
-			_alpm_log(handle, ALPM_LOG_DEBUG, "sig path %s could not be opened\n",
-					sigpath);
-			handle->pm_errno = ALPM_ERR_SIG_MISSING;
-			goto error;
-		}
-	}
-
 	if(init_gpgme(handle)) {
 		/* pm_errno was set in gpgme_init() */
 		goto error;
@@ -515,6 +530,11 @@
 				string_validity(gpgsig->validity),
 				gpgme_strerror(gpgsig->validity_reason));
 
+		if((time_t)gpgsig->timestamp > time(NULL)) {
+			_alpm_log(handle, ALPM_LOG_WARNING,
+					_("System time is greater than signature timestamp.\n"));
+		}
+
 		result = siglist->results + sigcount;
 		err = gpgme_get_key(ctx, gpgsig->fpr, &key, 0);
 		if(gpg_err_code(err) == GPG_ERR_EOF) {
@@ -797,7 +817,7 @@
 						_("%s: key \"%s\" is unknown\n"), identifier, name);
 #ifdef HAVE_LIBGPGME
 				{
-					int answer;
+					int answer = 0;
 					alpm_pgpkey_t fetch_key;
 					memset(&fetch_key, 0, sizeof(fetch_key));
 
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/signing.h pacman/lib/libalpm/signing.h
--- pacman-4.0.3/lib/libalpm/signing.h	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/signing.h	2012-10-15 18:11:52.505292182 +0000
@@ -1,7 +1,7 @@
 /*
  *  signing.h
  *
- *  Copyright (c) 2008-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2008-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/sync.c pacman/lib/libalpm/sync.c
--- pacman-4.0.3/lib/libalpm/sync.c	2012-04-07 15:13:38.000000000 +0000
+++ pacman/lib/libalpm/sync.c	2012-10-15 18:11:52.505292182 +0000
@@ -1,7 +1,7 @@
 /*
  *  sync.c
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *  Copyright (c) 2005 by Aurelien Foret <orelien@chez.com>
  *  Copyright (c) 2005 by Christian Hamar <krics@linuxforum.hu>
@@ -21,8 +21,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <sys/types.h> /* off_t */
 #include <stdlib.h>
 #include <stdio.h>
@@ -127,7 +125,8 @@
 	alpm_list_t *replacers = NULL;
 	alpm_list_t *k;
 	_alpm_log(handle, ALPM_LOG_DEBUG,
-			"searching for replacements for %s\n", lpkg->name);
+			"searching for replacements for %s in %s\n",
+			lpkg->name, sdb->treename);
 	for(k = _alpm_db_get_pkgcache(sdb); k; k = k->next) {
 		int found = 0;
 		alpm_pkg_t *spkg = k->data;
@@ -250,7 +249,7 @@
 
 	for(i = dbs; i; i = i->next) {
 		alpm_db_t *db = i->data;
-		alpm_group_t *grp = alpm_db_readgroup(db, name);
+		alpm_group_t *grp = alpm_db_get_group(db, name);
 
 		if(!grp)
 			continue;
@@ -290,7 +289,7 @@
 	alpm_handle_t *handle = newpkg->handle;
 	int ret = 0;
 
-	if(newpkg->origin != PKG_FROM_SYNCDB) {
+	if(newpkg->origin != ALPM_PKG_FROM_SYNCDB) {
 		newpkg->infolevel |= INFRQ_DSIZE;
 		newpkg->download_size = 0;
 		return 0;
@@ -320,13 +319,13 @@
 
 		/* tell the caller that we have a partial */
 		ret = 1;
-	} else if(handle->usedelta) {
+	} else if(handle->deltaratio > 0.0) {
 		off_t dltsize;
 
 		dltsize = _alpm_shortest_delta_path(handle, newpkg->deltas,
 				newpkg->filename, &newpkg->delta_path);
 
-		if(newpkg->delta_path && (dltsize < newpkg->size * MAX_DELTA_RATIO)) {
+		if(newpkg->delta_path && (dltsize < newpkg->size * handle->deltaratio)) {
 			_alpm_log(handle, ALPM_LOG_DEBUG, "using delta size\n");
 			size = dltsize;
 		} else {
@@ -367,7 +366,7 @@
 
 	for(i = trans->add; i; i = i->next) {
 		alpm_pkg_t *spkg = i->data;
-		from_sync += (spkg->origin == PKG_FROM_SYNCDB);
+		from_sync += (spkg->origin == ALPM_PKG_FROM_SYNCDB);
 	}
 
 	/* ensure all sync database are valid if we will be using them */
@@ -423,7 +422,7 @@
 		   see if they'd like to ignore them rather than failing the sync */
 		if(unresolvable != NULL) {
 			int remove_unresolvable = 0;
-			enum _alpm_errno_t saved_err = handle->pm_errno;
+			alpm_errno_t saved_err = handle->pm_errno;
 			QUESTION(handle, ALPM_QUESTION_REMOVE_PKGS, unresolvable,
 					NULL, NULL, &remove_unresolvable);
 			if(remove_unresolvable) {
@@ -695,11 +694,11 @@
 			} else {
 				/* len = cachedir len + from len + '/' + null */
 				len = strlen(cachedir) + strlen(d->from) + 2;
-				CALLOC(from, len, sizeof(char), RET_ERR(handle, ALPM_ERR_MEMORY, 1));
+				MALLOC(from, len, RET_ERR(handle, ALPM_ERR_MEMORY, 1));
 				snprintf(from, len, "%s/%s", cachedir, d->from);
 			}
 			len = strlen(cachedir) + strlen(d->to) + 2;
-			CALLOC(to, len, sizeof(char), RET_ERR(handle, ALPM_ERR_MEMORY, 1));
+			MALLOC(to, len, RET_ERR(handle, ALPM_ERR_MEMORY, 1));
 			snprintf(to, len, "%s/%s", cachedir, d->to);
 
 			/* build the patch command */
@@ -757,7 +756,7 @@
  * @return 1 if file was removed, 0 otherwise
  */
 static int prompt_to_delete(alpm_handle_t *handle, const char *filepath,
-		enum _alpm_errno_t reason)
+		alpm_errno_t reason)
 {
 	int doremove = 0;
 	QUESTION(handle, ALPM_QUESTION_CORRUPTED_PKG, (char *)filepath,
@@ -782,7 +781,7 @@
 		alpm_delta_t *d = i->data;
 		char *filepath = _alpm_filecache_find(handle, d->delta);
 
-		if(_alpm_test_checksum(filepath, d->delta_md5, ALPM_CSUM_MD5)) {
+		if(_alpm_test_checksum(filepath, d->delta_md5, ALPM_PKG_VALIDATION_MD5SUM)) {
 			errors = alpm_list_add(errors, filepath);
 		} else {
 			FREE(filepath);
@@ -803,11 +802,96 @@
 	return 0;
 }
 
+static struct dload_payload *build_payload(alpm_handle_t *handle,
+		const char *filename, size_t size, alpm_list_t *servers)
+{
+		struct dload_payload *payload;
+
+		CALLOC(payload, 1, sizeof(*payload), RET_ERR(handle, ALPM_ERR_MEMORY, NULL));
+		STRDUP(payload->remote_name, filename, RET_ERR(handle, ALPM_ERR_MEMORY, NULL));
+		payload->max_size = size;
+		payload->servers = servers;
+		return payload;
+}
+
+static int find_dl_candidates(alpm_db_t *repo, alpm_list_t **files, alpm_list_t **deltas)
+{
+	alpm_list_t *i;
+	alpm_handle_t *handle = repo->handle;
+
+	for(i = handle->trans->add; i; i = i->next) {
+		alpm_pkg_t *spkg = i->data;
+
+		if(spkg->origin != ALPM_PKG_FROM_FILE && repo == spkg->origin_data.db) {
+			alpm_list_t *delta_path = spkg->delta_path;
+
+			if(!repo->servers) {
+				handle->pm_errno = ALPM_ERR_SERVER_NONE;
+				_alpm_log(handle, ALPM_LOG_ERROR, "%s: %s\n",
+						alpm_strerror(handle->pm_errno), repo->treename);
+				return 1;
+			}
+
+			if(delta_path) {
+				/* using deltas */
+				alpm_list_t *dlts;
+				for(dlts = delta_path; dlts; dlts = dlts->next) {
+					alpm_delta_t *delta = dlts->data;
+					if(delta->download_size != 0) {
+						struct dload_payload *payload = build_payload(
+								handle, delta->delta, delta->delta_size, repo->servers);
+						ASSERT(payload, return -1);
+						*files = alpm_list_add(*files, payload);
+					}
+					/* keep a list of all the delta files for md5sums */
+					*deltas = alpm_list_add(*deltas, delta);
+				}
+
+			} else if(spkg->download_size != 0) {
+				struct dload_payload *payload;
+				ASSERT(spkg->filename != NULL, RET_ERR(handle, ALPM_ERR_PKG_INVALID_NAME, -1));
+				payload = build_payload(handle, spkg->filename, spkg->size, repo->servers);
+				ASSERT(payload, return -1);
+				*files = alpm_list_add(*files, payload);
+			}
+		}
+	}
+
+	return 0;
+}
+
+static int download_single_file(alpm_handle_t *handle, struct dload_payload *payload,
+		const char *cachedir)
+{
+	const alpm_list_t *server;
+
+	payload->handle = handle;
+	payload->allow_resume = 1;
+
+	for(server = payload->servers; server; server = server->next) {
+		const char *server_url = server->data;
+		size_t len;
+
+		/* print server + filename into a buffer */
+		len = strlen(server_url) + strlen(payload->remote_name) + 2;
+		MALLOC(payload->fileurl, len, RET_ERR(handle, ALPM_ERR_MEMORY, -1));
+		snprintf(payload->fileurl, len, "%s/%s", server_url, payload->remote_name);
+
+		if(_alpm_download(payload, cachedir, NULL) != -1) {
+			return 0;
+		}
+
+		FREE(payload->fileurl);
+		payload->unlink_on_fail = 0;
+	}
+
+	return -1;
+}
+
 static int download_files(alpm_handle_t *handle, alpm_list_t **deltas)
 {
 	const char *cachedir;
-	alpm_list_t *i, *j;
-	alpm_list_t *files = NULL;
+	alpm_list_t *i, *files = NULL;
 	int errors = 0;
 
 	cachedir = _alpm_filecache_setup(handle);
@@ -826,93 +910,53 @@
 		handle->totaldlcb(total_size);
 	}
 
-	/* group sync records by repository and download */
 	for(i = handle->dbs_sync; i; i = i->next) {
-		alpm_db_t *current = i->data;
+		errors += find_dl_candidates(i->data, &files, deltas);
+	}
 
-		for(j = handle->trans->add; j; j = j->next) {
-			alpm_pkg_t *spkg = j->data;
+	if(files) {
+		/* check for necessary disk space for download */
+		if(handle->checkspace) {
+			off_t *file_sizes;
+			size_t idx, num_files;
+			int ret;
 
-			if(spkg->origin != PKG_FROM_FILE && current == spkg->origin_data.db) {
-				alpm_list_t *delta_path = spkg->delta_path;
-				if(delta_path) {
-					/* using deltas */
-					alpm_list_t *dlts;
-					for(dlts = delta_path; dlts; dlts = dlts->next) {
-						alpm_delta_t *delta = dlts->data;
-						if(delta->download_size != 0) {
-							struct dload_payload *dpayload;
-
-							CALLOC(dpayload, 1, sizeof(*dpayload), RET_ERR(handle, ALPM_ERR_MEMORY, -1));
-							STRDUP(dpayload->remote_name, delta->delta, RET_ERR(handle, ALPM_ERR_MEMORY, -1));
-							dpayload->max_size = delta->delta_size;
-
-							files = alpm_list_add(files, dpayload);
-						}
-						/* keep a list of all the delta files for md5sums */
-						*deltas = alpm_list_add(*deltas, delta);
-					}
+			_alpm_log(handle, ALPM_LOG_DEBUG, "checking available disk space for download\n");
 
-				} else if(spkg->download_size != 0) {
-					struct dload_payload *payload;
+			num_files = alpm_list_count(files);
+			CALLOC(file_sizes, num_files, sizeof(off_t), goto finish);
 
-					ASSERT(spkg->filename != NULL, RET_ERR(handle, ALPM_ERR_PKG_INVALID_NAME, -1));
-					CALLOC(payload, 1, sizeof(*payload), RET_ERR(handle, ALPM_ERR_MEMORY, -1));
-					STRDUP(payload->remote_name, spkg->filename, RET_ERR(handle, ALPM_ERR_MEMORY, -1));
-					payload->max_size = spkg->size;
+			for(i = files, idx = 0; i; i = i->next, idx++) {
+				const struct dload_payload *payload = i->data;
+				file_sizes[idx] = payload->max_size;
+			}
 
-					files = alpm_list_add(files, payload);
-				}
+			ret = _alpm_check_downloadspace(handle, cachedir, num_files, file_sizes);
+			free(file_sizes);
 
+			if(ret != 0) {
+				errors++;
+				goto finish;
 			}
 		}
 
-		if(files) {
-			if(!current->servers) {
-				handle->pm_errno = ALPM_ERR_SERVER_NONE;
-				_alpm_log(handle, ALPM_LOG_ERROR, "%s: %s\n",
-						alpm_strerror(handle->pm_errno), current->treename);
+		EVENT(handle, ALPM_EVENT_RETRIEVE_START, NULL, NULL);
+		for(i = files; i; i = i->next) {
+			if(download_single_file(handle, i->data, cachedir) == -1) {
 				errors++;
-				continue;
+				_alpm_log(handle, ALPM_LOG_WARNING, _("failed to retrieve some files\n"));
 			}
-
-			EVENT(handle, ALPM_EVENT_RETRIEVE_START, current->treename, NULL);
-			for(j = files; j; j = j->next) {
-				struct dload_payload *payload = j->data;
-				alpm_list_t *server;
-				int ret = -1;
-				for(server = current->servers; server; server = server->next) {
-					const char *server_url = server->data;
-					size_t len;
-
-					/* print server + filename into a buffer */
-					len = strlen(server_url) + strlen(payload->remote_name) + 2;
-					MALLOC(payload->fileurl, len, RET_ERR(handle, ALPM_ERR_MEMORY, -1));
-					snprintf(payload->fileurl, len, "%s/%s", server_url, payload->remote_name);
-					payload->handle = handle;
-					payload->allow_resume = 1;
-
-					ret = _alpm_download(payload, cachedir, NULL);
-					if(ret != -1) {
-						break;
-					}
-					FREE(payload->fileurl);
-					payload->unlink_on_fail = 0;
-				}
-				if(ret == -1) {
-					errors++;
-					_alpm_log(handle, ALPM_LOG_WARNING, _("failed to retrieve some files from %s\n"),
-							current->treename);
-				}
-			}
-
-			alpm_list_free_inner(files, (alpm_list_fn_free)_alpm_dload_payload_reset);
-			FREELIST(files);
 		}
 	}
 
-	for(j = handle->trans->add; j; j = j->next) {
-		alpm_pkg_t *pkg = j->data;
+finish:
+	if(files) {
+		alpm_list_free_inner(files, (alpm_list_fn_free)_alpm_dload_payload_reset);
+		FREELIST(files);
+	}
+
+	for(i = handle->trans->add; i; i = i->next) {
+		alpm_pkg_t *pkg = i->data;
 		pkg->infolevel &= ~INFRQ_DSIZE;
 		pkg->download_size = 0;
 	}
@@ -933,7 +977,8 @@
 		char *path;
 		alpm_siglist_t *siglist;
 		alpm_siglevel_t level;
-		enum _alpm_errno_t error;
+		alpm_pkgvalidation_t validation;
+		alpm_errno_t error;
 	};
 	size_t current = 0, current_bytes = 0;
 	alpm_list_t *i, *errors = NULL;
@@ -942,12 +987,12 @@
 	EVENT(handle, ALPM_EVENT_INTEGRITY_START, NULL, NULL);
 
 	for(i = handle->trans->add; i; i = i->next, current++) {
-		struct validity v = { i->data, NULL, NULL, 0, 0 };
+		struct validity v = { i->data, NULL, NULL, 0, 0, 0 };
 		int percent = (int)(((double)current_bytes / total_bytes) * 100);
 
 		PROGRESS(handle, ALPM_PROGRESS_INTEGRITY_START, "", percent,
 				total, current);
-		if(v.pkg->origin == PKG_FROM_FILE) {
+		if(v.pkg->origin == ALPM_PKG_FROM_FILE) {
 			continue; /* pkg_load() has been already called, this package is valid */
 		}
 
@@ -956,7 +1001,7 @@
 		v.level = alpm_db_get_siglevel(alpm_pkg_get_db(v.pkg));
 
 		if(_alpm_pkg_validate_internal(handle, v.path, v.pkg,
-					v.level, &v.siglist) == -1) {
+					v.level, &v.siglist, &v.validation) == -1) {
 			v.error = handle->pm_errno;
 			struct validity *invalid = malloc(sizeof(struct validity));
 			memcpy(invalid, &v, sizeof(struct validity));
@@ -965,6 +1010,7 @@
 			alpm_siglist_cleanup(v.siglist);
 			free(v.siglist);
 			free(v.path);
+			v.pkg->validation = v.validation;
 		}
 	}
 
@@ -1022,7 +1068,7 @@
 
 		PROGRESS(handle, ALPM_PROGRESS_LOAD_START, "", percent,
 				total, current);
-		if(spkg->origin == PKG_FROM_FILE) {
+		if(spkg->origin == ALPM_PKG_FROM_FILE) {
 			continue; /* pkg_load() has been already called, this package is valid */
 		}
 
@@ -1044,6 +1090,8 @@
 		free(filepath);
 		/* copy over the install reason */
 		pkgfile->reason = spkg->reason;
+		/* copy over validation method */
+		pkgfile->validation = spkg->validation;
 		i->data = pkgfile;
 		/* spkg has been removed from the target list, so we can free the
 		 * sync-specific fields */
@@ -1090,7 +1138,7 @@
 	 * realistically if there are small and huge packages involved */
 	for(i = trans->add; i; i = i->next) {
 		alpm_pkg_t *spkg = i->data;
-		if(spkg->origin != PKG_FROM_FILE) {
+		if(spkg->origin != ALPM_PKG_FROM_FILE) {
 			total_bytes += spkg->size;
 		}
 		total++;
@@ -1119,7 +1167,7 @@
 	trans->state = STATE_COMMITING;
 
 	/* fileconflict check */
-	if(!(trans->flags & ALPM_TRANS_FLAG_FORCE)) {
+	if(!(trans->flags & (ALPM_TRANS_FLAG_FORCE|ALPM_TRANS_FLAG_DBONLY))) {
 		EVENT(handle, ALPM_EVENT_FILECONFLICTS_START, NULL, NULL);
 
 		_alpm_log(handle, ALPM_LOG_DEBUG, "looking for file conflicts\n");
@@ -1144,7 +1192,7 @@
 
 		_alpm_log(handle, ALPM_LOG_DEBUG, "checking available disk space\n");
 		if(_alpm_check_diskspace(handle) == -1) {
-			_alpm_log(handle, ALPM_LOG_ERROR, "%s\n", _("not enough free disk space"));
+			_alpm_log(handle, ALPM_LOG_ERROR, _("not enough free disk space\n"));
 			return -1;
 		}
 
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/sync.h pacman/lib/libalpm/sync.h
--- pacman-4.0.3/lib/libalpm/sync.h	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/sync.h	2012-10-15 18:11:52.505292182 +0000
@@ -1,7 +1,7 @@
 /*
  *  sync.h
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *  Copyright (c) 2005 by Aurelien Foret <orelien@chez.com>
  *  Copyright (c) 2005, 2006 by Miklos Vajna <vmiklos@frugalware.org>
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/trans.c pacman/lib/libalpm/trans.c
--- pacman-4.0.3/lib/libalpm/trans.c	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/trans.c	2012-10-15 18:11:52.505292182 +0000
@@ -1,7 +1,7 @@
 /*
  *  trans.c
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *  Copyright (c) 2005 by Aurelien Foret <orelien@chez.com>
  *  Copyright (c) 2005 by Christian Hamar <krics@linuxforum.hu>
@@ -21,8 +21,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <stdlib.h>
 #include <stdio.h>
 #include <string.h>
@@ -165,7 +163,7 @@
 
 	if(trans->add == NULL) {
 		if(_alpm_remove_packages(handle, 1) == -1) {
-			/* pm_errno is set by _alpm_remove_commit() */
+			/* pm_errno is set by _alpm_remove_packages() */
 			return -1;
 		}
 	} else {
@@ -278,8 +276,8 @@
 int _alpm_runscriptlet(alpm_handle_t *handle, const char *filepath,
 		const char *script, const char *ver, const char *oldver, int is_archive)
 {
-	char cmdline[PATH_MAX];
-	char *argv[] = { "sh", "-c", cmdline, NULL };
+	char arg0[64], arg1[3], cmdline[PATH_MAX];
+	char *argv[] = { arg0, arg1, cmdline, NULL };
 	char *tmpdir, *scriptfn = NULL, *scriptpath;
 	int retval = 0;
 	size_t len;
@@ -295,6 +293,9 @@
 		return 0;
 	}
 
+	strcpy(arg0, SCRIPTLET_SHELL);
+	strcpy(arg1, "-c");
+
 	/* create a directory in $root/tmp/ for copying/extracting the scriptlet */
 	len = strlen(handle->root) + strlen("tmp/alpm_XXXXXX") + 1;
 	MALLOC(tmpdir, len, RET_ERR(handle, ALPM_ERR_MEMORY, -1));
@@ -345,7 +346,7 @@
 
 	_alpm_log(handle, ALPM_LOG_DEBUG, "executing \"%s\"\n", cmdline);
 
-	retval = _alpm_run_chroot(handle, "/bin/sh", argv);
+	retval = _alpm_run_chroot(handle, SCRIPTLET_SHELL, argv);
 
 cleanup:
 	if(scriptfn && unlink(scriptfn)) {
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/trans.h pacman/lib/libalpm/trans.h
--- pacman-4.0.3/lib/libalpm/trans.h	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/trans.h	2012-10-15 18:11:52.505292182 +0000
@@ -1,7 +1,7 @@
 /*
  *  trans.h
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *  Copyright (c) 2005 by Aurelien Foret <orelien@chez.com>
  *  Copyright (c) 2005 by Christian Hamar <krics@linuxforum.hu>
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/util.c pacman/lib/libalpm/util.c
--- pacman-4.0.3/lib/libalpm/util.c	2012-01-19 04:24:08.000000000 +0000
+++ pacman/lib/libalpm/util.c	2012-10-15 18:11:52.505292182 +0000
@@ -22,24 +22,17 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
-#include <stdio.h>
 #include <stdlib.h>
-#include <stdarg.h>
-#include <string.h>
 #include <unistd.h>
 #include <ctype.h>
 #include <dirent.h>
-#include <fcntl.h>
 #include <time.h>
 #include <syslog.h>
 #include <errno.h>
 #include <limits.h>
-#include <sys/types.h>
-#include <sys/stat.h>
 #include <sys/wait.h>
 #include <locale.h> /* setlocale */
+#include <fnmatch.h>
 
 /* libarchive */
 #include <archive.h>
@@ -62,11 +55,19 @@
 #include "trans.h"
 
 #ifndef HAVE_STRSEP
-/* This is a replacement for strsep which is not portable (missing on Solaris).
- * Copyright (c) 2001 by François Gouget <fgouget_at_codeweavers.com> */
-char* strsep(char** str, const char* delims)
+/** Extracts tokens from a string.
+ * Replaces strset which is not portable (missing on Solaris).
+ * Copyright (c) 2001 by François Gouget <fgouget_at_codeweavers.com>
+ * Modifies str to point to the first character after the token if one is
+ * found, or NULL if one is not.
+ * @param str string containing delimited tokens to parse
+ * @param delim character delimiting tokens in str
+ * @return pointer to the first token in str if str is not NULL, NULL if
+ * str is NULL
+ */
+char *strsep(char **str, const char *delims)
 {
-	char* token;
+	char *token;
 
 	if(*str==NULL) {
 		/* No more tokens */
@@ -93,138 +94,118 @@
 	return _alpm_makepath_mode(path, 0755);
 }
 
-/* does the same thing as 'mkdir -p' */
+/** Creates a directory, including parents if needed, similar to 'mkdir -p'.
+ * @param path directory path to create
+ * @param mode permission mode for created directories
+ * @return 0 on success, 1 on error
+ */
 int _alpm_makepath_mode(const char *path, mode_t mode)
 {
-	/* A bit of pointer hell here. Descriptions:
-	 * orig - a copy of path so we can safely butcher it with strsep
-	 * str - the current position in the path string (after the delimiter)
-	 * ptr - the original position of str after calling strsep
-	 * incr - incrementally generated path for use in stat/mkdir call
-	 */
-	char *orig, *str, *ptr, *incr;
-	mode_t oldmask = umask(0000);
+	char *ptr, *str;
+	mode_t oldmask;
 	int ret = 0;
 
-	orig = strdup(path);
-	incr = calloc(strlen(orig) + 1, sizeof(char));
-	str = orig;
-	while((ptr = strsep(&str, "/"))) {
-		if(strlen(ptr)) {
-			/* we have another path component- append the newest component to
-			 * existing string and create one more level of dir structure */
-			strcat(incr, "/");
-			strcat(incr, ptr);
-			if(access(incr, F_OK)) {
-				if(mkdir(incr, mode)) {
-					ret = 1;
-					break;
-				}
-			}
-		}
-	}
-	free(orig);
-	free(incr);
-	umask(oldmask);
-	return ret;
-}
+	STRDUP(str, path, return 1);
 
-int _alpm_copyfile(const char *src, const char *dest)
-{
-	FILE *in, *out;
-	size_t len;
-	char *buf;
-	int ret = 0;
+	oldmask = umask(0000);
 
-	in = fopen(src, "rb");
-	if(in == NULL) {
-		return 1;
-	}
-	out = fopen(dest, "wb");
-	if(out == NULL) {
-		fclose(in);
-		return 1;
-	}
+	for(ptr = str; *ptr; ptr++) {
+		/* detect mid-path condition and zero length paths */
+		if(*ptr != '/' || ptr == str || ptr[-1] == '/') {
+			continue;
+		}
 
-	MALLOC(buf, (size_t)ALPM_BUFFER_SIZE, ret = 1; goto cleanup);
+		/* temporarily mask the end of the path */
+		*ptr = '\0';
 
-	/* do the actual file copy */
-	while((len = fread(buf, 1, ALPM_BUFFER_SIZE, in))) {
-		size_t nwritten = 0;
-		nwritten = fwrite(buf, 1, len, out);
-		if((nwritten != len) || ferror(out)) {
-			ret = -1;
-			goto cleanup;
+		if(mkdir(str, mode) < 0 && errno != EEXIST) {
+			ret = 1;
+			goto done;
 		}
+
+		/* restore path separator */
+		*ptr = '/';
 	}
 
-	/* chmod dest to permissions of src, as long as it is not a symlink */
-	struct stat statbuf;
-	if(!stat(src, &statbuf)) {
-		if(! S_ISLNK(statbuf.st_mode)) {
-			fchmod(fileno(out), statbuf.st_mode);
-		}
-	} else {
-		/* stat was unsuccessful */
+	/* end of the string. add the full path. It will already exist when the path
+	 * passed in has a trailing slash. */
+	if(mkdir(str, mode) < 0 && errno != EEXIST) {
 		ret = 1;
 	}
 
-cleanup:
-	fclose(in);
-	fclose(out);
-	free(buf);
+done:
+	umask(oldmask);
+	free(str);
 	return ret;
 }
 
-/* Trim whitespace and newlines from a string
-*/
-char *_alpm_strtrim(char *str)
+/** Copies a file.
+ * @param src file path to copy from
+ * @param dest file path to copy to
+ * @return 0 on success, 1 on error 
+ */
+int _alpm_copyfile(const char *src, const char *dest)
 {
-	char *pch = str;
+	char *buf;
+	int in, out, ret = 1;
+	ssize_t nread;
+	struct stat st;
 
-	if(*str == '\0') {
-		/* string is empty, so we're done. */
-		return str;
+	MALLOC(buf, (size_t)ALPM_BUFFER_SIZE, return 1);
+
+	OPEN(in, src, O_RDONLY);
+	do {
+		out = open(dest, O_WRONLY | O_CREAT, 0000);
+	} while(out == -1 && errno == EINTR);
+	if(in < 0 || out < 0) {
+		goto cleanup;
 	}
 
-	while(isspace((unsigned char)*pch)) {
-		pch++;
+	if(fstat(in, &st) || fchmod(out, st.st_mode)) {
+		goto cleanup;
 	}
-	if(pch != str) {
-		size_t len = strlen(pch);
-		if(len) {
-			memmove(str, pch, len + 1);
-		} else {
-			*str = '\0';
+
+	/* do the actual file copy */
+	while((nread = read(in, buf, ALPM_BUFFER_SIZE)) > 0 || errno == EINTR) {
+		ssize_t nwrite = 0;
+		if(nread < 0) {
+			continue;
 		}
+		do {
+			nwrite = write(out, buf + nwrite, nread);
+			if(nwrite >= 0) {
+				nread -= nwrite;
+			} else if(errno != EINTR) {
+				goto cleanup;
+			}
+		} while(nread > 0);
 	}
+	ret = 0;
 
-	/* check if there wasn't anything but whitespace in the string. */
-	if(*str == '\0') {
-		return str;
+cleanup:
+	free(buf);
+	if(in >= 0) {
+		CLOSE(in);
 	}
-
-	pch = (str + (strlen(str) - 1));
-	while(isspace((unsigned char)*pch)) {
-		pch--;
+	if(out >= 0) {
+		CLOSE(out);
 	}
-	*++pch = '\0';
-
-	return str;
+	return ret;
 }
 
-/**
- * Trim trailing newline from a string (if one exists).
+/** Trim trailing newlines from a string (if any exist).
  * @param str a single line of text
+ * @param len size of str, if known, else 0
  * @return the length of the trimmed string
  */
-size_t _alpm_strip_newline(char *str)
+size_t _alpm_strip_newline(char *str, size_t len)
 {
-	size_t len;
 	if(*str == '\0') {
 		return 0;
 	}
-	len = strlen(str);
+	if(len == 0) {
+		len = strlen(str);
+	}
 	while(len > 0 && str[len - 1] == '\n') {
 		len--;
 	}
@@ -235,9 +216,70 @@
 
 /* Compression functions */
 
-/**
- * @brief Unpack a specific file in an archive.
- *
+/** Open an archive for reading and perform the necessary boilerplate.
+ * This takes care of creating the libarchive 'archive' struct, setting up
+ * compression and format options, opening a file descriptor, setting up the
+ * buffer size, and performing a stat on the path once opened.
+ * On error, no file descriptor is opened, and the archive pointer returned
+ * will be set to NULL.
+ * @param handle the context handle
+ * @param path the path of the archive to open
+ * @param buf space for a stat buffer for the given path
+ * @param archive pointer to place the created archive object
+ * @param error error code to set on failure to open archive
+ * @return -1 on failure, >=0 file descriptor on success
+ */
+int _alpm_open_archive(alpm_handle_t *handle, const char *path,
+		struct stat *buf, struct archive **archive, alpm_errno_t error)
+{
+	int fd;
+	size_t bufsize = ALPM_BUFFER_SIZE;
+	errno = 0;
+
+	if((*archive = archive_read_new()) == NULL) {
+		RET_ERR(handle, ALPM_ERR_LIBARCHIVE, -1);
+	}
+
+	archive_read_support_compression_all(*archive);
+	archive_read_support_format_all(*archive);
+
+	_alpm_log(handle, ALPM_LOG_DEBUG, "opening archive %s\n", path);
+	OPEN(fd, path, O_RDONLY);
+	if(fd < 0) {
+		_alpm_log(handle, ALPM_LOG_ERROR,
+				_("could not open file %s: %s\n"), path, strerror(errno));
+		goto error;
+	}
+
+	if(fstat(fd, buf) != 0) {
+		_alpm_log(handle, ALPM_LOG_ERROR,
+				_("could not stat file %s: %s\n"), path, strerror(errno));
+		goto error;
+	}
+#ifdef HAVE_STRUCT_STAT_ST_BLKSIZE
+	if(buf->st_blksize > ALPM_BUFFER_SIZE) {
+		bufsize = buf->st_blksize;
+	}
+#endif
+
+	if(archive_read_open_fd(*archive, fd, bufsize) != ARCHIVE_OK) {
+		_alpm_log(handle, ALPM_LOG_ERROR, _("could not open file %s: %s\n"),
+				path, archive_error_string(*archive));
+		goto error;
+	}
+
+	return fd;
+
+error:
+	archive_read_finish(*archive);
+	*archive = NULL;
+	if(fd >= 0) {
+		CLOSE(fd);
+	}
+	RET_ERR(handle, error, -1);
+}
+
+/** Unpack a specific file in an archive.
  * @param handle the context handle
  * @param archive the archive to unpack
  * @param prefix where to extract the files
@@ -258,46 +300,33 @@
 	return ret;
 }
 
-/**
- * @brief Unpack a list of files in an archive.
- *
+/** Unpack a list of files in an archive.
  * @param handle the context handle
- * @param archive the archive to unpack
+ * @param path the archive to unpack
  * @param prefix where to extract the files
  * @param list a list of files within the archive to unpack or NULL for all
  * @param breakfirst break after the first entry found
- *
  * @return 0 on success, 1 on failure
  */
-int _alpm_unpack(alpm_handle_t *handle, const char *archive, const char *prefix,
+int _alpm_unpack(alpm_handle_t *handle, const char *path, const char *prefix,
 		alpm_list_t *list, int breakfirst)
 {
 	int ret = 0;
 	mode_t oldmask;
-	struct archive *_archive;
+	struct archive *archive;
 	struct archive_entry *entry;
-	int cwdfd;
-
-	if((_archive = archive_read_new()) == NULL) {
-		RET_ERR(handle, ALPM_ERR_LIBARCHIVE, 1);
-	}
-
-	archive_read_support_compression_all(_archive);
-	archive_read_support_format_all(_archive);
+	struct stat buf;
+	int fd, cwdfd;
 
-	if(archive_read_open_filename(_archive, archive,
-				ALPM_BUFFER_SIZE) != ARCHIVE_OK) {
-		_alpm_log(handle, ALPM_LOG_ERROR, _("could not open file %s: %s\n"), archive,
-				archive_error_string(_archive));
-		RET_ERR(handle, ALPM_ERR_PKG_OPEN, 1);
+	fd = _alpm_open_archive(handle, path, &buf, &archive, ALPM_ERR_PKG_OPEN);
+	if(fd < 0) {
+		return 1;
 	}
 
 	oldmask = umask(0022);
 
 	/* save the cwd so we can restore it later */
-	do {
-		cwdfd = open(".", O_RDONLY);
-	} while(cwdfd == -1 && errno == EINTR);
+	OPEN(cwdfd, ".", O_RDONLY);
 	if(cwdfd < 0) {
 		_alpm_log(handle, ALPM_LOG_ERROR, _("could not get current working directory\n"));
 	}
@@ -310,19 +339,12 @@
 		goto cleanup;
 	}
 
-	while(archive_read_next_header(_archive, &entry) == ARCHIVE_OK) {
-		const struct stat *st;
-		const char *entryname; /* the name of the file in the archive */
+	while(archive_read_next_header(archive, &entry) == ARCHIVE_OK) {
+		const char *entryname;
+		mode_t mode;
 
-		st = archive_entry_stat(entry);
 		entryname = archive_entry_pathname(entry);
 
-		if(S_ISREG(st->st_mode)) {
-			archive_entry_set_perm(entry, 0644);
-		} else if(S_ISDIR(st->st_mode)) {
-			archive_entry_set_perm(entry, 0755);
-		}
-
 		/* If specific files were requested, skip entries that don't match. */
 		if(list) {
 			char *entry_prefix = strdup(entryname);
@@ -333,7 +355,7 @@
 			char *found = alpm_list_find_str(list, entry_prefix);
 			free(entry_prefix);
 			if(!found) {
-				if(archive_read_data_skip(_archive) != ARCHIVE_OK) {
+				if(archive_read_data_skip(archive) != ARCHIVE_OK) {
 					ret = 1;
 					goto cleanup;
 				}
@@ -343,15 +365,22 @@
 			}
 		}
 
+		mode = archive_entry_mode(entry);
+		if(S_ISREG(mode)) {
+			archive_entry_set_perm(entry, 0644);
+		} else if(S_ISDIR(mode)) {
+			archive_entry_set_perm(entry, 0755);
+		}
+
 		/* Extract the archive entry. */
-		int readret = archive_read_extract(_archive, entry, 0);
+		int readret = archive_read_extract(archive, entry, 0);
 		if(readret == ARCHIVE_WARN) {
 			/* operation succeeded but a non-critical error was encountered */
 			_alpm_log(handle, ALPM_LOG_WARNING, _("warning given when extracting %s (%s)\n"),
-					entryname, archive_error_string(_archive));
+					entryname, archive_error_string(archive));
 		} else if(readret != ARCHIVE_OK) {
 			_alpm_log(handle, ALPM_LOG_ERROR, _("could not extract %s (%s)\n"),
-					entryname, archive_error_string(_archive));
+					entryname, archive_error_string(archive));
 			ret = 1;
 			goto cleanup;
 		}
@@ -363,63 +392,20 @@
 
 cleanup:
 	umask(oldmask);
-	archive_read_finish(_archive);
+	archive_read_finish(archive);
+	CLOSE(fd);
 	if(cwdfd >= 0) {
 		if(fchdir(cwdfd) != 0) {
 			_alpm_log(handle, ALPM_LOG_ERROR,
 					_("could not restore working directory (%s)\n"), strerror(errno));
 		}
-		close(cwdfd);
+		CLOSE(cwdfd);
 	}
 
 	return ret;
 }
 
-/* does the same thing as 'rm -rf' */
-int _alpm_rmrf(const char *path)
-{
-	int errflag = 0;
-	struct dirent *dp;
-	DIR *dirp;
-	struct stat st;
-
-	if(_alpm_lstat(path, &st) == 0) {
-		if(!S_ISDIR(st.st_mode)) {
-			if(!unlink(path)) {
-				return 0;
-			} else {
-				if(errno == ENOENT) {
-					return 0;
-				} else {
-					return 1;
-				}
-			}
-		} else {
-			dirp = opendir(path);
-			if(!dirp) {
-				return 1;
-			}
-			for(dp = readdir(dirp); dp != NULL; dp = readdir(dirp)) {
-				if(dp->d_name) {
-					if(strcmp(dp->d_name, "..") != 0 && strcmp(dp->d_name, ".") != 0) {
-						char name[PATH_MAX];
-						sprintf(name, "%s/%s", path, dp->d_name);
-						errflag += _alpm_rmrf(name);
-					}
-				}
-			}
-			closedir(dirp);
-			if(rmdir(path)) {
-				errflag++;
-			}
-		}
-		return errflag;
-	}
-	return 0;
-}
-
-/**
- * Determine if there are files in a directory
+/** Determine if there are files in a directory.
  * @param handle the context handle
  * @param path the full absolute directory path
  * @param full_count whether to return an exact count of files
@@ -460,6 +446,13 @@
 	return files;
 }
 
+/** Write formatted message to log.
+ * @param handle the context handle
+ * @param format formatted string to write out
+ * @param args formatting arguments
+ * @return 0 or number of characters written on success, vfprintf return value
+ * on error
+ */
 int _alpm_logaction(alpm_handle_t *handle, const char *fmt, va_list args)
 {
 	int ret = 0;
@@ -491,16 +484,20 @@
 	return ret;
 }
 
-int _alpm_run_chroot(alpm_handle_t *handle, const char *path, char *const argv[])
+/** Execute a command with arguments in a chroot.
+ * @param handle the context handle
+ * @param cmd command to execute
+ * @param argv arguments to pass to cmd
+ * @return 0 on success, 1 on error
+ */
+int _alpm_run_chroot(alpm_handle_t *handle, const char *cmd, char *const argv[])
 {
 	pid_t pid;
 	int pipefd[2], cwdfd;
 	int retval = 0;
 
 	/* save the cwd so we can restore it later */
-	do {
-		cwdfd = open(".", O_RDONLY);
-	} while(cwdfd == -1 && errno == EINTR);
+	OPEN(cwdfd, ".", O_RDONLY);
 	if(cwdfd < 0) {
 		_alpm_log(handle, ALPM_LOG_ERROR, _("could not get current working directory\n"));
 	}
@@ -513,7 +510,7 @@
 	}
 
 	_alpm_log(handle, ALPM_LOG_DEBUG, "executing \"%s\" under chroot \"%s\"\n",
-			path, handle->root);
+			cmd, handle->root);
 
 	/* Flush open fds before fork() to avoid cloning buffers */
 	fflush(NULL);
@@ -534,12 +531,12 @@
 
 	if(pid == 0) {
 		/* this code runs for the child only (the actual chroot/exec) */
-		close(1);
-		close(2);
+		CLOSE(1);
+		CLOSE(2);
 		while(dup2(pipefd[1], 1) == -1 && errno == EINTR);
 		while(dup2(pipefd[1], 2) == -1 && errno == EINTR);
-		close(pipefd[0]);
-		close(pipefd[1]);
+		CLOSE(pipefd[0]);
+		CLOSE(pipefd[1]);
 
 		/* use fprintf instead of _alpm_log to send output through the parent */
 		if(chroot(handle->root) != 0) {
@@ -552,7 +549,8 @@
 			exit(1);
 		}
 		umask(0022);
-		execv(path, argv);
+		execv(cmd, argv);
+		/* execv only returns if there was an error */
 		fprintf(stderr, _("call to execv failed (%s)\n"), strerror(errno));
 		exit(1);
 	} else {
@@ -560,10 +558,10 @@
 		int status;
 		FILE *pipe_file;
 
-		close(pipefd[1]);
+		CLOSE(pipefd[1]);
 		pipe_file = fdopen(pipefd[0], "r");
 		if(pipe_file == NULL) {
-			close(pipefd[0]);
+			CLOSE(pipefd[0]);
 			retval = 1;
 		} else {
 			while(!feof(pipe_file)) {
@@ -605,12 +603,16 @@
 			_alpm_log(handle, ALPM_LOG_ERROR,
 					_("could not restore working directory (%s)\n"), strerror(errno));
 		}
-		close(cwdfd);
+		CLOSE(cwdfd);
 	}
 
 	return retval;
 }
 
+/** Run ldconfig in a chroot.
+ * @param handle the context handle
+ * @return 0 on success, 1 on error
+ */
 int _alpm_ldconfig(alpm_handle_t *handle)
 {
 	char line[PATH_MAX];
@@ -621,7 +623,9 @@
 	if(access(line, F_OK) == 0) {
 		snprintf(line, PATH_MAX, "%ssbin/ldconfig", handle->root);
 		if(access(line, X_OK) == 0) {
-			char *argv[] = { "ldconfig", NULL };
+			char arg0[32];
+			char *argv[] = { arg0, NULL };
+			strcpy(arg0, "ldconfig");
 			return _alpm_run_chroot(handle, "/sbin/ldconfig", argv);
 		}
 	}
@@ -629,8 +633,13 @@
 	return 0;
 }
 
-/* Helper function for comparing strings using the
- * alpm "compare func" signature */
+/** Helper function for comparing strings using the alpm "compare func"
+ * signature.
+ * @param s1 first string to be compared
+ * @param s2 second string to be compared
+ * @return 0 if strings are equal, positive int if first unequal character
+ * has a greater value in s1, negative if it has a greater value in s2
+ */
 int _alpm_str_cmp(const void *s1, const void *s2)
 {
 	return strcmp(s1, s2);
@@ -671,7 +680,8 @@
 {
 	struct stat buf;
 	alpm_list_t *i;
-	char *cachedir, *tmpdir;
+	char *cachedir;
+	const char *tmpdir;
 
 	/* Loop through the cache dirs until we find a usable directory */
 	for(i = handle->cachedirs; i; i = i->next) {
@@ -687,7 +697,7 @@
 		} else if(!S_ISDIR(buf.st_mode)) {
 			_alpm_log(handle, ALPM_LOG_DEBUG,
 					"skipping cachedir, not a directory: %s\n", cachedir);
-		} else if(access(cachedir, W_OK) != 0) {
+		} else if(_alpm_access(handle, NULL, cachedir, W_OK) != 0) {
 			_alpm_log(handle, ALPM_LOG_DEBUG,
 					"skipping cachedir, not writable: %s\n", cachedir);
 		} else if(!(buf.st_mode & (S_IWUSR | S_IWGRP | S_IWOTH))) {
@@ -739,51 +749,64 @@
 }
 
 #ifdef HAVE_LIBSSL
+/** Compute the MD5 message digest of a file.
+ * @param path file path of file to compute  MD5 digest of
+ * @param output string to hold computed MD5 digest
+ * @return 0 on success, 1 on file open error, 2 on file read error
+ */
 static int md5_file(const char *path, unsigned char output[16])
 {
-	FILE *f;
-	size_t n;
 	MD5_CTX ctx;
 	unsigned char *buf;
+	ssize_t n;
+	int fd;
 
-	CALLOC(buf, ALPM_BUFFER_SIZE, sizeof(unsigned char), return 1);
+	MALLOC(buf, (size_t)ALPM_BUFFER_SIZE, return 1);
 
-	if((f = fopen(path, "rb")) == NULL) {
+	OPEN(fd, path, O_RDONLY);
+	if(fd < 0) {
 		free(buf);
 		return 1;
 	}
 
 	MD5_Init(&ctx);
 
-	while((n = fread(buf, 1, ALPM_BUFFER_SIZE, f)) > 0) {
+	while((n = read(fd, buf, ALPM_BUFFER_SIZE)) > 0 || errno == EINTR) {
+		if(n < 0) {
+			continue;
+		}
 		MD5_Update(&ctx, buf, n);
 	}
 
-	MD5_Final(output, &ctx);
-
-	memset(&ctx, 0, sizeof(MD5_CTX));
+	CLOSE(fd);
 	free(buf);
 
-	if(ferror(f) != 0) {
-		fclose(f);
+	if(n < 0) {
 		return 2;
 	}
 
-	fclose(f);
+	MD5_Final(output, &ctx);
 	return 0;
 }
 
 /* third param is so we match the PolarSSL definition */
+/** Compute the SHA-224 or SHA-256 message digest of a file.
+ * @param path file path of file to compute SHA2 digest of
+ * @param output string to hold computed SHA2 digest
+ * @param is224 use SHA-224 instead of SHA-256
+ * @return 0 on success, 1 on file open error, 2 on file read error
+ */
 static int sha2_file(const char *path, unsigned char output[32], int is224)
 {
-	FILE *f;
-	size_t n;
 	SHA256_CTX ctx;
 	unsigned char *buf;
+	ssize_t n;
+	int fd;
 
-	CALLOC(buf, ALPM_BUFFER_SIZE, sizeof(unsigned char), return 1);
+	MALLOC(buf, (size_t)ALPM_BUFFER_SIZE, return 1);
 
-	if((f = fopen(path, "rb")) == NULL) {
+	OPEN(fd, path, O_RDONLY);
+	if(fd < 0) {
 		free(buf);
 		return 1;
 	}
@@ -794,7 +817,10 @@
 		SHA256_Init(&ctx);
 	}
 
-	while((n = fread(buf, 1, ALPM_BUFFER_SIZE, f)) > 0) {
+	while((n = read(fd, buf, ALPM_BUFFER_SIZE)) > 0 || errno == EINTR) {
+		if(n < 0) {
+			continue;
+		}
 		if(is224) {
 			SHA224_Update(&ctx, buf, n);
 		} else {
@@ -802,24 +828,45 @@
 		}
 	}
 
+	CLOSE(fd);
+	free(buf);
+
+	if(n < 0) {
+		return 2;
+	}
+
 	if(is224) {
 		SHA224_Final(output, &ctx);
 	} else {
 		SHA256_Final(output, &ctx);
 	}
+	return 0;
+}
+#endif
 
-	memset(&ctx, 0, sizeof(SHA256_CTX));
-	free(buf);
+/** Create a string representing bytes in hexadecimal.
+ * @param bytes the bytes to represent in hexadecimal
+ * @param size number of bytes to consider
+ * @return a NULL terminated string with the hexadecimal representation of
+ * bytes or NULL on error. This string must be freed.
+ */
+static char *hex_representation(unsigned char *bytes, size_t size)
+{
+	static const char *hex_digits = "0123456789abcdef";
+	char *str;
+	size_t i;
 
-	if(ferror(f) != 0) {
-		fclose(f);
-		return 2;
+	MALLOC(str, 2 * size + 1, return NULL);
+
+	for (i = 0; i < size; i++) {
+		str[2 * i] = hex_digits[bytes[i] >> 4];
+		str[2 * i + 1] = hex_digits[bytes[i] & 0x0f];
 	}
 
-	fclose(f);
-	return 0;
+	str[2 * size] = '\0';
+
+	return str;
 }
-#endif
 
 /** Get the md5 sum of file.
  * @param filename name of the file
@@ -829,28 +876,15 @@
 char SYMEXPORT *alpm_compute_md5sum(const char *filename)
 {
 	unsigned char output[16];
-	char *md5sum;
-	int ret, i;
 
 	ASSERT(filename != NULL, return NULL);
 
-	/* allocate 32 chars plus 1 for null */
-	CALLOC(md5sum, 33, sizeof(char), return NULL);
 	/* defined above for OpenSSL, otherwise defined in md5.h */
-	ret = md5_file(filename, output);
-
-	if(ret > 0) {
-		free(md5sum);
+	if(md5_file(filename, output) > 0) {
 		return NULL;
 	}
 
-	/* Convert the result to something readable */
-	for (i = 0; i < 16; i++) {
-		/* sprintf is acceptable here because we know our output */
-		sprintf(md5sum +(i * 2), "%02x", output[i]);
-	}
-
-	return md5sum;
+	return hex_representation(output, 16);
 }
 
 /** Get the sha256 sum of file.
@@ -861,39 +895,33 @@
 char SYMEXPORT *alpm_compute_sha256sum(const char *filename)
 {
 	unsigned char output[32];
-	char *sha256sum;
-	int ret, i;
 
 	ASSERT(filename != NULL, return NULL);
 
-	/* allocate 64 chars plus 1 for null */
-	CALLOC(sha256sum, 65, sizeof(char), return NULL);
 	/* defined above for OpenSSL, otherwise defined in sha2.h */
-	ret = sha2_file(filename, output, 0);
-
-	if(ret > 0) {
-		free(sha256sum);
+	if(sha2_file(filename, output, 0) > 0) {
 		return NULL;
 	}
 
-	/* Convert the result to something readable */
-	for (i = 0; i < 32; i++) {
-		/* sprintf is acceptable here because we know our output */
-		sprintf(sha256sum +(i * 2), "%02x", output[i]);
-	}
-
-	return sha256sum;
+	return hex_representation(output, 32);
 }
 
+/** Calculates a file's MD5 or SHA2 digest  and compares it to an expected value. 
+ * @param filepath path of the file to check
+ * @param expected hash value to compare against
+ * @param type digest type to use
+ * @return 0 if file matches the expected hash, 1 if they do not match, -1 on
+ * error
+ */
 int _alpm_test_checksum(const char *filepath, const char *expected,
-		enum _alpm_csum type)
+		alpm_pkgvalidation_t type)
 {
 	char *computed;
 	int ret;
 
-	if(type == ALPM_CSUM_MD5) {
+	if(type == ALPM_PKG_VALIDATION_MD5SUM) {
 		computed = alpm_compute_md5sum(filepath);
-	} else if(type == ALPM_CSUM_SHA256) {
+	} else if(type == ALPM_PKG_VALIDATION_SHA256SUM) {
 		computed = alpm_compute_sha256sum(filepath);
 	} else {
 		return -1;
@@ -912,18 +940,24 @@
 }
 
 /* Note: does NOT handle sparse files on purpose for speed. */
+/** TODO.
+ * Does not handle sparse files on purpose for speed.
+ * @param a
+ * @param b
+ * @return 
+ */
 int _alpm_archive_fgets(struct archive *a, struct archive_read_buffer *b)
 {
-	char *i = NULL;
-	int64_t offset;
-	int done = 0;
-
 	/* ensure we start populating our line buffer at the beginning */
 	b->line_offset = b->line;
 
 	while(1) {
+		size_t block_remaining;
+		char *eol;
+
 		/* have we processed this entire block? */
 		if(b->block + b->block_size == b->block_offset) {
+			int64_t offset;
 			if(b->ret == ARCHIVE_EOF) {
 				/* reached end of archive on the last read, now we are out of data */
 				goto cleanup;
@@ -933,20 +967,20 @@
 			b->ret = archive_read_data_block(a, (void *)&b->block,
 					&b->block_size, &offset);
 			b->block_offset = b->block;
+			block_remaining = b->block_size;
 
 			/* error, cleanup */
 			if(b->ret < ARCHIVE_OK) {
 				goto cleanup;
 			}
+		} else {
+			block_remaining = b->block + b->block_size - b->block_offset;
 		}
 
-		/* loop through the block looking for EOL characters */
-		for(i = b->block_offset; i < (b->block + b->block_size); i++) {
-			/* check if read value was null or newline */
-			if(*i == '\0' || *i == '\n') {
-				done = 1;
-				break;
-			}
+		/* look through the block looking for EOL characters */
+		eol = memchr(b->block_offset, '\n', block_remaining);
+		if(!eol) {
+			eol = memchr(b->block_offset, '\0', block_remaining);
 		}
 
 		/* allocate our buffer, or ensure our existing one is big enough */
@@ -956,29 +990,32 @@
 			b->line_size = b->block_size + 1;
 			b->line_offset = b->line;
 		} else {
-			size_t needed = (size_t)((b->line_offset - b->line)
-					+ (i - b->block_offset) + 1);
+			/* note: we know eol > b->block_offset and b->line_offset > b->line,
+			 * so we know the result is unsigned and can fit in size_t */
+			size_t new = eol ? (size_t)(eol - b->block_offset) : block_remaining;
+			size_t needed = (size_t)((b->line_offset - b->line) + new + 1);
 			if(needed > b->max_line_size) {
 				b->ret = -ERANGE;
 				goto cleanup;
 			}
 			if(needed > b->line_size) {
 				/* need to realloc + copy data to fit total length */
-				char *new;
-				CALLOC(new, needed, sizeof(char), b->ret = -ENOMEM; goto cleanup);
-				memcpy(new, b->line, b->line_size);
+				char *new_line;
+				CALLOC(new_line, needed, sizeof(char), b->ret = -ENOMEM; goto cleanup);
+				memcpy(new_line, b->line, b->line_size);
 				b->line_size = needed;
-				b->line_offset = new + (b->line_offset - b->line);
+				b->line_offset = new_line + (b->line_offset - b->line);
 				free(b->line);
-				b->line = new;
+				b->line = new_line;
 			}
 		}
 
-		if(done) {
-			size_t len = (size_t)(i - b->block_offset);
+		if(eol) {
+			size_t len = (size_t)(eol - b->block_offset);
 			memcpy(b->line_offset, b->block_offset, len);
 			b->line_offset[len] = '\0';
-			b->block_offset = ++i;
+			b->block_offset = eol + 1;
+			b->real_line_size = b->line_offset + len - b->line;
 			/* this is the main return point; from here you can read b->line */
 			return ARCHIVE_OK;
 		} else {
@@ -986,11 +1023,12 @@
 			size_t len = (size_t)(b->block + b->block_size - b->block_offset);
 			memcpy(b->line_offset, b->block_offset, len);
 			b->line_offset += len;
-			b->block_offset = i;
+			b->block_offset = b->block + b->block_size;
 			/* there was no new data, return what is left; saved ARCHIVE_EOF will be
 			 * returned on next call */
 			if(len == 0) {
 				b->line_offset[0] = '\0';
+				b->real_line_size = b->line_offset - b->line;
 				return ARCHIVE_OK;
 			}
 		}
@@ -1005,6 +1043,14 @@
 	}
 }
 
+/** Parse a full package specifier.
+ * @param target package specifier to parse, such as: "pacman-4.0.1-2",
+ * "pacman-4.01-2/", or "pacman-4.0.1-2/desc"
+ * @param name to hold package name
+ * @param version to hold package version
+ * @param name_hash to hold package name hash
+ * @return 0 on success, -1 on error
+ */
 int _alpm_splitname(const char *target, char **name, char **version,
 		unsigned long *name_hash)
 {
@@ -1057,8 +1103,7 @@
 	return 0;
 }
 
-/**
- * Hash the given string to an unsigned long value.
+/** Hash the given string to an unsigned long value.
  * This is the standard sdbm hashing algorithm.
  * @param str string to hash
  * @return the hash value of the given string
@@ -1072,12 +1117,17 @@
 		return hash;
 	}
 	while((c = *str++)) {
-		hash = c + (hash << 6) + (hash << 16) - hash;
+		hash = c + hash * 65599;
 	}
 
 	return hash;
 }
 
+/** Convert a string to a file offset.
+ * This parses bare positive integers only.
+ * @param line string to convert
+ * @return off_t on success, -1 on error
+ */
 off_t _alpm_strtoofft(const char *line)
 {
 	char *end;
@@ -1089,13 +1139,13 @@
 		return (off_t)-1;
 	}
 	result = strtoull(line, &end, 10);
-	if (result == 0 && end == line) {
+	if(result == 0 && end == line) {
 		/* line was not a number */
 		return (off_t)-1;
-	} else if (result == ULLONG_MAX && errno == ERANGE) {
+	} else if(result == ULLONG_MAX && errno == ERANGE) {
 		/* line does not fit in unsigned long long */
 		return (off_t)-1;
-	} else if (*end) {
+	} else if(*end) {
 		/* line began with a number but has junk left over at the end */
 		return (off_t)-1;
 	}
@@ -1103,8 +1153,16 @@
 	return (off_t)result;
 }
 
-time_t _alpm_parsedate(const char *line)
+/** Parses a date into an alpm_time_t struct.
+ * @param line date to parse
+ * @return time struct on success, 0 on error
+ */
+alpm_time_t _alpm_parsedate(const char *line)
 {
+	char *end;
+	long long result;
+	errno = 0;
+
 	if(isalpha((unsigned char)line[0])) {
 		/* initialize to null in case of failure */
 		struct tm tmp_tm;
@@ -1112,13 +1170,27 @@
 		setlocale(LC_TIME, "C");
 		strptime(line, "%a %b %e %H:%M:%S %Y", &tmp_tm);
 		setlocale(LC_TIME, "");
-		return mktime(&tmp_tm);
+		return (alpm_time_t)mktime(&tmp_tm);
+	}
+
+	result = strtoll(line, &end, 10);
+	if(result == 0 && end == line) {
+		/* line was not a number */
+		errno = EINVAL;
+		return 0;
+	} else if(errno == ERANGE) {
+		/* line does not fit in long long */
+		return 0;
+	} else if(*end) {
+		/* line began with a number but has junk left over at the end */
+		errno = EINVAL;
+		return 0;
 	}
-	return (time_t)atol(line);
+
+	return (alpm_time_t)result;
 }
 
-/**
- * Wrapper around access() which takes a dir and file argument
+/** Wrapper around access() which takes a dir and file argument
  * separately and generates an appropriate error message.
  * If dir is NULL file will be treated as the whole path.
  * @param handle an alpm handle
@@ -1127,13 +1199,12 @@
  * @param amode access mode as described in access()
  * @return int value returned by access()
  */
-
 int _alpm_access(alpm_handle_t *handle, const char *dir, const char *file, int amode)
 {
 	size_t len = 0;
 	int ret = 0;
 
-	if (dir) {
+	if(dir) {
 		char *check_path;
 
 		len = strlen(dir) + strlen(file) + 1;
@@ -1148,19 +1219,19 @@
 	}
 
 	if(ret != 0) {
-		if (amode & R_OK) {
+		if(amode & R_OK) {
 			_alpm_log(handle, ALPM_LOG_DEBUG, "\"%s%s\" is not readable: %s\n",
 					dir, file, strerror(errno));
 		}
-		if (amode & W_OK) {
+		if(amode & W_OK) {
 			_alpm_log(handle, ALPM_LOG_DEBUG, "\"%s%s\" is not writable: %s\n",
 					dir, file, strerror(errno));
 		}
-		if (amode & X_OK) {
+		if(amode & X_OK) {
 			_alpm_log(handle, ALPM_LOG_DEBUG, "\"%s%s\" is not executable: %s\n",
 					dir, file, strerror(errno));
 		}
-		if (amode == F_OK) {
+		if(amode == F_OK) {
 			_alpm_log(handle, ALPM_LOG_DEBUG, "\"%s%s\" does not exist: %s\n",
 					dir, file, strerror(errno));
 		}
@@ -1168,8 +1239,30 @@
 	return ret;
 }
 
+/** Checks whether a string matches a shell wildcard pattern.
+ * Wrapper around fnmatch.
+ * @param pattern pattern to match aganist
+ * @param string string to check against pattern
+ * @return 0 if string matches pattern, non-zero if they don't match and on
+ * error
+ */
+int _alpm_fnmatch(const void *pattern, const void *string)
+{
+	return fnmatch(pattern, string, 0);
+}
+
+void _alpm_alloc_fail(size_t size)
+{
+	fprintf(stderr, "alloc failure: could not allocate %zd bytes\n", size);
+}
+
 #ifndef HAVE_STRNDUP
 /* A quick and dirty implementation derived from glibc */
+/** Determines the length of a fixed-size string.
+ * @param s string to be measured
+ * @param max maximum number of characters to search for the string end
+ * @return length of s or max, whichever is smaller
+ */
 static size_t strnlen(const char *s, size_t max)
 {
     register const char *p;
@@ -1177,6 +1270,12 @@
     return (p - s);
 }
 
+/** Copies a string.
+ * Returned string needs to be freed
+ * @param s string to be copied
+ * @param n maximum number of characters to copy
+ * @return pointer to the new string on success, NULL on error
+ */
 char *strndup(const char *s, size_t n)
 {
   size_t len = strnlen(s, n);
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/util.h pacman/lib/libalpm/util.h
--- pacman-4.0.3/lib/libalpm/util.h	2011-10-27 19:47:53.000000000 +0000
+++ pacman/lib/libalpm/util.h	2012-10-15 18:11:52.509417419 +0000
@@ -1,7 +1,7 @@
 /*
  *  util.h
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *  Copyright (c) 2005 by Aurelien Foret <orelien@chez.com>
  *  Copyright (c) 2005 by Christian Hamar <krics@linuxforum.hu>
@@ -24,8 +24,6 @@
 #ifndef _ALPM_UTIL_H
 #define _ALPM_UTIL_H
 
-#include "config.h"
-
 #include "alpm_list.h"
 #include "alpm.h"
 #include "package.h" /* alpm_pkg_t */
@@ -35,11 +33,13 @@
 #include <string.h>
 #include <stdarg.h>
 #include <stddef.h> /* size_t */
-#include <time.h>
+#include <sys/types.h>
 #include <sys/stat.h> /* struct stat */
-#include <archive.h> /* struct archive */
 #include <math.h> /* fabs */
 #include <float.h> /* DBL_EPSILON */
+#include <fcntl.h> /* open, close */
+
+#include <archive.h> /* struct archive */
 
 #ifdef ENABLE_NLS
 #include <libintl.h> /* here so it doesn't need to be included elsewhere */
@@ -49,13 +49,13 @@
 #define _(s) s
 #endif
 
-#define ALLOC_FAIL(s) do { fprintf(stderr, "alloc failure: could not allocate %zd bytes\n", s); } while(0)
+void _alpm_alloc_fail(size_t size);
 
-#define MALLOC(p, s, action) do { p = calloc(1, s); if(p == NULL) { ALLOC_FAIL(s); action; } } while(0)
-#define CALLOC(p, l, s, action) do { p = calloc(l, s); if(p == NULL) { ALLOC_FAIL(s); action; } } while(0)
+#define MALLOC(p, s, action) do { p = malloc(s); if(p == NULL) { _alpm_alloc_fail(s); action; } } while(0)
+#define CALLOC(p, l, s, action) do { p = calloc(l, s); if(p == NULL) { _alpm_alloc_fail(l * s); action; } } while(0)
 /* This strdup macro is NULL safe- copying NULL will yield NULL */
-#define STRDUP(r, s, action) do { if(s != NULL) { r = strdup(s); if(r == NULL) { ALLOC_FAIL(strlen(s)); action; } } else { r = NULL; } } while(0)
-#define STRNDUP(r, s, l, action) do { if(s != NULL) { r = strndup(s, l); if(r == NULL) { ALLOC_FAIL(strlen(s)); action; } } else { r = NULL; } } while(0)
+#define STRDUP(r, s, action) do { if(s != NULL) { r = strdup(s); if(r == NULL) { _alpm_alloc_fail(strlen(s)); action; } } else { r = NULL; } } while(0)
+#define STRNDUP(r, s, l, action) do { if(s != NULL) { r = strndup(s, l); if(r == NULL) { _alpm_alloc_fail(l); action; } } else { r = NULL; } } while(0)
 
 #define FREE(p) do { free(p); p = NULL; } while(0)
 
@@ -82,6 +82,13 @@
 #define ALPM_BUFFER_SIZE 8192
 #endif
 
+#ifndef O_BINARY
+#define O_BINARY 0
+#endif
+
+#define OPEN(fd, path, flags) do { fd = open(path, flags | O_BINARY); } while(fd == -1 && errno == EINTR)
+#define CLOSE(fd) do { int _ret; do { _ret = close(fd); } while(_ret == -1 && errno == EINTR); } while(0)
+
 /**
  * Used as a buffer/state holder for _alpm_archive_fgets().
  */
@@ -90,6 +97,7 @@
 	char *line_offset;
 	size_t line_size;
 	size_t max_line_size;
+	size_t real_line_size;
 
 	char *block;
 	char *block_offset;
@@ -98,39 +106,37 @@
 	int ret;
 };
 
-enum _alpm_csum {
-	ALPM_CSUM_MD5,
-	ALPM_CSUM_SHA256,
-};
-
 int _alpm_makepath(const char *path);
 int _alpm_makepath_mode(const char *path, mode_t mode);
 int _alpm_copyfile(const char *src, const char *dest);
-char *_alpm_strtrim(char *str);
-size_t _alpm_strip_newline(char *str);
+size_t _alpm_strip_newline(char *str, size_t len);
+
+int _alpm_open_archive(alpm_handle_t *handle, const char *path,
+		struct stat *buf, struct archive **archive, alpm_errno_t error);
 int _alpm_unpack_single(alpm_handle_t *handle, const char *archive,
 		const char *prefix, const char *filename);
 int _alpm_unpack(alpm_handle_t *handle, const char *archive, const char *prefix,
 		alpm_list_t *list, int breakfirst);
-int _alpm_rmrf(const char *path);
+
 ssize_t _alpm_files_in_directory(alpm_handle_t *handle, const char *path, int full_count);
 int _alpm_logaction(alpm_handle_t *handle, const char *fmt, va_list args);
-int _alpm_run_chroot(alpm_handle_t *handle, const char *path, char *const argv[]);
+int _alpm_run_chroot(alpm_handle_t *handle, const char *cmd, char *const argv[]);
 int _alpm_ldconfig(alpm_handle_t *handle);
 int _alpm_str_cmp(const void *s1, const void *s2);
 char *_alpm_filecache_find(alpm_handle_t *handle, const char *filename);
 const char *_alpm_filecache_setup(alpm_handle_t *handle);
 int _alpm_lstat(const char *path, struct stat *buf);
-int _alpm_test_checksum(const char *filepath, const char *expected, enum _alpm_csum type);
+int _alpm_test_checksum(const char *filepath, const char *expected, alpm_pkgvalidation_t type);
 int _alpm_archive_fgets(struct archive *a, struct archive_read_buffer *b);
 int _alpm_splitname(const char *target, char **name, char **version,
 		unsigned long *name_hash);
 unsigned long _alpm_hash_sdbm(const char *str);
 off_t _alpm_strtoofft(const char *line);
-time_t _alpm_parsedate(const char *line);
+alpm_time_t _alpm_parsedate(const char *line);
 int _alpm_raw_cmp(const char *first, const char *second);
 int _alpm_raw_ncmp(const char *first, const char *second, size_t max);
 int _alpm_access(alpm_handle_t *handle, const char *dir, const char *file, int amode);
+int _alpm_fnmatch(const void *pattern, const void *string);
 
 #ifndef HAVE_STRSEP
 char *strsep(char **, const char *);
diff -x '.*' -aur pacman-4.0.3/lib/libalpm/version.c pacman/lib/libalpm/version.c
--- pacman-4.0.3/lib/libalpm/version.c	2011-10-12 19:04:25.000000000 +0000
+++ pacman/lib/libalpm/version.c	2012-10-15 18:11:52.509417419 +0000
@@ -1,5 +1,5 @@
 /*
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -15,8 +15,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <string.h>
 #include <ctype.h>
 
Only in pacman-4.0.3: ltmain.sh
Only in pacman/m4: acinclude.m4
Only in pacman/m4: gpgme.m4
Only in pacman-4.0.3/m4: libcurl.m4
Only in pacman/m4: pkg.m4
Only in pacman-4.0.3: missing
Only in pacman-4.0.3: mkinstalldirs
diff -x '.*' -aur pacman-4.0.3/proto/PKGBUILD-split.proto pacman/proto/PKGBUILD-split.proto
--- pacman-4.0.3/proto/PKGBUILD-split.proto	2011-10-12 19:04:25.000000000 +0000
+++ pacman/proto/PKGBUILD-split.proto	2012-10-15 18:11:52.513287879 +0000
@@ -46,6 +46,7 @@
   epoch=
   pkgdesc=""
   arch=()
+  url=""
   license=()
   groups=()
   depends=()
diff -x '.*' -aur pacman-4.0.3/scripts/Makefile.am pacman/scripts/Makefile.am
--- pacman-4.0.3/scripts/Makefile.am	2011-10-12 19:04:25.000000000 +0000
+++ pacman/scripts/Makefile.am	2012-10-15 18:11:52.513287879 +0000
@@ -4,7 +4,9 @@
 SUBDIRS = po
 
 bin_SCRIPTS = \
-	$(OURSCRIPTS)
+	$(OURSCRIPTS) \
+	repo-remove \
+	repo-elephant
 
 OURSCRIPTS = \
 	makepkg \
@@ -12,7 +14,6 @@
 	pacman-key \
 	pacman-optimize \
 	pkgdelta \
-	rankmirrors \
 	repo-add
 
 EXTRA_DIST = \
@@ -21,13 +22,14 @@
 	pacman-key.sh.in \
 	pacman-optimize.sh.in \
 	pkgdelta.sh.in \
-	rankmirrors.sh.in \
 	repo-add.sh.in \
 	$(LIBRARY)
 
 LIBRARY = \
 	library/output_format.sh \
-	library/parse_options.sh
+	library/parseopts.sh \
+	library/human_to_size.sh \
+	library/size_to_human.sh
 
 # Files that should be removed, but which Automake does not know.
 MOSTLYCLEANFILES = $(bin_SCRIPTS)
@@ -51,6 +53,7 @@
 	-e 's|@PACKAGE_BUGREPORT[@]|$(PACKAGE_BUGREPORT)|g' \
 	-e 's|@PACKAGE_NAME[@]|$(PACKAGE_NAME)|g' \
 	-e 's|@BUILDSCRIPT[@]|$(BUILDSCRIPT)|g' \
+	-e "s|@INODECMD[@]|$(INODECMD)|g" \
 	-e 's|@SIZECMD[@]|$(SIZECMD)|g' \
 	-e 's|@SEDINPLACE[@]|$(SEDINPLACE)|g' \
 	-e 's|@DUPATH[@]|$(DUPATH)|g' \
@@ -60,18 +63,15 @@
 ## All the scripts depend on Makefile so that they are rebuilt when the
 ## prefix etc. changes. Use chmod -w to prevent people from editing the
 ## wrong file by accident.
-# two 'test' lines- make sure we can handle both sh and py type scripts
-# third 'test' line- make sure one of the two checks succeeded
 $(OURSCRIPTS): Makefile
-	@echo '    ' GEN $@;
-	@$(RM) $@
-	@test -f $(srcdir)/$@.sh.in && m4 -P -I $(srcdir) $(srcdir)/$@.sh.in | $(edit) >$@
-	@chmod +x $@
-	@chmod a-w $@
+	$(AM_V_at)$(RM) $@
+	$(AM_V_GEN)test -f $(srcdir)/$@.sh.in && m4 -P -I $(srcdir) $(srcdir)/$@.sh.in | $(edit) >$@
+	$(AM_V_at)chmod +x,a-w $@
+	@$(BASH_SHELL) -O extglob -n $@
 
 makepkg: \
 	$(srcdir)/makepkg.sh.in \
-	$(srcdir)/library/parse_options.sh
+	$(srcdir)/library/parseopts.sh
 
 pacman-db-upgrade: \
 	$(srcdir)/pacman-db-upgrade.sh.in \
@@ -80,7 +80,7 @@
 pacman-key: \
 	$(srcdir)/pacman-key.sh.in \
 	$(srcdir)/library/output_format.sh \
-	$(srcdir)/library/parse_options.sh
+	$(srcdir)/library/parseopts.sh
 
 pacman-optimize: \
 	$(srcdir)/pacman-optimize.sh.in \
@@ -88,21 +88,20 @@
 
 pkgdelta: \
 	$(srcdir)/pkgdelta.sh.in \
-	$(srcdir)/library/output_format.sh
-
-rankmirrors: $(srcdir)/rankmirrors.sh.in
+	$(srcdir)/library/output_format.sh \
+	$(srcdir)/library/parseopts.sh
 
 repo-add: \
 	$(srcdir)/repo-add.sh.in \
 	$(srcdir)/library/output_format.sh
 
 repo-remove: $(srcdir)/repo-add.sh.in
-	$(RM) repo-remove
-	$(LN_S) repo-add repo-remove
+	$(AM_V_at)$(RM) repo-remove
+	$(AM_V_at)$(LN_S) repo-add repo-remove
 
 repo-elephant: $(srcdir)/repo-add.sh.in
-	$(RM) repo-elephant
-	$(LN_S) repo-add repo-elephant
+	$(AM_V_at)$(RM) repo-elephant
+	$(AM_V_at)$(LN_S) repo-add repo-elephant
 
 install-data-hook:
 	cd $(DESTDIR)$(bindir) && \
diff -x '.*' -aur pacman-4.0.3/scripts/Makefile.in pacman/scripts/Makefile.in
--- pacman-4.0.3/scripts/Makefile.in	2012-04-07 15:58:14.000000000 +0000
+++ pacman/scripts/Makefile.in	2012-10-15 18:12:23.025546850 +0000
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.11.4 from Makefile.am.
+# Makefile.in generated by automake 1.12 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -52,20 +52,22 @@
 build_triplet = @build@
 host_triplet = @host@
 subdir = scripts
-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in \
+	$(top_srcdir)/build-aux/mkinstalldirs
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/m4/gettext.m4 \
+am__aclocal_m4_deps = $(top_srcdir)/m4/acinclude.m4 \
+	$(top_srcdir)/m4/gettext.m4 $(top_srcdir)/m4/gpgme.m4 \
 	$(top_srcdir)/m4/iconv.m4 $(top_srcdir)/m4/intlmacosx.m4 \
 	$(top_srcdir)/m4/lib-ld.m4 $(top_srcdir)/m4/lib-link.m4 \
-	$(top_srcdir)/m4/lib-prefix.m4 $(top_srcdir)/m4/libcurl.m4 \
-	$(top_srcdir)/m4/libtool.m4 $(top_srcdir)/m4/ltoptions.m4 \
-	$(top_srcdir)/m4/ltsugar.m4 $(top_srcdir)/m4/ltversion.m4 \
-	$(top_srcdir)/m4/lt~obsolete.m4 $(top_srcdir)/m4/nls.m4 \
+	$(top_srcdir)/m4/lib-prefix.m4 $(top_srcdir)/m4/libtool.m4 \
+	$(top_srcdir)/m4/ltoptions.m4 $(top_srcdir)/m4/ltsugar.m4 \
+	$(top_srcdir)/m4/ltversion.m4 $(top_srcdir)/m4/lt~obsolete.m4 \
+	$(top_srcdir)/m4/nls.m4 $(top_srcdir)/m4/pkg.m4 \
 	$(top_srcdir)/m4/po.m4 $(top_srcdir)/m4/progtest.m4 \
-	$(top_srcdir)/acinclude.m4 $(top_srcdir)/configure.ac
+	$(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
-mkinstalldirs = $(SHELL) $(top_srcdir)/mkinstalldirs
+mkinstalldirs = $(SHELL) $(top_srcdir)/build-aux/mkinstalldirs
 CONFIG_HEADER = $(top_builddir)/config.h
 CONFIG_CLEAN_FILES =
 CONFIG_CLEAN_VPATH_FILES =
@@ -98,6 +100,12 @@
   }
 am__installdirs = "$(DESTDIR)$(bindir)"
 SCRIPTS = $(bin_SCRIPTS)
+AM_V_GEN = $(am__v_GEN_@AM_V@)
+am__v_GEN_ = $(am__v_GEN_@AM_DEFAULT_V@)
+am__v_GEN_0 = @echo "  GEN     " $@;
+AM_V_at = $(am__v_at_@AM_V@)
+am__v_at_ = $(am__v_at_@AM_DEFAULT_V@)
+am__v_at_0 = @
 SOURCES =
 DIST_SOURCES =
 RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
@@ -148,6 +156,7 @@
   reldir="$$dir2"
 ACLOCAL = @ACLOCAL@
 AMTAR = @AMTAR@
+AM_DEFAULT_VERBOSITY = @AM_DEFAULT_VERBOSITY@
 AR = @AR@
 ASCIIDOC = @ASCIIDOC@
 AUTOCONF = @AUTOCONF@
@@ -163,10 +172,6 @@
 CHOST = @CHOST@
 CPP = @CPP@
 CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXCPP = @CXXCPP@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
 CYGPATH_W = @CYGPATH_W@
 DEFS = @DEFS@
 DEPDIR = @DEPDIR@
@@ -185,7 +190,11 @@
 GIT = @GIT@
 GMSGFMT = @GMSGFMT@
 GMSGFMT_015 = @GMSGFMT_015@
+GPGME_CFLAGS = @GPGME_CFLAGS@
+GPGME_CONFIG = @GPGME_CONFIG@
+GPGME_LIBS = @GPGME_LIBS@
 GREP = @GREP@
+INODECMD = @INODECMD@
 INSTALL = @INSTALL@
 INSTALL_DATA = @INSTALL_DATA@
 INSTALL_PROGRAM = @INSTALL_PROGRAM@
@@ -195,12 +204,16 @@
 INTL_MACOSX_LIBS = @INTL_MACOSX_LIBS@
 LD = @LD@
 LDFLAGS = @LDFLAGS@
-LIBCURL = @LIBCURL@
-LIBCURL_CPPFLAGS = @LIBCURL_CPPFLAGS@
+LIBARCHIVE_CFLAGS = @LIBARCHIVE_CFLAGS@
+LIBARCHIVE_LIBS = @LIBARCHIVE_LIBS@
+LIBCURL_CFLAGS = @LIBCURL_CFLAGS@
+LIBCURL_LIBS = @LIBCURL_LIBS@
 LIBICONV = @LIBICONV@
 LIBINTL = @LIBINTL@
 LIBOBJS = @LIBOBJS@
 LIBS = @LIBS@
+LIBSSL_CFLAGS = @LIBSSL_CFLAGS@
+LIBSSL_LIBS = @LIBSSL_LIBS@
 LIBTOOL = @LIBTOOL@
 LIB_VERSION = @LIB_VERSION@
 LIB_VERSION_INFO = @LIB_VERSION_INFO@
@@ -230,10 +243,14 @@
 PACKAGE_VERSION = @PACKAGE_VERSION@
 PATH_SEPARATOR = @PATH_SEPARATOR@
 PKGEXT = @PKGEXT@
+PKG_CONFIG = @PKG_CONFIG@
+PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
+PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 POSUB = @POSUB@
 PYTHON = @PYTHON@
 RANLIB = @RANLIB@
 ROOTDIR = @ROOTDIR@
+SCRIPTLET_SHELL = @SCRIPTLET_SHELL@
 SED = @SED@
 SEDINPLACE = @SEDINPLACE@
 SET_MAKE = @SET_MAKE@
@@ -246,17 +263,16 @@
 STRIP_STATIC = @STRIP_STATIC@
 USE_NLS = @USE_NLS@
 VERSION = @VERSION@
+WARNING_CFLAGS = @WARNING_CFLAGS@
 XGETTEXT = @XGETTEXT@
 XGETTEXT_015 = @XGETTEXT_015@
 XGETTEXT_EXTRA_OPTIONS = @XGETTEXT_EXTRA_OPTIONS@
-_libcurl_config = @_libcurl_config@
 abs_builddir = @abs_builddir@
 abs_srcdir = @abs_srcdir@
 abs_top_builddir = @abs_top_builddir@
 abs_top_srcdir = @abs_top_srcdir@
 ac_ct_AR = @ac_ct_AR@
 ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
 ac_ct_DUMPBIN = @ac_ct_DUMPBIN@
 am__include = @am__include@
 am__leading_dot = @am__leading_dot@
@@ -308,7 +324,9 @@
 AUTOMAKE_OPTIONS = std-options
 SUBDIRS = po
 bin_SCRIPTS = \
-	$(OURSCRIPTS)
+	$(OURSCRIPTS) \
+	repo-remove \
+	repo-elephant
 
 OURSCRIPTS = \
 	makepkg \
@@ -316,7 +334,6 @@
 	pacman-key \
 	pacman-optimize \
 	pkgdelta \
-	rankmirrors \
 	repo-add
 
 EXTRA_DIST = \
@@ -325,13 +342,14 @@
 	pacman-key.sh.in \
 	pacman-optimize.sh.in \
 	pkgdelta.sh.in \
-	rankmirrors.sh.in \
 	repo-add.sh.in \
 	$(LIBRARY)
 
 LIBRARY = \
 	library/output_format.sh \
-	library/parse_options.sh
+	library/parseopts.sh \
+	library/human_to_size.sh \
+	library/size_to_human.sh
 
 
 # Files that should be removed, but which Automake does not know.
@@ -352,6 +370,7 @@
 	-e 's|@PACKAGE_BUGREPORT[@]|$(PACKAGE_BUGREPORT)|g' \
 	-e 's|@PACKAGE_NAME[@]|$(PACKAGE_NAME)|g' \
 	-e 's|@BUILDSCRIPT[@]|$(BUILDSCRIPT)|g' \
+	-e "s|@INODECMD[@]|$(INODECMD)|g" \
 	-e 's|@SIZECMD[@]|$(SIZECMD)|g' \
 	-e 's|@SEDINPLACE[@]|$(SEDINPLACE)|g' \
 	-e 's|@DUPATH[@]|$(DUPATH)|g' \
@@ -449,11 +468,11 @@
 	-rm -rf .libs _libs
 
 # This directory's subdirectories are mostly independent; you can cd
-# into them and run `make' without going through this Makefile.
-# To change the values of `make' variables: instead of editing Makefiles,
-# (1) if the variable is set in `config.status', edit `config.status'
-#     (which will cause the Makefiles to be regenerated when you run `make');
-# (2) otherwise, pass the desired values on the `make' command line.
+# into them and run 'make' without going through this Makefile.
+# To change the values of 'make' variables: instead of editing Makefiles,
+# (1) if the variable is set in 'config.status', edit 'config.status'
+#     (which will cause the Makefiles to be regenerated when you run 'make');
+# (2) otherwise, pass the desired values on the 'make' command line.
 $(RECURSIVE_TARGETS):
 	@fail= failcom='exit 1'; \
 	for f in x $$MAKEFLAGS; do \
@@ -517,6 +536,10 @@
 	list='$(SUBDIRS)'; for subdir in $$list; do \
 	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) ctags); \
 	done
+cscopelist-recursive:
+	list='$(SUBDIRS)'; for subdir in $$list; do \
+	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) cscopelist); \
+	done
 
 ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
 	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
@@ -580,6 +603,20 @@
 	  && $(am__cd) $(top_srcdir) \
 	  && gtags -i $(GTAGS_ARGS) "$$here"
 
+cscopelist: cscopelist-recursive $(HEADERS) $(SOURCES) $(LISP)
+	list='$(SOURCES) $(HEADERS) $(LISP)'; \
+	case "$(srcdir)" in \
+	  [\\/]* | ?:[\\/]*) sdir="$(srcdir)" ;; \
+	  *) sdir=$(subdir)/$(srcdir) ;; \
+	esac; \
+	for i in $$list; do \
+	  if test -f "$$i"; then \
+	    echo "$(subdir)/$$i"; \
+	  else \
+	    echo "$$sdir/$$i"; \
+	  fi; \
+	done >> $(top_builddir)/cscope.files
+
 distclean-tags:
 	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
 
@@ -745,39 +782,36 @@
 uninstall-am: uninstall-binSCRIPTS
 	@$(NORMAL_INSTALL)
 	$(MAKE) $(AM_MAKEFLAGS) uninstall-hook
-.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) ctags-recursive \
-	install-am install-data-am install-strip tags-recursive \
-	uninstall-am
+.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) \
+	cscopelist-recursive ctags-recursive install-am \
+	install-data-am install-strip tags-recursive uninstall-am
 
 .PHONY: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) CTAGS GTAGS \
 	all all-am check check-am clean clean-generic clean-libtool \
-	ctags ctags-recursive distclean distclean-generic \
-	distclean-libtool distclean-tags distdir dvi dvi-am html \
-	html-am info info-am install install-am install-binSCRIPTS \
-	install-data install-data-am install-data-hook install-dvi \
-	install-dvi-am install-exec install-exec-am install-html \
-	install-html-am install-info install-info-am install-man \
-	install-pdf install-pdf-am install-ps install-ps-am \
-	install-strip installcheck installcheck-am \
-	installcheck-binSCRIPTS installdirs installdirs-am \
-	maintainer-clean maintainer-clean-generic mostlyclean \
-	mostlyclean-generic mostlyclean-libtool pdf pdf-am ps ps-am \
-	tags tags-recursive uninstall uninstall-am \
+	cscopelist cscopelist-recursive ctags ctags-recursive \
+	distclean distclean-generic distclean-libtool distclean-tags \
+	distdir dvi dvi-am html html-am info info-am install \
+	install-am install-binSCRIPTS install-data install-data-am \
+	install-data-hook install-dvi install-dvi-am install-exec \
+	install-exec-am install-html install-html-am install-info \
+	install-info-am install-man install-pdf install-pdf-am \
+	install-ps install-ps-am install-strip installcheck \
+	installcheck-am installcheck-binSCRIPTS installdirs \
+	installdirs-am maintainer-clean maintainer-clean-generic \
+	mostlyclean mostlyclean-generic mostlyclean-libtool pdf pdf-am \
+	ps ps-am tags tags-recursive uninstall uninstall-am \
 	uninstall-binSCRIPTS uninstall-hook
 
 
-# two 'test' lines- make sure we can handle both sh and py type scripts
-# third 'test' line- make sure one of the two checks succeeded
 $(OURSCRIPTS): Makefile
-	@echo '    ' GEN $@;
-	@$(RM) $@
-	@test -f $(srcdir)/$@.sh.in && m4 -P -I $(srcdir) $(srcdir)/$@.sh.in | $(edit) >$@
-	@chmod +x $@
-	@chmod a-w $@
+	$(AM_V_at)$(RM) $@
+	$(AM_V_GEN)test -f $(srcdir)/$@.sh.in && m4 -P -I $(srcdir) $(srcdir)/$@.sh.in | $(edit) >$@
+	$(AM_V_at)chmod +x,a-w $@
+	@$(BASH_SHELL) -O extglob -n $@
 
 makepkg: \
 	$(srcdir)/makepkg.sh.in \
-	$(srcdir)/library/parse_options.sh
+	$(srcdir)/library/parseopts.sh
 
 pacman-db-upgrade: \
 	$(srcdir)/pacman-db-upgrade.sh.in \
@@ -786,7 +820,7 @@
 pacman-key: \
 	$(srcdir)/pacman-key.sh.in \
 	$(srcdir)/library/output_format.sh \
-	$(srcdir)/library/parse_options.sh
+	$(srcdir)/library/parseopts.sh
 
 pacman-optimize: \
 	$(srcdir)/pacman-optimize.sh.in \
@@ -794,21 +828,20 @@
 
 pkgdelta: \
 	$(srcdir)/pkgdelta.sh.in \
-	$(srcdir)/library/output_format.sh
-
-rankmirrors: $(srcdir)/rankmirrors.sh.in
+	$(srcdir)/library/output_format.sh \
+	$(srcdir)/library/parseopts.sh
 
 repo-add: \
 	$(srcdir)/repo-add.sh.in \
 	$(srcdir)/library/output_format.sh
 
 repo-remove: $(srcdir)/repo-add.sh.in
-	$(RM) repo-remove
-	$(LN_S) repo-add repo-remove
+	$(AM_V_at)$(RM) repo-remove
+	$(AM_V_at)$(LN_S) repo-add repo-remove
 
 repo-elephant: $(srcdir)/repo-add.sh.in
-	$(RM) repo-elephant
-	$(LN_S) repo-add repo-elephant
+	$(AM_V_at)$(RM) repo-elephant
+	$(AM_V_at)$(LN_S) repo-add repo-elephant
 
 install-data-hook:
 	cd $(DESTDIR)$(bindir) && \
Only in pacman/scripts/library: README
Only in pacman/scripts/library: human_to_size.sh
Only in pacman-4.0.3/scripts/library: parse_options.sh
Only in pacman/scripts/library: parseopts.sh
Only in pacman/scripts/library: size_to_human.sh
diff -x '.*' -aur pacman-4.0.3/scripts/makepkg.sh.in pacman/scripts/makepkg.sh.in
--- pacman-4.0.3/scripts/makepkg.sh.in	2012-04-07 16:03:48.000000000 +0000
+++ pacman/scripts/makepkg.sh.in	2012-10-15 18:11:52.513287879 +0000
@@ -1,4 +1,4 @@
-#!/bin/bash -e
+#!/bin/bash
 #
 #   makepkg - make packages compatible for use with pacman
 #   @configure_input@
@@ -39,25 +39,27 @@
 # Ensure CDPATH doesn't screw with our cd calls
 unset CDPATH
 
-myver='@PACKAGE_VERSION@'
-confdir='@sysconfdir@'
-BUILDSCRIPT='@BUILDSCRIPT@'
-startdir="$PWD"
+declare -r makepkg_version='@PACKAGE_VERSION@'
+declare -r confdir='@sysconfdir@'
+declare -r BUILDSCRIPT='@BUILDSCRIPT@'
+declare -r startdir="$PWD"
 
 packaging_options=('strip' 'docs' 'libtool' 'emptydirs' 'zipman' 'purge' 'upx')
 other_options=('ccache' 'distcc' 'buildflags' 'makeflags')
-splitpkg_overrides=('pkgver' 'pkgrel' 'epoch' 'pkgdesc' 'arch' 'license' \
+splitpkg_overrides=('pkgver' 'pkgrel' 'epoch' 'pkgdesc' 'arch' 'url' 'license' \
                     'groups' 'depends' 'optdepends' 'provides' 'conflicts' \
                     'replaces' 'backup' 'options' 'install' 'changelog')
 readonly -a packaging_options other_options splitpkg_overrides
 
 # Options
+ASDEPS=0
 ASROOT=0
 CLEANUP=0
 DEP_BIN=0
 FORCE=0
 INFAKEROOT=0
 GENINTEG=0
+HOLDVER=0
 SKIPCHECKSUMS=0
 SKIPPGPCHECK=0
 INSTALL=0
@@ -69,10 +71,11 @@
 LOGGING=0
 SOURCEONLY=0
 IGNOREARCH=0
-HOLDVER=0
+PREPAREFUNC=0
 BUILDFUNC=0
 CHECKFUNC=0
 PKGFUNC=0
+PKGVERFUNC=0
 SPLITPKG=0
 PKGLIST=()
 SIGNPKG=''
@@ -168,7 +171,7 @@
 
 			# clean up dangling symlinks to packages
 			for pkg in ${pkgname[@]}; do
-				for file in ${pkg}-*-*-${CARCH}{${PKGEXT},${SRCEXT}}; do
+				for file in ${pkg}-*-*-*{${PKGEXT},${SRCEXT}}; do
 					if [[ -h $file && ! -e $file ]]; then
 						rm -f "$file"
 					fi
@@ -183,12 +186,7 @@
 
 enter_fakeroot() {
 	msg "$(gettext "Entering %s environment...")" "fakeroot"
-
-	if [[ -n $newpkgver ]]; then
-		fakeroot -- $0 --forcever $newpkgver -F "${ARGLIST[@]}" || exit $?
-	else
-		fakeroot -- $0 -F "${ARGLIST[@]}" || exit $?
-	fi
+	fakeroot -- $0 -F "${ARGLIST[@]}" || exit $?
 }
 
 
@@ -197,42 +195,522 @@
 # 2) "http://path/to/file"
 
 # Return the absolute filename of a source entry
-#
-# This function accepts a source entry or the already extracted filename of a
-# source entry as input
 get_filepath() {
 	local file="$(get_filename "$1")"
+	local proto="$(get_protocol "$1")"
 
-	if [[ -f "$startdir/$file" ]]; then
-		file="$startdir/$file"
-	elif [[ -f "$SRCDEST/$file" ]]; then
-		file="$SRCDEST/$file"
-	else
-		return 1
-	fi
-
-	echo "$file"
-}
+	case $proto in
+		bzr*|git*|hg*|svn*)
+			if [[ -d "$startdir/$file" ]]; then
+				file="$startdir/$file"
+			elif [[ -d "$SRCDEST/$file" ]]; then
+				file="$SRCDEST/$file"
+			else
+				return 1
+			fi
+			;;
+		*)
+			if [[ -f "$startdir/$file" ]]; then
+				file="$startdir/$file"
+			elif [[ -f "$SRCDEST/$file" ]]; then
+				file="$SRCDEST/$file"
+			else
+				return 1
+			fi
+			;;
+	esac
 
-# Print 'source not found' error message and exit makepkg
-missing_source_file() {
-	error "$(gettext "Unable to find source file %s.")" "$(get_filename "$1")"
-	plain "$(gettext "Aborting...")"
-	exit 1 # $E_MISSING_FILE
+	printf "%s\n" "$file"
 }
 
 # extract the filename from a source entry
 get_filename() {
+	local netfile=$1
+
 	# if a filename is specified, use it
-	local filename="${1%%::*}"
-	# if it is just an URL, we only keep the last component
-	echo "${filename##*/}"
+	if [[ $netfile = *::* ]]; then
+		printf "%s\n" ${netfile%%::*}
+		return
+	fi
+
+	local proto=$(get_protocol "$netfile")
+
+	case $proto in
+		bzr*|git*|hg*|svn*)
+			filename=${netfile%%#*}
+			filename=${filename%/}
+			filename=${filename##*/}
+			if [[ $proto = git* ]]; then
+				filename=${filename%%.git*}
+			fi
+			;;
+		*)
+			# if it is just an URL, we only keep the last component
+			filename="${netfile##*/}"
+			;;
+	esac
+	printf "%s\n" "${filename}"
 }
 
 # extract the URL from a source entry
 get_url() {
 	# strip an eventual filename
-	echo "${1#*::}"
+	printf "%s\n" "${1#*::}"
+}
+
+# extract the protocol from a source entry - return "local" for local sources
+get_protocol() {
+	if [[ $1 = *://* ]]; then
+		# strip leading filename
+		local proto="${1##*::}"
+		printf "%s\n" "${proto%%://*}"
+	else
+		printf "%s\n" local
+	fi
+}
+
+get_downloadclient() {
+	local proto=$1
+
+	# loop through DOWNLOAD_AGENTS variable looking for protocol
+	local i
+	for i in "${DLAGENTS[@]}"; do
+		local handler="${i%%::*}"
+		if [[ $proto = "$handler" ]]; then
+			local agent="${i##*::}"
+			break
+		fi
+	done
+
+	# if we didn't find an agent, return an error
+	if [[ -z $agent ]]; then
+		error "$(gettext "Unknown download protocol: %s")" "$proto"
+		plain "$(gettext "Aborting...")"
+		exit 1 # $E_CONFIG_ERROR
+	fi
+
+	# ensure specified program is installed
+	local program="${agent%% *}"
+	if [[ ! -x $program ]]; then
+		local baseprog="${program##*/}"
+		error "$(gettext "The download program %s is not installed.")" "$baseprog"
+		plain "$(gettext "Aborting...")"
+		exit 1 # $E_MISSING_PROGRAM
+	fi
+
+	printf "%s\n" "$agent"
+}
+
+download_local() {
+	local netfile=$1
+	local filepath=$(get_filepath "$netfile")
+
+	if [[ -n "$filepath" ]]; then
+		msg2 "$(gettext "Found %s")" "${filepath##*/}"
+		rm -f "$srcdir/${filepath##*/}"
+		ln -s "$filepath" "$srcdir/"
+		continue
+	else
+		local filename=$(get_filename "$netfile")
+		error "$(gettext "%s was not found in the build directory and is not a URL.")" "$filename"
+		exit 1 # $E_MISSING_FILE
+	fi
+}
+
+download_file() {
+	local netfile=$1
+
+	local filepath=$(get_filepath "$netfile")
+	if [[ -n "$filepath" ]]; then
+		msg2 "$(gettext "Found %s")" "${filepath##*/}"
+		rm -f "$srcdir/${filepath##*/}"
+		ln -s "$filepath" "$srcdir/"
+		return
+	fi
+
+	local proto=$(get_protocol "$netfile")
+
+	# find the client we should use for this URL
+	local dlcmd
+	dlcmd=$(get_downloadclient "$proto") || exit $?
+
+	local filename=$(get_filename "$netfile")
+	local url=$(get_url "$netfile")
+
+	if [[ $proto = "scp" ]]; then
+		# scp downloads should not pass the protocol in the url
+		url="${url##*://}"
+	fi
+
+	msg2 "$(gettext "Downloading %s...")" "$filename"
+
+	# temporary download file, default to last component of the URL
+	local dlfile="${url##*/}"
+
+	# replace %o by the temporary dlfile if it exists
+	if [[ $dlcmd = *%o* ]]; then
+		dlcmd=${dlcmd//\%o/\"$filename.part\"}
+		dlfile="$filename.part"
+	fi
+	# add the URL, either in place of %u or at the end
+	if [[ $dlcmd = *%u* ]]; then
+		dlcmd=${dlcmd//\%u/\"$url\"}
+	else
+		dlcmd="$dlcmd \"$url\""
+	fi
+
+	local ret=0
+	eval "$dlcmd || ret=\$?"
+	if (( ret )); then
+		[[ ! -s $dlfile ]] && rm -f -- "$dlfile"
+		error "$(gettext "Failure while downloading %s")" "$filename"
+		plain "$(gettext "Aborting...")"
+		exit 1
+	fi
+
+	# rename the temporary download file to the final destination
+	if [[ $dlfile != "$filename" ]]; then
+		mv -f "$SRCDEST/$dlfile" "$SRCDEST/$filename"
+	fi
+
+	rm -f "$srcdir/$filename"
+	ln -s "$SRCDEST/$filename" "$srcdir/"
+}
+
+download_bzr() {
+	local netfile=$1
+
+	local url=$(get_url "$netfile")
+	url=${url##*bzr+}
+	url=${url%%#*}
+
+	local fragment=${netfile#*#}
+	if [[ $fragment = "$netfile" ]]; then
+		unset fragment
+	fi
+
+	local displaylocation="$url"
+	local revision=('-r-1')
+
+	if [[ -n $fragment ]]; then
+		case ${fragment%%=*} in
+			revision)
+				revision=("-r${fragment##*=}")
+				displaylocation="$url -r ${fragment##*=}"
+				;;
+			*)
+				error "$(gettext "Unrecognized reference: %s")" "${fragment}"
+				plain "$(gettext "Aborting...")"
+				exit 1
+		esac
+	fi
+
+	local dir=$(get_filepath "$netfile")
+	[[ -z "$dir" ]] && dir="$SRCDEST/$(get_filename "$netfile")"
+
+	if [[ ! -d "$dir" ]] || dir_is_empty "$dir" ; then
+		msg2 "$(gettext "Branching %s ...")" "${displaylocation}"
+		if ! bzr branch "$url" "$dir" ${revision[@]} --no-tree --use-existing-dir; then
+			error "$(gettext "Failure while branching %s")" "${displaylocation}"
+			plain "$(gettext "Aborting...")"
+			exit 1
+		fi
+	elif (( ! HOLDVER )); then
+		# Make sure we are fetching the right repo
+		if [[ "$url" != "$(bzr config parent_location -d $dir)"  ]] ; then
+			error "$(gettext "%s is not a branch of %s")" "$dir" "$url"
+			plain "$(gettext "Aborting...")"
+			exit 1
+		fi
+		msg2 "$(gettext "Pulling %s ...")" "${displaylocation}"
+		cd_safe "$dir"
+		if ! bzr pull "$url" ${revision[@]} --overwrite; then
+			# only warn on failure to allow offline builds
+			warning "$(gettext "Failure while pulling %s")" "${displaylocation}"
+		fi
+	fi
+
+	msg2 "$(gettext "Creating working copy of %s %s repo...")" "${dir}" "bzr"
+	pushd "$srcdir" &>/dev/null
+	rm -rf "${dir##*/}"
+
+	if ! bzr checkout "$dir" --lightweight; then
+		error "$(gettext "Failure while creating working copy of %s %s repo")" "${dir}" "bzr"
+		plain "$(gettext "Aborting...")"
+		exit 1
+	fi
+
+	popd &>/dev/null
+}
+
+download_git() {
+	local netfile=$1
+
+	local fragment=${netfile#*#}
+	if [[ $fragment = "$netfile" ]]; then
+		unset fragment
+	fi
+
+	local dir=$(get_filepath "$netfile")
+	[[ -z "$dir" ]] && dir="$SRCDEST/$(get_filename "$netfile")"
+
+	local repo=${netfile##*/}
+	repo=${repo%%#*}
+	repo=${repo%%.git*}
+
+	local url=$(get_url "$netfile")
+	url=${url##*git+}
+	url=${url%%#*}
+
+	if [[ ! -d "$dir" ]] || dir_is_empty "$dir" ; then
+		msg2 "$(gettext "Cloning %s %s repo...")" "${repo}" "git"
+		if ! git clone --mirror "$url" "$dir"; then
+			error "$(gettext "Failure while downloading %s %s repo")" "${repo}" "git"
+			plain "$(gettext "Aborting...")"
+			exit 1
+		fi
+	elif (( ! HOLDVER )); then
+		cd_safe "$dir"
+		# Make sure we are fetching the right repo
+		if [[ "$url" != "$(git config --get remote.origin.url)"  ]] ; then
+			error "$(gettext "%s is not a clone of %s")" "$dir" "$url"
+			plain "$(gettext "Aborting...")"
+			exit 1
+		fi
+		msg2 "$(gettext "Updating %s %s repo...")" "${repo}" "git"
+		if ! git fetch --all -p; then
+			# only warn on failure to allow offline builds
+			warning "$(gettext "Failure while updating %s %s repo")" "${repo}" "git"
+		fi
+	fi
+
+	msg2 "$(gettext "Creating working copy of %s %s repo...")" "${repo}" "git"
+	pushd "$srcdir" &>/dev/null
+	rm -rf "${dir##*/}"
+
+	if ! git clone "$dir"; then
+		error "$(gettext "Failure while creating working copy of %s %s repo")" "${repo}" "git"
+		plain "$(gettext "Aborting...")"
+		exit 1
+	fi
+
+	cd_safe "${dir##*/}"
+
+	local ref
+	if [[ -n $fragment ]]; then
+		case ${fragment%%=*} in
+			commit|tag)
+				ref=${fragment##*=}
+				;;
+			branch)
+				ref=origin/${fragment##*=}
+				;;
+			*)
+				error "$(gettext "Unrecognized reference: %s")" "${fragment}"
+				plain "$(gettext "Aborting...")"
+				exit 1
+		esac
+	fi
+
+	if [[ -n $ref ]]; then
+		if ! git checkout -b makepkg $ref; then
+			error "$(gettext "Failure while creating working copy of %s %s repo")" "${repo}" "git"
+			plain "$(gettext "Aborting...")"
+			exit 1
+		fi
+	fi
+
+	popd &>/dev/null
+}
+
+download_hg() {
+	local netfile=$1
+
+	local fragment=${netfile#*#}
+	if [[ $fragment = "$netfile" ]]; then
+		unset fragment
+	fi
+
+	local dir=$(get_filepath "$netfile")
+	[[ -z "$dir" ]] && dir="$SRCDEST/$(get_filename "$netfile")"
+
+	local repo=${netfile##*/}
+	repo=${repo%%#*}
+
+	local url=$(get_url "$netfile")
+	url=${url##*hg+}
+	url=${url%%#*}
+
+	if [[ ! -d "$dir" ]] || dir_is_empty "$dir" ; then
+		msg2 "$(gettext "Cloning %s %s repo...")" "${repo}" "hg"
+		if ! hg clone -U "$url" "$dir"; then
+			error "$(gettext "Failure while downloading %s %s repo")" "${repo}" "hg"
+			plain "$(gettext "Aborting...")"
+			exit 1
+		fi
+	elif (( ! HOLDVER )); then
+		msg2 "$(gettext "Updating %s %s repo...")" "${repo}" "hg"
+		cd_safe "$dir"
+		if ! hg pull; then
+			# only warn on failure to allow offline builds
+			warning "$(gettext "Failure while updating %s %s repo")" "${repo}" "hg"
+		fi
+	fi
+
+	msg2 "$(gettext "Creating working copy of %s %s repo...")" "${repo}" "hg"
+	pushd "$srcdir" &>/dev/null
+	rm -rf "${dir##*/}"
+
+	local ref
+	if [[ -n $fragment ]]; then
+		case ${fragment%%=*} in
+			branch|revision|tag)
+				ref=('-u' "${fragment##*=}")
+				;;
+			*)
+				error "$(gettext "Unrecognized reference: %s")" "${fragment}"
+				plain "$(gettext "Aborting...")"
+				exit 1
+		esac
+	fi
+
+	if ! hg clone "${ref[@]}" "$dir" "${dir##*/}"; then
+		error "$(gettext "Failure while creating working copy of %s %s repo")" "${repo}" "hg"
+		plain "$(gettext "Aborting...")"
+		exit 1
+	fi
+
+	popd &>/dev/null
+}
+
+download_svn() {
+	local netfile=$1
+
+	local fragment=${netfile#*#}
+	if [[ $fragment = "$netfile" ]]; then
+		unset fragment
+	fi
+
+	local dir=$(get_filepath "$netfile")
+	[[ -z "$dir" ]] && dir="$SRCDEST/$(get_filename "$netfile")"
+
+	local repo=${netfile##*/}
+	repo=${repo%%#*}
+
+	local url=$(get_url "$netfile")
+	if [[ $url != svn+ssh* ]]; then
+		url=${url##*svn+}
+	fi
+	url=${url%%#*}
+
+	if [[ ! -d "$dir" ]] || dir_is_empty "$dir" ; then
+		msg2 "$(gettext "Cloning %s %s repo...")" "${repo}" "svn"
+		if ! svn checkout --config-dir "$dir" "$url" "$dir"; then
+			error "$(gettext "Failure while downloading %s %s repo")" "${repo}" "svn"
+			plain "$(gettext "Aborting...")"
+			exit 1
+		fi
+	elif (( ! HOLDVER )); then
+		msg2 "$(gettext "Updating %s %s repo...")" "${repo}" "svn"
+		cd_safe "$dir"
+		if ! svn update; then
+			# only warn on failure to allow offline builds
+			warning "$(gettext "Failure while updating %s %s repo")" "${repo}" "svn"
+		fi
+	fi
+
+	msg2 "$(gettext "Creating working copy of %s %s repo...")" "${repo}" "svn"
+	pushd "$srcdir" &>/dev/null
+	rm -rf "${dir##*/}"
+
+	local ref
+	if [[ -n $fragment ]]; then
+		case ${fragment%%=*} in
+			revision)
+				ref=('-r' "${fragment##*=}")
+				;;
+			*)
+				error "$(gettext "Unrecognized reference: %s")" "${fragment}"
+				plain "$(gettext "Aborting...")"
+				exit 1
+		esac
+	fi
+
+	if ! svn export ${ref[@]} "$dir"; then
+		error "$(gettext "Failure while creating working copy of %s %s repo")" "${repo}" "svn"
+		plain "$(gettext "Aborting...")"
+	fi
+
+	popd &>/dev/null
+}
+
+download_sources() {
+	msg "$(gettext "Retrieving Sources...")"
+
+	local GET_VCS=1
+	if [[ $1 == "fast" ]]; then
+		GET_VCS=0
+	fi
+
+	pushd "$SRCDEST" &>/dev/null
+
+	local netfile
+	for netfile in "${source[@]}"; do
+		local proto=$(get_protocol "$netfile")
+
+		case "$proto" in
+			local)
+				download_local "$netfile"
+				;;
+			bzr*)
+				(( GET_VCS )) && download_bzr "$netfile"
+				;;
+			git*)
+				(( GET_VCS )) && download_git "$netfile"
+				;;
+			hg*)
+				(( GET_VCS )) && download_hg "$netfile"
+				;;
+			svn*)
+				(( GET_VCS )) && download_svn "$netfile"
+				;;
+			*)
+				download_file "$netfile"
+				;;
+		esac
+	done
+
+	if (( PKGVERFUNC && GET_VCS )); then
+		update_pkgver
+		check_pkgver || exit 1
+		check_build_status
+	fi
+
+	popd &>/dev/null
+}
+
+# Automatically update pkgver variable if a pkgver() function is provided
+# Re-sources the PKGBUILD afterwards to allow for other variables that use $pkgver
+update_pkgver() {
+	newpkgver=$(run_function_safe pkgver)
+
+	if [[ -n $newpkgver && $newpkgver != "$pkgver" ]]; then
+		if [[ -f $BUILDFILE && -w $BUILDFILE ]]; then
+			@SEDINPLACE@ "s/^pkgver=[^ ]*/pkgver=$newpkgver/" "$BUILDFILE"
+			@SEDINPLACE@ "s/^pkgrel=[^ ]*/pkgrel=1/" "$BUILDFILE"
+			source "$BUILDFILE"
+		else
+			warning "$(gettext "%s is not writeable -- pkgver will not be updated")" \
+					"$BUILDFILE"
+		fi
+	fi
+}
+
+# Print 'source not found' error message and exit makepkg
+missing_source_file() {
+	error "$(gettext "Unable to find source file %s.")" "$(get_filename "$1")"
+	plain "$(gettext "Aborting...")"
+	exit 1 # $E_MISSING_FILE
 }
 
 ##
@@ -242,9 +720,9 @@
 get_full_version() {
 	if [[ -z $1 ]]; then
 		if [[ $epoch ]] && (( ! $epoch )); then
-			echo $pkgver-$pkgrel
+			printf "%s\n" "$pkgver-$pkgrel"
 		else
-			echo $epoch:$pkgver-$pkgrel
+			printf "%s\n" "$epoch:$pkgver-$pkgrel"
 		fi
 	else
 		for i in pkgver pkgrel epoch; do
@@ -253,9 +731,32 @@
 			[[ -z ${!indirect} ]] && eval ${indirect}=\"${!i}\"
 		done
 		if (( ! $epoch_override )); then
-			echo $pkgver_override-$pkgrel_override
+			printf "%s\n" "$pkgver_override-$pkgrel_override"
+		else
+			printf "%s\n" "$epoch_override:$pkgver_override-$pkgrel_override"
+		fi
+	fi
+}
+
+##
+#  usage : get_pkg_arch( [$pkgname] )
+# return : architecture of the package
+##
+get_pkg_arch() {
+	if [[ -z $1 ]]; then
+		if [[ $arch = "any" ]]; then
+			printf "%s\n" "any"
 		else
-			echo $epoch_override:$pkgver_override-$pkgrel_override
+			printf "%s\n" "$CARCH"
+		fi
+	else
+		local arch_override
+		eval $(declare -f package_$1 | sed -n 's/\(^[[:space:]]*arch=\)/arch_override=/p')
+		(( ${#arch_override[@]} == 0 )) && arch_override=("${arch[@]}")
+		if [[ $arch_override = "any" ]]; then
+			printf "%s\n" "any"
+		else
+			printf "%s\n" "$CARCH"
 		fi
 	fi
 }
@@ -264,189 +765,138 @@
 # Checks to see if options are present in makepkg.conf or PKGBUILD;
 # PKGBUILD options always take precedence.
 #
-#  usage : check_option( $option )
-# return : y - enabled
-#          n - disabled
-#          ? - not found
+#  usage : check_option( $option, $expected_val )
+# return : 0   - matches expected
+#          1   - does not match expected
+#          127 - not found
 ##
 check_option() {
-	local ret=$(in_opt_array "$1" ${options[@]})
-	if [[ $ret != '?' ]]; then
-		echo $ret
-		return
-	fi
+	in_opt_array "$1" ${options[@]}
+	case $? in
+		0) # assert enabled
+			[[ $2 = y ]]
+			return ;;
+		1) # assert disabled
+			[[ $2 = n ]]
+			return
+	esac
 
 	# fall back to makepkg.conf options
-	ret=$(in_opt_array "$1" ${OPTIONS[@]})
-	if [[ $ret != '?' ]]; then
-		echo $ret
-		return
-	fi
+	in_opt_array "$1" ${OPTIONS[@]}
+	case $? in
+		0) # assert enabled
+			[[ $2 = y ]]
+			return ;;
+		1) # assert disabled
+			[[ $2 = n ]]
+			return
+	esac
 
-	echo '?' # Not Found
+	# not found
+	return 127
 }
 
 
 ##
 # Check if option is present in BUILDENV
 #
-#  usage : check_buildenv( $option )
-# return : y - enabled
-#          n - disabled
-#          ? - not found
+#  usage : check_buildenv( $option, $expected_val )
+# return : 0   - matches expected
+#          1   - does not match expected
+#          127 - not found
 ##
 check_buildenv() {
 	in_opt_array "$1" ${BUILDENV[@]}
+	case $? in
+		0) # assert enabled
+			[[ $2 = "y" ]]
+			return ;;
+		1) # assert disabled
+			[[ $2 = "n" ]]
+			return ;;
+	esac
+
+	# not found
+	return 127
 }
 
 
 ##
 #  usage : in_opt_array( $needle, $haystack )
-# return : y - enabled
-#          n - disabled
-#          ? - not found
+# return : 0   - enabled
+#          1   - disabled
+#          127 - not found
 ##
 in_opt_array() {
 	local needle=$1; shift
 
 	local opt
 	for opt in "$@"; do
-		if [[ $opt = $needle ]]; then
-			echo 'y' # Enabled
-			return
+		if [[ $opt = "$needle" ]]; then
+			# enabled
+			return 0
 		elif [[ $opt = "!$needle" ]]; then
-			echo 'n' # Disabled
-			return
+			# disabled
+			return 1
 		fi
 	done
 
-	echo '?' # Not Found
+	# not found
+	return 127
 }
 
 
 ##
 #  usage : in_array( $needle, $haystack )
-# return : 0 - found
-#          1 - not found
-##
-in_array() {
-	local needle=$1; shift
-	local item
-	for item in "$@"; do
-		[[ $item = $needle ]] && return 0 # Found
-	done
-	return 1 # Not Found
-}
-
-source_has_signatures(){
-	local file
-	for file in "${source[@]}"; do
-		if [[ $file = *.@(sig?(n)|asc) ]]; then
-			return 0
-		fi
-	done
-	return 1
-}
-
-get_downloadclient() {
-	# $1 = URL with valid protocol prefix
-	local url=$1
-	local proto="${url%%://*}"
-
-	# loop through DOWNLOAD_AGENTS variable looking for protocol
-	local i
-	for i in "${DLAGENTS[@]}"; do
-		local handler="${i%%::*}"
-		if [[ $proto = $handler ]]; then
-			local agent="${i##*::}"
-			break
-		fi
-	done
-
-	# if we didn't find an agent, return an error
-	if [[ -z $agent ]]; then
-		error "$(gettext "There is no agent set up to handle %s URLs. Check %s.")" "$proto" "$MAKEPKG_CONF"
-		plain "$(gettext "Aborting...")"
-		exit 1 # $E_CONFIG_ERROR
-	fi
-
-	# ensure specified program is installed
-	local program="${agent%% *}"
-	if [[ ! -x $program ]]; then
-		local baseprog="${program##*/}"
-		error "$(gettext "The download program %s is not installed.")" "$baseprog"
-		plain "$(gettext "Aborting...")"
-		exit 1 # $E_MISSING_PROGRAM
-	fi
-
-	echo "$agent"
-}
-
-download_file() {
-	# download command
-	local dlcmd=$1
-	# URL of the file
-	local url=$2
-	# destination file
-	local file=$3
-	# temporary download file, default to last component of the URL
-	local dlfile="${url##*/}"
-
-	# replace %o by the temporary dlfile if it exists
-	if [[ $dlcmd = *%o* ]]; then
-		dlcmd=${dlcmd//\%o/\"$file.part\"}
-		dlfile="$file.part"
-	fi
-	# add the URL, either in place of %u or at the end
-	if [[ $dlcmd = *%u* ]]; then
-		dlcmd=${dlcmd//\%u/\"$url\"}
-	else
-		dlcmd="$dlcmd \"$url\""
-	fi
-
-	local ret=0
-	eval "$dlcmd || ret=\$?"
-	if (( ret )); then
-		[[ ! -s $dlfile ]] && rm -f -- "$dlfile"
-		return $ret
-	fi
+# return : 0 - found
+#          1 - not found
+##
+in_array() {
+	local needle=$1; shift
+	local item
+	for item in "$@"; do
+		[[ $item = "$needle" ]] && return 0 # Found
+	done
+	return 1 # Not Found
+}
 
-	# rename the temporary download file to the final destination
-	if [[ $dlfile != "$file" ]]; then
-		mv -f "$SRCDEST/$dlfile" "$SRCDEST/$file"
-	fi
+source_has_signatures() {
+	local file
+	for file in "${source[@]}"; do
+		if [[ ${file%%::*} = *.@(sig?(n)|asc) ]]; then
+			return 0
+		fi
+	done
+	return 1
 }
 
 run_pacman() {
 	local cmd
 	if [[ ! $1 = -@(T|Qq) ]]; then
-		printf -v cmd "%q " "$PACMAN" $PACMAN_OPTS "$@"
+		cmd=("$PACMAN" $PACMAN_OPTS "$@")
 	else
-		printf -v cmd "%q " "$PACMAN" "$@"
+		cmd=("$PACMAN" "$@")
 	fi
 	if (( ! ASROOT )) && [[ ! $1 = -@(T|Qq) ]]; then
 		if type -p sudo >/dev/null; then
-			cmd="sudo $cmd"
+			cmd=(sudo "${cmd[@]}")
 		else
-			cmd="su root -c '$cmd'"
+			cmd=(su root -c "$(printf '%q ' "${cmd[@]}")")
 		fi
 	fi
-	eval "$cmd"
+	"${cmd[@]}"
 }
 
 check_deps() {
 	(( $# > 0 )) || return 0
 
-	# Disable error trap in pacman subshell call as this breaks bash-3.2 compatibility
-	# Also, a non-zero return value is not unexpected and we are manually dealing them
-	set +E
 	local ret=0
 	local pmout
-	pmout=$(run_pacman -T "$@") || ret=$?
-	set -E
+	pmout=$(run_pacman -T "$@")
+	ret=$?
 
 	if (( ret == 127 )); then #unresolved deps
-		echo "$pmout"
+		printf "%s\n" "$pmout"
 	elif (( ret )); then
 		error "$(gettext "'%s' returned a fatal error (%i): %s")" "$PACMAN" "$ret" "$pmout"
 		return "$ret"
@@ -476,13 +926,11 @@
 	fi
 
 	# we might need the new system environment
-	# avoid triggering the ERR trap and exiting
-	set +e
-	local restoretrap=$(trap -p ERR)
-	trap - ERR
+	# save our shell options and turn off extglob
+	local shellopts=$(shopt -p)
+	shopt -u extglob
 	source /etc/profile &>/dev/null
-	eval $restoretrap
-	set -e
+	eval "$shellopts"
 
 	return $R_DEPS_SATISFIED
 }
@@ -538,50 +986,6 @@
 	fi
 }
 
-download_sources() {
-	msg "$(gettext "Retrieving Sources...")"
-
-	pushd "$SRCDEST" &>/dev/null
-
-	local netfile
-	for netfile in "${source[@]}"; do
-		local file=$(get_filepath "$netfile" || true)
-		if [[ -n "$file" ]]; then
-			msg2 "$(gettext "Found %s")" "${file##*/}"
-			rm -f "$srcdir/${file##*/}"
-			ln -s "$file" "$srcdir/"
-			continue
-		fi
-
-		file=$(get_filename "$netfile")
-		local url=$(get_url "$netfile")
-
-		# if we get here, check to make sure it was a URL, else fail
-		if [[ $file = $url ]]; then
-			error "$(gettext "%s was not found in the build directory and is not a URL.")" "$file"
-			exit 1 # $E_MISSING_FILE
-		fi
-
-		# find the client we should use for this URL
-		local dlclient
-		dlclient=$(get_downloadclient "$url") || exit $?
-
-		msg2 "$(gettext "Downloading %s...")" "$file"
-		# fix flyspray bug #3289
-		local ret=0
-		download_file "$dlclient" "$url" "$file" || ret=$?
-		if (( ret )); then
-			error "$(gettext "Failure while downloading %s")" "$file"
-			plain "$(gettext "Aborting...")"
-			exit 1
-		fi
-		rm -f "$srcdir/$file"
-		ln -s "$SRCDEST/$file" "$srcdir/"
-	done
-
-	popd &>/dev/null
-}
-
 get_integlist() {
 	local integ
 	local integlist=()
@@ -594,15 +998,14 @@
 	done
 
 	if (( ${#integlist[@]} > 0 )); then
-		echo ${integlist[@]}
+		printf "%s\n" "${integlist[@]}"
 	else
-		echo ${INTEGRITY_CHECK[@]}
+		printf "%s\n" "${INTEGRITY_CHECK[@]}"
 	fi
 }
 
 generate_checksums() {
 	msg "$(gettext "Generating checksums for source files...")"
-	plain ""
 
 	if ! type -p openssl >/dev/null; then
 		error "$(gettext "Cannot find the %s binary required for generating sourcefile checksums.")" "openssl"
@@ -627,7 +1030,7 @@
 
 		local ct=0
 		local numsrc=${#source[@]}
-		echo -n "${integ}sums=("
+		printf "%s" "${integ}sums=("
 
 		local i
 		local indent=''
@@ -637,12 +1040,23 @@
 
 		local netfile
 		for netfile in "${source[@]}"; do
-			local file
-			file="$(get_filepath "$netfile")" || missing_source_file "$netfile"
-			local sum="$(openssl dgst -${integ} "$file")"
-			sum=${sum##* }
-			(( ct )) && echo -n "$indent"
-			echo -n "'$sum'"
+			local proto sum
+			proto="$(get_protocol "$netfile")"
+
+			case $proto in
+				bzr*|git*|hg*|svn*)
+					sum="SKIP"
+					;;
+				*)
+					local file
+					file="$(get_filepath "$netfile")" || missing_source_file "$netfile"
+					sum="$(openssl dgst -${integ} "$file")"
+					sum=${sum##* }
+					;;
+			esac
+
+			(( ct )) && printf "%s" "$indent"
+			printf "%s" "'$sum'"
 			ct=$(($ct+1))
 			(( $ct < $numsrc )) && echo
 		done
@@ -668,7 +1082,13 @@
 			for file in "${source[@]}"; do
 				local found=1
 				file="$(get_filename "$file")"
-				echo -n "    $file ... " >&2
+				printf "%s" "    $file ... " >&2
+
+				if [[ ${integrity_sums[$idx]} = 'SKIP' ]]; then
+					echo "$(gettext "Skipped")" >&2
+					idx=$((idx + 1))
+					continue
+				fi
 
 				if ! file="$(get_filepath "$file")"; then
 					printf -- "$(gettext "NOT FOUND")\n" >&2
@@ -677,10 +1097,10 @@
 				fi
 
 				if (( $found )) ; then
-					local expectedsum=$(tr '[:upper:]' '[:lower:]' <<< "${integrity_sums[$idx]}")
+					local expectedsum="${integrity_sums[idx],,}"
 					local realsum="$(openssl dgst -${integ} "$file")"
 					realsum="${realsum##* }"
-					if [[ $expectedsum = $realsum ]]; then
+					if [[ $expectedsum = "$realsum" ]]; then
 						printf -- "$(gettext "Passed")\n" >&2
 					else
 						printf -- "$(gettext "FAILED")\n" >&2
@@ -838,10 +1258,10 @@
 
 		local ret=0
 		msg2 "$(gettext "Extracting %s with %s")" "$file" "$cmd"
-		if [[ $cmd = bsdtar ]]; then
+		if [[ $cmd = "bsdtar" ]]; then
 			$cmd -xf "$file" || ret=$?
 		else
-			rm -f "${file%.*}"
+			rm -f -- "${file%.*}"
 			$cmd -dcf "$file" > "${file%.*}" || ret=$?
 		fi
 		if (( ret )); then
@@ -870,6 +1290,40 @@
 	exit 2 # $E_BUILD_FAILED
 }
 
+cd_safe() {
+	if ! cd "$1"; then
+		error "$(gettext "Failed to change to directory %s")" "$1"
+		plain "$(gettext "Aborting...")"
+		exit 1
+	fi
+}
+
+source_safe() {
+	shopt -u extglob
+	if ! source "$@"; then
+		error "$(gettext "Failed to source %s")" "$1"
+		exit 1
+	fi
+	shopt -s extglob
+}
+
+run_function_safe() {
+	local restoretrap
+
+	set -e
+	set -E
+
+	restoretrap=$(trap -p ERR)
+	trap 'error_function $pkgfunc' ERR
+
+	run_function "$1"
+
+	eval $restoretrap
+
+	set +E
+	set +e
+}
+
 run_function() {
 	if [[ -z $1 ]]; then
 		return 1
@@ -877,25 +1331,24 @@
 	local pkgfunc="$1"
 
 	# clear user-specified buildflags if requested
-	if [[ $(check_option buildflags) = "n" ]]; then
-		unset CFLAGS CXXFLAGS LDFLAGS
+	if check_option "buildflags" "n"; then
+		unset CPPFLAGS CFLAGS CXXFLAGS LDFLAGS
 	fi
 
 	# clear user-specified makeflags if requested
-	if [[ $(check_option makeflags) = "n" ]]; then
+	if check_option "makeflags" "n"; then
 		unset MAKEFLAGS
 	fi
 
 	msg "$(gettext "Starting %s()...")" "$pkgfunc"
-	cd "$srcdir"
+	cd_safe "$srcdir"
 
 	# ensure all necessary build variables are exported
-	export CFLAGS CXXFLAGS LDFLAGS MAKEFLAGS CHOST
+	export CPPFLAGS CFLAGS CXXFLAGS LDFLAGS MAKEFLAGS CHOST
 	# save our shell options so pkgfunc() can't override what we need
 	local shellopts=$(shopt -p)
 
 	local ret=0
-	local restoretrap
 	if (( LOGGING )); then
 		local fullver=$(get_full_version)
 		local BUILDLOG="${startdir}/${pkgbase}-${fullver}-${CARCH}-$pkgfunc.log"
@@ -917,40 +1370,38 @@
 		tee "$BUILDLOG" < "$logpipe" &
 		local teepid=$!
 
-		restoretrap=$(trap -p ERR)
-		trap 'error_function $pkgfunc' ERR
 		$pkgfunc &>"$logpipe"
-		eval $restoretrap
 
 		wait $teepid
 		rm "$logpipe"
 	else
-		restoretrap=$(trap -p ERR)
-		trap 'error_function $pkgfunc' ERR
 		$pkgfunc 2>&1
-		eval $restoretrap
 	fi
 	# reset our shell options
 	eval "$shellopts"
 }
 
+run_prepare() {
+	run_function_safe "prepare"
+}
+
 run_build() {
 	# use distcc if it is requested (check buildenv and PKGBUILD opts)
-	if [[ $(check_buildenv distcc) = "y" && $(check_option distcc) != "n" ]]; then
+	if check_buildenv "distcc" "y" && ! check_option "distc" "n"; then
 		[[ -d /usr/lib/distcc/bin ]] && export PATH="/usr/lib/distcc/bin:$PATH"
 		export DISTCC_HOSTS
 	fi
 
 	# use ccache if it is requested (check buildenv and PKGBUILD opts)
-	if [[ $(check_buildenv ccache) = "y" && $(check_option ccache) != "n" ]]; then
+	if check_buildenv "ccache" "y" && ! check_option "ccache" "n"; then
 		[[ -d /usr/lib/ccache/bin ]] && export PATH="/usr/lib/ccache/bin:$PATH"
 	fi
 
-	run_function "build"
+	run_function_safe "build"
 }
 
 run_check() {
-	run_function "check"
+	run_function_safe "check"
 }
 
 run_package() {
@@ -961,73 +1412,65 @@
 		pkgfunc="package_$1"
 	fi
 
-	run_function "$pkgfunc"
+	run_function_safe "$pkgfunc"
 }
 
 tidy_install() {
-	cd "$pkgdir"
+	cd_safe "$pkgdir"
 	msg "$(gettext "Tidying install...")"
 
-	if [[ $(check_option docs) = "n" && -n ${DOC_DIRS[*]} ]]; then
+	if check_option "docs" "n" && [[ -n ${DOC_DIRS[*]} ]]; then
 		msg2 "$(gettext "Removing doc files...")"
-		rm -rf ${DOC_DIRS[@]}
+		rm -rf -- ${DOC_DIRS[@]}
 	fi
 
-	if [[ $(check_option purge) = "y" && -n ${PURGE_TARGETS[*]} ]]; then
+	if check_option "purge" "y" && [[ -n ${PURGE_TARGETS[*]} ]]; then
 		msg2 "$(gettext "Purging unwanted files...")"
 		local pt
 		for pt in "${PURGE_TARGETS[@]}"; do
-			if [[ ${pt} = ${pt//\/} ]]; then
-				find . -type f -name "${pt}" -exec rm -f -- '{}' \;
+			if [[ ${pt} = "${pt//\/}" ]]; then
+				find . ! -type d -name "${pt}" -exec rm -f -- '{}' \;
 			else
 				rm -f ${pt}
 			fi
 		done
 	fi
 
-	if [[ $(check_option zipman) = "y" && -n ${MAN_DIRS[*]} ]]; then
+	if check_option "zipman" "y" && [[ -n ${MAN_DIRS[*]} ]]; then
 		msg2 "$(gettext "Compressing man and info pages...")"
-		local manpage ext file link hardlinks hl
-		find ${MAN_DIRS[@]} -type f 2>/dev/null |
-		while read manpage ; do
-			ext="${manpage##*.}"
-			file="${manpage##*/}"
-			if [[ $ext != gz && $ext != bz2 ]]; then
-				# update symlinks to this manpage
-				find ${MAN_DIRS[@]} -lname "$file" 2>/dev/null |
-				while read link ; do
+		local file files inode link
+		while read -rd ' ' inode; do
+			read file
+			find ${MAN_DIRS[@]} -type l 2>/dev/null |
+			while read link ; do
+				if [[ "${file}" -ef "${link}" ]] ; then
 					rm -f "$link" "${link}.gz"
-					ln -s "${file}.gz" "${link}.gz"
-				done
-
-				# check file still exists (potentially already compressed due to hardlink)
-				if [[ -f ${manpage} ]]; then
-					# find hard links and remove them
-					#   the '|| true' part keeps the script from bailing on the EOF returned
-					#   by read at the end of the find output
-					IFS=$'\n' read -rd '' -a hardlinks < \
-						<(find ${MAN_DIRS[@]} \! -name "$file" -samefile "$manpage" \
-								2>/dev/null || true) || true
-					rm -f "${hardlinks[@]}"
-					# compress the original
-					gzip -9 "$manpage"
-					# recreate hard links removed earlier
-					for hl in "${hardlinks[@]}"; do
-						ln "${manpage}.gz" "${hl}.gz"
-						chmod 644 ${hl}.gz
-					done
+					if [[ ${file%/*} = ${link%/*} ]]; then
+						ln -s -- "${file##*/}.gz" "${link}.gz"
+					else
+						ln -s -- "/${file}.gz" "${link}.gz"
+					fi
 				fi
+			done
+			if [[ -z ${files[$inode]} ]]; then
+				files[$inode]=$file
+				gzip -9 -n -f "$file"
+			else
+				rm -f "$file"
+				ln "${files[$inode]}.gz" "${file}.gz"
+				chmod 644 "${file}.gz"
 			fi
-		done
+		done < <(find ${MAN_DIRS[@]} -type f \! -name "*.gz" \! -name "*.bz2" \
+			-exec @INODECMD@ '{}' + 2>/dev/null)
 	fi
 
-	if [[ $(check_option strip) = y ]]; then
+	if check_option "strip" "y"; then
 		msg2 "$(gettext "Stripping unneeded symbols from binaries and libraries...")"
 		# make sure library stripping variables are defined to prevent excess stripping
 		[[ -z ${STRIP_SHARED+x} ]] && STRIP_SHARED="-S"
 		[[ -z ${STRIP_STATIC+x} ]] && STRIP_STATIC="-S"
 		local binary
-		find . -type f -perm -u+w 2>/dev/null | while read binary ; do
+		find . -type f -perm -u+w -print0 2>/dev/null | while read -d '' binary ; do
 			case "$(file -bi "$binary")" in
 				*application/x-sharedlib*)  # Libraries (.so)
 					strip $STRIP_SHARED "$binary";;
@@ -1039,17 +1482,17 @@
 		done
 	fi
 
-	if [[ $(check_option libtool) = "n" ]]; then
+	if check_option "libtool" "n"; then
 		msg2 "$(gettext "Removing "%s" files...")" "libtool"
 		find . ! -type d -name "*.la" -exec rm -f -- '{}' \;
 	fi
 
-	if [[ $(check_option emptydirs) = "n" ]]; then
+	if check_option "emptydirs" "n"; then
 		msg2 "$(gettext "Removing empty directories...")"
-		find . -depth -type d -empty -delete
+		find . -depth -type d -exec rmdir '{}' + 2>/dev/null
 	fi
 
-	if [[ $(check_option upx) = "y" ]]; then
+	if check_option "upx" "y"; then
 		msg2 "$(gettext "Compressing binaries with %s...")" "UPX"
 		local binary
 		find . -type f -perm -u+w 2>/dev/null | while read binary ; do
@@ -1062,12 +1505,29 @@
 }
 
 find_libdepends() {
-	local libdepends
-	find "$pkgdir" -type f -perm -u+x | while read filename
-	do
+	local d sodepends;
+
+	sodepends=0;
+	for d in "${depends[@]}"; do
+		if [[ $d = *.so ]]; then
+			sodepends=1;
+			break;
+		fi
+	done
+
+	if (( sodepends == 0 )); then
+		printf '%s\n' "${depends[@]}"
+		return;
+	fi
+
+	local libdeps filename soarch sofile soname soversion;
+	declare -A libdeps;
+
+	while read filename; do
 		# get architecture of the file; if soarch is empty it's not an ELF binary
 		soarch=$(LC_ALL=C readelf -h "$filename" 2>/dev/null | sed -n 's/.*Class.*ELF\(32\|64\)/\1/p')
-		[ -n "$soarch" ] || continue
+		[[ -n "$soarch" ]] || continue
+
 		# process all libraries needed by the binary
 		for sofile in $(LC_ALL=C readelf -d "$filename" 2>/dev/null | sed -nr 's/.*Shared library: \[(.*)\].*/\1/p')
 		do
@@ -1075,42 +1535,97 @@
 			soname="${sofile%.so?(+(.+([0-9])))}".so
 			# extract the major version: 1
 			soversion="${sofile##*\.so\.}"
-			if in_array "${soname}" ${depends[@]}; then
-				if ! in_array "${soname}=${soversion}-${soarch}" ${libdepends[@]}; then
-					# libfoo.so=1-64
-					echo "${soname}=${soversion}-${soarch}"
-					libdepends=(${libdepends[@]} "${soname}=${soversion}-${soarch}")
+
+			if [[ ${libdeps[$soname]} ]]; then
+				if [[ ${libdeps[$soname]} != *${soversion}-${soarch}* ]]; then
+					libdeps[$soname]+=" ${soversion}-${soarch}"
 				fi
+			else
+				libdeps[$soname]="${soversion}-${soarch}"
 			fi
 		done
+	done < <(find "$pkgdir" -type f -perm -u+x)
+
+	local libdepends v
+	for d in "${depends[@]}"; do
+		case "$d" in
+			*.so)
+				if [[ ${libdeps[$d]} ]]; then
+					for v in ${libdeps[$d]}; do
+						libdepends+=("$d=$v")
+					done
+				else
+					warning "$(gettext "Library listed in %s is not required by any files: %s")" "'depends'" "$d"
+					libdepends+=("$d")
+				fi
+				;;
+			*)
+				libdepends+=("$d")
+				;;
+		esac
 	done
+
+	printf '%s\n' "${libdepends[@]}"
 }
 
-find_libprovides() {
-	local libprovides
-	find "$pkgdir" -type f -name \*.so\* | while read filename
-	do
-		# check if we really have a shared object
-		if LC_ALL=C readelf -h "$filename" 2>/dev/null | grep -q '.*Type:.*DYN (Shared object file).*'; then
-			# 64
-			soarch=$(LC_ALL=C readelf -h "$filename" | sed -n 's/.*Class.*ELF\(32\|64\)/\1/p')
-			# get the string binaries link to: libfoo.so.1.2 -> libfoo.so.1
-			sofile=$(LC_ALL=C readelf -d "$filename" 2>/dev/null | sed -n 's/.*Library soname: \[\(.*\)\].*/\1/p')
-			[ -z "$sofile" ] && sofile="${filename##*/}"
 
-			# extract the library name: libfoo.so
-			soname="${sofile%%\.so\.*}.so"
-			# extract the major version: 1
-			soversion="${sofile##*\.so\.}"
-			if in_array "${soname}" ${provides[@]}; then
-				if ! in_array "${soname}=${soversion}-${soarch}" ${libprovides[@]}; then
-					# libfoo.so=1-64
-					echo "${soname}=${soversion}-${soarch}"
-					libprovides=(${libprovides[@]} "${soname}=${soversion}-${soarch}")
+find_libprovides() {
+	local p libprovides missing
+	for p in "${provides[@]}"; do
+		missing=0
+		case "$p" in
+			*.so)
+				mapfile -t filename < <(find "$pkgdir" -type f -name $p\*)
+				if [[ $filename ]]; then
+					# packages may provide multiple versions of the same library
+					for fn in "${filename[@]}"; do
+						# check if we really have a shared object
+						if LC_ALL=C readelf -h "$fn" 2>/dev/null | grep -q '.*Type:.*DYN (Shared object file).*'; then
+							# get the string binaries link to (e.g. libfoo.so.1.2 -> libfoo.so.1)
+							local sofile=$(LC_ALL=C readelf -d "$fn" 2>/dev/null | sed -n 's/.*Library soname: \[\(.*\)\].*/\1/p')
+							if [[ -z "$sofile" ]]; then
+								warning "$(gettext "Library listed in %s is not versioned: %s")" "'provides'" "$p"
+								libprovides+=("$p")
+								continue
+							fi
+
+							# get the library architecture (32 or 64 bit)
+							local soarch=$(LC_ALL=C readelf -h "$fn" | sed -n 's/.*Class.*ELF\(32\|64\)/\1/p')
+
+							# extract the library major version
+							local soversion="${sofile##*\.so\.}"
+
+							libprovides+=("${p}=${soversion}-${soarch}")
+						else
+							warning "$(gettext "Library listed in %s is not a shared object: %s")" "'provides'" "$p"
+							libprovides+=("$p")
+						fi
+					done
+				else
+					libprovides+=("$p")
+					missing=1
 				fi
-			fi
-    fi
+				;;
+			*)
+				libprovides+=("$p")
+				;;
+		esac
+
+		if (( missing )); then
+			warning "$(gettext "Can not find library listed in %s: %s")" "'provides'" "$p"
+		fi
 	done
+
+	printf '%s\n' "${libprovides[@]}"
+}
+
+check_license() {
+	# TODO maybe remove this at some point
+	# warn if license array is not present or empty
+	if [[ -z $license ]]; then
+		warning "$(gettext "Please add a license line to your %s!")" "$BUILDSCRIPT"
+		plain "$(gettext "Example for GPL\'ed software: %s.")" "license=('GPL')"
+	fi
 }
 
 write_pkginfo() {
@@ -1130,84 +1645,53 @@
 	size="$(( ${size%%[^0-9]*} * 1024 ))"
 
 	msg2 "$(gettext "Generating %s file...")" ".PKGINFO"
-	echo "# Generated by makepkg $myver"
+	echo "# Generated by makepkg $makepkg_version"
 	if (( INFAKEROOT )); then
 		echo "# using $(fakeroot -v)"
 	fi
 	echo "# $(LC_ALL=C date -u)"
-	echo "pkgname = $1"
+	printf "pkgname = %s\n" "$1"
 	(( SPLITPKG )) && echo pkgbase = $pkgbase
 	echo "pkgver = $(get_full_version)"
-	echo "pkgdesc = $pkgdesc"
-	echo "url = $url"
-	echo "builddate = $builddate"
-	echo "packager = $packager"
-	echo "size = $size"
-	echo "arch = $PKGARCH"
-
-	[[ $license ]]    && printf "license = %s\n"   "${license[@]}"
-	[[ $replaces ]]   && printf "replaces = %s\n"  "${replaces[@]}"
-	[[ $groups ]]     && printf "group = %s\n"     "${groups[@]}"
-	[[ $optdepends ]] && printf "optdepend = %s\n" "${optdepends[@]//+([[:space:]])/ }"
-	[[ $conflicts ]]  && printf "conflict = %s\n"  "${conflicts[@]}"
-	[[ $backup ]]     && printf "backup = %s\n"    "${backup[@]}"
+	printf "pkgdesc = %s\n" "$pkgdesc"
+	printf "url = %s\n" "$url"
+	printf "builddate = %s\n" "$builddate"
+	printf "packager = %s\n" "$packager"
+	printf "size = %s\n" "$size"
+	printf "arch = %s\n" "$pkgarch"
+
+	mapfile -t provides < <(find_libprovides)
+	mapfile -t depends < <(find_libdepends)
+
+	[[ $license ]]      && printf "license = %s\n"     "${license[@]}"
+	[[ $replaces ]]     && printf "replaces = %s\n"    "${replaces[@]}"
+	[[ $groups ]]       && printf "group = %s\n"       "${groups[@]}"
+	[[ $conflicts ]]    && printf "conflict = %s\n"    "${conflicts[@]}"
+	[[ $provides ]]     && printf "provides = %s\n"    "${provides[@]}"
+	[[ $backup ]]       && printf "backup = %s\n"      "${backup[@]}"
+	[[ $depends ]]      && printf "depend = %s\n"      "${depends[@]}"
+	[[ $optdepends ]]   && printf "optdepend = %s\n"   "${optdepends[@]//+([[:space:]])/ }"
+	[[ $makedepends ]]  && printf "makedepend = %s\n"  "${makedepends[@]}"
+	[[ $checkdepends ]] && printf "checkdepend = %s\n" "${checkdepends[@]}"
 
 	local it
-
-	libprovides=$(find_libprovides)
-	libdepends=$(find_libdepends)
-	provides=("${provides[@]}" ${libprovides})
-	depends=("${depends[@]}" ${libdepends})
-
-	for it in "${depends[@]}"; do
-		if [[ $it = *.so ]]; then
-			# check if the entry has been found by find_libdepends
-			# if not, it's unneeded; tell the user so he can remove it
-			printf -v re '(^|\s)%s=.*' "$it"
-			if [[ ! $libdepends =~ $re ]]; then
-				error "$(gettext "Cannot find library listed in %s: %s")" "'depends'" "$it"
-				return 1
-			fi
-		else
-			echo "depend = $it"
-		fi
-	done
-
-	for it in "${provides[@]}"; do
-		# ignore versionless entires (those come from the PKGBUILD)
-		if [[ $it  = *.so ]]; then
-			# check if the entry has been found by find_libprovides
-			# if not, it's unneeded; tell the user so he can remove it
-			if [[ ! $libprovides =~ (^|\s)${it}=.* ]]; then
-				error "$(gettext "Cannot find library listed in %s: %s")" "'provides'" "$it"
-				return 1
-			fi
-		else
-			echo "provides = $it"
-		fi
-	done
-
 	for it in "${packaging_options[@]}"; do
-		local ret="$(check_option $it)"
-		if [[ $ret != "?" ]]; then
-			if [[ $ret = y ]]; then
-				echo "makepkgopt = $it"
-			else
-				echo "makepkgopt = !$it"
-			fi
-		fi
+		check_option "$it" "y"
+		case $? in
+			0)
+				printf "makepkgopt = %s\n" "$it"
+				;;
+			1)
+				printf "makepkgopt = %s\n" "!$it"
+				;;
+		esac
 	done
 
-	# TODO maybe remove this at some point
-	# warn if license array is not present or empty
-	if [[ -z $license ]]; then
-		warning "$(gettext "Please add a license line to your %s!")" "$BUILDSCRIPT"
-		plain "$(gettext "Example for GPL\'ed software: %s.")" "license=('GPL')"
-	fi
+	check_license
 }
 
 check_package() {
-	cd "$pkgdir"
+	cd_safe "$pkgdir"
 
 	# check existence of backup files
 	local file
@@ -1236,7 +1720,7 @@
 
 	check_package
 
-	cd "$pkgdir"
+	cd_safe "$pkgdir"
 	msg "$(gettext "Creating package...")"
 
 	local nameofpkg
@@ -1246,15 +1730,11 @@
 		nameofpkg="$1"
 	fi
 
-	if [[ $arch = "any" ]]; then
-		PKGARCH="any"
-	else
-		PKGARCH=$CARCH
-	fi
+	pkgarch=$(get_pkg_arch)
 
 	write_pkginfo $nameofpkg > .PKGINFO
 
-	local comp_files=".PKGINFO"
+	local comp_files=('.PKGINFO')
 
 	# check for changelog/install files
 	for i in 'changelog/.CHANGELOG' 'install/.INSTALL'; do
@@ -1264,7 +1744,7 @@
 			msg2 "$(gettext "Adding %s file...")" "$orig"
 			cp "$startdir/${!orig}" "$dest"
 			chmod 644 "$dest"
-			comp_files+=" $dest"
+			comp_files+=("$dest")
 		fi
 	done
 
@@ -1272,7 +1752,7 @@
 	msg2 "$(gettext "Compressing package...")"
 
 	local fullver=$(get_full_version)
-	local pkg_file="$PKGDEST/${nameofpkg}-${fullver}-${PKGARCH}${PKGEXT}"
+	local pkg_file="$PKGDEST/${nameofpkg}-${fullver}-${pkgarch}${PKGEXT}"
 	local ret=0
 
 	[[ -f $pkg_file ]] && rm -f "$pkg_file"
@@ -1286,12 +1766,12 @@
 	# bsdtar's gzip compression always saves the time stamp, making one
 	# archive created using the same command line distinct from another.
 	# Disable bsdtar compression and use gzip -n for now.
-	bsdtar -cf - $comp_files * |
+	bsdtar -cf - "${comp_files[@]}" * |
 	case "$PKGEXT" in
-		*tar.gz)  gzip -c -f -n ;;
-		*tar.bz2) bzip2 -c -f ;;
-		*tar.xz)  xz -c -z - ;;
-		*tar.Z)   compress -c -f ;;
+		*tar.gz)  ${COMPRESSGZ[@]:-gzip -c -f -n} ;;
+		*tar.bz2) ${COMPRESSBZ2[@]:-bzip2 -c -f} ;;
+		*tar.xz)  ${COMPRESSXZ[@]:-xz -c -z -} ;;
+		*tar.Z)   ${COMPRESSZ[@]:-compress -c -f} ;;
 		*tar)     cat ;;
 		*) warning "$(gettext "'%s' is not a valid archive extension.")" \
 			"$PKGEXT"; cat ;;
@@ -1351,12 +1831,14 @@
 	local srclinks="$(mktemp -d "$startdir"/srclinks.XXXXXXXXX)"
 	mkdir "${srclinks}"/${pkgbase}
 
+	check_license
+
 	msg2 "$(gettext "Adding %s...")" "$BUILDSCRIPT"
 	ln -s "${BUILDFILE}" "${srclinks}/${pkgbase}/${BUILDSCRIPT}"
 
 	local file
 	for file in "${source[@]}"; do
-		if [[ "$file" == $(get_filename "$file") ]] || (( SOURCEONLY == 2 )); then
+		if [[ "$file" = "$(get_filename "$file")" ]] || (( SOURCEONLY == 2 )); then
 			local absfile
 			absfile=$(get_filepath "$file") || missing_source_file "$file"
 			msg2 "$(gettext "Adding %s...")" "${absfile##*/}"
@@ -1393,7 +1875,7 @@
 
 	# tar it up
 	msg2 "$(gettext "Compressing source package...")"
-	cd "${srclinks}"
+	cd_safe "${srclinks}"
 	if ! bsdtar -c${TAR_OPT}Lf "$pkg_file" ${pkgbase}; then
 		error "$(gettext "Failed to create source package file.")"
 		exit 1 # TODO: error code
@@ -1409,7 +1891,7 @@
 		warning "$(gettext "Failed to create symlink to source package file.")"
 	fi
 
-	cd "${startdir}"
+	cd_safe "${startdir}"
 	rm -rf "${srclinks}"
 }
 
@@ -1422,17 +1904,16 @@
 		msg "$(gettext "Installing %s package group with %s...")" "$pkgbase" "$PACMAN -U"
 	fi
 
-	local fullver pkg pkglist
+	local fullver pkgarch pkg pkglist
+	(( ASDEPS )) && pkglist+=('--asdeps')
+
 	for pkg in ${pkgname[@]}; do
 		fullver=$(get_full_version $pkg)
-		if [[ -f $PKGDEST/${pkg}-${fullver}-${CARCH}${PKGEXT} ]]; then
-			pkglist+=" $PKGDEST/${pkg}-${fullver}-${CARCH}${PKGEXT}"
-		else
-			pkglist+=" $PKGDEST/${pkg}-${fullver}-any${PKGEXT}"
-		fi
+		pkgarch=$(get_pkg_arch $pkg)
+		pkglist+=("$PKGDEST/${pkg}-${fullver}-${pkgarch}${PKGEXT}")
 	done
 
-	if ! run_pacman -U $pkglist; then
+	if ! run_pacman -U ${pkglist[@]}; then
 		warning "$(gettext "Failed to install built package(s).")"
 		return 0
 	fi
@@ -1442,7 +1923,7 @@
 	# check for no-no's in the build script
 	local i
 	local ret=0
-	for i in 'pkgname' 'pkgrel' 'pkgver'; do
+	for i in 'pkgname' 'pkgrel'; do
 		if [[ -z ${!i} ]]; then
 			error "$(gettext "%s is not allowed to be empty.")" "$i"
 			ret=1
@@ -1454,6 +1935,11 @@
 			error "$(gettext "%s is not allowed to start with a hyphen.")" "pkgname"
 			ret=1
 		fi
+		if [[ $i = *[^[:alnum:]+_.@-]* ]]; then
+			error "$(gettext "%s contains invalid characters: '%s'")" \
+					'pkgname' "${pkgname//[[:alnum:]+_.@-]}"
+			ret=1
+		fi
 	done
 
 	if [[ ${pkgbase:0:1} = "-" ]]; then
@@ -1461,20 +1947,15 @@
 		ret=1
 	fi
 
-	awk -F'=' '$1 ~ /^[[:space:]]*pkgver$/' "$BUILDFILE" | sed "s/[[:space:]]*#.*//" |
-	while IFS='=' read -r _ i; do
-		eval i=\"$(sed 's/^\(['\''"]\)\(.*\)\1$/\2/' <<< "${i%%+([[:space:]])}")\"
-		if [[ $i = *[[:space:]:-]* ]]; then
-			error "$(gettext "%s is not allowed to contain colons, hyphens or whitespace.")" "pkgver"
-			return 1
-		fi
-	done || ret=1
+	if (( ! PKGVERFUNC )) ; then
+		check_pkgver || ret=1
+	fi
 
 	awk -F'=' '$1 ~ /^[[:space:]]*pkgrel$/' "$BUILDFILE" | sed "s/[[:space:]]*#.*//" |
 	while IFS='=' read -r _ i; do
 		eval i=\"$(sed 's/^\(['\''"]\)\(.*\)\1$/\2/' <<< "${i%%+([[:space:]])}")\"
-		if [[ $i = *[[:space:]-]* ]]; then
-			error "$(gettext "%s is not allowed to contain hyphens or whitespace.")" "pkgrel"
+		if [[ $i != +([0-9])?(.+([0-9])) ]]; then
+			error "$(gettext "%s must be a decimal.")" "pkgrel"
 			return 1
 		fi
 	done || ret=1
@@ -1566,7 +2047,7 @@
 		known=0
 		# check if option matches a known option or its inverse
 		for kopt in ${packaging_options[@]} ${other_options[@]}; do
-			if [[ ${i} = ${kopt} || ${i} = "!${kopt}" ]]; then
+			if [[ ${i} = "${kopt}" || ${i} = "!${kopt}" ]]; then
 				known=1
 			fi
 		done
@@ -1598,6 +2079,26 @@
 	return $ret
 }
 
+check_pkgver() {
+	local ret=0
+
+	if [[ -z ${pkgver} ]]; then
+		error "$(gettext "%s is not allowed to be empty.")" "pkgver"
+		ret=1
+	fi
+
+	awk -F'=' '$1 ~ /^[[:space:]]*pkgver$/' "$BUILDFILE" | sed "s/[[:space:]]*#.*//" |
+	while IFS='=' read -r _ i; do
+		eval i=\"$(sed 's/^\(['\''"]\)\(.*\)\1$/\2/' <<< "${i%%+([[:space:]])}")\"
+		if [[ $i = *[[:space:]:-]* ]]; then
+			error "$(gettext "%s is not allowed to contain colons, hyphens or whitespace.")" "pkgver"
+			return 1
+		fi
+	done || ret=1
+
+	return $ret
+}
+
 check_software() {
 	# check for needed software
 	local ret=0
@@ -1605,12 +2106,12 @@
 	# check for sudo if we will need it during makepkg execution
 	if (( ! ( ASROOT || INFAKEROOT ) && ( DEP_BIN || RMDEPS || INSTALL ) )); then
 		if ! type -p sudo >/dev/null; then
-			warning "$(gettext "Sudo can not be found. Will use su to acquire root privileges.")"
+			warning "$(gettext "Cannot find the %s binary. Will use %s to acquire root privileges.")" "sudo" "su"
 		fi
 	fi
 
 	# fakeroot - building as non-root user
-	if [[ $(check_buildenv fakeroot) = "y" ]] && (( EUID > 0 )); then
+	if check_buildenv "fakeroot" "y" && (( EUID > 0 )); then
 		if ! type -p fakeroot >/dev/null; then
 			error "$(gettext "Cannot find the %s binary required for building as non-root user.")" "fakeroot"
 			ret=1
@@ -1618,7 +2119,7 @@
 	fi
 
 	# gpg - package signing
-	if [[ $SIGNPKG == 'y' || (-z "$SIGNPKG" && $(check_buildenv sign) == 'y') ]]; then
+	if [[ $SIGNPKG == 'y' ]] || { [[ -z $SIGNPKG ]] && check_buildenv "sign" "y"; }; then
 		if ! type -p gpg >/dev/null; then
 			error "$(gettext "Cannot find the %s binary required for signing packages.")" "gpg"
 			ret=1
@@ -1642,7 +2143,7 @@
 	fi
 
 	# upx - binary compression
-	if [[ $(check_option upx) == 'y' ]]; then
+	if check_option "upx" "y"; then
 		if ! type -p upx >/dev/null; then
 			error "$(gettext "Cannot find the %s binary required for compressing binaries.")" "upx"
 			ret=1
@@ -1650,7 +2151,7 @@
 	fi
 
 	# distcc - compilation with distcc
-	if [[ $(check_buildenv distcc) = "y" && $(check_option distcc) != "n" ]]; then
+	if check_buildenv "distcc" "y" && ! check_option "distcc" "n" ]]; then
 		if ! type -p distcc >/dev/null; then
 			error "$(gettext "Cannot find the %s binary required for distributed compilation.")" "distcc"
 			ret=1
@@ -1658,7 +2159,7 @@
 	fi
 
 	# ccache - compilation with ccache
-	if [[ $(check_buildenv ccache) = "y" && $(check_option ccache) != "n" ]]; then
+	if check_buildenv "ccache" "y" && ! check_option "ccache" "n"; then
 		if ! type -p ccache >/dev/null; then
 			error "$(gettext "Cannot find the %s binary required for compiler cache usage.")" "ccache"
 			ret=1
@@ -1666,7 +2167,7 @@
 	fi
 
 	# strip - strip symbols from binaries/libraries
-	if [[ $(check_option strip) = "y" ]]; then
+	if check_option "strip" "y"; then
 		if ! type -p strip >/dev/null; then
 			error "$(gettext "Cannot find the %s binary required for object file stripping.")" "strip"
 			ret=1
@@ -1674,7 +2175,7 @@
 	fi
 
 	# gzip - compressig man and info pages
-	if [[ $(check_option zipman) = "y" ]]; then
+	if check_option "zipman" "y"; then
 		if ! type -p gzip >/dev/null; then
 			error "$(gettext "Cannot find the %s binary required for compressing man and info pages.")" "gzip"
 			ret=1
@@ -1684,110 +2185,50 @@
 	return $ret
 }
 
-devel_check() {
-	newpkgver=""
-
-	# Do not update pkgver if --holdver is set, when building a source package, repackaging,
-	# reading PKGBUILD from pipe (-f), or if we cannot write to the file (-w)
-	if (( HOLDVER || SOURCEONLY || REPKG )) ||
-		[[ ! -f $BUILDFILE || ! -w $BUILDFILE || $BUILDFILE = /dev/stdin ]]; then
-		return
-	fi
-
-	if [[ -z $FORCE_VER ]]; then
-		# Check if this is a svn/cvs/etc PKGBUILD; set $newpkgver if so.
-		# This will only be used on the first call to makepkg; subsequent
-		# calls to makepkg via fakeroot will explicitly pass the version
-		# number to avoid having to determine the version number twice.
-		# Also do a check to make sure we have the VCS tool available.
-		oldpkgver=$pkgver
-		if [[ -n ${_darcstrunk} && -n ${_darcsmod} ]] ; then
-			if ! type -p darcs >/dev/null; then
-				warning "$(gettext "Cannot find the %s binary required to determine latest %s revision.")" "darcs" "darcs"
-				return 0
-			fi
-			msg "$(gettext "Determining latest %s revision...")" 'darcs'
-			newpkgver=$(date +%Y%m%d)
-		elif [[ -n ${_cvsroot} && -n ${_cvsmod} ]] ; then
-			if ! type -p cvs >/dev/null; then
-				warning "$(gettext "Cannot find the %s binary required to determine latest %s revision.")" "cvs" "cvs"
-				return 0
-			fi
-			msg "$(gettext "Determining latest %s revision...")" 'cvs'
-			newpkgver=$(date +%Y%m%d)
-		elif [[ -n ${_gitroot} && -n ${_gitname} ]] ; then
-			if ! type -p git >/dev/null; then
-				warning "$(gettext "Cannot find the %s binary required to determine latest %s revision.")" "git" "git"
-				return 0
-			fi
-			msg "$(gettext "Determining latest %s revision...")" 'git'
-			newpkgver=$(date +%Y%m%d)
-		elif [[ -n ${_svntrunk} && -n ${_svnmod} ]] ; then
-			if ! type -p svn >/dev/null; then
-				warning "$(gettext "Cannot find the %s binary required to determine latest %s revision.")" "svn" "svn"
-				return 0
-			fi
-			msg "$(gettext "Determining latest %s revision...")" 'svn'
-			newpkgver=$(LC_ALL=C svn info $_svntrunk | sed -n 's/^Last Changed Rev: \([0-9]*\)$/\1/p')
-		elif [[ -n ${_bzrtrunk} && -n ${_bzrmod} ]] ; then
-			if ! type -p bzr >/dev/null; then
-				warning "$(gettext "Cannot find the %s binary required to determine latest %s revision.")" "bzr" "bzr"
-				return 0
-			fi
-			msg "$(gettext "Determining latest %s revision...")" 'bzr'
-			newpkgver=$(bzr revno ${_bzrtrunk})
-		elif [[ -n ${_hgroot} && -n ${_hgrepo} ]] ; then
-			if ! type -p hg >/dev/null; then
-				warning "$(gettext "Cannot find the %s binary required to determine latest %s revision.")" "hg" "hg"
-				return 0
-			fi
-			msg "$(gettext "Determining latest %s revision...")" 'hg'
-			if [[ -d ./src/$_hgrepo ]] ; then
-				cd ./src/$_hgrepo
-				local ret=0
-				hg pull || ret=$?
-				if (( ! ret )); then
-					hg update
-				elif (( ret != 1 )); then
-					return 1
-				fi
+check_build_status() {
+	if (( ! SPLITPKG )); then
+		fullver=$(get_full_version)
+		pkgarch=$(get_pkg_arch)
+		if [[ -f $PKGDEST/${pkgname}-${fullver}-${pkgarch}${PKGEXT} ]] \
+				 && ! (( FORCE || SOURCEONLY || NOBUILD )); then
+			if (( INSTALL )); then
+				warning "$(gettext "A package has already been built, installing existing package...")"
+				install_package
+				exit $?
 			else
-				[[ ! -d ./src/ ]] && mkdir ./src/
-				hg clone $_hgroot/$_hgrepo ./src/$_hgrepo
-				cd ./src/$_hgrepo
+				error "$(gettext "A package has already been built. (use %s to overwrite)")" "-f"
+				exit 1
 			fi
-			newpkgver=$(hg tip --template "{rev}")
-			cd ../../
-		fi
-
-		if [[ -n $newpkgver ]]; then
-			msg2 "$(gettext "Version found: %s")" "$newpkgver"
 		fi
-
 	else
-		# Version number retrieved from fakeroot->makepkg argument
-		newpkgver=$FORCE_VER
-	fi
-}
-
-devel_update() {
-	# This is lame, but if we're wanting to use an updated pkgver for
-	# retrieving svn/cvs/etc sources, we'll update the PKGBUILD with
-	# the new pkgver and then re-source it. This is the most robust
-	# method for dealing with PKGBUILDs that use, e.g.:
-	#
-	#  pkgver=23
-	#  ...
-	#  _foo=pkgver
-	#
-	if [[ -n $newpkgver ]]; then
-		if [[ $newpkgver != "$pkgver" ]]; then
-			if [[ -f $BUILDFILE && -w $BUILDFILE ]]; then
-				@SEDINPLACE@ "s/^pkgver=[^ ]*/pkgver=$newpkgver/" "$BUILDFILE"
-				@SEDINPLACE@ "s/^pkgrel=[^ ]*/pkgrel=1/" "$BUILDFILE"
-				source "$BUILDFILE"
+		allpkgbuilt=1
+		somepkgbuilt=0
+		for pkg in ${pkgname[@]}; do
+			fullver=$(get_full_version $pkg)
+			pkgarch=$(get_pkg_arch $pkg)
+			if [[ -f $PKGDEST/${pkg}-${fullver}-${pkgarch}${PKGEXT} ]]; then
+				somepkgbuilt=1
+			else
+				allpkgbuilt=0
+			fi
+		done
+		if ! (( FORCE || SOURCEONLY || NOBUILD )); then
+			if (( allpkgbuilt )); then
+				if (( INSTALL )); then
+					warning "$(gettext "The package group has already been built, installing existing packages...")"
+					install_package
+					exit $?
+				else
+					error "$(gettext "The package group has already been built. (use %s to overwrite)")" "-f"
+					exit 1
+				fi
+			fi
+			if (( somepkgbuilt && ! PKGVERFUNC )); then
+				error "$(gettext "Part of the package group has already been built. (use %s to overwrite)")" "-f"
+				exit 1
 			fi
 		fi
+		unset allpkgbuilt somepkgbuilt
 	fi
 }
 
@@ -1833,18 +2274,26 @@
 
 	if [[ -d $path ]]; then
 		(
-			cd "$path"
+			cd_safe "$path"
 			pwd -P
 		)
 	else
-		echo "$path"
+		printf "%s\n" "$path"
 	fi
 }
 
-m4_include(library/parse_options.sh)
+dir_is_empty() {
+	(
+		shopt -s dotglob nullglob
+		files=("$1"/*)
+		(( ${#files} == 0 ))
+	)
+}
+
+m4_include(library/parseopts.sh)
 
 usage() {
-	printf "makepkg (pacman) %s\n" "$myver"
+	printf "makepkg (pacman) %s\n" "$makepkg_version"
 	echo
 	printf -- "$(gettext "Usage: %s [options]")\n" "$0"
 	echo
@@ -1869,7 +2318,7 @@
 	printf -- "$(gettext "  --asroot         Allow %s to run as root user")\n" "makepkg"
 	printf -- "$(gettext "  --check          Run the %s function in the %s")\n" "check()" "$BUILDSCRIPT"
 	printf -- "$(gettext "  --config <file>  Use an alternate config file (instead of '%s')")\n" "$confdir/makepkg.conf"
-	printf -- "$(gettext "  --holdver        Prevent automatic version bumping for development %ss")\n" "$BUILDSCRIPT"
+	printf -- "$(gettext "  --holdver        Do not update VCS sources")\n"
 	printf -- "$(gettext "  --key <key>      Specify a key to use for %s signing instead of the default")\n" "gpg"
 	printf -- "$(gettext "  --nocheck        Do not run the %s function in the %s")\n" "check()" "$BUILDSCRIPT"
 	printf -- "$(gettext "  --nosign         Do not create a signature for the package")\n"
@@ -1881,6 +2330,7 @@
 	echo
 	printf -- "$(gettext "These options can be passed to %s:")\n" "pacman"
 	echo
+	printf -- "$(gettext "  --asdeps         Install packages as non-explicitly installed")\n"
 	printf -- "$(gettext "  --noconfirm      Do not ask for confirmation when resolving dependencies")\n"
 	printf -- "$(gettext "  --noprogressbar  Do not show a progress bar when downloading files")\n"
 	echo
@@ -1889,7 +2339,7 @@
 }
 
 version() {
-	printf "makepkg (pacman) %s\n" "$myver"
+	printf "makepkg (pacman) %s\n" "$makepkg_version"
 	printf -- "$(gettext "\
 Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>.\n\
 Copyright (C) 2002-2006 Judd Vinet <jvinet@zeroflux.org>.\n\n\
@@ -1902,7 +2352,7 @@
 # determine whether we have gettext; make it a no-op if we do not
 if ! type -p gettext >/dev/null; then
 	gettext() {
-		echo "$@"
+		printf "%s\n" "$@"
 	}
 fi
 
@@ -1910,23 +2360,25 @@
 
 # Parse Command Line Options.
 OPT_SHORT="AcdefFghiLmop:rRsSV"
-OPT_LONG="allsource,asroot,ignorearch,check,clean,nodeps"
-OPT_LONG+=",noextract,force,forcever:,geninteg,help,holdver,skippgpcheck"
-OPT_LONG+=",install,key:,log,nocolor,nobuild,nocheck,nosign,pkg:,rmdeps"
-OPT_LONG+=",repackage,skipchecksums,skipinteg,skippgpcheck,sign,source,syncdeps"
-OPT_LONG+=",version,config:"
+OPT_LONG=('allsource' 'asroot' 'check' 'clean' 'config:' 'force' 'geninteg'
+          'help' 'holdver' 'ignorearch' 'install' 'key:' 'log' 'nobuild' 'nocolor'
+          'nocheck' 'nodeps' 'noextract' 'nosign' 'pkg:' 'repackage' 'rmdeps'
+          'skipchecksums' 'skipinteg' 'skippgpcheck' 'skippgpcheck' 'sign'
+          'source' 'syncdeps' 'version')
 
 # Pacman Options
-OPT_LONG+=",noconfirm,noprogressbar"
-if ! OPT_TEMP="$(parse_options $OPT_SHORT $OPT_LONG "$@")"; then
-	echo; usage; exit 1 # E_INVALID_OPTION;
+OPT_LONG+=('asdeps' 'noconfirm' 'noprogressbar')
+
+if ! parseopts "$OPT_SHORT" "${OPT_LONG[@]}" -- "$@"; then
+	exit 1 # E_INVALID_OPTION;
 fi
-eval set -- "$OPT_TEMP"
-unset OPT_SHORT OPT_LONG OPT_TEMP
+set -- "${OPTRET[@]}"
+unset OPT_SHORT OPT_LONG OPTRET
 
 while true; do
 	case "$1" in
 		# Pacman Options
+		--asdeps)         ASDEPS=1;;
 		--noconfirm)      PACMAN_OPTS+=" --noconfirm" ;;
 		--noprogressbar)  PACMAN_OPTS+=" --noprogressbar" ;;
 
@@ -1940,8 +2392,6 @@
 		-d|--nodeps)      NODEPS=1 ;;
 		-e|--noextract)   NOEXTRACT=1 ;;
 		-f|--force)       FORCE=1 ;;
-		#hidden opt used by fakeroot call for svn/cvs/etc PKGBUILDs to set pkgver
-		--forcever)       shift; FORCE_VER=$1;;
 		-F)               INFAKEROOT=1 ;;
 		-g|--geninteg)    GENINTEG=1 ;;
 		--holdver)        HOLDVER=1 ;;
@@ -1953,7 +2403,7 @@
 		--nosign)         SIGNPKG='n' ;;
 		-o|--nobuild)     NOBUILD=1 ;;
 		-p)               shift; BUILDFILE=$1 ;;
-		--pkg)            shift; PKGLIST=($1) ;;
+		--pkg)            shift; IFS=, read -ra p <<<"$1"; PKGLIST+=("${p[@]}"); unset p ;;
 		-r|--rmdeps)      RMDEPS=1 ;;
 		-R|--repackage)   REPKG=1 ;;
 		--skipchecksums)  SKIPCHECKSUMS=1 ;;
@@ -1966,8 +2416,7 @@
 		-h|--help)        usage; exit 0 ;; # E_OK
 		-V|--version)     version; exit 0 ;; # E_OK
 
-		--)               OPT_IND=0; shift; break;;
-		*)                usage; exit 1 ;; # E_INVALID_OPTION
+		--)               OPT_IND=0; shift; break 2;;
 	esac
 	shift
 done
@@ -1979,7 +2428,6 @@
 done
 trap 'trap_exit INT "$(gettext "Aborted by user! Exiting...")"' INT
 trap 'trap_exit USR1 "$(gettext "An unknown error has occurred. Exiting...")"' ERR
-set -E
 
 # preserve environment variables and canonicalize path
 [[ -n ${PKGDEST} ]] && _PKGDEST=$(canonicalize_path ${PKGDEST})
@@ -1989,13 +2437,14 @@
 [[ -n ${PKGEXT} ]] && _PKGEXT=${PKGEXT}
 [[ -n ${SRCEXT} ]] && _SRCEXT=${SRCEXT}
 [[ -n ${GPGKEY} ]] && _GPGKEY=${GPGKEY}
+[[ -n ${PACKAGER} ]] && _PACKAGER=${PACKAGER}
 
 # default config is makepkg.conf
 MAKEPKG_CONF=${MAKEPKG_CONF:-$confdir/makepkg.conf}
 
 # Source the config file; fail if it is not found
 if [[ -r $MAKEPKG_CONF ]]; then
-	source "$MAKEPKG_CONF"
+	source_safe "$MAKEPKG_CONF"
 else
 	error "$(gettext "%s not found.")" "$MAKEPKG_CONF"
 	plain "$(gettext "Aborting...")"
@@ -2005,7 +2454,7 @@
 # Source user-specific makepkg.conf overrides, but only if no override config
 # file was specified
 if [[ $MAKEPKG_CONF = "$confdir/makepkg.conf" && -r ~/.makepkg.conf ]]; then
-	source ~/.makepkg.conf
+	source_safe ~/.makepkg.conf
 fi
 
 # set pacman command if not already defined
@@ -2013,7 +2462,7 @@
 
 # check if messages are to be printed using color
 unset ALL_OFF BOLD BLUE GREEN RED YELLOW
-if [[ -t 2 && ! $USE_COLOR = "n" && $(check_buildenv color) = "y" ]]; then
+if [[ -t 2 && ! $USE_COLOR = "n" ]] && check_buildenv "color" "y"; then
 	# prefer terminal safe colored and bold text when tput is supported
 	if tput setaf 0 &>/dev/null; then
 		ALL_OFF="$(tput sgr0)"
@@ -2037,8 +2486,11 @@
 BUILDDIR=${_BUILDDIR:-$BUILDDIR}
 BUILDDIR=${BUILDDIR:-$startdir} #default to $startdir if undefined
 if [[ ! -d $BUILDDIR ]]; then
-	mkdir -p "$BUILDDIR" ||
-			error "$(gettext "You do not have write permission to create packages in %s.")" "$BUILDDIR"
+	if ! mkdir -p "$BUILDDIR"; then
+		error "$(gettext "You do not have write permission to create packages in %s.")" "$BUILDDIR"
+		plain "$(gettext "Aborting...")"
+		exit 1
+	fi
 	chmod a-s "$BUILDDIR"
 fi
 if [[ ! -w $BUILDDIR ]]; then
@@ -2046,8 +2498,6 @@
 	plain "$(gettext "Aborting...")"
 	exit 1
 fi
-srcdir="$BUILDDIR/src"
-pkgdir="$BUILDDIR/pkg"
 
 PKGDEST=${_PKGDEST:-$PKGDEST}
 PKGDEST=${PKGDEST:-$startdir} #default to $startdir if undefined
@@ -2076,12 +2526,7 @@
 PKGEXT=${_PKGEXT:-$PKGEXT}
 SRCEXT=${_SRCEXT:-$SRCEXT}
 GPGKEY=${_GPGKEY:-$GPGKEY}
-
-if (( HOLDVER )) && [[ -n $FORCE_VER ]]; then
-	# The '\\0' is here to prevent gettext from thinking --holdver is an option
-	error "$(gettext "\\0%s and %s cannot both be specified" )" "--holdver" "--forcever"
-	exit 1
-fi
+PACKAGER=${_PACKAGER:-$PACKAGER}
 
 if (( ! INFAKEROOT )); then
 	if (( EUID == 0 && ! ASROOT )); then
@@ -2095,7 +2540,7 @@
 		error "$(gettext "The %s option is meant for the root user only. Please\n\
 rerun %s without the %s flag.")" "--asroot" "makepkg" "--asroot"
 		exit 1 # $E_USER_ABORT
-	elif (( EUID > 0 )) && [[ $(check_buildenv fakeroot) != "y" ]]; then
+	elif (( EUID > 0 )) && ! check_buildenv "fakeroot" "y"; then
 		warning "$(gettext "Running %s as an unprivileged user will result in non-root\n\
 ownership of the packaged files. Try using the %s environment by\n\
 placing %s in the %s array in %s.")" "makepkg" "fakeroot" "'fakeroot'" "BUILDENV" "$MAKEPKG_CONF"
@@ -2120,9 +2565,7 @@
 	else
 		# PKGBUILD passed through a pipe
 		BUILDFILE=/dev/stdin
-		shopt -u extglob
-		source "$BUILDFILE"
-		shopt -s extglob
+		source_safe "$BUILDFILE"
 	fi
 else
 	crlftest=$(file "$BUILDFILE" | grep -F 'CRLF' || true)
@@ -2134,48 +2577,54 @@
 	if [[ ${BUILDFILE:0:1} != "/" ]]; then
 		BUILDFILE="$startdir/$BUILDFILE"
 	fi
-	shopt -u extglob
-	source "$BUILDFILE"
-	shopt -s extglob
+	source_safe "$BUILDFILE"
 fi
 
 # set defaults if they weren't specified in buildfile
 pkgbase=${pkgbase:-${pkgname[0]}}
 epoch=${epoch:-0}
 
+if [[ $BUILDDIR = "$startdir" ]]; then
+	srcdir="$BUILDDIR/src"
+	pkgdir="$BUILDDIR/pkg"
+else
+	srcdir="$BUILDDIR/$pkgbase/src"
+	pkgdir="$BUILDDIR/$pkgbase/pkg"
+fi
+
 if (( GENINTEG )); then
 	mkdir -p "$srcdir"
 	chmod a-s "$srcdir"
-	cd "$srcdir"
-	download_sources
+	cd_safe "$srcdir"
+	download_sources fast
 	generate_checksums
 	exit 0 # $E_OK
 fi
 
+if declare -f pkgver >/dev/null; then
+	PKGVERFUNC=1
+fi
+
 # check the PKGBUILD for some basic requirements
 check_sanity || exit 1
 
 # check we have the software required to process the PKGBUILD
 check_software || exit 1
 
-# We need to run devel_update regardless of whether we are in the fakeroot
-# build process so that if the user runs makepkg --forcever manually, we
-# 1) output the correct pkgver, and 2) use the correct filename when
-# checking if the package file already exists - fixes FS #9194
-devel_check
-devel_update
-
 if (( ${#pkgname[@]} > 1 )); then
 	SPLITPKG=1
 fi
 
 # test for available PKGBUILD functions
+if declare -f prepare >/dev/null; then
+	PREPAREFUNC=1
+fi
 if declare -f build >/dev/null; then
 	BUILDFUNC=1
 fi
 if declare -f check >/dev/null; then
 	# "Hide" check() function if not going to be run
-	if [[ $RUN_CHECK = 'y' || (! $(check_buildenv check) = "n" &&  ! $RUN_CHECK = "n") ]]; then
+	if [[ $RUN_CHECK = 'y' ]] || { ! check_buildenv "check" "n" && [[ $RUN_CHECK != "n" ]]; }; then
 		CHECKFUNC=1
 	fi
 fi
@@ -2191,8 +2640,7 @@
 fi
 
 # check if gpg signature is to be created and if signing key is valid
-[[ -z $SIGNPKG ]] && SIGNPKG=$(check_buildenv sign)
-if [[ $SIGNPKG == 'y' ]]; then
+if { [[ -z $SIGNPKG ]] && check_buildenv "sign" "y"; } || [[ $SIGNPKG == 'y' ]]; then
 	if ! gpg --list-key ${GPGKEY} &>/dev/null; then
 		if [[ ! -z $GPGKEY ]]; then
 			error "$(gettext "The key %s does not exist in your keyring.")" "${GPGKEY}"
@@ -2203,50 +2651,8 @@
 	fi
 fi
 
-
-if (( ! SPLITPKG )); then
-	fullver=$(get_full_version)
-	if [[ -f $PKGDEST/${pkgname}-${fullver}-${CARCH}${PKGEXT} \
-	     || -f $PKGDEST/${pkgname}-${fullver}-any${PKGEXT} ]] \
-			 && ! (( FORCE || SOURCEONLY || NOBUILD )); then
-		if (( INSTALL )); then
-			warning "$(gettext "A package has already been built, installing existing package...")"
-			install_package
-			exit $?
-		else
-			error "$(gettext "A package has already been built. (use %s to overwrite)")" "-f"
-			exit 1
-		fi
-	fi
-else
-	allpkgbuilt=1
-	somepkgbuilt=0
-	for pkg in ${pkgname[@]}; do
-		fullver=$(get_full_version $pkg)
-		if [[ -f $PKGDEST/${pkg}-${fullver}-${CARCH}${PKGEXT} \
-		     || -f $PKGDEST/${pkg}-${fullver}-any${PKGEXT} ]]; then
-			somepkgbuilt=1
-		else
-			allpkgbuilt=0
-		fi
-	done
-	if ! (( FORCE || SOURCEONLY || NOBUILD )); then
-		if (( allpkgbuilt )); then
-			if (( INSTALL )); then
-				warning "$(gettext "The package group has already been built, installing existing packages...")"
-				install_package
-				exit $?
-			else
-				error "$(gettext "The package group has already been built. (use %s to overwrite)")" "-f"
-				exit 1
-			fi
-		fi
-		if (( somepkgbuilt )); then
-			error "$(gettext "Part of the package group has already been built. (use %s to overwrite)")" "-f"
-			exit 1
-		fi
-	fi
-	unset allpkgbuilt somepkgbuilt
+if (( ! PKGVERFUNC )); then
+	check_build_status
 fi
 
 # Run the bare minimum in fakeroot
@@ -2296,17 +2702,18 @@
 	# Get back to our src directory so we can begin with sources.
 	mkdir -p "$srcdir"
 	chmod a-s "$srcdir"
-	cd "$srcdir"
-	if ( (( ! SKIPCHECKSUMS )) || \
-			( (( ! SKIPPGPCHECK )) && source_has_signatures ) ) || \
-			(( SOURCEONLY == 2 )); then
+	cd_safe "$srcdir"
+	if (( SOURCEONLY == 2 )); then
 		download_sources
+	elif ( (( ! SKIPCHECKSUMS )) || \
+			( (( ! SKIPPGPCHECK )) && source_has_signatures ) ); then
+		download_sources fast
 	fi
 	check_source_integrity
-	cd "$startdir"
+	cd_safe "$startdir"
 
 	# if we are root or if fakeroot is not enabled, then we don't use it
-	if [[ $(check_buildenv fakeroot) != "y" ]] || (( EUID == 0 )); then
+	if ! check_buildenv "fakeroot" "y" || (( EUID == 0 )); then
 		create_srcpackage
 	else
 		enter_fakeroot
@@ -2316,9 +2723,9 @@
 	exit 0
 fi
 
-if (( NODEPS || ( (NOBUILD || REPKG) && !DEP_BIN ) )); then
-	# no warning message needed for nobuild, repkg
-	if (( NODEPS || ( REPKG && PKGFUNC ) )); then
+if (( NODEPS || (NOBUILD && !DEP_BIN ) )); then
+	# no warning message needed for nobuild
+	if (( NODEPS )); then
 		warning "$(gettext "Skipping dependency checks.")"
 	fi
 elif type -p "${PACMAN%% *}" >/dev/null; then
@@ -2359,21 +2766,13 @@
 # get back to our src directory so we can begin with sources
 mkdir -p "$srcdir"
 chmod a-s "$srcdir"
-cd "$srcdir"
+cd_safe "$srcdir"
 
 if (( NOEXTRACT )); then
-	warning "$(gettext "Skipping source retrieval        -- using existing %s tree")" "src/"
-	warning "$(gettext "Skipping source integrity checks -- using existing %s tree")" "src/"
-	warning "$(gettext "Skipping source extraction       -- using existing %s tree")" "src/"
-
-	if (( NOEXTRACT )) && [[ -z $(ls "$srcdir" 2>/dev/null) ]]; then
-		error "$(gettext "The source directory is empty, there is nothing to build!")"
-		plain "$(gettext "Aborting...")"
-		exit 1
-	fi
+	warning "$(gettext "Using existing %s tree")" "src/"
 elif (( REPKG )); then
 	if (( ! PKGFUNC && ! SPLITPKG )) \
-	     && [[ ! -d $pkgdir || -z $(ls "$pkgdir" 2>/dev/null) ]]; then
+	     && { [[ ! -d $pkgdir ]] || dir_is_empty "$pkgdir"; }; then
 		error "$(gettext "The package directory is empty, there is nothing to repackage!")"
 		plain "$(gettext "Aborting...")"
 		exit 1
@@ -2382,6 +2781,9 @@
 	download_sources
 	check_source_integrity
 	extract_sources
+	if (( PREPAREFUNC )); then
+		run_prepare
+	fi
 fi
 
 if (( NOBUILD )); then
@@ -2395,12 +2797,11 @@
 	fi
 	mkdir -p "$pkgdir"
 	chmod a-s "$pkgdir"
-	cd "$startdir"
+	cd_safe "$startdir"
 
 	# if we are root or if fakeroot is not enabled, then we don't use it
-	if [[ $(check_buildenv fakeroot) != "y" ]] || (( EUID == 0 )); then
+	if ! check_buildenv "fakeroot" "y" || (( EUID == 0 )); then
 		if (( ! REPKG )); then
-			devel_update
 			(( BUILDFUNC )) && run_build
 			(( CHECKFUNC )) && run_check
 		fi
@@ -2422,10 +2823,9 @@
 		fi
 	else
 		if (( ! REPKG && ( PKGFUNC || SPLITPKG ) )); then
-			devel_update
 			(( BUILDFUNC )) && run_build
 			(( CHECKFUNC )) && run_check
-			cd "$startdir"
+			cd_safe "$startdir"
 		fi
 
 		enter_fakeroot
diff -x '.*' -aur pacman-4.0.3/scripts/pacman-db-upgrade.sh.in pacman/scripts/pacman-db-upgrade.sh.in
--- pacman-4.0.3/scripts/pacman-db-upgrade.sh.in	2012-01-31 03:38:41.000000000 +0000
+++ pacman/scripts/pacman-db-upgrade.sh.in	2012-10-15 18:11:52.513287879 +0000
@@ -23,7 +23,7 @@
 export TEXTDOMAIN='pacman-scripts'
 export TEXTDOMAINDIR='@localedir@'
 
-myver='@PACKAGE_VERSION@'
+declare -r myver='@PACKAGE_VERSION@'
 
 eval $(awk '/DBPath/ {print $1$2$3}' @sysconfdir@/pacman.conf)
 dbroot="${DBPath:-@localstatedir@/lib/pacman/}"
diff -x '.*' -aur pacman-4.0.3/scripts/pacman-key.sh.in pacman/scripts/pacman-key.sh.in
--- pacman-4.0.3/scripts/pacman-key.sh.in	2012-04-07 16:03:48.000000000 +0000
+++ pacman/scripts/pacman-key.sh.in	2012-10-15 18:11:52.513287879 +0000
@@ -24,7 +24,7 @@
 export TEXTDOMAIN='pacman-scripts'
 export TEXTDOMAINDIR='@localedir@'
 
-myver="@PACKAGE_VERSION@"
+declare -r myver="@PACKAGE_VERSION@"
 
 # Options
 ADD=0
@@ -49,40 +49,43 @@
 
 m4_include(library/output_format.sh)
 
-m4_include(library/parse_options.sh)
+m4_include(library/parseopts.sh)
 
 usage() {
 	printf "pacman-key (pacman) %s\n" ${myver}
 	echo
-	printf -- "$(gettext "Usage: %s [options]")\n" $(basename $0)
+	printf -- "$(gettext "Usage: %s [options] operation [targets]")\n" $(basename $0)
 	echo
 	printf -- "$(gettext "Manage pacman's list of trusted keys")\n"
 	echo
-	printf -- "$(gettext "Options:")\n"
-	printf -- "$(gettext "  -a, --add [file(s)]       Add the specified keys (empty for stdin)")\n"
-	printf -- "$(gettext "  -d, --delete <keyid(s)>   Remove the specified keyids")\n"
-	printf -- "$(gettext "  -e, --export [keyid(s)]   Export the specified or all keyids")\n"
-	printf -- "$(gettext "  -f, --finger [keyid(s)]   List fingerprint for specified or all keyids")\n"
-	printf -- "$(gettext "  -h, --help                Show this help message and exit")\n"
-	printf -- "$(gettext "  -l, --list-keys [keyid(s)] List the specified or all keys")\n"
-	printf -- "$(gettext "  -r, --recv-keys <keyid(s)> Fetch the specified keyids")\n"
+	printf -- "$(gettext "Operations:")\n"
+	printf -- "$(gettext "  -a, --add                 Add the specified keys (empty for stdin)")\n"
+	printf -- "$(gettext "  -d, --delete              Remove the specified keyids")\n"
+	printf -- "$(gettext "  -e, --export              Export the specified or all keyids")\n"
+	printf -- "$(gettext "  -f, --finger              List fingerprint for specified or all keyids")\n"
+	printf -- "$(gettext "  -l, --list-keys           List the specified or all keys")\n"
+	printf -- "$(gettext "  -r, --recv-keys           Fetch the specified keyids")\n"
 	printf -- "$(gettext "  -u, --updatedb            Update the trustdb of pacman")\n"
-	printf -- "$(gettext "  -v, --verify <signature>  Verify the file specified by the signature")\n"
-	printf -- "$(gettext "  -V, --version             Show program version")\n"
+	printf -- "$(gettext "  -v, --verify              Verify the file(s) specified by the signature(s)")\n"
+	printf -- "$(gettext "  --edit-key                Present a menu for key management task on keyids")\n"
+	printf -- "$(gettext "  --import                  Imports pubring.gpg from dir(s)")\n"
+	printf -- "$(gettext "  --import-trustdb          Imports ownertrust values from trustdb.gpg in dir(s)")\n"
+	printf -- "$(gettext "  --init                    Ensure the keyring is properly initialized")\n"
+	printf -- "$(gettext "  --list-sigs               List keys and their signatures")\n"
+	printf -- "$(gettext "  --lsign-key               Locally sign the specified keyid")\n"
+	printf -- "$(gettext "  --populate                Reload the default keys from the (given) keyrings\n\
+                            in '%s'")\n" "@pkgdatadir@/keyrings"
+	printf -- "$(gettext "  --refresh-keys            Update specified or all keys from a keyserver")\n"
+	echo
+	printf -- "$(gettext "Options:")\n"
 	printf -- "$(gettext "  --config <file>           Use an alternate config file (instead of\n\
                             '%s')")\n" "@sysconfdir@/pacman.conf"
-	printf -- "$(gettext "  --edit-key <keyid(s)>     Present a menu for key management task on keyids")\n"
 	printf -- "$(gettext "  --gpgdir <dir>            Set an alternate directory for GnuPG (instead\n\
                             of '%s')")\n" "@sysconfdir@/pacman.d/gnupg"
-	printf -- "$(gettext "  --import <dir(s)>         Imports pubring.gpg from dir(s)")\n"
-	printf -- "$(gettext "  --import-trustdb <dir(s)> Imports ownertrust values from trustdb.gpg in dir(s)")\n"
-	printf -- "$(gettext "  --init                    Ensure the keyring is properly initialized")\n"
-	printf -- "$(gettext "  --keyserver               Specify a keyserver to use if necessary")\n"
-	printf -- "$(gettext "  --list-sigs [keyid(s)]    List keys and their signatures")\n"
-	printf -- "$(gettext "  --lsign-key <keyid>       Locally sign the specified keyid")\n"
-	printf -- "$(gettext "  --populate [keyring(s)]   Reload the default keys from the (given) keyrings\n\
-                            in '%s'")\n" "@pkgdatadir@/keyrings"
-	printf -- "$(gettext "  --refresh-keys [keyid(s)] Update specified or all keys from a keyserver")\n"
+	printf -- "$(gettext "  --keyserver <server-url>  Specify a keyserver to use if necessary")\n"
+	echo
+	printf -- "$(gettext "  -h, --help                Show this help message and exit")\n"
+	printf -- "$(gettext "  -V, --version             Show program version")\n"
 }
 
 version() {
@@ -113,14 +116,38 @@
 	return 1
 }
 
+key_lookup_from_name() {
+	local ids
+
+	mapfile -t ids < \
+		<("${GPG_PACMAN[@]}" --search-keys --batch --with-colons "$1" 2>/dev/null |
+			awk -F: '$1 == "pub" { print $2 }')
+
+	# only return success on non-ambiguous lookup
+	case ${#ids[*]} in
+		0)
+			error "$(gettext "Failed to lookup key by name:") %s" "$name"
+			return 1
+			;;
+		1)
+			printf '%s' "${ids[0]}"
+			return 0
+			;;
+		*)
+			error "$(gettext "Key name is ambiguous:") %s" "$name"
+			return 1
+			;;
+	esac
+}
+
 generate_master_key() {
 	# Generate the master key, which will be in both pubring and secring
 	"${GPG_PACMAN[@]}" --gen-key --batch <<EOF
-%echo Generating pacman keychain master key...
+%echo Generating pacman keyring master key...
 Key-Type: RSA
 Key-Length: 2048
 Key-Usage: sign
-Name-Real: Pacman Keychain Master Key
+Name-Real: Pacman Keyring Master Key
 Name-Email: pacman@localhost
 Expire-Date: 0
 %commit
@@ -146,7 +173,7 @@
 
 check_keyids_exist() {
 	local ret=0
-	for key in "${KEYIDS[@]}"; do
+	for key in "$@"; do
 		# Verify if the key exists in pacman's keyring
 		if ! "${GPG_PACMAN[@]}" --list-keys "$key" &>/dev/null ; then
 			error "$(gettext "The key identified by %s could not be found locally.")" "$key"
@@ -217,16 +244,16 @@
 populate_keyring() {
 	local KEYRING_IMPORT_DIR='@pkgdatadir@/keyrings'
 
-	local keyring
+	local keyring KEYRINGIDS=("$@")
 	local ret=0
-	if [[ -z ${KEYRINGIDS[@]} ]]; then
+	if (( ${#KEYRINGIDS[*]} == 0 )); then
 		# get list of all available keyrings
 		shopt -s nullglob
 		KEYRINGIDS=("$KEYRING_IMPORT_DIR"/*.gpg)
 		shopt -u nullglob
 		KEYRINGIDS=("${KEYRINGIDS[@]##*/}")
 		KEYRINGIDS=("${KEYRINGIDS[@]%.gpg}")
-		if [[ -z ${KEYRINGIDS[@]} ]]; then
+		if (( ${#KEYRINGIDS[*]} == 0 )); then
 			error "$(gettext "No keyring files exist in %s.")" "$KEYRING_IMPORT_DIR"
 			ret=1
 		fi
@@ -245,8 +272,7 @@
 	fi
 
 	# Variable used for iterating on keyrings
-	local key
-	local key_id
+	local keys key_id
 
 	# Add keys from requested keyrings
 	for keyring in "${KEYRINGIDS[@]}"; do
@@ -261,15 +287,13 @@
 	#  40CHARFINGERPRINTXXXXXXXXXXXXXXXXXXXXXXX:5:
 	local -A trusted_ids
 	for keyring in "${KEYRINGIDS[@]}"; do
-		if [[ -f "${KEYRING_IMPORT_DIR}/${keyring}-trusted" ]]; then
-			while read key; do
-				# skip comments; these are valid in this file
-				[[ $key = \#* ]] && continue
-				key_id="${key%%:*}"
-				if [[ -n ${key_id} ]]; then
-					# Mark this key to be lsigned
-					trusted_ids[$key_id]="${keyring}"
-				fi
+		if [[ -s "${KEYRING_IMPORT_DIR}/${keyring}-trusted" ]]; then
+			while IFS=: read key_id _; do
+				# skip blank lines, comments; these are valid in this file
+				[[ -z $key_id || ${key_id:0:1} = \# ]] && continue
+
+				# Mark this key to be lsigned
+				trusted_ids[$key_id]=$keyring
 			done < "${KEYRING_IMPORT_DIR}/${keyring}-trusted"
 		fi
 	done
@@ -278,11 +302,11 @@
 		msg "$(gettext "Locally signing trusted keys in keyring...")"
 		for key_id in "${!trusted_ids[@]}"; do
 			msg2 "$(gettext "Locally signing key %s...")" "${key_id}"
-			"${GPG_PACMAN[@]}" --quiet --lsign-key "${key_id}"
+			lsign_keys "${key_id}"
 		done
 		msg "$(gettext "Importing owner trust values...")"
 		for keyring in "${KEYRINGIDS[@]}"; do
-			if [[ -f "${KEYRING_IMPORT_DIR}/${keyring}-trusted" ]]; then
+			if [[ -s "${KEYRING_IMPORT_DIR}/${keyring}-trusted" ]]; then
 				"${GPG_PACMAN[@]}" --import-ownertrust "${KEYRING_IMPORT_DIR}/${keyring}-trusted"
 			fi
 		done
@@ -293,14 +317,14 @@
 	# guarantee of identification for the keys.
 	local -A revoked_ids
 	for keyring in "${KEYRINGIDS[@]}"; do
-		if [[ -f "${KEYRING_IMPORT_DIR}/${keyring}-revoked" ]]; then
-			while read key; do
-				key_id="$("${GPG_PACMAN[@]}" --quiet --with-colons --list-key "${key}" 2>/dev/null | grep ^pub | cut -d: -f5)"
-				if [[ -n ${key_id} ]]; then
+		if [[ -s "${KEYRING_IMPORT_DIR}/${keyring}-revoked" ]]; then
+			mapfile -t keys < "${KEYRING_IMPORT_DIR}/${keyring}-revoked"
+			while IFS=: read _ _ _ _ key_id _; do
+				if [[ -n $key_id ]]; then
 					# Mark this key to be disabled
 					revoked_ids[$key_id]="${keyring}"
 				fi
-			done < "${KEYRING_IMPORT_DIR}/${keyring}-revoked"
+			done < <("${GPG_PACMAN[@]}" --quiet --with-colons --list-keys "${keys[@]}" 2>/dev/null)
 		fi
 	done
 
@@ -314,24 +338,24 @@
 }
 
 add_keys() {
-	if ! "${GPG_PACMAN[@]}" --quiet --batch --import "${KEYFILES[@]}" ; then
-		error "$(gettext "A specified keyfile could not be added to the gpg keychain.")"
+	if ! "${GPG_PACMAN[@]}" --quiet --batch --import "$@" ; then
+		error "$(gettext "A specified keyfile could not be added to the keyring.")"
 		exit 1
 	fi
 }
 
 delete_keys() {
-	check_keyids_exist
-	if ! "${GPG_PACMAN[@]}" --quiet --batch --delete-key --yes "${KEYIDS[@]}" ; then
-		error "$(gettext "A specified key could not be removed from the gpg keychain.")"
+	check_keyids_exist "$@"
+	if ! "${GPG_PACMAN[@]}" --quiet --batch --delete-key --yes "$@" ; then
+		error "$(gettext "A specified key could not be removed from the keyring.")"
 		exit 1
 	fi
 }
 
 edit_keys() {
-	check_keyids_exist
+	check_keyids_exist "$@"
 	local ret=0
-	for key in "${KEYIDS[@]}"; do
+	for key in "$@"; do
 		if ! "${GPG_PACMAN[@]}" --edit-key "$key" ; then
 			error "$(gettext "The key identified by %s could not be edited.")" "$key"
 			ret=1
@@ -343,16 +367,16 @@
 }
 
 export_keys() {
-	check_keyids_exist
-	if ! "${GPG_PACMAN[@]}" --armor --export "${KEYIDS[@]}" ; then
-		error "$(gettext "A specified key could not be exported from the gpg keychain.")"
+	check_keyids_exist "$@"
+	if ! "${GPG_PACMAN[@]}" --armor --export "$@" ; then
+		error "$(gettext "A specified key could not be exported from the keyring.")"
 		exit 1
 	fi
 }
 
 finger_keys() {
 	check_keyids_exist
-	if ! "${GPG_PACMAN[@]}" --batch --fingerprint "${KEYIDS[@]}" ; then
+	if ! "${GPG_PACMAN[@]}" --batch --fingerprint "$@" ; then
 		error "$(gettext "The fingerprint of a specified key could not be determined.")"
 		exit 1
 	fi
@@ -361,7 +385,7 @@
 import_trustdb() {
 	local importdir
 	local ret=0
-	for importdir in "${IMPORT_DIRS[@]}"; do
+	for importdir in "$@"; do
 		if [[ -f "${importdir}/trustdb.gpg" ]]; then
 			gpg --homedir "${importdir}" --export-ownertrust | \
 				"${GPG_PACMAN[@]}" --import-ownertrust -
@@ -382,7 +406,7 @@
 import() {
 	local importdir
 	local ret=0
-	for importdir in "${IMPORT_DIRS[@]}"; do
+	for importdir in "$@"; do
 		if [[ -f "${importdir}/pubring.gpg" ]]; then
 			if ! "${GPG_PACMAN[@]}" --quiet --batch --import "${importdir}/pubring.gpg" ; then
 				error "$(gettext "%s could not be imported.")" "${importdir}/pubring.gpg"
@@ -400,7 +424,7 @@
 
 list_keys() {
 	check_keyids_exist
-	if ! "${GPG_PACMAN[@]}" --batch --list-keys "${KEYIDS[@]}" ; then
+	if ! "${GPG_PACMAN[@]}" --batch --list-keys "$@" ; then
 		error "$(gettext "A specified key could not be listed.")"
 		exit 1
 	fi
@@ -408,7 +432,7 @@
 
 list_sigs() {
 	check_keyids_exist
-	if ! "${GPG_PACMAN[@]}" --batch --list-sigs "${KEYIDS[@]}" ; then
+	if ! "${GPG_PACMAN[@]}" --batch --list-sigs "$@" ; then
 		error "$(gettext "A specified signature could not be listed.")"
 		exit 1
 	fi
@@ -416,7 +440,8 @@
 
 lsign_keys() {
 	check_keyids_exist
-	printf 'y\ny\n' | LANG=C "${GPG_PACMAN[@]}" --command-fd 0 --quiet --batch --lsign-key "${KEYIDS[@]}" 2>/dev/null
+	# we cannot use --yes here as gpg would still ask for confirmation if a key has more than one uid
+	printf 'y\ny\n' | LANG=C "${GPG_PACMAN[@]}" --command-fd 0 --quiet --batch --lsign-key "$@" 2>/dev/null
 	if (( PIPESTATUS[1] )); then
 		error "$(gettext "A specified key could not be locally signed.")"
 		exit 1
@@ -424,29 +449,45 @@
 }
 
 receive_keys() {
-	if ! "${GPG_PACMAN[@]}" --recv-keys "${KEYIDS[@]}" ; then
+	local name id keyids
+
+	# if the key is not a hex ID, do a lookup
+	for name; do
+		if [[ $name = ?(0x)+([0-9a-fA-F]) ]]; then
+			keyids+=("$name")
+		else
+			if id=$(key_lookup_from_name "$name"); then
+				keyids+=("$id")
+			fi
+		fi
+	done
+
+	(( ${#keyids[*]} > 0 )) || exit 1
+
+	if ! "${GPG_PACMAN[@]}" --recv-keys "${keyids[@]}" ; then
 		error "$(gettext "Remote key not fetched correctly from keyserver.")"
 		exit 1
 	fi
 }
 
 refresh_keys() {
-	check_keyids_exist
-	if ! "${GPG_PACMAN[@]}" --refresh-keys "${KEYIDS[@]}" ; then
+	check_keyids_exist "$@"
+	if ! "${GPG_PACMAN[@]}" --refresh-keys "$@" ; then
 		error "$(gettext "A specified local key could not be updated from a keyserver.")"
 		exit 1
 	fi
 }
 
 verify_sig() {
-	local fd="$(mktemp)"
-	"${GPG_PACMAN[@]}" --status-file "${fd}" --verify $SIGNATURE
-	if ! grep -q TRUST_FULLY "${fd}"; then
-		rm -f "${fd}"
-		error "$(gettext "The signature identified by %s could not be verified.")" "$SIGNATURE"
-		exit 1
-	fi
-	rm -f "${fd}"
+	local ret=0
+	for sig; do
+		msg "Checking %s ..." "$sig"
+		if ! "${GPG_PACMAN[@]}" --status-fd 1 --verify "$sig" | grep -qE 'TRUST_(FULLY|ULTIMATE)'; then
+			error "$(gettext "The signature identified by %s could not be verified.")" "$sig"
+			ret=1
+		fi
+	done
+	exit $ret
 }
 
 updatedb() {
@@ -464,56 +505,55 @@
 	}
 fi
 
-OPT_SHORT="a::d:e::f::hl::r:uv:V"
-OPT_LONG="add::,config:,delete:,edit-key:,export::,finger::,gpgdir:"
-OPT_LONG+=",help,import:,import-trustdb:,init,keyserver:,list-keys::,list-sigs::"
-OPT_LONG+=",lsign-key:,populate::,recv-keys:,refresh-keys::,updatedb"
-OPT_LONG+=",verify:,version"
-if ! OPT_TEMP="$(parse_options $OPT_SHORT $OPT_LONG "$@")"; then
-	echo; usage; exit 1 # E_INVALID_OPTION;
+OPT_SHORT="adefhlruvV"
+OPT_LONG=('add' 'config:' 'delete' 'edit-key' 'export' 'finger' 'gpgdir:'
+          'help' 'import' 'import-trustdb' 'init' 'keyserver:' 'list-keys' 'list-sigs'
+          'lsign-key' 'populate' 'recv-keys' 'refresh-keys' 'updatedb'
+          'verify' 'version')
+if ! parseopts "$OPT_SHORT" "${OPT_LONG[@]}" -- "$@"; then
+	exit 1 # E_INVALID_OPTION;
 fi
-eval set -- "$OPT_TEMP"
-unset OPT_SHORT OPT_LONG OPT_TEMP
+set -- "${OPTRET[@]}"
+unset OPT_SHORT OPT_LONG OPTRET
 
 if [[ $1 == "--" ]]; then
 	usage;
 	exit 0;
 fi
 
-while true; do
-	case "$1" in
-		-a|--add)         ADD=1; [[ -n $2 && ${2:0:1} != "-" ]] && shift && KEYFILES=($1); UPDATEDB=1 ;;
+while (( $# )); do
+	case $1 in
+		-a|--add)         ADD=1 UPDATEDB=1 ;;
 		--config)         shift; CONFIG=$1 ;;
-		-d|--delete)      DELETE=1; shift; KEYIDS=($1); UPDATEDB=1 ;;
-		--edit-key)       EDITKEY=1; shift; KEYIDS=($1); UPDATEDB=1 ;;
-		-e|--export)      EXPORT=1; [[ -n $2 && ${2:0:1} != "-" ]] && shift && KEYIDS=($1) ;;
-		-f|--finger)      FINGER=1; [[ -n $2 && ${2:0:1} != "-" ]] && shift && KEYIDS=($1) ;;
+		-d|--delete)      DELETE=1 UPDATEDB=1 ;;
+		--edit-key)       EDITKEY=1 UPDATEDB=1 ;;
+		-e|--export)      EXPORT=1 ;;
+		-f|--finger)      FINGER=1 ;;
 		--gpgdir)         shift; PACMAN_KEYRING_DIR=$1 ;;
-		--import)         IMPORT=1; shift; IMPORT_DIRS=($1); UPDATEDB=1 ;;
-		--import-trustdb) IMPORT_TRUSTDB=1; shift; IMPORT_DIRS=($1); UPDATEDB=1 ;;
+		--import)         IMPORT=1 UPDATEDB=1 ;;
+		--import-trustdb) IMPORT_TRUSTDB=1 UPDATEDB=1 ;;
 		--init)           INIT=1 ;;
 		--keyserver)      shift; KEYSERVER=$1 ;;
-		-l|--list-keys)   LISTKEYS=1; [[ -n $2 && ${2:0:1} != "-" ]] && shift && KEYIDS=($1) ;;
-		--list-sigs)      LISTSIGS=1; [[ -n $2 && ${2:0:1} != "-" ]] && shift && KEYIDS=($1) ;;
-		--lsign-key)      LSIGNKEY=1; shift; KEYIDS=($1); UPDATEDB=1 ;;
-		--populate)       POPULATE=1; [[ -n $2 && ${2:0:1} != "-" ]] && shift && KEYRINGIDS=($1); UPDATEDB=1 ;;
-		-r|--recv-keys)   RECEIVE=1; shift; KEYIDS=($1); UPDATEDB=1 ;;
-		--refresh-keys)   REFRESH=1; [[ -n $2 && ${2:0:1} != "-" ]] && shift && KEYIDS=($1) ;;
+		-l|--list-keys)   LISTKEYS=1 ;;
+		--list-sigs)      LISTSIGS=1 ;;
+		--lsign-key)      LSIGNKEY=1 UPDATEDB=1 ;;
+		--populate)       POPULATE=1 UPDATEDB=1 ;;
+		-r|--recv-keys)   RECEIVE=1 UPDATEDB=1 ;;
+		--refresh-keys)   REFRESH=1 ;;
 		-u|--updatedb)    UPDATEDB=1 ;;
-		-v|--verify)      VERIFY=1; shift; SIGNATURE=$1 ;;
+		-v|--verify)      VERIFY=1 ;;
 
 		-h|--help)        usage; exit 0 ;;
 		-V|--version)     version; exit 0 ;;
 
-		--)               OPT_IND=0; shift; break;;
-		*)                usage; exit 1 ;;
+		--)               shift; break 2 ;;
 	esac
 	shift
 done
 
 
 if ! type -p gpg >/dev/null; then
-    error "$(gettext "Cannot find the %s binary required for all %s operations.")" "gpg" "pacman-key"
+	error "$(gettext "Cannot find the %s binary required for all %s operations.")" "gpg" "pacman-key"
 	exit 1
 fi
 
@@ -556,23 +596,30 @@
 		;;
 esac
 
+# check for targets where needed
+if (( (ADD || DELETE || EDIT || IMPORT || IMPORT_TRUSTDB ||
+		LSIGNKEY || RECEIVE || VERIFY) && $# == 0 )); then
+	error "$(gettext "No targets specified")"
+	exit 1
+fi
+
 (( ! INIT )) && check_keyring
 
-(( ADD )) && add_keys
-(( DELETE )) && delete_keys
-(( EDITKEY )) && edit_keys
-(( EXPORT )) && export_keys
-(( FINGER )) && finger_keys
-(( IMPORT )) && import
-(( IMPORT_TRUSTDB)) && import_trustdb
+(( ADD )) && add_keys "$@"
+(( DELETE )) && delete_keys "$@"
+(( EDITKEY )) && edit_keys "$@"
+(( EXPORT )) && export_keys "$@"
+(( FINGER )) && finger_keys "$@"
+(( IMPORT )) && import "$@"
+(( IMPORT_TRUSTDB)) && import_trustdb "$@"
 (( INIT )) && initialize
-(( LISTKEYS )) && list_keys
-(( LISTSIGS )) && list_sigs
-(( LSIGNKEY )) && lsign_keys
-(( POPULATE )) && populate_keyring
-(( RECEIVE )) && receive_keys
-(( REFRESH )) && refresh_keys
-(( VERIFY )) && verify_sig
+(( LISTKEYS )) && list_keys "$@"
+(( LISTSIGS )) && list_sigs "$@"
+(( LSIGNKEY )) && lsign_keys "$@"
+(( POPULATE )) && populate_keyring "$@"
+(( RECEIVE )) && receive_keys "$@"
+(( REFRESH )) && refresh_keys "$@"
+(( VERIFY )) && verify_sig "$@"
 
 (( UPDATEDB )) && updatedb
 
diff -x '.*' -aur pacman-4.0.3/scripts/pacman-optimize.sh.in pacman/scripts/pacman-optimize.sh.in
--- pacman-4.0.3/scripts/pacman-optimize.sh.in	2012-02-14 15:45:15.000000000 +0000
+++ pacman/scripts/pacman-optimize.sh.in	2012-10-15 18:11:52.513287879 +0000
@@ -24,7 +24,7 @@
 export TEXTDOMAIN='pacman-scripts'
 export TEXTDOMAINDIR='@localedir@'
 
-myver='@PACKAGE_VERSION@'
+declare -r myver='@PACKAGE_VERSION@'
 
 eval $(awk '/DBPath/ {print $1$2$3}' @sysconfdir@/pacman.conf)
 dbroot="${DBPath:-@localstatedir@/lib/pacman/}"
@@ -88,9 +88,8 @@
 	dbroot="$1"
 fi
 
-# make sure diff is installed
-if ! type diff >/dev/null 2>&1; then
-	die "$(gettext "diff tool was not found, please install diffutils.")"
+if ! type -p openssl >/dev/null; then
+	die "$(gettext "Cannot find the %s binary required for verifying integrity.")" "openssl"
 fi
 
 if [[ ! -d $dbroot || ! -d $dbroot/local ]]; then
@@ -103,8 +102,8 @@
 
 # strip any trailing slash from our dbroot
 dbroot="${dbroot%/}"
-# form the path to our lockfile location
 lockfile="${dbroot}/db.lck"
+localdb="${dbroot}/local"
 
 # make sure pacman isn't running
 if [[ -f $lockfile ]]; then
@@ -113,42 +112,44 @@
 # do not let pacman run while we do this
 touch "$lockfile"
 
-workdir=$(mktemp -d /tmp/pacman-optimize.XXXXXXXXXX) ||
+workdir=$(mktemp -d "${TMPDIR:-/tmp}/pacman-optimize.XXXXXXXXXX") ||
 	die_r "$(gettext "Can not create temp directory for database building.")\n" >&2
 
 # step 1: sum the old db
 msg "$(gettext "MD5sum'ing the old database...")"
-find "$dbroot" -type f | sort | xargs md5sum > "$workdir/pacsums.old"
+(cd "$localdb" && find . -type f -print0 | \
+	xargs -0 openssl dgst -md5 | sort > "$workdir/pacsums.old")
 
 # step 2: tar it up
-msg "$(gettext "Tar'ing up %s...")" "$dbroot"
-bsdtar -czf "$workdir/pacman-db.tar.gz" -C "$dbroot" ./
+msg "$(gettext "Tar'ing up %s...")" "$localdb"
+bsdtar -czf "$workdir/pacman-db.tar.gz" -C "$localdb" ./
 if (( $? )); then
 	rm -rf "$workdir"
-	die_r "$(gettext "Tar'ing up %s failed.")" "$dbroot"
+	die_r "$(gettext "Tar'ing up %s failed.")" "$localdb"
 fi
 
 # step 3: make and sum the new db side-by-side with the old
 msg "$(gettext "Making and MD5sum'ing the new database...")"
-mkdir "$dbroot.new"
-bsdtar -xpf "$workdir/pacman-db.tar.gz" -C "$dbroot.new"
+mkdir "$localdb.new"
+bsdtar -xpf "$workdir/pacman-db.tar.gz" -C "$localdb.new"
 if (( $? )); then
        rm -rf "$workdir"
-       die_r "$(gettext "Untar'ing %s failed.")" "$dbroot"
+       die_r "$(gettext "Untar'ing %s failed.")" "$localdb"
 fi
 # immediate sync following extraction should get it written continuously on HDD
 msg "$(gettext "Syncing database to disk...")"
 sync
-find "$dbroot.new" -type f | sort | \
-		xargs md5sum | sed 's#.new##' > "$workdir/pacsums.new"
+(cd "$localdb.new" && find . -type f -print0 | \
+	xargs -0 openssl dgst -md5 | sort > "$workdir/pacsums.new")
 
 # step 4: compare the sums
 msg "$(gettext "Checking integrity...")"
-diff "$workdir/pacsums.old" "$workdir/pacsums.new" >/dev/null 2>&1
-if (( $? )); then
+read -ra old_dgst < <(openssl dgst -md5 < "$workdir/pacsums.old")
+read -ra new_dgst < <(openssl dgst -md5 < "$workdir/pacsums.new")
+if [[ ${old_dgst[@]:(-1)} != ${new_dgst[@]:(-1)} ]]; then
 	# failed
 	# leave our pacman-optimize tmpdir for checking to see what doesn't match up
-	rm -rf "$dbroot.new"
+	rm -rf "$localdb.new"
 	die_r "$(gettext "Integrity check FAILED, reverting to old database.")"
 fi
 
@@ -156,15 +157,15 @@
 msg "$(gettext "Rotating database into place...")"
 
 fail=0
-mv "$dbroot" "$dbroot.old" || fail=1
-mv "$dbroot.new" "$dbroot" || fail=1
-chmod --reference="$dbroot.old" "$dbroot" || fail=1
-chown --reference="$dbroot.old" "$dbroot" || fail=1
+mv "$localdb" "$localdb.old" || fail=1
+mv "$localdb.new" "$localdb" || fail=1
+chmod --reference="$localdb.old" "$localdb" || fail=1
+chown --reference="$localdb.old" "$localdb" || fail=1
 if (( fail )); then
 	# failure with our directory shuffle
-	die_r "$(gettext "New database substitution failed. Check for $dbroot,\n$dbroot.old, and $dbroot.new directories.")"
+	die_r "$(gettext "New database substitution failed. Check for %s, %s, and %s directories.")" "$localdb" "$localdb.old" "$localdb.new"
 fi
-rm -rf "$dbroot.old"
+rm -rf "$localdb.old"
 
 # remove the lock file and our working directory with sums and tarfile
 rm -f "$lockfile"
diff -x '.*' -aur pacman-4.0.3/scripts/pkgdelta.sh.in pacman/scripts/pkgdelta.sh.in
--- pacman-4.0.3/scripts/pkgdelta.sh.in	2012-04-07 15:30:59.000000000 +0000
+++ pacman/scripts/pkgdelta.sh.in	2012-10-15 18:11:52.513287879 +0000
@@ -26,23 +26,36 @@
 export TEXTDOMAIN='pacman-scripts'
 export TEXTDOMAINDIR='@localedir@'
 
-myver='@PACKAGE_VERSION@'
+declare -r myver='@PACKAGE_VERSION@'
 
 QUIET=0
 
+# minimal of package before deltas are generated (bytes)
+min_pkg_size=$((1024*1024))
+
+# percent of new package above which the delta will be discarded
+max_delta_size=70
+
+
 # ensure we have a sane umask set
 umask 0022
 
+m4_include(library/parseopts.sh)
 m4_include(library/output_format.sh)
 
 # print usage instructions
 usage() {
 	printf "pkgdelta (pacman) %s\n\n" "$myver"
-	printf -- "$(gettext "Usage: pkgdelta [-q] <package1> <package2>\n")"
+	printf -- "$(gettext "Usage: pkgdelta [options] <package1> <package2>\n")"
 	printf -- "$(gettext "\
 	pkgdelta will create a delta file between two packages.\n\
 This delta file can then be added to a database using repo-add.\n\n")"
 	printf -- "$(gettext "Example:  pkgdelta pacman-3.0.0.pkg.tar.gz pacman-3.0.1.pkg.tar.gz")\n"
+	echo
+	printf -- "$(gettext "Options:\n")"
+	printf -- "$(gettext "  -q, --quiet       minimize output\n")"
+	printf -- "$(gettext "  --min-pkg-size    minimum package size before deltas are generated\n")"
+	printf -- "$(gettext "  --max-delta-size  percent of new package above which the delta will be discarded\n")"
 }
 
 version() {
@@ -53,6 +66,12 @@
 There is NO WARRANTY, to the extent permitted by law.\n")"
 }
 
+m4_include(library/human_to_size.sh)
+
+isnumeric() {
+	[[ $1 != *[!0-9]* ]]
+}
+
 read_pkginfo()
 {
 	pkgname= pkgver= arch=
@@ -93,6 +112,13 @@
 	newver="$pkgver"
 	newarch="$arch"
 
+	pkgsize="$(@SIZECMD@ -L "$newfile")"
+
+	if ((pkgsize < min_pkg_size)); then
+		msg "$(gettext "Skipping delta creation for small package: %s - size %s")" "$newname" "$pkgsize"
+		return 0
+	fi
+
 	if [[ $oldname != "$newname" ]]; then
 		error "$(gettext "The package names don't match : '%s' and '%s'")" "$oldname" "$newname"
 		return 1
@@ -109,46 +135,86 @@
 	fi
 
 	msg "$(gettext "Generating delta from version %s to version %s")" "$oldver" "$newver"
-	deltafile="$(dirname $newfile)/$pkgname-${oldver}_to_${newver}-$arch.delta"
+	deltafile=$(dirname "$newfile")/$pkgname-${oldver}_to_${newver}-$arch.delta
 	local ret=0
 
 	xdelta3 -q -f -s "$oldfile" "$newfile" "$deltafile" || ret=$?
 	if (( ret )); then
 		error "$(gettext "Delta could not be created.")"
 		return 1
-	else
-		msg "$(gettext "Generated delta : '%s'")" "$deltafile"
-		(( QUIET )) && echo "$deltafile"
 	fi
+
+	deltasize="$(@SIZECMD@ -L "$deltafile")"
+
+	if ((max_delta_size * pkgsize / 100 < deltasize)); then
+		msg "$(gettext "Delta package larger than maximum size. Removing.")"
+		rm -f "$deltafile"
+		return 0
+	fi
+
+	msg "$(gettext "Generated delta : '%s'")" "$deltafile"
+	(( QUIET )) && echo "$deltafile"
+
 	return 0
 }
 
-case "$1" in
-	-h|--help)    usage; exit 0 ;;
-	-V|--version) version; exit 0 ;;
-	-q|--quiet)   QUIET=1; shift ;;
-esac
-
-if (( $# != 2 )); then
-	usage
+OPT_SHORT='hqV'
+OPT_LONG=('help' 'quiet' 'max-delta-size:' 'min-pkg-size:' 'version')
+if ! parseopts "$OPT_SHORT" "${OPT_LONG[@]}" -- "$@"; then
 	exit 1
 fi
+set -- "${OPTRET[@]}"
+unset OPT_SHORT OPT_LONG OPTRET
 
-if [[ ! -f $1 ]]; then
-	error "$(gettext "File '%s' does not exist")" "$1"
-	exit 1
-fi
+# parse arguments
+while :; do
+	case $1 in
+		-h|--help)
+			usage
+			exit 0 ;;
+		-V|--version)
+			version
+			exit 0 ;;
+		-q|--quiet)
+			QUIET=1;;
+		--min-pkg-size)
+			if ! min_pkg_size=$(human_to_size "$2"); then
+				echo "invalid argument '$2' for option -- '$1'"
+				exit 1
+			fi
+			shift ;;
+		--max-delta-size)
+			arg=$(awk -v val="$2" 'BEGIN { print val * 100 }')
+			if ! isnumeric "$arg" || (( arg > 200 )); then
+				echo "invalid argument '$2' for option -- '$1'"
+				exit 1
+			fi
+			max_delta_size=$arg
+			shift ;;
+		--)
+			shift
+			break 2 ;;
+	esac
+	shift
+done
 
-if [[ ! -f $2 ]]; then
-	error "$(gettext "File '%s' does not exist")" "$2"
+if (( $# != 2 )); then
+	usage
 	exit 1
 fi
 
+for i in "$@"; do
+	if [[ ! -f $i ]]; then
+		error "$(gettext "File '%s' does not exist")" "$i"
+		exit 1
+	fi
+done
+
 if ! type xdelta3 &>/dev/null; then
 	error "$(gettext "Cannot find the xdelta3 binary! Is xdelta3 installed?")"
 	exit 1
 fi
 
-create_xdelta "$1" "$2"
+create_xdelta "$@"
 
 # vim: set ts=2 sw=2 noet:
diff -x '.*' -aur pacman-4.0.3/scripts/po/POTFILES.in pacman/scripts/po/POTFILES.in
--- pacman-4.0.3/scripts/po/POTFILES.in	2011-10-12 19:04:25.000000000 +0000
+++ pacman/scripts/po/POTFILES.in	2012-10-15 18:11:52.517420474 +0000
@@ -8,4 +8,4 @@
 scripts/pkgdelta.sh.in
 scripts/repo-add.sh.in
 scripts/library/output_format.sh
-scripts/library/parse_options.sh
+scripts/library/parseopts.sh
Only in pacman-4.0.3/scripts/po: ca.gmo
diff -x '.*' -aur pacman-4.0.3/scripts/po/ca.po pacman/scripts/po/ca.po
--- pacman-4.0.3/scripts/po/ca.po	2012-04-07 16:08:59.000000000 +0000
+++ pacman/scripts/po/ca.po	2012-10-15 18:11:52.517420474 +0000
@@ -8,7 +8,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-02-06 13:22+0000\n"
 "Last-Translator: Hector Mtz-Seara <hseara@gmail.com>\n"
 "Language-Team: Catalan (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/scripts/po: cs.gmo
diff -x '.*' -aur pacman-4.0.3/scripts/po/cs.po pacman/scripts/po/cs.po
--- pacman-4.0.3/scripts/po/cs.po	2012-04-07 16:08:59.000000000 +0000
+++ pacman/scripts/po/cs.po	2012-10-15 18:11:52.517420474 +0000
@@ -11,7 +11,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-02-02 06:07+0000\n"
 "Last-Translator: Dan McGee <dpmcgee@gmail.com>\n"
 "Language-Team: Czech (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/scripts/po: da.gmo
diff -x '.*' -aur pacman-4.0.3/scripts/po/da.po pacman/scripts/po/da.po
--- pacman-4.0.3/scripts/po/da.po	2012-04-07 16:08:59.000000000 +0000
+++ pacman/scripts/po/da.po	2012-10-15 18:11:52.517420474 +0000
@@ -8,7 +8,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-03-31 16:48+0000\n"
 "Last-Translator: jakobw <jakob.wadsager@gmail.com>\n"
 "Language-Team: Danish (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/scripts/po: de.gmo
diff -x '.*' -aur pacman-4.0.3/scripts/po/de.po pacman/scripts/po/de.po
--- pacman-4.0.3/scripts/po/de.po	2012-04-07 16:08:59.000000000 +0000
+++ pacman/scripts/po/de.po	2012-10-15 18:11:52.517420474 +0000
@@ -14,7 +14,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-03-29 10:22+0000\n"
 "Last-Translator: Matthias Gorissen <matthias@archlinux.de>\n"
 "Language-Team: German (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/scripts/po: el.gmo
diff -x '.*' -aur pacman-4.0.3/scripts/po/el.po pacman/scripts/po/el.po
--- pacman-4.0.3/scripts/po/el.po	2012-04-07 16:08:59.000000000 +0000
+++ pacman/scripts/po/el.po	2012-10-15 18:11:52.517420474 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-02-02 08:19+0000\n"
 "Last-Translator: Christos Nouskas <nous@archlinux.us>\n"
 "Language-Team: Greek (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/scripts/po: en_GB.gmo
diff -x '.*' -aur pacman-4.0.3/scripts/po/en_GB.po pacman/scripts/po/en_GB.po
--- pacman-4.0.3/scripts/po/en_GB.po	2012-04-07 16:08:59.000000000 +0000
+++ pacman/scripts/po/en_GB.po	2012-10-15 18:11:52.517420474 +0000
@@ -8,8 +8,8 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
-"PO-Revision-Date: 2012-02-02 06:08+0000\n"
+"POT-Creation-Date: 2012-05-20 11:26-0500\n"
+"PO-Revision-Date: 2012-05-20 11:27-0600\n"
 "Last-Translator: Dan McGee <dpmcgee@gmail.com>\n"
 "Language-Team: LANGUAGE <LL@li.org>\n"
 "Language: en_GB\n"
@@ -76,8 +76,7 @@
 msgstr "Generating checksums for source files..."
 
 msgid "Cannot find the %s binary required for generating sourcefile checksums."
-msgstr ""
-"Cannot find the %s binary required for generating sourcefile checksums."
+msgstr "Cannot find the %s binary required for generating sourcefile checksums."
 
 msgid "Invalid integrity algorithm '%s' specified."
 msgstr "Invalid integrity algorithm '%s' specified."
@@ -265,6 +264,9 @@
 msgid "%s is not allowed to start with a hyphen."
 msgstr "%s is not allowed to start with a hyphen."
 
+msgid "%s contains invalid characters: '%s'"
+msgstr "%s contains invalid characters: '%s'"
+
 msgid "%s is not allowed to contain colons, hyphens or whitespace."
 msgstr "%s is not allowed to contain colons, hyphens or whitespace."
 
@@ -317,8 +319,7 @@
 msgstr "Cannot find the %s binary required for verifying source files."
 
 msgid "Cannot find the %s binary required for validating sourcefile checksums."
-msgstr ""
-"Cannot find the %s binary required for validating sourcefile checksums."
+msgstr "Cannot find the %s binary required for validating sourcefile checksums."
 
 msgid "Cannot find the %s binary required for compressing binaries."
 msgstr "Cannot find the %s binary required for compressing binaries."
@@ -386,29 +387,20 @@
 msgid "  -p <file>        Use an alternate build script (instead of '%s')"
 msgstr "  -p <file>        Use an alternate build script (instead of '%s')"
 
-msgid ""
-"  -r, --rmdeps     Remove installed dependencies after a successful build"
-msgstr ""
-"  -r, --rmdeps     Remove installed dependencies after a successful build"
+msgid "  -r, --rmdeps     Remove installed dependencies after a successful build"
+msgstr "  -r, --rmdeps     Remove installed dependencies after a successful build"
 
 msgid "  -R, --repackage  Repackage contents of the package without rebuilding"
-msgstr ""
-"  -R, --repackage  Repackage contents of the package without rebuilding"
+msgstr "  -R, --repackage  Repackage contents of the package without rebuilding"
 
 msgid "  -s, --syncdeps   Install missing dependencies with %s"
 msgstr "  -s, --syncdeps   Install missing dependencies with %s"
 
-msgid ""
-"  -S, --source     Generate a source-only tarball without downloaded sources"
-msgstr ""
-"  -S, --source     Generate a source-only tarball without downloaded sources"
+msgid "  -S, --source     Generate a source-only tarball without downloaded sources"
+msgstr "  -S, --source     Generate a source-only tarball without downloaded sources"
 
-msgid ""
-"  --allsource      Generate a source-only tarball including downloaded "
-"sources"
-msgstr ""
-"  --allsource      Generate a source-only tarball including downloaded "
-"sources"
+msgid "  --allsource      Generate a source-only tarball including downloaded sources"
+msgstr "  --allsource      Generate a source-only tarball including downloaded sources"
 
 msgid "  --asroot         Allow %s to run as root user"
 msgstr "  --asroot         Allow %s to run as root user"
@@ -419,15 +411,11 @@
 msgid "  --config <file>  Use an alternate config file (instead of '%s')"
 msgstr "  --config <file>  Use an alternate config file (instead of '%s')"
 
-msgid ""
-"  --holdver        Prevent automatic version bumping for development %ss"
-msgstr ""
-"  --holdver        Prevent automatic version bumping for development %ss"
+msgid "  --holdver        Prevent automatic version bumping for development %ss"
+msgstr "  --holdver        Prevent automatic version bumping for development %ss"
 
-msgid ""
-"  --key <key>      Specify a key to use for %s signing instead of the default"
-msgstr ""
-"  --key <key>      Specify a key to use for %s signing instead of the default"
+msgid "  --key <key>      Specify a key to use for %s signing instead of the default"
+msgstr "  --key <key>      Specify a key to use for %s signing instead of the default"
 
 msgid "  --nocheck        Do not run the %s function in the %s"
 msgstr "  --nocheck        Do not run the %s function in the %s"
@@ -444,10 +432,8 @@
 msgid "  --skipchecksums  Do not verify checksums of the source files"
 msgstr "  --skipchecksums  Do not verify checksums of the source files"
 
-msgid ""
-"  --skipinteg      Do not perform any verification checks on source files"
-msgstr ""
-"  --skipinteg      Do not perform any verification checks on source files"
+msgid "  --skipinteg      Do not perform any verification checks on source files"
+msgstr "  --skipinteg      Do not perform any verification checks on source files"
 
 msgid "  --skippgpcheck   Do not verify source files with PGP signatures"
 msgstr "  --skippgpcheck   Do not verify source files with PGP signatures"
@@ -455,10 +441,8 @@
 msgid "These options can be passed to %s:"
 msgstr "These options can be passed to %s:"
 
-msgid ""
-"  --noconfirm      Do not ask for confirmation when resolving dependencies"
-msgstr ""
-"  --noconfirm      Do not ask for confirmation when resolving dependencies"
+msgid "  --noconfirm      Do not ask for confirmation when resolving dependencies"
+msgstr "  --noconfirm      Do not ask for confirmation when resolving dependencies"
 
 msgid "  --noprogressbar  Do not show a progress bar when downloading files"
 msgstr "  --noprogressbar  Do not show a progress bar when downloading files"
@@ -467,15 +451,17 @@
 msgstr "If %s is not specified, %s will look for '%s'"
 
 msgid ""
-"Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>."
-"\\nCopyright (C) 2002-2006 Judd Vinet <jvinet@zeroflux.org>.\\n\\nThis is "
-"free software; see the source for copying conditions.\\nThere is NO "
-"WARRANTY, to the extent permitted by law.\\n"
-msgstr ""
-"Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>."
-"\\nCopyright (C) 2002-2006 Judd Vinet <jvinet@zeroflux.org>.\\n\\nThis is "
-"free software; see the source for copying conditions.\\nThere is NO "
-"WARRANTY, to the extent permitted by law.\\n"
+"Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>.\\n"
+"Copyright (C) 2002-2006 Judd Vinet <jvinet@zeroflux.org>.\\n"
+"\\n"
+"This is free software; see the source for copying conditions.\\n"
+"There is NO WARRANTY, to the extent permitted by law.\\n"
+msgstr ""
+"Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>.\\n"
+"Copyright (C) 2002-2006 Judd Vinet <jvinet@zeroflux.org>.\\n"
+"\\n"
+"This is free software; see the source for copying conditions.\\n"
+"There is NO WARRANTY, to the extent permitted by law.\\n"
 
 msgid "%s signal caught. Exiting..."
 msgstr "%s signal caught. Exiting..."
@@ -505,29 +491,29 @@
 msgstr "\\0%s and %s cannot both be specified"
 
 msgid ""
-"Running %s as root is a BAD idea and can cause permanent,\\ncatastrophic "
-"damage to your system. If you wish to run as root, please\\nuse the %s "
-"option."
+"Running %s as root is a BAD idea and can cause permanent,\\n"
+"catastrophic damage to your system. If you wish to run as root, please\\n"
+"use the %s option."
 msgstr ""
-"Running %s as root is a BAD idea and can cause permanent,\\ncatastrophic "
-"damage to your system. If you wish to run as root, please\\nuse the %s "
-"option."
+"Running %s as root is a BAD idea and can cause permanent,\\n"
+"catastrophic damage to your system. If you wish to run as root, please\\n"
+"use the %s option."
 
 msgid ""
-"The %s option is meant for the root user only. Please\\nrerun %s without the "
-"%s flag."
+"The %s option is meant for the root user only. Please\\n"
+"rerun %s without the %s flag."
 msgstr ""
-"The %s option is meant for the root user only. Please\\nrerun %s without the "
-"%s flag."
+"The %s option is meant for the root user only. Please\\n"
+"rerun %s without the %s flag."
 
 msgid ""
-"Running %s as an unprivileged user will result in non-root\\nownership of "
-"the packaged files. Try using the %s environment by\\nplacing %s in the %s "
-"array in %s."
+"Running %s as an unprivileged user will result in non-root\\n"
+"ownership of the packaged files. Try using the %s environment by\\n"
+"placing %s in the %s array in %s."
 msgstr ""
-"Running %s as an unprivileged user will result in non-root\\nownership of "
-"the packaged files. Try using the %s environment by\\nplacing %s in the %s "
-"array in %s."
+"Running %s as an unprivileged user will result in non-root\\n"
+"ownership of the packaged files. Try using the %s environment by\\n"
+"placing %s in the %s array in %s."
 
 msgid "Do not use the %s option. This option is only for use by %s."
 msgstr "Do not use the %s option. This option is only for use by %s."
@@ -550,17 +536,14 @@
 msgid "A package has already been built. (use %s to overwrite)"
 msgstr "A package has already been built. (use %s to overwrite)"
 
-msgid ""
-"The package group has already been built, installing existing packages..."
-msgstr ""
-"The package group has already been built, installing existing packages..."
+msgid "The package group has already been built, installing existing packages..."
+msgstr "The package group has already been built, installing existing packages..."
 
 msgid "The package group has already been built. (use %s to overwrite)"
 msgstr "The package group has already been built. (use %s to overwrite)"
 
 msgid "Part of the package group has already been built. (use %s to overwrite)"
-msgstr ""
-"Part of the package group has already been built. (use %s to overwrite)"
+msgstr "Part of the package group has already been built. (use %s to overwrite)"
 
 msgid "Leaving %s environment."
 msgstr "Leaving %s environment."
@@ -623,13 +606,13 @@
 msgstr "Usage: %s [pacman_db_root]"
 
 msgid ""
-"Copyright (c) 2010-2012 Pacman Development Team <pacman-dev@archlinux.org>."
-"\\nThis is free software; see the source for copying conditions.\\nThere is "
-"NO WARRANTY, to the extent permitted by law.\\n"
-msgstr ""
-"Copyright (c) 2010-2012 Pacman Development Team <pacman-dev@archlinux.org>."
-"\\nThis is free software; see the source for copying conditions.\\nThere is "
-"NO WARRANTY, to the extent permitted by law.\\n"
+"Copyright (c) 2010-2012 Pacman Development Team <pacman-dev@archlinux.org>.\\n"
+"This is free software; see the source for copying conditions.\\n"
+"There is NO WARRANTY, to the extent permitted by law.\\n"
+msgstr ""
+"Copyright (c) 2010-2012 Pacman Development Team <pacman-dev@archlinux.org>.\\n"
+"This is free software; see the source for copying conditions.\\n"
+"There is NO WARRANTY, to the extent permitted by law.\\n"
 
 msgid "%s does not exist or is not a directory."
 msgstr "%s does not exist or is not a directory."
@@ -661,10 +644,8 @@
 msgid "  -e, --export [keyid(s)]   Export the specified or all keyids"
 msgstr "  -e, --export [keyid(s)]   Export the specified or all keyids"
 
-msgid ""
-"  -f, --finger [keyid(s)]   List fingerprint for specified or all keyids"
-msgstr ""
-"  -f, --finger [keyid(s)]   List fingerprint for specified or all keyids"
+msgid "  -f, --finger [keyid(s)]   List fingerprint for specified or all keyids"
+msgstr "  -f, --finger [keyid(s)]   List fingerprint for specified or all keyids"
 
 msgid "  -h, --help                Show this help message and exit"
 msgstr "  -h, --help                Show this help message and exit"
@@ -685,33 +666,27 @@
 msgstr "  -V, --version             Show program version"
 
 msgid ""
-"  --config <file>           Use an alternate config file (instead of"
-"\\n                            '%s')"
+"  --config <file>           Use an alternate config file (instead of\\n"
+"                            '%s')"
 msgstr ""
-"  --config <file>           Use an alternate config file (instead of"
-"\\n                            '%s')"
+"  --config <file>           Use an alternate config file (instead of\\n"
+"                            '%s')"
 
-msgid ""
-"  --edit-key <keyid(s)>     Present a menu for key management task on keyids"
-msgstr ""
-"  --edit-key <keyid(s)>     Present a menu for key management task on keyids"
+msgid "  --edit-key <keyid(s)>     Present a menu for key management task on keyids"
+msgstr "  --edit-key <keyid(s)>     Present a menu for key management task on keyids"
 
 msgid ""
-"  --gpgdir <dir>            Set an alternate directory for GnuPG (instead"
-"\\n                            of '%s')"
+"  --gpgdir <dir>            Set an alternate directory for GnuPG (instead\\n"
+"                            of '%s')"
 msgstr ""
-"  --gpgdir <dir>            Set an alternate directory for GnuPG (instead"
-"\\n                            of '%s')"
+"  --gpgdir <dir>            Set an alternate directory for GnuPG (instead\\n"
+"                            of '%s')"
 
 msgid "  --import <dir(s)>         Imports pubring.gpg from dir(s)"
 msgstr "  --import <dir(s)>         Imports pubring.gpg from dir(s)"
 
-msgid ""
-"  --import-trustdb <dir(s)> Imports ownertrust values from trustdb.gpg in dir"
-"(s)"
-msgstr ""
-"  --import-trustdb <dir(s)> Imports ownertrust values from trustdb.gpg in dir"
-"(s)"
+msgid "  --import-trustdb <dir(s)> Imports ownertrust values from trustdb.gpg in dir(s)"
+msgstr "  --import-trustdb <dir(s)> Imports ownertrust values from trustdb.gpg in dir(s)"
 
 msgid "  --init                    Ensure the keyring is properly initialized"
 msgstr "  --init                    Ensure the keyring is properly initialised"
@@ -726,16 +701,14 @@
 msgstr "  --lsign-key <keyid>       Locally sign the specified keyid"
 
 msgid ""
-"  --populate [keyring(s)]   Reload the default keys from the (given) keyrings"
-"\\n                            in '%s'"
+"  --populate [keyring(s)]   Reload the default keys from the (given) keyrings\\n"
+"                            in '%s'"
 msgstr ""
-"  --populate [keyring(s)]   Reload the default keys from the (given) keyrings"
-"\\n                            in '%s'"
+"  --populate [keyring(s)]   Reload the default keys from the (given) keyrings\\n"
+"                            in '%s'"
 
-msgid ""
-"  --refresh-keys [keyid(s)] Update specified or all keys from a keyserver"
-msgstr ""
-"  --refresh-keys [keyid(s)] Update specified or all keys from a keyserver"
+msgid "  --refresh-keys [keyid(s)] Update specified or all keys from a keyserver"
+msgstr "  --refresh-keys [keyid(s)] Update specified or all keys from a keyserver"
 
 msgid "The key identified by %s could not be found locally."
 msgstr "The key identified by %s could not be found locally."
@@ -779,17 +752,17 @@
 msgid "Disabling key %s..."
 msgstr "Disabling key %s..."
 
-msgid "A specified keyfile could not be added to the gpg keychain."
-msgstr "A specified keyfile could not be added to the gpg keychain."
+msgid "A specified keyfile could not be added to the keyring."
+msgstr "A specified keyfile could not be added to the keyring."
 
-msgid "A specified key could not be removed from the gpg keychain."
-msgstr "A specified key could not be removed from the gpg keychain."
+msgid "A specified key could not be removed from the keyring."
+msgstr "A specified key could not be removed from the keyring."
 
 msgid "The key identified by %s could not be edited."
 msgstr "The key identified by %s could not be edited."
 
-msgid "A specified key could not be exported from the gpg keychain."
-msgstr "A specified key could not be exported from the gpg keychain."
+msgid "A specified key could not be exported from the keyring."
+msgstr "A specified key could not be exported from the keyring."
 
 msgid "The fingerprint of a specified key could not be determined."
 msgstr "The fingerprint of a specified key could not be determined."
@@ -843,26 +816,28 @@
 msgstr "Please run %s with each operation separately."
 
 msgid ""
-"pacman-optimize is a little hack that should improve the performance\\nof "
-"pacman when reading/writing to its filesystem-based database.\\n\\n"
-msgstr ""
-"pacman-optimize is a little hack that should improve the performance\\nof "
-"pacman when reading/writing to its filesystem-based database.\\n\\n"
-
-msgid ""
-"Because pacman uses many small files to keep track of packages,\\nthere is a "
-"tendency for these files to become fragmented over time.\\nThis script "
-"attempts to relocate these small files into one\\ncontinuous location on "
-"your hard drive. The result is that the hard\\ndrive should be able to read "
-"them faster, since the hard drive head\\ndoes not have to move around the "
-"disk as much.\\n"
-msgstr ""
-"Because pacman uses many small files to keep track of packages,\\nthere is a "
-"tendency for these files to become fragmented over time.\\nThis script "
-"attempts to relocate these small files into one\\ncontinuous location on "
-"your hard drive. The result is that the hard\\ndrive should be able to read "
-"them faster, since the hard drive head\\ndoes not have to move around the "
-"disk as much.\\n"
+"pacman-optimize is a little hack that should improve the performance\\n"
+"of pacman when reading/writing to its filesystem-based database.\\n"
+"\\n"
+msgstr ""
+"pacman-optimize is a little hack that should improve the performance\\n"
+"of pacman when reading/writing to its filesystem-based database.\\n"
+"\\n"
+
+msgid ""
+"Because pacman uses many small files to keep track of packages,\\n"
+"there is a tendency for these files to become fragmented over time.\\n"
+"This script attempts to relocate these small files into one\\n"
+"continuous location on your hard drive. The result is that the hard\\n"
+"drive should be able to read them faster, since the hard drive head\\n"
+"does not have to move around the disk as much.\\n"
+msgstr ""
+"Because pacman uses many small files to keep track of packages,\\n"
+"there is a tendency for these files to become fragmented over time.\\n"
+"This script attempts to relocate these small files into one\\n"
+"continuous location on your hard drive. The result is that the hard\\n"
+"drive should be able to read them faster, since the hard drive head\\n"
+"does not have to move around the disk as much.\\n"
 
 msgid "diff tool was not found, please install diffutils."
 msgstr "diff tool was not found, please install diffutils."
@@ -903,31 +878,50 @@
 msgid "Finished. Your pacman database has been optimized."
 msgstr "Finished. Your pacman database has been optimised."
 
-msgid "Usage: pkgdelta [-q] <package1> <package2>\\n"
-msgstr "Usage: pkgdelta [-q] <package1> <package2>\\n"
+msgid "Usage: pkgdelta [options] <package1> <package2>\\n"
+msgstr "Usage: pkgdelta [options] <package1> <package2>\\n"
 
 msgid ""
-"\tpkgdelta will create a delta file between two packages.\\nThis delta file "
-"can then be added to a database using repo-add.\\n\\n"
+"\tpkgdelta will create a delta file between two packages.\\n"
+"This delta file can then be added to a database using repo-add.\\n"
+"\\n"
 msgstr ""
-"\tpkgdelta will create a delta file between two packages.\\nThis delta file "
-"can then be added to a database using repo-add.\\n\\n"
+"\tpkgdelta will create a delta file between two packages.\\n"
+"This delta file can then be added to a database using repo-add.\\n"
+"\\n"
 
 msgid "Example:  pkgdelta pacman-3.0.0.pkg.tar.gz pacman-3.0.1.pkg.tar.gz"
 msgstr "Example:  pkgdelta pacman-3.0.0.pkg.tar.gz pacman-3.0.1.pkg.tar.gz"
 
+msgid "Options:\\n"
+msgstr "Options:\\n"
+
+msgid "  -q, --quiet       minimize output\\n"
+msgstr "  -q, --quiet       minimise output\\n"
+
+msgid "  --min-pkg-size    minimum package size before deltas are generated (bytes)\\n"
+msgstr "  --min-pkg-size    minimum package size before deltas are generated (bytes)\\n"
+
+msgid "  --max-delta-size  percent of package size above which deltas will be discarded\\n"
+msgstr "  --max-delta-size  percent of package size above which deltas will be discarded\\n"
+
 msgid ""
-"Copyright (c) 2009 Xavier Chantry <shiningxc@gmail.com>.\\n\\nThis is free "
-"software; see the source for copying conditions.\\nThere is NO WARRANTY, to "
-"the extent permitted by law.\\n"
-msgstr ""
-"Copyright (c) 2009 Xavier Chantry <shiningxc@gmail.com>.\\n\\nThis is free "
-"software; see the source for copying conditions.\\nThere is NO WARRANTY, to "
-"the extent permitted by law.\\n"
+"Copyright (c) 2009 Xavier Chantry <shiningxc@gmail.com>.\\n"
+"\\n"
+"This is free software; see the source for copying conditions.\\n"
+"There is NO WARRANTY, to the extent permitted by law.\\n"
+msgstr ""
+"Copyright (c) 2009 Xavier Chantry <shiningxc@gmail.com>.\\n"
+"\\n"
+"This is free software; see the source for copying conditions.\\n"
+"There is NO WARRANTY, to the extent permitted by law.\\n"
 
 msgid "Invalid package file '%s'."
 msgstr "Invalid package file '%s'."
 
+msgid "Skipping delta creation for small package: %s - size %s"
+msgstr "Skipping delta creation for small package: %s - size %s"
+
 msgid "The package names don't match : '%s' and '%s'"
 msgstr "The package names don't match : '%s' and '%s'"
 
@@ -943,6 +937,9 @@
 msgid "Delta could not be created."
 msgstr "Delta could not be created."
 
+msgid "Delta package larger than maximum size. Removing."
+msgstr "Delta package larger than maximum size. Removing."
+
 msgid "Generated delta : '%s'"
 msgstr "Generated delta : '%s'"
 
@@ -956,14 +953,11 @@
 msgstr "Usage: repo-add [options] <path-to-db> <package|delta> ...\\n"
 
 msgid ""
-"repo-add will update a package database by reading a package file."
-"\\nMultiple packages to add can be specified on the command line.\\n"
+"repo-add will update a package database by reading a package file.\\n"
+"Multiple packages to add can be specified on the command line.\\n"
 msgstr ""
-"repo-add will update a package database by reading a package file."
-"\\nMultiple packages to add can be specified on the command line.\\n"
-
-msgid "Options:\\n"
-msgstr "Options:\\n"
+"repo-add will update a package database by reading a package file.\\n"
+"Multiple packages to add can be specified on the command line.\\n"
 
 msgid "  -d, --delta       generate and add delta for package update\\n"
 msgstr "  -d, --delta       generate and add delta for package update\\n"
@@ -975,20 +969,17 @@
 msgstr "Usage: repo-remove [options] <path-to-db> <packagename|delta> ...\\n"
 
 msgid ""
-"repo-remove will update a package database by removing the package name"
-"\\nspecified on the command line from the given repo database. Multiple"
-"\\npackages to remove can be specified on the command line.\\n"
-msgstr ""
-"repo-remove will update a package database by removing the package name"
-"\\nspecified on the command line from the given repo database. Multiple"
-"\\npackages to remove can be specified on the command line.\\n"
+"repo-remove will update a package database by removing the package name\\n"
+"specified on the command line from the given repo database. Multiple\\n"
+"packages to remove can be specified on the command line.\\n"
+msgstr ""
+"repo-remove will update a package database by removing the package name\\n"
+"specified on the command line from the given repo database. Multiple\\n"
+"packages to remove can be specified on the command line.\\n"
 
 msgid "Please move along, there is nothing to see here.\\n"
 msgstr "Please move along, there is nothing to see here.\\n"
 
-msgid "  -q, --quiet       minimize output\\n"
-msgstr "  -q, --quiet       minimise output\\n"
-
 msgid "  -s, --sign        sign database with GnuPG after update\\n"
 msgstr "  -s, --sign        sign database with GnuPG after update\\n"
 
@@ -999,26 +990,28 @@
 msgstr "  -v, --verify      verify database's signature before update\\n"
 
 msgid ""
-"\\nSee %s(8) for more details and descriptions of the available options.\\n"
+"\\n"
+"See %s(8) for more details and descriptions of the available options.\\n"
 msgstr ""
-"\\nSee %s(8) for more details and descriptions of the available options.\\n"
+"\\n"
+"See %s(8) for more details and descriptions of the available options.\\n"
 
-msgid ""
-"Example:  repo-add /path/to/repo.db.tar.gz pacman-3.0.0-1-i686.pkg.tar.gz\\n"
-msgstr ""
-"Example:  repo-add /path/to/repo.db.tar.gz pacman-3.0.0-1-i686.pkg.tar.gz\\n"
+msgid "Example:  repo-add /path/to/repo.db.tar.gz pacman-3.0.0-1-i686.pkg.tar.gz\\n"
+msgstr "Example:  repo-add /path/to/repo.db.tar.gz pacman-3.0.0-1-i686.pkg.tar.gz\\n"
 
 msgid "Example:  repo-remove /path/to/repo.db.tar.gz kernel26\\n"
 msgstr "Example:  repo-remove /path/to/repo.db.tar.gz kernel26\\n"
 
 msgid ""
 "Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>\\n"
-"\\nThis is free software; see the source for copying conditions.\\nThere is "
-"NO WARRANTY, to the extent permitted by law.\\n"
+"\\n"
+"This is free software; see the source for copying conditions.\\n"
+"There is NO WARRANTY, to the extent permitted by law.\\n"
 msgstr ""
 "Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>\\n"
-"\\nThis is free software; see the source for copying conditions.\\nThere is "
-"NO WARRANTY, to the extent permitted by law.\\n"
+"\\n"
+"This is free software; see the source for copying conditions.\\n"
+"There is NO WARRANTY, to the extent permitted by law.\\n"
 
 msgid "No database entry for package '%s'."
 msgstr "No database entry for package '%s'."
@@ -1133,3 +1126,6 @@
 
 msgid "unrecognized option"
 msgstr "unrecognised option"
+
+#~ msgid "quiet\\n"
+#~ msgstr "quiet\\n"
Only in pacman-4.0.3/scripts/po: es.gmo
diff -x '.*' -aur pacman-4.0.3/scripts/po/es.po pacman/scripts/po/es.po
--- pacman-4.0.3/scripts/po/es.po	2012-04-07 16:08:59.000000000 +0000
+++ pacman/scripts/po/es.po	2012-10-15 18:11:52.521285884 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-04-01 16:26+0000\n"
 "Last-Translator: Angel Velasquez <angvp@archlinux.org>\n"
 "Language-Team: Spanish (Castilian) (http://www.transifex.net/projects/p/"
Only in pacman-4.0.3/scripts/po: fi.gmo
diff -x '.*' -aur pacman-4.0.3/scripts/po/fi.po pacman/scripts/po/fi.po
--- pacman-4.0.3/scripts/po/fi.po	2012-04-07 16:08:59.000000000 +0000
+++ pacman/scripts/po/fi.po	2012-10-15 18:11:52.521285884 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-02-10 22:06+0000\n"
 "Last-Translator: Larso <larso@gmx.com>\n"
 "Language-Team: Finnish (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/scripts/po: fr.gmo
diff -x '.*' -aur pacman-4.0.3/scripts/po/fr.po pacman/scripts/po/fr.po
--- pacman-4.0.3/scripts/po/fr.po	2012-04-07 16:08:59.000000000 +0000
+++ pacman/scripts/po/fr.po	2012-10-15 18:11:52.521285884 +0000
@@ -12,7 +12,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-02-07 03:54+0000\n"
 "Last-Translator: Dan McGee <dpmcgee@gmail.com>\n"
 "Language-Team: French (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/scripts/po: hu.gmo
diff -x '.*' -aur pacman-4.0.3/scripts/po/hu.po pacman/scripts/po/hu.po
--- pacman-4.0.3/scripts/po/hu.po	2012-04-07 16:08:59.000000000 +0000
+++ pacman/scripts/po/hu.po	2012-10-15 18:11:52.521285884 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-02-08 01:42+0000\n"
 "Last-Translator: György Balló <ballogy@freestart.hu>\n"
 "Language-Team: Hungarian (http://www.transifex.net/projects/p/archlinux-"
Only in pacman-4.0.3/scripts/po: it.gmo
diff -x '.*' -aur pacman-4.0.3/scripts/po/it.po pacman/scripts/po/it.po
--- pacman-4.0.3/scripts/po/it.po	2012-04-07 16:08:59.000000000 +0000
+++ pacman/scripts/po/it.po	2012-10-15 18:11:52.521285884 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-02-16 19:28+0000\n"
 "Last-Translator: Giovanni Scafora <giovanni@archlinux.org>\n"
 "Language-Team: Italian (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/scripts/po: kk.gmo
diff -x '.*' -aur pacman-4.0.3/scripts/po/kk.po pacman/scripts/po/kk.po
--- pacman-4.0.3/scripts/po/kk.po	2012-04-07 16:09:00.000000000 +0000
+++ pacman/scripts/po/kk.po	2012-10-15 18:11:52.525415394 +0000
@@ -7,7 +7,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-02-02 06:08+0000\n"
 "Last-Translator: Dan McGee <dpmcgee@gmail.com>\n"
 "Language-Team: Kazakh (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/scripts/po: lt.gmo
diff -x '.*' -aur pacman-4.0.3/scripts/po/lt.po pacman/scripts/po/lt.po
--- pacman-4.0.3/scripts/po/lt.po	2012-04-07 16:09:00.000000000 +0000
+++ pacman/scripts/po/lt.po	2012-10-15 18:11:52.525415394 +0000
@@ -11,7 +11,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-02-05 07:27+0000\n"
 "Last-Translator: Algimantas Margevičius <margevicius.algimantas@gmail.com>\n"
 "Language-Team: Lithuanian (http://www.transifex.net/projects/p/archlinux-"
Only in pacman-4.0.3/scripts/po: nb.gmo
diff -x '.*' -aur pacman-4.0.3/scripts/po/nb.po pacman/scripts/po/nb.po
--- pacman-4.0.3/scripts/po/nb.po	2012-04-07 16:09:00.000000000 +0000
+++ pacman/scripts/po/nb.po	2012-10-15 18:11:52.525415394 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-02-03 09:12+0000\n"
 "Last-Translator: Alexander Rødseth <rodseth@gmail.com>\n"
 "Language-Team: Norwegian Bokmål (http://www.transifex.net/projects/p/"
diff -x '.*' -aur pacman-4.0.3/scripts/po/pacman-scripts.pot pacman/scripts/po/pacman-scripts.pot
--- pacman-4.0.3/scripts/po/pacman-scripts.pot	2012-04-07 16:08:59.000000000 +0000
+++ pacman/scripts/po/pacman-scripts.pot	2012-10-15 18:11:52.525415394 +0000
@@ -8,7 +8,7 @@
 msgstr ""
 "Project-Id-Version: pacman 4.0.3\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-05-20 11:26-0500\n"
 "PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
 "Language-Team: LANGUAGE <LL@li.org>\n"
@@ -263,6 +263,9 @@
 msgid "%s is not allowed to start with a hyphen."
 msgstr ""
 
+msgid "%s contains invalid characters: '%s'"
+msgstr ""
+
 msgid "%s is not allowed to contain colons, hyphens or whitespace."
 msgstr ""
 
@@ -739,16 +742,16 @@
 msgid "Disabling key %s..."
 msgstr ""
 
-msgid "A specified keyfile could not be added to the gpg keychain."
+msgid "A specified keyfile could not be added to the keyring."
 msgstr ""
 
-msgid "A specified key could not be removed from the gpg keychain."
+msgid "A specified key could not be removed from the keyring."
 msgstr ""
 
 msgid "The key identified by %s could not be edited."
 msgstr ""
 
-msgid "A specified key could not be exported from the gpg keychain."
+msgid "A specified key could not be exported from the keyring."
 msgstr ""
 
 msgid "The fingerprint of a specified key could not be determined."
@@ -855,7 +858,7 @@
 msgid "Finished. Your pacman database has been optimized."
 msgstr ""
 
-msgid "Usage: pkgdelta [-q] <package1> <package2>\\n"
+msgid "Usage: pkgdelta [options] <package1> <package2>\\n"
 msgstr ""
 
 msgid ""
@@ -866,6 +869,22 @@
 msgid "Example:  pkgdelta pacman-3.0.0.pkg.tar.gz pacman-3.0.1.pkg.tar.gz"
 msgstr ""
 
+msgid "Options:\\n"
+msgstr ""
+
+msgid "  -q, --quiet       minimize output\\n"
+msgstr ""
+
+msgid ""
+"  --min-pkg-size    minimum package size before deltas are generated "
+"(bytes)\\n"
+msgstr ""
+
+msgid ""
+"  --max-delta-size  percent of package size above which deltas will be "
+"discarded\\n"
+msgstr ""
+
 msgid ""
 "Copyright (c) 2009 Xavier Chantry <shiningxc@gmail.com>.\\n\\nThis is free "
 "software; see the source for copying conditions.\\nThere is NO WARRANTY, to "
@@ -875,6 +894,9 @@
 msgid "Invalid package file '%s'."
 msgstr ""
 
+msgid "Skipping delta creation for small package: %s - size %s"
+msgstr ""
+
 msgid "The package names don't match : '%s' and '%s'"
 msgstr ""
 
@@ -890,6 +912,9 @@
 msgid "Delta could not be created."
 msgstr ""
 
+msgid "Delta package larger than maximum size. Removing."
+msgstr ""
+
 msgid "Generated delta : '%s'"
 msgstr ""
 
@@ -907,9 +932,6 @@
 "\\nMultiple packages to add can be specified on the command line.\\n"
 msgstr ""
 
-msgid "Options:\\n"
-msgstr ""
-
 msgid "  -d, --delta       generate and add delta for package update\\n"
 msgstr ""
 
@@ -928,9 +950,6 @@
 msgid "Please move along, there is nothing to see here.\\n"
 msgstr ""
 
-msgid "  -q, --quiet       minimize output\\n"
-msgstr ""
-
 msgid "  -s, --sign        sign database with GnuPG after update\\n"
 msgstr ""
 
Only in pacman-4.0.3/scripts/po: pl.gmo
diff -x '.*' -aur pacman-4.0.3/scripts/po/pl.po pacman/scripts/po/pl.po
--- pacman-4.0.3/scripts/po/pl.po	2012-04-07 16:09:00.000000000 +0000
+++ pacman/scripts/po/pl.po	2012-10-15 18:11:52.525415394 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-02-02 06:07+0000\n"
 "Last-Translator: Dan McGee <dpmcgee@gmail.com>\n"
 "Language-Team: Polish (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/scripts/po: pt.gmo
diff -x '.*' -aur pacman-4.0.3/scripts/po/pt.po pacman/scripts/po/pt.po
--- pacman-4.0.3/scripts/po/pt.po	2012-04-07 16:09:00.000000000 +0000
+++ pacman/scripts/po/pt.po	2012-10-15 18:11:52.525415394 +0000
@@ -10,7 +10,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-02-06 13:17+0000\n"
 "Last-Translator: R00KIE <registosites@hotmail.com>\n"
 "Language-Team: Portuguese (http://www.transifex.net/projects/p/archlinux-"
Only in pacman-4.0.3/scripts/po: pt_BR.gmo
diff -x '.*' -aur pacman-4.0.3/scripts/po/pt_BR.po pacman/scripts/po/pt_BR.po
--- pacman-4.0.3/scripts/po/pt_BR.po	2012-04-07 16:09:00.000000000 +0000
+++ pacman/scripts/po/pt_BR.po	2012-10-15 18:11:52.525415394 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-02-27 22:00+0000\n"
 "Last-Translator: Rafael Ferreira <rafael.f.f1@gmail.com>\n"
 "Language-Team: Portuguese (Brazil) (http://www.transifex.net/projects/p/"
Only in pacman-4.0.3/scripts/po: ro.gmo
diff -x '.*' -aur pacman-4.0.3/scripts/po/ro.po pacman/scripts/po/ro.po
--- pacman-4.0.3/scripts/po/ro.po	2012-04-07 16:09:00.000000000 +0000
+++ pacman/scripts/po/ro.po	2012-10-15 18:11:52.525415394 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-02-06 12:39+0000\n"
 "Last-Translator: Ionut Biru <ibiru@archlinux.org>\n"
 "Language-Team: Romanian (http://www.transifex.net/projects/p/archlinux-"
Only in pacman-4.0.3/scripts/po: ru.gmo
diff -x '.*' -aur pacman-4.0.3/scripts/po/ru.po pacman/scripts/po/ru.po
--- pacman-4.0.3/scripts/po/ru.po	2012-04-07 16:09:00.000000000 +0000
+++ pacman/scripts/po/ru.po	2012-10-15 18:11:52.525415394 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-04-07 03:19+0000\n"
 "Last-Translator: AlexanderR <alexander.r@gmx.com>\n"
 "Language-Team: Russian (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/scripts/po: sk.gmo
diff -x '.*' -aur pacman-4.0.3/scripts/po/sk.po pacman/scripts/po/sk.po
--- pacman-4.0.3/scripts/po/sk.po	2012-04-07 16:09:00.000000000 +0000
+++ pacman/scripts/po/sk.po	2012-10-15 18:11:52.529299254 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-03-29 07:31+0000\n"
 "Last-Translator: archetyp <archetyp@linuxmail.org>\n"
 "Language-Team: Slovak (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/scripts/po: sr.gmo
diff -x '.*' -aur pacman-4.0.3/scripts/po/sr.po pacman/scripts/po/sr.po
--- pacman-4.0.3/scripts/po/sr.po	2012-04-07 16:09:00.000000000 +0000
+++ pacman/scripts/po/sr.po	2012-10-15 18:11:52.529299254 +0000
@@ -8,7 +8,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-02-02 06:07+0000\n"
 "Last-Translator: Dan McGee <dpmcgee@gmail.com>\n"
 "Language-Team: Serbian (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/scripts/po: sr@latin.gmo
diff -x '.*' -aur pacman-4.0.3/scripts/po/sr@latin.po pacman/scripts/po/sr@latin.po
--- pacman-4.0.3/scripts/po/sr@latin.po	2012-04-07 16:09:00.000000000 +0000
+++ pacman/scripts/po/sr@latin.po	2012-10-15 18:11:52.529299254 +0000
@@ -8,7 +8,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-02-02 06:07+0000\n"
 "Last-Translator: Dan McGee <dpmcgee@gmail.com>\n"
 "Language-Team: Serbian (Latin) (http://www.transifex.net/projects/p/"
Only in pacman-4.0.3/scripts/po: stamp-po
Only in pacman-4.0.3/scripts/po: sv.gmo
diff -x '.*' -aur pacman-4.0.3/scripts/po/sv.po pacman/scripts/po/sv.po
--- pacman-4.0.3/scripts/po/sv.po	2012-04-07 16:09:00.000000000 +0000
+++ pacman/scripts/po/sv.po	2012-10-15 18:11:52.529299254 +0000
@@ -8,7 +8,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-03-24 21:35+0000\n"
 "Last-Translator: Kim Svensson <ks@linux.com>\n"
 "Language-Team: Swedish (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/scripts/po: tr.gmo
diff -x '.*' -aur pacman-4.0.3/scripts/po/tr.po pacman/scripts/po/tr.po
--- pacman-4.0.3/scripts/po/tr.po	2012-04-07 16:09:00.000000000 +0000
+++ pacman/scripts/po/tr.po	2012-10-15 18:11:52.529299254 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-02-03 10:50+0000\n"
 "Last-Translator: Samed Beyribey <ras0ir@eventualis.org>\n"
 "Language-Team: Turkish (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/scripts/po: uk.gmo
diff -x '.*' -aur pacman-4.0.3/scripts/po/uk.po pacman/scripts/po/uk.po
--- pacman-4.0.3/scripts/po/uk.po	2012-04-07 16:09:00.000000000 +0000
+++ pacman/scripts/po/uk.po	2012-10-15 18:11:52.529299254 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-03-27 20:05+0000\n"
 "Last-Translator: Yarema aka Knedlyk <yupadmin@gmail.com>\n"
 "Language-Team: Ukrainian (http://www.transifex.net/projects/p/archlinux-"
Only in pacman-4.0.3/scripts/po: zh_CN.gmo
diff -x '.*' -aur pacman-4.0.3/scripts/po/zh_CN.po pacman/scripts/po/zh_CN.po
--- pacman-4.0.3/scripts/po/zh_CN.po	2012-04-07 16:09:00.000000000 +0000
+++ pacman/scripts/po/zh_CN.po	2012-10-15 18:11:52.529299254 +0000
@@ -10,7 +10,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-02-05 02:05+0000\n"
 "Last-Translator: 甘 露 <rhythm.gan@gmail.com>\n"
 "Language-Team: Chinese (China) (http://www.transifex.net/projects/p/"
Only in pacman-4.0.3/scripts/po: zh_TW.gmo
diff -x '.*' -aur pacman-4.0.3/scripts/po/zh_TW.po pacman/scripts/po/zh_TW.po
--- pacman-4.0.3/scripts/po/zh_TW.po	2012-04-07 16:09:00.000000000 +0000
+++ pacman/scripts/po/zh_TW.po	2012-10-15 18:11:52.529299254 +0000
@@ -7,7 +7,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-28 18:00-0500\n"
 "PO-Revision-Date: 2012-02-02 06:08+0000\n"
 "Last-Translator: Dan McGee <dpmcgee@gmail.com>\n"
 "Language-Team: Chinese (Taiwan) (http://www.transifex.net/projects/p/"
Only in pacman-4.0.3/scripts: rankmirrors.sh.in
diff -x '.*' -aur pacman-4.0.3/scripts/repo-add.sh.in pacman/scripts/repo-add.sh.in
--- pacman-4.0.3/scripts/repo-add.sh.in	2012-03-05 17:44:34.000000000 +0000
+++ pacman/scripts/repo-add.sh.in	2012-10-15 18:11:52.529299254 +0000
@@ -25,8 +25,8 @@
 export TEXTDOMAIN='pacman-scripts'
 export TEXTDOMAINDIR='@localedir@'
 
-myver='@PACKAGE_VERSION@'
-confdir='@sysconfdir@'
+declare -r myver='@PACKAGE_VERSION@'
+declare -r confdir='@sysconfdir@'
 
 QUIET=0
 DELTA=0
@@ -108,7 +108,7 @@
 find_pkgentry() {
 	local pkgname=$1
 	local pkgentry
-	for pkgentry in $tmpdir/tree/$pkgname*; do
+	for pkgentry in "$tmpdir/tree/$pkgname"*; do
 		name=${pkgentry##*/}
 		if [[ ${name%-*-*} = $pkgname ]]; then
 			echo $pkgentry
@@ -129,31 +129,31 @@
 # write a delta entry
 #   arg1 - path to delta file
 db_write_delta() {
-	deltafile="$1"
-	pkgname="$(get_delta_pkgname $deltafile)"
+	deltafile=$1
+	pkgname=$(get_delta_pkgname "$deltafile")
 
-	pkgentry=$(find_pkgentry $pkgname)
+	pkgentry=$(find_pkgentry "$pkgname")
 	if [[ -z $pkgentry ]]; then
 		error "$(gettext "No database entry for package '%s'.")" "$pkgname"
 		return 1
 	fi
-	deltas="$pkgentry/deltas"
+	deltas=$pkgentry/deltas
 	if [[ ! -f $deltas ]]; then
-		echo -e "%DELTAS%" >$deltas
+		echo -e "%DELTAS%" >"$deltas"
 	fi
 	# get md5sum and compressed size of package
-	md5sum="$(openssl dgst -md5 "$deltafile")"
-	md5sum="${md5sum##* }"
+	md5sum=$(openssl dgst -md5 "$deltafile")
+	md5sum=${md5sum##* }
 	csize=$(@SIZECMD@ -L "$deltafile")
 
-	oldfile=$(xdelta3 printhdr $deltafile | grep "XDELTA filename (source)" | sed 's/.*: *//')
-	newfile=$(xdelta3 printhdr $deltafile | grep "XDELTA filename (output)" | sed 's/.*: *//')
+	oldfile=$(xdelta3 printhdr "$deltafile" | grep "XDELTA filename (source)" | sed 's/.*: *//')
+	newfile=$(xdelta3 printhdr "$deltafile" | grep "XDELTA filename (output)" | sed 's/.*: *//')
 
-	if grep -q "$oldfile.*$newfile" $deltas; then
-		sed -i.backup "/$oldfile.*$newfile/d" $deltas && rm -f $deltas.backup
+	if grep -q "$oldfile.*$newfile" "$deltas"; then
+		sed -i.backup "/$oldfile.*$newfile/d" "$deltas" && rm -f "$deltas.backup"
 	fi
 	msg2 "$(gettext "Adding 'deltas' entry : %s -> %s")" "$oldfile" "$newfile"
-	echo ${deltafile##*/} $md5sum $csize $oldfile $newfile >> $deltas
+	echo "${deltafile##*/} $md5sum $csize $oldfile $newfile" >> "$deltas"
 
 	return 0
 } # end db_write_delta
@@ -161,21 +161,26 @@
 # remove a delta entry
 #   arg1 - path to delta file
 db_remove_delta() {
-	deltafile="$1"
+	deltafile=$1
 	filename=${deltafile##*/}
-	pkgname="$(get_delta_pkgname $deltafile)"
+	pkgname=$(get_delta_pkgname "$deltafile")
 
-	pkgentry=$(find_pkgentry $pkgname)
+	pkgentry=$(find_pkgentry "$pkgname")
 	if [[ -z $pkgentry ]]; then
 		return 1
 	fi
-	deltas="$pkgentry/deltas"
+	deltas=$pkgentry/deltas
 	if [[ ! -f $deltas ]]; then
 		return 1
 	fi
-	if grep -q "$filename" $deltas; then
-		sed -i.backup "/$filename/d" $deltas && rm -f $deltas.backup
+	if grep -q "$filename" "$deltas"; then
+		sed -i.backup "/$filename/d" "$deltas" && rm -f "$deltas.backup"
 		msg2 "$(gettext "Removing existing entry '%s'...")" "$filename"
+		# empty deltas file contains only "%DELTAS%"
+		if (( $(wc -l < "$deltas") == 1 )); then
+			msg2 "$(gettext "Removing empty deltas file ...")"
+			rm "$deltas"
+		fi
 		return 0
 	fi
 
@@ -192,7 +197,7 @@
 # sign the package database once repackaged
 create_signature() {
 	(( ! SIGN )) && return
-	local dbfile="$1"
+	local dbfile=$1
 	local ret=0
 	msg "$(gettext "Signing database...")"
 
@@ -203,7 +208,7 @@
 	gpg --detach-sign --use-agent ${SIGNWITHKEY} "$dbfile" &>/dev/null || ret=$?
 
 	if (( ! ret )); then
-		msg2 "$(gettext "Created signature file %s.")" "${dbfile##*/}.sig"
+		msg2 "$(gettext "Created signature file %s.")" "${dbfile##*/.tmp.}.sig"
 	else
 		warning "$(gettext "Failed to sign package database.")"
 	fi
@@ -212,7 +217,7 @@
 # verify the existing package database signature
 verify_signature() {
 	(( ! VERIFY )) && return
-	local dbfile="$1"
+	local dbfile=$1
 	local ret=0
 	msg "$(gettext "Verifying database signature...")"
 
@@ -232,7 +237,7 @@
 verify_repo_extension() {
 	local repofile=$1
 
-	case "$repofile" in
+	case $repofile in
 		*.@(db|files).tar.gz)  TAR_OPT="z" ;;
 		*.@(db|files).tar.bz2) TAR_OPT="j" ;;
 		*.@(db|files).tar.xz)  TAR_OPT="J" ;;
@@ -250,8 +255,9 @@
 #   arg1 - path to package
 db_write_entry() {
 	# blank out all variables
-	local pkgfile="$1"
-	local -a _groups _licenses _replaces _depends _conflicts _provides _optdepends
+	local pkgfile=$1
+	local -a _groups _licenses _replaces _depends _conflicts _provides \
+		_optdepends _makedepends _checkdepends
 	local pkgname pkgver pkgdesc csize size url arch builddate packager \
 		md5sum sha256sum pgpsig pgpsigsize
 
@@ -263,14 +269,16 @@
 
 		# normalize whitespace with an extglob
 		declare "$var=${val//+([[:space:]])/ }"
-		case "$var" in
-			group)     _groups+=("$group") ;;
-			license)   _licenses+=("$license") ;;
-			replaces)  _replaces+=("$replaces") ;;
-			depend)    _depends+=("$depend") ;;
-			conflict)  _conflicts+=("$conflict") ;;
-			provides)  _provides+=("$provides") ;;
+		case $var in
+			group) _groups+=("$group") ;;
+			license) _licenses+=("$license") ;;
+			replaces) _replaces+=("$replaces") ;;
+			depend) _depends+=("$depend") ;;
+			conflict) _conflicts+=("$conflict") ;;
+			provides) _provides+=("$provides") ;;
 			optdepend) _optdepends+=("$optdepend") ;;
+			makedepend) _makedepends+=("$makedepend") ;;
+			checkdepend) _checkdepends+=("$checkdepend") ;;
 		esac
 	done< <(bsdtar -xOqf "$pkgfile" .PKGINFO)
 
@@ -284,10 +292,10 @@
 		warning "$(gettext "An entry for '%s' already existed")" "$pkgname-$pkgver"
 	else
 		if (( DELTA )); then
-			pkgentry=$(find_pkgentry $pkgname)
+			pkgentry=$(find_pkgentry "$pkgname")
 			if [[ -n $pkgentry ]]; then
-				local oldfilename=$(grep -A1 FILENAME $pkgentry/desc | tail -n1)
-				local oldfile="$(dirname $1)/$oldfilename"
+				local oldfilename=$(grep -A1 FILENAME "$pkgentry/desc" | tail -n1)
+				local oldfile="$(dirname "$1")/$oldfilename"
 			fi
 		fi
 	fi
@@ -307,10 +315,10 @@
 
 	# compute checksums
 	msg2 "$(gettext "Computing checksums...")"
-	md5sum="$(openssl dgst -md5 "$pkgfile")"
-	md5sum="${md5sum##* }"
-	sha256sum="$(openssl dgst -sha256 "$pkgfile")"
-	sha256sum="${sha256sum##* }"
+	md5sum=$(openssl dgst -md5 "$pkgfile")
+	md5sum=${md5sum##* }
+	sha256sum=$(openssl dgst -sha256 "$pkgfile")
+	sha256sum=${sha256sum##* }
 
 	# remove an existing entry if it exists, ignore failures
 	db_remove_entry "$pkgname"
@@ -353,10 +361,12 @@
 	# create depends entry
 	msg2 "$(gettext "Creating '%s' db entry...")" 'depends'
 	{
-		format_entry "DEPENDS"    "${_depends[@]}"
-		format_entry "CONFLICTS"  "${_conflicts[@]}"
-		format_entry "PROVIDES"   "${_provides[@]}"
+		format_entry "DEPENDS" "${_depends[@]}"
+		format_entry "CONFLICTS" "${_conflicts[@]}"
+		format_entry "PROVIDES" "${_provides[@]}"
 		format_entry "OPTDEPENDS" "${_optdepends[@]}"
+		format_entry "MAKEDEPENDS" "${_makedepends[@]}"
+		format_entry "CHECKDEPENDS" "${_checkdepends[@]}"
 	} >'depends'
 
 	popd >/dev/null
@@ -366,17 +376,17 @@
 	if (( WITHFILES )); then
 		msg2 "$(gettext "Creating '%s' db entry...")" 'files'
 		local files_path="$tmpdir/tree/$pkgname-$pkgver/files"
-		echo "%FILES%" >$files_path
-		bsdtar --exclude='^.*' -tf "$pkgfile" >>$files_path
+		echo "%FILES%" >"$files_path"
+		bsdtar --exclude='^.*' -tf "$pkgfile" >>"$files_path"
 	fi
 
 	# create a delta file
 	if (( DELTA )); then
 		if [[ -n $oldfilename ]]; then
 			if [[ -f $oldfile ]]; then
-				delta=$(pkgdelta -q $oldfile $1)
+				delta=$(pkgdelta -q "$oldfile" "$1")
 				if [[ -f $delta ]]; then
-					db_write_delta $delta
+					db_write_delta "$delta"
 				fi
 			else
 				warning "$(gettext "Old package file not found: %s")" "$oldfilename"
@@ -392,7 +402,7 @@
 db_remove_entry() {
 	local pkgname=$1
 	local notfound=1
-	local pkgentry=$(find_pkgentry $pkgname)
+	local pkgentry=$(find_pkgentry "$pkgname")
 	while [[ -n $pkgentry ]]; do
 		notfound=0
 		if [[ -f $pkgentry/deltas ]]; then
@@ -400,8 +410,8 @@
 		fi
 		msg2 "$(gettext "Removing existing entry '%s'...")" \
 		"${pkgentry##*/}"
-		rm -rf $pkgentry
-		pkgentry=$(find_pkgentry $pkgname)
+		rm -rf "$pkgentry"
+		pkgentry=$(find_pkgentry "$pkgname")
 	done
 	return $notfound
 } # end db_remove_entry
@@ -424,15 +434,10 @@
 check_repo_db() {
 	local repodir
 
-	# ensure the path to the DB exists
-	if [[ "$LOCKFILE" == /* ]]; then
-		repodir=${LOCKFILE%/*}/
-	else
-		repodir=$PWD/$LOCKFILE
-		repodir=${repodir%/*}/
-	fi
+	# ensure the path to the DB exists; $LOCKFILE is always an absolute path
+	repodir=${LOCKFILE%/*}/
 
-	if [[ ! -d "$repodir" ]]; then
+	if [[ ! -d $repodir ]]; then
 		error "$(gettext "%s does not exist or is not a directory.")" "$repodir"
 		exit 1
 	fi
@@ -442,7 +447,7 @@
 		CLEAN_LOCK=1
 	else
 		error "$(gettext "Failed to acquire lockfile: %s.")" "$LOCKFILE"
-		[[ -f $LOCKFILE ]] && error "$(gettext "Held by process %s")" "$(cat $LOCKFILE)"
+		[[ -f $LOCKFILE ]] && error "$(gettext "Held by process %s")" "$(cat "$LOCKFILE")"
 		exit 1
 	fi
 
@@ -460,7 +465,7 @@
 		msg "$(gettext "Extracting database to a temporary location...")"
 		bsdtar -xf "$REPO_DB_FILE" -C "$tmpdir/tree"
 	else
-		case "$cmd" in
+		case $cmd in
 			repo-remove)
 			error "$(gettext "Repository file '%s' was not found.")" "$REPO_DB_FILE"
 			exit 1
@@ -562,7 +567,7 @@
 	}
 fi
 
-case "$1" in
+case $1 in
 	-h|--help) usage; exit 0;;
 	-V|--version) version; exit 0;;
 esac
@@ -579,10 +584,10 @@
 	exit 1
 fi
 
-tmpdir=$(mktemp -d /tmp/repo-tools.XXXXXXXXXX) || (\
+tmpdir=$(mktemp -d "${TMPDIR:-/tmp}/repo-tools.XXXXXXXXXX") || (\
 	error "$(gettext "Cannot create temp directory for database building.")"; \
 	exit 1)
-mkdir $tmpdir/tree
+mkdir "$tmpdir/tree"
 
 trap 'clean_up' EXIT
 for signal in TERM HUP QUIT; do
@@ -595,7 +600,7 @@
 success=0
 # parse arguments
 while (( $# )); do
-	case "$1" in
+	case $1 in
 		-q|--quiet) QUIET=1;;
 		-d|--delta) DELTA=1;;
 		-f|--files) WITHFILES=1;;
@@ -614,7 +619,7 @@
 		-k|--key)
 			check_gpg
 			shift
-			GPGKEY="$1"
+			GPGKEY=$1
 			if ! gpg --list-key ${GPGKEY} &>/dev/null; then
 				error "$(gettext "The key ${GPGKEY} does not exist in your keyring.")"
 				exit 1
@@ -637,13 +642,17 @@
 	exit 1
 fi
 
-LOCKFILE=$REPO_DB_FILE.lck
+if [[ $REPO_DB_FILE == /* ]]; then
+	LOCKFILE=$REPO_DB_FILE.lck
+else
+	LOCKFILE=$PWD/$REPO_DB_FILE.lck
+fi
 
 verify_repo_extension "$REPO_DB_FILE" >/dev/null
 check_repo_db
 
 for arg in "${args[@]:1}"; do
-	case "$cmd" in
+	case $cmd in
 		repo-add) add "$arg" ;;
 		repo-remove) remove "$arg" ;;
 	esac && success=1
@@ -654,37 +663,51 @@
 	msg "$(gettext "Creating updated database file '%s'")" "$REPO_DB_FILE"
 
 	TAR_OPT=$(verify_repo_extension "$REPO_DB_FILE")
+	# $LOCKFILE is already guaranteed to be absolute so this is safe
+	dirname=${LOCKFILE%/*}
 	filename=${REPO_DB_FILE##*/}
+	# this ensures we create it on the same filesystem, making moves atomic
+	tempname=$dirname/.tmp.$filename
 
 	pushd "$tmpdir/tree" >/dev/null
 	if ( shopt -s nullglob; files=(*); (( ${#files[*]} )) ); then
-		bsdtar -c${TAR_OPT}f "$tmpdir/$filename" *
+		bsdtar -c${TAR_OPT}f "$tempname" *
 	else
 		# we have no packages remaining? zip up some emptyness
 		warning "$(gettext "No packages remain, creating empty database.")"
-		bsdtar -c${TAR_OPT}f "$tmpdir/$filename" -T /dev/null
+		bsdtar -c${TAR_OPT}f "$tempname" -T /dev/null
 	fi
 	popd >/dev/null
 
-	create_signature "$tmpdir/$filename"
+	create_signature "$tempname"
 
-	[[ -f $REPO_DB_FILE ]] && mv -f "$REPO_DB_FILE" "${REPO_DB_FILE}.old"
+	# hardlink or move the previous version of the database and signature to .old
+	# extension as a backup measure
+	if [[ -f $REPO_DB_FILE ]]; then
+		ln -f "$REPO_DB_FILE" "$REPO_DB_FILE.old" 2>/dev/null || \
+			mv -f "$REPO_DB_FILE" "$REPO_DB_FILE.old"
+	fi
 	if [[ -f $REPO_DB_FILE.sig ]]; then
-		mv -f "$REPO_DB_FILE.sig" "$REPO_DB_FILE.old.sig"
+		ln -f "$REPO_DB_FILE.sig" "$REPO_DB_FILE.old.sig" 2>/dev/null || \
+			mv -f "$REPO_DB_FILE.sig" "$REPO_DB_FILE.old.sig"
 	else
 		rm -f "$REPO_DB_FILE.old.sig"
 	fi
-	[[ -f $tmpdir/$filename ]] && mv "$tmpdir/$filename" "$REPO_DB_FILE"
-	[[ -f $tmpdir/$filename.sig ]] && mv "$tmpdir/$filename.sig" "$REPO_DB_FILE.sig"
-	dblink="${REPO_DB_FILE%.tar*}"
-	target=${REPO_DB_FILE##*/}
+
+	# rotate the newly-created database and signature into place
+	mv "$tempname" "$REPO_DB_FILE"
+	if [[ -f $tempname.sig ]]; then
+		mv "$tempname.sig" "$REPO_DB_FILE.sig"
+	fi
+
+	dblink=${REPO_DB_FILE%.tar*}
 	rm -f "$dblink" "$dblink.sig"
-	ln -s "$target" "$dblink" 2>/dev/null || \
-		ln "$target" "$dblink" 2>/dev/null || \
+	ln -s "$filename" "$dblink" 2>/dev/null || \
+		ln "$filename" "$dblink" 2>/dev/null || \
 		cp "$REPO_DB_FILE" "$dblink"
 	if [[ -f "$REPO_DB_FILE.sig" ]]; then
-		ln -s "$target.sig" "$dblink.sig" 2>/dev/null || \
-			ln "$target.sig" "$dblink.sig" 2>/dev/null || \
+		ln -s "$filename.sig" "$dblink.sig" 2>/dev/null || \
+			ln "$filename.sig" "$dblink.sig" 2>/dev/null || \
 			cp "$REPO_DB_FILE.sig" "$dblink.sig"
 	fi
 else
diff -x '.*' -aur pacman-4.0.3/src/pacman/Makefile.am pacman/src/pacman/Makefile.am
--- pacman-4.0.3/src/pacman/Makefile.am	2011-10-12 19:04:25.000000000 +0000
+++ pacman/src/pacman/Makefile.am	2012-10-15 18:11:52.529299254 +0000
@@ -11,15 +11,17 @@
 
 DEFS = -DLOCALEDIR=\"@localedir@\" \
        -DCONFFILE=\"$(conffile)\" \
-       -DROOTDIR=\"$(ROOTDIR)\" \
        -DDBPATH=\"$(dbpath)\" \
        -DGPGDIR=\"$(gpgdir)\" \
        -DCACHEDIR=\"$(cachedir)\" \
        -DLOGFILE=\"$(logfile)\" \
        @DEFS@
-INCLUDES = -I$(top_srcdir)/lib/libalpm
 
-AM_CFLAGS = -pedantic -D_GNU_SOURCE
+AM_CPPFLAGS = \
+	-imacros $(top_builddir)/config.h \
+	-I$(top_srcdir)/lib/libalpm
+
+AM_CFLAGS = -pedantic -D_GNU_SOURCE $(WARNING_CFLAGS)
 
 if USE_GIT_VERSION
 GIT_VERSION := $(shell sh -c 'git describe --abbrev=4 --dirty | sed s/^v//')
diff -x '.*' -aur pacman-4.0.3/src/pacman/Makefile.in pacman/src/pacman/Makefile.in
--- pacman-4.0.3/src/pacman/Makefile.in	2012-04-07 15:58:14.000000000 +0000
+++ pacman/src/pacman/Makefile.in	2012-10-15 18:12:23.101273168 +0000
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.11.4 from Makefile.am.
+# Makefile.in generated by automake 1.12 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -54,20 +54,23 @@
 bin_PROGRAMS = pacman$(EXEEXT)
 @USE_GIT_VERSION_TRUE@am__append_1 = -DGIT_VERSION=\"$(GIT_VERSION)\"
 subdir = src/pacman
-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in \
+	$(top_srcdir)/build-aux/depcomp \
+	$(top_srcdir)/build-aux/mkinstalldirs
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/m4/gettext.m4 \
+am__aclocal_m4_deps = $(top_srcdir)/m4/acinclude.m4 \
+	$(top_srcdir)/m4/gettext.m4 $(top_srcdir)/m4/gpgme.m4 \
 	$(top_srcdir)/m4/iconv.m4 $(top_srcdir)/m4/intlmacosx.m4 \
 	$(top_srcdir)/m4/lib-ld.m4 $(top_srcdir)/m4/lib-link.m4 \
-	$(top_srcdir)/m4/lib-prefix.m4 $(top_srcdir)/m4/libcurl.m4 \
-	$(top_srcdir)/m4/libtool.m4 $(top_srcdir)/m4/ltoptions.m4 \
-	$(top_srcdir)/m4/ltsugar.m4 $(top_srcdir)/m4/ltversion.m4 \
-	$(top_srcdir)/m4/lt~obsolete.m4 $(top_srcdir)/m4/nls.m4 \
+	$(top_srcdir)/m4/lib-prefix.m4 $(top_srcdir)/m4/libtool.m4 \
+	$(top_srcdir)/m4/ltoptions.m4 $(top_srcdir)/m4/ltsugar.m4 \
+	$(top_srcdir)/m4/ltversion.m4 $(top_srcdir)/m4/lt~obsolete.m4 \
+	$(top_srcdir)/m4/nls.m4 $(top_srcdir)/m4/pkg.m4 \
 	$(top_srcdir)/m4/po.m4 $(top_srcdir)/m4/progtest.m4 \
-	$(top_srcdir)/acinclude.m4 $(top_srcdir)/configure.ac
+	$(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
-mkinstalldirs = $(SHELL) $(top_srcdir)/mkinstalldirs
+mkinstalldirs = $(SHELL) $(top_srcdir)/build-aux/mkinstalldirs
 CONFIG_HEADER = $(top_builddir)/config.h
 CONFIG_CLEAN_FILES =
 CONFIG_CLEAN_VPATH_FILES =
@@ -82,19 +85,35 @@
 am__DEPENDENCIES_1 =
 pacman_DEPENDENCIES = $(am__DEPENDENCIES_1) \
 	$(top_builddir)/lib/libalpm/.libs/libalpm.la
+AM_V_lt = $(am__v_lt_@AM_V@)
+am__v_lt_ = $(am__v_lt_@AM_DEFAULT_V@)
+am__v_lt_0 = --silent
 DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
-depcomp = $(SHELL) $(top_srcdir)/depcomp
+depcomp = $(SHELL) $(top_srcdir)/build-aux/depcomp
 am__depfiles_maybe = depfiles
 am__mv = mv -f
 COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
 	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
-LTCOMPILE = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
-	--mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
-	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+LTCOMPILE = $(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) \
+	$(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) \
+	$(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) \
+	$(AM_CFLAGS) $(CFLAGS)
+AM_V_CC = $(am__v_CC_@AM_V@)
+am__v_CC_ = $(am__v_CC_@AM_DEFAULT_V@)
+am__v_CC_0 = @echo "  CC      " $@;
+AM_V_at = $(am__v_at_@AM_V@)
+am__v_at_ = $(am__v_at_@AM_DEFAULT_V@)
+am__v_at_0 = @
 CCLD = $(CC)
-LINK = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
-	--mode=link $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) \
-	$(LDFLAGS) -o $@
+LINK = $(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) \
+	$(LIBTOOLFLAGS) --mode=link $(CCLD) $(AM_CFLAGS) $(CFLAGS) \
+	$(AM_LDFLAGS) $(LDFLAGS) -o $@
+AM_V_CCLD = $(am__v_CCLD_@AM_V@)
+am__v_CCLD_ = $(am__v_CCLD_@AM_DEFAULT_V@)
+am__v_CCLD_0 = @echo "  CCLD    " $@;
+AM_V_GEN = $(am__v_GEN_@AM_V@)
+am__v_GEN_ = $(am__v_GEN_@AM_DEFAULT_V@)
+am__v_GEN_0 = @echo "  GEN     " $@;
 SOURCES = $(pacman_SOURCES)
 DIST_SOURCES = $(pacman_SOURCES)
 RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
@@ -145,6 +164,7 @@
   reldir="$$dir2"
 ACLOCAL = @ACLOCAL@
 AMTAR = @AMTAR@
+AM_DEFAULT_VERBOSITY = @AM_DEFAULT_VERBOSITY@
 AR = @AR@
 ASCIIDOC = @ASCIIDOC@
 AUTOCONF = @AUTOCONF@
@@ -160,15 +180,11 @@
 CHOST = @CHOST@
 CPP = @CPP@
 CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXCPP = @CXXCPP@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
 CYGPATH_W = @CYGPATH_W@
 DEFS = -DLOCALEDIR=\"@localedir@\" -DCONFFILE=\"$(conffile)\" \
-	-DROOTDIR=\"$(ROOTDIR)\" -DDBPATH=\"$(dbpath)\" \
-	-DGPGDIR=\"$(gpgdir)\" -DCACHEDIR=\"$(cachedir)\" \
-	-DLOGFILE=\"$(logfile)\" @DEFS@ $(am__append_1)
+	-DDBPATH=\"$(dbpath)\" -DGPGDIR=\"$(gpgdir)\" \
+	-DCACHEDIR=\"$(cachedir)\" -DLOGFILE=\"$(logfile)\" @DEFS@ \
+	$(am__append_1)
 DEPDIR = @DEPDIR@
 DLLTOOL = @DLLTOOL@
 DOXYGEN = @DOXYGEN@
@@ -185,7 +201,11 @@
 GIT = @GIT@
 GMSGFMT = @GMSGFMT@
 GMSGFMT_015 = @GMSGFMT_015@
+GPGME_CFLAGS = @GPGME_CFLAGS@
+GPGME_CONFIG = @GPGME_CONFIG@
+GPGME_LIBS = @GPGME_LIBS@
 GREP = @GREP@
+INODECMD = @INODECMD@
 INSTALL = @INSTALL@
 INSTALL_DATA = @INSTALL_DATA@
 INSTALL_PROGRAM = @INSTALL_PROGRAM@
@@ -195,12 +215,16 @@
 INTL_MACOSX_LIBS = @INTL_MACOSX_LIBS@
 LD = @LD@
 LDFLAGS = @LDFLAGS@
-LIBCURL = @LIBCURL@
-LIBCURL_CPPFLAGS = @LIBCURL_CPPFLAGS@
+LIBARCHIVE_CFLAGS = @LIBARCHIVE_CFLAGS@
+LIBARCHIVE_LIBS = @LIBARCHIVE_LIBS@
+LIBCURL_CFLAGS = @LIBCURL_CFLAGS@
+LIBCURL_LIBS = @LIBCURL_LIBS@
 LIBICONV = @LIBICONV@
 LIBINTL = @LIBINTL@
 LIBOBJS = @LIBOBJS@
 LIBS = @LIBS@
+LIBSSL_CFLAGS = @LIBSSL_CFLAGS@
+LIBSSL_LIBS = @LIBSSL_LIBS@
 LIBTOOL = @LIBTOOL@
 LIB_VERSION = @LIB_VERSION@
 LIB_VERSION_INFO = @LIB_VERSION_INFO@
@@ -230,10 +254,14 @@
 PACKAGE_VERSION = @PACKAGE_VERSION@
 PATH_SEPARATOR = @PATH_SEPARATOR@
 PKGEXT = @PKGEXT@
+PKG_CONFIG = @PKG_CONFIG@
+PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
+PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 POSUB = @POSUB@
 PYTHON = @PYTHON@
 RANLIB = @RANLIB@
 ROOTDIR = @ROOTDIR@
+SCRIPTLET_SHELL = @SCRIPTLET_SHELL@
 SED = @SED@
 SEDINPLACE = @SEDINPLACE@
 SET_MAKE = @SET_MAKE@
@@ -246,17 +274,16 @@
 STRIP_STATIC = @STRIP_STATIC@
 USE_NLS = @USE_NLS@
 VERSION = @VERSION@
+WARNING_CFLAGS = @WARNING_CFLAGS@
 XGETTEXT = @XGETTEXT@
 XGETTEXT_015 = @XGETTEXT_015@
 XGETTEXT_EXTRA_OPTIONS = @XGETTEXT_EXTRA_OPTIONS@
-_libcurl_config = @_libcurl_config@
 abs_builddir = @abs_builddir@
 abs_srcdir = @abs_srcdir@
 abs_top_builddir = @abs_top_builddir@
 abs_top_srcdir = @abs_top_srcdir@
 ac_ct_AR = @ac_ct_AR@
 ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
 ac_ct_DUMPBIN = @ac_ct_DUMPBIN@
 am__include = @am__include@
 am__leading_dot = @am__leading_dot@
@@ -311,8 +338,11 @@
 gpgdir = ${sysconfdir}/pacman.d/gnupg/
 cachedir = ${localstatedir}/cache/pacman/pkg/
 logfile = ${localstatedir}/log/pacman.log
-INCLUDES = -I$(top_srcdir)/lib/libalpm
-AM_CFLAGS = -pedantic -D_GNU_SOURCE
+AM_CPPFLAGS = \
+	-imacros $(top_builddir)/config.h \
+	-I$(top_srcdir)/lib/libalpm
+
+AM_CFLAGS = -pedantic -D_GNU_SOURCE $(WARNING_CFLAGS)
 @USE_GIT_VERSION_TRUE@GIT_VERSION := $(shell sh -c 'git describe --abbrev=4 --dirty | sed s/^v//')
 pacman_SOURCES = \
 	conf.h conf.c \
@@ -410,7 +440,7 @@
 	rm -f $$list
 pacman$(EXEEXT): $(pacman_OBJECTS) $(pacman_DEPENDENCIES) $(EXTRA_pacman_DEPENDENCIES) 
 	@rm -f pacman$(EXEEXT)
-	$(LINK) $(pacman_OBJECTS) $(pacman_LDADD) $(LIBS)
+	$(AM_V_CCLD)$(LINK) $(pacman_OBJECTS) $(pacman_LDADD) $(LIBS)
 
 mostlyclean-compile:
 	-rm -f *.$(OBJEXT)
@@ -431,25 +461,25 @@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/util.Po@am__quote@
 
 .c.o:
-@am__fastdepCC_TRUE@	$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
-@am__fastdepCC_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(COMPILE) -c $<
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c $<
 
 .c.obj:
-@am__fastdepCC_TRUE@	$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
-@am__fastdepCC_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(COMPILE) -c `$(CYGPATH_W) '$<'`
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c `$(CYGPATH_W) '$<'`
 
 .c.lo:
-@am__fastdepCC_TRUE@	$(LTCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
-@am__fastdepCC_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Plo
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='$<' object='$@' libtool=yes @AMDEPBACKSLASH@
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LTCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=yes @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(LTCOMPILE) -c -o $@ $<
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LTCOMPILE) -c -o $@ $<
 
 mostlyclean-libtool:
 	-rm -f *.lo
@@ -458,11 +488,11 @@
 	-rm -rf .libs _libs
 
 # This directory's subdirectories are mostly independent; you can cd
-# into them and run `make' without going through this Makefile.
-# To change the values of `make' variables: instead of editing Makefiles,
-# (1) if the variable is set in `config.status', edit `config.status'
-#     (which will cause the Makefiles to be regenerated when you run `make');
-# (2) otherwise, pass the desired values on the `make' command line.
+# into them and run 'make' without going through this Makefile.
+# To change the values of 'make' variables: instead of editing Makefiles,
+# (1) if the variable is set in 'config.status', edit 'config.status'
+#     (which will cause the Makefiles to be regenerated when you run 'make');
+# (2) otherwise, pass the desired values on the 'make' command line.
 $(RECURSIVE_TARGETS):
 	@fail= failcom='exit 1'; \
 	for f in x $$MAKEFLAGS; do \
@@ -526,6 +556,10 @@
 	list='$(SUBDIRS)'; for subdir in $$list; do \
 	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) ctags); \
 	done
+cscopelist-recursive:
+	list='$(SUBDIRS)'; for subdir in $$list; do \
+	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) cscopelist); \
+	done
 
 ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
 	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
@@ -589,6 +623,20 @@
 	  && $(am__cd) $(top_srcdir) \
 	  && gtags -i $(GTAGS_ARGS) "$$here"
 
+cscopelist: cscopelist-recursive $(HEADERS) $(SOURCES) $(LISP)
+	list='$(SOURCES) $(HEADERS) $(LISP)'; \
+	case "$(srcdir)" in \
+	  [\\/]* | ?:[\\/]*) sdir="$(srcdir)" ;; \
+	  *) sdir=$(subdir)/$(srcdir) ;; \
+	esac; \
+	for i in $$list; do \
+	  if test -f "$$i"; then \
+	    echo "$(subdir)/$$i"; \
+	  else \
+	    echo "$$sdir/$$i"; \
+	  fi; \
+	done >> $(top_builddir)/cscope.files
+
 distclean-tags:
 	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
 
@@ -755,24 +803,25 @@
 
 uninstall-am: uninstall-binPROGRAMS
 
-.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) ctags-recursive \
-	install-am install-strip tags-recursive
+.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) \
+	cscopelist-recursive ctags-recursive install-am install-strip \
+	tags-recursive
 
 .PHONY: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) CTAGS GTAGS \
 	all all-am check check-am clean clean-binPROGRAMS \
-	clean-generic clean-libtool ctags ctags-recursive distclean \
-	distclean-compile distclean-generic distclean-libtool \
-	distclean-tags distdir dvi dvi-am html html-am info info-am \
-	install install-am install-binPROGRAMS install-data \
-	install-data-am install-dvi install-dvi-am install-exec \
-	install-exec-am install-html install-html-am install-info \
-	install-info-am install-man install-pdf install-pdf-am \
-	install-ps install-ps-am install-strip installcheck \
-	installcheck-am installdirs installdirs-am maintainer-clean \
-	maintainer-clean-generic mostlyclean mostlyclean-compile \
-	mostlyclean-generic mostlyclean-libtool pdf pdf-am ps ps-am \
-	tags tags-recursive uninstall uninstall-am \
-	uninstall-binPROGRAMS
+	clean-generic clean-libtool cscopelist cscopelist-recursive \
+	ctags ctags-recursive distclean distclean-compile \
+	distclean-generic distclean-libtool distclean-tags distdir dvi \
+	dvi-am html html-am info info-am install install-am \
+	install-binPROGRAMS install-data install-data-am install-dvi \
+	install-dvi-am install-exec install-exec-am install-html \
+	install-html-am install-info install-info-am install-man \
+	install-pdf install-pdf-am install-ps install-ps-am \
+	install-strip installcheck installcheck-am installdirs \
+	installdirs-am maintainer-clean maintainer-clean-generic \
+	mostlyclean mostlyclean-compile mostlyclean-generic \
+	mostlyclean-libtool pdf pdf-am ps ps-am tags tags-recursive \
+	uninstall uninstall-am uninstall-binPROGRAMS
 
 
 # vim:set ts=2 sw=2 noet:
diff -x '.*' -aur pacman-4.0.3/src/pacman/callback.c pacman/src/pacman/callback.c
--- pacman-4.0.3/src/pacman/callback.c	2012-02-02 23:19:15.000000000 +0000
+++ pacman/src/pacman/callback.c	2012-10-15 18:11:52.529299254 +0000
@@ -1,7 +1,7 @@
 /*
  *  callback.c
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -18,13 +18,12 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
 #include <sys/time.h>
 #include <sys/types.h> /* off_t */
+#include <time.h>
 #include <unistd.h>
 #include <wchar.h>
 #include <limits.h> /* UINT_MAX */
@@ -44,15 +43,19 @@
 static int on_progress = 0;
 static alpm_list_t *output = NULL;
 
-/* Silly little helper function, determines if the caller needs a visual update
+/* update speed for the fill_progress based functions */
+#define UPDATE_SPEED_MS 200
+
+/**
+ * Silly little helper function, determines if the caller needs a visual update
  * since the last time this function was called.
- * This is made for the two progress bar functions, to prevent flicker
- *
- * first_call indicates if this is the first time it is called, for
- * initialization purposes */
-static double get_update_timediff(int first_call)
+ * This is made for the two progress bar functions, to prevent flicker.
+ * @param first_call 1 on first call for initialization purposes, 0 otherwise
+ * @return number of milliseconds since last call
+ */
+static long get_update_timediff(int first_call)
 {
-	double retval = 0.0;
+	long retval = 0;
 	static struct timeval last_time = {0, 0};
 
 	/* on first call, simply set the last time and return */
@@ -60,18 +63,17 @@
 		gettimeofday(&last_time, NULL);
 	} else {
 		struct timeval this_time;
-		double diff_sec, diff_usec;
+		time_t diff_sec;
+		suseconds_t diff_usec;
 
 		gettimeofday(&this_time, NULL);
 		diff_sec = this_time.tv_sec - last_time.tv_sec;
 		diff_usec = this_time.tv_usec - last_time.tv_usec;
 
-		retval = diff_sec + (diff_usec / 1000000.0);
+		retval = (diff_sec * 1000) + (diff_usec / 1000);
 
-		/* return 0 and do not update last_time if interval was too short */
-		if(retval < UPDATE_SPEED_SEC) {
-			retval = 0.0;
-		} else {
+		/* do not update last_time if interval was too short */
+		if(retval >= UPDATE_SPEED_MS) {
 			last_time = this_time;
 		}
 	}
@@ -95,41 +97,41 @@
 	}
 
 	if(hashlen > 0) {
-		printf(" [");
+		fputs(" [", stdout);
 		for(i = hashlen; i > 0; --i) {
 			/* if special progress bar enabled */
 			if(config->chomp) {
 				if(i > hashlen - hash) {
-					printf("-");
+					putchar('-');
 				} else if(i == hashlen - hash) {
 					if(lasthash == hash) {
 						if(mouth) {
-							printf("\033[1;33mC\033[m");
+							fputs("\033[1;33mC\033[m", stdout);
 						} else {
-							printf("\033[1;33mc\033[m");
+							fputs("\033[1;33mc\033[m", stdout);
 						}
 					} else {
 						lasthash = hash;
 						mouth = mouth == 1 ? 0 : 1;
 						if(mouth) {
-							printf("\033[1;33mC\033[m");
+							fputs("\033[1;33mC\033[m", stdout);
 						} else {
-							printf("\033[1;33mc\033[m");
+							fputs("\033[1;33mc\033[m", stdout);
 						}
 					}
-				} else if(i%3 == 0) {
-					printf("\033[0;37mo\033[m");
+				} else if(i % 3 == 0) {
+					fputs("\033[0;37mo\033[m", stdout);
 				} else {
-					printf("\033[0;37m \033[m");
+					fputs("\033[0;37m \033[m", stdout);
 				}
 			} /* else regular progress bar */
 			else if(i > hashlen - hash) {
-				printf("#");
+				putchar('#');
 			} else {
-				printf("-");
+				putchar('-');
 			}
 		}
-		printf("]");
+		putchar(']');
 	}
 	/* print display percent after progress bar */
 	/* 5 = 1 space + 3 digits + 1 % */
@@ -138,9 +140,9 @@
 	}
 
 	if(bar_percent == 100) {
-		printf("\n");
+		putchar('\n');
 	} else {
-		printf("\r");
+		putchar('\r');
 	}
 	fflush(stdout);
 }
@@ -196,9 +198,9 @@
 			break;
 		case ALPM_EVENT_UPGRADE_DONE:
 			alpm_logaction(config->handle, "upgraded %s (%s -> %s)\n",
-			         (char *)alpm_pkg_get_name(data1),
-			         (char *)alpm_pkg_get_version(data2),
-			         (char *)alpm_pkg_get_version(data1));
+			         alpm_pkg_get_name(data1),
+			         alpm_pkg_get_version(data2),
+			         alpm_pkg_get_version(data1));
 			display_new_optdepends(data2,data1);
 			break;
 		case ALPM_EVENT_INTEGRITY_START:
@@ -227,10 +229,10 @@
 			printf(_("failed.\n"));
 			break;
 		case ALPM_EVENT_SCRIPTLET_INFO:
-			printf("%s", (char *)data1);
+			fputs((const char *)data1, stdout);
 			break;
 		case ALPM_EVENT_RETRIEVE_START:
-			printf(_(":: Retrieving packages from %s...\n"), (char *)data1);
+			printf(_(":: Retrieving packages ...\n"));
 			break;
 		case ALPM_EVENT_DISKSPACE_START:
 			if(config->noprogressbar) {
@@ -294,10 +296,10 @@
 			break;
 		case ALPM_QUESTION_REMOVE_PKGS:
 			{
-				alpm_list_t *unresolved = (alpm_list_t *) data1;
+				alpm_list_t *unresolved = data1;
 				alpm_list_t *namelist = NULL, *i;
 				size_t count = 0;
-				for (i = unresolved; i; i = i->next) {
+				for(i = unresolved; i; i = i->next) {
 					namelist = alpm_list_add(namelist,
 							(char *)alpm_pkg_get_name(i->data));
 					count++;
@@ -306,7 +308,7 @@
 							":: The following package cannot be upgraded due to unresolvable dependencies:\n",
 							":: The following packages cannot be upgraded due to unresolvable dependencies:\n",
 							count));
-				list_display("     ", namelist);
+				list_display("     ", namelist, getcols(fileno(stdout)));
 				printf("\n");
 				*response = noyes(_n(
 							"Do you want to skip the above package for this upgrade?",
@@ -317,7 +319,7 @@
 			break;
 		case ALPM_QUESTION_SELECT_PROVIDER:
 			{
-				alpm_list_t *providers = (alpm_list_t *)data1;
+				alpm_list_t *providers = data1;
 				size_t count = alpm_list_count(providers);
 				char *depstring = alpm_dep_compute_string((alpm_depend_t *)data2);
 				printf(_(":: There are %zd providers available for %s:\n"), count,
@@ -340,15 +342,22 @@
 			*response = yesno(_(":: File %s is corrupted (%s).\n"
 						"Do you want to delete it?"),
 					(char *)data1,
-					alpm_strerror(*(enum _alpm_errno_t *)data2));
+					alpm_strerror(*(alpm_errno_t *)data2));
 			break;
 		case ALPM_QUESTION_IMPORT_KEY:
 			{
 				alpm_pgpkey_t *key = data1;
 				char created[12];
-				strftime(created, 12, "%Y-%m-%d", localtime(&(key->created)));
-				*response = yesno(_(":: Import PGP key %s, \"%s\", created %s?"),
-						key->fingerprint, key->uid, created);
+				const char *revoked = "";
+				time_t time = (time_t)key->created;
+				strftime(created, 12, "%Y-%m-%d", localtime(&time));
+
+				if(key->revoked) {
+					revoked = " (revoked)";
+				}
+
+				*response = yesno(_(":: Import PGP key %d%c/%s, \"%s\", created: %s%s?"),
+						key->length, key->pubkey_algo, key->fingerprint, key->uid, created, revoked);
 			}
 			break;
 	}
@@ -375,7 +384,7 @@
 	int len, wclen, wcwid, padwid;
 	wchar_t *wcstr;
 
-	const unsigned short cols = getcols();
+	const unsigned short cols = getcols(fileno(stdout));
 
 	if(config->noprogressbar || cols == 0) {
 		return;
@@ -393,7 +402,7 @@
 		if(current != prevcurrent) {
 			/* update always */
 		} else if(!pkgname || percent == prevpercent ||
-				get_update_timediff(0) < UPDATE_SPEED_SEC) {
+				get_update_timediff(0) < UPDATE_SPEED_MS) {
 			/* only update the progress bar when we have a package name, the
 			 * percentage has changed, and it has been long enough. */
 			return;
@@ -493,7 +502,7 @@
 		alpm_list_t *i = NULL;
 		on_progress = 0;
 		for(i = output; i; i = i->next) {
-			printf("%s", (char *)i->data);
+			fputs((const char *)i->data, stdout);
 		}
 		fflush(stdout);
 		FREELIST(output);
@@ -528,13 +537,14 @@
 
 	int totaldownload = 0;
 	off_t xfered, total;
-	double rate = 0.0, timediff = 0.0;
+	double rate = 0.0;
+	long timediff = 0;
 	unsigned int eta_h = 0, eta_m = 0, eta_s = 0;
 	double rate_human, xfered_human;
 	const char *rate_label, *xfered_label;
 	int file_percent = 0, total_percent = 0;
 
-	const unsigned short cols = getcols();
+	const unsigned short cols = getcols(fileno(stdout));
 
 	if(config->noprogressbar || cols == 0 || file_total == -1) {
 		if(file_xfered == 0) {
@@ -587,16 +597,17 @@
 	} else if(file_xfered == file_total) {
 		/* compute final values */
 		struct timeval current_time;
-		double diff_sec, diff_usec;
+		time_t diff_sec;
+		suseconds_t diff_usec;
 
 		gettimeofday(&current_time, NULL);
 		diff_sec = current_time.tv_sec - initial_time.tv_sec;
 		diff_usec = current_time.tv_usec - initial_time.tv_usec;
-		timediff = diff_sec + (diff_usec / 1000000.0);
-		if(timediff > 0.0) {
-			rate = xfered / timediff;
-			/* round elapsed time to the nearest second */
-			eta_s = (unsigned int)(timediff + 0.5);
+		timediff = (diff_sec * 1000) + (diff_usec / 1000);
+		if(timediff > 0) {
+			rate = (double)xfered / (timediff / 1000.0);
+			/* round elapsed time (in ms) to the nearest second */
+			eta_s = (unsigned int)(timediff + 500) / 1000;
 		} else {
 			eta_s = 0;
 		}
@@ -604,11 +615,11 @@
 		/* compute current average values */
 		timediff = get_update_timediff(0);
 
-		if(timediff < UPDATE_SPEED_SEC) {
+		if(timediff < UPDATE_SPEED_MS) {
 			/* return if the calling interval was too short */
 			return;
 		}
-		rate = (xfered - xfered_last) / timediff;
+		rate = (double)(xfered - xfered_last) / (timediff / 1000.0);
 		/* average rate to reduce jumpiness */
 		rate = (rate + 2 * rate_last) / 3;
 		if(rate > 0.0) {
@@ -713,7 +724,7 @@
 	} else if(eta_h < 100) {
 		printf("%02u:%02u:%02u", eta_h, eta_m, eta_s);
 	} else {
-		printf("--:--");
+		fputs("--:--", stdout);
 	}
 
 	free(fname);
diff -x '.*' -aur pacman-4.0.3/src/pacman/callback.h pacman/src/pacman/callback.h
--- pacman-4.0.3/src/pacman/callback.h	2011-10-12 19:04:25.000000000 +0000
+++ pacman/src/pacman/callback.h	2012-10-15 18:11:52.529299254 +0000
@@ -1,7 +1,7 @@
 /*
  *  callback.h
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
diff -x '.*' -aur pacman-4.0.3/src/pacman/conf.c pacman/src/pacman/conf.c
--- pacman-4.0.3/src/pacman/conf.c	2011-12-23 20:36:24.000000000 +0000
+++ pacman/src/pacman/conf.c	2012-10-15 18:11:52.529299254 +0000
@@ -1,7 +1,7 @@
 /*
  *  conf.c
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -18,8 +18,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <errno.h>
 #include <glob.h>
 #include <limits.h>
@@ -54,6 +52,7 @@
 	newconfig->op = PM_OP_MAIN;
 	newconfig->logmask = ALPM_LOG_ERROR | ALPM_LOG_WARNING;
 	newconfig->configfile = strdup(CONFFILE);
+	newconfig->deltaratio = 0.0;
 	if(alpm_capabilities() & ALPM_CAPABILITY_SIGNATURES) {
 		newconfig->siglevel = ALPM_SIG_PACKAGE | ALPM_SIG_PACKAGE_OPTIONAL |
 			ALPM_SIG_DATABASE | ALPM_SIG_DATABASE_OPTIONAL;
@@ -72,7 +71,6 @@
 	alpm_list_free(oldconfig->explicit_removes);
 
 	FREELIST(oldconfig->holdpkg);
-	FREELIST(oldconfig->syncfirst);
 	FREELIST(oldconfig->ignorepkg);
 	FREELIST(oldconfig->ignoregrp);
 	FREELIST(oldconfig->noupgrade);
@@ -203,11 +201,14 @@
 cleanup:
 	/* restore the old cwd if we have it */
 	if(cwdfd >= 0) {
+		int close_ret;
 		if(fchdir(cwdfd) != 0) {
 			pm_printf(ALPM_LOG_ERROR, _("could not restore working directory (%s)\n"),
 					strerror(errno));
 		}
-		close(cwdfd);
+		do {
+			close_ret = close(cwdfd);
+		} while(close_ret == -1 && errno == EINTR);
 	}
 
 	if(ret == -1) {
@@ -256,11 +257,11 @@
 		const char *original = i->data, *value;
 		int package = 0, database = 0;
 
-		if (strncmp(original, "Package", strlen("Package")) == 0) {
+		if(strncmp(original, "Package", strlen("Package")) == 0) {
 			/* only packages are affected, don't flip flags for databases */
 			value = original + strlen("Package");
 			package = 1;
-		} else if (strncmp(original, "Database", strlen("Database")) == 0) {
+		} else if(strncmp(original, "Database", strlen("Database")) == 0) {
 			/* only databases are affected, don't flip flags for packages */
 			value = original + strlen("Database");
 			database = 1;
@@ -396,8 +397,8 @@
 			config->verbosepkglists = 1;
 			pm_printf(ALPM_LOG_DEBUG, "config: verbosepkglists\n");
 		} else if(strcmp(key, "UseDelta") == 0) {
-			config->usedelta = 1;
-			pm_printf(ALPM_LOG_DEBUG, "config: usedelta\n");
+			config->deltaratio = 0.7;
+			pm_printf(ALPM_LOG_DEBUG, "config: usedelta (default 0.7)\n");
 		} else if(strcmp(key, "TotalDownload") == 0) {
 			config->totaldownload = 1;
 			pm_printf(ALPM_LOG_DEBUG, "config: totaldownload\n");
@@ -420,14 +421,24 @@
 			setrepeatingoption(value, "IgnoreGroup", &(config->ignoregrp));
 		} else if(strcmp(key, "HoldPkg") == 0) {
 			setrepeatingoption(value, "HoldPkg", &(config->holdpkg));
-		} else if(strcmp(key, "SyncFirst") == 0) {
-			setrepeatingoption(value, "SyncFirst", &(config->syncfirst));
 		} else if(strcmp(key, "CacheDir") == 0) {
 			setrepeatingoption(value, "CacheDir", &(config->cachedirs));
 		} else if(strcmp(key, "Architecture") == 0) {
 			if(!config->arch) {
 				config_set_arch(value);
 			}
+		} else if(strcmp(key, "UseDelta") == 0) {
+			double ratio;
+			char *endptr;
+			ratio = strtod(value, &endptr);
+			if(*endptr != '\0' || ratio < 0.0 || ratio > 2.0) {
+				pm_printf(ALPM_LOG_ERROR,
+						_("config file %s, line %d: invalid value for '%s' : '%s'\n"),
+						file, linenum, "UseDelta", value);
+				return 1;
+			}
+			config->deltaratio = ratio;
+			pm_printf(ALPM_LOG_DEBUG, "config: usedelta = %f\n", ratio);
 		} else if(strcmp(key, "DBPath") == 0) {
 			/* don't overwrite a path specified on the command line */
 			if(!config->dbpath) {
@@ -522,7 +533,7 @@
 static int setup_libalpm(void)
 {
 	int ret = 0;
-	enum _alpm_errno_t err;
+	alpm_errno_t err;
 	alpm_handle_t *handle;
 
 	pm_printf(ALPM_LOG_DEBUG, "setup_libalpm called\n");
@@ -604,7 +615,7 @@
 	alpm_option_set_arch(handle, config->arch);
 	alpm_option_set_checkspace(handle, config->checkspace);
 	alpm_option_set_usesyslog(handle, config->usesyslog);
-	alpm_option_set_usedelta(handle, config->usedelta);
+	alpm_option_set_deltaratio(handle, config->deltaratio);
 
 	alpm_option_set_ignorepkgs(handle, config->ignorepkg);
 	alpm_option_set_ignoregroups(handle, config->ignoregrp);
@@ -650,7 +661,7 @@
 	}
 
 	/* if we are not looking at options sections only, register a db */
-	db = alpm_db_register_sync(config->handle, section->name, section->siglevel);
+	db = alpm_register_syncdb(config->handle, section->name, section->siglevel);
 	if(db == NULL) {
 		pm_printf(ALPM_LOG_ERROR, _("could not register '%s' database (%s)\n"),
 				section->name, alpm_strerror(alpm_errno(config->handle)));
@@ -659,7 +670,7 @@
 	}
 
 	for(i = section->servers; i; i = alpm_list_next(i)) {
-		char *value = alpm_list_getdata(i);
+		char *value = i->data;
 		if(_add_mirror(db, value) != 0) {
 			pm_printf(ALPM_LOG_ERROR,
 					_("could not add mirror '%s' to database '%s' (%s)\n"),
@@ -709,7 +720,8 @@
 	pm_printf(ALPM_LOG_DEBUG, "config: attempting to read file %s\n", file);
 	fp = fopen(file, "r");
 	if(fp == NULL) {
-		pm_printf(ALPM_LOG_ERROR, _("config file %s could not be read.\n"), file);
+		pm_printf(ALPM_LOG_ERROR, _("config file %s could not be read: %s\n"),
+				file, strerror(errno));
 		ret = 1;
 		goto cleanup;
 	}
@@ -725,8 +737,7 @@
 			*ptr = '\0';
 		}
 
-		strtrim(line);
-		line_len = strlen(line);
+		line_len = strtrim(line);
 
 		if(line_len == 0) {
 			continue;
@@ -822,7 +833,7 @@
 			if((ret = _parse_options(key, value, file, linenum)) != 0) {
 				goto cleanup;
 			}
-		} else if (!parse_options && !section->is_options) {
+		} else if(!parse_options && !section->is_options) {
 			/* ... or in a repo section */
 			if(strcmp(key, "Server") == 0) {
 				if(value == NULL) {
@@ -859,7 +870,7 @@
 	}
 
 cleanup:
-	if (fp) {
+	if(fp) {
 		fclose(fp);
 	}
 	pm_printf(ALPM_LOG_DEBUG, "config: finished parsing %s\n", file);
diff -x '.*' -aur pacman-4.0.3/src/pacman/conf.h pacman/src/pacman/conf.h
--- pacman-4.0.3/src/pacman/conf.h	2012-02-15 21:57:20.000000000 +0000
+++ pacman/src/pacman/conf.h	2012-10-15 18:11:52.529299254 +0000
@@ -1,7 +1,7 @@
 /*
  *  conf.h
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -34,7 +34,7 @@
 	unsigned short print;
 	unsigned short checkspace;
 	unsigned short usesyslog;
-	unsigned short usedelta;
+	double deltaratio;
 	char *arch;
 	char *print_format;
 	/* unfortunately, we have to keep track of paths both here and in the library
@@ -84,7 +84,6 @@
 	/* select -Sc behavior */
 	unsigned short cleanmethod;
 	alpm_list_t *holdpkg;
-	alpm_list_t *syncfirst;
 	alpm_list_t *ignorepkg;
 	alpm_list_t *ignoregrp;
 	alpm_list_t *noupgrade;
@@ -127,7 +126,8 @@
 	OP_ARCH,
 	OP_PRINTFORMAT,
 	OP_GPGDIR,
-	OP_DBONLY
+	OP_DBONLY,
+	OP_FORCE
 };
 
 /* clean method */
diff -x '.*' -aur pacman-4.0.3/src/pacman/database.c pacman/src/pacman/database.c
--- pacman-4.0.3/src/pacman/database.c	2011-10-21 15:40:57.000000000 +0000
+++ pacman/src/pacman/database.c	2012-10-15 18:11:52.529299254 +0000
@@ -1,7 +1,7 @@
 /*
  *  database.c
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -18,8 +18,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <stdio.h>
 
 #include <alpm.h>
@@ -63,11 +61,11 @@
 		return 1;
 	}
 
-	db_local = alpm_option_get_localdb(config->handle);
+	db_local = alpm_get_localdb(config->handle);
 	for(i = targets; i; i = alpm_list_next(i)) {
 		char *pkgname = i->data;
 		alpm_pkg_t *pkg = alpm_db_get_pkg(db_local, pkgname);
-		if(!pkg || alpm_db_set_pkgreason(config->handle, pkg, reason)) {
+		if(!pkg || alpm_pkg_set_reason(pkg, reason)) {
 			pm_printf(ALPM_LOG_ERROR, _("could not set install reason for package %s (%s)\n"),
 							pkgname, alpm_strerror(alpm_errno(config->handle)));
 			retval = 1;
diff -x '.*' -aur pacman-4.0.3/src/pacman/deptest.c pacman/src/pacman/deptest.c
--- pacman-4.0.3/src/pacman/deptest.c	2011-10-21 15:40:57.000000000 +0000
+++ pacman/src/pacman/deptest.c	2012-10-15 18:11:52.529299254 +0000
@@ -1,7 +1,7 @@
 /*
  *  deptest.c
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -18,8 +18,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <stdio.h>
 
 #include <alpm.h>
@@ -33,10 +31,10 @@
 {
 	alpm_list_t *i;
 	alpm_list_t *deps = NULL;
-	alpm_db_t *localdb = alpm_option_get_localdb(config->handle);
+	alpm_db_t *localdb = alpm_get_localdb(config->handle);
 
 	for(i = targets; i; i = alpm_list_next(i)) {
-		char *target = alpm_list_getdata(i);
+		char *target = i->data;
 
 		if(!alpm_find_satisfier(alpm_db_get_pkgcache(localdb), target)) {
 			deps = alpm_list_add(deps, target);
@@ -48,7 +46,7 @@
 	}
 
 	for(i = deps; i; i = alpm_list_next(i)) {
-		const char *dep = alpm_list_getdata(i);
+		const char *dep = i->data;
 
 		printf("%s\n", dep);
 	}
diff -x '.*' -aur pacman-4.0.3/src/pacman/package.c pacman/src/pacman/package.c
--- pacman-4.0.3/src/pacman/package.c	2012-02-02 23:18:52.000000000 +0000
+++ pacman/src/pacman/package.c	2012-10-15 18:11:52.533425758 +0000
@@ -1,7 +1,7 @@
 /*
  *  package.c
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -18,14 +18,13 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <stdlib.h>
 #include <stdio.h>
 #include <string.h>
 #include <unistd.h>
 #include <limits.h>
 #include <errno.h>
+#include <time.h>
 
 #include <alpm.h>
 #include <alpm_list.h>
@@ -39,17 +38,31 @@
 
 /** Turn a depends list into a text list.
  * @param deps a list with items of type alpm_depend_t
- * @return a string list, must be freed
  */
 static void deplist_display(const char *title,
-		alpm_list_t *deps)
+		alpm_list_t *deps, unsigned short cols)
 {
 	alpm_list_t *i, *text = NULL;
 	for(i = deps; i; i = alpm_list_next(i)) {
-		alpm_depend_t *dep = alpm_list_getdata(i);
+		alpm_depend_t *dep = i->data;
 		text = alpm_list_add(text, alpm_dep_compute_string(dep));
 	}
-	list_display(title, text);
+	list_display(title, text, cols);
+	FREELIST(text);
+}
+
+/** Turn a optdepends list into a text list.
+ * @param optdeps a list with items of type alpm_depend_t
+ */
+static void optdeplist_display(const char *title,
+		alpm_list_t *optdeps, unsigned short cols)
+{
+	alpm_list_t *i, *text = NULL;
+	for(i = optdeps; i; i = alpm_list_next(i)) {
+		alpm_depend_t *optdep = i->data;
+		text = alpm_list_add(text, alpm_dep_compute_string(optdep));
+	}
+	list_display_linebreak(title, text, cols);
 	FREELIST(text);
 }
 
@@ -63,22 +76,22 @@
  */
 void dump_pkg_full(alpm_pkg_t *pkg, int extra)
 {
-	const char *reason;
+	unsigned short cols;
 	time_t bdate, idate;
-	char bdatestr[50] = "", idatestr[50] = "";
-	const char *label;
-	double size;
-	alpm_list_t *requiredby = NULL;
 	alpm_pkgfrom_t from;
+	double size;
+	char bdatestr[50] = "", idatestr[50] = "";
+	const char *label, *reason;
+	alpm_list_t *validation = NULL, *requiredby = NULL;
 
 	from = alpm_pkg_get_origin(pkg);
 
 	/* set variables here, do all output below */
-	bdate = alpm_pkg_get_builddate(pkg);
+	bdate = (time_t)alpm_pkg_get_builddate(pkg);
 	if(bdate) {
 		strftime(bdatestr, 50, "%c", localtime(&bdate));
 	}
-	idate = alpm_pkg_get_installdate(pkg);
+	idate = (time_t)alpm_pkg_get_installdate(pkg);
 	if(idate) {
 		strftime(idatestr, 50, "%c", localtime(&idate));
 	}
@@ -95,75 +108,99 @@
 			break;
 	}
 
-	if(extra || from == PKG_FROM_LOCALDB) {
+	alpm_pkgvalidation_t v = alpm_pkg_get_validation(pkg);
+	if(v) {
+		if(v & ALPM_PKG_VALIDATION_NONE) {
+			validation = alpm_list_add(validation, _("None"));
+		} else {
+			if(v & ALPM_PKG_VALIDATION_MD5SUM) {
+				validation = alpm_list_add(validation, _("MD5 Sum"));
+			}
+			if(v & ALPM_PKG_VALIDATION_SHA256SUM) {
+				validation = alpm_list_add(validation, _("SHA256 Sum"));
+			}
+			if(v & ALPM_PKG_VALIDATION_SIGNATURE) {
+				validation = alpm_list_add(validation, _("Signature"));
+			}
+		}
+	} else {
+		validation = alpm_list_add(validation, _("Unknown"));
+	}
+
+	if(extra || from == ALPM_PKG_FROM_LOCALDB) {
 		/* compute this here so we don't get a pause in the middle of output */
 		requiredby = alpm_pkg_compute_requiredby(pkg);
 	}
 
+	cols = getcols(fileno(stdout));
+
 	/* actual output */
-	if(from == PKG_FROM_SYNCDB) {
+	if(from == ALPM_PKG_FROM_SYNCDB) {
 		string_display(_("Repository     :"),
-				alpm_db_get_name(alpm_pkg_get_db(pkg)));
+				alpm_db_get_name(alpm_pkg_get_db(pkg)), cols);
 	}
-	string_display(_("Name           :"), alpm_pkg_get_name(pkg));
-	string_display(_("Version        :"), alpm_pkg_get_version(pkg));
-	string_display(_("URL            :"), alpm_pkg_get_url(pkg));
-	list_display(_("Licenses       :"), alpm_pkg_get_licenses(pkg));
-	list_display(_("Groups         :"), alpm_pkg_get_groups(pkg));
-	deplist_display(_("Provides       :"), alpm_pkg_get_provides(pkg));
-	deplist_display(_("Depends On     :"), alpm_pkg_get_depends(pkg));
-	list_display_linebreak(_("Optional Deps  :"), alpm_pkg_get_optdepends(pkg));
-	if(extra || from == PKG_FROM_LOCALDB) {
-		list_display(_("Required By    :"), requiredby);
+	string_display(_("Name           :"), alpm_pkg_get_name(pkg), cols);
+	string_display(_("Version        :"), alpm_pkg_get_version(pkg), cols);
+	string_display(_("Description    :"), alpm_pkg_get_desc(pkg), cols);
+	string_display(_("Architecture   :"), alpm_pkg_get_arch(pkg), cols);
+	string_display(_("URL            :"), alpm_pkg_get_url(pkg), cols);
+	list_display(_("Licenses       :"), alpm_pkg_get_licenses(pkg), cols);
+	list_display(_("Groups         :"), alpm_pkg_get_groups(pkg), cols);
+	deplist_display(_("Provides       :"), alpm_pkg_get_provides(pkg), cols);
+	deplist_display(_("Depends On     :"), alpm_pkg_get_depends(pkg), cols);
+	optdeplist_display(_("Optional Deps  :"), alpm_pkg_get_optdepends(pkg), cols);
+	if(extra || from == ALPM_PKG_FROM_LOCALDB) {
+		list_display(_("Required By    :"), requiredby, cols);
 	}
-	deplist_display(_("Conflicts With :"), alpm_pkg_get_conflicts(pkg));
-	deplist_display(_("Replaces       :"), alpm_pkg_get_replaces(pkg));
+	deplist_display(_("Conflicts With :"), alpm_pkg_get_conflicts(pkg), cols);
+	deplist_display(_("Replaces       :"), alpm_pkg_get_replaces(pkg), cols);
 
 	size = humanize_size(alpm_pkg_get_size(pkg), 'K', 2, &label);
-	if(from == PKG_FROM_SYNCDB) {
+	if(from == ALPM_PKG_FROM_SYNCDB) {
 		printf(_("Download Size  : %6.2f %s\n"), size, label);
-	} else if(from == PKG_FROM_FILE) {
+	} else if(from == ALPM_PKG_FROM_FILE) {
 		printf(_("Compressed Size: %6.2f %s\n"), size, label);
 	}
 
 	size = humanize_size(alpm_pkg_get_isize(pkg), 'K', 2, &label);
 	printf(_("Installed Size : %6.2f %s\n"), size, label);
 
-	string_display(_("Packager       :"), alpm_pkg_get_packager(pkg));
-	string_display(_("Architecture   :"), alpm_pkg_get_arch(pkg));
-	string_display(_("Build Date     :"), bdatestr);
-	if(from == PKG_FROM_LOCALDB) {
-		string_display(_("Install Date   :"), idatestr);
-		string_display(_("Install Reason :"), reason);
+	string_display(_("Packager       :"), alpm_pkg_get_packager(pkg), cols);
+	string_display(_("Build Date     :"), bdatestr, cols);
+	if(from == ALPM_PKG_FROM_LOCALDB) {
+		string_display(_("Install Date   :"), idatestr, cols);
+		string_display(_("Install Reason :"), reason, cols);
 	}
-	if(from == PKG_FROM_FILE || from == PKG_FROM_LOCALDB) {
+	if(from == ALPM_PKG_FROM_FILE || from == ALPM_PKG_FROM_LOCALDB) {
 		string_display(_("Install Script :"),
-				alpm_pkg_has_scriptlet(pkg) ?  _("Yes") : _("No"));
+				alpm_pkg_has_scriptlet(pkg) ?  _("Yes") : _("No"), cols);
 	}
 
-	if(from == PKG_FROM_SYNCDB) {
-		string_display(_("MD5 Sum        :"), alpm_pkg_get_md5sum(pkg));
-		string_display(_("SHA256 Sum     :"), alpm_pkg_get_sha256sum(pkg));
+	if(from == ALPM_PKG_FROM_SYNCDB && extra) {
+		string_display(_("MD5 Sum        :"), alpm_pkg_get_md5sum(pkg), cols);
+		string_display(_("SHA256 Sum     :"), alpm_pkg_get_sha256sum(pkg), cols);
 		string_display(_("Signatures     :"),
-				alpm_pkg_get_base64_sig(pkg) ? _("Yes") : _("None"));
+				alpm_pkg_get_base64_sig(pkg) ? _("Yes") : _("None"), cols);
+	} else {
+		list_display(_("Validated By   :"), validation, cols);
 	}
-	if(from == PKG_FROM_FILE) {
+
+	if(from == ALPM_PKG_FROM_FILE) {
 		alpm_siglist_t siglist;
 		int err = alpm_pkg_check_pgp_signature(pkg, &siglist);
 		if(err && alpm_errno(config->handle) == ALPM_ERR_SIG_MISSING) {
-			string_display(_("Signatures     :"), _("None"));
+			string_display(_("Signatures     :"), _("None"), cols);
 		} else if(err) {
 			string_display(_("Signatures     :"),
-					alpm_strerror(alpm_errno(config->handle)));
+					alpm_strerror(alpm_errno(config->handle)), cols);
 		} else {
-			signature_display(_("Signatures     :"), &siglist);
+			signature_display(_("Signatures     :"), &siglist, cols);
 		}
 		alpm_siglist_cleanup(&siglist);
 	}
-	string_display(_("Description    :"), alpm_pkg_get_desc(pkg));
 
 	/* Print additional package info if info flag passed more than once */
-	if(from == PKG_FROM_LOCALDB && extra) {
+	if(from == ALPM_PKG_FROM_LOCALDB && extra) {
 		dump_pkg_backups(pkg);
 	}
 
@@ -171,6 +208,7 @@
 	printf("\n");
 
 	FREELIST(requiredby);
+	alpm_list_free(validation);
 }
 
 static const char *get_backup_file_status(const char *root,
@@ -223,7 +261,7 @@
 	if(alpm_pkg_get_backup(pkg)) {
 		/* package has backup files, so print them */
 		for(i = alpm_pkg_get_backup(pkg); i; i = alpm_list_next(i)) {
-			const alpm_backup_t *backup = alpm_list_getdata(i);
+			const alpm_backup_t *backup = i->data;
 			const char *value;
 			if(!backup->hash) {
 				continue;
@@ -251,11 +289,16 @@
 
 	for(i = 0; i < pkgfiles->count; i++) {
 		const alpm_file_t *file = pkgfiles->files + i;
+		/* Regular: '<pkgname> <root><filepath>\n'
+		 * Quiet  : '<root><filepath>\n'
+		 */
 		if(!quiet) {
-			printf("%s %s%s\n", pkgname, root, file->name);
-		} else {
-			printf("%s%s\n", root, file->name);
+			fputs(pkgname, stdout);
+			putchar(' ');
 		}
+		fputs(root, stdout);
+		fputs(file->name, stdout);
+		putchar('\n');
 	}
 
 	fflush(stdout);
@@ -280,10 +323,10 @@
 				/* if we hit the end of the file, we need to add a null terminator */
 				*(buf + ret) = '\0';
 			}
-			printf("%s", buf);
+			fputs(buf, stdout);
 		}
 		alpm_pkg_changelog_close(pkg, fp);
-		printf("\n");
+		putchar('\n');
 	}
 }
 
diff -x '.*' -aur pacman-4.0.3/src/pacman/package.h pacman/src/pacman/package.h
--- pacman-4.0.3/src/pacman/package.h	2011-10-12 19:04:25.000000000 +0000
+++ pacman/src/pacman/package.h	2012-10-15 18:11:52.533425758 +0000
@@ -1,7 +1,7 @@
 /*
  *  package.h
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
diff -x '.*' -aur pacman-4.0.3/src/pacman/pacman.c pacman/src/pacman/pacman.c
--- pacman-4.0.3/src/pacman/pacman.c	2012-02-15 21:57:20.000000000 +0000
+++ pacman/src/pacman/pacman.c	2012-10-15 18:11:52.533425758 +0000
@@ -1,7 +1,7 @@
 /*
  *  pacman.c
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -18,8 +18,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 /* special handling of package version for GIT */
 #if defined(GIT_VERSION)
 #undef PACKAGE_VERSION
@@ -39,9 +37,6 @@
 #include <sys/utsname.h> /* uname */
 #include <locale.h> /* setlocale */
 #include <errno.h>
-#if defined(PACMAN_DEBUG) && defined(HAVE_MCHECK_H)
-#include <mcheck.h> /* debug tracing (mtrace) */
-#endif
 
 /* alpm */
 #include <alpm.h>
@@ -178,7 +173,7 @@
 		switch(op) {
 			case PM_OP_SYNC:
 			case PM_OP_UPGRADE:
-				addlist(_("  -f, --force          force install, overwrite conflicting files\n"));
+				addlist(_("      --force          force install, overwrite conflicting files\n"));
 				addlist(_("      --asdeps         install packages as non-explicitly installed\n"));
 				addlist(_("      --asexplicit     install packages as explicitly installed\n"));
 				addlist(_("      --ignore <pkg>   ignore a package upgrade (can be used more than once)\n"));
@@ -208,8 +203,8 @@
 		addlist(_("      --noconfirm      do not ask for any confirmation\n"));
 	}
 	list = alpm_list_msort(list, alpm_list_count(list), options_cmp);
-	for (i = list; i; i = alpm_list_next(i)) {
-		printf("%s", (char *)alpm_list_getdata(i));
+	for(i = list; i; i = alpm_list_next(i)) {
+		fputs((const char *)i->data, stdout);
 	}
 	alpm_list_free(list);
 #undef addlist
@@ -528,7 +523,7 @@
 	if(parsearg_trans(opt) == 0)
 		return 0;
 	switch(opt) {
-		case 'f': config->flags |= ALPM_TRANS_FLAG_FORCE; break;
+		case OP_FORCE: config->flags |= ALPM_TRANS_FLAG_FORCE; break;
 		case OP_ASDEPS: config->flags |= ALPM_TRANS_FLAG_ALLDEPS; break;
 		case OP_ASEXPLICIT: config->flags |= ALPM_TRANS_FLAG_ALLEXPLICIT; break;
 		case OP_NEEDED: config->flags |= ALPM_TRANS_FLAG_NEEDED; break;
@@ -593,7 +588,6 @@
 		{"nodeps",     no_argument,       0, 'd'},
 		{"deps",       no_argument,       0, 'd'},
 		{"explicit",   no_argument,       0, 'e'},
-		{"force",      no_argument,       0, 'f'},
 		{"groups",     no_argument,       0, 'g'},
 		{"help",       no_argument,       0, 'h'},
 		{"info",       no_argument,       0, 'i'},
@@ -620,6 +614,7 @@
 		{"config",     required_argument, 0, OP_CONFIG},
 		{"ignore",     required_argument, 0, OP_IGNORE},
 		{"debug",      optional_argument, 0, OP_DEBUG},
+		{"force",      no_argument,       0, OP_FORCE},
 		{"noprogressbar", no_argument,    0, OP_NOPROGRESSBAR},
 		{"noscriptlet", no_argument,      0, OP_NOSCRIPTLET},
 		{"ask",        required_argument, 0, OP_ASK},
@@ -724,7 +719,7 @@
  * @param argc
  * @param argv
  */
-static void cl_to_log(int argc, char* argv[])
+static void cl_to_log(int argc, char *argv[])
 {
 	size_t size = 0;
 	int i;
@@ -765,11 +760,6 @@
 	uid_t myuid = geteuid();
 #endif
 
-#if defined(PACMAN_DEBUG) && defined(HAVE_MCHECK_H)
-	/*setenv("MALLOC_TRACE","pacman.mtrace", 0);*/
-	mtrace();
-#endif
-
 	/* Set signal handlers */
 	/* Set up the structure to specify the new action. */
 	new_action.sa_handler = handler;
@@ -818,12 +808,13 @@
 
 	/* we support reading targets from stdin if a cmdline parameter is '-' */
 	if(!isatty(fileno(stdin)) && alpm_list_find_str(pm_targets, "-")) {
-		size_t current_size = PATH_MAX, i = 0;
+		size_t current_size = PATH_MAX;
 		char *line = malloc(current_size);
 
 		/* remove the '-' from the list */
 		pm_targets = alpm_list_remove_str(pm_targets, "-", NULL);
 
+		i = 0;
 		while((line[i] = (char)fgetc(stdin)) != EOF) {
 			if(isspace((unsigned char)line[i])) {
 				/* avoid adding zero length arg when multiple spaces separate args */
@@ -895,19 +886,19 @@
 #endif
 
 	if(config->verbose > 0) {
-		alpm_list_t *i;
+		alpm_list_t *j;
 		printf("Root      : %s\n", alpm_option_get_root(config->handle));
 		printf("Conf File : %s\n", config->configfile);
 		printf("DB Path   : %s\n", alpm_option_get_dbpath(config->handle));
 		printf("Cache Dirs: ");
-		for(i = alpm_option_get_cachedirs(config->handle); i; i = alpm_list_next(i)) {
-			printf("%s  ", (char *)alpm_list_getdata(i));
+		for(j = alpm_option_get_cachedirs(config->handle); j; j = alpm_list_next(j)) {
+			printf("%s  ", (const char *)j->data);
 		}
 		printf("\n");
 		printf("Lock File : %s\n", alpm_option_get_lockfile(config->handle));
 		printf("Log File  : %s\n", alpm_option_get_logfile(config->handle));
 		printf("GPG Dir   : %s\n", alpm_option_get_gpgdir(config->handle));
-		list_display("Targets   :", pm_targets);
+		list_display("Targets   :", pm_targets, 0);
 	}
 
 	/* Log command line */
diff -x '.*' -aur pacman-4.0.3/src/pacman/pacman.h pacman/src/pacman/pacman.h
--- pacman-4.0.3/src/pacman/pacman.h	2011-10-12 19:04:25.000000000 +0000
+++ pacman/src/pacman/pacman.h	2012-10-15 18:11:52.533425758 +0000
@@ -1,7 +1,7 @@
 /*
  *  pacman.h
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
Only in pacman-4.0.3/src/pacman/po: ca.gmo
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/ca.po pacman/src/pacman/po/ca.po
--- pacman-4.0.3/src/pacman/po/ca.po	2012-04-07 16:08:57.000000000 +0000
+++ pacman/src/pacman/po/ca.po	2012-10-15 18:11:52.533425758 +0000
@@ -10,7 +10,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: 2012-03-29 04:24+0000\n"
 "Last-Translator: Hector Mtz-Seara <hseara@gmail.com>\n"
 "Language-Team: Catalan (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/src/pacman/po: cs.gmo
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/cs.po pacman/src/pacman/po/cs.po
--- pacman-4.0.3/src/pacman/po/cs.po	2012-04-07 16:08:57.000000000 +0000
+++ pacman/src/pacman/po/cs.po	2012-10-15 18:11:52.537290414 +0000
@@ -11,7 +11,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: 2012-03-05 17:48+0000\n"
 "Last-Translator: Dan McGee <dpmcgee@gmail.com>\n"
 "Language-Team: Czech (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/src/pacman/po: da.gmo
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/da.po pacman/src/pacman/po/da.po
--- pacman-4.0.3/src/pacman/po/da.po	2012-04-07 16:08:57.000000000 +0000
+++ pacman/src/pacman/po/da.po	2012-10-15 18:11:52.537290414 +0000
@@ -10,7 +10,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: 2012-04-01 16:43+0000\n"
 "Last-Translator: jakobw <jakob.wadsager@gmail.com>\n"
 "Language-Team: Danish (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/src/pacman/po: de.gmo
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/de.po pacman/src/pacman/po/de.po
--- pacman-4.0.3/src/pacman/po/de.po	2012-04-07 16:08:57.000000000 +0000
+++ pacman/src/pacman/po/de.po	2012-10-15 18:11:52.537290414 +0000
@@ -13,7 +13,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: 2012-03-29 14:26+0000\n"
 "Last-Translator: Matthias Gorissen <matthias@archlinux.de>\n"
 "Language-Team: German (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/src/pacman/po: el.gmo
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/el.po pacman/src/pacman/po/el.po
--- pacman-4.0.3/src/pacman/po/el.po	2012-04-07 16:08:57.000000000 +0000
+++ pacman/src/pacman/po/el.po	2012-10-15 18:11:52.537290414 +0000
@@ -12,7 +12,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: 2012-03-22 20:54+0000\n"
 "Last-Translator: Christos Nouskas <nous@archlinux.us>\n"
 "Language-Team: Greek (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/src/pacman/po: en_GB.gmo
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/en_GB.po pacman/src/pacman/po/en_GB.po
--- pacman-4.0.3/src/pacman/po/en_GB.po	2012-04-07 16:08:57.000000000 +0000
+++ pacman/src/pacman/po/en_GB.po	2012-10-15 18:11:52.537290414 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: 2012-03-05 17:48+0000\n"
 "Last-Translator: Dan McGee <dpmcgee@gmail.com>\n"
 "Language-Team: LANGUAGE <LL@li.org>\n"
Only in pacman-4.0.3/src/pacman/po: es.gmo
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/es.po pacman/src/pacman/po/es.po
--- pacman-4.0.3/src/pacman/po/es.po	2012-04-07 16:08:57.000000000 +0000
+++ pacman/src/pacman/po/es.po	2012-10-15 18:11:52.537290414 +0000
@@ -14,7 +14,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: 2012-04-01 16:27+0000\n"
 "Last-Translator: Angel Velasquez <angvp@archlinux.org>\n"
 "Language-Team: Spanish (Castilian) (http://www.transifex.net/projects/p/"
Only in pacman-4.0.3/src/pacman/po: fi.gmo
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/fi.po pacman/src/pacman/po/fi.po
--- pacman-4.0.3/src/pacman/po/fi.po	2012-04-07 16:08:57.000000000 +0000
+++ pacman/src/pacman/po/fi.po	2012-10-15 18:11:52.541420021 +0000
@@ -13,7 +13,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: 2012-04-06 20:03+0000\n"
 "Last-Translator: Larso <larso@gmx.com>\n"
 "Language-Team: Finnish (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/src/pacman/po: fr.gmo
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/fr.po pacman/src/pacman/po/fr.po
--- pacman-4.0.3/src/pacman/po/fr.po	2012-04-07 16:08:57.000000000 +0000
+++ pacman/src/pacman/po/fr.po	2012-10-15 18:11:52.541420021 +0000
@@ -11,7 +11,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: 2012-03-07 17:22+0000\n"
 "Last-Translator: jiehong <ma.jiehong@gmail.com>\n"
 "Language-Team: French (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/src/pacman/po: hu.gmo
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/hu.po pacman/src/pacman/po/hu.po
--- pacman-4.0.3/src/pacman/po/hu.po	2012-04-07 16:08:57.000000000 +0000
+++ pacman/src/pacman/po/hu.po	2012-10-15 18:11:52.541420021 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: 2012-03-09 13:09+0000\n"
 "Last-Translator: György Balló <ballogy@freestart.hu>\n"
 "Language-Team: Hungarian (http://www.transifex.net/projects/p/archlinux-"
Only in pacman-4.0.3/src/pacman/po: it.gmo
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/it.po pacman/src/pacman/po/it.po
--- pacman-4.0.3/src/pacman/po/it.po	2012-04-07 16:08:57.000000000 +0000
+++ pacman/src/pacman/po/it.po	2012-10-15 18:11:52.541420021 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: 2012-03-09 11:28+0000\n"
 "Last-Translator: Andrea Scarpino <andrea@archlinux.org>\n"
 "Language-Team: Italian (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/src/pacman/po: kk.gmo
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/kk.po pacman/src/pacman/po/kk.po
--- pacman-4.0.3/src/pacman/po/kk.po	2012-04-07 16:08:57.000000000 +0000
+++ pacman/src/pacman/po/kk.po	2012-10-15 18:11:52.545286341 +0000
@@ -8,7 +8,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: 2012-03-05 17:48+0000\n"
 "Last-Translator: Dan McGee <dpmcgee@gmail.com>\n"
 "Language-Team: Kazakh (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/src/pacman/po: lt.gmo
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/lt.po pacman/src/pacman/po/lt.po
--- pacman-4.0.3/src/pacman/po/lt.po	2012-04-07 16:08:57.000000000 +0000
+++ pacman/src/pacman/po/lt.po	2012-10-15 18:11:52.545286341 +0000
@@ -11,7 +11,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: 2012-03-25 05:53+0000\n"
 "Last-Translator: Algimantas Margevičius <margevicius.algimantas@gmail.com>\n"
 "Language-Team: Lithuanian (http://www.transifex.net/projects/p/archlinux-"
Only in pacman-4.0.3/src/pacman/po: nb.gmo
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/nb.po pacman/src/pacman/po/nb.po
--- pacman-4.0.3/src/pacman/po/nb.po	2012-04-07 16:08:57.000000000 +0000
+++ pacman/src/pacman/po/nb.po	2012-10-15 18:11:52.545286341 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: 2012-03-21 18:16+0000\n"
 "Last-Translator: Alexander Rødseth <rodseth@gmail.com>\n"
 "Language-Team: Norwegian Bokmål (http://www.transifex.net/projects/p/"
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/pacman.pot pacman/src/pacman/po/pacman.pot
--- pacman-4.0.3/src/pacman/po/pacman.pot	2012-04-07 16:08:57.000000000 +0000
+++ pacman/src/pacman/po/pacman.pot	2012-10-15 18:11:52.545286341 +0000
@@ -6,9 +6,9 @@
 #, fuzzy
 msgid ""
 msgstr ""
-"Project-Id-Version: pacman 4.0.3\n"
+"Project-Id-Version: pacman 4.0.2\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
 "Language-Team: LANGUAGE <LL@li.org>\n"
Only in pacman-4.0.3/src/pacman/po: pl.gmo
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/pl.po pacman/src/pacman/po/pl.po
--- pacman-4.0.3/src/pacman/po/pl.po	2012-04-07 16:08:57.000000000 +0000
+++ pacman/src/pacman/po/pl.po	2012-10-15 18:11:52.545286341 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: 2012-03-05 17:48+0000\n"
 "Last-Translator: Dan McGee <dpmcgee@gmail.com>\n"
 "Language-Team: Polish (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/src/pacman/po: pt.gmo
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/pt.po pacman/src/pacman/po/pt.po
--- pacman-4.0.3/src/pacman/po/pt.po	2012-04-07 16:08:57.000000000 +0000
+++ pacman/src/pacman/po/pt.po	2012-10-15 18:11:52.545286341 +0000
@@ -12,7 +12,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: 2012-03-31 21:59+0000\n"
 "Last-Translator: DarkVenger <thedarkvenger@gmail.com>\n"
 "Language-Team: Portuguese (http://www.transifex.net/projects/p/archlinux-"
Only in pacman-4.0.3/src/pacman/po: pt_BR.gmo
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/pt_BR.po pacman/src/pacman/po/pt_BR.po
--- pacman-4.0.3/src/pacman/po/pt_BR.po	2012-04-07 16:08:57.000000000 +0000
+++ pacman/src/pacman/po/pt_BR.po	2012-10-15 18:11:52.549419159 +0000
@@ -12,7 +12,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: 2012-04-06 14:13+0000\n"
 "Last-Translator: Rafael Ferreira <rafael.f.f1@gmail.com>\n"
 "Language-Team: Portuguese (Brazil) (http://www.transifex.net/projects/p/"
Only in pacman-4.0.3/src/pacman/po: ro.gmo
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/ro.po pacman/src/pacman/po/ro.po
--- pacman-4.0.3/src/pacman/po/ro.po	2012-04-07 16:08:57.000000000 +0000
+++ pacman/src/pacman/po/ro.po	2012-10-15 18:11:52.549419159 +0000
@@ -10,7 +10,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: 2012-03-21 07:25+0000\n"
 "Last-Translator: Ionut Biru <ibiru@archlinux.org>\n"
 "Language-Team: Romanian (http://www.transifex.net/projects/p/archlinux-"
Only in pacman-4.0.3/src/pacman/po: ru.gmo
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/ru.po pacman/src/pacman/po/ru.po
--- pacman-4.0.3/src/pacman/po/ru.po	2012-04-07 16:08:57.000000000 +0000
+++ pacman/src/pacman/po/ru.po	2012-10-15 18:11:52.549419159 +0000
@@ -12,7 +12,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: 2012-04-05 13:53+0000\n"
 "Last-Translator: AlexanderR <alexander.r@gmx.com>\n"
 "Language-Team: Russian (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/src/pacman/po: sk.gmo
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/sk.po pacman/src/pacman/po/sk.po
--- pacman-4.0.3/src/pacman/po/sk.po	2012-04-07 16:08:58.000000000 +0000
+++ pacman/src/pacman/po/sk.po	2012-10-15 18:11:52.549419159 +0000
@@ -11,7 +11,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: 2012-03-09 21:16+0000\n"
 "Last-Translator: archetyp <archetyp@linuxmail.org>\n"
 "Language-Team: Slovak (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/src/pacman/po: sr.gmo
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/sr.po pacman/src/pacman/po/sr.po
--- pacman-4.0.3/src/pacman/po/sr.po	2012-04-07 16:08:58.000000000 +0000
+++ pacman/src/pacman/po/sr.po	2012-10-15 18:11:52.549419159 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: 2012-03-05 17:48+0000\n"
 "Last-Translator: Dan McGee <dpmcgee@gmail.com>\n"
 "Language-Team: Serbian (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/src/pacman/po: sr@latin.gmo
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/sr@latin.po pacman/src/pacman/po/sr@latin.po
--- pacman-4.0.3/src/pacman/po/sr@latin.po	2012-04-07 16:08:58.000000000 +0000
+++ pacman/src/pacman/po/sr@latin.po	2012-10-15 18:11:52.549419159 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: 2012-03-05 17:48+0000\n"
 "Last-Translator: Dan McGee <dpmcgee@gmail.com>\n"
 "Language-Team: Serbian (Latin) (http://www.transifex.net/projects/p/"
Only in pacman-4.0.3/src/pacman/po: stamp-po
Only in pacman-4.0.3/src/pacman/po: sv.gmo
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/sv.po pacman/src/pacman/po/sv.po
--- pacman-4.0.3/src/pacman/po/sv.po	2012-04-07 16:08:58.000000000 +0000
+++ pacman/src/pacman/po/sv.po	2012-10-15 18:11:52.549419159 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: 2012-03-24 20:59+0000\n"
 "Last-Translator: Kim Svensson <ks@linux.com>\n"
 "Language-Team: Swedish (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/src/pacman/po: tr.gmo
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/tr.po pacman/src/pacman/po/tr.po
--- pacman-4.0.3/src/pacman/po/tr.po	2012-04-07 16:08:58.000000000 +0000
+++ pacman/src/pacman/po/tr.po	2012-10-15 18:11:52.553289159 +0000
@@ -10,7 +10,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: 2012-03-22 14:32+0000\n"
 "Last-Translator: Atilla Öntaş <tarakbumba@gmail.com>\n"
 "Language-Team: Turkish (http://www.transifex.net/projects/p/archlinux-pacman/"
Only in pacman-4.0.3/src/pacman/po: uk.gmo
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/uk.po pacman/src/pacman/po/uk.po
--- pacman-4.0.3/src/pacman/po/uk.po	2012-04-07 16:08:58.000000000 +0000
+++ pacman/src/pacman/po/uk.po	2012-10-15 18:11:52.553289159 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: 2012-03-13 20:10+0000\n"
 "Last-Translator: Данило Коростіль <ted.korostiled@gmail.com>\n"
 "Language-Team: Ukrainian (http://www.transifex.net/projects/p/archlinux-"
Only in pacman-4.0.3/src/pacman/po: zh_CN.gmo
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/zh_CN.po pacman/src/pacman/po/zh_CN.po
--- pacman-4.0.3/src/pacman/po/zh_CN.po	2012-04-07 16:08:58.000000000 +0000
+++ pacman/src/pacman/po/zh_CN.po	2012-10-15 18:11:52.553289159 +0000
@@ -11,7 +11,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: 2012-03-29 01:45+0000\n"
 "Last-Translator: 甘 露 <rhythm.gan@gmail.com>\n"
 "Language-Team: Chinese (China) (http://www.transifex.net/projects/p/"
Only in pacman-4.0.3/src/pacman/po: zh_TW.gmo
diff -x '.*' -aur pacman-4.0.3/src/pacman/po/zh_TW.po pacman/src/pacman/po/zh_TW.po
--- pacman-4.0.3/src/pacman/po/zh_TW.po	2012-04-07 16:08:58.000000000 +0000
+++ pacman/src/pacman/po/zh_TW.po	2012-10-15 18:11:52.553289159 +0000
@@ -9,7 +9,7 @@
 msgstr ""
 "Project-Id-Version: Arch Linux Pacman package manager\n"
 "Report-Msgid-Bugs-To: http://bugs.archlinux.org/index.php?project=3\n"
-"POT-Creation-Date: 2012-04-07 11:08-0500\n"
+"POT-Creation-Date: 2012-03-05 11:35-0600\n"
 "PO-Revision-Date: 2012-03-05 17:48+0000\n"
 "Last-Translator: Dan McGee <dpmcgee@gmail.com>\n"
 "Language-Team: Chinese (Taiwan) (http://www.transifex.net/projects/p/"
diff -x '.*' -aur pacman-4.0.3/src/pacman/query.c pacman/src/pacman/query.c
--- pacman-4.0.3/src/pacman/query.c	2011-12-23 20:36:36.000000000 +0000
+++ pacman/src/pacman/query.c	2012-10-15 18:11:52.553289159 +0000
@@ -1,7 +1,7 @@
 /*
  *  query.c
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -18,8 +18,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <stdlib.h>
 #include <stdio.h>
 #include <stdint.h>
@@ -38,22 +36,7 @@
 #include "conf.h"
 #include "util.h"
 
-static char *resolve_path(const char *file)
-{
-	char *str = NULL;
-
-	str = calloc(PATH_MAX, sizeof(char));
-	if(!str) {
-		return NULL;
-	}
-
-	if(!realpath(file, str)) {
-		free(str);
-		return NULL;
-	}
-
-	return str;
-}
+#define LOCAL_PREFIX "local/"
 
 /* check if filename exists in PATH */
 static int search_path(char **filename, struct stat *bufptr)
@@ -75,7 +58,7 @@
 
 		/* strip the trailing slash if one exists */
 		while(path[plen - 1] == '/') {
-				path[--plen] = '\0';
+			path[--plen] = '\0';
 		}
 
 		fullname = malloc(plen + flen + 2);
@@ -111,7 +94,6 @@
 {
 	int ret = 0;
 	char path[PATH_MAX];
-	const char *root;
 	size_t rootlen;
 	alpm_list_t *t;
 	alpm_db_t *db_local;
@@ -125,25 +107,44 @@
 	/* Set up our root path buffer. We only need to copy the location of root in
 	 * once, then we can just overwrite whatever file was there on the previous
 	 * iteration. */
-	root = alpm_option_get_root(config->handle);
-	rootlen = strlen(root);
-	if(rootlen + 1 > PATH_MAX) {
-		/* we are in trouble here */
-		pm_printf(ALPM_LOG_ERROR, _("path too long: %s%s\n"), root, "");
+
+	/* resolve root now so any symlinks in it will only have to be resolved once */
+	if(!realpath(alpm_option_get_root(config->handle), path)) {
+		pm_printf(ALPM_LOG_ERROR, _("cannot determine real path for '%s': %s\n"),
+				path, strerror(errno));
+		return 1;
+	}
+
+	/* make sure there's enough room to append the package file to path */
+	rootlen = strlen(path);
+	if(rootlen + 2 > PATH_MAX) {
+		pm_printf(ALPM_LOG_ERROR, _("path too long: %s%s\n"), path, "");
 		return 1;
 	}
-	strcpy(path, root);
 
-	db_local = alpm_option_get_localdb(config->handle);
+	/* append trailing '/' removed by realpath */
+	path[rootlen++] = '/';
+	path[rootlen] = '\0';
+
+	db_local = alpm_get_localdb(config->handle);
 
 	for(t = targets; t; t = alpm_list_next(t)) {
-		char *filename, *dname, *rpath;
+		char *filename = NULL, *dname = NULL, *rpath = NULL;
 		const char *bname;
 		struct stat buf;
 		alpm_list_t *i;
+		size_t len;
 		int found = 0;
 
-		filename = strdup(alpm_list_getdata(t));
+		if((filename = strdup(t->data)) == NULL) {
+			goto targcleanup;
+		}
+
+		/* trailing '/' causes lstat to dereference directory symlinks */
+		len = strlen(filename) - 1;
+		while(len > 0 && filename[len] == '/') {
+			filename[len--] = '\0';
+		}
 
 		if(lstat(filename, &buf) == -1) {
 			/*  if it is not a path but a program name, then check in PATH */
@@ -151,49 +152,33 @@
 				if(search_path(&filename, &buf) == -1) {
 					pm_printf(ALPM_LOG_ERROR, _("failed to find '%s' in PATH: %s\n"),
 							filename, strerror(errno));
-					ret++;
-					free(filename);
-					continue;
+					goto targcleanup;
 				}
 			} else {
 				pm_printf(ALPM_LOG_ERROR, _("failed to read file '%s': %s\n"),
 						filename, strerror(errno));
-				ret++;
-				free(filename);
-				continue;
+				goto targcleanup;
 			}
 		}
 
 		if(S_ISDIR(buf.st_mode)) {
 			pm_printf(ALPM_LOG_ERROR,
 				_("cannot determine ownership of directory '%s'\n"), filename);
-			ret++;
-			free(filename);
-			continue;
+			goto targcleanup;
 		}
 
 		bname = mbasename(filename);
 		dname = mdirname(filename);
-		/* for files in '/', there is no directory name to match */
-		if(strcmp(dname, "") == 0) {
-			rpath = NULL;
-		} else {
-			rpath = resolve_path(dname);
+		rpath = realpath(dname, NULL);
 
-			if(!rpath) {
-				pm_printf(ALPM_LOG_ERROR, _("cannot determine real path for '%s': %s\n"),
-						filename, strerror(errno));
-				free(filename);
-				free(dname);
-				free(rpath);
-				ret++;
-				continue;
-			}
+		if(!dname || !rpath) {
+			pm_printf(ALPM_LOG_ERROR, _("cannot determine real path for '%s': %s\n"),
+					filename, strerror(errno));
+			goto targcleanup;
 		}
-		free(dname);
 
 		for(i = alpm_db_get_pkgcache(db_local); i && !found; i = alpm_list_next(i)) {
-			alpm_pkg_t *info = alpm_list_getdata(i);
+			alpm_pkg_t *info = i->data;
 			alpm_filelist_t *filelist = alpm_pkg_get_files(info);
 			size_t j;
 
@@ -202,41 +187,49 @@
 				char *ppath, *pdname;
 				const char *pkgfile = file->name;
 
-				/* avoid the costly resolve_path usage if the basenames don't match */
+				/* avoid the costly realpath usage if the basenames don't match */
 				if(strcmp(mbasename(pkgfile), bname) != 0) {
 					continue;
 				}
 
-				/* for files in '/', there is no directory name to match */
-				if(!rpath) {
-					print_query_fileowner(filename, info);
-					found = 1;
-					continue;
-				}
-
+				/* concatenate our file and the root path */
 				if(rootlen + 1 + strlen(pkgfile) > PATH_MAX) {
-					pm_printf(ALPM_LOG_ERROR, _("path too long: %s%s\n"), root, pkgfile);
+					path[rootlen] = '\0'; /* reset path for error message */
+					pm_printf(ALPM_LOG_ERROR, _("path too long: %s%s\n"), path, pkgfile);
+					continue;
 				}
-				/* concatenate our file and the root path */
 				strcpy(path + rootlen, pkgfile);
 
 				pdname = mdirname(path);
-				ppath = resolve_path(pdname);
+				ppath = realpath(pdname, NULL);
 				free(pdname);
 
-				if(ppath && strcmp(ppath, rpath) == 0) {
+				if(!ppath) {
+					pm_printf(ALPM_LOG_ERROR, _("cannot determine real path for '%s': %s\n"),
+							path, strerror(errno));
+					continue;
+				}
+
+				if(strcmp(ppath, rpath) == 0) {
 					print_query_fileowner(filename, info);
 					found = 1;
+					free(ppath);
+					break;
 				}
 				free(ppath);
 			}
 		}
 		if(!found) {
 			pm_printf(ALPM_LOG_ERROR, _("No package owns %s\n"), filename);
+		}
+
+targcleanup:
+		if(!found) {
 			ret++;
 		}
 		free(filename);
 		free(rpath);
+		free(dname);
 	}
 
 	return ret;
@@ -247,7 +240,8 @@
 {
 	alpm_list_t *i, *searchlist;
 	int freelist;
-	alpm_db_t *db_local = alpm_option_get_localdb(config->handle);
+	alpm_db_t *db_local = alpm_get_localdb(config->handle);
+	unsigned short cols;
 
 	/* if we have a targets list, search for packages matching it */
 	if(targets) {
@@ -261,37 +255,38 @@
 		return 1;
 	}
 
+	cols = getcols(fileno(stdout));
 	for(i = searchlist; i; i = alpm_list_next(i)) {
 		alpm_list_t *grp;
-		alpm_pkg_t *pkg = alpm_list_getdata(i);
+		alpm_pkg_t *pkg = i->data;
 
 		if(!config->quiet) {
-			printf("local/%s %s", alpm_pkg_get_name(pkg), alpm_pkg_get_version(pkg));
+			printf(LOCAL_PREFIX "%s %s", alpm_pkg_get_name(pkg), alpm_pkg_get_version(pkg));
 		} else {
-			printf("%s", alpm_pkg_get_name(pkg));
+			fputs(alpm_pkg_get_name(pkg), stdout);
 		}
 
 
 		if(!config->quiet) {
 			if((grp = alpm_pkg_get_groups(pkg)) != NULL) {
 				alpm_list_t *k;
-				printf(" (");
+				fputs(" (", stdout);
 				for(k = grp; k; k = alpm_list_next(k)) {
-					const char *group = alpm_list_getdata(k);
-					printf("%s", group);
+					const char *group = k->data;
+					fputs(group, stdout);
 					if(alpm_list_next(k)) {
 						/* only print a spacer if there are more groups */
-						printf(" ");
+						putchar(' ');
 					}
 				}
-				printf(")");
+				putchar(')');
 			}
 
 			/* we need a newline and initial indent first */
-			printf("\n    ");
-			indentprint(alpm_pkg_get_desc(pkg), 4);
+			fputs("\n    ", stdout);
+			indentprint(alpm_pkg_get_desc(pkg), 4, cols);
 		}
-		printf("\n");
+		fputc('\n', stdout);
 	}
 
 	/* we only want to free if the list was a search list */
@@ -304,33 +299,33 @@
 static int query_group(alpm_list_t *targets)
 {
 	alpm_list_t *i, *j;
-	char *grpname = NULL;
+	const char *grpname = NULL;
 	int ret = 0;
-	alpm_db_t *db_local = alpm_option_get_localdb(config->handle);
+	alpm_db_t *db_local = alpm_get_localdb(config->handle);
 
 	if(targets == NULL) {
 		for(j = alpm_db_get_groupcache(db_local); j; j = alpm_list_next(j)) {
-			alpm_group_t *grp = alpm_list_getdata(j);
+			alpm_group_t *grp = j->data;
 			const alpm_list_t *p;
 
 			for(p = grp->packages; p; p = alpm_list_next(p)) {
-				alpm_pkg_t *pkg = alpm_list_getdata(p);
+				alpm_pkg_t *pkg = p->data;
 				printf("%s %s\n", grp->name, alpm_pkg_get_name(pkg));
 			}
 		}
 	} else {
 		for(i = targets; i; i = alpm_list_next(i)) {
 			alpm_group_t *grp;
-			grpname = alpm_list_getdata(i);
-			grp = alpm_db_readgroup(db_local, grpname);
+			grpname = i->data;
+			grp = alpm_db_get_group(db_local, grpname);
 			if(grp) {
 				const alpm_list_t *p;
 				for(p = grp->packages; p; p = alpm_list_next(p)) {
 					if(!config->quiet) {
 						printf("%s %s\n", grpname,
-								alpm_pkg_get_name(alpm_list_getdata(p)));
+								alpm_pkg_get_name(p->data));
 					} else {
-						printf("%s\n", alpm_pkg_get_name(alpm_list_getdata(p)));
+						printf("%s\n", alpm_pkg_get_name(p->data));
 					}
 				}
 			} else {
@@ -346,11 +341,11 @@
 {
 	const char *pkgname = alpm_pkg_get_name(pkg);
 	alpm_list_t *j;
-	alpm_list_t *sync_dbs = alpm_option_get_syncdbs(config->handle);
+	alpm_list_t *sync_dbs = alpm_get_syncdbs(config->handle);
 
 	int match = 0;
 	for(j = sync_dbs; j; j = alpm_list_next(j)) {
-		alpm_db_t *db = alpm_list_getdata(j);
+		alpm_db_t *db = j->data;
 		alpm_pkg_t *findpkg = alpm_db_get_pkg(db, pkgname);
 		if(findpkg) {
 			match = 1;
@@ -395,7 +390,7 @@
 	}
 	/* check if this pkg is outdated */
 	if(config->op_q_upgrade && (alpm_sync_newversion(pkg,
-					alpm_option_get_syncdbs(config->handle)) == NULL)) {
+					alpm_get_syncdbs(config->handle)) == NULL)) {
 		return 0;
 	}
 	return 1;
@@ -514,7 +509,7 @@
 		}
 	}
 
-	db_local = alpm_option_get_localdb(config->handle);
+	db_local = alpm_get_localdb(config->handle);
 
 	/* operations on all packages in the local DB
 	 * valid: no-op (plain -Q), list, info, check
@@ -526,7 +521,7 @@
 		}
 
 		for(i = alpm_db_get_pkgcache(db_local); i; i = alpm_list_next(i)) {
-			pkg = alpm_list_getdata(i);
+			pkg = i->data;
 			if(filter(pkg)) {
 				int value = display(pkg);
 				if(value != 0) {
@@ -552,7 +547,12 @@
 	/* operations on named packages in the local DB
 	 * valid: no-op (plain -Q), list, info, check */
 	for(i = targets; i; i = alpm_list_next(i)) {
-		char *strname = alpm_list_getdata(i);
+		const char *strname = i->data;
+
+		/* strip leading part of "local/pkgname" */
+		if(strncmp(strname, LOCAL_PREFIX, strlen(LOCAL_PREFIX)) == 0) {
+			strname += strlen(LOCAL_PREFIX);
+		}
 
 		if(config->op_q_isfile) {
 			alpm_pkg_load(config->handle, strname, 1, 0, &pkg);
diff -x '.*' -aur pacman-4.0.3/src/pacman/remove.c pacman/src/pacman/remove.c
--- pacman-4.0.3/src/pacman/remove.c	2012-02-06 11:36:22.000000000 +0000
+++ pacman/src/pacman/remove.c	2012-10-15 18:11:52.553289159 +0000
@@ -1,7 +1,7 @@
 /*
  *  remove.c
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -18,8 +18,7 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
+#include <fnmatch.h>
 #include <stdlib.h>
 #include <stdio.h>
 
@@ -31,10 +30,15 @@
 #include "util.h"
 #include "conf.h"
 
+static int fnmatch_cmp(const void *pattern, const void *string)
+{
+	return fnmatch(pattern, string, 0);
+}
+
 static int remove_target(const char *target)
 {
 	alpm_pkg_t *pkg;
-	alpm_db_t *db_local = alpm_option_get_localdb(config->handle);
+	alpm_db_t *db_local = alpm_get_localdb(config->handle);
 	alpm_list_t *p;
 
 	if((pkg = alpm_db_get_pkg(db_local, target)) != NULL) {
@@ -48,13 +52,13 @@
 	}
 
 		/* fallback to group */
-	alpm_group_t *grp = alpm_db_readgroup(db_local, target);
+	alpm_group_t *grp = alpm_db_get_group(db_local, target);
 	if(grp == NULL) {
 		pm_printf(ALPM_LOG_ERROR, _("target not found: %s\n"), target);
 		return -1;
 	}
 	for(p = grp->packages; p; p = alpm_list_next(p)) {
-		pkg = alpm_list_getdata(p);
+		pkg = p->data;
 		if(alpm_remove_pkg(config->handle, pkg) == -1) {
 			pm_printf(ALPM_LOG_ERROR, "'%s': %s\n", target,
 					alpm_strerror(alpm_errno(config->handle)));
@@ -89,7 +93,7 @@
 
 	/* Step 1: add targets to the created transaction */
 	for(i = targets; i; i = alpm_list_next(i)) {
-		char *target = alpm_list_getdata(i);
+		char *target = i->data;
 		char *targ = strchr(target, '/');
 		if(targ && strncmp(target, "local", 5) == 0) {
 			targ++;
@@ -98,25 +102,22 @@
 		}
 		if(remove_target(targ) == -1) {
 			retval = 1;
-			goto cleanup;
 		}
 	}
 
+	if(retval == 1) {
+		goto cleanup;
+	}
+
 	/* Step 2: prepare the transaction based on its type, targets and flags */
 	if(alpm_trans_prepare(config->handle, &data) == -1) {
-		enum _alpm_errno_t err = alpm_errno(config->handle);
+		alpm_errno_t err = alpm_errno(config->handle);
 		pm_printf(ALPM_LOG_ERROR, _("failed to prepare transaction (%s)\n"),
 		        alpm_strerror(err));
 		switch(err) {
-			case ALPM_ERR_PKG_INVALID_ARCH:
-				for(i = data; i; i = alpm_list_next(i)) {
-					char *pkg = alpm_list_getdata(i);
-					printf(_(":: package %s does not have a valid architecture\n"), pkg);
-				}
-				break;
 			case ALPM_ERR_UNSATISFIED_DEPS:
 				for(i = data; i; i = alpm_list_next(i)) {
-					alpm_depmissing_t *miss = alpm_list_getdata(i);
+					alpm_depmissing_t *miss = i->data;
 					char *depstring = alpm_dep_compute_string(miss->depend);
 					printf(_(":: %s: requires %s\n"), miss->target, depstring);
 					free(depstring);
@@ -133,8 +134,8 @@
 	/* Search for holdpkg in target list */
 	int holdpkg = 0;
 	for(i = alpm_trans_get_remove(config->handle); i; i = alpm_list_next(i)) {
-		alpm_pkg_t *pkg = alpm_list_getdata(i);
-		if(alpm_list_find_str(config->holdpkg, alpm_pkg_get_name(pkg))) {
+		alpm_pkg_t *pkg = i->data;
+		if(alpm_list_find(config->holdpkg, alpm_pkg_get_name(pkg), fnmatch_cmp)) {
 			pm_printf(ALPM_LOG_WARNING, _("%s is designated as a HoldPkg.\n"),
 							alpm_pkg_get_name(pkg));
 			holdpkg = 1;
diff -x '.*' -aur pacman-4.0.3/src/pacman/sync.c pacman/src/pacman/sync.c
--- pacman-4.0.3/src/pacman/sync.c	2012-03-13 13:24:11.000000000 +0000
+++ pacman/src/pacman/sync.c	2012-10-15 18:11:52.553289159 +0000
@@ -18,8 +18,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
@@ -68,7 +66,7 @@
 		return 1;
 	}
 
-	syncdbs = alpm_option_get_syncdbs(config->handle);
+	syncdbs = alpm_get_syncdbs(config->handle);
 
 	rewinddir(dir);
 	/* step through the directory one file at a time */
@@ -118,7 +116,7 @@
 		if(keep_used) {
 			alpm_list_t *i;
 			for(i = syncdbs; i && !found; i = alpm_list_next(i)) {
-				alpm_db_t *db = alpm_list_getdata(i);
+				alpm_db_t *db = i->data;
 				found = !strcmp(dbname, alpm_db_get_name(db));
 			}
 		}
@@ -169,15 +167,11 @@
 static int sync_cleancache(int level)
 {
 	alpm_list_t *i;
-	alpm_list_t *sync_dbs = alpm_option_get_syncdbs(config->handle);
-	alpm_db_t *db_local = alpm_option_get_localdb(config->handle);
+	alpm_list_t *sync_dbs = alpm_get_syncdbs(config->handle);
+	alpm_db_t *db_local = alpm_get_localdb(config->handle);
 	alpm_list_t *cachedirs = alpm_option_get_cachedirs(config->handle);
 	int ret = 0;
 
-	for(i = cachedirs; i; i = alpm_list_next(i)) {
-		printf(_("Cache directory: %s\n"), (char *)alpm_list_getdata(i));
-	}
-
 	if(!config->cleanmethod) {
 		/* default to KeepInstalled if user did not specify */
 		config->cleanmethod = PM_CLEAN_KEEPINST;
@@ -191,22 +185,31 @@
 		if(config->cleanmethod & PM_CLEAN_KEEPCUR) {
 			printf(_("  All current sync database packages\n"));
 		}
-		if(!yesno(_("Do you want to remove all other packages from cache?"))) {
-			return 0;
-		}
-		printf(_("removing old packages from cache...\n"));
-	} else {
-		if(!noyes(_("Do you want to remove ALL files from cache?"))) {
-			return 0;
-		}
-		printf(_("removing all files from cache...\n"));
 	}
+	printf("\n");
 
 	for(i = cachedirs; i; i = alpm_list_next(i)) {
-		const char *cachedir = alpm_list_getdata(i);
-		DIR *dir = opendir(cachedir);
+		const char *cachedir = i->data;
+		DIR *dir;
 		struct dirent *ent;
 
+		printf(_("Cache directory: %s\n"), (const char *)i->data);
+
+		if(level == 1) {
+			if(!yesno(_("Do you want to remove all other packages from cache?"))) {
+				printf("\n");
+				continue;
+			}
+			printf(_("removing old packages from cache...\n"));
+		} else {
+			if(!noyes(_("Do you want to remove ALL files from cache?"))) {
+				printf("\n");
+				continue;
+			}
+			printf(_("removing all files from cache...\n"));
+		}
+
+		dir = opendir(cachedir);
 		if(dir == NULL) {
 			pm_printf(ALPM_LOG_ERROR,
 					_("could not access cache directory %s\n"), cachedir);
@@ -226,19 +229,30 @@
 				continue;
 			}
 
-			/* skip signature files - they are removed with their package file */
-			if(fnmatch("*.sig", ent->d_name, 0) == 0) {
-				continue;
-			}
-
-			/* skip package database within the cache directory */
-			if(fnmatch("*.db*", ent->d_name, 0) == 0) {
-				continue;
-			}
+			if (level <= 1) {
+				static const char * const glob_skips[] = {
+					/* skip signature files - they are removed with their package file */
+					"*.sig",
+					/* skip package database within the cache directory */
+					"*.db*",
+					/* skip source packages within the cache directory */
+					"*.src.tar.*",
+					/* skip package deltas, we aren't smart enough to clean these yet */
+					"*.delta",
+					/* skip any partial downloads */
+					"*.part"
+				};
+				size_t j;
 
-			/* skip source packages within the cache directory */
-			if(fnmatch("*.src.tar*", ent->d_name, 0) == 0) {
-				continue;
+				for(j = 0; j < sizeof(glob_skips) / sizeof(glob_skips[0]); j++) {
+					if(fnmatch(glob_skips[j], ent->d_name, 0) == 0) {
+						delete = 0;
+						break;
+					}
+				}
+				if(delete == 0) {
+					continue;
+				}
 			}
 
 			/* build the full filepath */
@@ -276,7 +290,7 @@
 				alpm_list_t *j;
 				/* check if this package is in a sync DB */
 				for(j = sync_dbs; j && delete; j = alpm_list_next(j)) {
-					alpm_db_t *db = alpm_list_getdata(j);
+					alpm_db_t *db = j->data;
 					pkg = alpm_db_get_pkg(db, local_name);
 					if(pkg != NULL && alpm_pkg_vercmp(local_version,
 								alpm_pkg_get_version(pkg)) == 0) {
@@ -301,6 +315,7 @@
 			}
 		}
 		closedir(dir);
+		printf("\n");
 	}
 
 	return ret;
@@ -309,12 +324,12 @@
 static int sync_synctree(int level, alpm_list_t *syncs)
 {
 	alpm_list_t *i;
-	int success = 0, ret;
+	unsigned int success = 0;
 
 	for(i = syncs; i; i = alpm_list_next(i)) {
-		alpm_db_t *db = alpm_list_getdata(i);
+		alpm_db_t *db = i->data;
 
-		ret = alpm_db_update((level < 2 ? 0 : 1), db);
+		int ret = alpm_db_update((level < 2 ? 0 : 1), db);
 		if(ret < 0) {
 			pm_printf(ALPM_LOG_ERROR, _("failed to update %s (%s)\n"),
 					alpm_db_get_name(db), alpm_strerror(alpm_errno(config->handle)));
@@ -358,10 +373,11 @@
 	alpm_list_t *i, *j, *ret;
 	int freelist;
 	int found = 0;
-	alpm_db_t *db_local = alpm_option_get_localdb(config->handle);
+	alpm_db_t *db_local = alpm_get_localdb(config->handle);
 
 	for(i = syncs; i; i = alpm_list_next(i)) {
-		alpm_db_t *db = alpm_list_getdata(i);
+		alpm_db_t *db = i->data;
+		unsigned short cols;
 		/* if we have a targets list, search for packages matching it */
 		if(targets) {
 			ret = alpm_db_search(db, targets);
@@ -375,39 +391,40 @@
 		} else {
 			found = 1;
 		}
+		cols = getcols(fileno(stdout));
 		for(j = ret; j; j = alpm_list_next(j)) {
 			alpm_list_t *grp;
-			alpm_pkg_t *pkg = alpm_list_getdata(j);
+			alpm_pkg_t *pkg = j->data;
 
 			if(!config->quiet) {
 				printf("%s/%s %s", alpm_db_get_name(db), alpm_pkg_get_name(pkg),
 							 alpm_pkg_get_version(pkg));
 			} else {
-				printf("%s", alpm_pkg_get_name(pkg));
+				fputs(alpm_pkg_get_name(pkg), stdout);
 			}
 
 			if(!config->quiet) {
 				if((grp = alpm_pkg_get_groups(pkg)) != NULL) {
 					alpm_list_t *k;
-					printf(" (");
+					fputs(" (", stdout);
 					for(k = grp; k; k = alpm_list_next(k)) {
-						const char *group = alpm_list_getdata(k);
-						printf("%s", group);
+						const char *group = k->data;
+						fputs(group, stdout);
 						if(alpm_list_next(k)) {
 							/* only print a spacer if there are more groups */
-							printf(" ");
+							putchar(' ');
 						}
 					}
-					printf(")");
+					putchar(')');
 				}
 
 				print_installed(db_local, pkg);
 
 				/* we need a newline and initial indent first */
-				printf("\n    ");
-				indentprint(alpm_pkg_get_desc(pkg), 4);
+				fputs("\n    ", stdout);
+				indentprint(alpm_pkg_get_desc(pkg), 4, cols);
 			}
-			printf("\n");
+			fputc('\n', stdout);
 		}
 		/* we only want to free if the list was a search list */
 		if(freelist) {
@@ -420,23 +437,23 @@
 
 static int sync_group(int level, alpm_list_t *syncs, alpm_list_t *targets)
 {
-	alpm_list_t *i, *j, *k;
+	alpm_list_t *i, *j, *k, *s = NULL;
 
 	if(targets) {
 		for(i = targets; i; i = alpm_list_next(i)) {
-			const char *grpname = alpm_list_getdata(i);
+			const char *grpname = i->data;
 			for(j = syncs; j; j = alpm_list_next(j)) {
-				alpm_db_t *db = alpm_list_getdata(j);
-				alpm_group_t *grp = alpm_db_readgroup(db, grpname);
+				alpm_db_t *db = j->data;
+				alpm_group_t *grp = alpm_db_get_group(db, grpname);
 
 				if(grp) {
 					/* get names of packages in group */
 					for(k = grp->packages; k; k = alpm_list_next(k)) {
 						if(!config->quiet) {
 							printf("%s %s\n", grpname,
-									alpm_pkg_get_name(alpm_list_getdata(k)));
+									alpm_pkg_get_name(k->data));
 						} else {
-							printf("%s\n", alpm_pkg_get_name(alpm_list_getdata(k)));
+							printf("%s\n", alpm_pkg_get_name(k->data));
 						}
 					}
 				}
@@ -444,22 +461,26 @@
 		}
 	} else {
 		for(i = syncs; i; i = alpm_list_next(i)) {
-			alpm_db_t *db = alpm_list_getdata(i);
+			alpm_db_t *db = i->data;
 
 			for(j = alpm_db_get_groupcache(db); j; j = alpm_list_next(j)) {
-				alpm_group_t *grp = alpm_list_getdata(j);
+				alpm_group_t *grp = j->data;
 
 				if(level > 1) {
 					for(k = grp->packages; k; k = alpm_list_next(k)) {
 						printf("%s %s\n", grp->name,
-								alpm_pkg_get_name(alpm_list_getdata(k)));
+								alpm_pkg_get_name(k->data));
 					}
 				} else {
 					/* print grp names only, no package names */
-					printf("%s\n", grp->name);
+					if(!alpm_list_find_str (s, grp->name)) {
+						s = alpm_list_add (s, grp->name);
+						printf("%s\n", grp->name);
+					}
 				}
 			}
 		}
+		alpm_list_free(s);
 	}
 
 	return 0;
@@ -472,7 +493,7 @@
 
 	if(targets) {
 		for(i = targets; i; i = alpm_list_next(i)) {
-			const char *target = alpm_list_getdata(i);
+			const char *target = i->data;
 			char *name = strdup(target);
 			char *repo, *pkgstr;
 			int foundpkg = 0, founddb = 0;
@@ -488,14 +509,14 @@
 			}
 
 			for(j = syncs; j; j = alpm_list_next(j)) {
-				alpm_db_t *db = alpm_list_getdata(j);
+				alpm_db_t *db = j->data;
 				if(repo && strcmp(repo, alpm_db_get_name(db)) != 0) {
 					continue;
 				}
 				founddb = 1;
 
 				for(k = alpm_db_get_pkgcache(db); k; k = alpm_list_next(k)) {
-					alpm_pkg_t *pkg = alpm_list_getdata(k);
+					alpm_pkg_t *pkg = k->data;
 
 					if(strcmp(alpm_pkg_get_name(pkg), pkgstr) == 0) {
 						dump_pkg_full(pkg, config->op_s_info > 1);
@@ -519,10 +540,10 @@
 		}
 	} else {
 		for(i = syncs; i; i = alpm_list_next(i)) {
-			alpm_db_t *db = alpm_list_getdata(i);
+			alpm_db_t *db = i->data;
 
 			for(j = alpm_db_get_pkgcache(db); j; j = alpm_list_next(j)) {
-				alpm_pkg_t *pkg = alpm_list_getdata(j);
+				alpm_pkg_t *pkg = j->data;
 				dump_pkg_full(pkg, config->op_s_info > 1);
 			}
 		}
@@ -534,15 +555,15 @@
 static int sync_list(alpm_list_t *syncs, alpm_list_t *targets)
 {
 	alpm_list_t *i, *j, *ls = NULL;
-	alpm_db_t *db_local = alpm_option_get_localdb(config->handle);
+	alpm_db_t *db_local = alpm_get_localdb(config->handle);
 
 	if(targets) {
 		for(i = targets; i; i = alpm_list_next(i)) {
-			const char *repo = alpm_list_getdata(i);
+			const char *repo = i->data;
 			alpm_db_t *db = NULL;
 
 			for(j = syncs; j; j = alpm_list_next(j)) {
-				alpm_db_t *d = alpm_list_getdata(j);
+				alpm_db_t *d = j->data;
 
 				if(strcmp(repo, alpm_db_get_name(d)) == 0) {
 					db = d;
@@ -564,10 +585,10 @@
 	}
 
 	for(i = ls; i; i = alpm_list_next(i)) {
-		alpm_db_t *db = alpm_list_getdata(i);
+		alpm_db_t *db = i->data;
 
 		for(j = alpm_db_get_pkgcache(db); j; j = alpm_list_next(j)) {
-			alpm_pkg_t *pkg = alpm_list_getdata(j);
+			alpm_pkg_t *pkg = j->data;
 
 			if(!config->quiet) {
 				printf("%s %s %s", alpm_db_get_name(db), alpm_pkg_get_name(pkg),
@@ -587,30 +608,10 @@
 	return 0;
 }
 
-static alpm_list_t *syncfirst(void) {
-	alpm_list_t *i, *res = NULL;
-	alpm_db_t *db_local = alpm_option_get_localdb(config->handle);
-	alpm_list_t *syncdbs = alpm_option_get_syncdbs(config->handle);
-
-	for(i = config->syncfirst; i; i = alpm_list_next(i)) {
-		char *pkgname = alpm_list_getdata(i);
-		alpm_pkg_t *pkg = alpm_db_get_pkg(db_local, pkgname);
-		if(pkg == NULL) {
-			continue;
-		}
-
-		if(alpm_sync_newversion(pkg, syncdbs)) {
-			res = alpm_list_add(res, strdup(pkgname));
-		}
-	}
-
-	return res;
-}
-
 static alpm_db_t *get_db(const char *dbname)
 {
 	alpm_list_t *i;
-	for(i = alpm_option_get_syncdbs(config->handle); i; i = i->next) {
+	for(i = alpm_get_syncdbs(config->handle); i; i = i->next) {
 		alpm_db_t *db = i->data;
 		if(strcmp(alpm_db_get_name(db), dbname) == 0) {
 			return db;
@@ -624,7 +625,7 @@
 	int ret = alpm_add_pkg(config->handle, pkg);
 
 	if(ret == -1) {
-		enum _alpm_errno_t err = alpm_errno(config->handle);
+		alpm_errno_t err = alpm_errno(config->handle);
 		if(err == ALPM_ERR_TRANS_DUP_TARGET
 				|| err == ALPM_ERR_PKG_IGNORED) {
 			/* just skip duplicate or ignored targets */
@@ -640,7 +641,7 @@
 	return 0;
 }
 
-static int process_group(alpm_list_t *dbs, const char *group)
+static int process_group(alpm_list_t *dbs, const char *group, int error)
 {
 	int ret = 0;
 	alpm_list_t *i;
@@ -652,6 +653,12 @@
 		return 1;
 	}
 
+	if(error) {
+		/* we already know another target errored. there is no reason to prompt the
+		 * user here; we already validated the group name so just move on since we
+		 * won't actually be installing anything anyway. */
+		goto cleanup;
+	}
 
 	if(config->print == 0) {
 		printf(_(":: There are %d members in group %s:\n"), count,
@@ -671,7 +678,7 @@
 		for(i = pkgs; i; i = alpm_list_next(i)) {
 			if(array[n++] == 0)
 				continue;
-			alpm_pkg_t *pkg = alpm_list_getdata(i);
+			alpm_pkg_t *pkg = i->data;
 
 			if(process_pkg(pkg) == 1) {
 				ret = 1;
@@ -682,7 +689,7 @@
 		free(array);
 	} else {
 		for(i = pkgs; i; i = alpm_list_next(i)) {
-			alpm_pkg_t *pkg = alpm_list_getdata(i);
+			alpm_pkg_t *pkg = i->data;
 
 			if(process_pkg(pkg) == 1) {
 				ret = 1;
@@ -690,12 +697,14 @@
 			}
 		}
 	}
+
 cleanup:
 	alpm_list_free(pkgs);
 	return ret;
 }
 
-static int process_targname(alpm_list_t *dblist, const char *targname)
+static int process_targname(alpm_list_t *dblist, const char *targname,
+		int error)
 {
 	alpm_pkg_t *pkg = alpm_find_dbs_satisfier(config->handle, dblist, targname);
 
@@ -709,20 +718,20 @@
 		return process_pkg(pkg);
 	}
 	/* fallback on group */
-	return process_group(dblist, targname);
+	return process_group(dblist, targname, error);
 }
 
-static int process_target(const char *target)
+static int process_target(const char *target, int error)
 {
 	/* process targets */
 	char *targstring = strdup(target);
 	char *targname = strchr(targstring, '/');
-	char *dbname = NULL;
 	int ret = 0;
-	alpm_list_t *dblist = NULL;
+	alpm_list_t *dblist;
 
 	if(targname && targname != targstring) {
-		alpm_db_t *db = NULL;
+		alpm_db_t *db;
+		const char *dbname;
 
 		*targname = '\0';
 		targname++;
@@ -734,14 +743,15 @@
 			ret = 1;
 			goto cleanup;
 		}
-		dblist = alpm_list_add(dblist, db);
-		ret = process_targname(dblist, targname);
+		dblist = alpm_list_add(NULL, db);
+		ret = process_targname(dblist, targname, error);
 		alpm_list_free(dblist);
 	} else {
 		targname = targstring;
-		dblist = alpm_option_get_syncdbs(config->handle);
-		ret = process_targname(dblist, targname);
+		dblist = alpm_get_syncdbs(config->handle);
+		ret = process_targname(dblist, targname, error);
 	}
+
 cleanup:
 	free(targstring);
 	if(ret && access(target, R_OK) == 0) {
@@ -754,6 +764,7 @@
 
 static int sync_trans(alpm_list_t *targets)
 {
+	int retval = 0;
 	alpm_list_t *i;
 
 	/* Step 1: create a new transaction... */
@@ -763,13 +774,17 @@
 
 	/* process targets */
 	for(i = targets; i; i = alpm_list_next(i)) {
-		char *targ = alpm_list_getdata(i);
-		if(process_target(targ) == 1) {
-			trans_release();
-			return 1;
+		const char *targ = i->data;
+		if(process_target(targ, retval) == 1) {
+			retval = 1;
 		}
 	}
 
+	if(retval) {
+		trans_release();
+		return retval;
+	}
+
 	if(config->op_s_upgrade) {
 		printf(_(":: Starting full system upgrade...\n"));
 		alpm_logaction(config->handle, "starting full system upgrade\n");
@@ -790,19 +805,19 @@
 
 	/* Step 2: "compute" the transaction based on targets and flags */
 	if(alpm_trans_prepare(config->handle, &data) == -1) {
-		enum _alpm_errno_t err = alpm_errno(config->handle);
+		alpm_errno_t err = alpm_errno(config->handle);
 		pm_printf(ALPM_LOG_ERROR, _("failed to prepare transaction (%s)\n"),
 		        alpm_strerror(err));
 		switch(err) {
 			case ALPM_ERR_PKG_INVALID_ARCH:
 				for(i = data; i; i = alpm_list_next(i)) {
-					char *pkg = alpm_list_getdata(i);
+					const char *pkg = i->data;
 					printf(_(":: package %s does not have a valid architecture\n"), pkg);
 				}
 				break;
 			case ALPM_ERR_UNSATISFIED_DEPS:
 				for(i = data; i; i = alpm_list_next(i)) {
-					alpm_depmissing_t *miss = alpm_list_getdata(i);
+					alpm_depmissing_t *miss = i->data;
 					char *depstring = alpm_dep_compute_string(miss->depend);
 					printf(_(":: %s: requires %s\n"), miss->target, depstring);
 					free(depstring);
@@ -810,7 +825,7 @@
 				break;
 			case ALPM_ERR_CONFLICTING_DEPS:
 				for(i = data; i; i = alpm_list_next(i)) {
-					alpm_conflict_t *conflict = alpm_list_getdata(i);
+					alpm_conflict_t *conflict = i->data;
 					/* only print reason if it contains new information */
 					if(conflict->reason->mod == ALPM_DEP_MOD_ANY) {
 						printf(_(":: %s and %s are in conflict\n"),
@@ -859,13 +874,13 @@
 	}
 
 	if(alpm_trans_commit(config->handle, &data) == -1) {
-		enum _alpm_errno_t err = alpm_errno(config->handle);
+		alpm_errno_t err = alpm_errno(config->handle);
 		pm_printf(ALPM_LOG_ERROR, _("failed to commit transaction (%s)\n"),
 		        alpm_strerror(err));
 		switch(err) {
 			case ALPM_ERR_FILE_CONFLICTS:
 				for(i = data; i; i = alpm_list_next(i)) {
-					alpm_fileconflict_t *conflict = alpm_list_getdata(i);
+					alpm_fileconflict_t *conflict = i->data;
 					switch(conflict->type) {
 						case ALPM_FILECONFLICT_TARGET:
 							printf(_("%s exists in both '%s' and '%s'\n"),
@@ -883,7 +898,7 @@
 			case ALPM_ERR_PKG_INVALID_SIG:
 			case ALPM_ERR_DLT_INVALID:
 				for(i = data; i; i = alpm_list_next(i)) {
-					const char *filename = alpm_list_getdata(i);
+					const char *filename = i->data;
 					printf(_("%s is invalid or corrupted\n"), filename);
 				}
 				break;
@@ -921,7 +936,6 @@
 		}
 
 		ret += sync_cleancache(config->op_s_clean);
-		printf("\n");
 		ret += sync_cleandb_all();
 
 		if(trans_release() == -1) {
@@ -935,7 +949,7 @@
 		return 1;
 	}
 
-	sync_dbs = alpm_option_get_syncdbs(config->handle);
+	sync_dbs = alpm_get_syncdbs(config->handle);
 
 	if(config->op_s_sync) {
 		/* grab a fresh package list */
@@ -983,38 +997,7 @@
 		}
 	}
 
-	alpm_list_t *targs = alpm_list_strdup(targets);
-	if(!config->op_s_downloadonly && !config->print) {
-		/* check for newer versions of packages to be upgraded first */
-		alpm_list_t *packages = syncfirst();
-		if(packages) {
-			/* Do not ask user if all the -S targets are SyncFirst packages, see FS#15810 */
-			alpm_list_t *tmp = NULL;
-			if(config->op_s_upgrade || (tmp = alpm_list_diff(targets, packages, (alpm_list_fn_cmp)strcmp))) {
-				alpm_list_free(tmp);
-				printf(_(":: The following packages should be upgraded first :\n"));
-				list_display("   ", packages);
-				if(yesno(_(":: Do you want to cancel the current operation\n"
-								":: and upgrade these packages now?"))) {
-					FREELIST(targs);
-					targs = packages;
-					config->flags = 0;
-					config->op_s_upgrade = 0;
-				} else {
-					FREELIST(packages);
-				}
-				printf("\n");
-			} else {
-				pm_printf(ALPM_LOG_DEBUG, "skipping SyncFirst dialog\n");
-				FREELIST(packages);
-			}
-		}
-	}
-
-	int ret = sync_trans(targs);
-	FREELIST(targs);
-
-	return ret;
+	return sync_trans(targets);
 }
 
 /* vim: set ts=2 sw=2 noet: */
diff -x '.*' -aur pacman-4.0.3/src/pacman/upgrade.c pacman/src/pacman/upgrade.c
--- pacman-4.0.3/src/pacman/upgrade.c	2011-10-21 15:40:57.000000000 +0000
+++ pacman/src/pacman/upgrade.c	2012-10-15 18:11:52.553289159 +0000
@@ -1,7 +1,7 @@
 /*
  *  upgrade.c
  *
- *  Copyright (c) 2006-2011 Pacman Development Team <pacman-dev@archlinux.org>
+ *  Copyright (c) 2006-2012 Pacman Development Team <pacman-dev@archlinux.org>
  *  Copyright (c) 2002-2006 by Judd Vinet <jvinet@zeroflux.org>
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -18,8 +18,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <stdlib.h>
 #include <stdio.h>
 #include <string.h>
@@ -41,6 +39,7 @@
  */
 int pacman_upgrade(alpm_list_t *targets)
 {
+	int retval = 0;
 	alpm_list_t *i;
 	alpm_siglevel_t level = alpm_option_get_default_siglevel(config->handle);
 
@@ -57,7 +56,7 @@
 			if(str == NULL) {
 				pm_printf(ALPM_LOG_ERROR, "'%s': %s\n",
 						(char *)i->data, alpm_strerror(alpm_errno(config->handle)));
-				return 1;
+				retval = 1;
 			} else {
 				free(i->data);
 				i->data = str;
@@ -65,6 +64,10 @@
 		}
 	}
 
+	if(retval) {
+		return retval;
+	}
+
 	/* Step 1: create a new transaction */
 	if(trans_init(config->flags, 1) == -1) {
 		return 1;
@@ -73,25 +76,30 @@
 	printf(_("loading packages...\n"));
 	/* add targets to the created transaction */
 	for(i = targets; i; i = alpm_list_next(i)) {
-		char *targ = alpm_list_getdata(i);
+		const char *targ = i->data;
 		alpm_pkg_t *pkg;
 
 		if(alpm_pkg_load(config->handle, targ, 1, level, &pkg) != 0) {
 			pm_printf(ALPM_LOG_ERROR, "'%s': %s\n",
 					targ, alpm_strerror(alpm_errno(config->handle)));
-			trans_release();
-			return 1;
+			retval = 1;
+			continue;
 		}
 		if(alpm_add_pkg(config->handle, pkg) == -1) {
 			pm_printf(ALPM_LOG_ERROR, "'%s': %s\n",
 					targ, alpm_strerror(alpm_errno(config->handle)));
 			alpm_pkg_free(pkg);
-			trans_release();
-			return 1;
+			retval = 1;
+			continue;
 		}
 		config->explicit_adds = alpm_list_add(config->explicit_adds, pkg);
 	}
 
+	if(retval) {
+		trans_release();
+		return retval;
+	}
+
 	/* now that targets are resolved, we can hand it all off to the sync code */
 	return sync_prepare_execute();
 }
diff -x '.*' -aur pacman-4.0.3/src/pacman/util.c pacman/src/pacman/util.c
--- pacman-4.0.3/src/pacman/util.c	2012-02-20 05:18:31.000000000 +0000
+++ pacman/src/pacman/util.c	2012-10-15 18:11:52.553289159 +0000
@@ -18,12 +18,10 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <sys/types.h>
 #include <sys/ioctl.h>
 #include <sys/stat.h>
-#include <sys/time.h>
+#include <time.h>
 
 #include <stdio.h>
 #include <stdlib.h>
@@ -65,7 +63,7 @@
 
 void trans_init_error(void)
 {
-	enum _alpm_errno_t err = alpm_errno(config->handle);
+	alpm_errno_t err = alpm_errno(config->handle);
 	pm_printf(ALPM_LOG_ERROR, _("failed to init transaction (%s)\n"),
 			alpm_strerror(err));
 	if(err == ALPM_ERR_HANDLE_LOCK) {
@@ -110,7 +108,7 @@
 {
 	int ret = 0;
 	alpm_list_t *i;
-	alpm_list_t *sync_dbs = alpm_option_get_syncdbs(config->handle);
+	alpm_list_t *sync_dbs = alpm_get_syncdbs(config->handle);
 
 	if(need_repos && sync_dbs == NULL) {
 		pm_printf(ALPM_LOG_ERROR, _("no usable package repositories configured.\n"));
@@ -132,10 +130,10 @@
 }
 
 /* discard unhandled input on the terminal's input buffer */
-static int flush_term_input(void) {
+static int flush_term_input(int fd) {
 #ifdef HAVE_TCFLUSH
-	if(isatty(fileno(stdin))) {
-		return tcflush(fileno(stdin), TCIFLUSH);
+	if(isatty(fd)) {
+		return tcflush(fd, TCIFLUSH);
 	}
 #endif
 
@@ -144,24 +142,24 @@
 }
 
 /* gets the current screen column width */
-unsigned short getcols(void)
+unsigned short getcols(int fd)
 {
 	const unsigned short default_tty = 80;
 	const unsigned short default_notty = 0;
 	unsigned short termwidth = 0;
 
-	if(!isatty(fileno(stdout))) {
+	if(!isatty(fd)) {
 		return default_notty;
 	}
 
-#ifdef TIOCGSIZE
+#if defined(TIOCGSIZE)
 	struct ttysize win;
-	if(ioctl(1, TIOCGSIZE, &win) == 0) {
+	if(ioctl(fd, TIOCGSIZE, &win) == 0) {
 		termwidth = win.ts_cols;
 	}
 #elif defined(TIOCGWINSZ)
 	struct winsize win;
-	if(ioctl(1, TIOCGWINSZ, &win) == 0) {
+	if(ioctl(fd, TIOCGWINSZ, &win) == 0) {
 		termwidth = win.ws_col;
 	}
 #endif
@@ -241,14 +239,22 @@
 		return strdup(".");
 	}
 
-	ret = strdup(path);
+	if((ret = strdup(path)) == NULL) {
+		return NULL;
+	}
+
 	last = strrchr(ret, '/');
 
 	if(last != NULL) {
 		/* we found a '/', so terminate our string */
+		if(last == ret) {
+			/* return "/" for root */
+			last++;
+		}
 		*last = '\0';
 		return ret;
 	}
+
 	/* no slash found */
 	free(ret);
 	return strdup(".");
@@ -256,12 +262,11 @@
 
 /* output a string, but wrap words properly with a specified indentation
  */
-void indentprint(const char *str, size_t indent)
+void indentprint(const char *str, unsigned short indent, unsigned short cols)
 {
 	wchar_t *wcstr;
 	const wchar_t *p;
-	int len, cidx;
-	const unsigned short cols = getcols();
+	size_t len, cidx;
 
 	if(!str) {
 		return;
@@ -270,7 +275,7 @@
 	/* if we're not a tty, or our tty is not wide enough that wrapping even makes
 	 * sense, print without indenting */
 	if(cols == 0 || indent > cols) {
-		printf("%s", str);
+		fputs(str, stdout);
 		return;
 	}
 
@@ -299,7 +304,7 @@
 			while(q < next) {
 				len += wcwidth(*q++);
 			}
-			if(len > (cols - cidx - 1)) {
+			if((len + 1) > (cols - cidx)) {
 				/* wrap to a newline and reindent */
 				printf("\n%-*s", (int)indent, "");
 				cidx = indent;
@@ -318,13 +323,13 @@
 
 /* Trim whitespace and newlines from a string
  */
-char *strtrim(char *str)
+size_t strtrim(char *str)
 {
-	char *pch = str;
+	char *end, *pch = str;
 
 	if(str == NULL || *str == '\0') {
 		/* string is empty, so we're done. */
-		return str;
+		return 0;
 	}
 
 	while(isspace((unsigned char)*pch)) {
@@ -341,16 +346,16 @@
 
 	/* check if there wasn't anything but whitespace in the string. */
 	if(*str == '\0') {
-		return str;
+		return 0;
 	}
 
-	pch = (str + (strlen(str) - 1));
-	while(isspace((unsigned char)*pch)) {
-		pch--;
+	end = (str + strlen(str) - 1);
+	while(isspace((unsigned char)*end)) {
+		end--;
 	}
-	*++pch = '\0';
+	*++end = '\0';
 
-	return str;
+	return end - pch;
 }
 
 /* Replace all occurances of 'needle' with 'replace' in 'str', returning
@@ -391,7 +396,7 @@
 	p = str;
 	newp = newstr;
 	for(i = list; i; i = alpm_list_next(i)) {
-		q = alpm_list_getdata(i);
+		q = i->data;
 		if(q > p) {
 			/* add chars between this occurence and last occurence, if any */
 			memcpy(newp, p, (size_t)(q - p));
@@ -463,7 +468,7 @@
 	return len;
 }
 
-void string_display(const char *title, const char *string)
+void string_display(const char *title, const char *string, unsigned short cols)
 {
 	if(title) {
 		printf("%s ", title);
@@ -473,82 +478,128 @@
 	} else {
 		/* compute the length of title + a space */
 		size_t len = string_length(title) + 1;
-		indentprint(string, len);
+		indentprint(string, (unsigned short)len, cols);
 	}
 	printf("\n");
 }
 
-static void table_print_line(const alpm_list_t *line,
-		size_t colcount, size_t *widths)
+static void table_print_line(const alpm_list_t *line, short col_padding,
+		size_t colcount, size_t *widths, int *has_data)
 {
-	size_t i;
+	size_t i, lastcol = 0;
+	int need_padding = 0;
 	const alpm_list_t *curcell;
 
+	for(i = colcount; i > 0; i--) {
+		if(has_data[i - 1]) {
+			lastcol = i - 1;
+			break;
+		}
+	}
+
 	for(i = 0, curcell = line; curcell && i < colcount;
 			i++, curcell = alpm_list_next(curcell)) {
-		const char *value = curcell->data;
-		size_t len = string_length(value);
+		const char *value;
+		int cell_padding;
+
+		if(!has_data[i]) {
+			continue;
+		}
+
+		value = curcell->data;
+		if(!value) {
+			value = "";
+		}
 		/* silly printf requires padding size to be an int */
-		int padding = (int)widths[i] - (int)len;
-		if(padding < 0) {
-			padding = 0;
+		cell_padding = (int)widths[i] - (int)string_length(value);
+		if(cell_padding < 0) {
+			cell_padding = 0;
+		}
+		if(need_padding) {
+			printf("%*s", col_padding, "");
 		}
 		/* left-align all but the last column */
-		if(i + 1 < colcount) {
-			printf("%s%*s", value, padding, "");
+		if(i != lastcol) {
+			printf("%s%*s", value, cell_padding, "");
 		} else {
-			printf("%*s%s", padding, "", value);
+			printf("%*s%s", cell_padding, "", value);
 		}
+		need_padding = 1;
 	}
 
 	printf("\n");
 }
 
-/* find the max string width of each column */
+
+
+/**
+ * Find the max string width of each column. Also determines whether values
+ * exist in the column and sets the value in has_data accordingly.
+ * @param header a list of header strings
+ * @param rows a list of lists of rows as strings
+ * @param padding the amount of padding between columns
+ * @param totalcols the total number of columns in the header and each row
+ * @param widths a pointer to store width data
+ * @param has_data a pointer to store whether column has data
+ *
+ * @return the total width of the table; 0 on failure
+ */
 static size_t table_calc_widths(const alpm_list_t *header,
-		const alpm_list_t *rows, size_t totalcols, size_t **widths)
+		const alpm_list_t *rows, short padding, size_t totalcols,
+		size_t **widths, int **has_data)
 {
 	const alpm_list_t *i;
-	const unsigned short padding = 2;
-	size_t curcol, totalwidth = 0;
+	size_t curcol, totalwidth = 0, usefulcols = 0;
 	size_t *colwidths;
+	int *coldata;
 
 	if(totalcols <= 0) {
 		return 0;
 	}
 
 	colwidths = malloc(totalcols * sizeof(size_t));
-	if(!colwidths) {
+	coldata = calloc(totalcols, sizeof(int));
+	if(!colwidths || !coldata) {
 		return 0;
 	}
 	/* header determines column count and initial values of longest_strs */
 	for(i = header, curcol = 0; i; i = alpm_list_next(i), curcol++) {
-		colwidths[curcol] = string_length(alpm_list_getdata(i));
+		colwidths[curcol] = string_length(i->data);
+		/* note: header does not determine whether column has data */
 	}
 
 	/* now find the longest string in each column */
 	for(i = rows; i; i = alpm_list_next(i)) {
 		/* grab first column of each row and iterate through columns */
-		const alpm_list_t *j = alpm_list_getdata(i);
+		const alpm_list_t *j = i->data;
 		for(curcol = 0; j; j = alpm_list_next(j), curcol++) {
-			char *str = alpm_list_getdata(j);
+			const char *str = j->data;
 			size_t str_len = string_length(str);
 
 			if(str_len > colwidths[curcol]) {
 				colwidths[curcol] = str_len;
 			}
+			if(str_len > 0) {
+				coldata[curcol] = 1;
+			}
 		}
 	}
 
 	for(i = header, curcol = 0; i; i = alpm_list_next(i), curcol++) {
-		/* pad everything but the last column */
-		if(curcol + 1 < totalcols) {
-			colwidths[curcol] += padding;
+		/* only include columns that have data */
+		if(coldata[curcol]) {
+			usefulcols++;
+			totalwidth += colwidths[curcol];
 		}
-		totalwidth += colwidths[curcol];
+	}
+
+	/* add padding between columns */
+	if(usefulcols > 0) {
+		totalwidth += padding * (usefulcols - 1);
 	}
 
 	*widths = colwidths;
+	*has_data = coldata;
 	return totalwidth;
 }
 
@@ -559,28 +610,31 @@
  *               of headers
  * @param rows the rows to display as a list of lists of strings. the outer
  *             list represents the rows, the inner list the cells (= columns)
- *
+ * @param cols the number of columns available in the terminal
  * @return -1 if not enough terminal cols available, else 0
  */
-int table_display(const char *title, const alpm_list_t *header,
-		const alpm_list_t *rows)
+static int table_display(const char *title, const alpm_list_t *header,
+		const alpm_list_t *rows, unsigned short cols)
 {
+	const unsigned short padding = 2;
 	const alpm_list_t *i;
 	size_t *widths = NULL, totalcols, totalwidth;
+	int *has_data = NULL;
 
 	if(rows == NULL || header == NULL) {
 		return 0;
 	}
 
 	totalcols = alpm_list_count(header);
-	totalwidth = table_calc_widths(header, rows, totalcols, &widths);
+	totalwidth = table_calc_widths(header, rows, padding, totalcols,
+			&widths, &has_data);
 	/* return -1 if terminal is not wide enough */
-	if(totalwidth > getcols()) {
+	if(totalwidth > cols) {
 		pm_printf(ALPM_LOG_WARNING,
 				_("insufficient columns available for table display\n"));
 		return -1;
 	}
-	if(!totalwidth || !widths) {
+	if(!totalwidth || !widths || !has_data) {
 		return -1;
 	}
 
@@ -588,18 +642,20 @@
 		printf("%s\n\n", title);
 	}
 
-	table_print_line(header, totalcols, widths);
+	table_print_line(header, padding, totalcols, widths, has_data);
 	printf("\n");
 
 	for(i = rows; i; i = alpm_list_next(i)) {
-		table_print_line(alpm_list_getdata(i), totalcols, widths);
+		table_print_line(i->data, padding, totalcols, widths, has_data);
 	}
 
 	free(widths);
+	free(has_data);
 	return 0;
 }
 
-void list_display(const char *title, const alpm_list_t *list)
+void list_display(const char *title, const alpm_list_t *list,
+		unsigned short maxcols)
 {
 	const alpm_list_t *i;
 	size_t len = 0;
@@ -612,20 +668,19 @@
 	if(!list) {
 		printf("%s\n", _("None"));
 	} else {
-		const unsigned short maxcols = getcols();
 		size_t cols = len;
-		const char *str = alpm_list_getdata(list);
-		printf("%s", str);
+		const char *str = list->data;
+		fputs(str, stdout);
 		cols += string_length(str);
 		for(i = alpm_list_next(list); i; i = alpm_list_next(i)) {
-			str = alpm_list_getdata(i);
+			str = i->data;
 			size_t s = string_length(str);
 			/* wrap only if we have enough usable column space */
 			if(maxcols > len && cols + s + 2 >= maxcols) {
 				size_t j;
 				cols = len;
 				printf("\n");
-				for (j = 1; j <= len; j++) {
+				for(j = 1; j <= len; j++) {
 					printf(" ");
 				}
 			} else if(cols != len) {
@@ -633,19 +688,20 @@
 				printf("  ");
 				cols += 2;
 			}
-			printf("%s", str);
+			fputs(str, stdout);
 			cols += s;
 		}
-		printf("\n");
+		putchar('\n');
 	}
 }
 
-void list_display_linebreak(const char *title, const alpm_list_t *list)
+void list_display_linebreak(const char *title, const alpm_list_t *list,
+		unsigned short maxcols)
 {
-	size_t len = 0;
+	unsigned short len = 0;
 
 	if(title) {
-		len = string_length(title) + 1;
+		len = (unsigned short)string_length(title) + 1;
 		printf("%s ", title);
 	}
 
@@ -654,7 +710,7 @@
 	} else {
 		const alpm_list_t *i;
 		/* Print the first element */
-		indentprint((const char *) alpm_list_getdata(list), len);
+		indentprint((const char *)list->data, len, maxcols);
 		printf("\n");
 		/* Print the rest */
 		for(i = alpm_list_next(list); i; i = alpm_list_next(i)) {
@@ -662,18 +718,19 @@
 			for(j = 1; j <= len; j++) {
 				printf(" ");
 			}
-			indentprint((const char *) alpm_list_getdata(i), len);
+			indentprint((const char *)i->data, len, maxcols);
 			printf("\n");
 		}
 	}
 }
 
-void signature_display(const char *title, alpm_siglist_t *siglist)
+void signature_display(const char *title, alpm_siglist_t *siglist,
+		unsigned short maxcols)
 {
-	size_t len = 0;
+	unsigned short len = 0;
 
 	if(title) {
-		len = string_length(title) + 1;
+		len = (unsigned short)string_length(title) + 1;
 		printf("%s ", title);
 	}
 	if(siglist->count == 0) {
@@ -737,7 +794,7 @@
 				pm_printf(ALPM_LOG_ERROR,  _("failed to allocate string\n"));
 				continue;
 			}
-			indentprint(sigline, len);
+			indentprint(sigline, len, maxcols);
 			printf("\n");
 			free(sigline);
 		}
@@ -745,7 +802,7 @@
 }
 
 /* creates a header row for use with table_display */
-static alpm_list_t *create_verbose_header(int dl_size)
+static alpm_list_t *create_verbose_header(void)
 {
 	alpm_list_t *res = NULL;
 	char *str;
@@ -758,16 +815,14 @@
 	res = alpm_list_add(res, str);
 	str = _("Net Change");
 	res = alpm_list_add(res, str);
-	if(dl_size) {
-		str = _("Download Size");
-		res = alpm_list_add(res, str);
-	}
+	str = _("Download Size");
+	res = alpm_list_add(res, str);
 
 	return res;
 }
 
 /* returns package info as list of strings */
-static alpm_list_t *create_verbose_row(pm_target_t *target, int dl_size)
+static alpm_list_t *create_verbose_row(pm_target_t *target)
 {
 	char *str;
 	off_t size = 0;
@@ -777,7 +832,12 @@
 
 	/* a row consists of the package name, */
 	if(target->install) {
-		pm_asprintf(&str, "%s", alpm_pkg_get_name(target->install));
+		const alpm_db_t *db = alpm_pkg_get_db(target->install);
+		if(db) {
+			pm_asprintf(&str, "%s/%s", alpm_db_get_name(db), alpm_pkg_get_name(target->install));
+		} else {
+			pm_asprintf(&str, "%s", alpm_pkg_get_name(target->install));
+		}
 	} else {
 		pm_asprintf(&str, "%s", alpm_pkg_get_name(target->remove));
 	}
@@ -799,16 +859,14 @@
 	pm_asprintf(&str, "%.2f %s", human_size, label);
 	ret = alpm_list_add(ret, str);
 
-	if(dl_size) {
-		size = target->install ? alpm_pkg_download_size(target->install) : 0;
+	size = target->install ? alpm_pkg_download_size(target->install) : 0;
+	if(size != 0) {
 		human_size = humanize_size(size, 'M', 2, &label);
-		if(size != 0) {
-			pm_asprintf(&str, "%.2f %s", human_size, label);
-		} else {
-			str = strdup("");
-		}
-		ret = alpm_list_add(ret, str);
+		pm_asprintf(&str, "%.2f %s", human_size, label);
+	} else {
+		str = NULL;
 	}
+	ret = alpm_list_add(ret, str);
 
 	return ret;
 }
@@ -820,8 +878,8 @@
 	const char *label;
 	double size;
 	off_t isize = 0, rsize = 0, dlsize = 0;
+	unsigned short cols;
 	alpm_list_t *i, *rows = NULL, *names = NULL;
-	int show_dl_size = config->op == PM_OP_SYNC;
 
 	if(!targets) {
 		return;
@@ -829,7 +887,7 @@
 
 	/* gather package info */
 	for(i = targets; i; i = alpm_list_next(i)) {
-		pm_target_t *target = alpm_list_getdata(i);
+		pm_target_t *target = i->data;
 
 		if(target->install) {
 			dlsize += alpm_pkg_download_size(target->install);
@@ -845,7 +903,7 @@
 	for(i = targets; i; i = alpm_list_next(i)) {
 		pm_target_t *target = i->data;
 
-		rows = alpm_list_add(rows, create_verbose_row(target, show_dl_size));
+		rows = alpm_list_add(rows, create_verbose_row(target));
 		if(target->install) {
 			pm_asprintf(&str, "%s-%s", alpm_pkg_get_name(target->install),
 					alpm_pkg_get_version(target->install));
@@ -860,24 +918,25 @@
 	}
 
 	/* print to screen */
-	pm_asprintf(&str, _("Targets (%d):"), alpm_list_count(targets));
-
+	pm_asprintf(&str, _("Packages (%d):"), alpm_list_count(targets));
 	printf("\n");
+
+	cols = getcols(fileno(stdout));
 	if(verbose) {
-		alpm_list_t *header = create_verbose_header(show_dl_size);
-		if(table_display(str, header, rows) != 0) {
+		alpm_list_t *header = create_verbose_header();
+		if(table_display(str, header, rows, cols) != 0) {
 			/* fallback to list display if table wouldn't fit */
-			list_display(str, names);
+			list_display(str, names, cols);
 		}
 		alpm_list_free(header);
 	} else {
-		list_display(str, names);
+		list_display(str, names, cols);
 	}
 	printf("\n");
 
 	/* rows is a list of lists of strings, free inner lists here */
 	for(i = rows; i; i = alpm_list_next(i)) {
-		alpm_list_t *lp = alpm_list_getdata(i);
+		alpm_list_t *lp = i->data;
 		FREELIST(lp);
 	}
 	alpm_list_free(rows);
@@ -931,10 +990,10 @@
 void display_targets(void)
 {
 	alpm_list_t *i, *targets = NULL;
-	alpm_db_t *db_local = alpm_option_get_localdb(config->handle);
+	alpm_db_t *db_local = alpm_get_localdb(config->handle);
 
 	for(i = alpm_trans_get_add(config->handle); i; i = alpm_list_next(i)) {
-		alpm_pkg_t *pkg = alpm_list_getdata(i);
+		alpm_pkg_t *pkg = i->data;
 		pm_target_t *targ = calloc(1, sizeof(pm_target_t));
 		if(!targ) return;
 		targ->install = pkg;
@@ -945,7 +1004,7 @@
 		targets = alpm_list_add(targets, targ);
 	}
 	for(i = alpm_trans_get_remove(config->handle); i; i = alpm_list_next(i)) {
-		alpm_pkg_t *pkg = alpm_list_getdata(i);
+		alpm_pkg_t *pkg = i->data;
 		pm_target_t *targ = calloc(1, sizeof(pm_target_t));
 		if(!targ) return;
 		targ->remove = pkg;
@@ -980,7 +1039,7 @@
 		case PM_OP_SYNC:
 			servers = alpm_db_get_servers(alpm_pkg_get_db(pkg));
 			if(servers) {
-				pm_asprintf(&string, "%s/%s", alpm_list_getdata(servers),
+				pm_asprintf(&string, "%s/%s", servers->data,
 						alpm_pkg_get_filename(pkg));
 				return string;
 			}
@@ -1054,7 +1113,7 @@
 		config->print_format = strdup("%l");
 	}
 	for(i = packages; i; i = alpm_list_next(i)) {
-		alpm_pkg_t *pkg = alpm_list_getdata(i);
+		alpm_pkg_t *pkg = i->data;
 		char *string = strdup(config->print_format);
 		char *temp = string;
 		/* %n : pkgname */
@@ -1096,46 +1155,104 @@
 			free(size);
 			free(temp);
 		}
-		printf("%s\n",string);
+		printf("%s\n", string);
 		free(string);
 	}
 }
 
-/* Helper function for comparing strings using the
- * alpm "compare func" signature */
-int str_cmp(const void *s1, const void *s2)
+/**
+ * Helper function for comparing depends using the alpm "compare func"
+ * signature. The function descends through the structure in the following
+ * comparison order: name, modifier (e.g., '>', '='), version, description.
+ * @param d1 the first depend structure
+ * @param d2 the second depend structure
+ * @return -1, 0, or 1 if first is <, ==, or > second
+ */
+static int depend_cmp(const void *d1, const void *d2)
 {
-	return strcmp(s1, s2);
+	const alpm_depend_t *dep1 = d1;
+	const alpm_depend_t *dep2 = d2;
+	int ret;
+
+	ret = strcmp(dep1->name, dep2->name);
+	if(ret == 0) {
+		ret = dep1->mod - dep2->mod;
+	}
+	if(ret == 0) {
+		if(dep1->version && dep2->version) {
+			ret = strcmp(dep1->version, dep2->version);
+		} else if(!dep1->version && dep2->version) {
+			ret = -1;
+		} else if(dep1->version && !dep2->version) {
+			ret = 1;
+		}
+	}
+	if(ret == 0) {
+		if(dep1->desc && dep2->desc) {
+			ret = strcmp(dep1->desc, dep2->desc);
+		} else if(!dep1->desc && dep2->desc) {
+			ret = -1;
+		} else if(dep1->desc && !dep2->desc) {
+			ret = 1;
+		}
+	}
+
+	return ret;
 }
 
 void display_new_optdepends(alpm_pkg_t *oldpkg, alpm_pkg_t *newpkg)
 {
-	alpm_list_t *old = alpm_pkg_get_optdepends(oldpkg);
-	alpm_list_t *new = alpm_pkg_get_optdepends(newpkg);
-	alpm_list_t *optdeps = alpm_list_diff(new,old,str_cmp);
-	if(optdeps) {
+	alpm_list_t *i, *old, *new, *optdeps, *optstrings = NULL;
+
+	old = alpm_pkg_get_optdepends(oldpkg);
+	new = alpm_pkg_get_optdepends(newpkg);
+	optdeps = alpm_list_diff(new, old, depend_cmp);
+
+	/* turn optdepends list into a text list */
+	for(i = optdeps; i; i = alpm_list_next(i)) {
+		alpm_depend_t *optdep = i->data;
+		optstrings = alpm_list_add(optstrings, alpm_dep_compute_string(optdep));
+	}
+
+	if(optstrings) {
 		printf(_("New optional dependencies for %s\n"), alpm_pkg_get_name(newpkg));
-		list_display_linebreak("   ", optdeps);
+		unsigned short cols = getcols(fileno(stdout));
+		list_display_linebreak("   ", optstrings, cols);
 	}
+
 	alpm_list_free(optdeps);
+	FREELIST(optstrings);
 }
 
 void display_optdepends(alpm_pkg_t *pkg)
 {
-	alpm_list_t *optdeps = alpm_pkg_get_optdepends(pkg);
-	if(optdeps) {
+	alpm_list_t *i, *optdeps, *optstrings = NULL;
+
+	optdeps = alpm_pkg_get_optdepends(pkg);
+
+	/* turn optdepends list into a text list */
+	for(i = optdeps; i; i = alpm_list_next(i)) {
+		alpm_depend_t *optdep = i->data;
+		optstrings = alpm_list_add(optstrings, alpm_dep_compute_string(optdep));
+	}
+
+	if(optstrings) {
 		printf(_("Optional dependencies for %s\n"), alpm_pkg_get_name(pkg));
-		list_display_linebreak("   ", optdeps);
+		unsigned short cols = getcols(fileno(stdout));
+		list_display_linebreak("   ", optstrings, cols);
 	}
+
+	FREELIST(optstrings);
 }
 
-static void display_repo_list(const char *dbname, alpm_list_t *list)
+static void display_repo_list(const char *dbname, alpm_list_t *list,
+		unsigned short cols)
 {
 	const char *prefix= "  ";
 
 	printf(":: ");
 	printf(_("Repository %s\n"), dbname);
-	list_display(prefix, list);
+	list_display(prefix, list, cols);
 }
 
 void select_display(const alpm_list_t *pkglist)
@@ -1145,15 +1262,16 @@
 	alpm_list_t *list = NULL;
 	char *string = NULL;
 	const char *dbname = NULL;
+	unsigned short cols = getcols(fileno(stdout));
 
-	for (i = pkglist; i; i = i->next) {
-		alpm_pkg_t *pkg = alpm_list_getdata(i);
+	for(i = pkglist; i; i = i->next) {
+		alpm_pkg_t *pkg = i->data;
 		alpm_db_t *db = alpm_pkg_get_db(pkg);
 
 		if(!dbname)
 			dbname = alpm_db_get_name(db);
 		if(strcmp(alpm_db_get_name(db), dbname) != 0) {
-			display_repo_list(dbname, list);
+			display_repo_list(dbname, list, cols);
 			FREELIST(list);
 			dbname = alpm_db_get_name(db);
 		}
@@ -1162,7 +1280,7 @@
 		list = alpm_list_add(list, string);
 		nth++;
 	}
-	display_repo_list(dbname, list);
+	display_repo_list(dbname, list, cols);
 	FREELIST(list);
 }
 
@@ -1189,17 +1307,17 @@
 {
 	char *str, *saveptr;
 
-	for (str = response; ; str = NULL) {
+	for(str = response; ; str = NULL) {
 		int include = 1;
 		int start, end;
+		size_t len;
 		char *ends = NULL;
-		char *starts = strtok_r(str, " ", &saveptr);
+		char *starts = strtok_r(str, " ,", &saveptr);
 
 		if(starts == NULL) {
 			break;
 		}
-		strtrim(starts);
-		int len = strlen(starts);
+		len = strtrim(starts);
 		if(len == 0)
 			continue;
 
@@ -1274,10 +1392,11 @@
 			break;
 		}
 
-		flush_term_input();
+		flush_term_input(fileno(stdin));
 
 		if(fgets(response, response_len, stdin)) {
 			const size_t response_incr = 64;
+			size_t len;
 			/* handle buffer not being large enough to read full line case */
 			while(*lastchar == '\0' && lastchar[-1] != '\n') {
 				response_len += response_incr;
@@ -1294,8 +1413,9 @@
 					return -1;
 				}
 			}
-			strtrim(response);
-			if(strlen(response) > 0) {
+
+			len = strtrim(response);
+			if(len > 0) {
 				if(multiselect_parse(array, count, response) == -1) {
 					/* only loop if user gave an invalid answer */
 					continue;
@@ -1335,11 +1455,11 @@
 			break;
 		}
 
-		flush_term_input();
+		flush_term_input(fileno(stdin));
 
 		if(fgets(response, sizeof(response), stdin)) {
-			strtrim(response);
-			if(strlen(response) > 0) {
+			size_t len = strtrim(response);
+			if(len > 0) {
 				int n;
 				if(parseindex(response, &n, 1, count) != 0)
 					continue;
@@ -1358,6 +1478,7 @@
 {
 	char response[32];
 	FILE *stream;
+	int fd_in = fileno(stdin);
 
 	if(config->noconfirm) {
 		stream = stdout;
@@ -1384,17 +1505,17 @@
 	}
 
 	fflush(stream);
-	flush_term_input();
+	flush_term_input(fd_in);
 
 	if(fgets(response, sizeof(response), stdin)) {
-		strtrim(response);
-		if(strlen(response) == 0) {
+		size_t len = strtrim(response);
+		if(len == 0) {
 			return preset;
 		}
 
 		/* if stdin is piped, response does not get printed out, and as a result
 		 * a \n is missing, resulting in broken output (FS#27909) */
-		if(!isatty(fileno(stdin))) {
+		if(!isatty(fd_in)) {
 			fprintf(stream, "%s\n", response);
 		}
 
diff -x '.*' -aur pacman-4.0.3/src/pacman/util.h pacman/src/pacman/util.h
--- pacman-4.0.3/src/pacman/util.h	2012-02-03 14:56:16.000000000 +0000
+++ pacman/src/pacman/util.h	2012-10-15 18:11:52.557414751 +0000
@@ -36,9 +36,6 @@
 #define _n(str1, str2, ct) (ct == 1 ? str1 : str2)
 #endif
 
-/* update speed for the fill_progress based functions */
-#define UPDATE_SPEED_SEC 0.2f
-
 typedef struct _pm_target_t {
 	alpm_pkg_t *remove;
 	alpm_pkg_t *install;
@@ -50,21 +47,23 @@
 int trans_release(void);
 int needs_root(void);
 int check_syncdbs(size_t need_repos, int check_valid);
-unsigned short getcols(void);
+unsigned short getcols(int fd);
 int rmrf(const char *path);
 const char *mbasename(const char *path);
 char *mdirname(const char *path);
-void indentprint(const char *str, size_t indent);
-char *strtrim(char *str);
+void indentprint(const char *str, unsigned short indent, unsigned short cols);
+size_t strtrim(char *str);
 char *strreplace(const char *str, const char *needle, const char *replace);
 alpm_list_t *strsplit(const char *str, const char splitchar);
-void string_display(const char *title, const char *string);
+void string_display(const char *title, const char *string, unsigned short cols);
 double humanize_size(off_t bytes, const char target_unit, int precision,
 		const char **label);
-int table_display(const char *title, const alpm_list_t *header, const alpm_list_t *rows);
-void list_display(const char *title, const alpm_list_t *list);
-void list_display_linebreak(const char *title, const alpm_list_t *list);
-void signature_display(const char *title, alpm_siglist_t *siglist);
+void list_display(const char *title, const alpm_list_t *list,
+		unsigned short maxcols);
+void list_display_linebreak(const char *title, const alpm_list_t *list,
+		unsigned short maxcols);
+void signature_display(const char *title, alpm_siglist_t *siglist,
+		unsigned short maxcols);
 void display_targets(void);
 int str_cmp(const void *s1, const void *s2);
 void display_new_optdepends(alpm_pkg_t *oldpkg, alpm_pkg_t *newpkg);
diff -x '.*' -aur pacman-4.0.3/src/util/Makefile.am pacman/src/util/Makefile.am
--- pacman-4.0.3/src/util/Makefile.am	2011-11-01 15:25:15.000000000 +0000
+++ pacman/src/util/Makefile.am	2012-10-15 18:11:52.557414751 +0000
@@ -1,19 +1,23 @@
 # paths set at make time
 conffile  = ${sysconfdir}/pacman.conf
 dbpath    = ${localstatedir}/lib/pacman/
+gpgdir    = ${sysconfdir}/pacman.d/gnupg/
 cachedir  = ${localstatedir}/cache/pacman/pkg/
 
 bin_PROGRAMS = vercmp testpkg testdb cleanupdelta pacsort pactree
 
 DEFS = -DLOCALEDIR=\"@localedir@\" \
        -DCONFFILE=\"$(conffile)\" \
-       -DROOTDIR=\"$(ROOTDIR)\" \
        -DDBPATH=\"$(dbpath)\" \
+       -DGPGDIR=\"$(gpgdir)\" \
        -DCACHEDIR=\"$(cachedir)\" \
        @DEFS@
-INCLUDES = -I$(top_srcdir)/lib/libalpm
 
-AM_CFLAGS = -pedantic -D_GNU_SOURCE
+AM_CPPFLAGS = \
+	-imacros $(top_builddir)/config.h \
+	-I$(top_srcdir)/lib/libalpm
+
+AM_CFLAGS = -pedantic -D_GNU_SOURCE $(WARNING_CFLAGS)
 
 cleanupdelta_SOURCES = cleanupdelta.c
 cleanupdelta_LDADD = $(top_builddir)/lib/libalpm/.libs/libalpm.la
@@ -31,6 +35,6 @@
 testpkg_LDADD = $(top_builddir)/lib/libalpm/.libs/libalpm.la
 
 vercmp_SOURCES = vercmp.c
-vercmp_LDADD = $(top_builddir)/lib/libalpm/version.lo
+vercmp_LDADD = $(top_builddir)/lib/libalpm/libalpm_la-version.lo
 
 # vim:set ts=2 sw=2 noet:
diff -x '.*' -aur pacman-4.0.3/src/util/Makefile.in pacman/src/util/Makefile.in
--- pacman-4.0.3/src/util/Makefile.in	2012-04-07 15:58:14.000000000 +0000
+++ pacman/src/util/Makefile.in	2012-10-15 18:12:23.177544777 +0000
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.11.4 from Makefile.am.
+# Makefile.in generated by automake 1.12 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -54,20 +54,23 @@
 bin_PROGRAMS = vercmp$(EXEEXT) testpkg$(EXEEXT) testdb$(EXEEXT) \
 	cleanupdelta$(EXEEXT) pacsort$(EXEEXT) pactree$(EXEEXT)
 subdir = src/util
-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in \
+	$(top_srcdir)/build-aux/depcomp \
+	$(top_srcdir)/build-aux/mkinstalldirs
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/m4/gettext.m4 \
+am__aclocal_m4_deps = $(top_srcdir)/m4/acinclude.m4 \
+	$(top_srcdir)/m4/gettext.m4 $(top_srcdir)/m4/gpgme.m4 \
 	$(top_srcdir)/m4/iconv.m4 $(top_srcdir)/m4/intlmacosx.m4 \
 	$(top_srcdir)/m4/lib-ld.m4 $(top_srcdir)/m4/lib-link.m4 \
-	$(top_srcdir)/m4/lib-prefix.m4 $(top_srcdir)/m4/libcurl.m4 \
-	$(top_srcdir)/m4/libtool.m4 $(top_srcdir)/m4/ltoptions.m4 \
-	$(top_srcdir)/m4/ltsugar.m4 $(top_srcdir)/m4/ltversion.m4 \
-	$(top_srcdir)/m4/lt~obsolete.m4 $(top_srcdir)/m4/nls.m4 \
+	$(top_srcdir)/m4/lib-prefix.m4 $(top_srcdir)/m4/libtool.m4 \
+	$(top_srcdir)/m4/ltoptions.m4 $(top_srcdir)/m4/ltsugar.m4 \
+	$(top_srcdir)/m4/ltversion.m4 $(top_srcdir)/m4/lt~obsolete.m4 \
+	$(top_srcdir)/m4/nls.m4 $(top_srcdir)/m4/pkg.m4 \
 	$(top_srcdir)/m4/po.m4 $(top_srcdir)/m4/progtest.m4 \
-	$(top_srcdir)/acinclude.m4 $(top_srcdir)/configure.ac
+	$(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
-mkinstalldirs = $(SHELL) $(top_srcdir)/mkinstalldirs
+mkinstalldirs = $(SHELL) $(top_srcdir)/build-aux/mkinstalldirs
 CONFIG_HEADER = $(top_builddir)/config.h
 CONFIG_CLEAN_FILES =
 CONFIG_CLEAN_VPATH_FILES =
@@ -77,6 +80,9 @@
 cleanupdelta_OBJECTS = $(am_cleanupdelta_OBJECTS)
 cleanupdelta_DEPENDENCIES =  \
 	$(top_builddir)/lib/libalpm/.libs/libalpm.la
+AM_V_lt = $(am__v_lt_@AM_V@)
+am__v_lt_ = $(am__v_lt_@AM_DEFAULT_V@)
+am__v_lt_0 = --silent
 am_pacsort_OBJECTS = pacsort.$(OBJEXT)
 pacsort_OBJECTS = $(am_pacsort_OBJECTS)
 pacsort_DEPENDENCIES = $(top_builddir)/lib/libalpm/.libs/libalpm.la
@@ -91,20 +97,34 @@
 testpkg_DEPENDENCIES = $(top_builddir)/lib/libalpm/.libs/libalpm.la
 am_vercmp_OBJECTS = vercmp.$(OBJEXT)
 vercmp_OBJECTS = $(am_vercmp_OBJECTS)
-vercmp_DEPENDENCIES = $(top_builddir)/lib/libalpm/version.lo
+vercmp_DEPENDENCIES =  \
+	$(top_builddir)/lib/libalpm/libalpm_la-version.lo
 DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
-depcomp = $(SHELL) $(top_srcdir)/depcomp
+depcomp = $(SHELL) $(top_srcdir)/build-aux/depcomp
 am__depfiles_maybe = depfiles
 am__mv = mv -f
 COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
 	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
-LTCOMPILE = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
-	--mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
-	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+LTCOMPILE = $(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) \
+	$(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) \
+	$(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) \
+	$(AM_CFLAGS) $(CFLAGS)
+AM_V_CC = $(am__v_CC_@AM_V@)
+am__v_CC_ = $(am__v_CC_@AM_DEFAULT_V@)
+am__v_CC_0 = @echo "  CC      " $@;
+AM_V_at = $(am__v_at_@AM_V@)
+am__v_at_ = $(am__v_at_@AM_DEFAULT_V@)
+am__v_at_0 = @
 CCLD = $(CC)
-LINK = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
-	--mode=link $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) \
-	$(LDFLAGS) -o $@
+LINK = $(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) \
+	$(LIBTOOLFLAGS) --mode=link $(CCLD) $(AM_CFLAGS) $(CFLAGS) \
+	$(AM_LDFLAGS) $(LDFLAGS) -o $@
+AM_V_CCLD = $(am__v_CCLD_@AM_V@)
+am__v_CCLD_ = $(am__v_CCLD_@AM_DEFAULT_V@)
+am__v_CCLD_0 = @echo "  CCLD    " $@;
+AM_V_GEN = $(am__v_GEN_@AM_V@)
+am__v_GEN_ = $(am__v_GEN_@AM_DEFAULT_V@)
+am__v_GEN_0 = @echo "  GEN     " $@;
 SOURCES = $(cleanupdelta_SOURCES) $(pacsort_SOURCES) \
 	$(pactree_SOURCES) $(testdb_SOURCES) $(testpkg_SOURCES) \
 	$(vercmp_SOURCES)
@@ -121,6 +141,7 @@
 DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
 ACLOCAL = @ACLOCAL@
 AMTAR = @AMTAR@
+AM_DEFAULT_VERBOSITY = @AM_DEFAULT_VERBOSITY@
 AR = @AR@
 ASCIIDOC = @ASCIIDOC@
 AUTOCONF = @AUTOCONF@
@@ -136,15 +157,11 @@
 CHOST = @CHOST@
 CPP = @CPP@
 CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXCPP = @CXXCPP@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
 CYGPATH_W = @CYGPATH_W@
 DEFS = -DLOCALEDIR=\"@localedir@\" \
        -DCONFFILE=\"$(conffile)\" \
-       -DROOTDIR=\"$(ROOTDIR)\" \
        -DDBPATH=\"$(dbpath)\" \
+       -DGPGDIR=\"$(gpgdir)\" \
        -DCACHEDIR=\"$(cachedir)\" \
        @DEFS@
 
@@ -164,7 +181,11 @@
 GIT = @GIT@
 GMSGFMT = @GMSGFMT@
 GMSGFMT_015 = @GMSGFMT_015@
+GPGME_CFLAGS = @GPGME_CFLAGS@
+GPGME_CONFIG = @GPGME_CONFIG@
+GPGME_LIBS = @GPGME_LIBS@
 GREP = @GREP@
+INODECMD = @INODECMD@
 INSTALL = @INSTALL@
 INSTALL_DATA = @INSTALL_DATA@
 INSTALL_PROGRAM = @INSTALL_PROGRAM@
@@ -174,12 +195,16 @@
 INTL_MACOSX_LIBS = @INTL_MACOSX_LIBS@
 LD = @LD@
 LDFLAGS = @LDFLAGS@
-LIBCURL = @LIBCURL@
-LIBCURL_CPPFLAGS = @LIBCURL_CPPFLAGS@
+LIBARCHIVE_CFLAGS = @LIBARCHIVE_CFLAGS@
+LIBARCHIVE_LIBS = @LIBARCHIVE_LIBS@
+LIBCURL_CFLAGS = @LIBCURL_CFLAGS@
+LIBCURL_LIBS = @LIBCURL_LIBS@
 LIBICONV = @LIBICONV@
 LIBINTL = @LIBINTL@
 LIBOBJS = @LIBOBJS@
 LIBS = @LIBS@
+LIBSSL_CFLAGS = @LIBSSL_CFLAGS@
+LIBSSL_LIBS = @LIBSSL_LIBS@
 LIBTOOL = @LIBTOOL@
 LIB_VERSION = @LIB_VERSION@
 LIB_VERSION_INFO = @LIB_VERSION_INFO@
@@ -209,10 +234,14 @@
 PACKAGE_VERSION = @PACKAGE_VERSION@
 PATH_SEPARATOR = @PATH_SEPARATOR@
 PKGEXT = @PKGEXT@
+PKG_CONFIG = @PKG_CONFIG@
+PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
+PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 POSUB = @POSUB@
 PYTHON = @PYTHON@
 RANLIB = @RANLIB@
 ROOTDIR = @ROOTDIR@
+SCRIPTLET_SHELL = @SCRIPTLET_SHELL@
 SED = @SED@
 SEDINPLACE = @SEDINPLACE@
 SET_MAKE = @SET_MAKE@
@@ -225,17 +254,16 @@
 STRIP_STATIC = @STRIP_STATIC@
 USE_NLS = @USE_NLS@
 VERSION = @VERSION@
+WARNING_CFLAGS = @WARNING_CFLAGS@
 XGETTEXT = @XGETTEXT@
 XGETTEXT_015 = @XGETTEXT_015@
 XGETTEXT_EXTRA_OPTIONS = @XGETTEXT_EXTRA_OPTIONS@
-_libcurl_config = @_libcurl_config@
 abs_builddir = @abs_builddir@
 abs_srcdir = @abs_srcdir@
 abs_top_builddir = @abs_top_builddir@
 abs_top_srcdir = @abs_top_srcdir@
 ac_ct_AR = @ac_ct_AR@
 ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
 ac_ct_DUMPBIN = @ac_ct_DUMPBIN@
 am__include = @am__include@
 am__leading_dot = @am__leading_dot@
@@ -286,9 +314,13 @@
 # paths set at make time
 conffile = ${sysconfdir}/pacman.conf
 dbpath = ${localstatedir}/lib/pacman/
+gpgdir = ${sysconfdir}/pacman.d/gnupg/
 cachedir = ${localstatedir}/cache/pacman/pkg/
-INCLUDES = -I$(top_srcdir)/lib/libalpm
-AM_CFLAGS = -pedantic -D_GNU_SOURCE
+AM_CPPFLAGS = \
+	-imacros $(top_builddir)/config.h \
+	-I$(top_srcdir)/lib/libalpm
+
+AM_CFLAGS = -pedantic -D_GNU_SOURCE $(WARNING_CFLAGS)
 cleanupdelta_SOURCES = cleanupdelta.c
 cleanupdelta_LDADD = $(top_builddir)/lib/libalpm/.libs/libalpm.la
 pacsort_SOURCES = pacsort.c
@@ -300,7 +332,7 @@
 testpkg_SOURCES = testpkg.c
 testpkg_LDADD = $(top_builddir)/lib/libalpm/.libs/libalpm.la
 vercmp_SOURCES = vercmp.c
-vercmp_LDADD = $(top_builddir)/lib/libalpm/version.lo
+vercmp_LDADD = $(top_builddir)/lib/libalpm/libalpm_la-version.lo
 all: all-am
 
 .SUFFIXES:
@@ -383,22 +415,22 @@
 	rm -f $$list
 cleanupdelta$(EXEEXT): $(cleanupdelta_OBJECTS) $(cleanupdelta_DEPENDENCIES) $(EXTRA_cleanupdelta_DEPENDENCIES) 
 	@rm -f cleanupdelta$(EXEEXT)
-	$(LINK) $(cleanupdelta_OBJECTS) $(cleanupdelta_LDADD) $(LIBS)
+	$(AM_V_CCLD)$(LINK) $(cleanupdelta_OBJECTS) $(cleanupdelta_LDADD) $(LIBS)
 pacsort$(EXEEXT): $(pacsort_OBJECTS) $(pacsort_DEPENDENCIES) $(EXTRA_pacsort_DEPENDENCIES) 
 	@rm -f pacsort$(EXEEXT)
-	$(LINK) $(pacsort_OBJECTS) $(pacsort_LDADD) $(LIBS)
+	$(AM_V_CCLD)$(LINK) $(pacsort_OBJECTS) $(pacsort_LDADD) $(LIBS)
 pactree$(EXEEXT): $(pactree_OBJECTS) $(pactree_DEPENDENCIES) $(EXTRA_pactree_DEPENDENCIES) 
 	@rm -f pactree$(EXEEXT)
-	$(LINK) $(pactree_OBJECTS) $(pactree_LDADD) $(LIBS)
+	$(AM_V_CCLD)$(LINK) $(pactree_OBJECTS) $(pactree_LDADD) $(LIBS)
 testdb$(EXEEXT): $(testdb_OBJECTS) $(testdb_DEPENDENCIES) $(EXTRA_testdb_DEPENDENCIES) 
 	@rm -f testdb$(EXEEXT)
-	$(LINK) $(testdb_OBJECTS) $(testdb_LDADD) $(LIBS)
+	$(AM_V_CCLD)$(LINK) $(testdb_OBJECTS) $(testdb_LDADD) $(LIBS)
 testpkg$(EXEEXT): $(testpkg_OBJECTS) $(testpkg_DEPENDENCIES) $(EXTRA_testpkg_DEPENDENCIES) 
 	@rm -f testpkg$(EXEEXT)
-	$(LINK) $(testpkg_OBJECTS) $(testpkg_LDADD) $(LIBS)
+	$(AM_V_CCLD)$(LINK) $(testpkg_OBJECTS) $(testpkg_LDADD) $(LIBS)
 vercmp$(EXEEXT): $(vercmp_OBJECTS) $(vercmp_DEPENDENCIES) $(EXTRA_vercmp_DEPENDENCIES) 
 	@rm -f vercmp$(EXEEXT)
-	$(LINK) $(vercmp_OBJECTS) $(vercmp_LDADD) $(LIBS)
+	$(AM_V_CCLD)$(LINK) $(vercmp_OBJECTS) $(vercmp_LDADD) $(LIBS)
 
 mostlyclean-compile:
 	-rm -f *.$(OBJEXT)
@@ -414,25 +446,25 @@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vercmp.Po@am__quote@
 
 .c.o:
-@am__fastdepCC_TRUE@	$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
-@am__fastdepCC_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(COMPILE) -c $<
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c $<
 
 .c.obj:
-@am__fastdepCC_TRUE@	$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
-@am__fastdepCC_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(COMPILE) -c `$(CYGPATH_W) '$<'`
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c `$(CYGPATH_W) '$<'`
 
 .c.lo:
-@am__fastdepCC_TRUE@	$(LTCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
-@am__fastdepCC_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Plo
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='$<' object='$@' libtool=yes @AMDEPBACKSLASH@
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LTCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=yes @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(LTCOMPILE) -c -o $@ $<
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LTCOMPILE) -c -o $@ $<
 
 mostlyclean-libtool:
 	-rm -f *.lo
@@ -489,6 +521,20 @@
 	  && $(am__cd) $(top_srcdir) \
 	  && gtags -i $(GTAGS_ARGS) "$$here"
 
+cscopelist:  $(HEADERS) $(SOURCES) $(LISP)
+	list='$(SOURCES) $(HEADERS) $(LISP)'; \
+	case "$(srcdir)" in \
+	  [\\/]* | ?:[\\/]*) sdir="$(srcdir)" ;; \
+	  *) sdir=$(subdir)/$(srcdir) ;; \
+	esac; \
+	for i in $$list; do \
+	  if test -f "$$i"; then \
+	    echo "$(subdir)/$$i"; \
+	  else \
+	    echo "$$sdir/$$i"; \
+	  fi; \
+	done >> $(top_builddir)/cscope.files
+
 distclean-tags:
 	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
 
@@ -632,18 +678,18 @@
 .MAKE: install-am install-strip
 
 .PHONY: CTAGS GTAGS all all-am check check-am clean clean-binPROGRAMS \
-	clean-generic clean-libtool ctags distclean distclean-compile \
-	distclean-generic distclean-libtool distclean-tags distdir dvi \
-	dvi-am html html-am info info-am install install-am \
-	install-binPROGRAMS install-data install-data-am install-dvi \
-	install-dvi-am install-exec install-exec-am install-html \
-	install-html-am install-info install-info-am install-man \
-	install-pdf install-pdf-am install-ps install-ps-am \
-	install-strip installcheck installcheck-am installdirs \
-	maintainer-clean maintainer-clean-generic mostlyclean \
-	mostlyclean-compile mostlyclean-generic mostlyclean-libtool \
-	pdf pdf-am ps ps-am tags uninstall uninstall-am \
-	uninstall-binPROGRAMS
+	clean-generic clean-libtool cscopelist ctags distclean \
+	distclean-compile distclean-generic distclean-libtool \
+	distclean-tags distdir dvi dvi-am html html-am info info-am \
+	install install-am install-binPROGRAMS install-data \
+	install-data-am install-dvi install-dvi-am install-exec \
+	install-exec-am install-html install-html-am install-info \
+	install-info-am install-man install-pdf install-pdf-am \
+	install-ps install-ps-am install-strip installcheck \
+	installcheck-am installdirs maintainer-clean \
+	maintainer-clean-generic mostlyclean mostlyclean-compile \
+	mostlyclean-generic mostlyclean-libtool pdf pdf-am ps ps-am \
+	tags uninstall uninstall-am uninstall-binPROGRAMS
 
 
 # vim:set ts=2 sw=2 noet:
diff -x '.*' -aur pacman-4.0.3/src/util/cleanupdelta.c pacman/src/util/cleanupdelta.c
--- pacman-4.0.3/src/util/cleanupdelta.c	2011-10-12 19:04:25.000000000 +0000
+++ pacman/src/util/cleanupdelta.c	2012-10-15 18:11:52.557414751 +0000
@@ -17,8 +17,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
@@ -56,10 +54,10 @@
 {
 	alpm_list_t *i, *j;
 	for(i = pkglist; i; i = alpm_list_next(i)) {
-		alpm_pkg_t *pkg = alpm_list_getdata(i);
+		alpm_pkg_t *pkg = i->data;
 		alpm_list_t *unused = alpm_pkg_unused_deltas(pkg);
 		for(j = unused; j; j = alpm_list_next(j)) {
-			char *delta = alpm_list_getdata(j);
+			const char *delta = j->data;
 			printf("%s\n", delta);
 		}
 		alpm_list_free(unused);
@@ -72,8 +70,8 @@
 	const alpm_siglevel_t level = ALPM_SIG_DATABASE | ALPM_SIG_DATABASE_OPTIONAL;
 
 	for(i = dbnames; i; i = alpm_list_next(i)) {
-		const char *dbname = alpm_list_getdata(i);
-		db = alpm_db_register_sync(handle, dbname, level);
+		const char *dbname = i->data;
+		db = alpm_register_syncdb(handle, dbname, level);
 		if(db == NULL) {
 			fprintf(stderr, "error: could not register sync database '%s' (%s)\n",
 					dbname, alpm_strerror(alpm_errno(handle)));
@@ -94,7 +92,7 @@
 int main(int argc, char *argv[])
 {
 	const char *dbpath = DBPATH;
-	enum _alpm_errno_t err;
+	alpm_errno_t err;
 	int a = 1;
 	alpm_list_t *dbnames = NULL;
 
diff -x '.*' -aur pacman-4.0.3/src/util/pacsort.c pacman/src/util/pacsort.c
--- pacman-4.0.3/src/util/pacsort.c	2011-10-12 19:04:25.000000000 +0000
+++ pacman/src/util/pacsort.c	2012-10-15 18:11:52.557414751 +0000
@@ -17,8 +17,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <errno.h>
 #include <getopt.h>
 #include <stdio.h>
diff -x '.*' -aur pacman-4.0.3/src/util/pactree.c pacman/src/util/pactree.c
--- pacman-4.0.3/src/util/pactree.c	2012-02-11 20:58:19.000000000 +0000
+++ pacman/src/util/pactree.c	2012-10-15 18:11:52.557414751 +0000
@@ -17,8 +17,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <ctype.h>
 #include <getopt.h>
 #include <stdio.h>
@@ -29,11 +27,18 @@
 
 #define LINE_MAX     512
 
+typedef struct tdepth {
+	struct tdepth *prev;
+	struct tdepth *next;
+	int level;
+} tdepth;
+
 /* output */
 struct graph_style {
 	const char *provides;
 	const char *tip1;
 	const char *tip2;
+	const char *limb;
 	int indent;
 };
 
@@ -41,6 +46,7 @@
 	" provides",
 	"|--",
 	"+--",
+	"|",
 	3
 };
 
@@ -48,6 +54,7 @@
 	"",
 	"",
 	"",
+	"",
 	0
 };
 
@@ -119,13 +126,13 @@
 }
 #endif
 
-static char *strtrim(char *str)
+static size_t strtrim(char *str)
 {
-	char *pch = str;
+	char *end, *pch = str;
 
 	if(str == NULL || *str == '\0') {
 		/* string is empty, so we're done. */
-		return str;
+		return 0;
 	}
 
 	while(isspace((unsigned char)*pch)) {
@@ -142,21 +149,21 @@
 
 	/* check if there wasn't anything but whitespace in the string. */
 	if(*str == '\0') {
-		return str;
+		return 0;
 	}
 
-	pch = (str + (strlen(str) - 1));
-	while(isspace((unsigned char)*pch)) {
-		pch--;
+	end = (str + strlen(str) - 1);
+	while(isspace((unsigned char)*end)) {
+		end--;
 	}
-	*++pch = '\0';
+	*++end = '\0';
 
-	return str;
+	return end - pch;
 }
 
 static int register_syncs(void) {
 	FILE *fp;
-	char *ptr, *section = NULL;
+	char *section = NULL;
 	char line[LINE_MAX];
 	const alpm_siglevel_t level = ALPM_SIG_DATABASE | ALPM_SIG_DATABASE_OPTIONAL;
 
@@ -167,23 +174,26 @@
 	}
 
 	while(fgets(line, LINE_MAX, fp)) {
+		size_t linelen;
+		char *ptr;
+
 		/* ignore whole line and end of line comments */
 		if((ptr = strchr(line, '#'))) {
 			*ptr = '\0';
 		}
 
-		strtrim(line);
+		linelen = strtrim(line);
 
-		if(strlen(line) == 0) {
+		if(linelen == 0) {
 			continue;
 		}
 
-		if(line[0] == '[' && line[strlen(line) - 1] == ']') {
+		if(line[0] == '[' && line[linelen - 1] == ']') {
 			free(section);
-			section = strndup(&line[1], strlen(line) - 2);
+			section = strndup(&line[1], linelen - 2);
 
 			if(section && strcmp(section, "options") != 0) {
-				alpm_db_register_sync(handle, section, level);
+				alpm_register_syncdb(handle, section, level);
 			}
 		}
 	}
@@ -291,28 +301,36 @@
 }
 
 /* pkg provides provision */
-static void print_text(const char *pkg, const char *provision, int depth)
+static void print_text(const char *pkg, const char *provision, tdepth *depth)
 {
-	int indent_sz = (depth + 1) * style->indent;
-
 	if(!pkg && !provision) {
 		/* not much we can do */
 		return;
 	}
 
+	/* print limbs */
+	while(depth->prev)
+		depth = depth->prev;
+	int level = 0;
+	printf("%s", color->branch1);
+	while(depth->next){
+		printf("%*s%-*s", style->indent * (depth->level - level), "",
+				style->indent, style->limb);
+		level = depth->level + 1;
+		depth = depth->next;
+	}
+	printf("%*s", style->indent * (depth->level - level), "");
+
+	/* print tip */
 	if(!pkg && provision) {
-		/* we failed to resolve provision */
-		printf("%s%*s%s%s%s [unresolvable]%s\n", color->branch1, indent_sz,
-				style->tip1, color->leaf1, provision, color->branch1, color->off);
+		printf("%s%s%s%s [unresolvable]%s\n", style->tip1,  color->leaf1,
+				provision, color->branch1, color->off);
 	} else if(provision && strcmp(pkg, provision) != 0) {
-		/* pkg provides provision */
-		printf("%s%*s%s%s%s%s %s%s%s\n", color->branch2, indent_sz, style->tip2,
-				color->leaf1, pkg, color->leaf2, style->provides, color->leaf1, provision,
+		printf("%s%s%s%s%s %s%s%s\n", style->tip2, color->leaf1, pkg,
+				color->leaf2, style->provides, color->leaf1, provision,
 				color->off);
 	} else {
-		/* pkg is a normal package */
-		printf("%s%*s%s%s%s\n", color->branch1, indent_sz, style->tip1, color->leaf1,
-				pkg, color->off);
+		printf("%s%s%s%s\n", style->tip1, color->leaf1, pkg, color->off);
 	}
 }
 
@@ -330,7 +348,7 @@
 }
 
 /* parent depends on dep which is satisfied by pkg */
-static void print(const char *parentname, const char *pkgname, const char *depname, int depth)
+static void print(const char *parentname, const char *pkgname, const char *depname, tdepth *depth)
 {
 	if(graphviz) {
 		print_graph(parentname, pkgname, depname);
@@ -346,7 +364,12 @@
 				"node [style=filled, color=green];\n"
 				" \"START\" -> \"%s\";\n", pkgname);
 	} else {
-		print_text(pkgname, provname, 0);
+		tdepth d = {
+			NULL,
+			NULL,
+			0
+		};
+		print_text(pkgname, provname, &d);
 	}
 }
 
@@ -358,92 +381,80 @@
 	}
 }
 
-static alpm_pkg_t *get_pkg_from_dbs(alpm_list_t *dbs, const char *needle) {
-	alpm_list_t *i;
-	alpm_pkg_t *ret;
-
-	for(i = dbs; i; i = alpm_list_next(i)) {
-		ret = alpm_db_get_pkg(alpm_list_getdata(i), needle);
-		if(ret) {
-			return ret;
-		}
+static alpm_list_t *get_pkg_dep_names(alpm_pkg_t *pkg)
+{
+	alpm_list_t *i, *names = NULL;
+	for(i = alpm_pkg_get_depends(pkg); i; i = alpm_list_next(i)) {
+		alpm_depend_t *d = i->data;
+		names = alpm_list_add(names, d->name);
 	}
-	return NULL;
+	return names;
 }
 
 /**
- * walk dependencies in reverse, showing packages which require the target
+ * walk dependencies, showing dependencies of the target
  */
-static void walk_reverse_deps(alpm_list_t *dblist, alpm_pkg_t *pkg, int depth)
+static void walk_deps(alpm_list_t *dblist, alpm_pkg_t *pkg, tdepth *depth, int rev)
 {
-	alpm_list_t *required_by, *i;
+	alpm_list_t *deps, *i;
 
-	if(!pkg || ((max_depth >= 0) && (depth == max_depth + 1))) {
+	if(!pkg || ((max_depth >= 0) && (depth->level > max_depth))) {
 		return;
 	}
 
 	walked = alpm_list_add(walked, (void *)alpm_pkg_get_name(pkg));
-	required_by = alpm_pkg_compute_requiredby(pkg);
 
-	for(i = required_by; i; i = alpm_list_next(i)) {
-		const char *pkgname = alpm_list_getdata(i);
+	if(rev) {
+		deps = alpm_pkg_compute_requiredby(pkg);
+	} else {
+		deps = get_pkg_dep_names(pkg);
+	}
+
+	for(i = deps; i; i = alpm_list_next(i)) {
+		const char *pkgname = i->data;
 
-		if(alpm_list_find_str(walked, pkgname)) {
+		alpm_pkg_t *dep_pkg = alpm_find_dbs_satisfier(handle, dblist, pkgname);
+
+		if(alpm_list_find_str(walked, dep_pkg ? alpm_pkg_get_name(dep_pkg) : pkgname)) {
 			/* if we've already seen this package, don't print in "unique" output
 			 * and don't recurse */
 			if(!unique) {
-				print(alpm_pkg_get_name(pkg), pkgname, NULL, depth);
+				print(alpm_pkg_get_name(pkg), alpm_pkg_get_name(dep_pkg), pkgname, depth);
 			}
 		} else {
-			print(alpm_pkg_get_name(pkg), pkgname, NULL, depth);
-			walk_reverse_deps(dblist, get_pkg_from_dbs(dblist, pkgname), depth + 1);
-		}
-	}
-
-	FREELIST(required_by);
-}
-
-/**
- * walk dependencies, showing dependencies of the target
- */
-static void walk_deps(alpm_list_t *dblist, alpm_pkg_t *pkg, int depth)
-{
-	alpm_list_t *i;
-
-	if((max_depth >= 0) && (depth == max_depth + 1)) {
-		return;
-	}
-
-	walked = alpm_list_add(walked, (void *)alpm_pkg_get_name(pkg));
-
-	for(i = alpm_pkg_get_depends(pkg); i; i = alpm_list_next(i)) {
-		alpm_depend_t *depend = alpm_list_getdata(i);
-		alpm_pkg_t *provider = alpm_find_dbs_satisfier(handle, dblist, depend->name);
-
-		if(provider) {
-			const char *provname = alpm_pkg_get_name(provider);
-
-			if(alpm_list_find_str(walked, provname)) {
-				/* if we've already seen this package, don't print in "unique" output
-				 * and don't recurse */
-				if(!unique) {
-					print(alpm_pkg_get_name(pkg), provname, depend->name, depth);
+			print(alpm_pkg_get_name(pkg), alpm_pkg_get_name(dep_pkg), pkgname, depth);
+			if(dep_pkg) {
+				tdepth d = {
+					depth,
+					NULL,
+					depth->level + 1
+				};
+				depth->next = &d;
+				/* last dep, cut off the limb here */
+				if(!alpm_list_next(i)){
+					if(depth->prev){
+						depth->prev->next = &d;
+						d.prev = depth->prev;
+						depth = &d;
+					} else {
+						d.prev = NULL;
+					}
 				}
-			} else {
-				print(alpm_pkg_get_name(pkg), provname, depend->name, depth);
-				walk_deps(dblist, provider, depth + 1);
+				walk_deps(dblist, dep_pkg, &d, rev);
+				depth->next = NULL;
 			}
-		} else {
-			/* unresolvable package */
-			print(alpm_pkg_get_name(pkg), NULL, depend->name, depth);
 		}
 	}
+
+	if(rev) {
+		FREELIST(deps);
+	}
 }
 
 int main(int argc, char *argv[])
 {
 	int freelist = 0, ret = 0;
-	enum _alpm_errno_t err;
+	alpm_errno_t err;
 	const char *target_name;
 	alpm_pkg_t *pkg;
 	alpm_list_t *dblist = NULL;
@@ -467,9 +478,9 @@
 			ret = 1;
 			goto finish;
 		}
-		dblist = alpm_option_get_syncdbs(handle);
+		dblist = alpm_get_syncdbs(handle);
 	} else {
-		dblist = alpm_list_add(dblist, alpm_option_get_localdb(handle));
+		dblist = alpm_list_add(dblist, alpm_get_localdb(handle));
 		freelist = 1;
 	}
 
@@ -485,11 +496,12 @@
 
 	print_start(alpm_pkg_get_name(pkg), target_name);
 
-	if(reverse) {
-		walk_reverse_deps(dblist, pkg, 1);
-	} else {
-		walk_deps(dblist, pkg, 1);
-	}
+	tdepth d = {
+		NULL,
+		NULL,
+		1
+	};
+	walk_deps(dblist, pkg, &d, reverse);
 
 	print_end();
 
diff -x '.*' -aur pacman-4.0.3/src/util/testdb.c pacman/src/util/testdb.c
--- pacman-4.0.3/src/util/testdb.c	2011-10-12 19:04:25.000000000 +0000
+++ pacman/src/util/testdb.c	2012-10-15 18:11:52.557414751 +0000
@@ -17,8 +17,6 @@
  *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  */
 
-#include "config.h"
-
 #include <unistd.h>
 #include <stdio.h>
 #include <stdlib.h>
@@ -94,17 +92,16 @@
 	return ret;
 }
 
-static int checkdeps(alpm_list_t *pkglist)
+static int check_deps(alpm_list_t *pkglist)
 {
 	alpm_list_t *data, *i;
 	int ret = 0;
 	/* check dependencies */
 	data = alpm_checkdeps(handle, pkglist, NULL, pkglist, 0);
 	for(i = data; i; i = alpm_list_next(i)) {
-		alpm_depmissing_t *miss = alpm_list_getdata(i);
+		alpm_depmissing_t *miss = i->data;
 		char *depstring = alpm_dep_compute_string(miss->depend);
-		printf("missing dependency for %s : %s\n", miss->target,
-				depstring);
+		printf("missing %s dependency for %s\n", depstring, miss->target);
 		free(depstring);
 		ret++;
 	}
@@ -112,14 +109,14 @@
 	return ret;
 }
 
-static int checkconflicts(alpm_list_t *pkglist)
+static int check_conflicts(alpm_list_t *pkglist)
 {
 	alpm_list_t *data, *i;
 	int ret = 0;
 	/* check conflicts */
 	data = alpm_checkconflicts(handle, pkglist);
 	for(i = data; i; i = i->next) {
-		alpm_conflict_t *conflict = alpm_list_getdata(i);
+		alpm_conflict_t *conflict = i->data;
 		printf("%s conflicts with %s\n",
 				conflict->package1, conflict->package2);
 		ret++;
@@ -128,6 +125,77 @@
 	return ret;
 }
 
+struct fileitem {
+	alpm_file_t *file;
+	alpm_pkg_t *pkg;
+};
+
+static int fileitem_cmp(const void *p1, const void *p2)
+{
+	const struct fileitem * fi1 = p1;
+	const struct fileitem * fi2 = p2;
+	return strcmp(fi1->file->name, fi2->file->name);
+}
+
+static int check_filelists(alpm_list_t *pkglist)
+{
+	alpm_list_t *i;
+	int ret = 0;
+	size_t list_size = 4096;
+	size_t offset = 0, j;
+	struct fileitem *all_files;
+	struct fileitem *prev_fileitem = NULL;
+
+	all_files = malloc(list_size * sizeof(struct fileitem));
+
+	for(i = pkglist; i; i = i->next) {
+		alpm_pkg_t *pkg = i->data;
+		alpm_filelist_t *filelist = alpm_pkg_get_files(pkg);
+		for(j = 0; j < filelist->count; j++) {
+			alpm_file_t *file = filelist->files + j;
+			/* only add files, not directories, to our big list */
+			if(file->name[strlen(file->name) - 1] == '/') {
+				continue;
+			}
+
+			/* do we need to reallocate and grow our array? */
+			if(offset >= list_size) {
+				struct fileitem *new_files;
+				new_files = realloc(all_files, list_size * 2 * sizeof(struct fileitem));
+				if(!new_files) {
+					free(all_files);
+					return 1;
+				}
+				all_files = new_files;
+				list_size *= 2;
+			}
+
+			/* we can finally add it to the list */
+			all_files[offset].file = file;
+			all_files[offset].pkg = pkg;
+			offset++;
+		}
+	}
+
+	/* now sort the list so we can find duplicates */
+	qsort(all_files, offset, sizeof(struct fileitem), fileitem_cmp);
+
+	/* do a 'uniq' style check on the list */
+	for(j = 0; j < offset; j++) {
+		struct fileitem *fileitem = all_files + j;
+		if(prev_fileitem && fileitem_cmp(prev_fileitem, fileitem) == 0) {
+			printf("file owned by %s and %s: %s\n",
+					alpm_pkg_get_name(prev_fileitem->pkg),
+					alpm_pkg_get_name(fileitem->pkg),
+					fileitem->file->name);
+		}
+		prev_fileitem = fileitem;
+	}
+
+	free(all_files);
+	return ret;
+}
+
 static int check_localdb(void)
 {
 	int ret = 0;
@@ -139,10 +207,11 @@
 		return ret;
 	}
 
-	db = alpm_option_get_localdb(handle);
+	db = alpm_get_localdb(handle);
 	pkglist = alpm_db_get_pkgcache(db);
-	ret += checkdeps(pkglist);
-	ret += checkconflicts(pkglist);
+	ret += check_deps(pkglist);
+	ret += check_conflicts(pkglist);
+	ret += check_filelists(pkglist);
 	return ret;
 }
 
@@ -154,8 +223,8 @@
 	const alpm_siglevel_t level = ALPM_SIG_DATABASE | ALPM_SIG_DATABASE_OPTIONAL;
 
 	for(i = dbnames; i; i = alpm_list_next(i)) {
-		char *dbname = alpm_list_getdata(i);
-		db = alpm_db_register_sync(handle, dbname, level);
+		const char *dbname = i->data;
+		db = alpm_register_syncdb(handle, dbname, level);
 		if(db == NULL) {
 			fprintf(stderr, "error: could not register sync database (%s)\n",
 					alpm_strerror(alpm_errno(handle)));
@@ -165,7 +234,7 @@
 		pkglist = alpm_db_get_pkgcache(db);
 		syncpkglist = alpm_list_join(syncpkglist, alpm_list_copy(pkglist));
 	}
-	ret += checkdeps(syncpkglist);
+	ret += check_deps(syncpkglist);
 
 cleanup:
 	alpm_list_free(syncpkglist);
@@ -184,8 +253,8 @@
 
 int main(int argc, char *argv[])
 {
-	int ret = 0;
-	enum _alpm_errno_t err;
+	int errors = 0;
+	alpm_errno_t err;
 	const char *dbpath = DBPATH;
 	int a = 1;
 	alpm_list_t *dbnames = NULL;
@@ -216,13 +285,13 @@
 	alpm_option_set_logcb(handle, output_cb);
 
 	if(!dbnames) {
-		ret = check_localdb();
+		errors = check_localdb();
 	} else {
-		ret = check_syncdbs(dbnames);
+		errors = check_syncdbs(dbnames);
 		alpm_list_free(dbnames);
 	}
 
-	cleanup(ret);
+	cleanup(errors > 0);
 }
 
 /* vim: set ts=2 sw=2 noet: */
diff -x '.*' -aur pacman-4.0.3/src/util/testpkg.c pacman/src/util/testpkg.c
--- pacman-4.0.3/src/util/testpkg.c	2011-10-12 19:04:25.000000000 +0000
+++ pacman/src/util/testpkg.c	2012-10-15 18:11:52.557414751 +0000
@@ -41,7 +41,7 @@
 {
 	int retval = 1; /* default = false */
 	alpm_handle_t *handle;
-	enum _alpm_errno_t err;
+	alpm_errno_t err;
 	alpm_pkg_t *pkg = NULL;
 	const alpm_siglevel_t level = ALPM_SIG_PACKAGE | ALPM_SIG_PACKAGE_OPTIONAL;
 
@@ -59,6 +59,9 @@
 	/* let us get log messages from libalpm */
 	alpm_option_set_logcb(handle, output_cb);
 
+	/* set gpgdir to default */
+	alpm_option_set_gpgdir(handle, GPGDIR);
+
 	if(alpm_pkg_load(handle, argv[1], 1, level, &pkg) == -1
 			|| pkg == NULL) {
 		err = alpm_errno(handle);
diff -x '.*' -aur pacman-4.0.3/test/pacman/Makefile.in pacman/test/pacman/Makefile.in
--- pacman-4.0.3/test/pacman/Makefile.in	2012-04-07 15:58:14.000000000 +0000
+++ pacman/test/pacman/Makefile.in	2012-10-15 18:12:23.237268328 +0000
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.11.4 from Makefile.am.
+# Makefile.in generated by automake 1.12 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -53,24 +53,31 @@
 host_triplet = @host@
 subdir = test/pacman
 DIST_COMMON = README $(srcdir)/Makefile.am $(srcdir)/Makefile.in \
-	ChangeLog TODO
+	$(top_srcdir)/build-aux/mkinstalldirs ChangeLog TODO
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/m4/gettext.m4 \
+am__aclocal_m4_deps = $(top_srcdir)/m4/acinclude.m4 \
+	$(top_srcdir)/m4/gettext.m4 $(top_srcdir)/m4/gpgme.m4 \
 	$(top_srcdir)/m4/iconv.m4 $(top_srcdir)/m4/intlmacosx.m4 \
 	$(top_srcdir)/m4/lib-ld.m4 $(top_srcdir)/m4/lib-link.m4 \
-	$(top_srcdir)/m4/lib-prefix.m4 $(top_srcdir)/m4/libcurl.m4 \
-	$(top_srcdir)/m4/libtool.m4 $(top_srcdir)/m4/ltoptions.m4 \
-	$(top_srcdir)/m4/ltsugar.m4 $(top_srcdir)/m4/ltversion.m4 \
-	$(top_srcdir)/m4/lt~obsolete.m4 $(top_srcdir)/m4/nls.m4 \
+	$(top_srcdir)/m4/lib-prefix.m4 $(top_srcdir)/m4/libtool.m4 \
+	$(top_srcdir)/m4/ltoptions.m4 $(top_srcdir)/m4/ltsugar.m4 \
+	$(top_srcdir)/m4/ltversion.m4 $(top_srcdir)/m4/lt~obsolete.m4 \
+	$(top_srcdir)/m4/nls.m4 $(top_srcdir)/m4/pkg.m4 \
 	$(top_srcdir)/m4/po.m4 $(top_srcdir)/m4/progtest.m4 \
-	$(top_srcdir)/acinclude.m4 $(top_srcdir)/configure.ac
+	$(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
-mkinstalldirs = $(SHELL) $(top_srcdir)/mkinstalldirs
+mkinstalldirs = $(SHELL) $(top_srcdir)/build-aux/mkinstalldirs
 CONFIG_HEADER = $(top_builddir)/config.h
 CONFIG_CLEAN_FILES =
 CONFIG_CLEAN_VPATH_FILES =
 SCRIPTS = $(noinst_SCRIPTS)
+AM_V_GEN = $(am__v_GEN_@AM_V@)
+am__v_GEN_ = $(am__v_GEN_@AM_DEFAULT_V@)
+am__v_GEN_0 = @echo "  GEN     " $@;
+AM_V_at = $(am__v_at_@AM_V@)
+am__v_at_ = $(am__v_at_@AM_DEFAULT_V@)
+am__v_at_0 = @
 SOURCES =
 DIST_SOURCES =
 RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
@@ -121,6 +128,7 @@
   reldir="$$dir2"
 ACLOCAL = @ACLOCAL@
 AMTAR = @AMTAR@
+AM_DEFAULT_VERBOSITY = @AM_DEFAULT_VERBOSITY@
 AR = @AR@
 ASCIIDOC = @ASCIIDOC@
 AUTOCONF = @AUTOCONF@
@@ -136,10 +144,6 @@
 CHOST = @CHOST@
 CPP = @CPP@
 CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXCPP = @CXXCPP@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
 CYGPATH_W = @CYGPATH_W@
 DEFS = @DEFS@
 DEPDIR = @DEPDIR@
@@ -158,7 +162,11 @@
 GIT = @GIT@
 GMSGFMT = @GMSGFMT@
 GMSGFMT_015 = @GMSGFMT_015@
+GPGME_CFLAGS = @GPGME_CFLAGS@
+GPGME_CONFIG = @GPGME_CONFIG@
+GPGME_LIBS = @GPGME_LIBS@
 GREP = @GREP@
+INODECMD = @INODECMD@
 INSTALL = @INSTALL@
 INSTALL_DATA = @INSTALL_DATA@
 INSTALL_PROGRAM = @INSTALL_PROGRAM@
@@ -168,12 +176,16 @@
 INTL_MACOSX_LIBS = @INTL_MACOSX_LIBS@
 LD = @LD@
 LDFLAGS = @LDFLAGS@
-LIBCURL = @LIBCURL@
-LIBCURL_CPPFLAGS = @LIBCURL_CPPFLAGS@
+LIBARCHIVE_CFLAGS = @LIBARCHIVE_CFLAGS@
+LIBARCHIVE_LIBS = @LIBARCHIVE_LIBS@
+LIBCURL_CFLAGS = @LIBCURL_CFLAGS@
+LIBCURL_LIBS = @LIBCURL_LIBS@
 LIBICONV = @LIBICONV@
 LIBINTL = @LIBINTL@
 LIBOBJS = @LIBOBJS@
 LIBS = @LIBS@
+LIBSSL_CFLAGS = @LIBSSL_CFLAGS@
+LIBSSL_LIBS = @LIBSSL_LIBS@
 LIBTOOL = @LIBTOOL@
 LIB_VERSION = @LIB_VERSION@
 LIB_VERSION_INFO = @LIB_VERSION_INFO@
@@ -203,10 +215,14 @@
 PACKAGE_VERSION = @PACKAGE_VERSION@
 PATH_SEPARATOR = @PATH_SEPARATOR@
 PKGEXT = @PKGEXT@
+PKG_CONFIG = @PKG_CONFIG@
+PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
+PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 POSUB = @POSUB@
 PYTHON = @PYTHON@
 RANLIB = @RANLIB@
 ROOTDIR = @ROOTDIR@
+SCRIPTLET_SHELL = @SCRIPTLET_SHELL@
 SED = @SED@
 SEDINPLACE = @SEDINPLACE@
 SET_MAKE = @SET_MAKE@
@@ -219,17 +235,16 @@
 STRIP_STATIC = @STRIP_STATIC@
 USE_NLS = @USE_NLS@
 VERSION = @VERSION@
+WARNING_CFLAGS = @WARNING_CFLAGS@
 XGETTEXT = @XGETTEXT@
 XGETTEXT_015 = @XGETTEXT_015@
 XGETTEXT_EXTRA_OPTIONS = @XGETTEXT_EXTRA_OPTIONS@
-_libcurl_config = @_libcurl_config@
 abs_builddir = @abs_builddir@
 abs_srcdir = @abs_srcdir@
 abs_top_builddir = @abs_top_builddir@
 abs_top_srcdir = @abs_top_srcdir@
 ac_ct_AR = @ac_ct_AR@
 ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
 ac_ct_DUMPBIN = @ac_ct_DUMPBIN@
 am__include = @am__include@
 am__leading_dot = @am__leading_dot@
@@ -336,11 +351,11 @@
 	-rm -rf .libs _libs
 
 # This directory's subdirectories are mostly independent; you can cd
-# into them and run `make' without going through this Makefile.
-# To change the values of `make' variables: instead of editing Makefiles,
-# (1) if the variable is set in `config.status', edit `config.status'
-#     (which will cause the Makefiles to be regenerated when you run `make');
-# (2) otherwise, pass the desired values on the `make' command line.
+# into them and run 'make' without going through this Makefile.
+# To change the values of 'make' variables: instead of editing Makefiles,
+# (1) if the variable is set in 'config.status', edit 'config.status'
+#     (which will cause the Makefiles to be regenerated when you run 'make');
+# (2) otherwise, pass the desired values on the 'make' command line.
 $(RECURSIVE_TARGETS):
 	@fail= failcom='exit 1'; \
 	for f in x $$MAKEFLAGS; do \
@@ -404,6 +419,10 @@
 	list='$(SUBDIRS)'; for subdir in $$list; do \
 	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) ctags); \
 	done
+cscopelist-recursive:
+	list='$(SUBDIRS)'; for subdir in $$list; do \
+	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) cscopelist); \
+	done
 
 ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
 	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
@@ -467,6 +486,20 @@
 	  && $(am__cd) $(top_srcdir) \
 	  && gtags -i $(GTAGS_ARGS) "$$here"
 
+cscopelist: cscopelist-recursive $(HEADERS) $(SOURCES) $(LISP)
+	list='$(SOURCES) $(HEADERS) $(LISP)'; \
+	case "$(srcdir)" in \
+	  [\\/]* | ?:[\\/]*) sdir="$(srcdir)" ;; \
+	  *) sdir=$(subdir)/$(srcdir) ;; \
+	esac; \
+	for i in $$list; do \
+	  if test -f "$$i"; then \
+	    echo "$(subdir)/$$i"; \
+	  else \
+	    echo "$$sdir/$$i"; \
+	  fi; \
+	done >> $(top_builddir)/cscope.files
+
 distclean-tags:
 	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
 
@@ -628,21 +661,22 @@
 uninstall-am:
 
 .MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) check-am \
-	ctags-recursive install-am install-strip tags-recursive
+	cscopelist-recursive ctags-recursive install-am install-strip \
+	tags-recursive
 
 .PHONY: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) CTAGS GTAGS \
 	all all-am check check-am clean clean-generic clean-libtool \
-	ctags ctags-recursive distclean distclean-generic \
-	distclean-libtool distclean-tags distdir dvi dvi-am html \
-	html-am info info-am install install-am install-data \
-	install-data-am install-dvi install-dvi-am install-exec \
-	install-exec-am install-html install-html-am install-info \
-	install-info-am install-man install-pdf install-pdf-am \
-	install-ps install-ps-am install-strip installcheck \
-	installcheck-am installdirs installdirs-am maintainer-clean \
-	maintainer-clean-generic mostlyclean mostlyclean-generic \
-	mostlyclean-libtool pdf pdf-am ps ps-am tags tags-recursive \
-	uninstall uninstall-am
+	cscopelist cscopelist-recursive ctags ctags-recursive \
+	distclean distclean-generic distclean-libtool distclean-tags \
+	distdir dvi dvi-am html html-am info info-am install \
+	install-am install-data install-data-am install-dvi \
+	install-dvi-am install-exec install-exec-am install-html \
+	install-html-am install-info install-info-am install-man \
+	install-pdf install-pdf-am install-ps install-ps-am \
+	install-strip installcheck installcheck-am installdirs \
+	installdirs-am maintainer-clean maintainer-clean-generic \
+	mostlyclean mostlyclean-generic mostlyclean-libtool pdf pdf-am \
+	ps ps-am tags tags-recursive uninstall uninstall-am
 
 
 # vim:set ts=2 sw=2 noet:
diff -x '.*' -aur pacman-4.0.3/test/pacman/README pacman/test/pacman/README
--- pacman-4.0.3/test/pacman/README	2011-10-12 19:04:25.000000000 +0000
+++ pacman/test/pacman/README	2012-10-15 18:11:52.557414751 +0000
@@ -108,7 +108,6 @@
   - HoldPkg
   - IgnorePkg
   - IgnoreGroup
-  - SyncFirst
   - NoExtract
   - NoUpgrade
   - XferCommand
@@ -184,7 +183,7 @@
 
 Note: there is no need to explicitly create a database.  The "local" one 
 already exists (even if empty), and sync databases are created on the fly when 
-a new database new is given.
+a new database name is given.
 
 	* addpkg(package)
 
diff -x '.*' -aur pacman-4.0.3/test/pacman/pactest.py pacman/test/pacman/pactest.py
--- pacman-4.0.3/test/pacman/pactest.py	2011-10-12 19:04:25.000000000 +0000
+++ pacman/test/pacman/pactest.py	2012-10-15 18:11:52.557414751 +0000
@@ -1,4 +1,4 @@
-#! /usr/bin/python
+#! /usr/bin/python2
 #
 #  pactest : run automated testing on the pacman binary
 #
diff -x '.*' -aur pacman-4.0.3/test/pacman/pmdb.py pacman/test/pacman/pmdb.py
--- pacman-4.0.3/test/pacman/pmdb.py	2011-10-12 19:04:25.000000000 +0000
+++ pacman/test/pacman/pmdb.py	2012-10-15 18:11:52.557414751 +0000
@@ -1,4 +1,4 @@
-#! /usr/bin/python
+#! /usr/bin/python2
 #
 #  Copyright (c) 2006 by Aurelien Foret <orelien@chez.com>
 #
diff -x '.*' -aur pacman-4.0.3/test/pacman/pmenv.py pacman/test/pacman/pmenv.py
--- pacman-4.0.3/test/pacman/pmenv.py	2011-10-12 19:04:25.000000000 +0000
+++ pacman/test/pacman/pmenv.py	2012-10-15 18:11:52.557414751 +0000
@@ -1,4 +1,4 @@
-#! /usr/bin/python
+#! /usr/bin/python2
 #
 #  Copyright (c) 2006 by Aurelien Foret <orelien@chez.com>
 #
diff -x '.*' -aur pacman-4.0.3/test/pacman/pmfile.py pacman/test/pacman/pmfile.py
--- pacman-4.0.3/test/pacman/pmfile.py	2011-10-12 19:04:25.000000000 +0000
+++ pacman/test/pacman/pmfile.py	2012-10-15 18:11:52.557414751 +0000
@@ -1,4 +1,4 @@
-#! /usr/bin/python
+#! /usr/bin/python2
 #
 #  Copyright (c) 2006 by Aurelien Foret <orelien@chez.com>
 #
diff -x '.*' -aur pacman-4.0.3/test/pacman/pmpkg.py pacman/test/pacman/pmpkg.py
--- pacman-4.0.3/test/pacman/pmpkg.py	2011-10-12 19:04:25.000000000 +0000
+++ pacman/test/pacman/pmpkg.py	2012-10-15 18:11:52.557414751 +0000
@@ -1,4 +1,4 @@
-#! /usr/bin/python
+#! /usr/bin/python2
 #
 #  Copyright (c) 2006 by Aurelien Foret <orelien@chez.com>
 #
diff -x '.*' -aur pacman-4.0.3/test/pacman/pmrule.py pacman/test/pacman/pmrule.py
--- pacman-4.0.3/test/pacman/pmrule.py	2011-10-12 19:04:25.000000000 +0000
+++ pacman/test/pacman/pmrule.py	2012-10-15 18:11:52.557414751 +0000
@@ -1,4 +1,4 @@
-#! /usr/bin/python
+#! /usr/bin/python2
 #
 #  Copyright (c) 2006 by Aurelien Foret <orelien@chez.com>
 #
@@ -87,8 +87,11 @@
                     if not value in newpkg.depends:
                         success = 0
                 elif case == "OPTDEPENDS":
-                    if not value in newpkg.optdepends:
-                        success = 0
+                    success = 0
+                    for optdep in newpkg.optdepends:
+                        if value == optdep.split(':', 1)[0]:
+                            success = 1
+                            break
                 elif case == "REASON":
                     if newpkg.reason != int(value):
                         success = 0
diff -x '.*' -aur pacman-4.0.3/test/pacman/pmtest.py pacman/test/pacman/pmtest.py
--- pacman-4.0.3/test/pacman/pmtest.py	2011-10-12 19:04:25.000000000 +0000
+++ pacman/test/pacman/pmtest.py	2012-10-15 18:11:52.557414751 +0000
@@ -1,4 +1,4 @@
-#! /usr/bin/python
+#! /usr/bin/python2
 #
 #  Copyright (c) 2006 by Aurelien Foret <orelien@chez.com>
 #
@@ -203,9 +203,12 @@
         if pacman["gdb"]:
             cmd.extend(["libtool", "execute", "gdb", "--args"])
         if pacman["valgrind"]:
+            suppfile = os.path.join(os.path.dirname(__file__),
+                    '..', '..', 'valgrind.supp')
             cmd.extend(["libtool", "execute", "valgrind", "-q",
                 "--tool=memcheck", "--leak-check=full",
-                "--show-reachable=yes", "--suppressions=%s/valgrind.supp" % os.getcwd()])
+                "--show-reachable=yes",
+                "--suppressions=%s" % suppfile])
         cmd.extend([pacman["bin"],
             "--config", os.path.join(self.root, util.PACCONF),
             "--root", self.root,
diff -x '.*' -aur pacman-4.0.3/test/pacman/tests/Makefile.am pacman/test/pacman/tests/Makefile.am
--- pacman-4.0.3/test/pacman/tests/Makefile.am	2011-10-12 19:04:25.000000000 +0000
+++ pacman/test/pacman/tests/Makefile.am	2012-10-15 18:11:52.557414751 +0000
@@ -17,11 +17,9 @@
 
 
 $(CONFTESTS): Makefile
-	@echo '    ' GEN $@;
-	@$(RM) $@ $@.tmp
-	@test -f $(srcdir)/$@.in && $(edit) $(srcdir)/$@.in >$@.tmp || true
-	@test -f $@.tmp || false
-	@chmod a-w $@.tmp
-	@mv $@.tmp $@
+	$(AM_V_at)$(RM) $@ $@.tmp
+	$(AM_V_GEN)test -f $(srcdir)/$@.in && $(edit) $(srcdir)/$@.in >$@.tmp || true
+	$(AM_V_at)chmod a-w $@.tmp
+	$(AM_V_at)mv $@.tmp $@
 
 # vim:set ts=2 sw=2 noet:
diff -x '.*' -aur pacman-4.0.3/test/pacman/tests/Makefile.in pacman/test/pacman/tests/Makefile.in
--- pacman-4.0.3/test/pacman/tests/Makefile.in	2012-04-07 15:58:14.000000000 +0000
+++ pacman/test/pacman/tests/Makefile.in	2012-10-15 18:12:23.289478364 +0000
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.11.4 from Makefile.am.
+# Makefile.in generated by automake 1.12 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -52,24 +52,32 @@
 build_triplet = @build@
 host_triplet = @host@
 subdir = test/pacman/tests
-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in \
+	$(top_srcdir)/build-aux/mkinstalldirs
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/m4/gettext.m4 \
+am__aclocal_m4_deps = $(top_srcdir)/m4/acinclude.m4 \
+	$(top_srcdir)/m4/gettext.m4 $(top_srcdir)/m4/gpgme.m4 \
 	$(top_srcdir)/m4/iconv.m4 $(top_srcdir)/m4/intlmacosx.m4 \
 	$(top_srcdir)/m4/lib-ld.m4 $(top_srcdir)/m4/lib-link.m4 \
-	$(top_srcdir)/m4/lib-prefix.m4 $(top_srcdir)/m4/libcurl.m4 \
-	$(top_srcdir)/m4/libtool.m4 $(top_srcdir)/m4/ltoptions.m4 \
-	$(top_srcdir)/m4/ltsugar.m4 $(top_srcdir)/m4/ltversion.m4 \
-	$(top_srcdir)/m4/lt~obsolete.m4 $(top_srcdir)/m4/nls.m4 \
+	$(top_srcdir)/m4/lib-prefix.m4 $(top_srcdir)/m4/libtool.m4 \
+	$(top_srcdir)/m4/ltoptions.m4 $(top_srcdir)/m4/ltsugar.m4 \
+	$(top_srcdir)/m4/ltversion.m4 $(top_srcdir)/m4/lt~obsolete.m4 \
+	$(top_srcdir)/m4/nls.m4 $(top_srcdir)/m4/pkg.m4 \
 	$(top_srcdir)/m4/po.m4 $(top_srcdir)/m4/progtest.m4 \
-	$(top_srcdir)/acinclude.m4 $(top_srcdir)/configure.ac
+	$(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
-mkinstalldirs = $(SHELL) $(top_srcdir)/mkinstalldirs
+mkinstalldirs = $(SHELL) $(top_srcdir)/build-aux/mkinstalldirs
 CONFIG_HEADER = $(top_builddir)/config.h
 CONFIG_CLEAN_FILES =
 CONFIG_CLEAN_VPATH_FILES =
 SCRIPTS = $(noinst_SCRIPTS)
+AM_V_GEN = $(am__v_GEN_@AM_V@)
+am__v_GEN_ = $(am__v_GEN_@AM_DEFAULT_V@)
+am__v_GEN_0 = @echo "  GEN     " $@;
+AM_V_at = $(am__v_at_@AM_V@)
+am__v_at_ = $(am__v_at_@AM_DEFAULT_V@)
+am__v_at_0 = @
 SOURCES =
 DIST_SOURCES =
 am__can_run_installinfo = \
@@ -80,6 +88,7 @@
 DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
 ACLOCAL = @ACLOCAL@
 AMTAR = @AMTAR@
+AM_DEFAULT_VERBOSITY = @AM_DEFAULT_VERBOSITY@
 AR = @AR@
 ASCIIDOC = @ASCIIDOC@
 AUTOCONF = @AUTOCONF@
@@ -95,10 +104,6 @@
 CHOST = @CHOST@
 CPP = @CPP@
 CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXCPP = @CXXCPP@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
 CYGPATH_W = @CYGPATH_W@
 DEFS = @DEFS@
 DEPDIR = @DEPDIR@
@@ -117,7 +122,11 @@
 GIT = @GIT@
 GMSGFMT = @GMSGFMT@
 GMSGFMT_015 = @GMSGFMT_015@
+GPGME_CFLAGS = @GPGME_CFLAGS@
+GPGME_CONFIG = @GPGME_CONFIG@
+GPGME_LIBS = @GPGME_LIBS@
 GREP = @GREP@
+INODECMD = @INODECMD@
 INSTALL = @INSTALL@
 INSTALL_DATA = @INSTALL_DATA@
 INSTALL_PROGRAM = @INSTALL_PROGRAM@
@@ -127,12 +136,16 @@
 INTL_MACOSX_LIBS = @INTL_MACOSX_LIBS@
 LD = @LD@
 LDFLAGS = @LDFLAGS@
-LIBCURL = @LIBCURL@
-LIBCURL_CPPFLAGS = @LIBCURL_CPPFLAGS@
+LIBARCHIVE_CFLAGS = @LIBARCHIVE_CFLAGS@
+LIBARCHIVE_LIBS = @LIBARCHIVE_LIBS@
+LIBCURL_CFLAGS = @LIBCURL_CFLAGS@
+LIBCURL_LIBS = @LIBCURL_LIBS@
 LIBICONV = @LIBICONV@
 LIBINTL = @LIBINTL@
 LIBOBJS = @LIBOBJS@
 LIBS = @LIBS@
+LIBSSL_CFLAGS = @LIBSSL_CFLAGS@
+LIBSSL_LIBS = @LIBSSL_LIBS@
 LIBTOOL = @LIBTOOL@
 LIB_VERSION = @LIB_VERSION@
 LIB_VERSION_INFO = @LIB_VERSION_INFO@
@@ -162,10 +175,14 @@
 PACKAGE_VERSION = @PACKAGE_VERSION@
 PATH_SEPARATOR = @PATH_SEPARATOR@
 PKGEXT = @PKGEXT@
+PKG_CONFIG = @PKG_CONFIG@
+PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
+PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 POSUB = @POSUB@
 PYTHON = @PYTHON@
 RANLIB = @RANLIB@
 ROOTDIR = @ROOTDIR@
+SCRIPTLET_SHELL = @SCRIPTLET_SHELL@
 SED = @SED@
 SEDINPLACE = @SEDINPLACE@
 SET_MAKE = @SET_MAKE@
@@ -178,17 +195,16 @@
 STRIP_STATIC = @STRIP_STATIC@
 USE_NLS = @USE_NLS@
 VERSION = @VERSION@
+WARNING_CFLAGS = @WARNING_CFLAGS@
 XGETTEXT = @XGETTEXT@
 XGETTEXT_015 = @XGETTEXT_015@
 XGETTEXT_EXTRA_OPTIONS = @XGETTEXT_EXTRA_OPTIONS@
-_libcurl_config = @_libcurl_config@
 abs_builddir = @abs_builddir@
 abs_srcdir = @abs_srcdir@
 abs_top_builddir = @abs_top_builddir@
 abs_top_srcdir = @abs_top_srcdir@
 ac_ct_AR = @ac_ct_AR@
 ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
 ac_ct_DUMPBIN = @ac_ct_DUMPBIN@
 am__include = @am__include@
 am__leading_dot = @am__leading_dot@
@@ -294,6 +310,8 @@
 ctags: CTAGS
 CTAGS:
 
+cscope cscopelist:
+
 
 distdir: $(DISTFILES)
 	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
@@ -442,12 +460,10 @@
 
 
 $(CONFTESTS): Makefile
-	@echo '    ' GEN $@;
-	@$(RM) $@ $@.tmp
-	@test -f $(srcdir)/$@.in && $(edit) $(srcdir)/$@.in >$@.tmp || true
-	@test -f $@.tmp || false
-	@chmod a-w $@.tmp
-	@mv $@.tmp $@
+	$(AM_V_at)$(RM) $@ $@.tmp
+	$(AM_V_GEN)test -f $(srcdir)/$@.in && $(edit) $(srcdir)/$@.in >$@.tmp || true
+	$(AM_V_at)chmod a-w $@.tmp
+	$(AM_V_at)mv $@.tmp $@
 
 # vim:set ts=2 sw=2 noet:
 
Only in pacman/test/pacman/tests: fileconflict009.py
Only in pacman/test/pacman/tests: fileconflict010.py
Only in pacman/test/pacman/tests: fileconflict011.py
Only in pacman/test/pacman/tests: fileconflict012.py
Only in pacman/test/pacman/tests: fileconflict013.py
Only in pacman/test/pacman/tests: fileconflict015.py
Only in pacman/test/pacman/tests: fileconflict016.py
Only in pacman/test/pacman/tests: ignore008.py
Only in pacman-4.0.3/test/pacman/tests: pkgname-spaces-remove.py
Only in pacman-4.0.3/test/pacman/tests: pkgname-spaces-sync.py
Only in pacman-4.0.3/test/pacman/tests: pkgname-spaces-upgrade.py
Only in pacman/test/pacman/tests: query007.py
Only in pacman/test/pacman/tests: remove031.py
Only in pacman/test/pacman/tests: sync139.py
Only in pacman-4.0.3/test/pacman/tests: sync200.py
Only in pacman/test/pacman/tests: sync200.py.in
Only in pacman-4.0.3/test/pacman/tests: sync301.py
Only in pacman-4.0.3/test/pacman/tests: sync302.py
Only in pacman-4.0.3/test/pacman/tests: sync303.py
Only in pacman-4.0.3/test/pacman/tests: sync304.py
Only in pacman-4.0.3/test/pacman/tests: sync305.py
Only in pacman/test/pacman/tests: sync502.py
Only in pacman/test/pacman/tests: sync503.py
Only in pacman/test/pacman/tests: sync700.py
Only in pacman/test/pacman/tests: sync701.py
Only in pacman/test/pacman/tests: sync702.py
diff -x '.*' -aur pacman-4.0.3/test/pacman/tests/upgrade012.py pacman/test/pacman/tests/upgrade012.py
--- pacman-4.0.3/test/pacman/tests/upgrade012.py	2011-10-14 13:13:27.000000000 +0000
+++ pacman/test/pacman/tests/upgrade012.py	2012-10-15 18:11:52.573418238 +0000
@@ -6,7 +6,7 @@
 
 self.filesystem = ["bin/dummy"]
 
-self.args = "-Uf %s" % p.filename()
+self.args = "-U --force %s" % p.filename()
 
 self.addrule("PACMAN_RETCODE=0")
 self.addrule("PKG_EXIST=dummy")
diff -x '.*' -aur pacman-4.0.3/test/pacman/tests/upgrade014.py pacman/test/pacman/tests/upgrade014.py
--- pacman-4.0.3/test/pacman/tests/upgrade014.py	2011-10-14 13:13:27.000000000 +0000
+++ pacman/test/pacman/tests/upgrade014.py	2012-10-15 18:11:52.573418238 +0000
@@ -13,7 +13,7 @@
 for p in p1, p2:
 	self.addpkg(p)
 
-self.args = "-Uf %s" % " ".join([p.filename() for p in p1, p2])
+self.args = "-U --force %s" % " ".join([p.filename() for p in p1, p2])
 
 self.addrule("PACMAN_RETCODE=0")
 for p in p1, p2:
diff -x '.*' -aur pacman-4.0.3/test/pacman/tests/upgrade015.py pacman/test/pacman/tests/upgrade015.py
--- pacman-4.0.3/test/pacman/tests/upgrade015.py	2011-10-14 13:13:27.000000000 +0000
+++ pacman/test/pacman/tests/upgrade015.py	2012-10-15 18:11:52.573418238 +0000
@@ -6,7 +6,7 @@
 
 self.filesystem = ["etc/dummy.conf"]
 
-self.args = "-Uf %s" % p.filename()
+self.args = "-U --force %s" % p.filename()
 
 self.addrule("PACMAN_RETCODE=0")
 self.addrule("PKG_EXIST=dummy")
diff -x '.*' -aur pacman-4.0.3/test/pacman/tests/upgrade016.py pacman/test/pacman/tests/upgrade016.py
--- pacman-4.0.3/test/pacman/tests/upgrade016.py	2011-10-14 13:13:27.000000000 +0000
+++ pacman/test/pacman/tests/upgrade016.py	2012-10-15 18:11:52.573418238 +0000
@@ -7,7 +7,7 @@
 
 self.filesystem = ["etc/dummy.conf"]
 
-self.args = "-Uf %s" % p.filename()
+self.args = "-U --force %s" % p.filename()
 
 self.addrule("PACMAN_RETCODE=0")
 self.addrule("PKG_EXIST=dummy")
diff -x '.*' -aur pacman-4.0.3/test/pacman/tests/upgrade046.py pacman/test/pacman/tests/upgrade046.py
--- pacman-4.0.3/test/pacman/tests/upgrade046.py	2011-10-14 13:13:27.000000000 +0000
+++ pacman/test/pacman/tests/upgrade046.py	2012-10-15 18:11:52.577266396 +0000
@@ -20,7 +20,7 @@
 for p in p1, p2:
 	self.addpkg(p)
 
-self.args = "-Uf %s" % " ".join([p.filename() for p in p1, p2])
+self.args = "-U --force %s" % " ".join([p.filename() for p in p1, p2])
 
 self.addrule("PACMAN_RETCODE=0")
 for p in p1, p2:
diff -x '.*' -aur pacman-4.0.3/test/pacman/util.py pacman/test/pacman/util.py
--- pacman-4.0.3/test/pacman/util.py	2011-10-12 19:04:25.000000000 +0000
+++ pacman/test/pacman/util.py	2012-10-15 18:11:52.577266396 +0000
@@ -1,4 +1,4 @@
-#! /usr/bin/python
+#! /usr/bin/python2
 #
 #  Copyright (c) 2006 by Aurelien Foret <orelien@chez.com>
 #
Only in pacman/test: scripts
diff -x '.*' -aur pacman-4.0.3/test/util/Makefile.in pacman/test/util/Makefile.in
--- pacman-4.0.3/test/util/Makefile.in	2012-04-07 15:58:14.000000000 +0000
+++ pacman/test/util/Makefile.in	2012-10-15 18:12:23.397267642 +0000
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.11.4 from Makefile.am.
+# Makefile.in generated by automake 1.12 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -52,24 +52,32 @@
 build_triplet = @build@
 host_triplet = @host@
 subdir = test/util
-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in \
+	$(top_srcdir)/build-aux/mkinstalldirs
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/m4/gettext.m4 \
+am__aclocal_m4_deps = $(top_srcdir)/m4/acinclude.m4 \
+	$(top_srcdir)/m4/gettext.m4 $(top_srcdir)/m4/gpgme.m4 \
 	$(top_srcdir)/m4/iconv.m4 $(top_srcdir)/m4/intlmacosx.m4 \
 	$(top_srcdir)/m4/lib-ld.m4 $(top_srcdir)/m4/lib-link.m4 \
-	$(top_srcdir)/m4/lib-prefix.m4 $(top_srcdir)/m4/libcurl.m4 \
-	$(top_srcdir)/m4/libtool.m4 $(top_srcdir)/m4/ltoptions.m4 \
-	$(top_srcdir)/m4/ltsugar.m4 $(top_srcdir)/m4/ltversion.m4 \
-	$(top_srcdir)/m4/lt~obsolete.m4 $(top_srcdir)/m4/nls.m4 \
+	$(top_srcdir)/m4/lib-prefix.m4 $(top_srcdir)/m4/libtool.m4 \
+	$(top_srcdir)/m4/ltoptions.m4 $(top_srcdir)/m4/ltsugar.m4 \
+	$(top_srcdir)/m4/ltversion.m4 $(top_srcdir)/m4/lt~obsolete.m4 \
+	$(top_srcdir)/m4/nls.m4 $(top_srcdir)/m4/pkg.m4 \
 	$(top_srcdir)/m4/po.m4 $(top_srcdir)/m4/progtest.m4 \
-	$(top_srcdir)/acinclude.m4 $(top_srcdir)/configure.ac
+	$(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
-mkinstalldirs = $(SHELL) $(top_srcdir)/mkinstalldirs
+mkinstalldirs = $(SHELL) $(top_srcdir)/build-aux/mkinstalldirs
 CONFIG_HEADER = $(top_builddir)/config.h
 CONFIG_CLEAN_FILES =
 CONFIG_CLEAN_VPATH_FILES =
 SCRIPTS = $(noinst_SCRIPTS)
+AM_V_GEN = $(am__v_GEN_@AM_V@)
+am__v_GEN_ = $(am__v_GEN_@AM_DEFAULT_V@)
+am__v_GEN_0 = @echo "  GEN     " $@;
+AM_V_at = $(am__v_at_@AM_V@)
+am__v_at_ = $(am__v_at_@AM_DEFAULT_V@)
+am__v_at_0 = @
 SOURCES =
 DIST_SOURCES =
 am__can_run_installinfo = \
@@ -80,6 +88,7 @@
 DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
 ACLOCAL = @ACLOCAL@
 AMTAR = @AMTAR@
+AM_DEFAULT_VERBOSITY = @AM_DEFAULT_VERBOSITY@
 AR = @AR@
 ASCIIDOC = @ASCIIDOC@
 AUTOCONF = @AUTOCONF@
@@ -95,10 +104,6 @@
 CHOST = @CHOST@
 CPP = @CPP@
 CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXCPP = @CXXCPP@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
 CYGPATH_W = @CYGPATH_W@
 DEFS = @DEFS@
 DEPDIR = @DEPDIR@
@@ -117,7 +122,11 @@
 GIT = @GIT@
 GMSGFMT = @GMSGFMT@
 GMSGFMT_015 = @GMSGFMT_015@
+GPGME_CFLAGS = @GPGME_CFLAGS@
+GPGME_CONFIG = @GPGME_CONFIG@
+GPGME_LIBS = @GPGME_LIBS@
 GREP = @GREP@
+INODECMD = @INODECMD@
 INSTALL = @INSTALL@
 INSTALL_DATA = @INSTALL_DATA@
 INSTALL_PROGRAM = @INSTALL_PROGRAM@
@@ -127,12 +136,16 @@
 INTL_MACOSX_LIBS = @INTL_MACOSX_LIBS@
 LD = @LD@
 LDFLAGS = @LDFLAGS@
-LIBCURL = @LIBCURL@
-LIBCURL_CPPFLAGS = @LIBCURL_CPPFLAGS@
+LIBARCHIVE_CFLAGS = @LIBARCHIVE_CFLAGS@
+LIBARCHIVE_LIBS = @LIBARCHIVE_LIBS@
+LIBCURL_CFLAGS = @LIBCURL_CFLAGS@
+LIBCURL_LIBS = @LIBCURL_LIBS@
 LIBICONV = @LIBICONV@
 LIBINTL = @LIBINTL@
 LIBOBJS = @LIBOBJS@
 LIBS = @LIBS@
+LIBSSL_CFLAGS = @LIBSSL_CFLAGS@
+LIBSSL_LIBS = @LIBSSL_LIBS@
 LIBTOOL = @LIBTOOL@
 LIB_VERSION = @LIB_VERSION@
 LIB_VERSION_INFO = @LIB_VERSION_INFO@
@@ -162,10 +175,14 @@
 PACKAGE_VERSION = @PACKAGE_VERSION@
 PATH_SEPARATOR = @PATH_SEPARATOR@
 PKGEXT = @PKGEXT@
+PKG_CONFIG = @PKG_CONFIG@
+PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
+PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 POSUB = @POSUB@
 PYTHON = @PYTHON@
 RANLIB = @RANLIB@
 ROOTDIR = @ROOTDIR@
+SCRIPTLET_SHELL = @SCRIPTLET_SHELL@
 SED = @SED@
 SEDINPLACE = @SEDINPLACE@
 SET_MAKE = @SET_MAKE@
@@ -178,17 +195,16 @@
 STRIP_STATIC = @STRIP_STATIC@
 USE_NLS = @USE_NLS@
 VERSION = @VERSION@
+WARNING_CFLAGS = @WARNING_CFLAGS@
 XGETTEXT = @XGETTEXT@
 XGETTEXT_015 = @XGETTEXT_015@
 XGETTEXT_EXTRA_OPTIONS = @XGETTEXT_EXTRA_OPTIONS@
-_libcurl_config = @_libcurl_config@
 abs_builddir = @abs_builddir@
 abs_srcdir = @abs_srcdir@
 abs_top_builddir = @abs_top_builddir@
 abs_top_srcdir = @abs_top_srcdir@
 ac_ct_AR = @ac_ct_AR@
 ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
 ac_ct_DUMPBIN = @ac_ct_DUMPBIN@
 am__include = @am__include@
 am__leading_dot = @am__leading_dot@
@@ -288,6 +304,8 @@
 ctags: CTAGS
 CTAGS:
 
+cscope cscopelist:
+
 
 distdir: $(DISTFILES)
 	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
Only in pacman: valgrind.supp
